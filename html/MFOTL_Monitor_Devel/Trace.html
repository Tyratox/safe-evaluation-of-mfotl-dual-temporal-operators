<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Trace</title>
</head>


<body>
<div class="head">
<h1>Theory Trace</h1>
</div>

<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Trace
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/Stream.html">HOL-Library.Stream</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Traces and trace prefixes›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Infinite traces›</span></span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">ssorted</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder stream <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"shd <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≤</span> shd <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ssorted</span> <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ssorted</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ssorted_siterate<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⟹</span> ssorted <span class="main">(</span>siterate <span class="free">f</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ssortedD<span class="main">:</span> <span class="quoted"><span class="quoted">"ssorted <span class="free">s</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">≤</span> stl <span class="free">s</span> <span class="main">!!</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ssorted.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ssorted_sdrop<span class="main">:</span> <span class="quoted"><span class="quoted">"ssorted <span class="free">s</span> <span class="main">⟹</span> ssorted <span class="main">(</span>sdrop <span class="free">i</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ssorted.cases ssortedD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ssorted_monoD<span class="main">:</span> <span class="quoted"><span class="quoted">"ssorted <span class="free">s</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">s</span> <span class="main">!!</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="free">i</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> Suc<span class="main">(</span>2-4<span class="main">)</span> ssortedD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_Suc_eq Suc_diff_le<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_stake<span class="main">:</span> <span class="quoted"><span class="quoted">"ssorted <span class="free">s</span> <span class="main">⟹</span> sorted <span class="main">(</span>stake <span class="free">i</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ssorted.cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ssorted_monoD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> order_trans<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ ssortedD<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ssorted_monoI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="free">s</span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">s</span> <span class="main">!!</span> <span class="bound">j</span> <span class="main">⟹</span> ssorted <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">_</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> spec2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ssorted_iff_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"ssorted <span class="free">s</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="free">s</span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">s</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ssorted_monoI ssorted_monoD <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> ssorted_iff_le_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"ssorted <span class="free">s</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">s</span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">s</span> <span class="main">!!</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mono_iff_le_Suc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"snth <span class="free">s</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_def ssorted_iff_mono<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sincreasing</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sincreasingI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">s</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> sincreasing <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sincreasing_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sincreasing_grD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> semilattice_sup"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sincreasing <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="free">i</span><span class="main">.</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">s</span> <span class="main">!!</span> <span class="bound">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="main">{</span><span class="free">s</span> <span class="main">!!</span> <span class="bound">n</span> <span class="main">|</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≤</span> <span class="free">i</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_fin <span class="var">?A</span> <span class="main">&lt;</span> <span class="free">s</span> <span class="main">!!</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sincreasing_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">s</span> <span class="main">!!</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order.strict_trans1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sup_fin.coboundedI<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">!!</span> <span class="skolem">j</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_less<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">!!</span> <span class="skolem">j</span> <span class="main">≤</span> Sup_fin <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sup_fin.coboundedI<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sincreasing_siterate_nat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sincreasing <span class="main">(</span>siterate <span class="free">f</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> sincreasing_def <span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">&lt;</span> siterate <span class="free">f</span> <span class="free">n</span> <span class="main">!!</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> siterate <span class="free">f</span> <span class="free">n</span> <span class="main">!!</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> order.strict_trans1<span class="main">[</span><span class="operator">OF</span> le0 assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> siterate <span class="free">f</span> <span class="free">n</span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">x</span> <span class="main">&lt;</span> siterate <span class="free">f</span> <span class="free">n</span> <span class="main">!!</span> Suc <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> order.strict_trans1<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> snth.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sincreasing_stl<span class="main">:</span> <span class="quoted"><span class="quoted">"sincreasing <span class="free">s</span> <span class="main">⟹</span> sincreasing <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> semilattice_sup stream"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gr0_conv_Suc <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sincreasingI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sincreasing_grD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="tfree">'a</span> trace <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">s</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> set <span class="main">×</span> nat<span class="main">)</span> stream<span class="main">.</span> ssorted <span class="main">(</span>smap snd <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> sincreasing <span class="main">(</span>smap snd <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"smap <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">{}</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> nats"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.map_comp stream.map_ident <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> stream.map_cong<span class="main">)</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_trace

<span class="keyword1"><span class="command">lift_definition</span></span> Γ <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trace <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span> <span class="bound">i</span><span class="main">.</span> fst <span class="main">(</span><span class="bound">s</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> τ <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trace <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span> <span class="bound">i</span><span class="main">.</span> snd <span class="main">(</span><span class="bound">s</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> stream_eq_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="free">s'</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free">s</span> <span class="main">!!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">s'</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stream.map_cong0 stream_smap_nats<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trace_eqI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> Γ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> Γ <span class="free">σ'</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> τ <span class="free">σ'</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">σ'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream_eq_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prod_eqI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> τ_mono<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> τ <span class="free">s</span> <span class="free">i</span> <span class="main">≤</span> τ <span class="free">s</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ssorted_iff_mono<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ex_le_τ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> <span class="free">x</span> <span class="main">≤</span> τ <span class="free">s</span> <span class="bound">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sincreasing_grD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="main">]</span></span> less_imp_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> le_τ_less<span class="main">:</span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">i</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> τ <span class="free">σ</span> <span class="free">i</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> antisym<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> less_τD<span class="main">:</span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">i</span> <span class="main">&lt;</span> τ <span class="free">σ</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> τ_mono less_le_not_le not_le_imp_less<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> τ <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> τ <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> map_Γ <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> trace <span class="main">⇒</span> <span class="tfree">'b</span> trace"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="bound">s</span><span class="main">.</span> smap <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.map_comp prod.case_eq_if <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> stream.map_cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Γ_map_Γ<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Γ <span class="main">(</span>map_Γ <span class="free">f</span> <span class="free">s</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>Γ <span class="free">s</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.case_eq_if<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> τ_map_Γ<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"τ <span class="main">(</span>map_Γ <span class="free">f</span> <span class="free">s</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> τ <span class="free">s</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.case_eq_if<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_Γ_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_Γ id <span class="free">s</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stream.map_id<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_Γ_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"map_Γ <span class="free">g</span> <span class="main">(</span>map_Γ <span class="free">f</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> map_Γ <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stream.map_comp comp_def prod.case_eq_if case_prod_beta'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_Γ_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">σ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> map_Γ <span class="free">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">σ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> map_Γ <span class="free">f<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">σ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> stream.map_cong<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Finite trace prefixes›</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="tfree">'a</span> prefix <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> set <span class="main">×</span> nat<span class="main">)</span> list<span class="main">.</span> sorted <span class="main">(</span>map snd <span class="bound">p</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_prefix

<span class="keyword1"><span class="command">lift_definition</span></span> pmap_Γ <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> prefix <span class="main">⇒</span> <span class="tfree">'b</span> prefix"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta comp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> last_ts <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prefix <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">p</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> snd <span class="main">(</span>last <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> first_ts <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> prefix <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span> <span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">p</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="bound">n</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> snd <span class="main">(</span>hd <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> pnil <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prefix"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lift_definition</span></span> plen <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prefix <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"length"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> psnoc <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prefix <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">×</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> prefix"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">p</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> snd <span class="main">(</span>last <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> snd <span class="bound">x</span> <span class="keyword1">then</span> <span class="bound">p</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">goal_cases</span> sorted_psnoc<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sorted_psnoc <span class="skolem">p</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits list.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> prefix <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">order</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">less_eq_prefix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prefix <span class="main">⇒</span> <span class="tfree">'a</span> prefix <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="bound">q</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">@</span> <span class="bound">r</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_prefix</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prefix <span class="main">⇒</span> <span class="tfree">'a</span> prefix <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_prefix</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> less refl trans antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> less_prefix_def <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>refl <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>trans <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>antisym <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> psnoc_inject<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"last_ts <span class="free">p</span> <span class="main">≤</span> snd <span class="free">x</span> <span class="main">⟹</span> last_ts <span class="free">q</span> <span class="main">≤</span> snd <span class="free">y</span> <span class="main">⟹</span> psnoc <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> psnoc <span class="free">q</span> <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">p</span> <span class="main">=</span> <span class="free">q</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lift_definition</span></span> prefix_of <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prefix <span class="main">⇒</span> <span class="tfree">'a</span> trace <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span> <span class="bound">s</span><span class="main">.</span> stake <span class="main">(</span>length <span class="bound">p</span><span class="main">)</span> <span class="bound">s</span> <span class="main">=</span> <span class="bound">p</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prefix_of_pnil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of pnil <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> plen_pnil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"plen pnil <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> prefix_of_pmap_Γ<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ</span> <span class="main">⟹</span> prefix_of <span class="main">(</span>pmap_Γ <span class="free">f</span> <span class="free">π</span><span class="main">)</span> <span class="main">(</span>map_Γ <span class="free">f</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> plen_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">≤</span> <span class="free">π'</span> <span class="main">⟹</span> plen <span class="free">π</span> <span class="main">≤</span> plen <span class="free">π'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> prefix_of_psnocE<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="main">(</span>psnoc <span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> last_ts <span class="free">p</span> <span class="main">≤</span> snd <span class="free">x</span> <span class="main">⟹</span>
  <span class="main">(</span>prefix_of <span class="free">p</span> <span class="free">s</span> <span class="main">⟹</span> Γ <span class="free">s</span> <span class="main">(</span>plen <span class="free">p</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">x</span> <span class="main">⟹</span> τ <span class="free">s</span> <span class="main">(</span>plen <span class="free">p</span><span class="main">)</span> <span class="main">=</span> snd <span class="free">x</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stake.simps <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stake_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> le_pnil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pnil <span class="main">≤</span> <span class="free">π</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lift_definition</span></span> take_prefix <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> trace <span class="main">⇒</span> <span class="tfree">'a</span> prefix"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">stake</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sorted_stake<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> plen_take_prefix<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"plen <span class="main">(</span>take_prefix <span class="free">i</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> plen_psnoc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"last_ts <span class="free">π</span> <span class="main">≤</span> snd <span class="free">x</span> <span class="main">⟹</span> plen <span class="main">(</span>psnoc <span class="free">π</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> plen <span class="free">π</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> prefix_of_take_prefix<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="main">(</span>take_prefix <span class="free">i</span> <span class="free">σ</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lift_definition</span></span> pdrop <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> prefix <span class="main">⇒</span> <span class="tfree">'a</span> prefix"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">drop</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> drop_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> sorted_drop<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pdrop_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pdrop <span class="main">0</span> <span class="free">π</span> <span class="main">=</span> <span class="free">π</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> prefix_of_antimono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">≤</span> <span class="free">π'</span> <span class="main">⟹</span> prefix_of <span class="free">π'</span> <span class="free">s</span> <span class="main">⟹</span> prefix_of <span class="free">π</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stake_add <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stake_add<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prefix_of_imp_linear<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ</span> <span class="main">⟹</span> prefix_of <span class="free">π'</span> <span class="free">σ</span> <span class="main">⟹</span> <span class="free">π</span> <span class="main">≤</span> <span class="free">π'</span> <span class="main">∨</span> <span class="free">π'</span> <span class="main">≤</span> <span class="free">π</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">transfer</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">π</span> <span class="skolem">π'</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> set <span class="main">×</span> nat<span class="main">)</span> stream"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"stake <span class="main">(</span>length <span class="skolem">π</span><span class="main">)</span> <span class="skolem">σ</span> <span class="main">=</span> <span class="skolem">π</span>"</span></span> <span class="quoted"><span class="quoted">"stake <span class="main">(</span>length <span class="skolem">π'</span><span class="main">)</span> <span class="skolem">σ</span> <span class="main">=</span> <span class="skolem">π'</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="skolem">π'</span> <span class="main">=</span> <span class="skolem">π</span> <span class="main">@</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="skolem">π</span> <span class="main">=</span> <span class="skolem">π'</span> <span class="main">@</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">π</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">π'</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> le_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> le
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π'</span> <span class="main">=</span> take <span class="main">(</span>length <span class="skolem">π</span><span class="main">)</span> <span class="skolem">π'</span> <span class="main">@</span> drop <span class="main">(</span>length <span class="skolem">π</span><span class="main">)</span> <span class="skolem">π'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">π</span><span class="main">)</span> <span class="skolem">π'</span> <span class="main">=</span> <span class="skolem">π</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms le <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> min.absorb1 take_stake<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> ge
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">=</span> take <span class="main">(</span>length <span class="skolem">π'</span><span class="main">)</span> <span class="skolem">π</span> <span class="main">@</span> drop <span class="main">(</span>length <span class="skolem">π'</span><span class="main">)</span> <span class="skolem">π</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">π'</span><span class="main">)</span> <span class="skolem">π</span> <span class="main">=</span> <span class="skolem">π'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms ge <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> min.absorb1 take_stake<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ex_prefix_of<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> prefix_of <span class="free">p</span> <span class="bound">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> bexI CollectI conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> set <span class="main">×</span> nat<span class="main">)</span> list"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map snd <span class="skolem">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?σ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">@-</span> smap <span class="main">(</span>Pair undefined<span class="main">)</span> <span class="main">(</span>fromN <span class="main">(</span>snd <span class="main">(</span>last <span class="skolem">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stake <span class="main">(</span>length <span class="skolem">p</span><span class="main">)</span> <span class="var">?σ</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stake_shift<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> le_last<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">p</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> snd <span class="main">(</span>last <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> sorted_nth_mono<span class="main">[</span><span class="operator">OF</span> *<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> last_conv_nth nth_Cons'<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ssorted <span class="main">(</span>smap snd <span class="var">?σ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ssorted_iff_mono sorted_iff_nth_mono shift_snth<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sincreasing <span class="main">(</span>smap snd <span class="var">?σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sincreasingI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> smap snd <span class="var">?σ</span> <span class="main">!!</span> Suc <span class="main">(</span>length <span class="skolem">p</span> <span class="main">+</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> Suc_pred add.commute diff_Suc_Suc length_greater_0_conv less_add_Suc1 less_diff_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">&lt;</span> smap snd <span class="var">?σ</span> <span class="main">!!</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> τ_prefix_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">p</span> <span class="free">s</span> <span class="main">⟹</span> prefix_of <span class="free">p</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> plen <span class="free">p</span> <span class="main">⟹</span> τ <span class="free">s</span> <span class="free">i</span> <span class="main">=</span> τ <span class="free">s'</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stake_nth<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Γ_prefix_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">p</span> <span class="free">s</span> <span class="main">⟹</span> prefix_of <span class="free">p</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> plen <span class="free">p</span> <span class="main">⟹</span> Γ <span class="free">s</span> <span class="free">i</span> <span class="main">=</span> Γ <span class="free">s'</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stake_nth<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sincreasing_sdrop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> semilattice_sup<span class="main">)</span> stream"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sincreasing <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sincreasing <span class="main">(</span>sdrop <span class="free">n</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sincreasingI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">s</span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sincreasing_grD<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> sdrop <span class="free">n</span> <span class="free">s</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sdrop_snth<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">&lt;</span> sdrop <span class="free">n</span> <span class="free">s</span> <span class="main">!!</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ssorted_shift<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ssorted <span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>sorted <span class="free">xs</span> <span class="main">∧</span> ssorted <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>sset <span class="free">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"ssorted <span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sorted <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ssorted_iff_mono shift_snth sorted_iff_nth_mono <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ssorted_sdrop<span class="main">[</span><span class="operator">OF</span> *<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ssorted <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sdrop_shift<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> sset <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">!!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth sset_range<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ssorted_monoD<span class="main">[</span><span class="operator">OF</span> *<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">+</span> length <span class="free">xs</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sorted <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"ssorted <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>sset <span class="free">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ssorted <span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ssorted <span class="skolem">xs</span> <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹ssorted <span class="skolem">s</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> ssorted.simps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> neq_Nil_conv shd_sset <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">#</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sincreasing_shift<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sincreasing <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sincreasing <span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sincreasingI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">s</span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sincreasing_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">s</span><span class="main">)</span> <span class="main">!!</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">s</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> replace_prefix <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prefix <span class="main">⇒</span> <span class="tfree">'a</span> trace <span class="main">⇒</span> <span class="tfree">'a</span> trace"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">π</span> <span class="bound">σ</span><span class="main">.</span> <span class="keyword1">if</span> ssorted <span class="main">(</span>smap snd <span class="main">(</span><span class="bound">π</span> <span class="main">@-</span> sdrop <span class="main">(</span>length <span class="bound">π</span><span class="main">)</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
     <span class="bound">π</span> <span class="main">@-</span> sdrop <span class="main">(</span>length <span class="bound">π</span><span class="main">)</span> <span class="bound">σ</span> <span class="keyword1">else</span> smap <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> nats"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.map_comp stream.map_ident sdrop_smap<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
    <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sdrop_smap <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sincreasing_shift sincreasing_sdrop <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> stream.map_cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prefix_of_replace_prefix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"prefix_of <span class="main">(</span>pmap_Γ <span class="free">f</span> <span class="free">π</span><span class="main">)</span> <span class="free">σ</span> <span class="main">⟹</span> prefix_of <span class="free">π</span> <span class="main">(</span>replace_prefix <span class="free">π</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">f</span> <span class="skolem">π</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> stake_sdrop<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"length <span class="skolem"><span class="skolem"><span class="skolem">π</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ssorted_shift split_beta o_def stake_shift sdrop_smap<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
        ssorted_sdrop not_le <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sdrop_smap<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_Γ_replace_prefix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⟹</span> prefix_of <span class="main">(</span>pmap_Γ <span class="free">f</span> <span class="free">π</span><span class="main">)</span> <span class="free">σ</span> <span class="main">⟹</span> map_Γ <span class="free">f</span> <span class="main">(</span>replace_prefix <span class="free">π</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> map_Γ <span class="free">f</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">f</span> <span class="skolem">π</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> stake_sdrop<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">σ</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"length <span class="skolem"><span class="skolem"><span class="skolem">π</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> stake_sdrop<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">σ</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"length <span class="skolem"><span class="skolem"><span class="skolem">π</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ssorted_shift split_beta o_def stake_shift sdrop_smap<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ssorted_sdrop
        not_le <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sdrop_smap <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> map_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prefix_of_pmap_Γ_D<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="main">(</span>pmap_Γ <span class="free">f</span> <span class="free">π</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ'</span><span class="main">.</span> prefix_of <span class="free">π</span> <span class="bound">σ'</span> <span class="main">∧</span> prefix_of <span class="main">(</span>pmap_Γ <span class="free">f</span> <span class="free">π</span><span class="main">)</span> <span class="main">(</span>map_Γ <span class="free">f</span> <span class="bound">σ'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="skolem">σ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_prefix_of <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="main">(</span>pmap_Γ <span class="free">f</span> <span class="free">π</span><span class="main">)</span> <span class="main">(</span>map_Γ <span class="free">f</span> <span class="skolem">σ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prefix_of_map_Γ_D<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π'</span> <span class="main">(</span>map_Γ <span class="free">f</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">π''</span><span class="main">.</span> <span class="free">π'</span> <span class="main">=</span> pmap_Γ <span class="free">f</span> <span class="bound">π''</span> <span class="main">∧</span> prefix_of <span class="bound">π''</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"stake <span class="main">(</span>length <span class="main">_</span><span class="main">)</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sym <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sorted_stake<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> pts <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prefix <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"map snd"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pts_pmap_Γ<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pts <span class="main">(</span>pmap_Γ <span class="free">f</span> <span class="free">π</span><span class="main">)</span> <span class="main">=</span> pts <span class="free">π</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</body>

</html>