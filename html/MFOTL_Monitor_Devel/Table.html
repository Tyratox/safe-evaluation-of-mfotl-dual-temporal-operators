<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Table</title>
</head>


<body>
<div class="head">
<h1>Theory Table</h1>
</div>

<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Table
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Finite tables›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">tabulate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tabulate</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tabulate</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">tabulate</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tabulate_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"tabulate <span class="free">f</span> <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> map <span class="free">f</span> <span class="main">[</span><span class="free">x</span> <span class="main">..&lt;</span> <span class="free">x</span> <span class="main">+</span> <span class="free">n</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_le Suc_le_eq upt_rec<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> length_tabulate<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>tabulate <span class="free">f</span> <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> map_tabulate<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="main">(</span>tabulate <span class="free">g</span> <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> tabulate <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_tabulate<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> tabulate <span class="free">f</span> <span class="free">x</span> <span class="free">n</span> <span class="main">!</span> <span class="free">k</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> tuple <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> table <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tuple set"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_tuple</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat set <span class="main">⇒</span> <span class="tfree">'a</span> tuple <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_tuple</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟷</span> length <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> None <span class="main">⟷</span> <span class="bound">i</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">table</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat set <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">table</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">.</span> wf_tuple <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">empty_table</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">unit_table</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">{</span>replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> None<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">singleton_table</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">{</span>tabulate <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> in_empty_table<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">x</span> <span class="main">∈</span> empty_table"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> empty_table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> empty_table<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">V</span> empty_table"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> table_def empty_table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> unit_table_wf_tuple<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> unit_table <span class="free">n</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> unit_table_def wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> unit_table<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> table <span class="free">n</span> <span class="free">V</span> <span class="main">(</span>unit_table <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> in_unit_table<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> unit_table <span class="free">n</span> <span class="main">⟷</span> wf_tuple <span class="free">n</span> <span class="main">{}</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> unit_table_def wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> singleton_table_wf_tuple<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> singleton_table <span class="free">n</span> <span class="free">i</span> <span class="free">z</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> singleton_table_def wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> singleton_table<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">⟹</span> table <span class="free">n</span> <span class="free">V</span> <span class="main">(</span>singleton_table <span class="free">n</span> <span class="free">i</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> table_Un<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">V</span> <span class="free">X</span> <span class="main">⟹</span> table <span class="free">n</span> <span class="free">V</span> <span class="free">Y</span> <span class="main">⟹</span> table <span class="free">n</span> <span class="free">V</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_tuple_length<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="free">x</span> <span class="main">⟹</span> length <span class="free">x</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">join1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tuple <span class="main">×</span> <span class="tfree">'a</span> tuple <span class="main">⇒</span> <span class="tfree">'a</span> tuple option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">join1</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">join1</span> <span class="main">(</span>None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> map_option <span class="main">(</span>Cons None<span class="main">)</span> <span class="main">(</span><span class="free">join1</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">join1</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> map_option <span class="main">(</span>Cons <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">join1</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">join1</span> <span class="main">(</span>None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> map_option <span class="main">(</span>Cons <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">join1</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">join1</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>
    <span class="keyword1">then</span> map_option <span class="main">(</span>Cons <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">join1</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">join1</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">join</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> table <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> <span class="tfree">'a</span> table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">join</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="keyword1">then</span> Option.these <span class="main">(</span>join1 <span class="main">`</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">×</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">-</span> Option.these <span class="main">(</span>join1 <span class="main">`</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">×</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> join_True_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"join <span class="free">A</span> True <span class="free">B</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">b</span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> set_option <span class="main">(</span>join1 <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> join_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Option.these_def image_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> join_False_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"join <span class="free">X</span> False <span class="free">Y</span> <span class="main">=</span> <span class="free">X</span> <span class="main">-</span> join <span class="free">X</span> True <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> join_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> self_join1<span class="main">:</span> <span class="quoted"><span class="quoted">"join1 <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">xs</span> <span class="main">⟹</span> join1 <span class="main">(</span><span class="free">zs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">zs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> join1.induct<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> join_False_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"join <span class="free">A</span> False <span class="free">B</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">b</span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> join1 <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">≠</span> Some <span class="bound">a</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> join_False_alt join_True_code
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Option.these_def image_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> self_join1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_tuple_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Suc_pred'<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="free">x</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">x</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> Suc <span class="main">0</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_tuple_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> None <span class="keyword1">then</span> <span class="main">0</span> <span class="main">∉</span> <span class="free">A</span> <span class="keyword1">else</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="free">n</span> <span class="main">=</span> Suc <span class="bound">m</span> <span class="main">∧</span> wf_tuple <span class="bound">m</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons image_iff Ball_def gr0_conv_Suc Suc_pred' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> join1_wf_tuple<span class="main">:</span>
  <span class="quoted"><span class="quoted">"join1 <span class="main">(</span><span class="free">v1</span><span class="main">,</span> <span class="free">v2</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="free">v1</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">B</span> <span class="free">v2</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v1</span><span class="main">,</span> <span class="free">v2</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">v1</span></span> <span class="quoted"><span class="free">v2</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> join1.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_Un Un_Diff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> join_wf_tuple<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> join <span class="free">X</span> <span class="free">b</span> <span class="free">Y</span> <span class="main">⟹</span>
  <span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="bound">v</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">B</span> <span class="bound">v</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">¬</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∪</span> <span class="free">B</span> <span class="main">=</span> <span class="free">C</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">C</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> join_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Option.these_def image_iff sup_absorb1 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> join1_wf_tuple <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> join_table<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A</span> <span class="free">X</span> <span class="main">⟹</span> table <span class="free">n</span> <span class="free">B</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">¬</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∪</span> <span class="free">B</span> <span class="main">=</span> <span class="free">C</span> <span class="main">⟹</span>
  table <span class="free">n</span> <span class="free">C</span> <span class="main">(</span>join <span class="free">X</span> <span class="free">b</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> table_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> join_wf_tuple<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_tuple_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="free">A</span> <span class="free">a</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
   wf_tuple <span class="free">m</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tl <span class="free">a</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">0</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟷</span> hd <span class="free">a</span> <span class="main">≠</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons image_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> table_project<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">A</span> <span class="free">X</span> <span class="main">⟹</span> table <span class="free">n</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">`</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> table_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">restrict</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">restrict</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">else</span> None<span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"restrict <span class="free">A</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"restrict <span class="free">A</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="main">#</span> restrict <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="keyword1">else</span> None <span class="main">#</span> restrict <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> restrict_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_upt_Suc image_iff Suc_pred' Ball_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_tuple_restrict<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">B</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∩</span> <span class="free">B</span> <span class="main">=</span> <span class="free">C</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">C</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> restrict_def wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_tuple_restrict_simple<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">B</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> restrict_def wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_restrict<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">v</span> <span class="main">⟹</span> restrict <span class="free">A</span> <span class="free">v</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">v</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_eq_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"restrict <span class="free">A</span> <span class="free">v</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">v</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> length_restrict<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>restrict <span class="free">A</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> length <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> join1_Some_restrict<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tuple"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">B</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"join1 <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">z</span> <span class="main">⟷</span> wf_tuple <span class="free">n</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="free">z</span> <span class="main">∧</span> restrict <span class="free">A</span> <span class="free">z</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span> restrict <span class="free">B</span> <span class="free">z</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> join1.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 4 0 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_Un Un_Diff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 4 0 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_Un Un_Diff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 4 0 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_Un Un_Diff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 4 0 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_Un Un_Diff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_idle<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="free">v</span> <span class="main">⟹</span> restrict <span class="free">A</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_the_restrict<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> map the <span class="main">(</span>restrict <span class="free">A</span> <span class="free">v</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> map the <span class="free">v</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons' gr0_conv_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> join_restrict<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span> <span class="free">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tuple set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="bound">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">B</span> <span class="bound">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> join <span class="free">X</span> <span class="free">b</span> <span class="free">Y</span> <span class="main">⟷</span>
    wf_tuple <span class="free">n</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="free">v</span> <span class="main">∧</span> restrict <span class="free">A</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> restrict <span class="free">B</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">Y</span> <span class="keyword1">else</span> restrict <span class="free">B</span> <span class="free">v</span> <span class="main">∉</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> join_def Option.these_def image_iff assms wf_tuple_restrict sup_absorb1 restrict_idle
    restrict_idle<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> assms
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> join1_Some_restrict<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span>
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Some <span class="free">v</span>"</span></span><span class="main"><span class="main">]</span></span>
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Some <span class="free">v</span>"</span></span><span class="main"><span class="main">]</span></span> join1_Some_restrict<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> join_restrict_table<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">B</span> <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> join <span class="free">X</span> <span class="free">b</span> <span class="free">Y</span> <span class="main">⟷</span>
    wf_tuple <span class="free">n</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="free">v</span> <span class="main">∧</span> restrict <span class="free">A</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> restrict <span class="free">B</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">Y</span> <span class="keyword1">else</span> restrict <span class="free">B</span> <span class="free">v</span> <span class="main">∉</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> table_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_restrict<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> join_restrict_annotated<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span> <span class="free">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tuple set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">b</span> <span class="keyword1">=simp=&gt;</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"join <span class="main">{</span><span class="bound">v</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="bound">v</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">v</span><span class="main">}</span> <span class="free">b</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">B</span> <span class="bound">v</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">v</span><span class="main">}</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound">v</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="bound">v</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">Q</span> <span class="main">(</span>restrict <span class="free">B</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">¬</span> <span class="free">Q</span> <span class="main">(</span>restrict <span class="free">B</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> join_restrict<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_restrict_simple simp_implies_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_joinI<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A</span> <span class="free">X</span> <span class="main">⟹</span> table <span class="free">n</span> <span class="free">B</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">¬</span><span class="free">b</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="free">v</span> <span class="main">⟹</span>
  restrict <span class="free">A</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">b</span> <span class="main">⟹</span> restrict <span class="free">B</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">¬</span><span class="free">b</span> <span class="main">⟹</span> restrict <span class="free">B</span> <span class="free">v</span> <span class="main">∉</span> <span class="free">Y</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> join <span class="free">X</span> <span class="free">b</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> table_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> join_restrict<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_joinE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> join <span class="free">X</span> <span class="free">b</span> <span class="free">Y</span> <span class="main">⟹</span> table <span class="free">n</span> <span class="free">A</span> <span class="free">X</span> <span class="main">⟹</span> table <span class="free">n</span> <span class="free">B</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">¬</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span>wf_tuple <span class="free">n</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="free">v</span> <span class="main">⟹</span> restrict <span class="free">A</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> restrict <span class="free">B</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">Y</span> <span class="keyword1">else</span> restrict <span class="free">B</span> <span class="free">v</span> <span class="main">∉</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> table_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> join_restrict<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">qtable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> tuple <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> tuple <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span>
  <span class="tfree">'a</span> table <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">qtable</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⟷</span> table <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>wf_tuple <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">x</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">wf_table</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_table</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> qtable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_table_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_table <span class="free">n</span> <span class="free">A</span> <span class="free">Q</span> <span class="free">X</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">Q</span> <span class="bound">x</span> <span class="main">∧</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> qtable_def table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> table_wf_table<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A</span> <span class="free">X</span> <span class="main">=</span> wf_table <span class="free">n</span> <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">X</span><span class="main">)</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> table_def wf_table_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> qtableI<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A</span> <span class="free">X</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">)</span> <span class="main">⟹</span>
  qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> qtable_def table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> in_qtableI<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">X</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> qtable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> in_qtableE<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">(</span>wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">R</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> qtable_def table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> qtable_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">⟹</span> False<span class="main">)</span> <span class="main">⟹</span> qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q</span> empty_table"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> qtable_def table_def empty_table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> qtable_empty_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q</span> empty_table <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">⟶</span> False<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> qtable_def table_def empty_table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> qtable_unit_table<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="main">{}</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> qtable <span class="free">n</span> <span class="main">{}</span> <span class="free">P</span> <span class="free">Q</span> <span class="main">(</span>unit_table <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> qtable_def table_def in_unit_table <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> qtable_union<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q1</span> <span class="free">X</span> <span class="main">⟹</span> qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q2</span> <span class="free">Y</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">⟷</span> <span class="free">Q1</span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">Q2</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> qtable_def table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> qtable_Union<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="main">(</span><span class="free">Qi</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">Xi</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">Qi</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">Xi</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">I</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">i</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_union<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?Q1.0</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">Qi</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> <span class="var">?Q2.0</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">F</span><span class="main">.</span> <span class="free">Qi</span> <span class="bound">i</span> <span class="bound">x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_empty<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> empty_table_def<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> qtable_join<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q1</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">B</span> <span class="free">P</span> <span class="free">Q2</span> <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="free">A</span> <span class="main">∪</span> <span class="free">B</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">C</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span>restrict <span class="free">B</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">b</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">C</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">⟷</span> <span class="free">Q1</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="free">Q2</span> <span class="main">(</span>restrict <span class="free">B</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="free">b</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">C</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">⟷</span> <span class="free">Q1</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">Q2</span> <span class="main">(</span>restrict <span class="free">B</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">C</span> <span class="free">P</span> <span class="free">Q</span> <span class="main">(</span>join <span class="free">X</span> <span class="free">b</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> qtableI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1-4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">C</span> <span class="main">(</span>join <span class="free">X</span> <span class="free">b</span> <span class="free">Y</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> qtable_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> join_table<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> join <span class="free">X</span> <span class="free">b</span> <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">C</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1-3<span class="main">)</span> assms<span class="main">(</span>5-7<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> qtable_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 2 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_restrict_simple <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_joinE <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">C</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1-4<span class="main">)</span> assms<span class="main">(</span>5-7<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> join <span class="free">X</span> <span class="free">b</span> <span class="free">Y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> qtable_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wf_tuple_restrict_simple <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_joinI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">Y</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> qtable_join_fixed<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q1</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">B</span> <span class="free">P</span> <span class="free">Q2</span> <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="free">A</span> <span class="main">∪</span> <span class="free">B</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">C</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span>restrict <span class="free">B</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">C</span> <span class="free">P</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">Q1</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">Q2</span> <span class="main">(</span>restrict <span class="free">B</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">¬</span> <span class="free">Q2</span> <span class="main">(</span>restrict <span class="free">B</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>join <span class="free">X</span> <span class="free">b</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> qtable_join<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_tuple_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> map the <span class="free">v</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">=</span> map the <span class="free">w</span> <span class="main">!</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">v</span> <span class="main">=</span> length <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> this assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"map the <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">z</span> <span class="main">=</span> map the <span class="skolem">ys</span> <span class="main">!</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
      <span class="keyword1"><span class="command">using</span></span> that Cons<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> bspec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">z</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_Suc_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">,</span>3-5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span><span class="main"><span class="main">]</span></span> * <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mem_restr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list set <span class="main">⇒</span> <span class="tfree">'a</span> tuple <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mem_restr</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">≠</span> None <span class="main">⟶</span> <span class="bound">a</span> <span class="main">=</span> Some <span class="bound">b</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">y</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mem_restrI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> length <span class="free">y</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">V</span><span class="main">.</span> <span class="free">x</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">y</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> mem_restr <span class="free">A</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mem_restr_def wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_conv_all_nth<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mem_restrE<span class="main">:</span> <span class="quoted"><span class="quoted">"mem_restr <span class="free">A</span> <span class="free">x</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">V</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">V</span><span class="main">.</span> <span class="free">x</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">y</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mem_restr_def wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_conv_all_nth<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mem_restr_IntD<span class="main">:</span> <span class="quoted"><span class="quoted">"mem_restr <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span> <span class="free">v</span> <span class="main">⟹</span> mem_restr <span class="free">A</span> <span class="free">v</span> <span class="main">∧</span> mem_restr <span class="free">B</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mem_restr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mem_restr_Un_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"mem_restr <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="free">x</span> <span class="main">⟷</span> mem_restr <span class="free">A</span> <span class="free">x</span> <span class="main">∨</span> mem_restr <span class="free">B</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mem_restr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> mem_restr_UNIV <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mem_restr UNIV <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mem_restr_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"map the <span class="free">x</span>"</span></span><span class="main"><span class="main">]</span></span> list.rel_refl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_mem_restr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mem_restr <span class="free">A</span> <span class="free">x</span> <span class="main">⟹</span> mem_restr <span class="free">A</span> <span class="main">(</span>restrict <span class="free">V</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mem_restr_def restrict_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_conv_all_nth <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lift_envs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list set <span class="main">⇒</span> <span class="tfree">'a</span> list set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lift_envs</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span> <span class="main">#</span> <span class="bound">b</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>UNIV <span class="main">×</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lift_envs_mem_restr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mem_restr <span class="free">A</span> <span class="free">x</span> <span class="main">⟹</span> mem_restr <span class="main">(</span>lift_envs <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mem_restr_def lift_envs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> qtable_project<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"qtable <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">A</span> <span class="main">(</span>mem_restr <span class="main">(</span>lift_envs <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> Some <span class="bound">x</span> <span class="keyword1">else</span> None<span class="main">)</span> <span class="main">#</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">`</span> <span class="free">X</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="var">?A</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="var">?P</span> <span class="var">?X</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> qtableI<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> table left right<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> table
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> qtable_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> table_project<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>left <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∉</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> qtable_def table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> left<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">v</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> image_iff hd_Cons_tl<span class="main">)</span>    
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> in_qtableE<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> left<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>right <span class="skolem">v</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> Some <span class="skolem">x</span> <span class="keyword1">else</span> None<span class="main">)</span> <span class="main">#</span> <span class="skolem">v</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> in_qtableI<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> qtable_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="free">P</span> <span class="bound">v</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">v</span> <span class="main">⟷</span> <span class="free">Q'</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟹</span> qtable <span class="free">n</span> <span class="free">B</span> <span class="free">P</span> <span class="free">Q'</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qtable_def<span class="main">)</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</body>

</html>