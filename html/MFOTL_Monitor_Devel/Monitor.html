<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Monitor</title>
</head>


<body>
<div class="head">
<h1>Theory Monitor</h1>
</div>

<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Monitor
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Abstract_Monitor.html">Abstract_Monitor</a> <a href="MFOTL.html">MFOTL</a> <a href="Table.html">Table</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Monitor implementation›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Monitorable formulas›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⟷</span> safe_formula <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> MFOTL.future_bounded <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mmonitorable_exec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>MFOTL.Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>MFOTL.is_Const <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">∨</span> MFOTL.is_Const <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>MFOTL.Neg <span class="main">(</span>MFOTL.Eq <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>MFOTL.Neg <span class="main">(</span>MFOTL.Eq <span class="main">(</span>MFOTL.Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>MFOTL.Pred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>MFOTL.Neg <span class="main">(</span>MFOTL.Or <span class="main">(</span>MFOTL.Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">⊆</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">of</span> MFOTL.Neg <span class="bound">ψ'</span> <span class="main">⇒</span> <span class="free">mmonitorable_exec</span> <span class="bound">ψ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>MFOTL.Or <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>MFOTL.Exists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>MFOTL.Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>MFOTL.Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>MFOTL.Since <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⊆</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span> MFOTL.Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="free">mmonitorable_exec</span> <span class="bound">φ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>MFOTL.Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⊆</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span> bounded <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span> MFOTL.Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="free">mmonitorable_exec</span> <span class="bound">φ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> plus_eq_enat_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">=</span> enat <span class="free">i</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span> <span class="bound">k</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> enat <span class="bound">j</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">=</span> enat <span class="bound">k</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">+</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> minus_eq_enat_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> enat <span class="free">k</span> <span class="main">=</span> enat <span class="free">i</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> enat <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">-</span> <span class="free">k</span> <span class="main">=</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> safe_formula_mmonitorable_exec<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span> <span class="main">⟹</span> MFOTL.future_bounded <span class="free">φ</span> <span class="main">⟹</span> mmonitorable_exec <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> safe_formula.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> safe_formula.simps future_bounded.simps mmonitorable_exec.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> safe_formula.simps future_bounded.simps mmonitorable_exec.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>10 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> safe_formula.simps future_bounded.simps mmonitorable_exec.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>11 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> safe_formula.simps future_bounded.simps mmonitorable_exec.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> plus_eq_enat_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_eq_enat_iff minus_eq_enat_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mmonitorable_exec_mmonitorable<span class="main">:</span> <span class="quoted"><span class="quoted">"mmonitorable_exec <span class="free">φ</span> <span class="main">⟹</span> mmonitorable <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mmonitorable_exec.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mmonitorable_def mmonitorable_exec.simps safe_formula.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>10 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mmonitorable_def mmonitorable_exec.simps safe_formula.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>11 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mmonitorable_def mmonitorable_exec.simps safe_formula.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> one_enat_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mmonitorable_def one_enat_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> monitorable_formula_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mmonitorable <span class="free">φ</span> <span class="main">=</span> mmonitorable_exec <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mmonitorable_exec_mmonitorable safe_formula_mmonitorable_exec mmonitorable_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The executable monitor›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> ts <span class="main">=</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> mbuf2 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> table list <span class="main">×</span> <span class="tfree">'a</span> table list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> msaux <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> muaux <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> table <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> mformula <span class="main">=</span>
    MRel <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> table"</span></span>
  <span class="main">|</span> MPred <span class="quoted">MFOTL.name</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.trm list"</span></span>
  <span class="main">|</span> MAnd <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mformula"</span></span> <span class="quoted">bool</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mformula"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mbuf2"</span></span>
  <span class="main">|</span> MOr <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mformula"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mformula"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mbuf2"</span></span>
  <span class="main">|</span> MExists <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mformula"</span></span>
  <span class="main">|</span> MPrev <span class="quoted">ℐ</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mformula"</span></span> <span class="quoted">bool</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> table list"</span></span> <span class="quoted"><span class="quoted">"ts list"</span></span>
  <span class="main">|</span> MNext <span class="quoted">ℐ</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mformula"</span></span> <span class="quoted">bool</span> <span class="quoted"><span class="quoted">"ts list"</span></span>
  <span class="main">|</span> MSince <span class="quoted">bool</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mformula"</span></span> <span class="quoted">ℐ</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mformula"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mbuf2"</span></span> <span class="quoted"><span class="quoted">"ts list"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> msaux"</span></span>
  <span class="main">|</span> MUntil <span class="quoted">bool</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mformula"</span></span> <span class="quoted">ℐ</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mformula"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mbuf2"</span></span> <span class="quoted"><span class="quoted">"ts list"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> muaux"</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'a</span> mstate <span class="main">=</span>
  mstate_i <span class="main">::</span> <span class="quoted">nat</span>
  mstate_m <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mformula"</span></span>
  mstate_n <span class="main">::</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eq_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.trm <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.trm <span class="main">⇒</span> <span class="tfree">'a</span> table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eq_rel</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> unit_table <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">else</span> empty_table<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eq_rel</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> singleton_table <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eq_rel</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> singleton_table <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eq_rel</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> undefined"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">neq_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.trm <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.trm <span class="main">⇒</span> <span class="tfree">'a</span> table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">neq_rel</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> empty_table <span class="keyword1">else</span> unit_table <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">neq_rel</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> empty_table <span class="keyword1">else</span> undefined<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">neq_rel</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> undefined"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">minit0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> <span class="tfree">'a</span> mformula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span>
    MFOTL.Eq <span class="bound">t1</span> <span class="bound">t2</span> <span class="main">⇒</span> MRel <span class="main">(</span>neq_rel <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">t1</span> <span class="bound">t2</span><span class="main">)</span>
  <span class="main">|</span> MFOTL.Or <span class="main">(</span>MFOTL.Neg <span class="bound">φ</span><span class="main">)</span> <span class="bound">ψ</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> safe_formula <span class="bound">ψ</span> <span class="main">∧</span> MFOTL.fv <span class="bound">ψ</span> <span class="main">⊆</span> MFOTL.fv <span class="bound">φ</span>
      <span class="keyword1">then</span> MAnd <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">φ</span><span class="main">)</span> False <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">ψ</span> <span class="keyword1">of</span> MFOTL.Neg <span class="bound">ψ</span> <span class="main">⇒</span> MAnd <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">φ</span><span class="main">)</span> True <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> undefined<span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> undefined<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> MRel <span class="main">(</span>eq_rel <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Pred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> MPred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Or <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> MOr <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Exists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> MExists <span class="main">(</span><span class="free">minit0</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> MPrev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> True <span class="main">[]</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> MNext <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> True <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Since <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> safe_formula <span class="free"><span class="bound"><span class="entity">φ</span></span></span>
    <span class="keyword1">then</span> MSince True <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[]</span> <span class="main">[]</span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span>
      MFOTL.Neg <span class="bound">φ</span> <span class="main">⇒</span> MSince False <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">φ</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[]</span> <span class="main">[]</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> undefined<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> safe_formula <span class="free"><span class="bound"><span class="entity">φ</span></span></span>
    <span class="keyword1">then</span> MUntil True <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[]</span> <span class="main">[]</span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span>
      MFOTL.Neg <span class="bound">φ</span> <span class="main">⇒</span> MUntil False <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">φ</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[]</span> <span class="main">[]</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> undefined<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">minit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> <span class="tfree">'a</span> mstate"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">minit</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> MFOTL.nfv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">in</span> <span class="main">⦇</span>mstate_i <span class="main">=</span> <span class="main">0</span><span class="main">,</span> mstate_m <span class="main">=</span> minit0 <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">,</span> mstate_n <span class="main">=</span> <span class="bound">n</span><span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mprev_next</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> <span class="tfree">'a</span> table list <span class="main">⇒</span> ts list <span class="main">⇒</span> <span class="tfree">'a</span> table list <span class="main">×</span> <span class="tfree">'a</span> table list <span class="main">×</span> ts list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mprev_next</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mprev_next</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mprev_next</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mprev_next</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">=</span> <span class="free">mprev_next</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> empty_table<span class="main">)</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mbuf2_add</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> table list <span class="main">⇒</span> <span class="tfree">'a</span> table list <span class="main">⇒</span> <span class="tfree">'a</span> mbuf2 <span class="main">⇒</span> <span class="tfree">'a</span> mbuf2"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">mbuf2_add</span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span> <span class="free"><span class="bound"><span class="entity">ys'</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">ys'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mbuf2_take</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> table <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> mbuf2 <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">×</span> <span class="tfree">'a</span> mbuf2"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mbuf2_take</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">buf</span><span class="main">)</span> <span class="main">=</span> <span class="free">mbuf2_take</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="bound">zs</span><span class="main">,</span> <span class="bound">buf</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mbuf2_take</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mbuf2t_take</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> table <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span>
  <span class="tfree">'a</span> mbuf2 <span class="main">⇒</span> ts list <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'a</span> mbuf2 <span class="main">×</span> ts list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mbuf2t_take</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">mbuf2t_take</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mbuf2t_take</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">match</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.trm list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇀</span> <span class="tfree">'a</span><span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">=</span> Some Map.empty"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free">match</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="main">(</span>MFOTL.Var <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">match</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> None
    <span class="main">|</span> Some <span class="bound">f</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">f</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span>
        None <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">|</span> Some <span class="bound">z</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="bound">z</span> <span class="keyword1">then</span> Some <span class="bound">f</span> <span class="keyword1">else</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">update_since</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> ts <span class="main">⇒</span>
  <span class="tfree">'a</span> msaux <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">×</span> <span class="tfree">'a</span> msaux"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_since</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">rel1</span></span></span> <span class="free"><span class="bound"><span class="entity">rel2</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">aux</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">[</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> join <span class="bound">rel</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">rel1</span></span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>t<span class="main">,</span> rel<span class="main">)</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">,</span> memR <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">]</span> <span class="keyword1">of</span>
        <span class="main">[]</span> <span class="main">⇒</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rel2</span></span></span><span class="main">)</span><span class="main">]</span>
      <span class="main">|</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">aux'</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> fst <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">,</span> snd <span class="bound">x</span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">rel2</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="bound">aux'</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rel2</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">aux'</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="main">(</span>foldr <span class="main">(∪)</span> <span class="main">[</span><span class="bound">rel</span><span class="main">.</span> <span class="main">(</span>t<span class="main">,</span> rel<span class="main">)</span> <span class="main">←</span> <span class="bound">aux</span><span class="main">,</span> memL <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">]</span> <span class="main">{}</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">update_until</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'a</span> muaux <span class="main">⇒</span> <span class="tfree">'a</span> muaux"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_until</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">rel1</span></span></span> <span class="free"><span class="bound"><span class="entity">rel2</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">=</span>
    <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">a1</span><span class="main">,</span> <span class="bound">a2</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="keyword1">then</span> join <span class="bound">a1</span> True <span class="free"><span class="bound"><span class="entity">rel1</span></span></span> <span class="keyword1">else</span> <span class="bound">a1</span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">rel1</span></span></span><span class="main">,</span>
      <span class="keyword1">if</span> mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">then</span> <span class="bound">a2</span> <span class="main">∪</span> join <span class="free"><span class="bound"><span class="entity">rel2</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="bound">a1</span> <span class="keyword1">else</span> <span class="bound">a2</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">@</span>
    <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rel1</span></span></span><span class="main">,</span> <span class="keyword1">if</span> memL <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">rel2</span></span></span> <span class="keyword1">else</span> empty_table<span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_until</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'a</span> muaux <span class="main">⇒</span> <span class="tfree">'a</span> table list <span class="main">×</span> <span class="tfree">'a</span> muaux"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_until</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_until</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">¬</span> memR <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span> <span class="main">=</span> <span class="free">eval_until</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="main">#</span> <span class="bound">xs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">meval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.database <span class="main">⇒</span> <span class="tfree">'a</span> mformula <span class="main">⇒</span> <span class="tfree">'a</span> table list <span class="main">×</span> <span class="tfree">'a</span> mformula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MRel <span class="free"><span class="bound"><span class="entity">rel</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">rel</span></span></span><span class="main">]</span><span class="main">,</span> MRel <span class="free"><span class="bound"><span class="entity">rel</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MPred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> tabulate <span class="bound">f</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">`</span> Option.these
    <span class="main">(</span>match <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">`</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">e'</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">db</span></span></span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="bound">e'</span> <span class="keyword1">then</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> MPred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MAnd <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">;</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">buf</span><span class="main">)</span> <span class="main">=</span> mbuf2_take <span class="main">(</span><span class="main">λ</span><span class="bound">r1</span> <span class="bound">r2</span><span class="main">.</span> join <span class="bound">r1</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="bound">r2</span><span class="main">)</span> <span class="main">(</span>mbuf2_add <span class="bound">xs</span> <span class="bound">ys</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> MAnd <span class="bound">φ</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="bound">ψ</span> <span class="bound">buf</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">;</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">buf</span><span class="main">)</span> <span class="main">=</span> mbuf2_take <span class="main">(</span><span class="main">λ</span><span class="bound">r1</span> <span class="bound">r2</span><span class="main">.</span> <span class="bound">r1</span> <span class="main">∪</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">(</span>mbuf2_add <span class="bound">xs</span> <span class="bound">ys</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> MOr <span class="bound">φ</span> <span class="bound">ψ</span> <span class="bound">buf</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MExists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">in</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> tl <span class="main">`</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">xs</span><span class="main">,</span> MExists <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MPrev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">first</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">buf</span><span class="main">,</span> <span class="bound">nts</span><span class="main">)</span> <span class="main">=</span> mprev_next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">@</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">first</span></span></span> <span class="keyword1">then</span> empty_table <span class="main">#</span> <span class="bound">zs</span> <span class="keyword1">else</span> <span class="bound">zs</span><span class="main">,</span> MPrev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">φ</span> False <span class="bound">buf</span> <span class="bound">nts</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MNext <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">first</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">first</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">first</span></span></span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span> <span class="main">#</span> <span class="bound">xs</span><span class="main">,</span> True<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> False<span class="main">)</span> <span class="main">|</span> <span class="bound">a</span> <span class="main">⇒</span> <span class="bound">a</span><span class="main">)</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">nts</span><span class="main">)</span> <span class="main">=</span> mprev_next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">xs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> MNext <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">φ</span> <span class="bound">first</span> <span class="bound">nts</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MSince <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">;</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">,</span> <span class="bound">buf</span><span class="main">,</span> <span class="bound">nts</span><span class="main">)</span> <span class="main">=</span> mbuf2t_take <span class="main">(</span><span class="main">λ</span><span class="bound">r1</span> <span class="bound">r2</span> <span class="bound">t</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">.</span>
        <span class="keyword1">let</span> <span class="main">(</span><span class="bound">z</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span> <span class="main">=</span> update_since <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="bound">r1</span> <span class="bound">r2</span> <span class="bound">t</span> <span class="bound">aux</span>
        <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">z</span><span class="main">]</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">(</span>mbuf2_add <span class="bound">xs</span> <span class="bound">ys</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> MSince <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="bound">φ</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">ψ</span> <span class="bound">buf</span> <span class="bound">nts</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MUntil <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">;</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">aux</span><span class="main">,</span> <span class="bound">buf</span><span class="main">,</span> <span class="bound">nts</span><span class="main">)</span> <span class="main">=</span> mbuf2t_take <span class="main">(</span>update_until <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">(</span>mbuf2_add <span class="bound">xs</span> <span class="bound">ys</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span> <span class="main">=</span> eval_until <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">nts</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">|</span> <span class="bound">nt</span> <span class="main">#</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">nt</span><span class="main">)</span> <span class="bound">aux</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> MUntil <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="bound">φ</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">ψ</span> <span class="bound">buf</span> <span class="bound">nts</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mstep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.database <span class="main">×</span> ts <span class="main">⇒</span> <span class="tfree">'a</span> mstate <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'a</span> tuple<span class="main">)</span> set <span class="main">×</span> <span class="tfree">'a</span> mstate"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mstep</span> <span class="free"><span class="bound"><span class="entity">tdb</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> meval <span class="main">(</span>mstate_n <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">tdb</span></span></span><span class="main">)</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">tdb</span></span></span><span class="main">)</span> <span class="main">(</span>mstate_m <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>
     <span class="keyword1">in</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="bound">X</span><span class="main">)</span> <span class="main">(</span>List.enumerate <span class="main">(</span>mstate_i <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      <span class="main">⦇</span>mstate_i <span class="main">=</span> mstate_i <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">+</span> length <span class="bound">xs</span><span class="main">,</span> mstate_m <span class="main">=</span> <span class="bound">m</span><span class="main">,</span> mstate_n <span class="main">=</span> mstate_n <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">⦈</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mstep_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"mstep <span class="free">tdb</span> <span class="free">st</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> meval <span class="main">(</span>mstate_n <span class="free">st</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">tdb</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">tdb</span><span class="main">)</span> <span class="main">(</span>mstate_m <span class="free">st</span><span class="main">)</span>
     <span class="keyword1">in</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>List.enumerate <span class="main">(</span>mstate_i <span class="free">st</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">v</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">}</span><span class="main">,</span>
      <span class="main">⦇</span>mstate_i <span class="main">=</span> mstate_i <span class="free">st</span> <span class="main">+</span> length <span class="bound">xs</span><span class="main">,</span> mstate_m <span class="main">=</span> <span class="bound">m</span><span class="main">,</span> mstate_n <span class="main">=</span> mstate_n <span class="free">st</span><span class="main">⦈</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mstep_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Progress›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">progress</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.trace <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>MFOTL.Pred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>MFOTL.Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>MFOTL.Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>MFOTL.Or <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> min <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>MFOTL.Exists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>MFOTL.Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> min <span class="main">(</span>Suc <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>MFOTL.Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>MFOTL.Since <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> min <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>MFOTL.Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span>
    Inf <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> min <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">⟶</span> memR <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> progress_And<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="main">(</span>MFOTL.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> MFOTL.And_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_And_Not<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="main">(</span>MFOTL.And_Not <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> MFOTL.And_Not_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span> <span class="main">⟹</span> progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Until <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> memR_nonzeroD less_τD spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">j'</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cInf_superset_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_le<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Until <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cInf_lower<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> progress_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"MFOTL.future_bounded <span class="free">φ</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="free">φ</span> <span class="bound">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pred <span class="skolem">e</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eq <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Or <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Or.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j1</span></span> <span class="skolem"><span class="skolem">j2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">φ1</span> <span class="skolem">j1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">φ2</span> <span class="skolem">j2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Or.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="main">(</span>MFOTL.Or <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span> <span class="main">(</span>max <span class="skolem">j1</span> <span class="skolem">j2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j1</span> <span class="main">≤</span> <span class="skolem">j2</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_mono<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Exists <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prev <span class="skolem">I</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Prev.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">φ</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Prev.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_le<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Next <span class="skolem">I</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Next.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MFOTL.future_bounded <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"MFOTL.future_bounded <span class="skolem">φ</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">φ</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Next.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Since <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Since.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j1</span></span> <span class="skolem"><span class="skolem">j2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">φ1</span> <span class="skolem">j1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">φ2</span> <span class="skolem">j2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Since.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="main">(</span>MFOTL.Since <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span> <span class="main">(</span>max <span class="skolem">j1</span> <span class="skolem">j2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j1</span> <span class="main">≤</span> <span class="skolem">j2</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_mono<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Until <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Until.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="skolem">I</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bounded_memR<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">i'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">i'</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_le_τ<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">i</span> <span class="main">+</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">σ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le memR_antimono<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Until.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j1</span></span> <span class="skolem"><span class="skolem">j2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i'</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">φ1</span> <span class="skolem">j1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i'</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">φ2</span> <span class="skolem">j2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Until.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem">i'</span></span>"</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="main">(</span>MFOTL.Until <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span> <span class="main">(</span>max <span class="skolem">j1</span> <span class="skolem">j2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> progress.simps
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> cInf_greatest<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> nonempty greatest<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> nonempty
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> trans_le_add1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> τ_mono<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"max <span class="skolem">j1</span> <span class="skolem">j2</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>greatest <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">i'</span>›</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j1</span> <span class="main">≤</span> <span class="skolem">j2</span>"</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_absorb1 max_absorb2 less_eq_Suc_le memR_antimono
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_le<span class="main"><span class="main">]</span></span> contrapos_np order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_mono<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> not_le_imp_less<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> less_imp_le<span class="main"><span class="main">]</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">i'</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less_τD<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> less_imp_le<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cInf_restrict_nat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inf <span class="free">A</span> <span class="main">=</span> Inf <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> antisym <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cInf_greatest cInf_lower Inf_nat_def1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_time_conv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free">j</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> τ <span class="free">σ'</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">=</span> progress <span class="free">σ'</span> <span class="free">φ</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Until <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">⟷</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> Until <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"bounded <span class="skolem">I</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> True * Until <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms τ_mono<span class="main">[</span><span class="operator">THEN</span> trans_le_add1<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 6 0
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> arg_cong<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted">Inf</span><span class="main"><span class="main"><span class="main">]</span></span></span>
            cInf_restrict_nat<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main"><span class="main">]</span></span></span> cInf_restrict_nat<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bounded_memR<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> Inf_UNIV_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Inf UNIV <span class="main">::</span> nat<span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cInf_eq_minimum<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_prefix_conv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">=</span> progress <span class="free">σ'</span> <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> progress_time_conv τ_prefix_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_prefix_conv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"MFOTL.sat <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">⟷</span> MFOTL.sat <span class="free">σ'</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pred <span class="skolem">e</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Γ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eq <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Or <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Exists <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prev <span class="skolem">I</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> τ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Next <span class="skolem">I</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_le<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">φ</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Next τ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Since <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_le<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Since τ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Until <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Until.prems <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bounded <span class="skolem">I</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"bounded <span class="skolem">I</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bounded_memR Inf_UNIV_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Until.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">φ1</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">φ2</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le not_le <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Suc_leI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span>"</span></span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_cInf_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">φ1</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">φ2</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> contrapos_np <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less_τD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">using</span></span> 1<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_le<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> Until.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> progress <span class="free">σ'</span> <span class="main">(</span>MFOTL.Until <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> progress_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> progress <span class="free">σ'</span> <span class="skolem">φ1</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> progress <span class="free">σ'</span> <span class="skolem">φ2</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le not_le <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Suc_leI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span>"</span></span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_cInf_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">φ1</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 21<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">φ2</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">unfolding</span></span> progress_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> contrapos_np <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less_τD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">σ'</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 31<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">using</span></span> 11<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_le<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sat.simps
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">intro</span> ex_cong iffI<span class="main"><span class="keyword3">;</span></span> <span class="operator">elim</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> LR RL<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LR <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Until.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> Until.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 2<span class="main">]</span> τ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> 3<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_diff_conv add.commute memR_antimono <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> less_imp_le order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> τ_mono<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RL <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Until.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 11<span class="main">]</span> Until.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 21<span class="main">]</span> τ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> 31<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_diff_conv add.commute memR_antimono <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> less_imp_le order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> τ_mono<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Specification›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pprogress</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.prefix <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pprogress</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> prefix_of <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="bound">σ</span> <span class="main">⟶</span> progress <span class="bound">σ</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>plen <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="bound">n</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pprogress_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ</span> <span class="main">⟹</span> pprogress <span class="free">φ</span> <span class="free">π</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pprogress_def <span class="keyword1"><span class="command">using</span></span> progress_prefix_conv
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">locale</span></span> future_bounded_mfotl <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.formula"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> future_bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"MFOTL.future_bounded <span class="free">φ</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> future_bounded_mfotl <span class="main">⊆</span> sliceable_timed_progress <span class="quoted"><span class="quoted">"MFOTL.nfv <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"MFOTL.fv <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"relevant_events <span class="free">φ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">σ</span> <span class="bound">v</span> <span class="bound">i</span><span class="main">.</span> MFOTL.sat <span class="bound">σ</span> <span class="bound">v</span> <span class="bound">i</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"pprogress <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fvi_less_nfv<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">v</span> <span class="skolem">v'</span> <span class="skolem">σ</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> sat_fvi_cong<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">v</span> <span class="skolem">S</span> <span class="skolem">σ</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> sat_slice_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">π</span> <span class="skolem">π'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="skolem">π'</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_prefix_of <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="skolem">π</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefix_of_antimono<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">≤</span> <span class="skolem">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹prefix_of <span class="skolem">π'</span> <span class="skolem">σ</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pprogress_eq plen_mono progress_mono<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">σ</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> progress <span class="skolem">σ</span> <span class="free">φ</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> future_bounded progress_ge <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> pprogress <span class="free">φ</span> <span class="main">(</span>take_prefix <span class="skolem">j</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pprogress_eq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">σ</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">π</span> <span class="skolem">σ</span> <span class="skolem">σ'</span> <span class="skolem">i</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> progress <span class="skolem">σ</span> <span class="free">φ</span> <span class="main">(</span>plen <span class="skolem">π</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pprogress_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 6 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> sat_prefix_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">π</span> <span class="skolem">π'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"plen <span class="skolem">π</span> <span class="main">=</span> plen <span class="skolem">π'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="skolem">π</span> <span class="skolem">σ</span>"</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="skolem">π'</span> <span class="skolem">σ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_prefix_of <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> plen <span class="skolem">π</span><span class="main">.</span> τ <span class="skolem">σ</span> <span class="bound">i</span> <span class="main">=</span> τ <span class="skolem">σ'</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 7 calculation
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pprogress_eq progress_time_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">locale</span></span> monitorable_mfotl <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.formula"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> monitorable<span class="main">:</span> <span class="quoted"><span class="quoted">"mmonitorable <span class="free">φ</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> monitorable_mfotl <span class="main">⊆</span> future_bounded_mfotl
  <span class="keyword1"><span class="command">using</span></span> monitorable <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mmonitorable_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_mbuf2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span>
  <span class="tfree">'a</span> mbuf2 <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_mbuf2</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">ja</span></span></span> <span class="free"><span class="bound"><span class="entity">jb</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">ja</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">jb</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">⇒</span>
    list_all2 <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">ja</span></span></span><span class="main">]</span> <span class="bound">xs</span> <span class="main">∧</span> list_all2 <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">jb</span></span></span><span class="main">]</span> <span class="bound">ys</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_mbuf2'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.trace <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list set <span class="main">⇒</span>
  <span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> <span class="tfree">'a</span> mbuf2 <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_mbuf2'</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟷</span> wf_mbuf2 <span class="main">(</span>min <span class="main">(</span>progress <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span>progress <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>progress <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span>progress <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_mbuf2'_UNIV_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="free">j</span> <span class="free">n</span> UNIV <span class="free">φ</span> <span class="free">ψ</span> <span class="free">buf</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">buf</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">⇒</span>
  list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wf_table <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>
    <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span> <span class="main">..&lt;</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span><span class="main">]</span> <span class="bound">xs</span> <span class="main">∧</span>
  list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wf_table <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>
    <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span> <span class="main">..&lt;</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span><span class="main">]</span> <span class="bound">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2'_def wf_mbuf2_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mem_restr_UNIV<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> eqTrueI<span class="main"><span class="main">,</span></span> <span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_ts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.trace <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> ts list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_ts</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">⟷</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>min <span class="main">(</span>progress <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span>progress <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Sincep</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> MFOTL.Since <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">else</span> MFOTL.Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_since_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.trace <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list set <span class="main">⇒</span> bool <span class="main">⇒</span>
    <span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> ℐ <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> <span class="tfree">'a</span> msaux <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_since_aux</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">⟷</span> sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">&gt;</span> fst <span class="bound">y</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">≤</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">∧</span> memR <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span>
      qtable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>Sincep <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>point <span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">≤</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">∧</span> memR <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> qtable_mem_restr_UNIV<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="main">(</span>mem_restr UNIV<span class="main">)</span> <span class="free">Q</span> <span class="free">X</span> <span class="main">=</span> wf_table <span class="free">n</span> <span class="free">A</span> <span class="free">Q</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> qtable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_since_aux_UNIV_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_since_aux <span class="free">σ</span> <span class="free">n</span> UNIV <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="free">aux</span> <span class="free">ne</span> <span class="main">⟷</span> sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">&gt;</span> fst <span class="bound">y</span><span class="main">)</span> <span class="free">aux</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">aux</span> <span class="main">⟶</span> <span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">∧</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span>
      wf_table <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>Sincep <span class="free">pos</span> <span class="free">φ</span> <span class="main">(</span>point <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">∧</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">aux</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_since_aux_def qtable_mem_restr_UNIV <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_until_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.trace <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list set <span class="main">⇒</span> bool <span class="main">⇒</span>
    <span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> ℐ <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> <span class="tfree">'a</span> muaux <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_until_aux</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">⟷</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r1</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">i</span> <span class="main">∧</span>
      qtable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">+</span>length <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">}</span><span class="main">.</span> MFOTL.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>
          <span class="keyword1">else</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">+</span>length <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">}</span><span class="main">.</span> MFOTL.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">r1</span> <span class="main">∧</span>
      qtable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">+</span> length <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">∧</span> mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span>
          MFOTL.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">j</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span>
          <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span><span class="main">..&lt;</span><span class="bound">j</span><span class="main">}</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="keyword1">then</span> MFOTL.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">else</span> <span class="main">¬</span> MFOTL.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">r2</span><span class="main">)</span>
    <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">+</span>length <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_until_aux_UNIV_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_until_aux <span class="free">σ</span> <span class="free">n</span> UNIV <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="free">aux</span> <span class="free">ne</span> <span class="main">⟷</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r1</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">∧</span>
      wf_table <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">pos</span>
          <span class="keyword1">then</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span><span class="main">..&lt;</span><span class="free">ne</span><span class="main">+</span>length <span class="free">aux</span><span class="main">}</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>
          <span class="keyword1">else</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span><span class="main">..&lt;</span><span class="free">ne</span><span class="main">+</span>length <span class="free">aux</span><span class="main">}</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="bound">r1</span> <span class="main">∧</span>
      wf_table <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">ne</span> <span class="main">+</span> length <span class="free">aux</span> <span class="main">∧</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span>
          MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">j</span> <span class="free">ψ</span> <span class="main">∧</span>
          <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span><span class="main">..&lt;</span><span class="bound">j</span><span class="main">}</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">pos</span> <span class="keyword1">then</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free">φ</span> <span class="keyword1">else</span> <span class="main">¬</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="bound">r2</span><span class="main">)</span>
    <span class="free">aux</span> <span class="main">[</span><span class="free">ne</span><span class="main">..&lt;</span><span class="free">ne</span><span class="main">+</span>length <span class="free">aux</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_until_aux_def qtable_mem_restr_UNIV <span class="keyword1"><span class="command">..</span></span>
   

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">wf_mformula</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.trace <span class="main">⇒</span> nat <span class="main">⇒</span>
  nat <span class="main">⇒</span> <span class="tfree">'a</span> list set <span class="main">⇒</span> <span class="tfree">'a</span> mformula <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">σ</span> <span class="entity">j</span> <span class="keyword2"><span class="keyword">where</span></span>
  Eq<span class="main">:</span> <span class="quoted"><span class="quoted">"MFOTL.is_Const <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">∨</span> MFOTL.is_Const <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">⟹</span>
    <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>MFOTL.fv_trm <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>MFOTL.fv_trm <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MRel <span class="main">(</span>eq_rel <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>MFOTL.Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> neq_Const<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> MRel <span class="main">(</span>neq_rel <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>MFOTL.Neg <span class="main">(</span>MFOTL.Eq <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> neq_Var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MRel empty_table<span class="main">)</span> <span class="main">(</span>MFOTL.Neg <span class="main">(</span>MFOTL.Eq <span class="main">(</span>MFOTL.Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> Pred<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>MFOTL.fv <span class="main">(</span>MFOTL.Pred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MPred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Pred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> And<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span> <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">χ</span></span></span> <span class="main">=</span> MFOTL.And <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span>safe_formula <span class="main">(</span>MFOTL.Neg <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span> <span class="main">∧</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⊆</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">χ</span></span></span> <span class="main">=</span> MFOTL.And_Not <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">∧</span> safe_formula <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">∧</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⊆</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    wf_mbuf2' <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MAnd <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">χ</span></span></span>"</span></span>
<span class="main">|</span> Or<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span> <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">=</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    wf_mbuf2' <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Or <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Exists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>lift_envs <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MExists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Exists <span class="free"><span class="bound"><span class="entity">φ'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Prev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">first</span></span></span> <span class="main">⟷</span> <span class="free">j</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span>
    list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free">j</span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟹</span>
    list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MPrev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">first</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Next<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">first</span></span></span> <span class="main">⟷</span> progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free">j</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span>
    list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MNext <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">first</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Since<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span> <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="main">=</span> MFOTL.Neg <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    safe_formula <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="main">⟹</span>
    MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⊆</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    wf_mbuf2' <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟹</span>
    wf_ts <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">⟹</span>
    wf_since_aux <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">(</span>progress <span class="free">σ</span> <span class="main">(</span>MFOTL.Since <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MSince <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Since <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Until<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span> <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="main">=</span> MFOTL.Neg <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    safe_formula <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="main">⟹</span>
    MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⊆</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    wf_mbuf2' <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟹</span>
    wf_ts <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">⟹</span>
    wf_until_aux <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">(</span>progress <span class="free">σ</span> <span class="main">(</span>MFOTL.Until <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟹</span>
    progress <span class="free">σ</span> <span class="main">(</span>MFOTL.Until <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span> <span class="free">j</span> <span class="main">+</span> length <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">=</span> min <span class="main">(</span>progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free">j</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MUntil <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Until <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_mstate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.prefix <span class="main">⇒</span> <span class="tfree">'a</span> list set <span class="main">⇒</span> <span class="tfree">'a</span> mstate <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_mstate</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">⟷</span> mstate_n <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> MFOTL.nfv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> prefix_of <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="bound">σ</span> <span class="main">⟶</span>
    mstate_i <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> progress <span class="bound">σ</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>plen <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">)</span> <span class="main">∧</span>
    wf_mformula <span class="bound">σ</span> <span class="main">(</span>plen <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">)</span> <span class="main">(</span>mstate_n <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>mstate_m <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Initialisation›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> minit0_And<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>safe_formula <span class="main">(</span>MFOTL.Neg <span class="free">ψ</span><span class="main">)</span> <span class="main">∧</span> MFOTL.fv <span class="free">ψ</span> <span class="main">⊆</span> MFOTL.fv <span class="free">φ</span><span class="main">)</span> <span class="main">⟹</span>
     minit0 <span class="free">n</span> <span class="main">(</span>MFOTL.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> MAnd <span class="main">(</span>minit0 <span class="free">n</span> <span class="free">φ</span><span class="main">)</span> True <span class="main">(</span>minit0 <span class="free">n</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> MFOTL.And_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> minit0_And_Not<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">ψ</span> <span class="main">∧</span> MFOTL.fv <span class="free">ψ</span> <span class="main">⊆</span> MFOTL.fv <span class="free">φ</span> <span class="main">⟹</span>
  minit0 <span class="free">n</span> <span class="main">(</span>MFOTL.And_Not <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>MAnd <span class="main">(</span>minit0 <span class="free">n</span> <span class="free">φ</span><span class="main">)</span> False <span class="main">(</span>minit0 <span class="free">n</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> MFOTL.And_Not_def MFOTL.is_Neg_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_mbuf2'_0<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="main">0</span> <span class="free">n</span> <span class="free">R</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2'_def wf_mbuf2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_ts_0<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_ts <span class="free">σ</span> <span class="main">0</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_since_aux_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_since_aux <span class="free">σ</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span> <span class="main">[]</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_since_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_until_aux_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_until_aux <span class="free">σ</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span> <span class="main">[]</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_until_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_minit0<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>MFOTL.fv <span class="free">φ</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span>
  wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="free">n</span> <span class="free">R</span> <span class="main">(</span>minit0 <span class="free">n</span> <span class="free">φ</span><span class="main">)</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">R</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> safe_formula_induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minit0_And fvi_And minit0_And_Not fvi_And_Not
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.intros wf_mbuf2'_0 wf_ts_0 wf_since_aux_Nil wf_until_aux_Nil
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fvi_Suc_bound<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_mstate_minit<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span> <span class="main">⟹</span> wf_mstate <span class="free">φ</span> pnil <span class="free">R</span> <span class="main">(</span>minit <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_mstate_def minit_def Let_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_minit0 fvi_less_nfv<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Evaluation›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> match_wf_tuple<span class="main">:</span> <span class="quoted"><span class="quoted">"Some <span class="free">f</span> <span class="main">=</span> match <span class="free">ts</span> <span class="free">xs</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span><span class="main">∈</span>set <span class="free">ts</span><span class="main">.</span> MFOTL.fv_trm <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>tabulate <span class="free">f</span> <span class="main">0</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> match_fvi_trm_None<span class="main">:</span> <span class="quoted"><span class="quoted">"Some <span class="free">f</span> <span class="main">=</span> match <span class="free">ts</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set <span class="free">ts</span><span class="main">.</span> <span class="free">x</span> <span class="main">∉</span> MFOTL.fv_trm <span class="bound">t</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> match_fvi_trm_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"Some <span class="free">f</span> <span class="main">=</span> match <span class="free">ts</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">∈</span> set <span class="free">ts</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> MFOTL.fv_trm <span class="free">t</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> match_eval_trm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set <span class="free">ts</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>MFOTL.fv_trm <span class="bound">t</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> Some <span class="free">f</span> <span class="main">=</span> match <span class="free">ts</span> <span class="free">xs</span> <span class="main">⟹</span>
    map <span class="main">(</span>MFOTL.eval_trm <span class="main">(</span>tabulate <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> the <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="free">ts</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">ts</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 3<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> match_fvi_trm_Some sym <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eval_trm_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_tuple_tabulate_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="main">(</span>tabulate <span class="free">f</span> <span class="main">0</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> Some <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ex_match<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span><span class="main">∈</span>set <span class="free">ts</span><span class="main">.</span> MFOTL.fv_trm <span class="bound">t</span><span class="main">)</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set <span class="free">ts</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>MFOTL.fv_trm <span class="bound">t</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">f</span><span class="main">.</span> match <span class="free">ts</span> <span class="main">(</span>map <span class="main">(</span>MFOTL.eval_trm <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">f</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">=</span> tabulate <span class="bound">f</span> <span class="main">0</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>MFOTL.eval_trm <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">ts</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">ts</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span><span class="main">∈</span>set <span class="skolem">ts</span><span class="main">.</span> MFOTL.fv_trm <span class="bound">t</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insert_absorb <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_tuple_tabulate_Some meta_spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> 3<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
      *<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>MFOTL.eval_trm <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ts</span> <span class="main">=</span> map <span class="main">(</span>MFOTL.eval_trm <span class="main">(</span>map the <span class="main">(</span><span class="skolem">v</span><span class="main">[</span><span class="skolem">x</span> <span class="main">:=</span> None<span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ts</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_def nth_list_update <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eval_trm_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> False 3<span class="main">(</span>2-4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"match <span class="skolem">ts</span> <span class="main">(</span>map <span class="main">(</span>MFOTL.eval_trm <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">[</span><span class="skolem">x</span> <span class="main">:=</span> None<span class="main">]</span> <span class="main">=</span> tabulate <span class="skolem">f</span> <span class="main">0</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> *
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> 3<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">v</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span> <span class="main"><span class="main"><span class="main">:=</span></span></span> None<span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_def nth_list_update <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eval_trm_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> False this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> None"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">v</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> match_fvi_trm_None<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sym<span class="main"><span class="main">]</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">length</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq wf_tuple_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_rel_eval_trm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> eq_rel <span class="free">n</span> <span class="free">t1</span> <span class="free">t2</span> <span class="main">⟹</span> MFOTL.is_Const <span class="free">t1</span> <span class="main">∨</span> MFOTL.is_Const <span class="free">t2</span> <span class="main">⟹</span>
  <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>MFOTL.fv_trm <span class="free">t1</span> <span class="main">∪</span> MFOTL.fv_trm <span class="free">t2</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span>
  MFOTL.eval_trm <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span> <span class="free">t1</span> <span class="main">=</span> MFOTL.eval_trm <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">t2</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> singleton_table_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_eq_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="main">(</span>MFOTL.fv_trm <span class="free">t1</span> <span class="main">∪</span> MFOTL.fv_trm <span class="free">t2</span><span class="main">)</span> <span class="free">v</span> <span class="main">⟹</span>
  MFOTL.is_Const <span class="free">t1</span> <span class="main">∨</span> MFOTL.is_Const <span class="free">t2</span> <span class="main">⟹</span>
  MFOTL.eval_trm <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span> <span class="free">t1</span> <span class="main">=</span> MFOTL.eval_trm <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span> <span class="free">t2</span> <span class="main">⟹</span>
  <span class="free">v</span> <span class="main">∈</span> eq_rel <span class="free">n</span> <span class="free">t1</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">t2</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> singleton_table_def wf_tuple_def unit_table_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nth_equalityI <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> table_eq_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"MFOTL.is_Const <span class="free">t1</span> <span class="main">∨</span> MFOTL.is_Const <span class="free">t2</span> <span class="main">⟹</span>
  table <span class="free">n</span> <span class="main">(</span>MFOTL.fv_trm <span class="free">t1</span> <span class="main">∪</span> MFOTL.fv_trm <span class="free">t2</span><span class="main">)</span> <span class="main">(</span>eq_rel <span class="free">n</span> <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">t2</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_tuple_Suc_fviD<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>MFOTL.fvi <span class="free">b</span> <span class="free">φ</span><span class="main">)</span> <span class="free">v</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="main">(</span>MFOTL.fvi <span class="main">(</span>Suc <span class="free">b</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>tl <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fvi_Suc nth_tl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> table_fvi_tl<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>MFOTL.fvi <span class="free">b</span> <span class="free">φ</span><span class="main">)</span> <span class="free">X</span> <span class="main">⟹</span> table <span class="free">n</span> <span class="main">(</span>MFOTL.fvi <span class="main">(</span>Suc <span class="free">b</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">`</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> table_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_tuple_Suc_fviD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_tuple_Suc_fvi_SomeI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> MFOTL.fvi <span class="free">b</span> <span class="free">φ</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="main">(</span>MFOTL.fvi <span class="main">(</span>Suc <span class="free">b</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span> <span class="free">v</span> <span class="main">⟹</span>
  wf_tuple <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>MFOTL.fvi <span class="free">b</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">x</span> <span class="main">#</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fvi_Suc less_Suc_eq_0_disj<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_tuple_Suc_fvi_NoneI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> MFOTL.fvi <span class="free">b</span> <span class="free">φ</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="main">(</span>MFOTL.fvi <span class="main">(</span>Suc <span class="free">b</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span> <span class="free">v</span> <span class="main">⟹</span>
  wf_tuple <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>MFOTL.fvi <span class="free">b</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>None <span class="main">#</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fvi_Suc less_Suc_eq_0_disj<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> qtable_project_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="main">(</span>lift_envs <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="free">X</span> <span class="main">⟹</span>
    qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fvi <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">∈</span> fv <span class="free">φ</span> <span class="keyword1">then</span> Some <span class="bound">x</span> <span class="keyword1">else</span> None<span class="main">)</span> <span class="main">#</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">`</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> neq0_conv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff Bex_def fvi_Suc <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_cong <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_project<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mprev<span class="main">:</span> <span class="quoted"><span class="quoted">"mprev_next <span class="free">I</span> <span class="free">xs</span> <span class="free">ts</span> <span class="main">=</span> <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">xs'</span><span class="main">,</span> <span class="free">ts'</span><span class="main">)</span> <span class="main">⟹</span>
  list_all2 <span class="free">P</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j'</span><span class="main">]</span> <span class="free">xs</span> <span class="main">⟹</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free">ts</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j'</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span>
  list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">X</span><span class="main">.</span> <span class="keyword1">if</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free">P</span> <span class="bound">i</span> <span class="bound">X</span> <span class="keyword1">else</span> <span class="bound">X</span> <span class="main">=</span> empty_table<span class="main">)</span>
    <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span>min <span class="free">j'</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="free">ys</span> <span class="main">∧</span>
  list_all2 <span class="free">P</span> <span class="main">[</span>min <span class="free">j'</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">..&lt;</span><span class="free">j'</span><span class="main">]</span> <span class="free">xs'</span> <span class="main">∧</span>
  list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>min <span class="free">j'</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free">ts'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">xs'</span></span> <span class="quoted"><span class="free">ts'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mprev_next.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">I</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="free">j'</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">I</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="free">j'</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">I</span> <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 4<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"tl <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="skolem">xs'</span></span> <span class="quoted"><span class="skolem">ts'</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span> 4<span class="main">(</span>2-6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv Suc_less_eq2
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.rel_mono_strong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> mnext<span class="main">:</span> <span class="quoted"><span class="quoted">"mprev_next <span class="free">I</span> <span class="free">xs</span> <span class="free">ts</span> <span class="main">=</span> <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">xs'</span><span class="main">,</span> <span class="free">ts'</span><span class="main">)</span> <span class="main">⟹</span>
  list_all2 <span class="free">P</span> <span class="main">[</span>Suc <span class="free">i</span><span class="main">..&lt;</span><span class="free">j'</span><span class="main">]</span> <span class="free">xs</span> <span class="main">⟹</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free">ts</span> <span class="main">⟹</span> Suc <span class="free">i</span> <span class="main">≤</span> <span class="free">j'</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span>
  list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">X</span><span class="main">.</span> <span class="keyword1">if</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="bound">X</span> <span class="keyword1">else</span> <span class="bound">X</span> <span class="main">=</span> empty_table<span class="main">)</span>
    <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span>min <span class="main">(</span><span class="free">j'</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="free">ys</span> <span class="main">∧</span>
  list_all2 <span class="free">P</span> <span class="main">[</span>Suc <span class="main">(</span>min <span class="main">(</span><span class="free">j'</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">..&lt;</span><span class="free">j'</span><span class="main">]</span> <span class="free">xs'</span> <span class="main">∧</span>
  list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>min <span class="main">(</span><span class="free">j'</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free">ts'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">xs'</span></span> <span class="quoted"><span class="free">ts'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mprev_next.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">I</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="free">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">I</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="free">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">I</span> <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 4<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"tl <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="skolem">xs'</span></span> <span class="quoted"><span class="skolem">ts'</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span> 4<span class="main">(</span>2-6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv Suc_less_eq2
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.rel_mono_strong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits if_splits<span class="main">)</span> <span class="comment1">(* slow 10 sec *)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> in_foldr_UnI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> foldr <span class="main">(∪)</span> <span class="free">xs</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> in_foldr_UnE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> foldr <span class="main">(∪)</span> <span class="free">xs</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">A</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_the_restrict<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="free">φ</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="main">(</span>restrict <span class="free">A</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">=</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sat_fvi_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_the_restrict<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> update_since<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_since_aux <span class="free">σ</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="free">aux</span> <span class="free">ne</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> qtable1<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="free">φ</span><span class="main">)</span> <span class="free">rel1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> qtable2<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">rel2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> result_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">rel</span><span class="main">,</span> <span class="free">aux'</span><span class="main">)</span> <span class="main">=</span> update_since <span class="free">I</span> <span class="free">pos</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span><span class="main">)</span> <span class="free">aux</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fvi_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"MFOTL.fv <span class="free">φ</span> <span class="main">⊆</span> MFOTL.fv <span class="free">ψ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_since_aux <span class="free">σ</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="free">aux'</span> <span class="main">(</span>Suc <span class="free">ne</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="main">(</span>Sincep <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="free">rel</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?wf_tuple</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">v</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="bound">v</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> sat.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span></span></span></span><span class="main">]</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">aux0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aux0</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> join <span class="bound">rel</span> <span class="free">pos</span> <span class="free">rel1</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>t<span class="main">,</span> rel<span class="main">)</span> <span class="main">←</span> <span class="free">aux</span><span class="main">,</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> sorted_aux0<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">&gt;</span> fst <span class="bound">y</span><span class="main">)</span> <span class="skolem">aux0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pre<span class="main">[</span><span class="operator">unfolded</span> wf_since_aux_def<span class="main">,</span> <span class="operator">THEN</span> conjunct1<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> aux0_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">aux</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_wrt_append<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> in_aux0_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">aux0</span> <span class="main">⟹</span> <span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">∧</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∧</span>
      qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span>MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>Sincep <span class="free">pos</span> <span class="free">φ</span> <span class="main">(</span>point <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">∧</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="free">pos</span> <span class="keyword1">then</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="free">φ</span> <span class="keyword1">else</span> <span class="main">¬</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="skolem">X</span>
    <span class="keyword1"><span class="command">unfolding</span></span> aux0_def <span class="keyword1"><span class="command">using</span></span> fvi_subset
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 1 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_join<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ qtable1<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sat_the_restrict
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> wf_since_aux_def<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct2<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct1<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> in_aux0_le_τ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">aux0</span> <span class="main">⟹</span> <span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="skolem">X</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> τ_mono diff_le_self le_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> in_aux0_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">⟹</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">aux0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">aux</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> wf_since_aux_def<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct2<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct2<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gr0_conv_Suc <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> diff_le_mono τ_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> join <span class="skolem">X</span> <span class="free">pos</span> <span class="free">rel1</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">aux0</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> aux0_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">X</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">aux0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> aux0_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">aux0</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">ne</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">∧</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∄</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> in_aux0_2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> aux'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">aux'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">aux0</span> <span class="keyword1">of</span>
      <span class="main">[]</span> <span class="main">⇒</span> <span class="main">[</span><span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span><span class="main">,</span> <span class="free">rel2</span><span class="main">)</span><span class="main">]</span>
    <span class="main">|</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">aux'</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> fst <span class="bound">x</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">ne</span> <span class="keyword1">then</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">,</span> snd <span class="bound">x</span> <span class="main">∪</span> <span class="free">rel2</span><span class="main">)</span> <span class="main">#</span> <span class="bound">aux'</span> <span class="keyword1">else</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span><span class="main">,</span> <span class="free">rel2</span><span class="main">)</span> <span class="main">#</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">aux'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> result_eq <span class="keyword1"><span class="command">unfolding</span></span> aux0_def update_since_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> sorted_aux'<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">&gt;</span> fst <span class="bound">y</span><span class="main">)</span> <span class="free">aux'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq
    <span class="keyword1"><span class="command">using</span></span> sorted_aux0 in_aux0_le_τ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">aux0</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> in_aux'_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">∧</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∧</span>
      qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="main">(</span>Sincep <span class="free">pos</span> <span class="free">φ</span> <span class="main">(</span>point <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> aux'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">aux'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="skolem">X</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">aux0</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">with</span></span> aux' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq <span class="keyword1"><span class="command">using</span></span> qtable2 aux0_Nil
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_enat_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> sat_Since_rec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">ne</span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> t<span class="main">:</span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> aux' Cons t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> snd <span class="skolem">a</span> <span class="main">∪</span> <span class="free">rel2</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq <span class="keyword1"><span class="command">using</span></span> sorted_aux0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> in_aux0_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">a</span>"</span></span><span class="main">]</span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
          <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> fst <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> fst <span class="skolem">a</span>"</span></span>
          <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>
            <span class="main">(</span>Sincep <span class="free">pos</span> <span class="free">φ</span> <span class="main">(</span>point <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> fst <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">pos</span> <span class="keyword1">then</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="free">φ</span>
              <span class="keyword1">else</span> <span class="main">¬</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">a</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> qtable2 t True
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sat_Since_rec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">ne</span></span><span class="main"><span class="main">]</span></span> sat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_union<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> aux' Cons t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="free">rel2</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq <span class="keyword1"><span class="command">using</span></span> sorted_aux0 in_aux0_le_τ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">a</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> aux' Cons t False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq <span class="keyword1"><span class="command">using</span></span> qtable2 in_aux0_2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span><span class="main">]</span> in_aux0_le_τ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">a</span>"</span></span><span class="main">]</span> sorted_aux0
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sat_Since_rec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">ne</span></span><span class="main"><span class="main">]</span></span> sat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> zero_enat_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> enat_0_iff not_le
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ refl<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_τ_less meta_mp<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> aux' Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">aux0</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
        <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Sincep <span class="free">pos</span> <span class="free">φ</span> <span class="main">(</span>point <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">∧</span>
           <span class="main">(</span><span class="keyword1">if</span> <span class="free">pos</span> <span class="keyword1">then</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="free">φ</span> <span class="keyword1">else</span> <span class="main">¬</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> in_aux0_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">with</span></span> False aux' Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq <span class="keyword1"><span class="command">using</span></span> qtable2
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sat_Since_rec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">ne</span></span><span class="main"><span class="main">]</span></span> sat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
          diff_diff_right<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">ne</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> j<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">_</span> <span class="main">+</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> k<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span>
            <span class="operator">OF</span> trans_le_add2<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ refl<span class="main"><span class="main">]</span></span> order_trans <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> le_τ_less<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> in_aux'_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">aux'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">aux0</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> le_τ_less neq0_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> False that <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_leI Suc_pred τ_mono diff_is_0_eq' order.antisym neq0_conv not_le<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">aux0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_aux0_2<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq <span class="keyword1"><span class="command">using</span></span> False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">X</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.split<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_since_aux <span class="free">σ</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="free">aux'</span> <span class="main">(</span>Suc <span class="free">ne</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wf_since_aux_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_aux'_1 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sorted_aux' in_aux'_2<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> rel_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rel</span> <span class="main">=</span> foldr <span class="main">(∪)</span> <span class="main">[</span><span class="bound">rel</span><span class="main">.</span> <span class="main">(</span>t<span class="main">,</span> rel<span class="main">)</span> <span class="main">←</span> <span class="free">aux'</span><span class="main">,</span> memL <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">]</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq aux0_def
    <span class="keyword1"><span class="command">using</span></span> result_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> update_since_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> rel_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rel</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">rel</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">aux'</span><span class="main">.</span> <span class="keyword1">if</span> memL <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">then</span> <span class="bound">rel</span> <span class="keyword1">else</span> empty_table<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rel_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_foldr_UnE bexI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_foldr_UnI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="main">(</span>Sincep <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="free">rel</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rel_alt
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> qtable_Union<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Qi<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">X</span></span><span class="main"><span class="main">)</span></span> <span class="bound"><span class="bound">v</span></span><span class="main"><span class="main">.</span></span>
    memL <span class="free"><span class="free">I</span></span> <span class="main"><span class="main">(</span></span>τ <span class="free"><span class="free">σ</span></span> <span class="free"><span class="free">ne</span></span> <span class="main"><span class="main">-</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∧</span></span> MFOTL.sat <span class="free"><span class="free">σ</span></span> <span class="main"><span class="main">(</span></span>map the <span class="bound"><span class="bound">v</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">ne</span></span> <span class="main"><span class="main">(</span></span>Sincep <span class="free"><span class="free">pos</span></span> <span class="free"><span class="free">φ</span></span> <span class="main"><span class="main">(</span></span>point <span class="main"><span class="main">(</span></span>τ <span class="free"><span class="free">σ</span></span> <span class="free"><span class="free">ne</span></span> <span class="main"><span class="main">-</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">ψ</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">goal_cases</span> finite qtable equiv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>equiv <span class="skolem">v</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> sat_Since_point<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> left right<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>left <span class="skolem">j</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> in_aux'_2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">j</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> _ _ exI<span class="main">,</span> <span class="operator">OF</span> _ _ refl<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> right
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sat_Since_pointD <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_aux'_1<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_aux'_1 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_empty<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> length_update_until<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>update_until <span class="free">pos</span> <span class="free">I</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="free">nt</span> <span class="free">aux</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="free">aux</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> update_until_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_update_until<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_until_aux <span class="free">σ</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="free">aux</span> <span class="free">ne</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> qtable1<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free">ne</span> <span class="main">+</span> length <span class="free">aux</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span> <span class="free">rel1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> qtable2<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free">ne</span> <span class="main">+</span> length <span class="free">aux</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">rel2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fvi_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"MFOTL.fv <span class="free">φ</span> <span class="main">⊆</span> MFOTL.fv <span class="free">ψ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_until_aux <span class="free">σ</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="main">(</span>update_until <span class="free">I</span> <span class="free">pos</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">+</span> length <span class="free">aux</span><span class="main">)</span><span class="main">)</span> <span class="free">aux</span><span class="main">)</span> <span class="free">ne</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_until_aux_def length_update_until
  <span class="keyword1"><span class="command">unfolding</span></span> update_until_def list.rel_map add_Suc_right upt.simps eqTrueI<span class="main">[</span><span class="operator">OF</span> le_add1<span class="main">]</span> if_True
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> list_all2_appendI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> list.rel_map<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> old new<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> old
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> list.rel_mono_strong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> wf_until_aux_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> mono1 mono2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mono1 <span class="skolem">i</span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">v</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sat_the_restrict less_Suc_eq
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_join<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ qtable1<span class="main"><span class="main">]</span></span> qtable_union<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ qtable1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mono2 <span class="skolem">i</span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">v</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvi_subset
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sat_the_restrict less_Suc_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_union<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ qtable_join_fixed<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> qtable2<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ refl<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">+</span> length <span class="free">aux</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="comment1">(* slow 8 sec*)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> new
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_empty qtable1 qtable2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> qtable_cong<span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">+</span> length <span class="free">aux</span>"</span></span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_Suc_eq zero_enat_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_until_aux_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_until_aux <span class="free">σ</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">aux</span><span class="main">)</span> <span class="free">ne</span> <span class="main">⟹</span>
  wf_until_aux <span class="free">σ</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="free">aux</span> <span class="main">(</span>Suc <span class="free">ne</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_until_aux_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upt_conv_Cons <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_until_aux_Cons1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_until_aux <span class="free">σ</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="main">(</span><span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">a1</span><span class="main">,</span> <span class="free">a2</span><span class="main">)</span> <span class="main">#</span> <span class="free">aux</span><span class="main">)</span> <span class="free">ne</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_until_aux_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upt_conv_Cons <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_until_aux_Cons3<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_until_aux <span class="free">σ</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="main">(</span><span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">a1</span><span class="main">,</span> <span class="free">a2</span><span class="main">)</span> <span class="main">#</span> <span class="free">aux</span><span class="main">)</span> <span class="free">ne</span> <span class="main">⟹</span>
  qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="free">ne</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> Suc <span class="main">(</span><span class="free">ne</span> <span class="main">+</span> length <span class="free">aux</span><span class="main">)</span> <span class="main">∧</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">ne</span><span class="main">)</span> <span class="main">∧</span>
    MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">j</span> <span class="free">ψ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="free">ne</span><span class="main">..&lt;</span><span class="bound">j</span><span class="main">}</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">pos</span> <span class="keyword1">then</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free">φ</span> <span class="keyword1">else</span> <span class="main">¬</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">a2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_until_aux_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upt_conv_Cons <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> upt_append<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">..&lt;</span><span class="free">c</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">c</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_Suc_ex upt_add_eq_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_mbuf2_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_mbuf2 <span class="free">i</span> <span class="free">ja</span> <span class="free">jb</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="main">[</span><span class="free">ja</span><span class="main">..&lt;</span><span class="free">ja'</span><span class="main">]</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">Q</span> <span class="main">[</span><span class="free">jb</span><span class="main">..&lt;</span><span class="free">jb'</span><span class="main">]</span> <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ja</span> <span class="main">≤</span> <span class="free">ja'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">jb</span> <span class="main">≤</span> <span class="free">jb'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_mbuf2 <span class="free">i</span> <span class="free">ja'</span> <span class="free">jb'</span> <span class="free">P</span> <span class="free">Q</span> <span class="main">(</span>mbuf2_add <span class="free">xs</span> <span class="free">ys</span> <span class="free">buf</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_append2 upt_append <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">ja</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">ja</span><span class="main">..&lt;</span><span class="free">ja'</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span>
           exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">jb</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">jb</span><span class="main">..&lt;</span><span class="free">jb'</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mbuf2_take_eqD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mbuf2_take <span class="free">f</span> <span class="free">buf</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">buf'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_mbuf2 <span class="free">i</span> <span class="free">ja</span> <span class="free">jb</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">buf</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_mbuf2 <span class="main">(</span>min <span class="free">ja</span> <span class="free">jb</span><span class="main">)</span> <span class="free">ja</span> <span class="free">jb</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">buf'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">z</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">i</span> <span class="bound">y</span> <span class="main">∧</span> <span class="bound">z</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span>min <span class="free">ja</span> <span class="free">jb</span><span class="main">]</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">buf</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">buf'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mbuf2_take.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv min_absorb1 min_absorb2 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mbuf2t_take_eqD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mbuf2t_take <span class="free">f</span> <span class="free">z</span> <span class="free">buf</span> <span class="free">nts</span> <span class="main">=</span> <span class="main">(</span><span class="free">z'</span><span class="main">,</span> <span class="free">buf'</span><span class="main">,</span> <span class="free">nts'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_mbuf2 <span class="free">i</span> <span class="free">ja</span> <span class="free">jb</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free">nts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ja</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">jb</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_mbuf2 <span class="main">(</span>min <span class="free">ja</span> <span class="free">jb</span><span class="main">)</span> <span class="free">ja</span> <span class="free">jb</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">buf'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span> <span class="main">[</span>min <span class="free">ja</span> <span class="free">jb</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free">nts'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">buf</span></span> <span class="quoted"><span class="free">nts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">z'</span></span> <span class="quoted"><span class="free">buf'</span></span> <span class="quoted"><span class="free">nts'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mbuf2t_take.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv less_eq_Suc_le min_absorb1 min_absorb2
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mbuf2t_take_induct<span class="main">[</span><span class="operator">consumes</span> 5<span class="main">,</span> <span class="operator">case_names</span> base step<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mbuf2t_take <span class="free">f</span> <span class="free">z</span> <span class="free">buf</span> <span class="free">nts</span> <span class="main">=</span> <span class="main">(</span><span class="free">z'</span><span class="main">,</span> <span class="free">buf'</span><span class="main">,</span> <span class="free">nts'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_mbuf2 <span class="free">i</span> <span class="free">ja</span> <span class="free">jb</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free">nts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ja</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">jb</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="free">i</span> <span class="free">z</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">t</span> <span class="bound">z</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">⟹</span> Suc <span class="bound">k</span> <span class="main">≤</span> <span class="free">ja</span> <span class="main">⟹</span> Suc <span class="bound">k</span> <span class="main">≤</span> <span class="free">jb</span> <span class="main">⟹</span>
      <span class="free">P</span> <span class="bound">k</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">k</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">k</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="free">U</span> <span class="bound">k</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="free">U</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">t</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">(</span>min <span class="free">ja</span> <span class="free">jb</span><span class="main">)</span> <span class="free">z'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">buf</span></span> <span class="quoted"><span class="free">nts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">z'</span></span> <span class="quoted"><span class="free">buf'</span></span> <span class="quoted"><span class="free">nts'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mbuf2t_take.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv less_eq_Suc_le min_absorb1 min_absorb2
       <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">U</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ refl<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mbuf2_take_add'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mbuf2_take <span class="free">f</span> <span class="main">(</span>mbuf2_add <span class="free">xs</span> <span class="free">ys</span> <span class="free">buf</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">zs</span><span class="main">,</span> <span class="free">buf'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="free">j</span> <span class="free">n</span> <span class="free">R</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="free">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j'</span><span class="main">]</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j'</span><span class="main">]</span> <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="free">j'</span> <span class="free">n</span> <span class="free">R</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="free">buf'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">Z</span><span class="main">.</span> <span class="main">∃</span><span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span>
      qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">φ</span><span class="main">)</span> <span class="bound">X</span> <span class="main">∧</span>
      qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">ψ</span><span class="main">)</span> <span class="bound">Y</span> <span class="main">∧</span>
      <span class="bound">Z</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">X</span> <span class="bound">Y</span><span class="main">)</span>
      <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j'</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j'</span><span class="main">)</span><span class="main">]</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pre <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2'_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mbuf2_take_eqD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq<span class="main"><span class="main">]</span></span> wf_mbuf2_add<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ xs ys<span class="main"><span class="main">]</span></span> progress_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mbuf2t_take_add'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mbuf2t_take <span class="free">f</span> <span class="free">z</span> <span class="main">(</span>mbuf2_add <span class="free">xs</span> <span class="free">ys</span> <span class="free">buf</span><span class="main">)</span> <span class="free">nts</span> <span class="main">=</span> <span class="main">(</span><span class="free">z'</span><span class="main">,</span> <span class="free">buf'</span><span class="main">,</span> <span class="free">nts'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pre_buf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="free">j</span> <span class="free">n</span> <span class="free">R</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="free">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pre_nts<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="free">j'</span><span class="main">]</span> <span class="free">nts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j'</span><span class="main">]</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j'</span><span class="main">]</span> <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="free">j'</span> <span class="free">n</span> <span class="free">R</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="free">buf'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_ts <span class="free">σ</span> <span class="free">j'</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="free">nts'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pre_buf pre_nts <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2'_def wf_ts_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mbuf2t_take_eqD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq<span class="main"><span class="main">]</span></span> wf_mbuf2_add<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ xs ys<span class="main"><span class="main">]</span></span> progress_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>›</span></span><span class="main"><span class="main">]</span></span>
      progress_le<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mbuf2t_take_add_induct'<span class="main">[</span><span class="operator">consumes</span> 6<span class="main">,</span> <span class="operator">case_names</span> base step<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mbuf2t_take <span class="free">f</span> <span class="free">z</span> <span class="main">(</span>mbuf2_add <span class="free">xs</span> <span class="free">ys</span> <span class="free">buf</span><span class="main">)</span> <span class="free">nts</span> <span class="main">=</span> <span class="main">(</span><span class="free">z'</span><span class="main">,</span> <span class="free">buf'</span><span class="main">,</span> <span class="free">nts'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pre_buf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="free">j</span> <span class="free">n</span> <span class="free">R</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="free">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pre_nts<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="free">j'</span><span class="main">]</span> <span class="free">nts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j'</span><span class="main">]</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j'</span><span class="main">]</span> <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">(</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="free">z</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span> <span class="bound">X</span> <span class="bound">Y</span> <span class="bound">z</span><span class="main">.</span> min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">⟹</span>
      Suc <span class="bound">k</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j'</span> <span class="main">⟹</span> Suc <span class="bound">k</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j'</span> <span class="main">⟹</span>
      qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span> <span class="bound">X</span> <span class="main">⟹</span>
      qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free">ψ</span><span class="main">)</span> <span class="bound">Y</span> <span class="main">⟹</span>
      <span class="free">U</span> <span class="bound">k</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="free">U</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">X</span> <span class="bound">Y</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span><span class="main">)</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">(</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j'</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j'</span><span class="main">)</span><span class="main">)</span> <span class="free">z'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pre_buf pre_nts <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2'_def wf_ts_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mbuf2t_take_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq<span class="main"><span class="main">]</span></span> wf_mbuf2_add<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ xs ys<span class="main"><span class="main">]</span></span> progress_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>›</span></span><span class="main"><span class="main">]</span></span>
      progress_le base step<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_Until_le<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="main">(</span>formula.Until <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span> <span class="main">≤</span> min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> trans_le_add1 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cInf_lower<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all2_upt_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">a</span> <span class="free">x</span> <span class="main">⟹</span> list_all2 <span class="free">P</span> <span class="main">[</span>Suc <span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">]</span> <span class="free">xs</span> <span class="main">⟹</span> Suc <span class="free">a</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span>
  list_all2 <span class="free">P</span> <span class="main">[</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all2_upt_append<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="main">[</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">]</span> <span class="free">xs</span> <span class="main">⟹</span> list_all2 <span class="free">P</span> <span class="main">[</span><span class="free">b</span><span class="main">..&lt;</span><span class="free">c</span><span class="main">]</span> <span class="free">ys</span> <span class="main">⟹</span>
  <span class="free">a</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">⟹</span> list_all2 <span class="free">P</span> <span class="main">[</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">c</span><span class="main">]</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> meval<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="free">n</span> <span class="free">R</span> <span class="free">φ</span> <span class="free">φ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> meval <span class="free">n</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Γ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="free">φ</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">⇒</span> wf_mformula <span class="free">σ</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">n</span> <span class="free">R</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ'</span> <span class="main">∧</span>
    list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">φ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">φ'</span><span class="main">)</span><span class="main">)</span>
    <span class="main">[</span>progress <span class="free">σ</span> <span class="free">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free">φ'</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">]</span> <span class="bound">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">φ'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MRel <span class="skolem">rel</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">pred</span><span class="main"><span class="main">:</span></span> wf_mformula<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ball_Un <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_mformula.intros qtableI table_eq_rel eq_rel_eval_trm
        in_eq_rel qtable_empty qtable_unit_table<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MPred <span class="skolem">e</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">pred</span><span class="main"><span class="main">:</span></span> wf_mformula<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> table_def in_these_eq match_wf_tuple match_eval_trm image_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ex_match
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.intros qtableI <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MAnd <span class="skolem">φ</span> <span class="skolem">pos</span> <span class="skolem">ψ</span> <span class="skolem">buf</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MAnd.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">pred</span><span class="main"><span class="main">:</span></span> wf_mformula<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fvi_And sat_And fvi_And_Not sat_And_Not sat_the_restrict
       <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> MAnd.IH <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.And qtable_join
       <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mbuf2_take_add' <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.rel_mono_strong<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MOr <span class="skolem">φ</span> <span class="skolem">ψ</span> <span class="skolem">buf</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MOr.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">pred</span><span class="main"><span class="main">:</span></span> wf_mformula<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> MOr.IH <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Or qtable_union
       <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mbuf2_take_add' <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.rel_mono_strong<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MExists <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MExists.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">pred</span><span class="main"><span class="main">:</span></span> wf_mformula<span class="main">)</span>
      <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list.rel_map fvi_Suc sat_fvi_cong nth_Cons'
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Exists <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> MExists.IH qtable_project_fv 
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.rel_mono_strong table_fvi_tl qtable_cong sat_fvi_cong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MPrev <span class="skolem">I</span> <span class="skolem">φ</span> <span class="skolem">first</span> <span class="skolem">buf</span> <span class="skolem">nts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MPrev.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">pred</span><span class="main"><span class="main">:</span></span> wf_mformula<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prev <span class="skolem">ψ</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Γ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?φ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Γ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ls</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>mprev_next <span class="skolem">I</span> <span class="main">(</span><span class="skolem">buf</span> <span class="main">@</span> <span class="var">?xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> <span class="main">[</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>snd <span class="main">(</span>mprev_next <span class="skolem">I</span> <span class="main">(</span><span class="skolem">buf</span> <span class="main">@</span> <span class="var">?xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> <span class="main">[</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>snd <span class="main">(</span>mprev_next <span class="skolem">I</span> <span class="main">(</span><span class="skolem">buf</span> <span class="main">@</span> <span class="var">?xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> <span class="main">[</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span> <span class="bound">X</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="bound">X</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?min</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> Prev MPrev.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">R</span></span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="var">?φ</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"list_all2 <span class="var">?P</span> <span class="main">[</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">]</span> <span class="var">?xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Prev<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">X</span><span class="main">.</span> <span class="keyword1">if</span> mem <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">then</span> <span class="var">?P</span> <span class="bound">i</span> <span class="bound">X</span> <span class="keyword1">else</span> <span class="bound">X</span> <span class="main">=</span> empty_table<span class="main">)</span>
        <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">..&lt;</span><span class="var">?min</span><span class="main">]</span> <span class="var">?ls</span> <span class="main">∧</span>
       list_all2 <span class="var">?P</span> <span class="main">[</span><span class="var">?min</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">]</span> <span class="var">?rs</span> <span class="main">∧</span>
       list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="var">?min</span><span class="main">..&lt;</span>Suc <span class="free">j</span><span class="main">]</span> <span class="var">?ts</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mprev<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> progress_mono progress_le <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> 
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all2_upt_append list_all2_appendI order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> min.cobounded1<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>Suc <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> Suc <span class="main">(</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> progress_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">j</span>"</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">]</span> Prev<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> IH 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_Suc_upt<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> upt_Suc<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span> list.rel_map qtable_empty_iff
        <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Prev list.rel_mono_strong
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MNext <span class="skolem">I</span> <span class="skolem">φ</span> <span class="skolem">first</span> <span class="skolem">nts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MNext.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">pred</span><span class="main"><span class="main">:</span></span> wf_mformula<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Next <span class="skolem">ψ</span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> min<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="skolem">j</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="skolem">j</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span>
      <span class="quoted"><span class="quoted">"min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
      <span class="keyword1"><span class="command">using</span></span> progress_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">ψ</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> progress_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">ψ</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Γ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ys</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="main">(</span><span class="var">?xs</span><span class="main">,</span> <span class="skolem">first</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span> <span class="main">#</span> <span class="bound">xs</span><span class="main">,</span> True<span class="main">)</span> <span class="main">⇒</span> <span class="bound">xs</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="var">?xs</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?φ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Γ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ls</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>mprev_next <span class="skolem">I</span> <span class="var">?ys</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> <span class="main">[</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>snd <span class="main">(</span>mprev_next <span class="skolem">I</span> <span class="var">?ys</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> <span class="main">[</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>snd <span class="main">(</span>mprev_next <span class="skolem">I</span> <span class="var">?ys</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> <span class="main">[</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span> <span class="bound">X</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="bound">X</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?min</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> Next MNext.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">R</span></span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="var">?φ</span> <span class="skolem">ψ</span>"</span></span>
      <span class="quoted"><span class="quoted">"list_all2 <span class="var">?P</span> <span class="main">[</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">]</span> <span class="var">?xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Next <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">X</span><span class="main">.</span> <span class="keyword1">if</span> mem <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">then</span> <span class="var">?P</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="bound">X</span> <span class="keyword1">else</span> <span class="bound">X</span> <span class="main">=</span> empty_table<span class="main">)</span>
        <span class="main">[</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">..&lt;</span><span class="var">?min</span><span class="main">]</span> <span class="var">?ls</span> <span class="main">∧</span>
       list_all2 <span class="var">?P</span> <span class="main">[</span>Suc <span class="var">?min</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">]</span> <span class="var">?rs</span> <span class="main">∧</span>
       list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="var">?min</span><span class="main">..&lt;</span>Suc <span class="free">j</span><span class="main">]</span> <span class="var">?ts</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="free">j</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> progress_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">ψ</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span> that
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mnext<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> progress_mono list_all2_Cons2 upt_eq_Cons_conv
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all2_upt_append list_all2_appendI <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> progress_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">j</span>"</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">]</span> progress_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">ψ</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">j</span>"</span></span><span class="main">]</span> Next IH
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">&gt;</span> progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="free">j</span>"</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qtable_empty_iff le_Suc_eq le_diff_conv
         <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Next list.rel_mono_strong list_all2_appendI
         <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split list.splits if_split_asm<span class="main">)</span>  <span class="comment1">(* slow 5 sec*)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MSince <span class="skolem">pos</span> <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span> <span class="skolem">buf</span> <span class="skolem">nts</span> <span class="skolem">aux</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> sat.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> MSince.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ''</span></span> <span class="skolem"><span class="skolem">φ'''</span></span> <span class="skolem"><span class="skolem">ψ''</span></span> <span class="keyword2"><span class="keyword">where</span></span> Since_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ'</span> <span class="main">=</span> MFOTL.Since <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> <span class="skolem">pos</span> <span class="keyword1">then</span> <span class="skolem">φ'''</span> <span class="main">=</span> <span class="skolem">φ''</span> <span class="keyword1">else</span> <span class="skolem">φ'''</span> <span class="main">=</span> MFOTL.Neg <span class="skolem">φ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pos_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">φ'''</span> <span class="main">=</span> <span class="skolem">pos</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> φ<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ψ<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">ψ</span> <span class="skolem">ψ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fvi_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"MFOTL.fv <span class="skolem">φ''</span> <span class="main">⊆</span> MFOTL.fv <span class="skolem">ψ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> buf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="free">j</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ''</span> <span class="skolem">ψ''</span> <span class="skolem">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nts<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_ts <span class="free">σ</span> <span class="free">j</span> <span class="skolem">φ''</span> <span class="skolem">ψ''</span> <span class="skolem">nts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_since_aux <span class="free">σ</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">pos</span> <span class="skolem">φ''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span> <span class="skolem">aux</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="main">(</span>formula.Since <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">pred</span><span class="main"><span class="main">:</span></span> wf_mformula<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> φ'''<span class="main">:</span> <span class="quoted"><span class="quoted">"MFOTL.fv <span class="skolem">φ'''</span> <span class="main">=</span> MFOTL.fv <span class="skolem">φ''</span>"</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">φ'''</span> <span class="skolem">j</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="skolem">φ''</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">using</span></span> pos <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> nts_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span>
    <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">φ''</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ''</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>Suc <span class="free">j</span><span class="main">]</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> <span class="main">[</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nts <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> progress_le<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> min.coboundedI1<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> list_all2_appendI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> update<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_since_aux <span class="free">σ</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">pos</span> <span class="skolem">φ''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span> <span class="main">(</span>snd <span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">aux'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="main">(</span>formula.Since <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>MFOTL.fv <span class="skolem">φ'''</span> <span class="main">∪</span> MFOTL.fv <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Since <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="main">(</span>formula.Since <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="main">(</span>formula.Since <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">aux'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> eval_φ<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Γ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eval_ψ<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Γ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ys</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mbuf2t_take <span class="main">(</span><span class="main">λ</span><span class="bound">r1</span> <span class="bound">r2</span> <span class="bound">t</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">.</span>
        <span class="keyword1">case</span> update_since <span class="skolem">I</span> <span class="skolem">pos</span> <span class="bound">r1</span> <span class="bound">r2</span> <span class="bound">t</span> <span class="bound">aux</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">z</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">zs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">z</span><span class="main">]</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">aux</span><span class="main">)</span> <span class="main">(</span>mbuf2_add <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">buf</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> <span class="main">[</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">aux'</span><span class="main">)</span><span class="main">,</span> <span class="skolem">buf'</span><span class="main">,</span> <span class="skolem">nts'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">zs</span> <span class="skolem">aux'</span> <span class="skolem">buf'</span> <span class="skolem">nts'</span>
    <span class="keyword1"><span class="command">unfolding</span></span> progress.simps φ'''
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mbuf2t_take_add_induct'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="free"><span class="free">j</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> z'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">zs</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">aux'</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> eq buf nts_snoc<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">goal_cases</span> xs ys _ base step<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> xs
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> MSince.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> φ<span class="main">]</span> eval_φ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> ys
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> MSince.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ψ<span class="main">]</span> eval_ψ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> base
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command">using</span></span> aux <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> φ'''<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">k</span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">z</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> fvi_subset pos
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Un_absorb1 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> update_since<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list_all2_appendI <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> update_since<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> MSince.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> φ<span class="main">]</span> MSince.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ψ<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Since_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_mformula.Since<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _  _ pos pos_eq fvi_subset<span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mbuf2t_take_add'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ buf nts_snoc<span class="main"><span class="main">]</span></span> mbuf2t_take_add'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ buf nts_snoc<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MUntil <span class="skolem">pos</span> <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span> <span class="skolem">buf</span> <span class="skolem">nts</span> <span class="skolem">aux</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> sat.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span></span></span></span><span class="main">]</span> progress.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> MUntil.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ''</span></span> <span class="skolem"><span class="skolem">φ'''</span></span> <span class="skolem"><span class="skolem">ψ''</span></span> <span class="keyword2"><span class="keyword">where</span></span> Until_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ'</span> <span class="main">=</span> MFOTL.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> <span class="skolem">pos</span> <span class="keyword1">then</span> <span class="skolem">φ'''</span> <span class="main">=</span> <span class="skolem">φ''</span> <span class="keyword1">else</span> <span class="skolem">φ'''</span> <span class="main">=</span> MFOTL.Neg <span class="skolem">φ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pos_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">φ'''</span> <span class="main">=</span> <span class="skolem">pos</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> φ<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ψ<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">ψ</span> <span class="skolem">ψ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fvi_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"MFOTL.fv <span class="skolem">φ''</span> <span class="main">⊆</span> MFOTL.fv <span class="skolem">ψ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> buf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="free">j</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ''</span> <span class="skolem">ψ''</span> <span class="skolem">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nts<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_ts <span class="free">σ</span> <span class="free">j</span> <span class="skolem">φ''</span> <span class="skolem">ψ''</span> <span class="skolem">nts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_until_aux <span class="free">σ</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">pos</span> <span class="skolem">φ''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span> <span class="skolem">aux</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> length_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="free">j</span> <span class="main">+</span> length <span class="skolem">aux</span> <span class="main">=</span>
      min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">φ''</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ''</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">pred</span><span class="main"><span class="main">:</span></span> wf_mformula<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> φ'''<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">φ'''</span> <span class="skolem">j</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="skolem">φ''</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">using</span></span> pos <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> progress.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> nts_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span>
    <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">φ''</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ''</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>Suc <span class="free">j</span><span class="main">]</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> <span class="main">[</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nts <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> progress_le<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> min.coboundedI1<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> list_all2_appendI<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">zs</span> <span class="skolem">aux'</span> <span class="skolem">aux''</span> <span class="skolem">buf'</span> <span class="skolem">nts'</span>
    <span class="keyword3"><span class="command">assume</span></span> eval_φ<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Γ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eval_ψ<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Γ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ys</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"mbuf2t_take <span class="main">(</span>update_until <span class="skolem">I</span> <span class="skolem">pos</span><span class="main">)</span> <span class="skolem">aux</span> <span class="main">(</span>mbuf2_add <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">buf</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> <span class="main">[</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="skolem">aux'</span><span class="main">,</span> <span class="skolem">buf'</span><span class="main">,</span> <span class="skolem">nts'</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_until <span class="skolem">I</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">nts'</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> τ <span class="free">σ</span> <span class="free">j</span> <span class="main">|</span> <span class="bound">nt</span> <span class="main">#</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">nt</span><span class="main">)</span> <span class="skolem">aux'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">aux''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> update1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_until_aux <span class="free">σ</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">pos</span> <span class="skolem">φ''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span> <span class="skolem">aux'</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">∧</span>
      progress <span class="free">σ</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="free">j</span> <span class="main">+</span> length <span class="skolem">aux'</span> <span class="main">=</span>
        min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">φ'''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> MUntil.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> φ<span class="main">]</span> eval_φ MUntil.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ψ<span class="main">]</span>
        eval_ψ nts_snoc nts_snoc length_aux aux fvi_subset
      <span class="keyword1"><span class="command">unfolding</span></span> φ'''
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> mbuf2t_take_add_induct'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="free"><span class="free"><span class="free">j</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> eq1 buf<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_update_until <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> wf_update_until<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> nts'<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_ts <span class="free">σ</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="skolem">φ''</span> <span class="skolem">ψ''</span> <span class="skolem">nts'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> MUntil.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> φ<span class="main">]</span> eval_φ MUntil.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ψ<span class="main">]</span> eval_ψ nts_snoc
      <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mbuf2t_take_eqD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq1<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> progress_mono progress_le
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_mbuf2_add buf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> wf_mbuf2'_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">⟹</span>
      wf_until_aux <span class="free">σ</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">pos</span> <span class="skolem">φ''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span> <span class="skolem">aux'</span> <span class="skolem">i</span> <span class="main">⟹</span>
      <span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">aux'</span> <span class="main">=</span> min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">φ'''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
      wf_until_aux <span class="free">σ</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">pos</span> <span class="skolem">φ''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span> <span class="skolem">aux''</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
        <span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">zs</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">∧</span>
        <span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">zs</span> <span class="main">+</span> length <span class="skolem">aux''</span> <span class="main">=</span> min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">φ'''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
        list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>MFOTL.fv <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Until <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">pos</span> <span class="keyword1">then</span> <span class="skolem">φ''</span> <span class="keyword1">else</span> MFOTL.Neg <span class="skolem">φ''</span><span class="main">)</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">[</span><span class="skolem">i</span><span class="main">..&lt;</span><span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">zs</span><span class="main">]</span> <span class="skolem">zs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">using</span></span> eq2
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">aux'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">zs</span></span> <span class="quoted"><span class="skolem">aux''</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> antisym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> progress_Until_le<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">aux'</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">a1</span></span> <span class="skolem"><span class="skolem">a2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">a1</span><span class="main">,</span> <span class="skolem">a2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> aux'<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_until_aux <span class="free">σ</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">pos</span> <span class="skolem">φ''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span> <span class="skolem">aux'</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_until_aux_Cons<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">a1</span><span class="main">,</span> <span class="skolem">a2</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_until_aux_Cons1<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="main">(</span>MFOTL.fv <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="skolem">i</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> Suc <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">aux'</span><span class="main">)</span> <span class="main">∧</span> mem <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">j</span> <span class="skolem">ψ''</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="skolem">i</span><span class="main">..&lt;</span><span class="bound">j</span><span class="main">}</span><span class="main">.</span> <span class="keyword1">if</span> <span class="skolem">pos</span> <span class="keyword1">then</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="skolem">φ''</span> <span class="keyword1">else</span> <span class="main">¬</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="skolem">φ''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a2</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">a1</span><span class="main">,</span> <span class="skolem">a2</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_until_aux_Cons3<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> Suc_i_aux'<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">aux'</span> <span class="main">=</span>
          min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">φ'''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> progress <span class="free">σ</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">case</span> <span class="skolem">nts'</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> τ <span class="free">σ</span> <span class="free">j</span> <span class="main">|</span> <span class="bound">nt</span> <span class="main">#</span> <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">nt</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that nts' <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_def progress.simps
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1 list_all2_Cons2 upt_eq_Cons_conv φ'''
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cInf_lower τ_mono diff_le_mono <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits list.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">case</span> <span class="skolem">nts'</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> τ <span class="free">σ</span> <span class="free">j</span> <span class="main">|</span> <span class="bound">nt</span> <span class="main">#</span> <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">nt</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> τ_min<span class="main">:</span>  <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">(</span>min <span class="free">j</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> min <span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_of_mono monoI<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> le_progress_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">φ</span> <span class="skolem">i</span> <span class="main">⟷</span> progress <span class="free">σ</span> <span class="skolem">φ</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">φ</span> <span class="skolem">i</span>
          <span class="keyword1"><span class="command">using</span></span> progress_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">φ</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> min_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="free">j</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> Suc <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">φ'''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?min</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"min <span class="free">j</span> <span class="main">(</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">φ''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="var">?min</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">j</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> τ_mono<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> τ_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">φ''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="main">]</span></span>
           <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_le not_less φ''' <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">φ''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> that nts' <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_def progress.simps
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cInf_greatest<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="var">?X</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 1 φ''' list_all2_Cons2 upt_eq_Cons_conv
              <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits if_splits
              <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="var">?min</span>"</span></span><span class="main"><span class="main">]</span></span>
              <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> diff_le_mono diff_le_mono2 order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> diff_le_mono diff_le_mono2<span class="main"><span class="main">]</span></span> τ_mono
              <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> contrapos_np<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">≤</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">case</span> <span class="skolem">nts'</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> τ <span class="free">σ</span> <span class="free">j</span> <span class="main">|</span> <span class="bound">nt</span> <span class="main">#</span> <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">nt</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">=</span> <span class="skolem">ψ''</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="skolem">φ''</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="skolem">ψ</span>
        <span class="keyword1"><span class="command">using</span></span> that nts' <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv
          <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits if_splits
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> contrapos_np<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> diff_le_mono diff_le_mono2<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems Suc_i_aux'<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">a1</span><span class="main">,</span> <span class="skolem">a2</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ''' 1 sat.simps upt_conv_Cons <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Cons.IH<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ aux' Suc_i_aux'<span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> iff_exI qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 3 refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">note</span></span> this<span class="main">[</span><span class="operator">OF</span> progress_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_SucI<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> order.refl<span class="main"><span class="main">]</span></span> conjunct1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> update1<span class="main"><span class="main">]</span></span> conjunct2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> update1<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> update <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> MUntil.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> φ<span class="main">]</span> MUntil.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ψ<span class="main">]</span> pos pos_eq fvi_subset <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Until_eq φ''' progress.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split if_splits
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> update<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl refl<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Until
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.rel_mono_strong qtable_cong
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mbuf2t_take_add'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ buf nts_snoc<span class="main"><span class="main">]</span></span> mbuf2t_take_add'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ buf nts_snoc<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Monitor step›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_mstate_mstep<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mstate <span class="free">φ</span> <span class="free">π</span> <span class="free">R</span> <span class="free">st</span> <span class="main">⟹</span> last_ts <span class="free">π</span> <span class="main">≤</span> snd <span class="free">tdb</span> <span class="main">⟹</span>
  wf_mstate <span class="free">φ</span> <span class="main">(</span>psnoc <span class="free">π</span> <span class="free">tdb</span><span class="main">)</span> <span class="free">R</span> <span class="main">(</span>snd <span class="main">(</span>mstep <span class="free">tdb</span> <span class="free">st</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_mstate_def mstep_def Let_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> progress_mono le_imp_diff_is_add <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prefix_of_psnocE <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> meval list_all2_lengthD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mstep_output_iff<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_mstate <span class="free">φ</span> <span class="free">π</span> <span class="free">R</span> <span class="free">st</span>"</span></span> <span class="quoted"><span class="quoted">"last_ts <span class="free">π</span> <span class="main">≤</span> snd <span class="free">tdb</span>"</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="main">(</span>psnoc <span class="free">π</span> <span class="free">tdb</span><span class="main">)</span> <span class="free">σ</span>"</span></span> <span class="quoted"><span class="quoted">"mem_restr <span class="free">R</span> <span class="free">v</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> fst <span class="main">(</span>mstep <span class="free">tdb</span> <span class="free">st</span><span class="main">)</span> <span class="main">⟷</span>
    progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">(</span>Suc <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    wf_tuple <span class="main">(</span>MFOTL.nfv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>MFOTL.fv <span class="free">φ</span><span class="main">)</span> <span class="free">v</span> <span class="main">∧</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> prefix_of_psnocE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ</span>"</span></span> 
    <span class="quoted"><span class="quoted">"Γ <span class="free">σ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">tdb</span>"</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">=</span> snd <span class="free">tdb</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹prefix_of <span class="free">π</span> <span class="free">σ</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mstate_n <span class="free">st</span> <span class="main">=</span> MFOTL.nfv <span class="free">φ</span>"</span></span>
    <span class="quoted"><span class="quoted">"mstate_i <span class="free">st</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">(</span>mstate_n <span class="free">st</span><span class="main">)</span> <span class="free">R</span> <span class="main">(</span>mstate_m <span class="free">st</span><span class="main">)</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wf_mstate_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> meval<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹wf_mformula <span class="free">σ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">(</span>mstate_n <span class="free">st</span><span class="main">)</span> <span class="free">R</span> <span class="main">(</span>mstate_m <span class="free">st</span><span class="main">)</span> <span class="free">φ</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Vs</span></span> <span class="skolem"><span class="skolem">st'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"meval <span class="main">(</span>mstate_n <span class="free">st</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Γ <span class="free">σ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mstate_m <span class="free">st</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Vs</span><span class="main">,</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span>Suc <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mstate_n <span class="free">st</span><span class="main">)</span> <span class="free">R</span> <span class="skolem">st'</span> <span class="free">φ</span>"</span></span>
    <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="main">(</span>mstate_n <span class="free">st</span><span class="main">)</span> <span class="main">(</span>fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">(</span>Suc <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="skolem">Vs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"qtable <span class="main">(</span>mstate_n <span class="free">st</span><span class="main">)</span> <span class="main">(</span>fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Vs</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">(</span>Suc <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_conv_all_nth
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">-</span> progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> mstep_def Let_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_enumerate_eq list_all2_conv_all_nth progress_mono le_imp_diff_is_add
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_qtableE in_qtableI <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="skolem">Vs</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Monitor function›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">minit_safe</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">minit_safe</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> mmonitorable_exec <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">then</span> minit <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">else</span> undefined<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> minit_safe_minit<span class="main">:</span> <span class="quoted"><span class="quoted">"mmonitorable <span class="free">φ</span> <span class="main">⟹</span> minit_safe <span class="free">φ</span> <span class="main">=</span> minit <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> minit_safe_def monitorable_formula_code <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> monitorable_mfotl<span class="main">)</span> mstep_mverdicts<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mstate <span class="free">φ</span> <span class="free">π</span> <span class="free">R</span> <span class="free">st</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"last_ts <span class="free">π</span> <span class="main">≤</span> snd <span class="free">tdb</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> restrict<span class="main">:</span> <span class="quoted"><span class="quoted">"mem_restr <span class="free">R</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> fst <span class="main">(</span>mstep <span class="free">tdb</span> <span class="free">st</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> M <span class="main">(</span>psnoc <span class="free">π</span> <span class="free">tdb</span><span class="main">)</span> <span class="main">-</span> M <span class="free">π</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> p2<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="main">(</span>psnoc <span class="free">π</span> <span class="free">tdb</span><span class="main">)</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_prefix_of <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> le <span class="keyword1"><span class="command">have</span></span> p1<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prefix_of_psnocE<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> M_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p2 progress_prefix_conv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ p1<span class="main"><span class="main">]</span></span> sat_prefix_conv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ p1<span class="main"><span class="main">]</span></span> not_less
        pprogress_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p1<span class="main"><span class="main">]</span></span> pprogress_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p2<span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>  mstep_output_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf le p2 restrict<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">σ</span></span><span class="main"><span class="main">]</span></span>
             mstep_output_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf le _ restrict<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span> progress_sat_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p1<span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mstep_output_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf le p2 restrict<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span> p1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">msteps0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">msteps0</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">msteps0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tdb</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">V'</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span> <span class="main">=</span> mstep <span class="free"><span class="bound"><span class="entity">tdb</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">;</span> <span class="main">(</span><span class="bound">V''</span><span class="main">,</span> <span class="bound">st''</span><span class="main">)</span> <span class="main">=</span> <span class="free">msteps0</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="bound">st'</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">V'</span> <span class="main">∪</span> <span class="bound">V''</span><span class="main">,</span> <span class="bound">st''</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">msteps0_stateless</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">msteps0_stateless</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">msteps0_stateless</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tdb</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">V'</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span> <span class="main">=</span> mstep <span class="free"><span class="bound"><span class="entity">tdb</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="keyword1">in</span> <span class="bound">V'</span> <span class="main">∪</span> <span class="free">msteps0_stateless</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="bound">st'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> msteps0_msteps0_stateless<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>msteps0 <span class="free">w</span> <span class="free">st</span><span class="main">)</span> <span class="main">=</span> msteps0_stateless <span class="free">w</span> <span class="free">st</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">st</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> msteps <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.prefix <span class="main">⇒</span> <span class="tfree">'a</span> mstate <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'a</span> option list<span class="main">)</span> set <span class="main">×</span> <span class="tfree">'a</span> mstate"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">msteps0</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> msteps_stateless <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.prefix <span class="main">⇒</span> <span class="tfree">'a</span> mstate <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'a</span> option list<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">msteps0_stateless</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> msteps_msteps_stateless<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>msteps <span class="free">w</span> <span class="free">st</span><span class="main">)</span> <span class="main">=</span> msteps_stateless <span class="free">w</span> <span class="free">st</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> msteps0_msteps0_stateless<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> msteps0_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"msteps0 <span class="main">(</span><span class="free">π</span> <span class="main">@</span> <span class="main">[</span><span class="free">tdb</span><span class="main">]</span><span class="main">)</span> <span class="free">st</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">V'</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span> <span class="main">=</span> msteps0 <span class="free">π</span> <span class="free">st</span><span class="main">;</span> <span class="main">(</span><span class="bound">V''</span><span class="main">,</span> <span class="bound">st''</span><span class="main">)</span> <span class="main">=</span> mstep <span class="free">tdb</span> <span class="bound">st'</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">V'</span> <span class="main">∪</span> <span class="bound">V''</span><span class="main">,</span> <span class="bound">st''</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">π</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">st</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> msteps_psnoc<span class="main">:</span> <span class="quoted"><span class="quoted">"last_ts <span class="free">π</span> <span class="main">≤</span> snd <span class="free">tdb</span> <span class="main">⟹</span> msteps <span class="main">(</span>psnoc <span class="free">π</span> <span class="free">tdb</span><span class="main">)</span> <span class="free">st</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">V'</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span> <span class="main">=</span> msteps <span class="free">π</span> <span class="free">st</span><span class="main">;</span> <span class="main">(</span><span class="bound">V''</span><span class="main">,</span> <span class="bound">st''</span><span class="main">)</span> <span class="main">=</span> mstep <span class="free">tdb</span> <span class="bound">st'</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">V'</span> <span class="main">∪</span> <span class="bound">V''</span><span class="main">,</span> <span class="bound">st''</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> msteps0_snoc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits prod.splits if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">monitor</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">monitor</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">=</span> msteps_stateless <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span>minit_safe <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Suc_length_conv_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="free">n</span> <span class="main">=</span> length <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span> <span class="main">∧</span> length <span class="bound">ys</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> monitorable_mfotl<span class="main">)</span> wf_mstate_msteps<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mstate <span class="free">φ</span> <span class="free">π</span> <span class="free">R</span> <span class="free">st</span> <span class="main">⟹</span> mem_restr <span class="free">R</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">π</span> <span class="main">≤</span> <span class="free">π'</span> <span class="main">⟹</span>
  <span class="free">X</span> <span class="main">=</span> msteps <span class="main">(</span>pdrop <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="free">π'</span><span class="main">)</span> <span class="free">st</span> <span class="main">⟹</span> wf_mstate <span class="free">φ</span> <span class="free">π'</span> <span class="free">R</span> <span class="main">(</span>snd <span class="free">X</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> fst <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> M <span class="free">π'</span> <span class="main">-</span> M <span class="free">π</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"plen <span class="free">π'</span> <span class="main">-</span> plen <span class="free">π</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">st</span></span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="free">π'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">from</span></span> 0<span class="main">(</span>1<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">=</span> <span class="skolem">π'</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="skolem">st</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> 0<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>2<span class="main">,</span>5<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π''</span></span> <span class="skolem"><span class="skolem">tdb</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> plen <span class="skolem">π''</span> <span class="main">-</span> plen <span class="skolem">π</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">≤</span> <span class="skolem">π''</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">π'</span> <span class="main">=</span> psnoc <span class="skolem">π''</span> <span class="skolem">tdb</span>"</span></span> <span class="quoted"><span class="quoted">"pdrop <span class="main">(</span>plen <span class="skolem">π</span><span class="main">)</span> <span class="main">(</span>psnoc <span class="skolem">π''</span> <span class="skolem">tdb</span><span class="main">)</span> <span class="main">=</span> psnoc <span class="main">(</span>pdrop <span class="main">(</span>plen <span class="skolem">π</span><span class="main">)</span> <span class="skolem">π''</span><span class="main">)</span> <span class="skolem">tdb</span>"</span></span>
    <span class="quoted"><span class="quoted">"last_ts <span class="main">(</span>pdrop <span class="main">(</span>plen <span class="skolem">π</span><span class="main">)</span> <span class="skolem">π''</span><span class="main">)</span> <span class="main">≤</span> snd <span class="skolem">tdb</span>"</span></span> <span class="quoted"><span class="quoted">"last_ts <span class="skolem">π''</span> <span class="main">≤</span> snd <span class="skolem">tdb</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">π''</span> <span class="main">≤</span> psnoc <span class="skolem">π''</span> <span class="skolem">tdb</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> prefix<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>prefix _ _ <span class="skolem">π'</span> _ <span class="skolem">π_tdb</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">π_tdb</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">π</span> <span class="skolem">tdb</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> prefix <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">π'</span></span></span> <span class="main"><span class="main"><span class="main">@</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">π</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">tdb</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_append append_eq_Cons_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits if_splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> refl<span class="main">]</span> Suc.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> msteps_msteps_stateless<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> msteps_psnoc split_beta mstep_mverdicts
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mono_monitor<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> set_mp<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mstate_mstep<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> monitorable_mfotl<span class="main">)</span> wf_mstate_msteps_stateless<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_mstate <span class="free">φ</span> <span class="free">π</span> <span class="free">R</span> <span class="free">st</span>"</span></span> <span class="quoted"><span class="quoted">"mem_restr <span class="free">R</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">≤</span> <span class="free">π'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> msteps_stateless <span class="main">(</span>pdrop <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="free">π'</span><span class="main">)</span> <span class="free">st</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> M <span class="free">π'</span> <span class="main">-</span> M <span class="free">π</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf_mstate_msteps<span class="main">[</span><span class="operator">OF</span> assms refl<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> msteps_msteps_stateless <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> monitorable_mfotl<span class="main">)</span> wf_mstate_msteps_stateless_UNIV<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mstate <span class="free">φ</span> <span class="free">π</span> UNIV <span class="free">st</span> <span class="main">⟹</span> <span class="free">π</span> <span class="main">≤</span> <span class="free">π'</span> <span class="main">⟹</span>
  msteps_stateless <span class="main">(</span>pdrop <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="free">π'</span><span class="main">)</span> <span class="free">st</span> <span class="main">=</span> M <span class="free">π'</span> <span class="main">-</span> M <span class="free">π</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wf_mstate_msteps_stateless<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ mem_restr_UNIV<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> monitorable_mfotl<span class="main">)</span> mverdicts_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"M pnil <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def pprogress_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_mstate_minit_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"mmonitorable <span class="free">φ</span> <span class="main">⟹</span> wf_mstate <span class="free">φ</span> pnil <span class="free">R</span> <span class="main">(</span>minit_safe <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf_mstate_minit minit_safe_minit mmonitorable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> monitorable_mfotl<span class="main">)</span> monitor_mverdicts<span class="main">:</span> <span class="quoted"><span class="quoted">"monitor <span class="free">φ</span> <span class="free">π</span> <span class="main">=</span> M <span class="free">π</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> monitor_def <span class="keyword1"><span class="command">using</span></span> monitorable
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> wf_mstate_msteps_stateless_UNIV<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_mstate_minit_safe<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmonitorable_def mverdicts_Nil<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Collected correctness results›</span></span>

<span class="keyword1"><span class="command">context</span></span> monitorable_mfotl
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We summarize the main results proved above.
\begin{enumerate}
\item The term <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">M</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> describes semantically the monitor's expected behaviour:
\begin{itemize}
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] mono_monitor<span class="antiquote"><span class="antiquote">}</span></span></span></span>: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> mono_monitor<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] sound_monitor<span class="antiquote"><span class="antiquote">}</span></span></span></span>: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> sound_monitor<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] complete_monitor<span class="antiquote"><span class="antiquote">}</span></span></span></span>: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> complete_monitor<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] sliceable_M<span class="antiquote"><span class="antiquote">}</span></span></span></span>: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> sliceable_M<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\end{itemize}
\item The executable monitor's online interface <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">minit_safe</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">mstep</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  preserves the invariant <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">wf_mstate</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and produces the the verdicts according
  to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">M</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:
\begin{itemize}
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] wf_mstate_minit_safe<span class="antiquote"><span class="antiquote">}</span></span></span></span>: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> wf_mstate_minit_safe<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] wf_mstate_mstep<span class="antiquote"><span class="antiquote">}</span></span></span></span>: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> wf_mstate_mstep<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] mstep_mverdicts<span class="antiquote"><span class="antiquote">}</span></span></span></span>: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> mstep_mverdicts<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\end{itemize}
\item The executable monitor's offline interface <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">monitor</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> implements <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">M</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:
\begin{itemize}
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] monitor_mverdicts<span class="antiquote"><span class="antiquote">}</span></span></span></span>: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> monitor_mverdicts<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\end{itemize}
\end{enumerate}
›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</body>

</html>