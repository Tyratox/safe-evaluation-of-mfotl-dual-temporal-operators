<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Formula</title>
</head>


<body>
<div class="head">
<h1>Theory Formula</h1>
</div>

<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Formula
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="Event_Data.html">Event_Data</a>
    <a href="Regex.html">Regex</a>
    <span class="quoted">"<a href="../MFOTL_Monitor_Devel/Interval.html">MFOTL_Monitor_Devel.Interval</a>"</span>
    <span class="quoted">"<a href="../MFOTL_Monitor_Devel/Trace.html">MFOTL_Monitor_Devel.Trace</a>"</span>
    <span class="quoted">"<a href="../MFOTL_Monitor_Devel/Abstract_Monitor.html">MFOTL_Monitor_Devel.Abstract_Monitor</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Mapping.html">HOL-Library.Mapping</a>"</span>
    <a href="../Containers/Set_Impl.html">Containers.Set_Impl</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Metric first-order dynamic logic›</span></span>

<span class="keyword1"><span class="command">derive</span></span> <span class="main">(</span>eq<span class="main">)</span> ceq <span class="quoted">enat</span>

<span class="keyword1"><span class="command">instantiation</span></span> enat <span class="main">::</span> <span class="quoted">ccompare</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">ccompare_enat</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"enat comparator option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ccompare_enat</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="keyword1">then</span> order.Eq <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span> <span class="keyword1">then</span> order.Lt <span class="keyword1">else</span> order.Gt<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ccompare_enat_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> comparator.intro<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Formulas and satisfiability›</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">type_synonym</span></span> name <span class="main">=</span> <span class="quoted">string8</span>
<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">type_synonym</span></span> event <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">×</span> event_data list<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">type_synonym</span></span> database <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name<span class="main">,</span> event_data list set list<span class="main">)</span> mapping"</span></span>
<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">type_synonym</span></span> prefix <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">×</span> event_data list<span class="main">)</span> prefix"</span></span>
<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">type_synonym</span></span> trace <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">×</span> event_data list<span class="main">)</span> trace"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">type_synonym</span></span> env <span class="main">=</span> <span class="quoted"><span class="quoted">"event_data list"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Syntax›</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">datatype</span></span> trm <span class="main">=</span> <span class="entity">is_Var</span><span class="main">:</span> Var <span class="quoted">nat</span> <span class="main">|</span> <span class="entity">is_Const</span><span class="main">:</span> Const <span class="quoted">event_data</span>
  <span class="main">|</span> Plus <span class="quoted">trm</span> <span class="quoted">trm</span> <span class="main">|</span> Minus <span class="quoted">trm</span> <span class="quoted">trm</span> <span class="main">|</span> UMinus <span class="quoted">trm</span> <span class="main">|</span> Mult <span class="quoted">trm</span> <span class="quoted">trm</span> <span class="main">|</span> Div <span class="quoted">trm</span> <span class="quoted">trm</span> <span class="main">|</span> Mod <span class="quoted">trm</span> <span class="quoted">trm</span>
  <span class="main">|</span> F2i <span class="quoted">trm</span> <span class="main">|</span> I2f <span class="quoted">trm</span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">fvi_trm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> trm <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fvi_trm</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi_trm</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Const <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi_trm</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fvi_trm</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∪</span> <span class="free">fvi_trm</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi_trm</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Minus <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fvi_trm</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∪</span> <span class="free">fvi_trm</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi_trm</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>UMinus <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fvi_trm</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi_trm</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Mult <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fvi_trm</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∪</span> <span class="free">fvi_trm</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi_trm</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Div <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fvi_trm</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∪</span> <span class="free">fvi_trm</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi_trm</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Mod <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fvi_trm</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∪</span> <span class="free">fvi_trm</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi_trm</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>F2i <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fvi_trm</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi_trm</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>I2f <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fvi_trm</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">fv_trm</span> <span class="main">≡</span> fvi_trm <span class="main">0</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">eval_trm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"env <span class="main">⇒</span> trm <span class="main">⇒</span> event_data"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_trm</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_trm</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Const <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_trm</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">eval_trm</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free">eval_trm</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_trm</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Minus <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">eval_trm</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">-</span> <span class="free">eval_trm</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_trm</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>UMinus <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="free">eval_trm</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_trm</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Mult <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">eval_trm</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">*</span> <span class="free">eval_trm</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_trm</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Div <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">eval_trm</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">div</span> <span class="free">eval_trm</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_trm</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Mod <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">eval_trm</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">mod</span> <span class="free">eval_trm</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_trm</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>F2i <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> EInt <span class="main">(</span>integer_of_event_data <span class="main">(</span><span class="free">eval_trm</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_trm</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>I2f <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> EFloat <span class="main">(</span>double_of_event_data <span class="main">(</span><span class="free">eval_trm</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_trm_fv_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv_trm <span class="free">t</span><span class="main">.</span> <span class="free">v</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">v'</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">⟹</span> eval_trm <span class="free">v</span> <span class="free">t</span> <span class="main">=</span> eval_trm <span class="free">v'</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>


<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">datatype</span></span> agg_type <span class="main">=</span> Agg_Cnt <span class="main">|</span> Agg_Min <span class="main">|</span> Agg_Max <span class="main">|</span> Agg_Sum <span class="main">|</span> Agg_Avg <span class="main">|</span> Agg_Med
<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">type_synonym</span></span> agg_op <span class="main">=</span> <span class="quoted"><span class="quoted">"agg_type <span class="main">×</span> event_data"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">flatten_multiset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>event_data <span class="main">×</span> enat<span class="main">)</span> set <span class="main">⇒</span> event_data list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">flatten_multiset</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">.</span> replicate <span class="main">(</span>the_enat <span class="bound">c</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>csorted_list_of_set <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_agg_op</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"agg_op <span class="main">⇒</span> <span class="main">(</span>event_data <span class="main">×</span> enat<span class="main">)</span> set <span class="main">⇒</span> event_data"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_agg_op</span> <span class="main">(</span>Agg_Cnt<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y0</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> EInt <span class="main">(</span>integer_of_int <span class="main">(</span>length <span class="main">(</span>flatten_multiset <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_agg_op</span> <span class="main">(</span>Agg_Min<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y0</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> flatten_multiset <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="keyword1">of</span>
      <span class="main">[]</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">y0</span></span></span>
    <span class="main">|</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">⇒</span> foldl min <span class="bound">x</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_agg_op</span> <span class="main">(</span>Agg_Max<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y0</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> flatten_multiset <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="keyword1">of</span>
      <span class="main">[]</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">y0</span></span></span>
    <span class="main">|</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">⇒</span> foldl max <span class="bound">x</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_agg_op</span> <span class="main">(</span>Agg_Sum<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y0</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> foldl plus <span class="free"><span class="bound"><span class="entity">y0</span></span></span> <span class="main">(</span>flatten_multiset <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_agg_op</span> <span class="main">(</span>Agg_Avg<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y0</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> EFloat <span class="main">(</span><span class="keyword1">let</span> <span class="bound">xs</span> <span class="main">=</span> flatten_multiset <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="keyword1">in</span> <span class="keyword1">case</span> <span class="bound">xs</span> <span class="keyword1">of</span>
      <span class="main">[]</span> <span class="main">⇒</span> <span class="main">0</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> double_of_event_data <span class="main">(</span>foldl plus <span class="main">(</span>EInt <span class="main">0</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">/</span> double_of_int <span class="main">(</span>length <span class="bound">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_agg_op</span> <span class="main">(</span>Agg_Med<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y0</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> EFloat <span class="main">(</span><span class="keyword1">let</span> <span class="bound">xs</span> <span class="main">=</span> flatten_multiset <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">;</span> <span class="bound">u</span> <span class="main">=</span> length <span class="bound">xs</span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">u</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span>
      <span class="keyword1">let</span> <span class="bound">u'</span> <span class="main">=</span> <span class="bound">u</span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> even <span class="bound">u</span> <span class="keyword1">then</span>
        <span class="main">(</span>double_of_event_data <span class="main">(</span><span class="bound">xs</span> <span class="main">!</span> <span class="main">(</span><span class="bound">u'</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> double_of_event_data <span class="main">(</span><span class="bound">xs</span> <span class="main">!</span> <span class="bound">u'</span><span class="main">)</span> <span class="main">/</span> double_of_int <span class="numeral">2</span><span class="main">)</span>
      <span class="keyword1">else</span> double_of_event_data <span class="main">(</span><span class="bound">xs</span> <span class="main">!</span> <span class="bound">u'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span>discs_sels<span class="main">)</span> formula <span class="main">=</span> Pred <span class="quoted">name</span> <span class="quoted"><span class="quoted">"trm list"</span></span>
  <span class="main">|</span> Let <span class="quoted">name</span> <span class="quoted">formula</span> <span class="quoted">formula</span>
  <span class="main">|</span> Eq <span class="quoted">trm</span> <span class="quoted">trm</span> <span class="main">|</span> Less <span class="quoted">trm</span> <span class="quoted">trm</span> <span class="main">|</span> LessEq <span class="quoted">trm</span> <span class="quoted">trm</span>
  <span class="main">|</span> Neg <span class="quoted">formula</span> <span class="main">|</span> Or <span class="quoted">formula</span> <span class="quoted">formula</span> <span class="main">|</span> And <span class="quoted">formula</span> <span class="quoted">formula</span> <span class="main">|</span> Ands <span class="quoted"><span class="quoted">"formula list"</span></span> <span class="main">|</span> Exists <span class="quoted">formula</span>
  <span class="main">|</span> Agg <span class="quoted">nat</span> <span class="quoted">agg_op</span> <span class="quoted">nat</span> <span class="quoted">trm</span> <span class="quoted">formula</span>
  <span class="main">|</span> Prev <span class="quoted">ℐ</span> <span class="quoted">formula</span> <span class="main">|</span> Next <span class="quoted">ℐ</span> <span class="quoted">formula</span>
  <span class="main">|</span> Since <span class="quoted">formula</span> <span class="quoted">ℐ</span> <span class="quoted">formula</span> <span class="main">|</span> Until <span class="quoted">formula</span> <span class="quoted">ℐ</span> <span class="quoted">formula</span>
  <span class="main">|</span> Trigger <span class="quoted">formula</span> <span class="quoted">ℐ</span> <span class="quoted">formula</span> <span class="main">|</span> Release <span class="quoted">formula</span> <span class="quoted">ℐ</span> <span class="quoted">formula</span>
  <span class="main">|</span> MatchF <span class="quoted">ℐ</span> <span class="quoted"><span class="quoted">"formula Regex.regex"</span></span> <span class="main">|</span> MatchP <span class="quoted">ℐ</span> <span class="quoted"><span class="quoted">"formula Regex.regex"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">FF</span> <span class="main">=</span> Exists <span class="main">(</span>Neg <span class="main">(</span>Eq <span class="main">(</span>Var <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Var <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">TT</span> <span class="main">≡</span> Neg FF"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">fvi</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> formula <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Pred <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">.</span> fvi_trm <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Let <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> fvi_trm <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">∪</span> fvi_trm <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Less <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> fvi_trm <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">∪</span> fvi_trm <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>LessEq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> fvi_trm <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">∪</span> fvi_trm <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Ands <span class="free"><span class="bound"><span class="entity">φs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">xs</span> <span class="main">=</span> map <span class="main">(</span><span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="keyword1">in</span> <span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="bound">xs</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Exists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fvi</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Agg <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b'</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fvi</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">b'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> fvi_trm <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">b'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Since <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Trigger <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Release <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>MatchF <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Regex.fv_regex <span class="main">(</span><span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>MatchP <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Regex.fv_regex <span class="main">(</span><span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">fv</span> <span class="main">≡</span> fvi <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">fv_regex</span> <span class="main">≡</span> Regex.fv_regex fv"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fv_abbrevs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv TT <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"fv FF <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> TT_def FF_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fvi_abbrevs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span><span class="main">.</span> fvi <span class="bound">b</span> TT <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">b</span><span class="main">.</span> fvi <span class="bound">b</span> FF <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> TT_def FF_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fv_subset_Ands<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">∈</span> set <span class="free">φs</span> <span class="main">⟹</span> fv <span class="free">φ</span> <span class="main">⊆</span> fv <span class="main">(</span>Ands <span class="free">φs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_fvi_trm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>fvi_trm <span class="free">b</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_fvi<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>fvi <span class="free">b</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> fvi_trm_plus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> fvi_trm <span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span> <span class="free">t</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">+</span> <span class="free">c</span> <span class="main">∈</span> fvi_trm <span class="free">b</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fvi_trm_iff_fv_trm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> fvi_trm <span class="free">b</span> <span class="free">t</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">+</span> <span class="free">b</span> <span class="main">∈</span> fv_trm <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fvi_trm_plus<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">b</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> fvi_plus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> fvi <span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">+</span> <span class="free">c</span> <span class="main">∈</span> fvi <span class="free">b</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> formula.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Exists <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b'</span> <span class="skolem">f</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">+</span> <span class="free">c</span> <span class="main">+</span> <span class="skolem">b'</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">+</span> <span class="skolem">b'</span> <span class="main">+</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> Agg <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> * fvi_trm_plus<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fvi_trm_plus fv_regex_commute<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">c</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fvi_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> fvi <span class="main">(</span>Suc <span class="free">b</span><span class="main">)</span> <span class="free">φ</span> <span class="main">⟷</span> Suc <span class="free">x</span> <span class="main">∈</span> fvi <span class="free">b</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fvi_plus<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> fvi_plus_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>fvi <span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span> <span class="free">φ</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>fvi <span class="free">b</span> <span class="free">φ</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">c</span> <span class="main">+</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> fvi <span class="free">b</span> <span class="free">φ</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">c</span> <span class="main">+</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">c</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">i'</span> <span class="main">+</span> <span class="free">c</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nat_le_iff_add <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_less<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> fvi <span class="free">b</span> <span class="free">φ</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fvi_plus<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fvi_Suc_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>fvi <span class="main">(</span>Suc <span class="free">b</span><span class="main">)</span> <span class="free">φ</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>fvi <span class="free">b</span> <span class="free">φ</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> Suc <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms fvi_plus_bound<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> fvi_iff_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> fvi <span class="free">b</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">+</span> <span class="free">b</span> <span class="main">∈</span> fv <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fvi_plus<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> c<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">b</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">nfv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"formula <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nfv</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> Max <span class="main">(</span>insert <span class="main">0</span> <span class="main">(</span>Suc <span class="main">`</span> fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">nfv_regex</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nfv_regex</span> <span class="main">≡</span> Regex.nfv_regex fv"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">envs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"formula <span class="main">⇒</span> env set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">envs</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> length <span class="bound">v</span> <span class="main">=</span> nfv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nfv_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nfv <span class="main">(</span>Let <span class="free">p</span> <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> nfv <span class="free">ψ</span>"</span></span>
  <span class="quoted"><span class="quoted">"nfv <span class="main">(</span>Neg <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> nfv <span class="free">φ</span>"</span></span>
  <span class="quoted"><span class="quoted">"nfv <span class="main">(</span>Or <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>nfv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>nfv <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"nfv <span class="main">(</span>And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>nfv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>nfv <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"nfv <span class="main">(</span>Prev <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> nfv <span class="free">φ</span>"</span></span>
  <span class="quoted"><span class="quoted">"nfv <span class="main">(</span>Next <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> nfv <span class="free">φ</span>"</span></span>
  <span class="quoted"><span class="quoted">"nfv <span class="main">(</span>Since <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>nfv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>nfv <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"nfv <span class="main">(</span>Until <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>nfv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>nfv <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"nfv <span class="main">(</span>MatchP <span class="free">I</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Regex.nfv_regex fv <span class="free">r</span>"</span></span>
  <span class="quoted"><span class="quoted">"nfv <span class="main">(</span>MatchF <span class="free">I</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Regex.nfv_regex fv <span class="free">r</span>"</span></span>
  <span class="quoted"><span class="quoted">"nfv_regex <span class="main">(</span>Regex.Skip <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"nfv_regex <span class="main">(</span>Regex.Test <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> Max <span class="main">(</span>insert <span class="main">0</span> <span class="main">(</span>Suc <span class="main">`</span> fv <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"nfv_regex <span class="main">(</span>Regex.Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>nfv_regex <span class="free">r</span><span class="main">)</span> <span class="main">(</span>nfv_regex <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"nfv_regex <span class="main">(</span>Regex.Times <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>nfv_regex <span class="free">r</span><span class="main">)</span> <span class="main">(</span>nfv_regex <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"nfv_regex <span class="main">(</span>Regex.Star <span class="free">r</span><span class="main">)</span> <span class="main">=</span> nfv_regex <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nfv_def Regex.nfv_regex_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_Un Max_Un<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nfv_Ands<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nfv <span class="main">(</span>Ands <span class="free">l</span><span class="main">)</span> <span class="main">=</span> Max <span class="main">(</span>insert <span class="main">0</span> <span class="main">(</span>nfv <span class="main">`</span> set <span class="free">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> nfv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>Ands <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fv <span class="skolem">a</span> <span class="main">∪</span> fv <span class="main">(</span>Ands <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nfv <span class="main">(</span>Ands <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>nfv <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>nfv <span class="main">(</span>Ands <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nfv_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_Un Max.union<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Cons.IH <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fvi_less_nfv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>fv <span class="free">φ</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> nfv <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nfv_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Max_gr_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> max.strict_coboundedI2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fvi_less_nfv_regex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>fv_regex <span class="free">φ</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> nfv_regex <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Regex.nfv_regex_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Max_gr_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> max.strict_coboundedI2<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Future reach›</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">future_bounded</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"formula <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">future_bounded</span> <span class="main">(</span>Pred <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">future_bounded</span> <span class="main">(</span>Let <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">future_bounded</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">future_bounded</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">future_bounded</span> <span class="main">(</span>Eq <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">future_bounded</span> <span class="main">(</span>Less <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">future_bounded</span> <span class="main">(</span>LessEq <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">future_bounded</span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">future_bounded</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">future_bounded</span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">future_bounded</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">future_bounded</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">future_bounded</span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">future_bounded</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">future_bounded</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">future_bounded</span> <span class="main">(</span>Ands <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> list_all <span class="free">future_bounded</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">future_bounded</span> <span class="main">(</span>Exists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">future_bounded</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">future_bounded</span> <span class="main">(</span>Agg <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">future_bounded</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">future_bounded</span> <span class="main">(</span>Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">future_bounded</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">future_bounded</span> <span class="main">(</span>Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">future_bounded</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">future_bounded</span> <span class="main">(</span>Since <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">future_bounded</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">future_bounded</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">future_bounded</span> <span class="main">(</span>Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">future_bounded</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">future_bounded</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span> bounded <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">future_bounded</span> <span class="main">(</span>Trigger <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">future_bounded</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">future_bounded</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">future_bounded</span> <span class="main">(</span>Release <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">future_bounded</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">future_bounded</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span> bounded <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">future_bounded</span> <span class="main">(</span>MatchP <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Regex.pred_regex <span class="free">future_bounded</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">future_bounded</span> <span class="main">(</span>MatchF <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Regex.pred_regex <span class="free">future_bounded</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> bounded <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Semantics›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">ecard</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> finite <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">then</span> card <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">else</span> <span class="main">∞</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">sat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"trace <span class="main">⇒</span> <span class="main">(</span>name <span class="main">⇀</span> nat <span class="main">⇒</span> event_data list set<span class="main">)</span> <span class="main">⇒</span> env <span class="main">⇒</span> nat <span class="main">⇒</span> formula <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Pred <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">of</span>
       None <span class="main">⇒</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> map <span class="main">(</span>eval_trm <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">∈</span> Γ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>
     <span class="main">|</span> Some <span class="bound">X</span> <span class="main">⇒</span> map <span class="main">(</span>eval_trm <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">∈</span> <span class="bound">X</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Let <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">↦</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> length <span class="bound">v</span> <span class="main">=</span> nfv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="bound">v</span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>eval_trm <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> eval_trm <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Less <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>eval_trm <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">&lt;</span> eval_trm <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>LessEq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>eval_trm <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">≤</span> eval_trm <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> <span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∨</span> <span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Ands <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">.</span> <span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">φ</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Exists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Agg <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">M</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> ecard <span class="bound">Zs</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">Zs</span><span class="main">.</span> <span class="bound">Zs</span> <span class="main">=</span> <span class="main">{</span><span class="bound">zs</span><span class="main">.</span> length <span class="bound">zs</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∧</span> <span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span><span class="bound">zs</span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> eval_trm <span class="main">(</span><span class="bound">zs</span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">Zs</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="bound">M</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟶</span> fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> eval_agg_op <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="bound">M</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> False <span class="main">|</span> Suc <span class="bound">j</span> <span class="main">⇒</span> mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span> <span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">j</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">-</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Since <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">.</span> mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span> <span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">j</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">j</span> <span class="main">&lt;..</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">}</span><span class="main">.</span> <span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">.</span> mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">j</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">..&lt;</span> <span class="bound">j</span><span class="main">}</span><span class="main">.</span> <span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Trigger <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">.</span> <span class="main">(</span>mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">j</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">j</span> <span class="main">&lt;..</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">}</span><span class="main">.</span> <span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Release <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">.</span> <span class="main">(</span>mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">j</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">..&lt;</span> <span class="bound">j</span><span class="main">}</span><span class="main">.</span> <span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>MatchP <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">.</span> mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span> Regex.match <span class="main">(</span><span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">j</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>MatchF <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">.</span> mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">∧</span> Regex.match <span class="main">(</span><span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">j</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sat_abbrevs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> TT"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> FF"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> TT_def FF_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_Ands<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Ands <span class="free">l</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">φ</span><span class="main">∈</span>set <span class="free">l</span><span class="main">.</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="bound">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_Until_rec<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Until <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">⟷</span>
  memL <span class="free">I</span> <span class="main">0</span> <span class="main">∧</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="free">ψ</span> <span class="main">∨</span>
  <span class="main">(</span>memR <span class="free">I</span> <span class="main">(</span>Δ <span class="free">σ</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">∧</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Until <span class="free">φ</span> <span class="main">(</span>subtract <span class="main">(</span>Δ <span class="free">σ</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">elim</span> disjE conjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">ψ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="skolem">j</span><span class="main">}</span><span class="main">.</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> j<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I</span> <span class="main">(</span>Δ <span class="free">σ</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_le_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> False j<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> False j <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Until <span class="free">φ</span> <span class="main">(</span>subtract <span class="main">(</span>Δ <span class="free">σ</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Δ<span class="main">:</span> <span class="quoted"><span class="quoted">"memR <span class="free">I</span> <span class="main">(</span>Δ <span class="free">σ</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> now<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted">"next"</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Until <span class="free">φ</span> <span class="main">(</span>subtract <span class="main">(</span>Δ <span class="free">σ</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"next"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span><span class="main">(</span>subtract <span class="main">(</span>Δ <span class="free">σ</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">ψ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">..&lt;</span> <span class="skolem">j</span><span class="main">}</span><span class="main">.</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_le_mono memL_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Δ j<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> now j<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_eq_less_or_eq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_Since_rec<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Since <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">⟷</span>
  mem <span class="free">I</span> <span class="main">0</span> <span class="main">∧</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="free">ψ</span> <span class="main">∨</span>
  <span class="main">(</span><span class="free">i</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> memR <span class="free">I</span> <span class="main">(</span>Δ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">∧</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Since <span class="free">φ</span> <span class="main">(</span>subtract <span class="main">(</span>Δ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">elim</span> disjE conjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">ψ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span><span class="main">.</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> j<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> j<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I</span> <span class="main">(</span>Δ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_le_mono2 le_Suc_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> False j<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> False j <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Since <span class="free">φ</span> <span class="main">(</span>subtract <span class="main">(</span>Δ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Δ<span class="main">:</span> <span class="quoted"><span class="quoted">"memR <span class="free">I</span> <span class="main">(</span>Δ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> now<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted">"prev"</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Since <span class="free">φ</span> <span class="main">(</span>subtract <span class="main">(</span>Δ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"prev"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>subtract <span class="main">(</span>Δ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">ψ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span> <span class="main">&lt;..</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_le_mono2 memL_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Δ i j<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> now i j<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_Suc_eq gr0_conv_Suc <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_MatchF_rec<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>MatchF <span class="free">I</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟷</span> memL <span class="free">I</span> <span class="main">0</span> <span class="main">∧</span> Regex.eps <span class="main">(</span>sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="main">∨</span>
  memR <span class="free">I</span> <span class="main">(</span>Δ <span class="free">σ</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span> <span class="main">∈</span> Regex.lpd <span class="main">(</span>sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span><span class="main">.</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>MatchF <span class="main">(</span>subtract <span class="main">(</span>Δ <span class="free">σ</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R1</span> <span class="main">∨</span> <span class="var">?R2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">elim</span> disjE conjE bexE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Regex.match <span class="main">(</span>sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span> <span class="free">r</span> <span class="free">i</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R1</span> <span class="main">∨</span> <span class="var">?R2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹Regex.match <span class="main">(</span>sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span> <span class="free">r</span> <span class="free">i</span> <span class="skolem">j</span>›</span></span> lpd_match<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Regex.lpd <span class="main">(</span>sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"Regex.match <span class="main">(</span>sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> True j <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?R2</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_diff_conv le_diff_conv2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> le_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eps_match<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I</span> <span class="main">(</span>Δ <span class="free">σ</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Regex.lpd <span class="main">(</span>sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>MatchF <span class="main">(</span>subtract <span class="main">(</span>Δ <span class="free">σ</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&gt;</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"Regex.match <span class="main">(</span>sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">j</span>"</span></span>
    <span class="quoted"><span class="quoted">"mem <span class="main">(</span>subtract <span class="main">(</span>Δ <span class="free">σ</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_le_mono memL_mono Suc_le_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_diff_conv lpd_match <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eps_match <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_MatchP_rec<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>MatchP <span class="free">I</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟷</span> memL <span class="free">I</span> <span class="main">0</span> <span class="main">∧</span> Regex.eps <span class="main">(</span>sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="main">∨</span>
  <span class="free">i</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> memR <span class="free">I</span> <span class="main">(</span>Δ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span> <span class="main">∈</span> Regex.rpd <span class="main">(</span>sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span><span class="main">.</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>MatchP <span class="main">(</span>subtract <span class="main">(</span>Δ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R1</span> <span class="main">∨</span> <span class="var">?R2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">elim</span> disjE conjE bexE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Regex.match <span class="main">(</span>sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span> <span class="free">r</span> <span class="skolem">j</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R1</span> <span class="main">∨</span> <span class="var">?R2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹Regex.match <span class="main">(</span>sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span> <span class="free">r</span> <span class="skolem">j</span> <span class="free">i</span>›</span></span> rpd_match<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Regex.rpd <span class="main">(</span>sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"Regex.match <span class="main">(</span>sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">j</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> True j <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?R2</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_le_mono2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eps_match<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I</span> <span class="main">(</span>Δ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> Regex.rpd <span class="main">(</span>sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>MatchP <span class="main">(</span>subtract <span class="main">(</span>Δ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"Regex.match <span class="main">(</span>sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span> <span class="skolem">s</span> <span class="skolem">j</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"mem <span class="main">(</span>subtract <span class="main">(</span>Δ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gr0_conv_Suc less_Suc_eq_le<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rpd_match <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eps_match <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_Since_0<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">0</span> <span class="main">(</span>Since <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">⟷</span> memL <span class="free">I</span> <span class="main">0</span> <span class="main">∧</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">0</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_MatchP_0<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">0</span> <span class="main">(</span>MatchP <span class="free">I</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟷</span> memL <span class="free">I</span> <span class="main">0</span> <span class="main">∧</span> Regex.eps <span class="main">(</span>sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span> <span class="main">0</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eps_match<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_Since_point<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Since <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟹</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⟹</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Since <span class="free">φ</span> <span class="main">(</span>point <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> diff_le_self<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_MatchP_point<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>MatchP <span class="free">I</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟹</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⟹</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>MatchP <span class="main">(</span>point <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> diff_le_self<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_Since_pointD<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Since <span class="free">φ</span> <span class="main">(</span>point <span class="free">t</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">⟹</span> mem <span class="free">I</span> <span class="free">t</span> <span class="main">⟹</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Since <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_MatchP_pointD<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>MatchP <span class="main">(</span>point <span class="free">t</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> mem <span class="free">I</span> <span class="free">t</span> <span class="main">⟹</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>MatchP <span class="free">I</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_fv_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="free">φ</span><span class="main">.</span> <span class="free">v</span><span class="main">!</span><span class="bound">x</span> <span class="main">=</span> <span class="free">v'</span><span class="main">!</span><span class="bound">x</span> <span class="main">⟹</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">=</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v'</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">v'</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> formula.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pred <span class="skolem">n</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> map_cong eval_trm_fv_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Pred<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">simplified</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">THEN</span> bspec<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eq <span class="skolem">x1</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fvi.simps sat.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UnCI eval_trm_fv_cong<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Less <span class="skolem">x1</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fvi.simps sat.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UnCI eval_trm_fv_cong<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LessEq <span class="skolem">x1</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fvi.simps sat.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UnCI eval_trm_fv_cong<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ands <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span><span class="main">.</span> <span class="bound">φ</span> <span class="main">∈</span> set <span class="skolem">l</span> <span class="main">⟹</span> sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="bound">φ</span> <span class="main">=</span> sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v'</span> <span class="skolem">i</span> <span class="bound">φ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv <span class="skolem">φ</span> <span class="main">⊆</span> fv <span class="main">(</span>Ands <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fv_subset_Ands <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="skolem">φ</span><span class="main">.</span> <span class="skolem">v</span><span class="main">!</span><span class="bound">x</span> <span class="main">=</span> <span class="skolem">v'</span><span class="main">!</span><span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Ands.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="skolem">φ</span> <span class="main">=</span> sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v'</span> <span class="skolem">i</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Ands.hyps <span class="quoted"><span class="quoted">‹<span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> sat_Ands <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Exists <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sat.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iff_exI<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fvi_Suc nth_Cons'<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">!</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">v'</span> <span class="main">!</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Agg.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">φ</span> <span class="main">=</span> sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="skolem">v'</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">φ</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">zs</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">zs</span>
    <span class="keyword1"><span class="command">using</span></span> that Agg.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Agg.hyps<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> v<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">@</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> v'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">@</span> <span class="skolem">v'</span>"</span></span><span class="main"><span class="main">]</span></span>
        nth_append fvi_iff_fv<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_trm <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">f</span> <span class="main">=</span> eval_trm <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="skolem">v'</span><span class="main">)</span> <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">zs</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">zs</span>
    <span class="keyword1"><span class="command">using</span></span> that Agg.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eval_trm_fv_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> v<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">@</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> v'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">@</span> <span class="skolem">v'</span>"</span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append fvi_iff_fv<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="main">]</span></span> fvi_trm_iff_fv_trm<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"length <span class="skolem">zs</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> conj_cong<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MatchF <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Regex.match <span class="main">(</span>sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">=</span> Regex.match <span class="main">(</span>sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v'</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> match_fv_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_regex_alt<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MatchP <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Regex.match <span class="main">(</span>sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">=</span> Regex.match <span class="main">(</span>sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v'</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> match_fv_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_regex_alt<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trigger <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Trigger<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">v</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">v'</span></span></span></span><span class="main">]</span> Trigger<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Release <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Release<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">v</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">v'</span></span></span></span><span class="main">]</span> Release<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> 10 0 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> iff_exI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> match_fv_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv_regex <span class="free">r</span><span class="main">.</span> <span class="free">v</span><span class="main">!</span><span class="bound">x</span> <span class="main">=</span> <span class="free">v'</span><span class="main">!</span><span class="bound">x</span> <span class="main">⟹</span> Regex.match <span class="main">(</span>sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> Regex.match <span class="main">(</span>sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v'</span><span class="main">)</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> match_fv_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sat_fv_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_regex_alt<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eps_fv_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv_regex <span class="free">r</span><span class="main">.</span> <span class="free">v</span><span class="main">!</span><span class="bound">x</span> <span class="main">=</span> <span class="free">v'</span><span class="main">!</span><span class="bound">x</span> <span class="main">⟹</span> Regex.eps <span class="main">(</span>sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="main">=</span> Regex.eps <span class="main">(</span>sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v'</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> eps_match <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> match_fv_cong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> fun_cong<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> fun_cong<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Trigger / Release›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interval_geq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">i</span> <span class="free">j</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"memL <span class="free">I</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">j</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">k</span><span class="main">)</span> <span class="main">∧</span> memL <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interval_leq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">i</span> <span class="free">j</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"memL <span class="free">I</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">j</span> <span class="main">≥</span> τ <span class="free">σ</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> memL <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interval_all<span class="main">:</span> <span class="quoted"><span class="quoted">"mem all <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">first</span> <span class="main">=</span> Neg <span class="main">(</span>Prev all TT<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> first_sat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> first <span class="main">=</span> <span class="main">(</span><span class="free">i</span><span class="main">=</span><span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> interval_all <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> first_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> first_fvi<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fvi <span class="free">b</span> first <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> first_def TT_def FF_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> interval_bounds<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">b</span><span class="main">::</span> <span class="quoted">enat</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span><span class="main">::</span><span class="quoted">ℐ</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">=</span> interval <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"memL <span class="free">I</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">a</span> <span class="main">≤</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> memR <span class="free">I</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> enat <span class="bound">i</span> <span class="main">≤</span> <span class="free">b</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>bounded <span class="free">I</span> <span class="main">=</span> <span class="main">(</span><span class="free">b</span> <span class="main">≠</span> <span class="main">∞</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="comment1">(* [a, b] ⇒ [b+1, ∞] *)</span>
<span class="keyword1"><span class="command">lift_definition</span></span> flip_int <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> ℐ"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">I</span><span class="main">.</span> <span class="keyword1">if</span> bounded <span class="bound">I</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span>memR <span class="bound">I</span> <span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> True<span class="main">)</span><span class="main">,</span> False<span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> True<span class="main">)</span><span class="main">,</span> False<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upclosed_def downclosed_def<span class="main">)</span>

<span class="comment1">(* [a, b] ⇒ [b+1, 2b]. nonempty if b+1≤2b ⇔ 1≤b *)</span>
<span class="keyword1"><span class="command">lift_definition</span></span> flip_int_double_upper <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> ℐ"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">I</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span>bounded <span class="bound">I</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span>memR <span class="bound">I</span> <span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> memR <span class="bound">I</span> <span class="main">(</span><span class="keyword1">(div)</span> <span class="bound">i</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> True<span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> True<span class="main">)</span><span class="main">,</span> False<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">memL</span><span class="main">,</span> <span class="bound">memR</span><span class="main">,</span> <span class="bound">bounded</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="bound">memL</span> <span class="bound">m</span> <span class="main">∧</span> <span class="bound">memR</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∧</span> upclosed <span class="bound">memL</span> <span class="main">∧</span> downclosed <span class="bound">memR</span> <span class="main">∧</span> <span class="bound">bounded</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">memR</span> <span class="bound">m</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">I</span> <span class="main">::</span> <span class="quoted">ℐ</span>
    <span class="keyword3"><span class="command">assume</span></span> I_props<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded <span class="skolem">I</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> memR <span class="skolem">I</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> Inf <span class="skolem">B</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> up<span class="main">:</span> <span class="quoted"><span class="quoted">"upclosed <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span> memR <span class="skolem">I</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> memR_antimono upclosed_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">m</span>
      <span class="keyword3"><span class="command">assume</span></span> assumptions<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> memR <span class="skolem">I</span> <span class="main">(</span><span class="keyword1">(div)</span> <span class="bound">i</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">≤</span><span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> memR <span class="skolem">I</span> <span class="main">(</span><span class="keyword1">(div)</span> <span class="bound">i</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">m</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> memR <span class="skolem">I</span> <span class="main">(</span><span class="keyword1">(div)</span> <span class="bound">i</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="bound">r</span> <span class="main">⟶</span> <span class="bound">m</span> <span class="main">≤</span> <span class="bound">r</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> memR <span class="skolem">I</span> <span class="main">(</span><span class="keyword1">(div)</span> <span class="bound">i</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="bound">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> down<span class="main">:</span> <span class="quoted"><span class="quoted">"downclosed <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> memR <span class="skolem">I</span> <span class="main">(</span><span class="keyword1">(div)</span> <span class="bound">i</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> downclosed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span>memR <span class="skolem">I</span> <span class="bound">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> I_props bounded_memR <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> B_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inf_nat_def1<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="skolem">I</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> memR_nonzeroD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b_half_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span><span class="skolem">b</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">≥</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cInf_lower b_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> b_half_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span><span class="skolem">b</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memR <span class="skolem">I</span> <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_def b_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span> memR <span class="skolem">I</span> <span class="bound">i</span><span class="main">,</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> memR <span class="skolem">I</span> <span class="main">(</span><span class="bound">i</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">,</span> True<span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> b_props A_def up down
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">I</span><span class="main">.</span> bounded <span class="bound">I</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span> memR <span class="bound">I</span> <span class="bound">i</span><span class="main">,</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> memR <span class="bound">I</span> <span class="main">(</span><span class="bound">i</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">,</span> True<span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="main">¬</span>bounded <span class="bound">I</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> True<span class="main">,</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> True<span class="main">,</span> False<span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Interval.all.rep_eq Rep_ℐ<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">I</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> bounded <span class="bound">I</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span> memR <span class="bound">I</span> <span class="bound">i</span><span class="main">,</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> memR <span class="bound">I</span> <span class="main">(</span><span class="bound">i</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">,</span> True<span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> True<span class="main">,</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> True<span class="main">,</span> False<span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ℐ</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> bounded <span class="bound">ℐ</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span> memR <span class="bound">ℐ</span> <span class="bound">i</span><span class="main">,</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> memR <span class="bound">ℐ</span> <span class="main">(</span><span class="bound">i</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span><span class="main">,</span> True<span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> True<span class="main">,</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> True<span class="main">,</span> False<span class="main">)</span><span class="main">)</span>
         <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">memL</span><span class="main">,</span> <span class="bound">memR</span><span class="main">,</span> <span class="bound">bounded</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="bound">memL</span> <span class="bound">m</span> <span class="main">∧</span> <span class="bound">memR</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∧</span> upclosed <span class="bound">memL</span> <span class="main">∧</span> downclosed <span class="bound">memR</span> <span class="main">∧</span> <span class="bound">bounded</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">memR</span> <span class="bound">m</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* [a, b] ⇒ [0, a-1] *)</span>
<span class="keyword1"><span class="command">lift_definition</span></span> flip_int_less_lower <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> ℐ"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">I</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">¬</span>memL <span class="bound">I</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">¬</span>memL <span class="bound">I</span> <span class="bound">i</span><span class="main">)</span><span class="main">,</span> True<span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> True<span class="main">)</span><span class="main">,</span> False<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upclosed_def downclosed_def<span class="main">)</span>

<span class="comment1">(* [a, b] ⇒ [0, b] *)</span>
<span class="keyword1"><span class="command">lift_definition</span></span> int_remove_lower_bound <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> ℐ"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">I</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> True<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> memR <span class="bound">I</span> <span class="bound">i</span><span class="main">)</span><span class="main">,</span> bounded <span class="bound">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upclosed_def downclosed_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> flip_int_props<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bounded <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I'</span> <span class="main">=</span> flip_int <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>bounded <span class="free">I'</span> <span class="main">∧</span> <span class="main">¬</span>mem <span class="free">I'</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer'</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> flip_int_less_lower_props<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memL <span class="free">I</span> <span class="main">0</span>"</span></span> <span class="comment1">(* [a, b] *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I'</span> <span class="main">=</span> flip_int_less_lower <span class="free">I</span>"</span></span> <span class="comment1">(* [0, a-1] *)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I'</span> <span class="main">0</span> <span class="main">∧</span> bounded <span class="free">I'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer'</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> flip_int_less_lower_memL<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memL <span class="free">I</span> <span class="free">x</span>"</span></span> <span class="comment1">(* [a, b], x &lt; a *)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"memL <span class="main">(</span>flip_int_less_lower <span class="free">I</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="comment1">(* x ∈ [0, a-1] *)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer'</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> flip_int_less_lower_memR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memL <span class="free">I</span> <span class="main">0</span>"</span></span> <span class="comment1">(* I = [a, b], I' = [0, a-1]. x ≤ a-1 *)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>memR <span class="main">(</span>flip_int_less_lower <span class="free">I</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span>memL <span class="free">I</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="comment1">(* x ∉ [a, b] *)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer'</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> flip_int_less_lower_mem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>bounded <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I</span> <span class="free">x</span>"</span></span> <span class="comment1">(* [a, ∞], x &lt; a *)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>flip_int_less_lower <span class="free">I</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="comment1">(* x ∈ [0, a-1] *)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer'</span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bounded_memR<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> int_flip_mem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bounded <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I</span> <span class="free">x</span>"</span></span> <span class="comment1">(* [0, a], a&lt;x *)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>flip_int <span class="free">I</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="comment1">(* [a, ∞] *)</span>
  <span class="keyword1"><span class="command">using</span></span> assms memL_mono
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer'</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> flip_int_double_upper_leq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="comment1">(* x ∈ [b+1, 2b] *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> mem <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">≤</span><span class="free">x</span>"</span></span> <span class="comment1">(* y ∉ [b+1, 2b] and y ≤ x *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memL <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="free">y</span> <span class="main">∨</span> <span class="main">¬</span>memR <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟶</span> memR <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="bound">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memL <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer'</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flip_int_double_upper_bounded<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bounded <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="main">=</span> bounded <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer'</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> int_remove_lower_bound_bounded<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bounded <span class="main">(</span>int_remove_lower_bound <span class="free">I</span><span class="main">)</span> <span class="main">=</span> bounded <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer'</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> int_remove_lower_bound_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="free">x</span> <span class="main">⟹</span> mem <span class="main">(</span>int_remove_lower_bound <span class="free">I</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer'</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Trigger <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Neg <span class="main">(</span>Since <span class="main">(</span>Neg <span class="free">φ</span><span class="main">)</span> <span class="free">I</span> <span class="main">(</span>Neg <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Release <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Neg <span class="main">(</span>Until <span class="main">(</span>Neg <span class="free">φ</span><span class="main">)</span> <span class="free">I</span> <span class="main">(</span>Neg <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">release</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"formula <span class="main">⇒</span> ℐ <span class="main">⇒</span> formula <span class="main">⇒</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">release</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span> Neg <span class="main">(</span>Until <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sat_release<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>release <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> <span class="main">(</span>mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="free">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="bound">j</span><span class="main">}</span><span class="main">.</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> release_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_release_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Release <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>release <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">once</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> formula <span class="main">⇒</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">once</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> Since TT <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sat_once<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>once <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> once_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> once_fvi<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span> <span class="quoted"><span class="quoted">"fvi <span class="free">b</span> <span class="main">(</span>once <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> fvi <span class="free">b</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> once_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">historically</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> formula <span class="main">⇒</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">historically</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span>Neg <span class="main">(</span>once <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sat_historically<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>historically <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> historically_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(*lemma sat_historically_eq[simp]: "sat σ V v i (Historically I φ) = sat σ V v i (historically I φ)"
  by auto*)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eventually</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> formula <span class="main">⇒</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eventually</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> Until TT <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eventually_fvi<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fvi <span class="free">b</span> <span class="main">(</span>eventually <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> fvi <span class="free">b</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eventually_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_eventually<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>eventually <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eventually_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">always</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> formula <span class="main">⇒</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">always</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span>Neg <span class="main">(</span>eventually <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">(*lemma "sat σ V v i (Always I φ) = sat σ V v i (Neg (eventually I (Neg φ)))"
  by auto*)</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_always<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>always <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟶</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> always_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(*lemma sat_always_eq[simp]: "sat σ V v i (Always I φ) = sat σ V v i (always I φ)"
  by auto*)</span>

<span class="comment1">(* case distrinction since intervals aren't allowed to be empty and flip_int [0, ∞] would be *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">historically_safe_0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> formula <span class="main">⇒</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">historically_safe_0</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>bounded <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>Or <span class="main">(</span>Since <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>flip_int <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">(</span>Next all <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Since <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>And first <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>Since <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>And first <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                                                                                                        
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">historically_safe_unbounded</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> formula <span class="main">⇒</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">historically_safe_unbounded</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span>And <span class="main">(</span>once <span class="main">(</span>flip_int_less_lower <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">(</span>Prev all <span class="main">(</span>Since <span class="free"><span class="bound"><span class="entity">φ</span></span></span> all <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> first<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>once <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">historically_safe_bounded</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> formula <span class="main">⇒</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">historically_safe_bounded</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span>And <span class="main">(</span>once <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>Neg <span class="main">(</span>once <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>And <span class="main">(</span>Or <span class="main">(</span>once <span class="main">(</span>int_remove_lower_bound <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>eventually <span class="main">(</span>int_remove_lower_bound <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">always_safe_0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> formula <span class="main">⇒</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">always_safe_0</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span>Or <span class="main">(</span>Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>flip_int_double_upper <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">(</span>Prev all <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>Next <span class="main">(</span>flip_int <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> TT<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">always_safe_bounded</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> formula <span class="main">⇒</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">always_safe_bounded</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span>And <span class="main">(</span>eventually <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>Neg <span class="main">(</span>eventually <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>And <span class="main">(</span>Or <span class="main">(</span>once <span class="main">(</span>int_remove_lower_bound <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>eventually <span class="main">(</span>int_remove_lower_bound <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">trigger_safe_0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"formula <span class="main">⇒</span> ℐ <span class="main">⇒</span> formula <span class="main">⇒</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trigger_safe_0</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span> Or <span class="main">(</span>Since <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>historically_safe_0 <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">trigger_safe_unbounded</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"formula <span class="main">⇒</span> ℐ <span class="main">⇒</span> formula <span class="main">⇒</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trigger_safe_unbounded</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span> And <span class="main">(</span>once <span class="free"><span class="bound"><span class="entity">I</span></span></span> TT<span class="main">)</span> <span class="main">(</span>Or <span class="main">(</span>Or <span class="main">(</span>historically_safe_unbounded <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span>once <span class="main">(</span>flip_int_less_lower <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>once <span class="main">(</span>flip_int_less_lower <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">(</span>Prev all <span class="main">(</span>Since <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">(</span>int_remove_lower_bound <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">trigger_safe_bounded</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"formula <span class="main">⇒</span> ℐ <span class="main">⇒</span> formula <span class="main">⇒</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trigger_safe_bounded</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span> And <span class="main">(</span>once <span class="free"><span class="bound"><span class="entity">I</span></span></span> TT<span class="main">)</span> <span class="main">(</span>Or <span class="main">(</span>Or <span class="main">(</span>historically_safe_bounded <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span>once <span class="main">(</span>flip_int_less_lower <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>once <span class="main">(</span>flip_int_less_lower <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">(</span>Prev all <span class="main">(</span>Since <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">(</span>int_remove_lower_bound <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">and_trigger_safe_bounded</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"formula <span class="main">⇒</span> formula <span class="main">⇒</span> ℐ <span class="main">⇒</span> formula <span class="main">⇒</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">and_trigger_safe_bounded</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">=</span> <span class="main">(</span>Or <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>Neg <span class="main">(</span>once <span class="free"><span class="bound"><span class="entity">I</span></span></span> TT<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>trigger_safe_bounded <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">and_trigger_safe_unbounded</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"formula <span class="main">⇒</span> formula <span class="main">⇒</span> ℐ <span class="main">⇒</span> formula <span class="main">⇒</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">and_trigger_safe_unbounded</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">=</span> <span class="main">(</span>Or <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>Neg <span class="main">(</span>once <span class="free"><span class="bound"><span class="entity">I</span></span></span> TT<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>trigger_safe_unbounded <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">release_safe_0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"formula <span class="main">⇒</span> ℐ <span class="main">⇒</span> formula <span class="main">⇒</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">release_safe_0</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span> Or <span class="main">(</span>Until <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>always_safe_0 <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">release_safe_bounded</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"formula <span class="main">⇒</span> ℐ <span class="main">⇒</span> formula <span class="main">⇒</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">release_safe_bounded</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span> And <span class="main">(</span>eventually <span class="free"><span class="bound"><span class="entity">I</span></span></span> TT<span class="main">)</span> <span class="main">(</span>Or <span class="main">(</span>Or <span class="main">(</span>always_safe_bounded <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span>eventually <span class="main">(</span>flip_int_less_lower <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>eventually <span class="main">(</span>flip_int_less_lower <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">(</span>Next all <span class="main">(</span>Until <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">(</span>int_remove_lower_bound <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">and_release_safe_bounded</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"formula <span class="main">⇒</span> formula <span class="main">⇒</span> ℐ <span class="main">⇒</span> formula <span class="main">⇒</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">and_release_safe_bounded</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">=</span> <span class="main">(</span>Or <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>Neg <span class="main">(</span>eventually <span class="free"><span class="bound"><span class="entity">I</span></span></span> TT<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>release_safe_bounded <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> since_true<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Since <span class="free">φ</span> <span class="free">I</span> TT<span class="main">)</span> <span class="main">=</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Since <span class="free">φ</span> <span class="free">I</span> <span class="main">(</span>Next all <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Since <span class="free">φ</span> <span class="free">I</span> TT<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≤</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="skolem">j</span><span class="main">&lt;..</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">=</span><span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> j_props assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">&lt;</span><span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_props<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> le_eq_less_or_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Since <span class="free">φ</span> <span class="free">I</span> <span class="main">(</span>Next all <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> j_props interval_all
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Since <span class="free">φ</span> <span class="free">I</span> <span class="main">(</span>Next all <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Since <span class="free">φ</span> <span class="free">I</span> TT<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> until_true<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Until <span class="free">φ</span> <span class="free">I</span> TT<span class="main">)</span> <span class="main">=</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Until <span class="free">φ</span> <span class="free">I</span> <span class="main">(</span>Prev all <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Until <span class="free">φ</span> <span class="free">I</span> TT<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≥</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">j</span><span class="main">}</span><span class="main">.</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">=</span><span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> j_props assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">&gt;</span><span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_props<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> le_eq_less_or_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Until <span class="free">φ</span> <span class="free">I</span> <span class="main">(</span>Prev all <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> j_props interval_all
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Until <span class="free">φ</span> <span class="free">I</span> <span class="main">(</span>Prev all <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Until <span class="free">φ</span> <span class="free">I</span> TT<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Past-only formulas›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">past_only</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"formula <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">past_only</span> <span class="main">(</span>Pred <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">past_only</span> <span class="main">(</span>Eq <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">past_only</span> <span class="main">(</span>Less <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">past_only</span> <span class="main">(</span>LessEq <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">past_only</span> <span class="main">(</span>Let <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">past_only</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">∧</span> <span class="free">past_only</span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">past_only</span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">past_only</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">past_only</span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">past_only</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">∧</span> <span class="free">past_only</span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">past_only</span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">past_only</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">∧</span> <span class="free">past_only</span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">past_only</span> <span class="main">(</span>Ands <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">α</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">.</span> <span class="free">past_only</span> <span class="bound">α</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">past_only</span> <span class="main">(</span>Exists <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">past_only</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">past_only</span> <span class="main">(</span>Agg <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">past_only</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">past_only</span> <span class="main">(</span>Prev <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">past_only</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">past_only</span> <span class="main">(</span>Next <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">past_only</span> <span class="main">(</span>Since <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">past_only</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">∧</span> <span class="free">past_only</span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">past_only</span> <span class="main">(</span>Until <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">past_only</span> <span class="main">(</span>Trigger <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">past_only</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">∧</span> <span class="free">past_only</span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">past_only</span> <span class="main">(</span>Release <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">past_only</span> <span class="main">(</span>MatchP <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Regex.pred_regex <span class="free">past_only</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">past_only</span> <span class="main">(</span>MatchF <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> past_only_sat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ</span>"</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> plen <span class="free">π</span> <span class="main">⟹</span> dom <span class="free">V</span> <span class="main">=</span> dom <span class="free">V'</span> <span class="main">⟹</span>
     <span class="main">(</span><span class="main">⋀</span><span class="bound">p</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> dom <span class="free">V</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> plen <span class="free">π</span> <span class="main">⟹</span> the <span class="main">(</span><span class="free">V</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">i</span> <span class="main">=</span> the <span class="main">(</span><span class="free">V'</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span>
     past_only <span class="free">φ</span> <span class="main">⟹</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">=</span> sat <span class="free">σ'</span> <span class="free">V'</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">V'</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pred <span class="skolem">e</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="skolem">e</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V'</span> <span class="skolem">e</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">V</span> <span class="main">=</span> dom <span class="skolem">V'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> None Γ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> Pred<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V'</span> <span class="skolem">e</span> <span class="main">=</span> Some <span class="skolem">a'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Some <span class="quoted"><span class="quoted">‹dom <span class="skolem">V</span> <span class="main">=</span> dom <span class="skolem">V'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="skolem">V</span> <span class="skolem">e</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> the <span class="main">(</span><span class="skolem">V'</span> <span class="skolem">e</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Some Pred<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> domI<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let <span class="skolem">p</span> <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?V</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">V</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">(</span><span class="bound">V</span><span class="main">(</span><span class="skolem">p</span> <span class="main">↦</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> length <span class="bound">v</span> <span class="main">=</span> nfv <span class="skolem">φ</span> <span class="main">∧</span> sat <span class="bound">σ</span> <span class="bound">V</span> <span class="bound">v</span> <span class="bound">i</span> <span class="skolem">φ</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sat.simps <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Let.IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">from</span></span> Let.prems <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"past_only <span class="skolem">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> Let.prems <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="var">?V</span> <span class="skolem">V</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> dom <span class="main">(</span><span class="var">?V</span> <span class="skolem">V'</span> <span class="free">σ'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> fun_upd_apply<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p'</span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> dom <span class="main">(</span><span class="var">?V</span> <span class="skolem">V</span> <span class="free">σ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="var">?V</span> <span class="skolem">V</span> <span class="free">σ</span> <span class="skolem">p'</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> the <span class="main">(</span><span class="var">?V</span> <span class="skolem">V'</span> <span class="free">σ'</span> <span class="skolem">p'</span><span class="main">)</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> Let <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> plen <span class="free">π</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Let.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ands <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Γ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prev <span class="skolem">I</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> τ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Since <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> τ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trigger <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> τ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MatchP <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Regex.match <span class="main">(</span>sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">r</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> Regex.match <span class="main">(</span>sat <span class="free">σ'</span> <span class="skolem">V'</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">r</span> <span class="skolem">a</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Regex.match_cong_strong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> regex.pred_set<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> τ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> MatchP<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Safe formulas›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">remove_neg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"formula <span class="main">⇒</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_neg</span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">remove_neg</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fvi_remove_neg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fvi <span class="free">b</span> <span class="main">(</span>remove_neg <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> fvi <span class="free">b</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> partition_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> partition <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> partition <span class="free">g</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> size_remove_neg<span class="main">[</span><span class="operator">termination_simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>remove_neg <span class="free">φ</span><span class="main">)</span> <span class="main">≤</span> size <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">is_constraint</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"formula <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_constraint</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_constraint</span> <span class="main">(</span>Less <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_constraint</span> <span class="main">(</span>LessEq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_constraint</span> <span class="main">(</span>Neg <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_constraint</span> <span class="main">(</span>Neg <span class="main">(</span>Less <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_constraint</span> <span class="main">(</span>Neg <span class="main">(</span>LessEq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">is_constraint</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">safe_assignment</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set <span class="main">⇒</span> formula <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">safe_assignment</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span>
       Eq <span class="main">(</span>Var <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>Var <span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⟷</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span>
     <span class="main">|</span> Eq <span class="main">(</span>Var <span class="bound">x</span><span class="main">)</span> <span class="bound">t</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∧</span> fv_trm <span class="bound">t</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span>
     <span class="main">|</span> Eq <span class="bound">t</span> <span class="main">(</span>Var <span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∧</span> fv_trm <span class="bound">t</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span>
     <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">safe_formula_dual</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"
  <span class="free">safe_formula_dual</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">safe_formula</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">safe_formula</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span> fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⊆</span> fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span> <span class="main">(</span>
      <span class="free"><span class="bound"><span class="entity">safe_formula</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="comment1">― ‹∨ safe_assignment (fv ψ) φ ∨ is_constraint φ›</span> <span class="main">∨</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span> Formula.Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">safe_formula</span></span></span> <span class="bound">φ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>
    <span class="main">)</span><span class="main">)</span>
      <span class="keyword1">else</span>
    <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">safe_formula</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">safe_formula</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span> fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span>
"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> safe_formula_dual_impl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"safe_formula_dual <span class="free">b</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="main">⟹</span> safe_formula_dual <span class="free">b</span> <span class="free">Q</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> safe_formula_dual_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits formula.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> size_regex_cong <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> size <span class="bound">f</span> <span class="main">&lt;</span> Regex.size_regex size <span class="free">r</span> <span class="main">⟹</span> <span class="free">size'</span> <span class="bound">f</span> <span class="main">=</span> <span class="free">size''</span> <span class="bound">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Regex.size_regex <span class="free">size'</span> <span class="free">r</span> <span class="main">=</span> Regex.size_regex <span class="free">size''</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">size'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"formula <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">size'</span> <span class="main">(</span>Pred <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">size'</span> <span class="main">(</span>Let <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">size'</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">+</span> <span class="free">size'</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">size'</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">size'</span> <span class="main">(</span>Less <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">size'</span> <span class="main">(</span>LessEq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">size'</span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">size'</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">size'</span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">size'</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">+</span> <span class="free">size'</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">size'</span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">of</span>
    <span class="main">(</span>Release <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">)</span> <span class="main">⇒</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">size'</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">size'</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">+</span> <span class="main">1</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free">size'</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">+</span> <span class="free">size'</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">+</span> <span class="main">1</span>
  <span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">size'</span> <span class="main">(</span>Ands <span class="free"><span class="bound"><span class="entity">φs</span></span></span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span>map <span class="main">(</span><span class="free">size'</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">size'</span> <span class="main">(</span>Exists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">size'</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">size'</span> <span class="main">(</span>Agg <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b'</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">size'</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">size'</span> <span class="main">(</span>Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">size'</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">size'</span> <span class="main">(</span>Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">size'</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">size'</span> <span class="main">(</span>Since <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">size'</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">+</span> <span class="free">size'</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">size'</span> <span class="main">(</span>Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">size'</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">+</span> <span class="free">size'</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">size'</span> <span class="main">(</span>Trigger <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">size'</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">+</span> <span class="free">size'</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">size'</span> <span class="main">(</span>Release <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="numeral">6</span> <span class="main">*</span> <span class="free">size'</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">+</span> <span class="numeral">24</span> <span class="main">*</span> <span class="free">size'</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">+</span> <span class="numeral">110</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">size'</span> <span class="main">(</span>MatchF <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Regex.size_regex <span class="main">(</span><span class="free">size'</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">size'</span> <span class="main">(</span>MatchP <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Regex.size_regex <span class="main">(</span><span class="free">size'</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>



<span class="keyword1"><span class="command">lemma</span></span> size'_and_release<span class="main">:</span> <span class="quoted"><span class="quoted">"size' <span class="main">(</span>And <span class="free">φ</span> <span class="main">(</span>Release <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> size' <span class="main">(</span>and_release_safe_bounded <span class="free">φ</span> <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> and_release_safe_bounded_def
  <span class="keyword1"><span class="command">unfolding</span></span> release_safe_bounded_def always_safe_bounded_def eventually_def once_def TT_def FF_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size'.simps<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> size'_Release<span class="main">:</span> <span class="quoted"><span class="quoted">"size' <span class="main">(</span>Release <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">≥</span> size' <span class="main">(</span>release_safe_0 <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">+</span> size' <span class="main">(</span>release_safe_bounded <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> release_safe_0_def release_safe_bounded_def always_safe_0_def always_safe_bounded_def eventually_def once_def TT_def FF_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> size'.simps<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> size'_Or<span class="main">:</span>
  <span class="quoted"><span class="quoted">"size' <span class="free">φ</span> <span class="main">&lt;</span> size' <span class="main">(</span>And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"size' <span class="free">ψ</span> <span class="main">&lt;</span> size' <span class="main">(</span>And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> size'_release_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"size' <span class="main">(</span>and_release_safe_bounded <span class="free">φ</span> <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span><span class="main">)</span> <span class="main">&lt;</span> <span class="numeral">221</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> size' <span class="free">φ</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">12</span> <span class="main">*</span> size' <span class="free">φ'</span> <span class="main">+</span> <span class="numeral">48</span> <span class="main">*</span> size' <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="free">φ</span> <span class="keyword1">of</span> Release <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span> <span class="main">⇒</span> <span class="numeral">2</span> <span class="main">*</span> size' <span class="free">ψ</span> <span class="main">+</span> <span class="numeral">2</span> <span class="main">*</span> size' <span class="free">φ</span> <span class="main">+</span> <span class="main">1</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> size' <span class="free">ψ</span> <span class="main">+</span> size' <span class="free">φ</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> size' <span class="main">(</span>always_safe_0 <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">&lt;</span> <span class="numeral">23</span> <span class="main">*</span> size' <span class="free">ψ</span> <span class="main">+</span> <span class="main">(</span><span class="numeral">108</span> <span class="main">+</span> <span class="numeral">6</span> <span class="main">*</span> size' <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"size' <span class="main">(</span>release_safe_bounded <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">&lt;</span> <span class="numeral">6</span> <span class="main">*</span> size' <span class="free">φ</span> <span class="main">+</span> <span class="numeral">24</span> <span class="main">*</span> size' <span class="free">ψ</span> <span class="main">+</span> <span class="numeral">110</span>"</span></span>
  <span class="quoted"><span class="quoted">"size' <span class="main">(</span>release_safe_0 <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">&lt;</span> <span class="numeral">6</span> <span class="main">*</span> size' <span class="free">φ</span> <span class="main">+</span> <span class="numeral">24</span> <span class="main">*</span> size' <span class="free">ψ</span> <span class="main">+</span> <span class="numeral">110</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> and_release_safe_bounded_def release_safe_0_def release_safe_bounded_def always_safe_bounded_def always_safe_0_def eventually_def once_def TT_def FF_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> safe_formula_dual_size <span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> size' <span class="bound">f</span> <span class="main">≤</span> size' <span class="free">φ</span> <span class="main">+</span> size' <span class="free">ψ</span> <span class="main">⟹</span> <span class="free">safe_formula</span> <span class="bound">f</span> <span class="main">=</span> <span class="free">safe_formula'</span> <span class="bound">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"safe_formula_dual <span class="free">b</span> <span class="free">safe_formula</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="main">=</span> safe_formula_dual <span class="free">b</span> <span class="free">safe_formula'</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_formula_dual_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_list_mem_leq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">l</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> sum_list <span class="main">(</span>map <span class="free">f</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> regex_atms_size'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> regex.atms <span class="free">r</span> <span class="main">⟹</span> size' <span class="free">x</span> <span class="main">&lt;</span> regex.size_regex size' <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">)</span> <span class="entity">safe_formula</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"formula <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>is_Const <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">∧</span> <span class="main">(</span>is_Const <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∨</span> is_Var <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">∨</span> is_Var <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">∧</span> is_Const <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>Neg <span class="main">(</span>Eq <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>Less <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>LessEq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>Pred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">.</span> is_Var <span class="bound">t</span> <span class="main">∨</span> is_Const <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>Let <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>nfv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">}</span> <span class="main">⊆</span> fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> <span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span> fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span>
    <span class="main">(</span>safe_assignment <span class="main">(</span>fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∨</span> <span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∨</span>
      fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">⊆</span> fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="main">(</span>is_constraint <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">of</span> Neg <span class="bound">ψ'</span> <span class="main">⇒</span> <span class="free">safe_formula</span> <span class="bound">ψ'</span>
      <span class="main">|</span> <span class="main">(</span>Trigger <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">)</span> <span class="main">⇒</span> safe_formula_dual True <span class="free">safe_formula</span> <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span>
      <span class="main">|</span> <span class="main">(</span>Release <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>
        bounded <span class="bound">I</span> <span class="main">∧</span> <span class="main">¬</span>mem <span class="bound">I</span> <span class="main">0</span> <span class="main">∧</span>
        <span class="free">safe_formula</span> <span class="bound">φ'</span> <span class="main">∧</span> <span class="free">safe_formula</span> <span class="bound">ψ'</span> <span class="main">∧</span> fv <span class="bound">φ'</span> <span class="main">=</span> fv <span class="bound">ψ'</span> <span class="main">∧</span>
        <span class="free">safe_formula</span> <span class="main">(</span>and_release_safe_bounded <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">)</span>
      <span class="main">)</span>
      <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False
    <span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>Ands <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">pos</span><span class="main">,</span> <span class="bound">neg</span><span class="main">)</span> <span class="main">=</span> partition <span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">in</span> <span class="bound">pos</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
    list_all <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span>
        Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="free">safe_formula</span> <span class="bound">φ'</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free">safe_formula</span> <span class="bound">φ</span>
      <span class="main">)</span>
    <span class="main">)</span> <span class="bound">neg</span> <span class="main">∧</span>
    <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map fv <span class="bound">neg</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map fv <span class="bound">pos</span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>Exists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>Agg <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∉</span> fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">}</span> <span class="main">⊆</span> fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> fv_trm <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⊆</span> fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>Since <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span> fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⊆</span> fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span> Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="free">safe_formula</span> <span class="bound">φ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span> fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⊆</span> fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span> Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="free">safe_formula</span> <span class="bound">φ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>Trigger <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> safe_formula_dual False <span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>Release <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">0</span> <span class="main">∧</span> bounded <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span> <span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span> fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⊆</span> fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span> <span class="free">safe_formula</span> <span class="main">(</span>release_safe_0 <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>MatchP <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Regex.safe_regex fv <span class="main">(</span><span class="main">λ</span><span class="bound">g</span> <span class="bound">φ</span><span class="main">.</span> <span class="free">safe_formula</span> <span class="bound">φ</span> <span class="main">∨</span>
     <span class="main">(</span><span class="bound">g</span> <span class="main">=</span> Lax <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span> Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="free">safe_formula</span> <span class="bound">φ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span> Past Strict <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>MatchF <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Regex.safe_regex fv <span class="main">(</span><span class="main">λ</span><span class="bound">g</span> <span class="bound">φ</span><span class="main">.</span> <span class="free">safe_formula</span> <span class="bound">φ</span> <span class="main">∨</span>
     <span class="main">(</span><span class="bound">g</span> <span class="main">=</span> Lax <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span> Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="free">safe_formula</span> <span class="bound">φ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span> Futu Strict <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command">using</span></span> size'_and_release size'_Release size'_Or size'_release_aux
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure size'"</span></span><span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Nat.less_Suc_eq_le release_safe_0_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_list_mem_leq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">size'</span><span class="main"><span class="main">]</span></span> regex_atms_size'<span class="main">)</span>
  

<span class="keyword1"><span class="command">lemma</span></span> safe_abbrevs<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula TT"</span></span> <span class="quoted"><span class="quoted">"safe_formula FF"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> TT_def FF_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> TT_future_bounded<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"future_bounded TT"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> TT_def FF_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> first_fv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv first <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> first_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> first_safe<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula first"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> first_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> first_future_bounded<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"future_bounded first"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> first_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> once_fv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>once <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> once_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> once_safe<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="main">(</span>once <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> safe_formula <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> once_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> once_future_bounded<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"future_bounded <span class="main">(</span>once <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> future_bounded <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> once_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eventually_fv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>eventually <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eventually_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eventually_safe<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="main">(</span>eventually <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> safe_formula <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eventually_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eventually_future_bounded<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"future_bounded <span class="main">(</span>eventually <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>future_bounded <span class="free">φ</span> <span class="main">∧</span> bounded <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eventually_def<span class="main">)</span>

<span class="comment1">(* historically *)</span>

<span class="comment1">(* [0, b] *)</span>
<span class="keyword1"><span class="command">lemma</span></span> historically_safe_0_safe<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="main">(</span>historically_safe_0 <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> safe_formula <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> historically_safe_0_def safe_assignment_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> φ
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_Const_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> φ
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_Const_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> historically_safe_0_fv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>historically_safe_0 <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> historically_safe_0_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> historically_safe_0_future_bounded<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"future_bounded <span class="main">(</span>historically_safe_0 <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> future_bounded <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> historically_safe_0_def eventually_def<span class="main">)</span>

<span class="comment1">(* [b, ∞) *)</span>

<span class="keyword1"><span class="command">lemma</span></span> historically_safe_unbounded_safe<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"safe_formula <span class="main">(</span>historically_safe_unbounded <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> safe_formula <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> historically_safe_unbounded_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> historically_safe_unbounded_fv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>historically_safe_unbounded <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> historically_safe_unbounded_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> historically_safe_future_bounded<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"future_bounded <span class="main">(</span>historically_safe_unbounded <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> future_bounded <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> historically_safe_unbounded_def<span class="main">)</span>

<span class="comment1">(* [a, b] *)</span>

<span class="keyword1"><span class="command">lemma</span></span> historically_safe_bounded_safe<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="main">(</span>historically_safe_bounded <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> safe_formula <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> historically_safe_bounded_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> historically_safe_bounded_fv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>historically_safe_bounded <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> historically_safe_bounded_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> historically_safe_bounded_future_bounded<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"future_bounded <span class="main">(</span>historically_safe_bounded <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>future_bounded <span class="free">φ</span> <span class="main">∧</span> bounded <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> historically_safe_bounded_def bounded.rep_eq int_remove_lower_bound.rep_eq<span class="main">)</span>

<span class="comment1">(*lemma "mem I 0 ⟹ safe_formula (historically I φ) = safe_formula (historically_safe_0 I φ)"
  unfolding historically_def once_def
  by auto

lemma "¬mem I 0 ⟹ ¬bounded I ⟹ safe_formula (historically I φ) = safe_formula (historically_safe_unbounded I φ)"
  by auto

lemma "¬mem I 0 ⟹ bounded I ⟹ safe_formula (historically I φ) = safe_formula (historically_safe_bounded I φ)"
  by auto*)</span>

<span class="comment1">(* always *)</span>

<span class="comment1">(* [0, b] *)</span>

<span class="keyword1"><span class="command">lemma</span></span> always_safe_0_safe<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="main">(</span>always_safe_0 <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> safe_formula <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> always_safe_0_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> always_safe_0_safe_fv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>always_safe_0 <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> always_safe_0_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> always_safe_0_future_bounded<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"future_bounded <span class="main">(</span>always_safe_0 <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>future_bounded <span class="free">φ</span> <span class="main">∧</span> bounded <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> always_safe_0_def bounded.rep_eq flip_int_double_upper.rep_eq<span class="main">)</span>

<span class="comment1">(* [a, b] *)</span>

<span class="keyword1"><span class="command">lemma</span></span> always_safe_bounded_safe<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="main">(</span>always_safe_bounded <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> safe_formula <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> always_safe_bounded_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> always_safe_bounded_fv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>always_safe_bounded <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> fv <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> always_safe_bounded_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> always_safe_bounded_future_bounded<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"future_bounded <span class="main">(</span>always_safe_bounded <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>future_bounded <span class="free">φ</span> <span class="main">∧</span> bounded <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> always_safe_bounded_def bounded.rep_eq int_remove_lower_bound.rep_eq<span class="main">)</span>

<span class="comment1">(*lemma "mem I 0 ⟹ safe_formula (always I φ) = safe_formula (always_safe_0 I φ)"
  by auto

lemma "¬mem I 0 ⟹ bounded I ⟹ safe_formula (always I φ) = safe_formula (always_safe_bounded I φ)"
  by auto*)</span>                        


<span class="keyword1"><span class="command">lemma</span></span> safe_formula_release_bounded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span> <span class="main">∧</span> safe_formula <span class="free">ψ</span> <span class="main">∧</span> fv <span class="free">φ</span> <span class="main">=</span> fv <span class="free">ψ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="main">(</span>release_safe_bounded <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> release_safe_bounded_def once_def historically_safe_unbounded_def safe_formula_dual_def<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">safe_regex</span> <span class="main">≡</span> Regex.safe_regex fv <span class="main">(</span><span class="main">λ</span><span class="bound">g</span> <span class="bound">φ</span><span class="main">.</span> safe_formula <span class="bound">φ</span> <span class="main">∨</span>
  <span class="main">(</span><span class="bound">g</span> <span class="main">=</span> Lax <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span> Neg <span class="bound">φ'</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> safe_regex_safe_formula<span class="main">:</span>
  <span class="quoted"><span class="quoted">"safe_regex <span class="free">m</span> <span class="free">g</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">φ</span> <span class="main">∈</span> Regex.atms <span class="free">r</span> <span class="main">⟹</span> safe_formula <span class="free">φ</span> <span class="main">∨</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">ψ</span><span class="main">.</span> <span class="free">φ</span> <span class="main">=</span> Neg <span class="bound">ψ</span> <span class="main">∧</span> safe_formula <span class="bound">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">g</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> safe_regex_safe<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> formula<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">φ</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">safe_neg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"formula <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">safe_neg</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">¬</span> safe_formula <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⟶</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span> <span class="main">(</span>Neg <span class="bound">φ'</span><span class="main">)</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">atms</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"formula Regex.regex <span class="main">⇒</span> formula set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">atms</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> Regex.atms <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">.</span>
     <span class="keyword1">if</span> safe_formula <span class="bound">φ</span> <span class="keyword1">then</span> <span class="main">{</span><span class="bound">φ</span><span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span> Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="main">{</span><span class="bound">φ'</span><span class="main">}</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> atms_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"atms <span class="main">(</span>Regex.Skip <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="quoted"><span class="quoted">"atms <span class="main">(</span>Regex.Test <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> safe_formula <span class="free">φ</span> <span class="keyword1">then</span> <span class="main">{</span><span class="free">φ</span><span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">case</span> <span class="free">φ</span> <span class="keyword1">of</span> Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="main">{</span><span class="bound">φ'</span><span class="main">}</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"atms <span class="main">(</span>Regex.Plus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> atms <span class="free">r</span> <span class="main">∪</span> atms <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"atms <span class="main">(</span>Regex.Times <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> atms <span class="free">r</span> <span class="main">∪</span> atms <span class="free">s</span>"</span></span>
  <span class="quoted"><span class="quoted">"atms <span class="main">(</span>Regex.Star <span class="free">r</span><span class="main">)</span> <span class="main">=</span> atms <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> atms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_atms<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>atms <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> disjE_Not2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∨</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="main">⟹</span> <span class="free">R</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">¬</span><span class="free">P</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">R</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> release_safe_unbounded<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="main">(</span>release_safe_bounded <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span><span class="main">)</span> <span class="main">⟹</span> safe_formula <span class="free">φ'</span> <span class="main">∧</span> safe_formula <span class="free">ψ'</span> <span class="main">∧</span> fv <span class="free">φ'</span> <span class="main">=</span> fv <span class="free">ψ'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> release_safe_bounded_def always_safe_bounded_def once_def eventually_def TT_def FF_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_assignment_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> safe_formula_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">,</span> <span class="operator">case_names</span> Eq_Const Eq_Var1 Eq_Var2 neq_Var Pred Let
    And_assign And_safe And_constraint And_Not And_Trigger And_Release
    Ands Neg Or Exists Agg
    Prev Next
    Since Not_Since Until Not_Until
    Trigger_0 Trigger
    Release_0 Release
    MatchP MatchF<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Eq_Const<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span> <span class="bound">d</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Eq <span class="main">(</span>Const <span class="bound">c</span><span class="main">)</span> <span class="main">(</span>Const <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Eq_Var1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Eq <span class="main">(</span>Const <span class="bound">c</span><span class="main">)</span> <span class="main">(</span>Var <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Eq_Var2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">c</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Eq <span class="main">(</span>Var <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>Const <span class="bound">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> neq_Var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Neg <span class="main">(</span>Eq <span class="main">(</span>Var <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>Var <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Pred<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">e</span> <span class="bound">ts</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set <span class="bound">ts</span><span class="main">.</span> is_Var <span class="bound">t</span> <span class="main">∨</span> is_Const <span class="bound">t</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Pred <span class="bound">e</span> <span class="bound">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Let<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">φ</span> <span class="bound">ψ</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>nfv <span class="bound">φ</span><span class="main">}</span> <span class="main">⊆</span> fv <span class="bound">φ</span> <span class="main">⟹</span> safe_formula <span class="bound">φ</span> <span class="main">⟹</span> safe_formula <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Let <span class="bound">p</span> <span class="bound">φ</span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> And_assign<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">ψ</span><span class="main">.</span> safe_formula <span class="bound">φ</span> <span class="main">⟹</span> safe_assignment <span class="main">(</span>fv <span class="bound">φ</span><span class="main">)</span> <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>And <span class="bound">φ</span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> And_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">ψ</span><span class="main">.</span> safe_formula <span class="bound">φ</span> <span class="main">⟹</span> <span class="main">¬</span> safe_assignment <span class="main">(</span>fv <span class="bound">φ</span><span class="main">)</span> <span class="bound">ψ</span> <span class="main">⟹</span> safe_formula <span class="bound">ψ</span> <span class="main">⟹</span>
      <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>And <span class="bound">φ</span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> And_constraint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">ψ</span><span class="main">.</span> safe_formula <span class="bound">φ</span> <span class="main">⟹</span> <span class="main">¬</span> safe_assignment <span class="main">(</span>fv <span class="bound">φ</span><span class="main">)</span> <span class="bound">ψ</span> <span class="main">⟹</span> <span class="main">¬</span> safe_formula <span class="bound">ψ</span> <span class="main">⟹</span>
      fv <span class="bound">ψ</span> <span class="main">⊆</span> fv <span class="bound">φ</span> <span class="main">⟹</span> is_constraint <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>And <span class="bound">φ</span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> And_Not<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">ψ</span><span class="main">.</span> safe_formula <span class="bound">φ</span> <span class="main">⟹</span> <span class="main">¬</span> safe_assignment <span class="main">(</span>fv <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span>Neg <span class="bound">ψ</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> safe_formula <span class="main">(</span>Neg <span class="bound">ψ</span><span class="main">)</span> <span class="main">⟹</span>
      fv <span class="main">(</span>Neg <span class="bound">ψ</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="bound">φ</span> <span class="main">⟹</span> <span class="main">¬</span> is_constraint <span class="main">(</span>Neg <span class="bound">ψ</span><span class="main">)</span> <span class="main">⟹</span> safe_formula <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>And <span class="bound">φ</span> <span class="main">(</span>Neg <span class="bound">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> And_Trigger<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">.</span> safe_formula <span class="bound">φ</span> <span class="main">⟹</span> safe_formula <span class="bound">φ'</span> <span class="main">⟹</span> safe_formula_dual True safe_formula <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span> <span class="main">⟹</span> fv <span class="main">(</span>Trigger <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ'</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">ψ'</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>And <span class="bound">φ</span> <span class="main">(</span>Trigger <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> And_Release<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">.</span> safe_formula <span class="bound">φ</span> <span class="main">⟹</span> safe_formula <span class="bound">φ'</span> <span class="main">⟹</span> safe_formula <span class="bound">ψ'</span> <span class="main">⟹</span> fv <span class="bound">φ'</span> <span class="main">=</span> fv <span class="bound">ψ'</span> <span class="main">⟹</span> bounded <span class="bound">I</span> <span class="main">⟹</span> <span class="main">¬</span>mem <span class="bound">I</span> <span class="main">0</span> <span class="main">⟹</span> fv <span class="main">(</span>Release <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="bound">φ</span>  <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>and_release_safe_bounded <span class="bound">φ</span> <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ'</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">ψ'</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>And <span class="bound">φ</span> <span class="main">(</span>Release <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Ands<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span> <span class="bound">pos</span> <span class="bound">neg</span><span class="main">.</span> <span class="main">(</span><span class="bound">pos</span><span class="main">,</span> <span class="bound">neg</span><span class="main">)</span> <span class="main">=</span> partition safe_formula <span class="bound">l</span> <span class="main">⟹</span> <span class="bound">pos</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span>
      list_all safe_formula <span class="bound">pos</span> <span class="main">⟹</span> list_all <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span>
          Neg <span class="bound">φ'</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span>
          <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> safe_formula <span class="bound">φ</span>
        <span class="main">)</span>
      <span class="main">)</span> <span class="bound">neg</span> <span class="main">⟹</span>
      <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span><span class="main">∈</span>set <span class="bound">neg</span><span class="main">.</span> fv <span class="bound">φ</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span><span class="main">∈</span>set <span class="bound">pos</span><span class="main">.</span> fv <span class="bound">φ</span><span class="main">)</span> <span class="main">⟹</span>
      list_all <span class="free">P</span> <span class="bound">pos</span> <span class="main">⟹</span> list_all <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span>
          Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="free">P</span> <span class="bound">φ'</span>
          <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free">P</span> <span class="bound">φ</span>
        <span class="main">)</span>
      <span class="main">)</span> <span class="bound">neg</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Ands <span class="bound">l</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Neg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span><span class="main">.</span> fv <span class="bound">φ</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> safe_formula <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Neg <span class="bound">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Or<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">ψ</span><span class="main">.</span> fv <span class="bound">ψ</span> <span class="main">=</span> fv <span class="bound">φ</span> <span class="main">⟹</span> safe_formula <span class="bound">φ</span> <span class="main">⟹</span> safe_formula <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Or <span class="bound">φ</span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Exists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span><span class="main">.</span> safe_formula <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Exists <span class="bound">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Agg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span> <span class="bound">ω</span> <span class="bound">b</span> <span class="bound">f</span> <span class="bound">φ</span><span class="main">.</span> <span class="bound">y</span> <span class="main">+</span> <span class="bound">b</span> <span class="main">∉</span> fv <span class="bound">φ</span> <span class="main">⟹</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">b</span><span class="main">}</span> <span class="main">⊆</span> fv <span class="bound">φ</span> <span class="main">⟹</span> fv_trm <span class="bound">f</span> <span class="main">⊆</span> fv <span class="bound">φ</span> <span class="main">⟹</span>
      safe_formula <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Agg <span class="bound">y</span> <span class="bound">ω</span> <span class="bound">b</span> <span class="bound">f</span> <span class="bound">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Prev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">I</span> <span class="bound">φ</span><span class="main">.</span> safe_formula <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Prev <span class="bound">I</span> <span class="bound">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Next<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">I</span> <span class="bound">φ</span><span class="main">.</span> safe_formula <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Next <span class="bound">I</span> <span class="bound">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Since<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">I</span> <span class="bound">ψ</span><span class="main">.</span> fv <span class="bound">φ</span> <span class="main">⊆</span> fv <span class="bound">ψ</span> <span class="main">⟹</span> safe_formula <span class="bound">φ</span> <span class="main">⟹</span> safe_formula <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Since <span class="bound">φ</span> <span class="bound">I</span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Not_Since<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">I</span> <span class="bound">ψ</span><span class="main">.</span> fv <span class="main">(</span>Neg <span class="bound">φ</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="bound">ψ</span> <span class="main">⟹</span> safe_formula <span class="bound">φ</span> <span class="main">⟹</span>
      <span class="main">¬</span> safe_formula <span class="main">(</span>Neg <span class="bound">φ</span><span class="main">)</span> <span class="main">⟹</span> safe_formula <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Since <span class="main">(</span>Neg <span class="bound">φ</span><span class="main">)</span> <span class="bound">I</span> <span class="bound">ψ</span> <span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Until<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">I</span> <span class="bound">ψ</span><span class="main">.</span> fv <span class="bound">φ</span> <span class="main">⊆</span> fv <span class="bound">ψ</span> <span class="main">⟹</span> safe_formula <span class="bound">φ</span> <span class="main">⟹</span> safe_formula <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Until <span class="bound">φ</span> <span class="bound">I</span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Not_Until<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">I</span> <span class="bound">ψ</span><span class="main">.</span> fv <span class="main">(</span>Neg <span class="bound">φ</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="bound">ψ</span> <span class="main">⟹</span> safe_formula <span class="bound">φ</span> <span class="main">⟹</span>
      <span class="main">¬</span> safe_formula <span class="main">(</span>Neg <span class="bound">φ</span><span class="main">)</span> <span class="main">⟹</span> safe_formula <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Until <span class="main">(</span>Neg <span class="bound">φ</span><span class="main">)</span> <span class="bound">I</span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Trigger_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">I</span> <span class="bound">ψ</span><span class="main">.</span> mem <span class="bound">I</span> <span class="main">0</span> <span class="main">⟹</span> safe_formula <span class="bound">ψ</span> <span class="main">⟹</span> fv <span class="bound">φ</span> <span class="main">⊆</span> fv <span class="bound">ψ</span> <span class="main">⟹</span> 
      <span class="main">(</span><span class="main">(</span>safe_formula <span class="bound">φ</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">∨</span> <span class="comment1">― ‹(safe_assignment (fv ψ) φ) ∨ is_constraint φ ∨›</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span> Formula.Neg <span class="bound">φ'</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">φ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Trigger <span class="bound">φ</span> <span class="bound">I</span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Trigger<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">I</span> <span class="bound">ψ</span><span class="main">.</span> False <span class="main">⟹</span> <span class="main">¬</span>mem <span class="bound">I</span> <span class="main">0</span> <span class="main">⟹</span> fv <span class="bound">φ</span> <span class="main">=</span> fv <span class="bound">ψ</span> <span class="main">⟹</span> safe_formula <span class="bound">φ</span> <span class="main">⟹</span> safe_formula <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Trigger <span class="bound">φ</span> <span class="bound">I</span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Release_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">I</span> <span class="bound">ψ</span><span class="main">.</span> mem <span class="bound">I</span> <span class="main">0</span> <span class="main">⟹</span> bounded <span class="bound">I</span> <span class="main">⟹</span> safe_formula <span class="bound">ψ</span> <span class="main">⟹</span> fv <span class="bound">φ</span> <span class="main">⊆</span> fv <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>release_safe_0 <span class="bound">φ</span> <span class="bound">I</span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Release <span class="bound">φ</span> <span class="bound">I</span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Release<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">I</span> <span class="bound">ψ</span><span class="main">.</span> False <span class="main">⟹</span> <span class="main">¬</span>mem <span class="bound">I</span> <span class="main">0</span> <span class="main">⟹</span> fv <span class="bound">φ</span> <span class="main">=</span> fv <span class="bound">ψ</span> <span class="main">⟹</span> safe_formula <span class="bound">φ</span> <span class="main">⟹</span> safe_formula <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Release <span class="bound">φ</span> <span class="bound">I</span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> MatchP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">I</span> <span class="bound">r</span><span class="main">.</span> safe_regex Past Strict <span class="bound">r</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">φ</span> <span class="main">∈</span> atms <span class="bound">r</span><span class="main">.</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>MatchP <span class="bound">I</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> MatchF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">I</span> <span class="bound">r</span><span class="main">.</span> safe_regex Futu Strict <span class="bound">r</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">φ</span> <span class="main">∈</span> atms <span class="bound">r</span><span class="main">.</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>MatchF <span class="bound">I</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> safe_formula.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Eq_Const Eq_Var1 Eq_Var2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> trm.is_Const_def trm.is_Var_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>9 <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹safe_formula <span class="main">(</span>And <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹safe_formula <span class="main">(</span>And <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">consider</span></span>
    <span class="main">(</span>a<span class="main">)</span> <span class="quoted"><span class="quoted">"safe_assignment <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">ψ</span>"</span></span>
    <span class="main">|</span> <span class="main">(</span>b<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> safe_assignment <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">ψ</span>"</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">ψ</span>"</span></span>
    <span class="main">|</span> <span class="main">(</span>c<span class="main">)</span> <span class="quoted"><span class="quoted">"fv <span class="skolem">ψ</span> <span class="main">⊆</span> fv <span class="skolem">φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> safe_assignment <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">ψ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> safe_formula <span class="skolem">ψ</span>"</span></span> <span class="quoted"><span class="quoted">"is_constraint <span class="skolem">ψ</span>"</span></span>
    <span class="main">|</span> <span class="main">(</span>d<span class="main">)</span> <span class="skolem">ψ'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"fv <span class="skolem">ψ</span> <span class="main">⊆</span> fv <span class="skolem">φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> safe_assignment <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">ψ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> safe_formula <span class="skolem">ψ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_constraint <span class="skolem">ψ</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">=</span> Neg <span class="skolem">ψ'</span>"</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">ψ'</span>"</span></span>
    <span class="main">|</span> <span class="main">(</span>e<span class="main">)</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">=</span> Trigger <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span>"</span></span> <span class="quoted"><span class="quoted">"safe_formula_dual True safe_formula <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span>"</span></span> <span class="quoted"><span class="quoted">"fv <span class="skolem">ψ</span> <span class="main">⊆</span> fv <span class="skolem">φ</span>"</span></span>
    <span class="main">|</span> <span class="main">(</span>f<span class="main">)</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">=</span> Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span>"</span></span> <span class="quoted"><span class="quoted">"bounded <span class="skolem">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="skolem">I</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="main">(</span>and_release_safe_bounded <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">φ'</span>"</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">ψ'</span>"</span></span> <span class="quoted"><span class="quoted">"fv <span class="skolem">φ'</span> <span class="main">=</span> fv <span class="skolem">ψ'</span>"</span></span> <span class="quoted"><span class="quoted">"fv <span class="skolem">ψ</span> <span class="main">⊆</span> fv <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> a
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"9.IH"</span> <span class="quoted"><span class="quoted">‹safe_formula <span class="skolem">φ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> And_assign<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> b
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"9.IH"</span> <span class="quoted"><span class="quoted">‹safe_formula <span class="skolem">φ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> And_safe<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> c
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"9.IH"</span> <span class="quoted"><span class="quoted">‹safe_formula <span class="skolem">φ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> And_constraint<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> d
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"9.IH"</span> <span class="quoted"><span class="quoted">‹safe_formula <span class="skolem">φ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> And_Not<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> e
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"9.IH"</span> <span class="quoted"><span class="quoted">‹safe_formula <span class="skolem">φ</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">φ'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> e False
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_formula_dual_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> safe_dual_mem_0<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula_dual False safe_formula <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> e
        <span class="keyword1"><span class="command">unfolding</span></span> safe_formula_dual_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ψ_props<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="main">¬</span> safe_assignment <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">ψ</span>"</span></span>
        <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">ψ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> e<span class="main">(</span>1<span class="main">)</span> safe_dual_mem_0
        <span class="keyword1"><span class="command">unfolding</span></span> safe_assignment_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"9.IH"</span><span class="main">(</span>1-2<span class="main">)</span> <span class="quoted"><span class="quoted">‹safe_formula <span class="skolem">φ</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> And_safe<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> And_Trigger <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_formula_dual_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits formula.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> f
    <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">φ'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">ψ'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"9.IH"</span><span class="main">(</span>5-6<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> f<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> f<span class="main">(</span>5<span class="main">,</span>6<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> And_Release<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹safe_formula <span class="skolem">φ</span>›</span></span> f<span class="main"><span class="main">(</span></span>5-7<span class="main"><span class="main">,</span></span> 2-3<span class="main"><span class="main">)</span></span> f<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> f<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> _ _ p<span class="main">]</span> <span class="quoted">"9.IH"</span><span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹safe_formula <span class="skolem">φ</span>›</span></span><span class="main">]</span> <span class="quoted">"9.IH"</span><span class="main">(</span>7<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> f<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> f<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>10 <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pos</span></span> <span class="skolem"><span class="skolem">neg</span></span> <span class="keyword2"><span class="keyword">where</span></span> posneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pos</span><span class="main">,</span> <span class="skolem">neg</span><span class="main">)</span> <span class="main">=</span> partition safe_formula <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pos</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"10.prems"</span> posneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all safe_formula <span class="skolem">pos</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> posneg <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.pred_set<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> neg_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">φ</span> <span class="main">∈</span> set <span class="skolem">neg</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span>
        Neg <span class="bound">φ'</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> safe_formula <span class="bound">φ</span>
      <span class="main">)</span>
    <span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"10.prems"</span> posneg
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.pred_set<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="free">P</span> <span class="skolem">pos</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> posneg <span class="quoted">"10.IH"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span>
          Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="free">P</span> <span class="bound">φ'</span>
          <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free">P</span> <span class="bound">φ</span>
        <span class="main">)</span>
      <span class="main">)</span> <span class="skolem">neg</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span>
      <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">neg</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> φ_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">φ</span> <span class="keyword1">of</span> Neg <span class="bound">φ'</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> safe_formula <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> neg_props
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="skolem">φ</span> <span class="keyword1">of</span>
          Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="free">P</span> <span class="bound">φ'</span>
          <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free">P</span> <span class="skolem">φ</span>
        <span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"10.IH"</span><span class="main">(</span>2-<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> posneg _ assm<span class="main">]</span> φ_props
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Ball_set_list_all<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"10.prems"</span> Ands posneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>15 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ands <span class="skolem">l</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"15.IH"</span><span class="main">(</span>1-2<span class="main">)</span> <span class="quoted">"15.prems"</span> Since <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> disjE_Not2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Since Not_Since<span class="main">)</span> <span class="comment1">(*SLOW*)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>16 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ands <span class="skolem">l</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"16.IH"</span><span class="main">(</span>1-2<span class="main">)</span><span class="quoted">"16.prems"</span> Until <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> disjE_Not2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Until Not_Until<span class="main">)</span> <span class="comment1">(*SLOW*)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>17 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> mem<span class="main">:</span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">φ</span> <span class="keyword1">of</span> Neg <span class="bound">x</span> <span class="main">⇒</span> safe_formula <span class="bound">x</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">=</span> Neg <span class="skolem">φ'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mem 17 Trigger_0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_formula_dual_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mem 17 Trigger_0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_formula_dual_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Trigger 17 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_formula_dual_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>18 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> mem<span class="main">:</span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 18 Release_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Release 18 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_formula_dual_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>19 <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> MatchP<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atms_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> safe_regex_safe_formula <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>20 <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> MatchF<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atms_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> safe_regex_safe_formula <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> safe_formula_Neg<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="main">(</span>Formula.Neg <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">φ</span> <span class="main">=</span> Formula.Eq <span class="main">(</span>Formula.Var <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>Formula.Var <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>fv <span class="free">φ</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> safe_formula <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"Formula.Neg <span class="free">φ</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> safe_formula.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Slicing traces›</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">matches</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"env <span class="main">⇒</span> formula <span class="main">⇒</span> name <span class="main">×</span> event_data list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Pred <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> map <span class="main">(</span>eval_trm <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> snd <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Let <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">v'</span><span class="main">.</span> <span class="free">matches</span> <span class="bound">v'</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∧</span> <span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
    fst <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> <span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Eq <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Less <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>LessEq <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∨</span> <span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∨</span> <span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Ands <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">φ</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">.</span> <span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">φ</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Exists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="free">matches</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Agg <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">zs</span><span class="main">.</span> length <span class="bound">zs</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∧</span> <span class="free">matches</span> <span class="main">(</span><span class="bound">zs</span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Since <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∨</span> <span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∨</span> <span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Trigger <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∨</span> <span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Release <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∨</span> <span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>MatchP <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">φ</span> <span class="main">∈</span> Regex.atms <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">.</span> <span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">φ</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>MatchF <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">φ</span> <span class="main">∈</span> Regex.atms <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">.</span> <span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">φ</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> matches_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="free">φ</span><span class="main">.</span> <span class="free">v</span><span class="main">!</span><span class="bound">x</span> <span class="main">=</span> <span class="free">v'</span><span class="main">!</span><span class="bound">x</span> <span class="main">⟹</span> matches <span class="free">v</span> <span class="free">φ</span> <span class="free">e</span> <span class="main">=</span> matches <span class="free">v'</span> <span class="free">φ</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">v'</span></span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pred <span class="skolem">n</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> map_cong eval_trm_fv_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Pred<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">simplified</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">THEN</span> bspec<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let <span class="skolem">p</span> <span class="skolem">b</span> <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">e</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 11 0<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ands <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span><span class="main">.</span> <span class="bound">φ</span> <span class="main">∈</span> <span class="main">(</span>set <span class="skolem">l</span><span class="main">)</span> <span class="main">⟹</span> matches <span class="skolem">v</span> <span class="bound">φ</span> <span class="skolem">e</span> <span class="main">=</span> matches <span class="skolem">v'</span> <span class="bound">φ</span> <span class="skolem">e</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> <span class="main">(</span>set <span class="skolem">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv <span class="skolem">φ</span> <span class="main">⊆</span> fv <span class="main">(</span>Ands <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fv_subset_Ands <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="skolem">φ</span><span class="main">.</span> <span class="skolem">v</span><span class="main">!</span><span class="bound">x</span> <span class="main">=</span> <span class="skolem">v'</span><span class="main">!</span><span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Ands.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"matches <span class="skolem">v</span> <span class="skolem">φ</span> <span class="skolem">e</span> <span class="main">=</span> matches <span class="skolem">v'</span> <span class="skolem">φ</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Ands.hyps <span class="quoted"><span class="quoted">‹<span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Exists <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> matches.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iff_exI<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fvi_Suc nth_Cons'<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"matches <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">φ</span> <span class="skolem">e</span> <span class="main">=</span> matches <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="skolem">v'</span><span class="main">)</span> <span class="skolem">φ</span> <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">zs</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">zs</span>
    <span class="keyword1"><span class="command">using</span></span> that Agg.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Agg.hyps<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> v<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">@</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> v'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">@</span> <span class="skolem">v'</span>"</span></span><span class="main"><span class="main">]</span></span>
        nth_append fvi_iff_fv<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> 9 0 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_Cons' fv_regex_alt<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">relevant_events</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">relevant_events</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">e</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∩</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> matches <span class="bound">v</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="bound">e</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sat_slice_strong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">V</span> <span class="main">=</span> dom <span class="free">V'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">v</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> dom <span class="free">V</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> relevant_events <span class="free">φ</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">v</span> <span class="main">∈</span> the <span class="main">(</span><span class="free">V</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">i</span> <span class="main">⟷</span> <span class="bound">v</span> <span class="main">∈</span> the <span class="main">(</span><span class="free">V'</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"relevant_events <span class="free">φ</span> <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="bound">e</span><span class="main">.</span> fst <span class="bound">e</span> <span class="main">∈</span> dom <span class="free">V</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">E</span> <span class="main">⟹</span>
    sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">⟷</span> sat <span class="main">(</span>map_Γ <span class="main">(</span><span class="main">λ</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∩</span> <span class="free">E</span><span class="main">)</span> <span class="free">σ</span><span class="main">)</span> <span class="free">V'</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">V'</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pred <span class="skolem">r</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="skolem">r</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V'</span> <span class="skolem">r</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">V</span> <span class="main">=</span> dom <span class="skolem">V'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> None Pred<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> domIff <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V'</span> <span class="skolem">r</span> <span class="main">=</span> Some <span class="skolem">a'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Some <span class="quoted"><span class="quoted">‹dom <span class="skolem">V</span> <span class="main">=</span> dom <span class="skolem">V'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span>eval_trm <span class="skolem">v</span><span class="main">)</span> <span class="skolem">ts</span> <span class="main">∈</span> the <span class="main">(</span><span class="skolem">V</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span>eval_trm <span class="skolem">v</span><span class="main">)</span> <span class="skolem">ts</span> <span class="main">∈</span> the <span class="main">(</span><span class="skolem">V'</span> <span class="skolem">r</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Some Pred<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> domI<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let <span class="skolem">p</span> <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Let.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sat.simps
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> Let<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">S</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> relevant v dom V<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>V <span class="skolem">p'</span> <span class="skolem">v'</span> <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> True
      <span class="keyword1"><span class="command">with</span></span> V <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> fun_upd_apply eqTrueI<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> if_True option.sel mem_Collect_eq
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ex_cong conj_cong refl Let<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span>
        S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">v'</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">.</span> matches <span class="bound">v</span> <span class="skolem">ψ</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> V<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">V</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">goal_cases</span> relevant' v' dom' V'<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> relevant'
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> subset_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_eq_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>V' <span class="skolem">p'</span> <span class="skolem">v'</span> <span class="skolem">i</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> V<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_eq_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> V<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>5<span class="main">,</span>6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> fun_upd_apply eq_False<span class="main">[</span><span class="operator">THEN</span> iffD2<span class="main">,</span> <span class="operator">OF</span> False<span class="main">]</span> if_False
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> V<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> False<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dom_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Or <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Or.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">S</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">V</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">v</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">V'</span></span></span></span><span class="main">]</span> Or.prems
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Collect_disj_eq Int_Un_distrib subset_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> And.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">S</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">V</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">v</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">V'</span></span></span></span><span class="main">]</span> And.prems
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Collect_disj_eq Int_Un_distrib subset_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ands <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"relevant_events <span class="main">(</span>Ands <span class="skolem">l</span><span class="main">)</span> <span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="bound">e</span><span class="main">.</span> fst <span class="bound">e</span> <span class="main">∈</span> dom <span class="skolem">V</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">E</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Ands.prems<span class="main">(</span>1<span class="main">)</span> Ands.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">e</span><span class="main">.</span> <span class="skolem">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> matches <span class="bound">v</span> <span class="main">(</span>Ands <span class="skolem">l</span><span class="main">)</span> <span class="bound">e</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">e</span><span class="main">.</span> fst <span class="bound">e</span> <span class="main">∈</span> dom <span class="skolem">V</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">E</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span><span class="main">.</span> <span class="bound">φ</span> <span class="main">∈</span> set <span class="skolem">l</span> <span class="main">⟹</span> sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="bound">φ</span> <span class="main">⟷</span> sat <span class="main">(</span>map_Γ <span class="main">(</span><span class="main">λ</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∩</span> <span class="free">E</span><span class="main">)</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">V'</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="bound">φ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"relevant_events <span class="skolem">φ</span> <span class="skolem">S</span> <span class="main">=</span> <span class="main">{</span><span class="bound">e</span><span class="main">.</span> <span class="skolem">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> matches <span class="bound">v</span> <span class="skolem">φ</span> <span class="bound">e</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">e</span><span class="main">.</span> <span class="skolem">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> matches <span class="bound">v</span> <span class="skolem">φ</span> <span class="bound">e</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">e</span><span class="main">.</span> <span class="skolem">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> matches <span class="bound">v</span> <span class="main">(</span>Ands <span class="skolem">l</span><span class="main">)</span> <span class="bound">e</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⊆</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> matches <span class="bound">v</span> <span class="skolem">φ</span> <span class="skolem">e</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> matches <span class="bound">v</span> <span class="main">(</span>Ands <span class="skolem">l</span><span class="main">)</span> <span class="skolem">e</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"matches <span class="skolem">v</span> <span class="skolem">φ</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">l</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"relevant_events <span class="skolem">φ</span> <span class="skolem">S</span> <span class="main">-</span> <span class="main">{</span><span class="bound">e</span><span class="main">.</span> fst <span class="bound">e</span> <span class="main">∈</span> dom <span class="skolem">V</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">E</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Ands.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="skolem">φ</span> <span class="main">⟷</span> sat <span class="main">(</span>map_Γ <span class="main">(</span><span class="main">λ</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∩</span> <span class="free">E</span><span class="main">)</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">V'</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Ands.prems<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">l</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Ands.IH<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">φ</span></span> <span class="quoted"><span class="skolem">S</span></span> <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">V'</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="main">]</span></span> Ands.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">φ</span><span class="main">.</span> <span class="bound">φ</span> <span class="main">∈</span> set <span class="skolem">l</span> <span class="main">⟹</span> sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="bound">φ</span> <span class="main">=</span> sat <span class="main">(</span>map_Γ <span class="main">(</span><span class="main">λ</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∩</span> <span class="free">E</span><span class="main">)</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">V'</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="bound">φ</span>›</span></span> sat_Ands <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Exists <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">#</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">φ</span> <span class="main">=</span> sat <span class="main">(</span>map_Γ <span class="main">(</span><span class="main">λ</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∩</span> <span class="free">E</span><span class="main">)</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">V'</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">#</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">φ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
    <span class="keyword1"><span class="command">using</span></span> Exists.prems<span class="main">(</span>1-3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Exists.IH<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">z</span> <span class="main">#</span> <span class="bound">v</span> <span class="main">|</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span> Exists.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">φ</span> <span class="main">=</span> sat <span class="main">(</span>map_Γ <span class="main">(</span><span class="main">λ</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∩</span> <span class="free">E</span><span class="main">)</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">V'</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">φ</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">zs</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">zs</span>
    <span class="keyword1"><span class="command">using</span></span> that Agg.prems<span class="main">(</span>1-3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Agg.IH<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">zs</span> <span class="main">@</span> <span class="bound">v</span> <span class="main">|</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span> Agg.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> conj_cong<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prev <span class="skolem">I</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> nat.case_cong<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Next <span class="skolem">I</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Since <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Since.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">S</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">V</span></span></span></span><span class="main">]</span> Since.prems
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Collect_disj_eq Int_Un_distrib subset_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Until <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Until.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">S</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">V</span></span></span></span><span class="main">]</span> Until.prems
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Collect_disj_eq Int_Un_distrib subset_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trigger <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Trigger.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">S</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">V</span></span></span></span><span class="main">]</span> Trigger.prems
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Collect_disj_eq Int_Un_distrib subset_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Release <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Release.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">S</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">V</span></span></span></span><span class="main">]</span> Release.prems
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Collect_disj_eq Int_Un_distrib subset_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MatchP <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MatchP.prems<span class="main">(</span>1-3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Regex.match <span class="main">(</span>sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">=</span> Regex.match <span class="main">(</span>sat <span class="main">(</span>map_Γ <span class="main">(</span><span class="main">λ</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∩</span> <span class="free">E</span><span class="main">)</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">V'</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Regex.match_fv_cong MatchP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">S</span></span> <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main"><span class="main">]</span></span> MatchP.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MatchF <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MatchF.prems<span class="main">(</span>1-3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Regex.match <span class="main">(</span>sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">=</span> Regex.match <span class="main">(</span>sat <span class="main">(</span>map_Γ <span class="main">(</span><span class="main">λ</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∩</span> <span class="free">E</span><span class="main">)</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">V'</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Regex.match_fv_cong MatchF<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">S</span></span> <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main"><span class="main">]</span></span> MatchF.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Translation to n-ary conjunction›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">get_and_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"formula <span class="main">⇒</span> formula list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">get_and_list</span> <span class="main">(</span>Ands <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">get_and_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fv_get_and<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span>set <span class="main">(</span>get_and_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> fvi <span class="free">b</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> fvi <span class="free">b</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> get_and_list.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> safe_get_and<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span> <span class="main">⟹</span> list_all safe_neg <span class="main">(</span>get_and_list <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> get_and_list.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">φ</span> <span class="main">∈</span> set <span class="skolem">l</span><span class="main">.</span> <span class="main">¬</span>safe_formula <span class="bound">φ</span> <span class="main">⟶</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span>
        Neg <span class="bound">φ'</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> safe_formula <span class="bound">φ</span>
      <span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">φ</span> <span class="main">∈</span> set <span class="skolem">l</span><span class="main">.</span> <span class="main">¬</span>safe_formula <span class="bound">φ</span> <span class="main">⟶</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span>
        Neg <span class="bound">φ'</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False
      <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>safe_formula <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="skolem">φ</span> <span class="keyword1">of</span>
        Neg <span class="bound">φ'</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False
      <span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> l_props
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_neg_def list_all_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_neg_def list_all_iff <span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_get_and<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">⟷</span> list_all <span class="main">(</span>sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>get_and_list <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> get_and_list.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>

<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">)</span> <span class="entity">convert_multiway</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"formula <span class="main">⇒</span> formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">convert_multiway</span> <span class="main">(</span>Pred <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Pred <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">convert_multiway</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">convert_multiway</span> <span class="main">(</span>Less <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Less <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">convert_multiway</span> <span class="main">(</span>LessEq <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>LessEq <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">convert_multiway</span> <span class="main">(</span>Let <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> Let <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">convert_multiway</span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> Neg <span class="main">(</span><span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">convert_multiway</span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> Or <span class="main">(</span><span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">convert_multiway</span> <span class="main">(</span>And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> safe_assignment <span class="main">(</span>fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">then</span>
      And <span class="main">(</span><span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> safe_formula <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">then</span>
      Ands <span class="main">(</span>get_and_list <span class="main">(</span><span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">@</span> get_and_list <span class="main">(</span><span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span>is_constraint <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
      And <span class="main">(</span><span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">of</span> <span class="main">(</span>Trigger <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">)</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span> <span class="keyword1">then</span>
      And <span class="main">(</span><span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">of</span> <span class="main">(</span>Release <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">)</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>
      <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">of</span> <span class="main">(</span>Release <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">)</span> <span class="main">⇒</span>
        <span class="keyword1">if</span> mem <span class="bound">I</span> <span class="main">0</span> <span class="keyword1">then</span>
          And <span class="main">(</span><span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>
        <span class="keyword1">else</span>
          <span class="free">convert_multiway</span> <span class="main">(</span>and_release_safe_bounded <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">)</span>
    <span class="main">)</span>
    <span class="keyword1">else</span> Ands <span class="main">(</span><span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">#</span> get_and_list <span class="main">(</span><span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">convert_multiway</span> <span class="main">(</span>Ands <span class="free"><span class="bound"><span class="entity">φs</span></span></span><span class="main">)</span> <span class="main">=</span> Ands <span class="main">(</span>map <span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">convert_multiway</span> <span class="main">(</span>Exists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> Exists <span class="main">(</span><span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">convert_multiway</span> <span class="main">(</span>Agg <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> Agg <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">convert_multiway</span> <span class="main">(</span>Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">convert_multiway</span> <span class="main">(</span>Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">convert_multiway</span> <span class="main">(</span>Since <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> Since <span class="main">(</span><span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">convert_multiway</span> <span class="main">(</span>Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> Until <span class="main">(</span><span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">convert_multiway</span> <span class="main">(</span>Trigger <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> Trigger <span class="main">(</span><span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">convert_multiway</span> <span class="main">(</span>Release <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">0</span> <span class="keyword1">then</span>
      <span class="free">convert_multiway</span> <span class="main">(</span>release_safe_0 <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">(</span>
      <span class="free">convert_multiway</span> <span class="main">(</span>release_safe_bounded <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>
    <span class="main">)</span>
  <span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">convert_multiway</span> <span class="main">(</span>MatchP <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> MatchP <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>Regex.map_regex <span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">convert_multiway</span> <span class="main">(</span>MatchF <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> MatchF <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>Regex.map_regex <span class="free">convert_multiway</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command">using</span></span> size'_and_release size'_Release size'_Or size'_release_aux
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure size'"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Nat.less_Suc_eq_le <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_list_mem_leq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">size'</span><span class="main"><span class="main">]</span></span> regex_atms_size'<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">convert_multiway_regex</span> <span class="main">≡</span> Regex.map_regex convert_multiway"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fv_safe_get_and<span class="main">:</span>
  <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span> <span class="main">⟹</span> fv <span class="free">φ</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span>set <span class="main">(</span>filter safe_formula <span class="main">(</span>get_and_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> fv <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> get_and_list.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pos</span></span> <span class="skolem"><span class="skolem">neg</span></span> <span class="keyword2"><span class="keyword">where</span></span> posneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pos</span><span class="main">,</span> <span class="skolem">neg</span><span class="main">)</span> <span class="main">=</span> partition safe_formula <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"get_and_list <span class="main">(</span>Ands <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">neg</span><span class="main">.</span> fv <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">pos</span><span class="main">.</span> fv <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span> posneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>Ands <span class="skolem">l</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">pos</span><span class="main">.</span> fv <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>Ands <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">pos</span><span class="main">.</span> fv <span class="bound">x</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">neg</span><span class="main">.</span> fv <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> posneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sub <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> posneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ex_safe_get_and<span class="main">:</span>
  <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span> <span class="main">⟹</span> list_ex safe_formula <span class="main">(</span>get_and_list <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> get_and_list.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"get_and_list <span class="main">(</span>Ands <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pos</span></span> <span class="skolem"><span class="skolem">neg</span></span> <span class="keyword2"><span class="keyword">where</span></span> posneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pos</span><span class="main">,</span> <span class="skolem">neg</span><span class="main">)</span> <span class="main">=</span> partition safe_formula <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pos</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">pos</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> posneg <span class="keyword1"><span class="command">using</span></span> Bex_set_list_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> case_NegE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="free">φ</span> <span class="keyword1">of</span> Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="free">P</span> <span class="bound">φ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">φ'</span><span class="main">.</span> <span class="free">φ</span> <span class="main">=</span> Neg <span class="bound">φ'</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ'</span> <span class="main">⟹</span> <span class="free">Q</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">declare</span></span> fvi.simps<span class="main">(</span>17<span class="main">)</span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> release_fvi<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fvi <span class="free">b</span> <span class="main">(</span>Release <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> fvi <span class="free">b</span> <span class="main">(</span>release_safe_0 <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"fvi <span class="free">b</span> <span class="main">(</span>Release <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> fvi <span class="free">b</span> <span class="main">(</span>release_safe_bounded <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"fvi <span class="free">b</span> <span class="main">(</span>And <span class="free">φ'</span> <span class="main">(</span>Release <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fvi <span class="free">b</span> <span class="main">(</span>and_release_safe_bounded <span class="free">φ'</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> release_safe_0_def always_safe_0_def TT_def FF_def and_release_safe_bounded_def release_safe_bounded_def always_safe_bounded_def fvi.simps<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> convert_multiway_remove_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="main">(</span>remove_neg <span class="free">φ</span><span class="main">)</span> <span class="main">⟹</span> convert_multiway <span class="main">(</span>remove_neg <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> remove_neg <span class="main">(</span>convert_multiway <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And <span class="skolem">φ'</span> <span class="skolem">ψ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> and_release_safe_bounded_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> case_NegE <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> release_safe_0_def <span class="main">)</span>
                    

<span class="keyword1"><span class="command">lemma</span></span> regex_atms_to_atms<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"safe_regex <span class="free">m</span> <span class="free">s</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">∈</span> regex.atms <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">∈</span> atms <span class="free">r</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ψ</span><span class="main">.</span> <span class="free">φ</span> <span class="main">=</span> Neg <span class="bound">ψ</span> <span class="main">∧</span> safe_formula <span class="bound">ψ</span> <span class="main">∧</span> <span class="bound">ψ</span> <span class="main">∈</span> atms <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> atms_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> ψ_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">=</span> Neg <span class="skolem">ψ</span>"</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> safe_regex_safe_formula<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> safe_formula <span class="free">φ</span> <span class="keyword1">then</span> <span class="main">{</span><span class="free">φ</span><span class="main">}</span> <span class="keyword1">else</span> <span class="keyword1">case</span> <span class="free">φ</span> <span class="keyword1">of</span> Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="main">{</span><span class="bound">φ'</span><span class="main">}</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">{}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">ψ</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> False ψ_props<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">∈</span> atms <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> atms_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">=</span> Neg <span class="skolem">ψ</span> <span class="main">∧</span> safe_formula <span class="skolem">ψ</span> <span class="main">∧</span> <span class="skolem">ψ</span> <span class="main">∈</span> atms <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ψ_props
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fv_convert_multiway_TT<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fvi <span class="free">b</span> <span class="main">(</span>convert_multiway TT<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> TT_def FF_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fv_convert_multiway<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span> <span class="main">⟹</span> fvi <span class="free">b</span> <span class="main">(</span>convert_multiway <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> fvi <span class="free">b</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> safe_formula_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_safe <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_get_and Un_commute<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_Not <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_get_and Un_commute<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_Trigger <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_get_and Un_commute safe_formula_dual_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_Release <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> unsafe_assignment<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>safe_assignment <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> safe_assignment_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> unsafe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> safe_formula <span class="main">(</span>Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_Release<span class="main">(</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> safe_formula.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"convert_multiway <span class="main">(</span>And <span class="skolem">φ</span> <span class="main">(</span>Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> convert_multiway <span class="main">(</span>and_release_safe_bounded <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unsafe_assignment unsafe And_Release<span class="main">(</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fvi <span class="skolem">b</span> <span class="main">(</span>convert_multiway <span class="main">(</span>And <span class="skolem">φ</span> <span class="main">(</span>Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fvi <span class="skolem">b</span> <span class="main">(</span>and_release_safe_bounded <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_Release.IH<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> release_fvi<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ands <span class="skolem">l</span> <span class="skolem">pos</span> <span class="skolem">neg</span><span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> neg_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span><span class="main">.</span> <span class="bound">φ</span><span class="main">∈</span>set <span class="skolem">neg</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> fvi <span class="bound">x</span> <span class="main">(</span>convert_multiway <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> fvi <span class="bound">x</span> <span class="bound">φ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">neg</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">φ</span> <span class="keyword1">of</span> Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> fvi <span class="bound">x</span> <span class="main">(</span>convert_multiway <span class="bound">φ'</span><span class="main">)</span> <span class="main">=</span> fvi <span class="bound">x</span> <span class="bound">φ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> fvi <span class="bound">x</span> <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> fvi <span class="bound">x</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Ands<span class="main">(</span>7<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> list_all_iff
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> fvi <span class="bound">x</span> <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> fvi <span class="bound">x</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">pos</span> <span class="main">∨</span> <span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">neg</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Ands<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fvi <span class="skolem">b</span> <span class="skolem">φ</span> <span class="main">=</span> fvi <span class="skolem">b</span> <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Ands<span class="main">(</span>6<span class="main">)</span> neg_props
      <span class="keyword1"><span class="command">unfolding</span></span> list_all_iff
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trigger_0 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> fvi <span class="bound">x</span> <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> fvi <span class="bound">x</span> <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Trigger_0<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Trigger_0<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Release_0 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> release_fvi<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MatchP <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>regex.atms <span class="skolem">r</span><span class="main">.</span> fvi <span class="skolem">b</span> <span class="main">(</span>convert_multiway <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>fvi <span class="skolem">b</span> <span class="main">`</span> regex.atms <span class="skolem">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>regex.atms <span class="skolem">r</span><span class="main">.</span> fvi <span class="skolem">b</span> <span class="main">(</span>convert_multiway <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ</span></span> <span class="keyword2"><span class="keyword">where</span></span> φ_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> regex.atms <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> fvi <span class="skolem">b</span> <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> atms <span class="skolem">r</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ψ</span><span class="main">.</span> <span class="skolem">φ</span> <span class="main">=</span> Neg <span class="bound">ψ</span> <span class="main">∧</span> safe_formula <span class="bound">ψ</span> <span class="main">∧</span> <span class="bound">ψ</span> <span class="main">∈</span> atms <span class="skolem">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> regex_atms_to_atms<span class="main">[</span><span class="operator">OF</span> MatchP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> φ_props<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> fvi <span class="bound">x</span> <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> fvi <span class="bound">x</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> MatchP<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>fvi <span class="skolem">b</span> <span class="main">`</span> regex.atms <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> φ_props<span class="main">(</span>1-2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>fvi <span class="skolem">b</span> <span class="main">`</span> regex.atms <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ</span></span> <span class="keyword2"><span class="keyword">where</span></span> φ_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> regex.atms <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> fvi <span class="skolem">b</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> atms <span class="skolem">r</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ψ</span><span class="main">.</span> <span class="skolem">φ</span> <span class="main">=</span> Neg <span class="bound">ψ</span> <span class="main">∧</span> safe_formula <span class="bound">ψ</span> <span class="main">∧</span> <span class="bound">ψ</span> <span class="main">∈</span> atms <span class="skolem">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> regex_atms_to_atms<span class="main">[</span><span class="operator">OF</span> MatchP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> φ_props<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> fvi <span class="bound">x</span> <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> fvi <span class="bound">x</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> MatchP<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>regex.atms <span class="skolem">r</span><span class="main">.</span> fvi <span class="skolem">b</span> <span class="main">(</span>convert_multiway <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> φ_props<span class="main">(</span>1-2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> convert_multiway.simps fvi.simps fv_regex_alt regex.set_map image_image
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MatchF <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>regex.atms <span class="skolem">r</span><span class="main">.</span> fvi <span class="skolem">b</span> <span class="main">(</span>convert_multiway <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span> <span class="main">(</span>fvi <span class="skolem">b</span> <span class="main">`</span> regex.atms <span class="skolem">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>regex.atms <span class="skolem">r</span><span class="main">.</span> fvi <span class="skolem">b</span> <span class="main">(</span>convert_multiway <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ</span></span> <span class="keyword2"><span class="keyword">where</span></span> φ_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> regex.atms <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> fvi <span class="skolem">b</span> <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> atms <span class="skolem">r</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ψ</span><span class="main">.</span> <span class="skolem">φ</span> <span class="main">=</span> Neg <span class="bound">ψ</span> <span class="main">∧</span> safe_formula <span class="bound">ψ</span> <span class="main">∧</span> <span class="bound">ψ</span> <span class="main">∈</span> atms <span class="skolem">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> regex_atms_to_atms<span class="main">[</span><span class="operator">OF</span> MatchF<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> φ_props<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> fvi <span class="bound">x</span> <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> fvi <span class="bound">x</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> MatchF<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>fvi <span class="skolem">b</span> <span class="main">`</span> regex.atms <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> φ_props<span class="main">(</span>1-2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>fvi <span class="skolem">b</span> <span class="main">`</span> regex.atms <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ</span></span> <span class="keyword2"><span class="keyword">where</span></span> φ_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> regex.atms <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> fvi <span class="skolem">b</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> atms <span class="skolem">r</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ψ</span><span class="main">.</span> <span class="skolem">φ</span> <span class="main">=</span> Neg <span class="bound">ψ</span> <span class="main">∧</span> safe_formula <span class="bound">ψ</span> <span class="main">∧</span> <span class="bound">ψ</span> <span class="main">∈</span> atms <span class="skolem">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> regex_atms_to_atms<span class="main">[</span><span class="operator">OF</span> MatchF<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> φ_props<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> fvi <span class="bound">x</span> <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> fvi <span class="bound">x</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> MatchF<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>regex.atms <span class="skolem">r</span><span class="main">.</span> fvi <span class="skolem">b</span> <span class="main">(</span>convert_multiway <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> φ_props<span class="main">(</span>1-2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> convert_multiway.simps fvi.simps fv_regex_alt regex.set_map image_image
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nfv_convert_multiway<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span> <span class="main">⟹</span> nfv <span class="main">(</span>convert_multiway <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> nfv <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nfv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_convert_multiway<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> get_and_nonempty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"get_and_list <span class="free">φ</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> future_bounded_get_and<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all future_bounded <span class="main">(</span>get_and_list <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> future_bounded <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> safe_convert_multiway<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span> <span class="main">⟹</span> safe_formula <span class="main">(</span>convert_multiway <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> safe_formula_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_safe <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"And <span class="skolem">φ</span> <span class="skolem">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="var">?a</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cφ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="skolem">φ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cψ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="skolem">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> b_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">=</span> Ands <span class="main">(</span>get_and_list <span class="var">?cφ</span> <span class="main">@</span> get_and_list <span class="var">?cψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_safe <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"get_and_list <span class="var">?cφ</span> <span class="main">@</span> get_and_list <span class="var">?cψ</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pos</span></span> <span class="skolem"><span class="skolem">neg</span></span> <span class="keyword2"><span class="keyword">where</span></span> posneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pos</span><span class="main">,</span> <span class="skolem">neg</span><span class="main">)</span> <span class="main">=</span> partition safe_formula <span class="var">?l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all safe_formula <span class="skolem">pos</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> lsafe_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all safe_neg <span class="var">?l</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> And_safe <span class="quoted"><span class="quoted">‹safe_formula <span class="skolem">φ</span>›</span></span> <span class="quoted"><span class="quoted">‹safe_formula <span class="skolem">ψ</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_get_and<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> list_all_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span>
        Neg <span class="bound">φ'</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> safe_formula <span class="bound">φ</span>
      <span class="main">)</span>
    <span class="main">)</span> <span class="skolem">neg</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">neg</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span>
        Neg <span class="bound">φ'</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> safe_formula <span class="bound">x</span>
      <span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">neg</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> safe_formula <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> posneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"safe_neg <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lsafe_neg <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">neg</span>›</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> safe_neg_def list_all_iff partition_set<span class="main">[</span><span class="operator">OF</span> posneg<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="skolem">x</span> <span class="keyword1">of</span>
          Neg <span class="bound">φ'</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span>
          <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> safe_formula <span class="skolem">x</span>
        <span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> safe_neg_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> pos_filter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pos</span> <span class="main">=</span> filter safe_formula <span class="main">(</span>get_and_list <span class="var">?cφ</span> <span class="main">@</span> get_and_list <span class="var">?cψ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> posneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">neg</span><span class="main">.</span> fv <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">pos</span><span class="main">.</span> fv <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="var">?cφ</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span>set <span class="main">(</span>filter safe_formula <span class="main">(</span>get_and_list <span class="var">?cφ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> fv <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⊆</span> <span class="var">?fvφ</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> And_safe <span class="quoted"><span class="quoted">‹safe_formula <span class="skolem">φ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fv_safe_get_and<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="var">?cψ</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span>set <span class="main">(</span>filter safe_formula <span class="main">(</span>get_and_list <span class="var">?cψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> fv <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⊆</span> <span class="var">?fvψ</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> And_safe <span class="quoted"><span class="quoted">‹safe_formula <span class="skolem">ψ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fv_safe_get_and<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">neg</span><span class="main">.</span> fv <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="var">?cφ</span> <span class="main">∪</span> fv <span class="var">?cψ</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>fv <span class="main">`</span> set <span class="skolem">neg</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span> <span class="main">(</span>fv <span class="main">`</span> <span class="main">(</span>set <span class="skolem">pos</span> <span class="main">∪</span> set <span class="skolem">neg</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> fv <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span> <span class="main">∪</span> fv <span class="main">(</span>convert_multiway <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> partition_set<span class="main">[</span><span class="operator">OF</span> posneg<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_get_and<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">neg</span><span class="main">.</span> fv <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="var">?fvφ</span> <span class="main">∪</span> <span class="var">?fvψ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> pos_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pos</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>get_and_list <span class="var">?cφ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> And_safe <span class="quoted"><span class="quoted">‹safe_formula <span class="skolem">φ</span>›</span></span> ex_safe_get_and <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_ex_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> pos_filter <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> filter_empty_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> b_def
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋃</span> <span class="main">(</span>fv <span class="main">`</span> set <span class="skolem">neg</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span> <span class="main">(</span>fv <span class="main">`</span> set <span class="skolem">pos</span><span class="main">)</span>›</span></span> list_all_neg <span class="quoted"><span class="quoted">‹list_all safe_formula <span class="skolem">pos</span>›</span></span> posneg
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_Not <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"And <span class="skolem">φ</span> <span class="main">(</span>Neg <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="var">?a</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cφ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="skolem">φ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cψ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="skolem">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> b_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">=</span> Ands <span class="main">(</span>Neg <span class="var">?cψ</span> <span class="main">#</span> get_and_list <span class="var">?cφ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_Not <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Neg <span class="var">?cψ</span> <span class="main">#</span> get_and_list <span class="var">?cφ</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹safe_formula <span class="var">?cφ</span>›</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all safe_neg <span class="main">(</span>get_and_list <span class="var">?cφ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_get_and<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"safe_neg <span class="main">(</span>Neg <span class="var">?cψ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹safe_formula <span class="var">?cψ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_neg_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lsafe_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all safe_neg <span class="var">?l</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pos</span></span> <span class="skolem"><span class="skolem">neg</span></span> <span class="keyword2"><span class="keyword">where</span></span> posneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pos</span><span class="main">,</span> <span class="skolem">neg</span><span class="main">)</span> <span class="main">=</span> partition safe_formula <span class="var">?l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all safe_formula <span class="skolem">pos</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    
    <span class="keyword1"><span class="command">have</span></span> list_all_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span>
        Neg <span class="bound">φ'</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> safe_formula <span class="bound">φ</span>
      <span class="main">)</span>
    <span class="main">)</span> <span class="skolem">neg</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>set <span class="skolem">neg</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span>
        Neg <span class="bound">φ'</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> safe_formula <span class="bound">x</span>
      <span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">neg</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> safe_formula <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> posneg <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> filter.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"safe_neg <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lsafe_neg <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">neg</span>›</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> safe_neg_def list_all_iff partition_set<span class="main">[</span><span class="operator">OF</span> posneg<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="skolem">x</span> <span class="keyword1">of</span>
          Neg <span class="bound">φ'</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span>
          <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> safe_formula <span class="skolem">x</span>
        <span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> safe_neg_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Ball_set_list_all <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> pos_filter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pos</span> <span class="main">=</span> filter safe_formula <span class="var">?l</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> posneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> neg_filter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">neg</span> <span class="main">=</span> filter <span class="main">(</span>Not <span class="main">∘</span> safe_formula<span class="main">)</span> <span class="var">?l</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> posneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span>set <span class="skolem">neg</span><span class="main">)</span><span class="main">.</span> fv <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span>set <span class="skolem">pos</span><span class="main">)</span><span class="main">.</span> fv <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> fv_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span>set <span class="skolem">neg</span><span class="main">)</span><span class="main">.</span> fv <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span>set <span class="var">?l</span><span class="main">)</span><span class="main">.</span> fv <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> posneg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span>set <span class="var">?l</span><span class="main">)</span><span class="main">.</span> fv <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="var">?cφ</span> <span class="main">∪</span> fv <span class="var">?cψ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹safe_formula <span class="skolem">φ</span>›</span></span> <span class="quoted"><span class="quoted">‹safe_formula <span class="skolem">ψ</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_get_and fv_convert_multiway<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv <span class="var">?cφ</span> <span class="main">∪</span> fv <span class="var">?cψ</span> <span class="main">⊆</span> fv <span class="var">?cφ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹safe_formula <span class="skolem">φ</span>›</span></span> <span class="quoted"><span class="quoted">‹safe_formula <span class="skolem">ψ</span>›</span></span> <span class="quoted"><span class="quoted">‹fv <span class="main">(</span>Neg <span class="skolem">ψ</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="skolem">φ</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_convert_multiway<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span>set <span class="skolem">neg</span><span class="main">)</span><span class="main">.</span> fv <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="var">?cφ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fv_neg <span class="keyword1"><span class="command">unfolding</span></span> neg_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> pos_filter
        <span class="keyword1"><span class="command">using</span></span> fv_safe_get_and<span class="main">[</span><span class="operator">OF</span> And_Not.IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pos</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>get_and_list <span class="var">?cφ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> And_Not.IH <span class="quoted"><span class="quoted">‹safe_formula <span class="skolem">φ</span>›</span></span> ex_safe_get_and <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_ex_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> pos_filter <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> filter_empty_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> b_def
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋃</span> <span class="main">(</span>fv <span class="main">`</span> set <span class="skolem">neg</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span> <span class="main">(</span>fv <span class="main">`</span> set <span class="skolem">pos</span><span class="main">)</span>›</span></span> list_all_neg <span class="quoted"><span class="quoted">‹list_all safe_formula <span class="skolem">pos</span>›</span></span> posneg
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_Trigger <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Trigger <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> And <span class="skolem">φ</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> t_not_safe_assign<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>safe_assignment <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> safe_assignment_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> t_not_constraint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_constraint <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span> <span class="main">∈</span> set <span class="main">(</span>get_and_list <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> safe_formula <span class="bound">f</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> set <span class="main">(</span>get_and_list <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>safe_formula <span class="bound">f</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span>Ands <span class="bound">l</span><span class="main">)</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"convert_multiway <span class="skolem">φ</span> <span class="main">=</span> Ands <span class="skolem">l</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> assm And_Trigger<span class="main">(</span>5<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"get_and_list <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>convert_multiway <span class="skolem">φ</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assm
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> assm And_Trigger<span class="main">(</span>5<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> filter_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"filter safe_formula <span class="main">(</span>get_and_list <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_empty_conv<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> φ_fvs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map fv <span class="main">(</span>snd <span class="main">(</span>partition safe_formula <span class="main">(</span>get_and_list <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map fv <span class="main">(</span>fst <span class="main">(</span>partition safe_formula <span class="main">(</span>get_and_list <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_Trigger
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">t</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> get_and_list <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span> <span class="main">@</span> get_and_list <span class="main">(</span>convert_multiway <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pos</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pos</span> <span class="main">=</span> fst <span class="main">(</span>partition safe_formula <span class="skolem">l</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">neg</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">neg</span> <span class="main">=</span> snd <span class="main">(</span>partition safe_formula <span class="skolem">l</span><span class="main">)</span>"</span></span>

    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> convert_f<span class="main">:</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="skolem">f</span> <span class="main">=</span> Ands <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> f_def l_def
      <span class="keyword1"><span class="command">using</span></span> t_not_safe_assign
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="main">(</span>convert_multiway <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> And_Trigger True
      <span class="keyword1"><span class="command">unfolding</span></span> t_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_formula_dual_def fv_convert_multiway<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> neg_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map fv <span class="skolem">neg</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map fv <span class="main">(</span>snd <span class="main">(</span>partition safe_formula <span class="main">(</span>get_and_list <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> neg_def l_def t_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span>
      <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">0</span>"</span></span>
      <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">ψ'</span>"</span></span>
      <span class="quoted"><span class="quoted">"fv <span class="skolem">φ'</span> <span class="main">⊆</span> fv <span class="skolem">ψ'</span>"</span></span>
      <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">φ'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True And_Trigger
      <span class="keyword1"><span class="command">unfolding</span></span> t_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_formula_dual_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter safe_formula <span class="skolem">pos</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> filter_pos
      <span class="keyword1"><span class="command">unfolding</span></span> pos_def l_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span>
        Neg <span class="bound">φ'</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> safe_formula <span class="bound">φ</span>
      <span class="main">)</span>
    <span class="main">)</span> <span class="skolem">neg</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> And_Trigger mem
      <span class="keyword1"><span class="command">unfolding</span></span> l_def neg_def t_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_formula_dual_def fv_convert_multiway<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map fv <span class="skolem">neg</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map fv <span class="skolem">pos</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> φ_fvs neg_fv
      <span class="keyword1"><span class="command">unfolding</span></span> l_def pos_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_convert_multiway<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="main">(</span>Ands <span class="skolem">l</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pos_def neg_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> convert_f
      <span class="keyword1"><span class="command">unfolding</span></span> f_def t_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>

    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> convert_f<span class="main">:</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="skolem">f</span> <span class="main">=</span> And <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>Trigger <span class="main">(</span>convert_multiway <span class="skolem">φ'</span><span class="main">)</span> <span class="skolem">I</span> <span class="main">(</span>convert_multiway <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t_not_safe_assign t_not_constraint
      <span class="keyword1"><span class="command">unfolding</span></span> f_def t_def convert_multiway.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> And_Trigger
      <span class="keyword1"><span class="command">unfolding</span></span> f_def t_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_convert_multiway safe_formula_dual_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_Release <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> And <span class="skolem">φ</span> <span class="skolem">r</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> t_not_safe_assign<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>safe_assignment <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> safe_assignment_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> t_not_constraint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_constraint <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> unsafe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> safe_formula <span class="main">(</span>Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_Release
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>convert_multiway <span class="skolem">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>convert_multiway <span class="main">(</span>and_release_safe_bounded <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> t_not_safe_assign t_not_constraint unsafe And_Release<span class="main">(</span>5-6<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> f_def r_def convert_multiway.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="main">(</span>convert_multiway <span class="main">(</span>and_release_safe_bounded <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_Release.IH
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_def r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ands <span class="skolem">l</span> <span class="skolem">pos</span> <span class="skolem">neg</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pos'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pos'</span> <span class="main">=</span> fst <span class="main">(</span>partition safe_formula <span class="main">(</span>map convert_multiway <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">neg'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">neg'</span> <span class="main">=</span> snd <span class="main">(</span>partition safe_formula <span class="main">(</span>map convert_multiway <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> pos_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map fv <span class="skolem">pos</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map fv <span class="skolem">pos'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Ands<span class="main">(</span>1<span class="main">,</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> pos'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff fv_convert_multiway<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> neg_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">α</span> <span class="main">∈</span> set <span class="skolem">neg'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">α'</span> <span class="main">∈</span> set <span class="skolem">neg</span><span class="main">.</span> <span class="bound">α</span> <span class="main">=</span> convert_multiway <span class="bound">α'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">α</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">α</span> <span class="main">∈</span> set <span class="skolem">neg'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> α_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">α</span> <span class="main">∈</span> set <span class="skolem">neg'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>safe_formula <span class="skolem">α</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> neg'_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="keyword2"><span class="keyword">where</span></span> α'_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">α</span> <span class="main">=</span> convert_multiway <span class="skolem">α'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">α'</span> <span class="main">∈</span> set <span class="skolem">l</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> neg'_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">α'</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">α</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> α'_props Ands<span class="main">(</span>1<span class="main">,</span>6<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> α_props<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>safe_formula <span class="skolem">α'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">α'</span> <span class="main">∈</span> set <span class="skolem">neg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">α</span> <span class="main">=</span> convert_multiway <span class="skolem">α'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Ands<span class="main">(</span>1<span class="main">)</span> α'_props
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">α'</span> <span class="main">∈</span> set <span class="skolem">neg</span><span class="main">.</span> <span class="skolem">α</span> <span class="main">=</span> convert_multiway <span class="bound">α'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> neg_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map fv <span class="skolem">neg'</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map fv <span class="skolem">neg</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map fv <span class="skolem">neg'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="keyword2"><span class="keyword">where</span></span> α_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> fv <span class="skolem">α</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">α</span> <span class="main">∈</span> set <span class="skolem">neg'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>safe_formula <span class="skolem">α</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> neg'_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α'</span></span> <span class="keyword2"><span class="keyword">where</span></span> α'_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">α'</span><span class="main">∈</span> set <span class="skolem">neg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">α</span> <span class="main">=</span> convert_multiway <span class="skolem">α'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> neg_mem
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv <span class="skolem">α'</span> <span class="main">=</span> fv <span class="main">(</span>convert_multiway <span class="skolem">α'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">α'</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> fv_convert_multiway<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α''</span></span> <span class="keyword2"><span class="keyword">where</span></span> α''_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">α'</span> <span class="main">=</span> Neg <span class="skolem">α''</span>"</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">α''</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Ands<span class="main">(</span>4<span class="main">)</span> α'_props<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> list_all_iff
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">φ</span><span class="main">∈</span>set <span class="skolem">neg</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span> Neg <span class="bound">x</span> <span class="main">⇒</span> safe_formula <span class="bound">x</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> safe_formula <span class="bound">φ</span>"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">α''</span><span class="main">.</span> <span class="main">⟦</span><span class="skolem">α'</span> <span class="main">=</span> Neg <span class="bound">α''</span><span class="main">;</span> safe_formula <span class="bound">α''</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="skolem">thesis</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">α'</span> <span class="keyword1">of</span> Neg <span class="bound">x</span> <span class="main">⇒</span> safe_formula <span class="bound">x</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False"</span></span>
            <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False <span class="quoted"><span class="quoted">‹<span class="skolem">α'</span> <span class="main">∈</span> set <span class="skolem">neg</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> a2 case_NegE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> fv_convert_multiway<span class="main">[</span><span class="operator">OF</span> α''_props<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>

      
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map fv <span class="skolem">neg</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> α_props<span class="main">(</span>1<span class="main">)</span> α'_props<span class="main">(</span>1-2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">α</span> <span class="main">∈</span> set <span class="skolem">pos</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Ands<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> hd_in_set
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">α</span> <span class="main">∈</span> set <span class="skolem">l</span>"</span></span>
    <span class="quoted"><span class="quoted">"safe_formula <span class="main">(</span>convert_multiway <span class="skolem">α</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Ands<span class="main">(</span>1<span class="main">,</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"convert_multiway <span class="skolem">α</span> <span class="main">∈</span> set <span class="skolem">pos'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> pos'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pos'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span>
        Neg <span class="bound">φ'</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> safe_formula <span class="bound">φ</span>
      <span class="main">)</span>
    <span class="main">)</span> <span class="skolem">neg'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">neg'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> φ'_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ'</span><span class="main">∈</span>set <span class="skolem">neg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">=</span> convert_multiway <span class="skolem">φ'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> neg_mem
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> φ'_cases<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">φ'</span> <span class="keyword1">of</span>
           Neg <span class="bound">φ'</span> <span class="main">⇒</span> safe_formula <span class="main">(</span>convert_multiway <span class="bound">φ'</span><span class="main">)</span>
           <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> safe_formula <span class="skolem">φ</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">φ'</span> <span class="keyword1">of</span> Neg <span class="bound">φ'</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> safe_formula <span class="skolem">φ'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Ands<span class="main">(</span>4<span class="main">,</span>7<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>

      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="skolem">φ</span> <span class="keyword1">of</span>
          Neg <span class="bound">φ'</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span>
          <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> safe_formula <span class="skolem">φ</span>
        <span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> φ'_props
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ'</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And <span class="skolem">α</span> <span class="skolem">β</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> φ'_cases<span class="main">(</span>1<span class="main">)</span> φ'_props
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="skolem">β</span> <span class="keyword1">of</span> <span class="main">(</span>Release <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">)</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> β_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">β</span> <span class="main">=</span> Release <span class="skolem">a</span> <span class="skolem">I</span> <span class="skolem">b</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
          
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">β</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> φ_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">=</span> Ands <span class="main">(</span>get_and_list <span class="main">(</span>convert_multiway <span class="skolem">α</span><span class="main">)</span> <span class="main">@</span> get_and_list <span class="main">(</span>convert_multiway <span class="main">(</span>Release <span class="skolem">a</span> <span class="skolem">I</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> "</span></span>
              <span class="keyword1"><span class="command">using</span></span> β_eq And φ'_cases<span class="main">(</span>1<span class="main">)</span> φ'_props
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_assignment_def<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">φ</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> φ'_cases<span class="main">(</span>1<span class="main">)</span> And
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">0</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> mem<span class="main">:</span> True
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> φ_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">=</span> And <span class="main">(</span>convert_multiway <span class="skolem">α</span><span class="main">)</span> <span class="main">(</span>convert_multiway <span class="main">(</span>Release <span class="skolem">a</span> <span class="skolem">I</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> False<span class="main">[</span><span class="operator">unfolded</span> β_eq<span class="main">]</span>
                <span class="keyword1"><span class="command">unfolding</span></span> φ'_props<span class="main">(</span>2<span class="main">)</span> And<span class="main">[</span><span class="operator">unfolded</span> β_eq<span class="main">]</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_assignment_def<span class="main">)</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">φ</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> φ'_cases<span class="main">(</span>1<span class="main">)</span> And
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> not_mem<span class="main">:</span> False
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> φ_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">=</span> convert_multiway <span class="main">(</span>and_release_safe_bounded <span class="skolem">α</span> <span class="skolem">a</span> <span class="skolem">I</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> False<span class="main">[</span><span class="operator">unfolded</span> β_eq<span class="main">]</span>
                <span class="keyword1"><span class="command">unfolding</span></span> φ'_props<span class="main">(</span>2<span class="main">)</span> And<span class="main">[</span><span class="operator">unfolded</span> β_eq<span class="main">]</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_assignment_def<span class="main">)</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">φ</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> φ'_cases<span class="main">(</span>1<span class="main">)</span> And
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> and_release_safe_bounded_def<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> release_safe_0_def<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map fv <span class="skolem">neg'</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map fv <span class="skolem">pos'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Ands<span class="main">(</span>5<span class="main">)</span> pos_fv neg_fv
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> neg'_def pos'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="main">(</span>Neg <span class="skolem">φ'</span><span class="main">)</span> <span class="main">⟷</span> safe_formula <span class="skolem">φ'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"fv <span class="skolem">φ'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">φ'</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Neg <span class="skolem">φ'</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> safe_formula.cases<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">with</span></span> Neg <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_convert_multiway<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> assms<span class="main">:</span> <span class="main">(</span>Trigger_0 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">φ</span> <span class="main">∧</span> safe_formula <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_convert_multiway safe_formula_dual_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="comment1">(*moreover {
    assume assm: "safe_assignment (fv ψ) φ"
    
    then have "safe_assignment (fv (convert_multiway ψ)) (convert_multiway φ)"
      using assm assms(2-3)
      by (cases φ) (auto simp add: safe_assignment_def fv_convert_multiway)

    moreover have "fv (convert_multiway φ) ⊆ fv (convert_multiway ψ)"
      using assm assms(2-3)
      by (cases φ) (auto simp add: safe_assignment_def fv_convert_multiway)

    ultimately have ?case
      using assms
      by (auto simp add: fv_convert_multiway)
  }
  moreover {
    assume assm: "is_constraint φ"
    then have "is_constraint (convert_multiway φ)"
      using assm assms(2-3)
    proof (cases φ)
      case (Neg φ')
      then show ?thesis using assm by (cases φ') (auto simp add: fv_convert_multiway)
    qed (auto simp add: fv_convert_multiway)

    moreover have "fv (convert_multiway φ) ⊆ fv (convert_multiway ψ)"
      using assm assms(2-3)
    proof (cases φ)
      case (Neg φ')
      then show ?thesis using assms(2-3) assm by (cases φ') (auto simp add: fv_convert_multiway)
    qed (auto simp add: fv_convert_multiway)

    ultimately have ?case
      using assms
      by (auto simp add: fv_convert_multiway)
  }*)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="skolem">φ</span> <span class="keyword1">of</span> Neg <span class="bound">φ'</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span> <span class="main">∧</span> safe_formula <span class="main">(</span>convert_multiway <span class="bound">φ'</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> φ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">=</span> Neg <span class="skolem">φ'</span>"</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">φ'</span>"</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="main">(</span>convert_multiway <span class="skolem">φ'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_convert_multiway safe_formula_dual_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MatchP <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atms_def fv_convert_multiway <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> safe_regex_map_regex
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> disjE_Not2 case_NegE
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> safe_regex_safe_formula <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MatchF <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atms_def fv_convert_multiway <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> safe_regex_map_regex
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> disjE_Not2 case_NegE
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> safe_regex_safe_formula <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_convert_multiway nfv_convert_multiway <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> future_bounded_multiway_Ands<span class="main">:</span> <span class="quoted"><span class="quoted">"future_bounded <span class="main">(</span>convert_multiway <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> future_bounded <span class="free">φ</span> <span class="main">⟹</span> future_bounded <span class="main">(</span>Ands <span class="main">(</span>get_and_list <span class="main">(</span>convert_multiway <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> future_bounded <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="main">(</span>convert_multiway <span class="free">φ</span><span class="main">)</span> <span class="keyword1">of</span> Ands <span class="bound">l</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> release_bounded_future_bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.future_bounded <span class="main">(</span>release_safe_bounded <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>bounded <span class="free">I</span> <span class="main">∧</span> <span class="main">¬</span>mem <span class="free">I</span> <span class="main">0</span> <span class="main">∧</span> Formula.future_bounded <span class="free">ψ</span> <span class="main">∧</span> Formula.future_bounded <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.future_bounded <span class="main">(</span>release_safe_bounded <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bounded <span class="free">I</span> <span class="main">∧</span> <span class="main">¬</span>mem <span class="free">I</span> <span class="main">0</span> <span class="main">∧</span> Formula.future_bounded <span class="free">ψ</span> <span class="main">∧</span> Formula.future_bounded <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> release_safe_bounded_def eventually_def bounded.rep_eq flip_int_less_lower.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"bounded <span class="free">I</span> <span class="main">∧</span> <span class="main">¬</span>mem <span class="free">I</span> <span class="main">0</span> <span class="main">∧</span> Formula.future_bounded <span class="free">ψ</span> <span class="main">∧</span> Formula.future_bounded <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.future_bounded <span class="main">(</span>release_safe_bounded <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> flip_int_less_lower_props<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="quoted">"flip_int_less_lower <span class="free">I</span>"</span></span><span class="main">]</span> int_remove_lower_bound_bounded
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> release_safe_bounded_def eventually_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> future_bounded_convert_multiway<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span> <span class="main">⟹</span> future_bounded <span class="main">(</span>convert_multiway <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> future_bounded <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> safe_formula_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_safe <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"And <span class="skolem">φ</span> <span class="skolem">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="var">?a</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cφ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="skolem">φ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cψ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="skolem">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> b_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">=</span> Ands <span class="main">(</span>get_and_list <span class="var">?cφ</span> <span class="main">@</span> get_and_list <span class="var">?cψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_safe <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"future_bounded <span class="var">?a</span> <span class="main">=</span> <span class="main">(</span>future_bounded <span class="var">?cφ</span> <span class="main">∧</span> future_bounded <span class="var">?cψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_safe <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"future_bounded <span class="var">?cφ</span> <span class="main">=</span> list_all future_bounded <span class="main">(</span>get_and_list <span class="var">?cφ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹safe_formula <span class="skolem">φ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> future_bounded_get_and safe_convert_multiway<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"future_bounded <span class="var">?cψ</span> <span class="main">=</span> list_all future_bounded <span class="main">(</span>get_and_list <span class="var">?cψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹safe_formula <span class="skolem">ψ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> future_bounded_get_and safe_convert_multiway<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"future_bounded <span class="var">?b</span> <span class="main">=</span> list_all future_bounded <span class="main">(</span>get_and_list <span class="var">?cφ</span> <span class="main">@</span> get_and_list <span class="var">?cψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> b_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_Not <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"And <span class="skolem">φ</span> <span class="main">(</span>Neg <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="var">?a</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cφ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="skolem">φ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cψ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="skolem">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> b_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">=</span> Ands <span class="main">(</span>Neg <span class="var">?cψ</span> <span class="main">#</span> get_and_list <span class="var">?cφ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_Not <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"future_bounded <span class="var">?a</span> <span class="main">=</span> <span class="main">(</span>future_bounded <span class="var">?cφ</span> <span class="main">∧</span> future_bounded <span class="var">?cψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_Not <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"future_bounded <span class="var">?cφ</span> <span class="main">=</span> list_all future_bounded <span class="main">(</span>get_and_list <span class="var">?cφ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹safe_formula <span class="skolem">φ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> future_bounded_get_and safe_convert_multiway<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"future_bounded <span class="var">?b</span> <span class="main">=</span> list_all future_bounded <span class="main">(</span>Neg <span class="var">?cψ</span> <span class="main">#</span> get_and_list <span class="var">?cφ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> b_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.pred_map o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_Trigger <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Trigger <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> And <span class="skolem">φ</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> t_not_safe_assign<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>safe_assignment <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> safe_assignment_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> t_not_constraint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_constraint <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">t</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="main">(</span>get_and_list <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span> <span class="main">@</span> get_and_list <span class="main">(</span>convert_multiway <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f_convert<span class="main">:</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="skolem">f</span> <span class="main">=</span> Ands <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t_not_safe_assign
      <span class="keyword1"><span class="command">unfolding</span></span> l_def f_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> t_multiway<span class="main">:</span> <span class="quoted"><span class="quoted">"future_bounded <span class="main">(</span>convert_multiway <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> future_bounded <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> And_Trigger<span class="main">(</span>6-7<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> t_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all future_bounded <span class="skolem">l</span> <span class="main">=</span> <span class="main">(</span>future_bounded <span class="skolem">φ</span> <span class="main">∧</span> future_bounded <span class="main">(</span>Trigger <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> future_bounded_multiway_Ands<span class="main">[</span><span class="operator">OF</span> t_multiway<span class="main">]</span> future_bounded_multiway_Ands<span class="main">[</span><span class="operator">OF</span> And_Trigger<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> l_def t_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> f_convert
      <span class="keyword1"><span class="command">unfolding</span></span> f_def t_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> convert_f<span class="main">:</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="skolem">f</span> <span class="main">=</span> And <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>Trigger <span class="main">(</span>convert_multiway <span class="skolem">φ'</span><span class="main">)</span> <span class="skolem">I</span> <span class="main">(</span>convert_multiway <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t_not_safe_assign t_not_constraint
      <span class="keyword1"><span class="command">unfolding</span></span> f_def t_def convert_multiway.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> And_Trigger
      <span class="keyword1"><span class="command">unfolding</span></span> f_def t_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_convert_multiway safe_formula_dual_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_Release <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> release_bounded_future_bounded
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> and_release_safe_bounded_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ands <span class="skolem">l</span> <span class="skolem">pos</span> <span class="skolem">neg</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l_future_bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> future_bounded <span class="main">(</span>convert_multiway <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> future_bounded <span class="bound">a</span><span class="main">)</span> <span class="skolem">l</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span>
      <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"future_bounded <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> future_bounded <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">pos</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Ands<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> φ'_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">φ</span> <span class="keyword1">of</span> Neg <span class="bound">φ'</span> <span class="main">⇒</span> future_bounded <span class="main">(</span>convert_multiway <span class="bound">φ'</span><span class="main">)</span> <span class="main">=</span> future_bounded <span class="bound">φ'</span>
           <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> future_bounded <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> future_bounded <span class="skolem">φ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Ands<span class="main">(</span>1<span class="main">,</span>7<span class="main">)</span> assm
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits formula.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> assms<span class="main">:</span> <span class="main">(</span>Trigger_0 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"future_bounded <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> future_bounded <span class="skolem">φ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"safe_assignment <span class="main">(</span>fv <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_assignment_def<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"is_constraint <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">φ'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="skolem">φ</span> <span class="keyword1">of</span> Neg <span class="bound">φ'</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span> <span class="main">∧</span> future_bounded <span class="main">(</span>convert_multiway <span class="bound">φ'</span><span class="main">)</span> <span class="main">=</span> future_bounded <span class="bound">φ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> assms<span class="main">:</span> <span class="main">(</span>Release_0 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> release_safe_0_def always_safe_0_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MatchP <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atms_def regex.pred_set regex.set_map ball_Un
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> safe_regex_safe_formula<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> disjE_Not2<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MatchF <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atms_def regex.pred_set regex.set_map ball_Un
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> safe_regex_safe_formula<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> disjE_Not2<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list.pred_set<span class="main">)</span>

<span class="comment1">(* rewrite formulas *)</span>

<span class="keyword1"><span class="command">lemma</span></span> interval_unbounded_leq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> bounded <span class="free">I</span>"</span></span> <span class="comment1">(* [a, ∞] *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span>"</span></span> <span class="comment1">(* if j≤i is part of the interval, then so is k≤j≤i *)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">j</span> <span class="main">≥</span> τ <span class="free">σ</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">j</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memL <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> bounded_memR assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interval_unbounded_geq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> bounded <span class="free">I</span>"</span></span> <span class="comment1">(* [a, ∞] *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="comment1">(* if j≤i is part of the interval, then so is k≤j≤i *)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">j</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memL <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> bounded_memR assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> interval_0_bounded_geq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"bounded <span class="free">I</span>"</span></span> <span class="comment1">(* [0, a] *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span>"</span></span> <span class="comment1">(* if j≤i is part of the interval, then so is j≤k≤i *)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">j</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ineq<span class="main">:</span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">j</span> <span class="main">≥</span> τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer'</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memL <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ineq assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer'</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> historically_rewrite_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I1</span> <span class="main">::</span> <span class="quoted">ℐ</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>historically <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>historically_safe_0 <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I2</span> <span class="main">=</span> flip_int <span class="free">I1</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> hist<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>historically <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span><span class="main">≤</span><span class="free">i</span> <span class="main">∧</span> mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Max <span class="skolem">A</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> int_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded <span class="free">I1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="free">i</span><span class="main">.</span> mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> A_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> finite <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≤</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">assume</span></span> k_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">&lt;</span><span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">≤</span><span class="free">i</span>"</span></span> 
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> A_props k_props j_def A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms I2_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer'</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="skolem">j</span><span class="main">&lt;..</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="skolem">j</span><span class="main">&lt;..</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hist <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Since <span class="free">φ</span> <span class="skolem">I2</span> Formula.TT<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Since <span class="free">φ</span> <span class="skolem">I2</span> <span class="main">(</span>Formula.Next all <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> since_true int_bound I2_def flip_int_props
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> unbounded<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>bounded <span class="free">I1</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mem_leq_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">using</span></span> bounded_memR memL_mono
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Since <span class="free">φ</span> <span class="free">I1</span> <span class="main">(</span>Formula.And Formula.first <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mem_leq_j hist
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="free">i</span><span class="main">.</span> <span class="main">¬</span>mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mem_leq_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms I2_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer'</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Since <span class="free">φ</span> <span class="free">I1</span> <span class="main">(</span>Formula.And Formula.first <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mem_leq_j hist
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>historically_safe_0 <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> I2_def historically_safe_0_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I2</span> <span class="main">=</span> flip_int <span class="free">I1</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> hist<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>historically_safe_0 <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> int_bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded <span class="free">I1</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Since <span class="free">φ</span> <span class="skolem">I2</span> <span class="main">(</span>Formula.Next all <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Formula.Since <span class="free">φ</span> <span class="free">I1</span> <span class="main">(</span>Formula.And Formula.first <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> I2_def historically_safe_0_def hist
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Since <span class="free">φ</span> <span class="skolem">I2</span> <span class="main">(</span>Formula.Next all <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Since <span class="free">φ</span> <span class="free">I1</span> <span class="main">(</span>Formula.And Formula.first <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> since<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Since <span class="free">φ</span> <span class="skolem">I2</span> <span class="main">(</span>Formula.Next all <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="free">i</span><span class="main">.</span> mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">j</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
        <span class="keyword3"><span class="command">assume</span></span> k_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">≤</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">≤</span><span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">≥</span> τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_props I2_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer'</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> memR_antimono<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> int_bounded k_props I2_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer'</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">k</span><span class="main">≤</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_props j_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>historically <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Since <span class="free">φ</span> <span class="free">I1</span> <span class="main">(</span>Formula.And Formula.first <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>historically <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>historically <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>bounded <span class="free">I1</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Since <span class="free">φ</span> <span class="free">I1</span> <span class="main">(</span>Formula.And Formula.first <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> historically_safe_0_def hist
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>historically <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>historically <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> historically_rewrite_unbounded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> mem <span class="free">I1</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> bounded <span class="free">I1</span>"</span></span> <span class="comment1">(* [a, ∞] *)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>once <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>historically <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>historically_safe_unbounded <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I2</span> <span class="main">=</span> flip_int_less_lower <span class="free">I1</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> historically<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>once <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>historically <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span><span class="main">≤</span><span class="free">i</span> <span class="main">∧</span> mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="free">φ</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Max <span class="skolem">A</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> historically <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> A_props<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≤</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> k_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">≤</span><span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> j_props<span class="main">(</span>1-2<span class="main">)</span> interval_unbounded_leq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="free">I1</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> first_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="free">φ</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> j_props k_props historically assms<span class="main">(</span>1-2<span class="main">)</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> leq_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="skolem">j</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">≤</span><span class="free">i</span> <span class="main">∧</span> mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">k</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> Min <span class="skolem">B</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I2</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms I2_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer'</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> B_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_in_B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">≤</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">=</span><span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> k_props assms flip_int_less_lower_props<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I1</span></span> <span class="quoted"><span class="skolem">I2</span></span><span class="main">]</span> interval_0_bounded_geq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="skolem">I2</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">]</span> I2_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms j_props I2_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer'</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">&gt;</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B_def k_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">≥</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B_props k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> k_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_pre<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms flip_int_less_lower_mem I2_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> historically k_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_def k_pre k_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_def A_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">φ</span> all <span class="main">(</span>Formula.And <span class="free">φ</span> Formula.first<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> interval_all k_pos leq_j k_props
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">φ</span> all <span class="main">(</span>Formula.And <span class="free">φ</span> Formula.first<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>once <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> historically
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>historically_safe_unbounded <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms historically_safe_unbounded_def I2_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I2</span> <span class="main">=</span> flip_int_less_lower <span class="free">I1</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span><span class="main">≤</span><span class="free">i</span> <span class="main">∧</span> mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>historically_safe_unbounded <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>once <span class="skolem">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">φ</span> all <span class="main">(</span>Formula.And <span class="free">φ</span> Formula.first<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>once <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms historically_safe_unbounded_def I2_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>once <span class="skolem">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">φ</span> all <span class="main">(</span>Formula.And <span class="free">φ</span> Formula.first<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>once <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">φ</span> all <span class="main">(</span>Formula.And <span class="free">φ</span> Formula.first<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="free">i</span><span class="main">.</span> mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">φ</span> all <span class="main">(</span>Formula.And <span class="free">φ</span> Formula.first<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≤</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">φ</span> all <span class="main">(</span>Formula.And <span class="free">φ</span> Formula.first<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">φ</span> all <span class="main">(</span>Formula.And <span class="free">φ</span> Formula.first<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> j_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_pred_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>Formula.Since <span class="free">φ</span> all <span class="main">(</span>Formula.And <span class="free">φ</span> Formula.first<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> j_pos j_props
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Nitpick.case_nat_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> x_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">&gt;</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">x</span> <span class="main">≥</span> τ <span class="free">σ</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> j_props assms flip_int_less_lower_props<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I1</span></span> <span class="quoted"><span class="skolem">I2</span></span><span class="main">]</span> interval_0_bounded_geq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">I2</span></span><span class="main">]</span> I2_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms I2_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer'</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> x_greater<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">&gt;</span><span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> x_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">≤</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">&gt;</span><span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> x_props x_greater <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">x</span><span class="main">&gt;</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">≤</span><span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">≤</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">x</span><span class="main">≤</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">≤</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">x</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_pred_sat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>once <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>historically <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rewrite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> historically_rewrite_bounded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I1</span> <span class="main">::</span> <span class="quoted">ℐ</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I1</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"bounded <span class="free">I1</span>"</span></span> <span class="comment1">(* [a, b], a&gt;0 *)</span>
  <span class="comment1">(*
    [0, b-a] would be more efficient but this interval can
    (probably) not be constructed using the current
    implementation of intervals.
  *)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>once <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>historically <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>historically_safe_bounded <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>once <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>historically <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>historically_safe_bounded <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms historically_safe_bounded_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I2</span> <span class="main">=</span> int_remove_lower_bound <span class="free">I1</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>historically_safe_bounded <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>once <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>Formula.Neg <span class="main">(</span>once <span class="free">I1</span> <span class="main">(</span>Formula.And <span class="main">(</span>Formula.Or <span class="main">(</span>once <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Formula.Neg <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms I2_def historically_safe_bounded_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≤</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> j_leq_i_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="main">(</span>Formula.Neg <span class="main">(</span>once <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="main">(</span>Formula.Neg <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rewrite
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> k_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">≤</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="main">(</span>Formula.Neg <span class="main">(</span>once <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="main">(</span>Formula.Neg <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> j_leq_i_sat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="main">(</span>Formula.Neg <span class="main">(</span>once <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="main">(</span>Formula.Neg <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> leq_k_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="skolem">k</span><span class="main">.</span> mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> geq_k_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="skolem">k</span><span class="main">.</span> mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> j_int<span class="main">:</span> <span class="quoted"><span class="quoted">"memL <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> j_props assms<span class="main">(</span>1-2<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> k_int<span class="main">:</span> <span class="quoted"><span class="quoted">"memL <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> k_props assms<span class="main">(</span>1-2<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> k_geq_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">≥</span><span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> j_int k_int assms I2_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_le_mono int_remove_lower_bound.rep_eq le_eq_less_or_eq memR.rep_eq memR_antimono neq0_conv prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prod.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> zero_less_diff<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> j_int k_int assms I2_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> int_remove_lower_bound.rep_eq memL.rep_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> assms leq_k_sat j_props k_geq_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> k_less_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">k</span><span class="main">≥</span><span class="skolem">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> j_int k_int assms I2_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_le_mono int_remove_lower_bound.rep_eq le_eq_less_or_eq memR.rep_eq memR_antimono neq0_conv prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prod.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> zero_less_diff<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms I2_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> int_remove_lower_bound.rep_eq memL.rep_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> assms geq_k_sat j_props k_less_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>once <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>historically <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rewrite <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sat_trigger_rewrite_0_mem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">i</span> <span class="free">j</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> trigger<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Trigger <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">≤</span><span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mem_j<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">j</span> <span class="free">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">j</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">j</span><span class="main">&lt;..</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">j</span><span class="main">&lt;..</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">x</span> <span class="free">φ</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> Max <span class="skolem">A</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> A_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_in_A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">j</span><span class="main">&lt;..</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">l</span></span><span class="main">&gt;</span><span class="skolem">k</span><span class="main">.</span> <span class="bound">l</span> <span class="main">∉</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Max_ge<span class="main">[</span><span class="operator">OF</span> A_props<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> k_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mem mem_j k_props interval_geq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> k_props mem trigger <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sat_trigger_rewrite_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Trigger <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>trigger_safe_0 <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> trigger<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Trigger <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="main">(</span>Formula.And <span class="free">ψ</span> <span class="main">(</span>Formula.Neg <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="free">I</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>historically <span class="free">I</span> <span class="main">(</span>Formula.And <span class="free">ψ</span> <span class="main">(</span>Formula.Neg <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span><span class="main">≤</span> <span class="free">i</span> <span class="main">∧</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Max <span class="skolem">A</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="main">(</span>Formula.And <span class="free">ψ</span> <span class="main">(</span>Formula.Neg <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> j'_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j'</span> <span class="main">(</span>Formula.And <span class="free">ψ</span> <span class="main">(</span>Formula.Neg <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j'</span> <span class="free">ψ</span> <span class="main">∨</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j'</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j'</span> <span class="free">ψ</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j'</span><span class="main">&lt;..</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> j'_props assms trigger sat_trigger_rewrite_0_mem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">ψ</span></span> <span class="quoted"><span class="skolem">j'</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> A_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> finite <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≤</span> <span class="free">i</span> <span class="main">∧</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span><span class="main">&lt;..</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span><span class="main">&lt;..</span><span class="free">i</span><span class="main">}</span> <span class="main">∧</span> <span class="main">¬</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms j_props interval_geq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span><span class="main">&lt;..</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">x</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms trigger k_props sat_trigger_rewrite_0_mem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">ψ</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span><span class="main">&lt;..</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">x</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> Max <span class="skolem">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> A_def A_props
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
        <span class="keyword1"><span class="command">using</span></span> j_def k_props x_props
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span><span class="main">&lt;..</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="free">I</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>historically <span class="free">I</span> <span class="main">(</span>Formula.And <span class="free">ψ</span> <span class="main">(</span>Formula.Neg <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> j_props
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span><span class="main">≤</span> <span class="free">i</span> <span class="main">∧</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="free">φ</span><span class="main">}</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> Max <span class="skolem">B</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j'</span> <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> B_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B_def j'_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">≤</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">l</span></span><span class="main">&gt;</span><span class="skolem">k</span><span class="main">.</span> <span class="bound">l</span> <span class="main">∉</span> <span class="skolem">B</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Max_ge<span class="main">[</span><span class="operator">OF</span> B_props<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> k_def<span class="main">)</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
        <span class="keyword3"><span class="command">assume</span></span> l_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span><span class="main">&lt;..</span><span class="free">i</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms k_props interval_geq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">l</span> <span class="free">φ</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B_def l_props l_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">≤</span><span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">&gt;</span><span class="skolem">k</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> k_def l_props B_props<span class="main">(</span>2<span class="main">)</span> Max_ge<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">l</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> not_phi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span><span class="main">{</span><span class="skolem">k</span><span class="main">&lt;..</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">l</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_sat_psi<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_props trigger B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
        <span class="keyword3"><span class="command">assume</span></span> l_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">∈</span><span class="main">{</span><span class="skolem">k</span><span class="main">&lt;..</span><span class="free">i</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> k_props assms interval_geq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">l</span> <span class="free">ψ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> l_props trigger not_phi
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span><span class="main">{</span><span class="skolem">k</span><span class="main">&lt;..</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">l</span> <span class="free">ψ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> not_phi assms trigger
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="free">I</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> k_props k_sat_psi
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="free">I</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>historically <span class="free">I</span> <span class="main">(</span>Formula.And <span class="free">ψ</span> <span class="main">(</span>Formula.Neg <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="free">I</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>historically <span class="free">I</span> <span class="main">(</span>Formula.And <span class="free">ψ</span> <span class="main">(</span>Formula.Neg <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>trigger_safe_0 <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms historically_rewrite_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span>"</span></span><span class="main">]</span> trigger_safe_0_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>trigger_safe_0 <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="free">I</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>historically <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> trigger_safe_0_def assms historically_rewrite_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>historically <span class="free">I</span> <span class="main">(</span>Formula.And <span class="free">ψ</span> <span class="main">(</span>Formula.Neg <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Trigger <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> since_and_j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="free">I</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted">"<span class="skolem"><span class="skolem">j'</span></span>"</span> <span class="keyword2"><span class="keyword">where</span></span> j'_props<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">j'</span><span class="main">≤</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j'</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j'</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> j'_props since_and_j_props le
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> geq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">j'</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="skolem">j'</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> j'_props
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="skolem">j'</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> geq j'_props
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Trigger <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sat_trigger_rewrite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I1</span> <span class="free">I2</span> <span class="main">::</span> <span class="quoted">ℐ</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I1</span> <span class="main">0</span>"</span></span> <span class="comment1">(* [a, b] *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I2</span> <span class="main">=</span> flip_int_less_lower <span class="free">I1</span>"</span></span> <span class="comment1">(* [0, a-1] *)</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Trigger <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Or <span class="main">(</span>historically <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>once <span class="free">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>once <span class="free">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> trigger<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Trigger <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="free">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Or <span class="main">(</span>historically <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>once <span class="free">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>once <span class="free">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> all <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="free">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≤</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span><span class="main">{</span><span class="skolem">j</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> Max <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_props trigger <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> A_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> finite <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span><span class="main">{</span><span class="skolem">j</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> x_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">≥</span><span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> k_not_mem_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">x</span> <span class="main">≥</span> τ <span class="free">σ</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">x</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms j_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> memR_antimono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memL <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> x_props assms
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> flip_int_less_lower.rep_eq memL.rep_eq memR.rep_eq prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prod.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> k_not_mem_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> geq_j_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">≥</span><span class="skolem">j</span><span class="main">.</span> <span class="main">¬</span>mem <span class="free">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Or <span class="main">(</span>historically <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>once <span class="free">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>once <span class="free">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> k_props
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> k_not_mem_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> geq_j_mem k_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="free">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trigger k_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">l</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_def k_props l_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> A_props l_props k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_since<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> int_remove_lower_bound.rep_eq memL.rep_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">=</span><span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Or <span class="main">(</span>historically <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>once <span class="free">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>once <span class="free">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> k_sat sat_once<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">I2</span></span> <span class="quoted"><span class="free">φ</span></span><span class="main">]</span> assms k_mem
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">k</span><span class="main">=</span><span class="free">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_suc_leq_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">≤</span><span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> x_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span><span class="main">&lt;..</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">x</span> <span class="free">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">x</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trigger <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">x</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">x</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">l</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_def x_props k_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_def A_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> l_props x_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">x</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_greater_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="skolem">k</span><span class="main">&lt;..</span><span class="free">i</span><span class="main">}</span><span class="main">.</span> mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">x</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> k_suc_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="free">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> k_suc_leq_i k_since interval_all
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> k_suc_leq_i
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>once <span class="free">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="main">{</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span><span class="main">∈</span><span class="main">{</span><span class="skolem">k</span><span class="main">&lt;..</span><span class="free">i</span><span class="main">}</span> <span class="main">∧</span> mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">l</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">l</span> <span class="free">ψ</span><span class="main">}</span>"</span></span>
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> Max <span class="skolem">B</span>"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_suc_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> geq_j_mem k_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">x</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trigger k_suc_leq_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">x</span> <span class="free">φ</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">x</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_def k_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_props k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> x_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> B_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B_def k_suc_leq_i k_suc_mem k_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span><span class="main">∈</span><span class="main">{</span><span class="skolem">k</span><span class="main">&lt;..</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">c</span> <span class="free">ψ</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> B_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_cond<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">≤</span><span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_sat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
            <span class="keyword3"><span class="command">assume</span></span> x_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="main">{</span><span class="skolem">k</span><span class="main">&lt;..</span><span class="skolem">c</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">x</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lower<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">x</span> <span class="main">≥</span> τ <span class="free">σ</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> upper<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> k_mem memR_antimono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms c_props lower <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">x</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_greater_sat x_props c_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="skolem">k</span><span class="main">&lt;..</span><span class="skolem">c</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">x</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">c</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> k_mem c_props
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_is_0_eq diff_self_eq_0 greaterThanAtMost_iff int_remove_lower_bound.rep_eq interval_leq memL.rep_eq memR.rep_eq prod.sel<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> c_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">c</span> <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> k_cond
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span><span class="main">+</span><span class="main">1</span><span class="main">≤</span><span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c_def B_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">∉</span><span class="main">{</span><span class="skolem">k</span><span class="main">&lt;..</span><span class="free">i</span><span class="main">}</span> <span class="main">∨</span> <span class="main">¬</span>mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="skolem">c</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">∉</span><span class="main">{</span><span class="skolem">k</span><span class="main">&lt;..</span><span class="free">i</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> assms c_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">(</span><span class="skolem">c</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">∉</span><span class="main">{</span><span class="skolem">k</span><span class="main">&lt;..</span><span class="free">i</span><span class="main">}</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c_suc_leq_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">∈</span><span class="main">{</span><span class="skolem">k</span><span class="main">&lt;..</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="skolem">c</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> disj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">assume</span></span> c_suc_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="skolem">c</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> disj <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
                <span class="keyword1"><span class="command">using</span></span> k_greater_sat c_suc_leq_i c_suc_mem
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">assume</span></span> c_suc_not_mem_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">{</span></span>
                <span class="keyword3"><span class="command">assume</span></span> not_mem2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> upper<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memR <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> c_suc_not_mem_1 assms geq_j_mem k_cond k_props
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">c</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">c</span> <span class="main">≥</span> τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> diff_le_mono2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c_props assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> not_mem2 memR_antimono
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> upper <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">}</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">≤</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="skolem">c</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> c_suc_leq_i c_sat interval_all
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>once <span class="free">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> interval_all sat_once
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>once <span class="free">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>once <span class="free">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>once <span class="free">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Or <span class="main">(</span>historically <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>once <span class="free">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>once <span class="free">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Or <span class="main">(</span>historically <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>once <span class="free">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>once <span class="free">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Or <span class="main">(</span>historically <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>once <span class="free">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>once <span class="free">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Or <span class="main">(</span>historically <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>once <span class="free">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>once <span class="free">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Or <span class="main">(</span>historically <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>once <span class="free">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>once <span class="free">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>historically <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">∨</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>once <span class="free">I2</span> <span class="free">φ</span><span class="main">)</span> <span class="main">∨</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>once <span class="free">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>historically <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Trigger <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>once <span class="free">I2</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≤</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> x_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">≤</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> j_leq_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">≥</span><span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">x</span> <span class="main">≥</span> τ <span class="free">σ</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_leq_x j_props assms
          <span class="keyword1"><span class="command">using</span></span> flip_int_less_lower_props interval_0_bounded_geq memR_zero
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
          <span class="keyword1"><span class="command">using</span></span> x_props assms flip_int_less_lower.rep_eq memR.rep_eq memR_zero
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">x</span><span class="main">≥</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">&lt;</span><span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">≤</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">x</span><span class="main">&lt;</span><span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Trigger <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> since<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>once <span class="free">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≤</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> j_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">&gt;</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_pred_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> j_pos j_props
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Nitpick.case_nat_unfold<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">≤</span><span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">x</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="bound">x</span><span class="main">&lt;..</span><span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">≤</span><span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">x</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="skolem">x</span><span class="main">&lt;..</span><span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">ψ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
      <span class="keyword3"><span class="command">assume</span></span> l_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">≤</span><span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">&lt;</span><span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">l</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_props j_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> l_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">l</span><span class="main">&lt;</span><span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">≤</span><span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">≤</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">≤</span><span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">l</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_props l_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="skolem">l</span><span class="main">≤</span><span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l_geq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">≥</span><span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> j_pred_psi<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_pred_sat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> l_greater<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">&gt;</span><span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">l</span> <span class="main">≥</span> τ <span class="free">σ</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> assms j_props j_pos l_greater flip_int_less_lower_props interval_0_bounded_geq
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_pred le_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> memR_zero<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> assms flip_int_less_lower.rep_eq memR.rep_eq memR_zero
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> l_assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">=</span><span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l_geq le_eq_less_or_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">l</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_pred_psi <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">l</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">⟶</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">l</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">l</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">≤</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">x</span> <span class="free">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Trigger <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Trigger <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sat_trigger_rewrite_unbounded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I1</span> <span class="free">I2</span> <span class="main">::</span> <span class="quoted">ℐ</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I1</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>bounded <span class="free">I1</span>"</span></span> <span class="comment1">(* [a, b] *)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>once <span class="free">I1</span> Formula.TT<span class="main">)</span> <span class="main">(</span>Formula.Trigger <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>trigger_safe_unbounded <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I2</span> <span class="main">=</span> flip_int_less_lower <span class="free">I1</span>"</span></span> <span class="comment1">(* [0, a-1] *)</span>
  <span class="keyword3"><span class="command">assume</span></span> trigger<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>once <span class="free">I1</span> Formula.TT<span class="main">)</span> <span class="main">(</span>Formula.Trigger <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≤</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> disj<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Or <span class="main">(</span>historically <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> trigger assms I2_def sat_trigger_rewrite
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>once <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>historically_safe_unbounded <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">∨</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span> <span class="main">∨</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> disj assms historically_rewrite_unbounded<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I1</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">ψ</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>once <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> disj j_props
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>historically_safe_unbounded <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">∨</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span> <span class="main">∨</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>once <span class="free">I1</span> Formula.TT<span class="main">)</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Or <span class="main">(</span>historically_safe_unbounded <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> trigger
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>trigger_safe_unbounded <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> trigger_safe_unbounded_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">I1</span></span> <span class="quoted"><span class="free">ψ</span></span><span class="main">]</span> assms I2_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I2</span> <span class="main">=</span> flip_int_less_lower <span class="free">I1</span>"</span></span> <span class="comment1">(* [0, a-1] *)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>trigger_safe_unbounded <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>once <span class="free">I1</span> Formula.TT<span class="main">)</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Or <span class="main">(</span>historically_safe_unbounded <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms I2_def trigger_safe_unbounded_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Or <span class="main">(</span>historically <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms historically_rewrite_unbounded<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I1</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">ψ</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>once <span class="free">I1</span> Formula.TT<span class="main">)</span> <span class="main">(</span>Formula.Trigger <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms I2_def sat_trigger_rewrite assm
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sat_trigger_rewrite_bounded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I1</span> <span class="free">I2</span> <span class="main">::</span> <span class="quoted">ℐ</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I1</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"bounded <span class="free">I1</span>"</span></span> <span class="comment1">(* [a, b] *)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>once <span class="free">I1</span> Formula.TT<span class="main">)</span> <span class="main">(</span>Formula.Trigger <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>trigger_safe_bounded <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I2</span> <span class="main">=</span> flip_int_less_lower <span class="free">I1</span>"</span></span> <span class="comment1">(* [0, a-1] *)</span>
  <span class="keyword3"><span class="command">assume</span></span> trigger<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>once <span class="free">I1</span> Formula.TT<span class="main">)</span> <span class="main">(</span>Formula.Trigger <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≤</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> disj<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Or <span class="main">(</span>historically <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> trigger assms I2_def sat_trigger_rewrite
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>once <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>historically_safe_bounded <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">∨</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span> <span class="main">∨</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> disj assms historically_rewrite_bounded<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I1</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">ψ</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>once <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> disj j_props
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>historically_safe_bounded <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">∨</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span> <span class="main">∨</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>once <span class="free">I1</span> Formula.TT<span class="main">)</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Or <span class="main">(</span>historically_safe_bounded <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> trigger
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>trigger_safe_bounded <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> trigger_safe_bounded_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">I1</span></span> <span class="quoted"><span class="free">ψ</span></span><span class="main">]</span> assms I2_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I2</span> <span class="main">=</span> flip_int_less_lower <span class="free">I1</span>"</span></span> <span class="comment1">(* [0, a-1] *)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>trigger_safe_bounded <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>once <span class="free">I1</span> Formula.TT<span class="main">)</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Or <span class="main">(</span>historically_safe_bounded <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms I2_def trigger_safe_bounded_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Or <span class="main">(</span>historically <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>once <span class="skolem">I2</span> <span class="main">(</span>Formula.Prev all <span class="main">(</span>Formula.Since <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms historically_rewrite_bounded<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I1</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>once <span class="free">I1</span> Formula.TT<span class="main">)</span> <span class="main">(</span>Formula.Trigger <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms I2_def sat_trigger_rewrite assm
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sat_and_trigger_bounded_rewrite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bounded <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I</span> <span class="main">0</span>"</span></span> <span class="comment1">(* [a, b] *)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="main">(</span>Formula.Trigger <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>and_trigger_safe_bounded <span class="free">φ</span> <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> once<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>once <span class="free">I</span> TT<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Trigger <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span><span class="main">)</span> <span class="main">=</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>trigger_safe_bounded <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sat_trigger_rewrite_bounded<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"
    sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Or <span class="main">(</span>And <span class="free">φ</span> <span class="main">(</span>Neg <span class="main">(</span>once <span class="free">I</span> TT<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>And <span class="free">φ</span> <span class="main">(</span>trigger_safe_bounded <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>And <span class="free">φ</span> <span class="main">(</span>trigger_safe_bounded <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> once
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> and_trigger_safe_bounded_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> and_trigger_safe_bounded_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_and_trigger_unbounded_rewrite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>bounded <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I</span> <span class="main">0</span>"</span></span> <span class="comment1">(* [a, b] *)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="main">(</span>Formula.Trigger <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>and_trigger_safe_unbounded <span class="free">φ</span> <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> once<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>once <span class="free">I</span> TT<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Trigger <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span><span class="main">)</span> <span class="main">=</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>trigger_safe_unbounded <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sat_trigger_rewrite_unbounded<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"
    sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Or <span class="main">(</span>And <span class="free">φ</span> <span class="main">(</span>Neg <span class="main">(</span>once <span class="free">I</span> TT<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>And <span class="free">φ</span> <span class="main">(</span>trigger_safe_unbounded <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>And <span class="free">φ</span> <span class="main">(</span>trigger_safe_unbounded <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> once
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> and_trigger_safe_unbounded_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> and_trigger_safe_unbounded_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> always_rewrite_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I</span> <span class="main">::</span> <span class="quoted">ℐ</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"bounded <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>always <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>always_safe_0 <span class="free">I</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> all<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>always <span class="free">I</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span><span class="main">≥</span><span class="free">i</span> <span class="main">∧</span> mem <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Inf <span class="skolem">A</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> mem <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inf_nat_def1<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≥</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">assume</span></span> k_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">j</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ineq<span class="main">:</span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_le_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_def k_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≥</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_def cInf_lower <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> k_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> j_props ineq assms<span class="main">(</span>1<span class="main">)</span> flip_int_double_upper_leq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_props all <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> until_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">j</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> mem <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flip_int_double_upper.rep_eq memL.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Until <span class="free">φ</span> <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="main">(</span>Formula.Prev all <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> j_props until_j until_true<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">φ</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="bound">b</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> Inf <span class="skolem">B</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">≥</span><span class="free">i</span> <span class="main">∧</span> <span class="skolem">b</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> Inf <span class="skolem">C</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> empty_int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> <span class="main">¬</span> mem <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="comment1">(* [b+1, 2b] *)</span>
    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B_def bounded_memR <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inf_nat_def1<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memR <span class="free">I</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   
    <span class="keyword1"><span class="command">have</span></span> exists_db<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ex_le_τ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> τ <span class="free">σ</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inf_nat_def1<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span><span class="main">≥</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="skolem">c</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> b_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main">&gt;</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> c_props b_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c_ge_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span><span class="main">&gt;</span><span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c_props <span class="keyword1"><span class="command">using</span></span> le_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> memL_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">≥</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b_def cInf_lower <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C_def c_ge_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span><span class="main">-</span><span class="main">1</span> <span class="main">≥</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c_def cInf_lower <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> c_ge_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c_pred_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c_pred_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> all c_ge_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="main">(</span>flip_int <span class="free">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">c</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="comment1">(* [b+1, ∞] but attention, here 'b' = b+1 *)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">c</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> bounded_memR int_flip_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c_dist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">c</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b_props memR_antimono not_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">from</span></span> c_pred_mem <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b_props memR_antimono not_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b_ineq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≤</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">c</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">c</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">b</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> c_props c_dist
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="skolem">b</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">≥</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b_def cInf_lower <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> b_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I</span> <span class="main">(</span><span class="skolem">b</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span><span class="keyword1">(div)</span> <span class="bound">i</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="skolem">b</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span><span class="keyword1">(div)</span> <span class="bound">i</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">c</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b_ineq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">c</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flip_int_double_upper.rep_eq memR.rep_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memL <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">c</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> b_ineq b_props flip_int_double_upper.rep_eq memL.rep_eq memR_antimono
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> empty_int c_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>flip_int <span class="free">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">c</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c_pred_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="main">(</span>Formula.Next <span class="main">(</span>flip_int <span class="free">I</span><span class="main">)</span> Formula.TT<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c_pred_sat c_ge_i
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> τ_mono assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> atLeastLessThan_iff c_pred_mem diff_le_mono le_eq_less_or_eq memL_mono memR_antimono zero_le<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> all <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">≥</span><span class="free">i</span>"</span></span>
        <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="main">(</span>Formula.Next <span class="main">(</span>flip_int <span class="free">I</span><span class="main">)</span> Formula.TT<span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c_ge_i c_pred_mem c_pred_sat
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Until <span class="free">φ</span> <span class="free">I</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="main">(</span>Formula.Next <span class="main">(</span>flip_int <span class="free">I</span><span class="main">)</span> Formula.TT<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Until <span class="free">φ</span> <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="main">(</span>Formula.Prev all <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Formula.Until <span class="free">φ</span> <span class="free">I</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="main">(</span>Formula.Next <span class="main">(</span>flip_int <span class="free">I</span><span class="main">)</span> Formula.TT<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>always_safe_0 <span class="free">I</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> always_safe_0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>always_safe_0 <span class="free">I</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Until <span class="free">φ</span> <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="main">(</span>Formula.Prev all <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Formula.Until <span class="free">φ</span> <span class="free">I</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="main">(</span>Formula.Next <span class="main">(</span>flip_int <span class="free">I</span><span class="main">)</span> Formula.TT<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> always_safe_0_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Until <span class="free">φ</span> <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> Formula.TT<span class="main">)</span> <span class="main">∨</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Until <span class="free">φ</span> <span class="free">I</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="main">(</span>Formula.Next <span class="main">(</span>flip_int <span class="free">I</span><span class="main">)</span> Formula.TT<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Until <span class="free">φ</span> <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> Formula.TT<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≥</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">j</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">k</span><span class="main">&lt;</span><span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms flip_int_double_upper.rep_eq forall_finite<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> interval_leq leI memL.rep_eq prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>always <span class="free">I</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Until <span class="free">φ</span> <span class="free">I</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="main">(</span>Formula.Next <span class="main">(</span>flip_int <span class="free">I</span><span class="main">)</span> Formula.TT<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≥</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="main">(</span>Formula.Next <span class="main">(</span>flip_int <span class="free">I</span><span class="main">)</span> Formula.TT<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">j</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> phi_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="free">i</span><span class="main">..</span><span class="skolem">j</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">assume</span></span> k_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">&gt;</span><span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t_geq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> diff_le_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> j_props <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>flip_int <span class="free">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> τ_mono assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> diff_le_mono2 flip_int.rep_eq j_props<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> memL.rep_eq memL_mono prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms memL_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t_geq memR_antimono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> k_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&gt;</span><span class="skolem">j</span><span class="main">.</span> <span class="main">¬</span>mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>always <span class="free">I</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> phi_sat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>always <span class="free">I</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> always_rewrite_bounded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I1</span> <span class="main">::</span> <span class="quoted">ℐ</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bounded <span class="free">I1</span>"</span></span> <span class="comment1">(* [a, b] *)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>eventually <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>always <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>always_safe_bounded <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>eventually <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>always <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>always_safe_bounded <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms always_safe_bounded_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I2</span> <span class="main">=</span> int_remove_lower_bound <span class="free">I1</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>always_safe_bounded <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>eventually <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>Formula.Neg <span class="main">(</span>eventually <span class="free">I1</span> <span class="main">(</span>Formula.And <span class="main">(</span>Formula.Or <span class="main">(</span>once <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Formula.Neg <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms I2_def always_safe_bounded_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≥</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> j_geq_i_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="main">(</span>Formula.Neg <span class="main">(</span>once <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="main">(</span>Formula.Neg <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rewrite
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword3"><span class="command">assume</span></span> k_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">≥</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="main">(</span>Formula.Neg <span class="main">(</span>once <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="main">(</span>Formula.Neg <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> j_geq_i_sat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="main">(</span>Formula.Neg <span class="main">(</span>once <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="main">(</span>Formula.Neg <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> leq_k_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="skolem">k</span><span class="main">.</span> mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> geq_k_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="skolem">k</span><span class="main">.</span> mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> j_int<span class="main">:</span> <span class="quoted"><span class="quoted">"memL <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> j_props assms
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> k_int<span class="main">:</span> <span class="quoted"><span class="quoted">"memL <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> k_props assms
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> k_geq_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">≥</span><span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> j_int k_int assms I2_def interval_geq j_props<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> forall_finite<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> int_remove_lower_bound.rep_eq memL.rep_eq memR.rep_eq not_le_imp_less prod.sel<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> j_int k_int assms I2_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> int_remove_lower_bound.rep_eq memL.rep_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> assms leq_k_sat j_props k_geq_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> k_less_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">k</span><span class="main">≥</span><span class="skolem">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> j_int k_int assms I2_def j_props<span class="main">(</span>1<span class="main">)</span> k_props<span class="main">(</span>1<span class="main">)</span> interval_geq
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> forall_finite<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> int_remove_lower_bound.rep_eq memL.rep_eq memR.rep_eq not_le_imp_less prod.sel<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms I2_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> int_remove_lower_bound.rep_eq memL.rep_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> assms geq_k_sat j_props k_less_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟶</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>eventually <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>always <span class="free">I1</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rewrite
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sat_release_rewrite_0_mem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">i</span> <span class="free">j</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> trigger<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Release <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> geq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">≥</span><span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mem_j<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">j</span> <span class="free">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="free">j</span><span class="main">}</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">x</span> <span class="free">φ</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> Min <span class="skolem">A</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> A_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_in_A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">l</span></span><span class="main">&lt;</span><span class="skolem">k</span><span class="main">.</span> <span class="bound">l</span> <span class="main">∉</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Min_le<span class="main">[</span><span class="operator">OF</span> A_props<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> k_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mem mem_j k_props interval_leq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> k_props mem trigger <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sat_release_rewrite_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"bounded <span class="free">I</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Release <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>release_safe_0 <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> release<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Release <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟶</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="main">(</span>Formula.And <span class="free">ψ</span> <span class="main">(</span>Formula.Neg <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="free">I</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>always <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟶</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="main">(</span>Formula.And <span class="free">ψ</span> <span class="main">(</span>Formula.Neg <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> j'_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">≥</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j'</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j'</span> <span class="main">(</span>Formula.And <span class="free">ψ</span> <span class="main">(</span>Formula.Neg <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">j'</span><span class="main">}</span> <span class="main">∧</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Min <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> j'_props <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j'</span> <span class="free">ψ</span> <span class="main">∨</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j'</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j'</span> <span class="free">ψ</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">j'</span><span class="main">}</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> j'_props assms release sat_release_rewrite_0_mem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">ψ</span></span> <span class="quoted"><span class="skolem">j'</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> A_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> finite <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">j'</span><span class="main">}</span> <span class="main">∧</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">j</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">j</span><span class="main">}</span> <span class="main">∧</span> <span class="main">¬</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms j_props interval_leq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">x</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">x</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms release k_props sat_release_rewrite_0_mem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">ψ</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">x</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">x</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> Min <span class="skolem">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> A_def A_props k_props j_props
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
        <span class="keyword1"><span class="command">using</span></span> j_def k_props x_props
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">j</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="free">I</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>always <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> j_props
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="free">i</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span> <span class="main">∧</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="free">φ</span><span class="main">}</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> Min <span class="skolem">B</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j'</span> <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> B_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B_def j'_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">∈</span><span class="main">{</span><span class="free">i</span><span class="main">..</span><span class="skolem">j'</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">l</span></span><span class="main">&lt;</span><span class="skolem">k</span><span class="main">.</span> <span class="bound">l</span> <span class="main">∉</span> <span class="skolem">B</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Min_le<span class="main">[</span><span class="operator">OF</span> B_props<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> k_def<span class="main">)</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
        <span class="keyword3"><span class="command">assume</span></span> l_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">l</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms k_props interval_leq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">l</span> <span class="free">φ</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B_def l_props l_mem k_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">≥</span><span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">&lt;</span><span class="skolem">k</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> k_def l_props B_props<span class="main">(</span>2<span class="main">)</span> Min_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">l</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> not_phi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span><span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">l</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_sat_psi<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_props release B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
        <span class="keyword3"><span class="command">assume</span></span> l_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">∈</span><span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">l</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> k_props assms interval_leq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">l</span> <span class="free">ψ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> l_props release not_phi
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span><span class="main">∈</span><span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">l</span> <span class="free">ψ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> not_phi assms release
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="free">I</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> k_props k_sat_psi
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="free">I</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>always <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="free">I</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>always <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="free">I</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>always_safe_0 <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms always_rewrite_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>release_safe_0 <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms release_safe_0_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">ψ</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>release_safe_0 <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="free">I</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>always_safe_0 <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms release_safe_0_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">ψ</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="free">I</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>always <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms always_rewrite_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>always <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Release <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> until_and_j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="free">I</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted">"<span class="skolem"><span class="skolem">j'</span></span>"</span> <span class="keyword2"><span class="keyword">where</span></span> j'_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span><span class="main">≥</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j'</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j'</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="skolem">j'</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&gt;</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="skolem">j'</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j'_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> until_and_j_props ge <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="skolem">j</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">j'</span> <span class="main">&gt;</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="skolem">j'</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="skolem">j</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> j'_props
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="skolem">j'</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="skolem">j</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> leq j'_props
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="skolem">j</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="skolem">j</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Release <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sat_release_rewrite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">I1</span> <span class="free">I2</span> <span class="main">::</span> <span class="quoted">ℐ</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bounded <span class="free">I1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I1</span> <span class="main">0</span>"</span></span> <span class="comment1">(* [a, b] *)</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>eventually <span class="free">I1</span> Formula.TT<span class="main">)</span> <span class="main">(</span>Formula.Release <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>release_safe_bounded <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I2</span> <span class="main">=</span> flip_int_less_lower <span class="free">I1</span>"</span></span> <span class="comment1">(* [0, a-1] *)</span>
  <span class="keyword3"><span class="command">assume</span></span> release<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>eventually <span class="free">I1</span> Formula.TT<span class="main">)</span> <span class="main">(</span>Formula.Release <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟶</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="free">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> all<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>always <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≥</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> release <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>always_safe_bounded <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms always_rewrite_bounded<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I1</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">ψ</span></span><span class="main">]</span> all
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Or <span class="main">(</span>always_safe_bounded <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="main">(</span>Formula.Next all <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="free">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≥</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span><span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="skolem">j</span><span class="main">}</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> Min <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="skolem">j</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_props release <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> A_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span><span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="skolem">j</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> x_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">≤</span><span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">x</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> k_not_mem_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">x</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">x</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">x</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms j_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">x</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> memR_antimono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memL <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">x</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> k_not_mem_1 x_props assms I2_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> flip_int_less_lower.rep_eq memL.rep_eq memR.rep_eq prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prod.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">x</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> k_not_mem_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">x</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> geq_j_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">≤</span><span class="skolem">j</span><span class="main">.</span> <span class="main">¬</span>mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">x</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟶</span> mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">x</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Or <span class="main">(</span>always_safe_bounded <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="main">(</span>Formula.Next all <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> k_props
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> k_not_mem_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> geq_j_mem k_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="free">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="skolem">k</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> release k_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="skolem">k</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="skolem">k</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">l</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_def k_props l_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> A_props l_props k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_until<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms int_remove_lower_bound.rep_eq memL.rep_eq prod.sel<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">=</span><span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Or <span class="main">(</span>always_safe_bounded <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="main">(</span>Formula.Next all <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> k_sat sat_once<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">I2</span></span> <span class="quoted"><span class="free">φ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> assms k_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> k_neq_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">k</span><span class="main">=</span><span class="free">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_pred_geq_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">≥</span><span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> x_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">x</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">x</span> <span class="free">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="skolem">x</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> release <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="skolem">x</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">l</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_def x_props k_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≥</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_def A_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> l_props x_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">x</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_greater_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span><span class="main">.</span> mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">x</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟶</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">x</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> k_suc_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>Formula.Next all <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> k_pred_geq_i k_until interval_all k_neq_i
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="main">(</span>Formula.Next all <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> k_pred_geq_i
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="main">(</span>Formula.Next all <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="main">{</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span><span class="main">∈</span><span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span> <span class="main">∧</span> mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">l</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">l</span> <span class="free">ψ</span><span class="main">}</span>"</span></span>
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> Min <span class="skolem">B</span>"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_suc_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> geq_j_mem k_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">x</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> release k_pred_geq_i
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">x</span> <span class="free">φ</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">}</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">x</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_def k_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_props k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> x_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="skolem">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> B_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> finite <span class="skolem">B</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> B_def k_pred_geq_i k_suc_mem k_props k_neq_i
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span><span class="main">∈</span><span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">c</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">c</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_cond<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">≥</span><span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">k</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_sat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span><span class="main">=</span><span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> c_props assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span><span class="main">≠</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
            <span class="keyword3"><span class="command">assume</span></span> x_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="main">{</span><span class="skolem">c</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">x</span> <span class="main">≥</span> τ <span class="free">σ</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lower<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">x</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">c</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">x</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> upper<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">x</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">x</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> k_mem memR_antimono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">x</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms c_props lower <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">x</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_greater_sat x_props c_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span><span class="skolem">c</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">x</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> k_mem c_props
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeastLessThan_iff int_remove_lower_bound.rep_eq interval_geq less_or_eq_imp_le memL.rep_eq memR.rep_eq prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prod.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> c_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">c</span> <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assms k_cond
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">≥</span><span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c_def B_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span><span class="main">-</span><span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">∉</span><span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span> <span class="main">∨</span> <span class="main">¬</span>mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">∉</span><span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> assms c_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">∉</span><span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c_pred_geq_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">∈</span><span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> disj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">assume</span></span> c_suc_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> disj <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
                <span class="keyword1"><span class="command">using</span></span> k_greater_sat c_pred_geq_i c_suc_mem
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">assume</span></span> c_pred_not_mem_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">{</span></span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> upper<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> c_pred_not_mem_1 assms geq_j_mem k_cond k_props
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">c</span> <span class="main">≥</span> τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">c</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span> <span class="main">≥</span> τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> diff_le_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">c</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c_props assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> memR_antimono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> upper <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">}</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">≥</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="skolem">c</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>Formula.Next all <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> c_pred_geq_i c_sat interval_all c_pos
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="main">(</span>Formula.Next all <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> interval_all sat_eventually
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="main">(</span>Formula.Next all <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="main">(</span>Formula.Next all <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="main">(</span>Formula.Next all <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Or <span class="main">(</span>always_safe_bounded <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="main">(</span>Formula.Next all <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Or <span class="main">(</span>always_safe_bounded <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="main">(</span>Formula.Next all <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Or <span class="main">(</span>always_safe_bounded <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="main">(</span>Formula.Next all <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>eventually <span class="free">I1</span> Formula.TT<span class="main">)</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Or <span class="main">(</span>always_safe_bounded <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="main">(</span>Formula.Next all <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> release
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>release_safe_bounded <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms I2_def release_safe_bounded_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I2</span> <span class="main">=</span> flip_int_less_lower <span class="free">I1</span>"</span></span> <span class="comment1">(* [0, a-1] *)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>release_safe_bounded <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>eventually <span class="free">I1</span> Formula.TT<span class="main">)</span> <span class="main">(</span>Formula.Or <span class="main">(</span>Formula.Or <span class="main">(</span>always_safe_bounded <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="main">(</span>Formula.Next all <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms I2_def release_safe_bounded_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eventually<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>eventually <span class="free">I1</span> Formula.TT<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>always_safe_bounded <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">∨</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span> <span class="main">∨</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="main">(</span>Formula.Next all <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assm
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>always_safe_bounded <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>always <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms always_rewrite_bounded<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">I1</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">ψ</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Release <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≥</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> x_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">≥</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">x</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">≤</span><span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">x</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">x</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_props assms I2_def flip_int_less_lower_props
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> diff_le_mono memL_mono memR_antimono memR_zero zero_le<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> x_props assms I2_def
          <span class="keyword1"><span class="command">using</span></span> flip_int_less_lower.rep_eq memR.rep_eq memR_zero
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">x</span><span class="main">≤</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">&gt;</span><span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">x</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">x</span><span class="main">&gt;</span><span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Release <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> until<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>eventually <span class="skolem">I2</span> <span class="main">(</span>Formula.Next all <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">j</span> <span class="main">(</span>Formula.Next all <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≥</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">j</span> <span class="main">(</span>Formula.Next all <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_pred_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>Formula.Until <span class="free">ψ</span> <span class="main">(</span>int_remove_lower_bound <span class="free">I1</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">≥</span><span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">x</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">..&lt;</span><span class="bound">x</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">≥</span><span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">x</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
      <span class="keyword3"><span class="command">assume</span></span> l_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">≥</span><span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">&gt;</span><span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="skolem">l</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_props j_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> l_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="skolem">l</span><span class="main">&gt;</span><span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">l</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">≥</span><span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">≥</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">l</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">≥</span><span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">l</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_props l_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="skolem">l</span><span class="main">≥</span><span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l_geq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">≤</span><span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> j_suc_psi<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_pred_sat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">&lt;</span><span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">l</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">l</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms I2_def j_props flip_int_less_lower_props
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> diff_le_mono le0 memL_mono memR_antimono memR_zero<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">l</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> assms I2_def flip_int_less_lower.rep_eq memR.rep_eq memR_zero
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> l_assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span><span class="main">=</span><span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l_geq le_eq_less_or_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">l</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_suc_psi <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">l</span> <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">l</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟶</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="skolem">l</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="skolem">l</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I1</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">x</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟶</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">x</span> <span class="free">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="bound">x</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Release <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.Release <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="main">(</span>eventually <span class="free">I1</span> Formula.TT<span class="main">)</span> <span class="main">(</span>Formula.Release <span class="free">φ</span> <span class="free">I1</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assm
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sat_and_release_rewrite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bounded <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I</span> <span class="main">0</span>"</span></span> <span class="comment1">(* [a, b] *)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Formula.And <span class="free">φ</span> <span class="main">(</span>Formula.Release <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>and_release_safe_bounded <span class="free">φ</span> <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eventually<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>eventually <span class="free">I</span> TT<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Release <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span><span class="main">)</span> <span class="main">=</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>release_safe_bounded <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sat_release_rewrite<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">φ'</span></span> <span class="quoted"><span class="free">ψ'</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"
    sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Or <span class="main">(</span>And <span class="free">φ</span> <span class="main">(</span>Neg <span class="main">(</span>eventually <span class="free">I</span> TT<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>And <span class="free">φ</span> <span class="main">(</span>release_safe_bounded <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>And <span class="free">φ</span> <span class="main">(</span>release_safe_bounded <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eventually
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> and_release_safe_bounded_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> and_release_safe_bounded_def<span class="main">)</span>

<span class="comment1">(* end rewrite formulas *)</span>

<span class="keyword1"><span class="command">lemma</span></span> release_safe_0_future_bounded<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.future_bounded <span class="main">(</span>release_safe_0 <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>bounded <span class="free">I</span> <span class="main">∧</span> Formula.future_bounded <span class="free">ψ</span> <span class="main">∧</span> Formula.future_bounded <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> release_safe_0_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_convert_multiway<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span> <span class="main">⟹</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>convert_multiway <span class="free">φ</span><span class="main">)</span> <span class="main">⟷</span> sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> safe_formula_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_safe <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"And <span class="skolem">φ</span> <span class="skolem">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="var">?a</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?la</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"get_and_list <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lb</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"get_and_list <span class="main">(</span>convert_multiway <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sat</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> b_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">=</span> Ands <span class="main">(</span><span class="var">?la</span> <span class="main">@</span> <span class="var">?lb</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> And_safe <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="var">?sat</span> <span class="var">?la</span> <span class="main">⟷</span> <span class="var">?sat</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> And_safe sat_get_and <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="var">?sat</span> <span class="var">?lb</span> <span class="main">⟷</span> <span class="var">?sat</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> And_safe sat_get_and <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> And_safe <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list.pred_set<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_Not <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"And <span class="skolem">φ</span> <span class="main">(</span>Neg <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="var">?a</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?la</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"get_and_list <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lb</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="skolem">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sat</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> b_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">=</span> Ands <span class="main">(</span>Neg <span class="var">?lb</span> <span class="main">#</span> <span class="var">?la</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> And_Not <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="var">?sat</span> <span class="var">?la</span> <span class="main">⟷</span> <span class="var">?sat</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> And_Not sat_get_and <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> And_Not <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list.pred_set<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_Trigger <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Trigger <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> t_not_safe_assign<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>safe_assignment <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> safe_assignment_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> t_not_constraint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_constraint <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> get_and_list<span class="main">:</span> <span class="quoted"><span class="quoted">"get_and_list <span class="main">(</span>convert_multiway <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>convert_multiway <span class="skolem">t</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> t_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">t</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l_props<span class="main">:</span>
      <span class="quoted"><span class="quoted">"convert_multiway <span class="main">(</span>And <span class="skolem">φ</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> Ands <span class="skolem">l</span>"</span></span>
      <span class="quoted"><span class="quoted">"set <span class="skolem">l</span> <span class="main">=</span> set <span class="main">(</span>get_and_list <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>convert_multiway <span class="skolem">t</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t_not_safe_assign t_not_constraint get_and_list
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
    <span class="keyword1"><span class="command">have</span></span> t_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="main">(</span>convert_multiway <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> And_Trigger<span class="main">(</span>6-7<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> t_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">φ</span> <span class="main">∈</span> set <span class="skolem">l</span><span class="main">.</span> sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="main">(</span>And <span class="skolem">φ</span> <span class="main">(</span>Trigger <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span>Ands <span class="bound">l</span><span class="main">)</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> l'_props<span class="main">:</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="skolem">φ</span> <span class="main">=</span> Ands <span class="skolem">l'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"get_and_list <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">l'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">φ</span> <span class="main">∈</span> set <span class="skolem">l'</span><span class="main">.</span> sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> And_Trigger<span class="main">(</span>5<span class="main">)</span> l'_props
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> t_sat l_props<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> t_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"get_and_list <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>convert_multiway <span class="skolem">φ</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> And_Trigger<span class="main">(</span>5<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> t_sat l_props<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> t_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> l_props<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> t_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> And_Trigger t_not_safe_assign t_not_constraint
      <span class="keyword1"><span class="command">unfolding</span></span> t_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_Release <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> sat_and_release_rewrite<span class="main">[</span><span class="operator">OF</span> And_Release<span class="main"><span class="main">(</span></span>5-6<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfv_def fv_convert_multiway <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> conj_cong<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> assms<span class="main">:</span> <span class="main">(</span>Trigger_0 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">V</span> <span class="bound">v</span> <span class="bound">i</span><span class="main">.</span> sat <span class="free">σ</span> <span class="bound">V</span> <span class="bound">v</span> <span class="bound">i</span> <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span> <span class="main">⟷</span> sat <span class="free">σ</span> <span class="bound">V</span> <span class="bound">v</span> <span class="bound">i</span> <span class="skolem">φ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"safe_assignment <span class="main">(</span>fv <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_assignment_def<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"is_constraint <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">φ'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="skolem">φ</span> <span class="keyword1">of</span> Neg <span class="bound">φ'</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">V</span> <span class="bound">v</span> <span class="bound">i</span><span class="main">.</span> sat <span class="free">σ</span> <span class="bound">V</span> <span class="bound">v</span> <span class="bound">i</span> <span class="main">(</span>convert_multiway <span class="bound">φ'</span><span class="main">)</span> <span class="main">=</span> sat <span class="free">σ</span> <span class="bound">V</span> <span class="bound">v</span> <span class="bound">i</span> <span class="bound">φ'</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> assms<span class="main">:</span> <span class="main">(</span>Release_0 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> sat_release_rewrite_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MatchP <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Regex.match <span class="main">(</span>sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span>convert_multiway_regex <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> Regex.match <span class="main">(</span>sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> match_map_regex
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Regex.match_fv_cong<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> 0 5 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atms_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> disjE_Not2 <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> safe_regex_safe_formula<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MatchF <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Regex.match <span class="main">(</span>sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span>convert_multiway_regex <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> Regex.match <span class="main">(</span>sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> match_map_regex
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Regex.match_fv_cong<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> 0 5 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atms_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> disjE_Not2 <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> safe_regex_safe_formula<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let <span class="skolem">p</span> <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nfv_convert_multiway fun_upd_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ands <span class="skolem">l</span> <span class="skolem">pos</span> <span class="skolem">neg</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l_future_bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="main">(</span>convert_multiway <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">l</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span>
      <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">pos</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Ands<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> φ'_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">φ</span> <span class="keyword1">of</span> Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="main">∀</span><span class="bound">x</span> <span class="bound">xa</span> <span class="bound">xaa</span><span class="main">.</span> sat <span class="free">σ</span> <span class="bound">x</span> <span class="bound">xa</span> <span class="bound">xaa</span> <span class="main">(</span>convert_multiway <span class="bound">φ'</span><span class="main">)</span> <span class="main">=</span> sat <span class="free">σ</span> <span class="bound">x</span> <span class="bound">xa</span> <span class="bound">xaa</span> <span class="bound">φ'</span>
           <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">∀</span><span class="bound">x</span> <span class="bound">xa</span> <span class="bound">xaa</span><span class="main">.</span> sat <span class="free">σ</span> <span class="bound">x</span> <span class="bound">xa</span> <span class="bound">xaa</span> <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> sat <span class="free">σ</span> <span class="bound">x</span> <span class="bound">xa</span> <span class="bound">xaa</span> <span class="skolem">φ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Ands<span class="main">(</span>1<span class="main">,</span>7<span class="main">)</span> assm
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits formula.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> nat.case_cong<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(*context*)</span>

<span class="keyword1"><span class="command">interpretation</span></span> Formula_slicer<span class="main">:</span> abstract_slicer <span class="quoted"><span class="quoted">"relevant_events <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">φ</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sat_slice_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">⟷</span> Formula.sat <span class="main">(</span>Formula_slicer.slice <span class="free">φ</span> <span class="free">S</span> <span class="free">σ</span><span class="main">)</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sat_slice_strong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Neg_splits<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">φ</span> <span class="keyword1">of</span> formula.Neg <span class="bound">ψ</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">ψ</span> <span class="main">|</span> <span class="bound">φ</span> <span class="main">⇒</span> <span class="free">g</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span><span class="main">.</span> <span class="free">φ</span> <span class="main">=</span> formula.Neg <span class="bound">ψ</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="main">¬</span> Formula.is_Neg <span class="free">φ</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">P</span> <span class="main">(</span><span class="free">g</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">φ</span> <span class="keyword1">of</span> formula.Neg <span class="bound">ψ</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">ψ</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free">g</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">ψ</span><span class="main">.</span> <span class="free">φ</span> <span class="main">=</span> formula.Neg <span class="bound">ψ</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="main">¬</span> Formula.is_Neg <span class="free">φ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="free">g</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">φ</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Formula.is_Neg_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">map_formula</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Formula.formula <span class="main">⇒</span> Formula.formula<span class="main">)</span> <span class="main">⇒</span> Formula.formula <span class="main">⇒</span> Formula.formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.Pred <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.Pred <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.Let <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>
    Formula.Let <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.Less <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.Less <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.LessEq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.LessEq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.Neg <span class="main">(</span><span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.Or <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>
    Formula.Or <span class="main">(</span><span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>
    Formula.And <span class="main">(</span><span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.Ands <span class="free"><span class="bound"><span class="entity">φs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>
    Formula.Ands <span class="main">(</span>map <span class="main">(</span><span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.Exists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.Exists <span class="main">(</span><span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.Agg <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>
    Formula.Agg <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f'</span></span></span> <span class="main">(</span><span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.Since <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>
    Formula.Since <span class="main">(</span><span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span> <span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>
    Formula.Until <span class="main">(</span><span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.Trigger <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>
    Formula.Trigger <span class="main">(</span><span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.Release <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>
    Formula.Release <span class="main">(</span><span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.MatchF <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.MatchF <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_formula</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.MatchP <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Formula.MatchP <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_formula_fvi<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span> <span class="bound">φ</span><span class="main">.</span> Formula.fvi <span class="bound">b</span> <span class="main">(</span><span class="free">f</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> Formula.fvi <span class="bound">b</span> <span class="bound">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Formula.fvi <span class="free">b</span> <span class="main">(</span>map_formula <span class="free">f</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> Formula.fvi <span class="free">b</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms release_safe_0_def always_safe_0_def fvi.simps<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="comment1">(*lemma map_formula_safe:
  assumes "⋀b φ. Formula.fvi b (f φ) = Formula.fvi b φ"
  assumes "⋀φ. safe_formula (f φ) = safe_formula φ"
  assumes "⋀φ. ¬safe_formula φ ⟹ f φ = φ"
  shows "safe_formula (map_formula f φ) = safe_formula φ"
proof (induction φ rule: safe_formula.induct)
  case (6 p φ ψ)
  then show ?case by (auto simp add: map_formula_fvi[OF assms(1)] assms(2-3))
next
  case ("7_1" v va)
  then show ?case
    using map_formula_fvi[OF assms(1)] assms
    sorry

qed (auto simp add: map_formula_fvi[OF assms(1)] assms(2-3))*)</span>
 

<span class="keyword1"><span class="command">lemma</span></span> map_formula_sat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span> <span class="bound">φ</span><span class="main">.</span> Formula.fvi <span class="bound">b</span> <span class="main">(</span><span class="free">f</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> Formula.fvi <span class="bound">b</span> <span class="bound">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">V</span> <span class="bound">v</span> <span class="bound">i</span> <span class="bound">φ</span><span class="main">.</span> Formula.sat <span class="bound">σ</span> <span class="bound">V</span> <span class="bound">v</span> <span class="bound">i</span> <span class="main">(</span><span class="free">f</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> Formula.sat <span class="bound">σ</span> <span class="bound">V</span> <span class="bound">v</span> <span class="bound">i</span> <span class="bound">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span> <span class="bound">V</span> <span class="bound">v</span> <span class="bound">i</span><span class="main">.</span> Formula.sat <span class="bound">σ</span> <span class="bound">V</span> <span class="bound">v</span> <span class="bound">i</span> <span class="free">φ</span> <span class="main">=</span> Formula.sat <span class="bound">σ</span> <span class="bound">V</span> <span class="bound">v</span> <span class="bound">i</span> <span class="main">(</span>map_formula <span class="free">f</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> assm<span class="main">:</span> <span class="main">(</span>Let <span class="skolem">p</span> <span class="skolem">φ'</span> <span class="skolem">ψ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> nfv_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">φ</span><span class="main">.</span> Formula.nfv <span class="main">(</span>map_formula <span class="free">f</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> Formula.nfv <span class="bound">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Formula.nfv_def map_formula_fvi
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="skolem">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="main">(</span>formula.Let <span class="skolem">p</span> <span class="skolem">φ'</span> <span class="skolem">ψ'</span><span class="main">)</span> <span class="main">=</span> Formula.sat <span class="skolem">σ</span> <span class="main">(</span><span class="skolem">V</span><span class="main">(</span><span class="skolem">p</span> <span class="main">↦</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> length <span class="bound">v</span> <span class="main">=</span> Formula.nfv <span class="skolem">φ'</span> <span class="main">∧</span> Formula.sat <span class="skolem">σ</span> <span class="skolem">V</span> <span class="bound">v</span> <span class="bound">i</span> <span class="skolem">φ'</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="skolem">ψ'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="skolem">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="main">(</span>formula.Let <span class="skolem">p</span> <span class="skolem">φ'</span> <span class="skolem">ψ'</span><span class="main">)</span> <span class="main">=</span> Formula.sat <span class="skolem">σ</span> <span class="main">(</span><span class="skolem">V</span><span class="main">(</span><span class="skolem">p</span> <span class="main">↦</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> length <span class="bound">v</span> <span class="main">=</span> Formula.nfv <span class="skolem">φ'</span> <span class="main">∧</span> Formula.sat <span class="skolem">σ</span> <span class="skolem">V</span> <span class="bound">v</span> <span class="bound">i</span> <span class="skolem">φ'</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="main">(</span>map_formula <span class="free">f</span> <span class="skolem">ψ'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assm
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="skolem">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="main">(</span>formula.Let <span class="skolem">p</span> <span class="skolem">φ'</span> <span class="skolem">ψ'</span><span class="main">)</span> <span class="main">=</span> Formula.sat <span class="skolem">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="main">(</span>map_formula <span class="free">f</span> <span class="main">(</span>formula.Let <span class="skolem">p</span> <span class="skolem">φ'</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assm nfv_eq assms
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> assm<span class="main">:</span> <span class="main">(</span>Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f'</span> <span class="skolem">φ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> ecard <span class="bound">Zs</span><span class="main">)</span> <span class="main">|</span>
        <span class="bound">x</span> <span class="bound">Zs</span><span class="main">.</span> <span class="bound">Zs</span> <span class="main">=</span> <span class="main">{</span><span class="bound">zs</span><span class="main">.</span> length <span class="bound">zs</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">∧</span>
        Formula.sat <span class="skolem">σ</span> <span class="skolem">V</span> <span class="main">(</span><span class="bound">zs</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">φ'</span> <span class="main">∧</span>
        Formula.eval_trm <span class="main">(</span><span class="bound">zs</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">f'</span> <span class="main">=</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">Zs</span> <span class="main">≠</span> <span class="main">{}</span>
    <span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">M'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> ecard <span class="bound">Zs</span><span class="main">)</span> <span class="main">|</span>
        <span class="bound">x</span> <span class="bound">Zs</span><span class="main">.</span> <span class="bound">Zs</span> <span class="main">=</span> <span class="main">{</span><span class="bound">zs</span><span class="main">.</span> length <span class="bound">zs</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">∧</span>
        Formula.sat <span class="skolem">σ</span> <span class="skolem">V</span> <span class="main">(</span><span class="bound">zs</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>map_formula <span class="free">f</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="main">∧</span>
        Formula.eval_trm <span class="main">(</span><span class="bound">zs</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">f'</span> <span class="main">=</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">Zs</span> <span class="main">≠</span> <span class="main">{}</span>
    <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> M_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="skolem">M'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> M_def M'_def assm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> nfv_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">φ</span><span class="main">.</span> Formula.nfv <span class="main">(</span>map_formula <span class="free">f</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> Formula.nfv <span class="bound">φ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms Formula.nfv_def map_formula_fvi
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="skolem">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="main">(</span>formula.Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f'</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
      <span class="main">(</span><span class="skolem">M</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟶</span> fv <span class="skolem">φ'</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">v</span> <span class="main">!</span> <span class="skolem">y</span> <span class="main">=</span> eval_agg_op <span class="skolem">ω</span> <span class="skolem">M</span>
    <span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> M_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="skolem">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="main">(</span>formula.Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f'</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
      <span class="main">(</span><span class="skolem">M'</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟶</span> fv <span class="main">(</span>map_formula <span class="free">f</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">v</span> <span class="main">!</span> <span class="skolem">y</span> <span class="main">=</span> eval_agg_op <span class="skolem">ω</span> <span class="skolem">M'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms assm M_eq nfv_eq map_formula_fvi
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="skolem">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="main">(</span>formula.Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f'</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="main">=</span> Formula.sat <span class="skolem">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="main">(</span>formula.Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f'</span> <span class="main">(</span>map_formula <span class="free">f</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> M'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="skolem">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="main">(</span>formula.Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f'</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="main">=</span> Formula.sat <span class="skolem">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="main">(</span>map_formula <span class="free">f</span> <span class="main">(</span>formula.Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f'</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rewrite_trigger</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Formula.formula <span class="main">⇒</span> Formula.formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rewrite_trigger</span> <span class="main">(</span>Formula.And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>Formula.Trigger <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="main">(</span>mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span>
      <span class="comment1">― ‹the rewrite function already was applied recursively, hence the trigger should already be rewritten›</span>
      Formula.And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span> trigger_safe_0 <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">(</span>
      <span class="keyword1">if</span> <span class="main">(</span>bounded <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
        and_trigger_safe_bounded <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span>
      <span class="keyword1">else</span>
        and_trigger_safe_unbounded <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span>
    <span class="main">)</span>
  <span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rewrite_trigger</span> <span class="main">(</span>Formula.Trigger <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="main">(</span>mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span>
      trigger_safe_0 <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span>
    <span class="keyword1">else</span> <span class="main">(</span>
      Formula.Trigger <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span>
    <span class="main">)</span>
  <span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rewrite_trigger</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> historically_safe_0_fvi<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.fvi <span class="free">b</span> <span class="main">(</span>historically_safe_0 <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> Formula.fvi <span class="free">b</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> historically_safe_0_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> historically_safe_unbounded_fvi<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.fvi <span class="free">b</span> <span class="main">(</span>historically_safe_unbounded <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> Formula.fvi <span class="free">b</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> historically_safe_unbounded_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> historically_safe_bounded_fvi<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.fvi <span class="free">b</span> <span class="main">(</span>historically_safe_bounded <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> Formula.fvi <span class="free">b</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> historically_safe_bounded_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trigger_safe_0_fvi<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.fvi <span class="free">b</span> <span class="main">(</span>trigger_safe_0 <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> Formula.fvi <span class="free">b</span> <span class="free">φ</span> <span class="main">∪</span> Formula.fvi <span class="free">b</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trigger_safe_0_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trigger_safe_unbounded_fvi<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.fvi <span class="free">b</span> <span class="main">(</span>trigger_safe_unbounded <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> Formula.fvi <span class="free">b</span> <span class="free">φ</span> <span class="main">∪</span> Formula.fvi <span class="free">b</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trigger_safe_unbounded_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trigger_safe_bounded_fvi<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.fvi <span class="free">b</span> <span class="main">(</span>trigger_safe_bounded <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> Formula.fvi <span class="free">b</span> <span class="free">φ</span> <span class="main">∪</span> Formula.fvi <span class="free">b</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trigger_safe_bounded_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rewrite_trigger_fvi<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.fvi <span class="free">b</span> <span class="main">(</span>rewrite_trigger <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> Formula.fvi <span class="free">b</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rewrite_trigger <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Formula.And <span class="skolem">φ</span> <span class="main">(</span> trigger_safe_0 <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Trigger
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> And
        <span class="keyword1"><span class="command">using</span></span> Trigger
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> not_mem<span class="main">:</span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"bounded <span class="skolem">I</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rewrite_trigger <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> and_trigger_safe_bounded <span class="skolem">φ</span> <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> not_mem
          <span class="keyword1"><span class="command">unfolding</span></span> Trigger
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> And Trigger
          <span class="keyword1"><span class="command">unfolding</span></span> and_trigger_safe_bounded_def once_def trigger_safe_bounded_def eventually_def historically_safe_bounded_def Formula.TT_def Formula.FF_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rewrite_trigger <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> and_trigger_safe_unbounded <span class="skolem">φ</span> <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> not_mem
          <span class="keyword1"><span class="command">unfolding</span></span> Trigger
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> And Trigger
          <span class="keyword1"><span class="command">unfolding</span></span> and_trigger_safe_unbounded_def once_def trigger_safe_unbounded_def eventually_def historically_safe_unbounded_def Formula.TT_def Formula.FF_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"rewrite_trigger <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">=</span> trigger_safe_0 <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Trigger rewrite
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"rewrite_trigger <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">=</span> formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Trigger <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rewrite_trigger_sat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>rewrite_trigger <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rewrite_trigger <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Formula.And <span class="skolem">φ</span> <span class="main">(</span>trigger_safe_0 <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Trigger
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> And Trigger
        <span class="keyword1"><span class="command">using</span></span> sat_trigger_rewrite_0<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> not_mem<span class="main">:</span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"bounded <span class="skolem">I</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rewrite_trigger <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> and_trigger_safe_bounded <span class="skolem">φ</span> <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> not_mem
          <span class="keyword1"><span class="command">unfolding</span></span> Trigger
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> And Trigger
          <span class="keyword1"><span class="command">using</span></span> sat_and_trigger_bounded_rewrite<span class="main">[</span><span class="operator">OF</span> True not_mem<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rewrite_trigger <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> and_trigger_safe_unbounded <span class="skolem">φ</span> <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> not_mem
          <span class="keyword1"><span class="command">unfolding</span></span> Trigger
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> And Trigger
          <span class="keyword1"><span class="command">using</span></span> sat_and_trigger_unbounded_rewrite<span class="main">[</span><span class="operator">OF</span> False not_mem<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"rewrite_trigger <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">=</span> trigger_safe_0 <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Trigger rewrite
      <span class="keyword1"><span class="command">using</span></span> sat_trigger_rewrite_0<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"rewrite_trigger <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">=</span> formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Trigger <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> trigger_not_safe_assignment<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> safe_assignment <span class="main">(</span>fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>formula.Trigger <span class="free">α</span> <span class="free">I</span> <span class="free">β</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> safe_assignment_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> rewrite_trigger_safe_formula<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> safe<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="main">(</span>rewrite_trigger <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rewrite_trigger <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Formula.And <span class="skolem">φ</span> <span class="main">(</span>trigger_safe_0 <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Trigger
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"safe_formula_dual False safe_formula <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> safe True
        <span class="keyword1"><span class="command">unfolding</span></span> And Trigger
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_assignment_def safe_formula_dual_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="main">(</span>trigger_safe_0 <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> True
        <span class="keyword1"><span class="command">unfolding</span></span> safe_formula_dual_def trigger_safe_0_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> safe
        <span class="keyword1"><span class="command">unfolding</span></span> And rewrite
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> not_mem<span class="main">:</span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"bounded <span class="skolem">I</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rewrite_trigger <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> and_trigger_safe_bounded <span class="skolem">φ</span> <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> not_mem
          <span class="keyword1"><span class="command">unfolding</span></span> Trigger
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> safe trigger_not_safe_assignment
          <span class="keyword1"><span class="command">unfolding</span></span> And Trigger and_trigger_safe_bounded_def trigger_safe_bounded_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_formula_dual_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rewrite_trigger <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> and_trigger_safe_unbounded <span class="skolem">φ</span> <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> not_mem
          <span class="keyword1"><span class="command">unfolding</span></span> Trigger
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> safe trigger_not_safe_assignment
          <span class="keyword1"><span class="command">unfolding</span></span> And Trigger and_trigger_safe_unbounded_def trigger_safe_unbounded_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_formula_dual_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"rewrite_trigger <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">=</span> trigger_safe_0 <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> safe
      <span class="keyword1"><span class="command">unfolding</span></span> Trigger rewrite trigger_safe_0_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_formula_dual_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rewrite<span class="main">:</span> <span class="quoted"><span class="quoted">"rewrite_trigger <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">=</span> formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> safe
      <span class="keyword1"><span class="command">unfolding</span></span> Trigger
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</body>

</html>