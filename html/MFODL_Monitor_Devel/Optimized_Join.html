<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Optimized_Join</title>
</head>


<body>
<div class="head">
<h1>Theory Optimized_Join</h1>
</div>

<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Optimized_Join
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Generic_Join_Devel/Generic_Join_Correctness.html">Generic_Join_Devel.Generic_Join_Correctness</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Optimized relational join›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Binary join›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">join_mask</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat set <span class="main">⇒</span> bool list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">join_mask</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">proj_tuple</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool list <span class="main">⇒</span> <span class="tfree">'a</span> tuple <span class="main">⇒</span> <span class="tfree">'a</span> tuple"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">proj_tuple</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">proj_tuple</span> <span class="main">(</span>True <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free">proj_tuple</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">proj_tuple</span> <span class="main">(</span>False <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">=</span> None <span class="main">#</span> <span class="free">proj_tuple</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">proj_tuple</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">proj_tuple</span> <span class="main">[]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> proj_tuple_replicate<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> set <span class="free">bs</span> <span class="main">⟹</span> <span class="main">¬</span><span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> length <span class="free">bs</span> <span class="main">=</span> length <span class="free">as</span> <span class="main">⟹</span>
  proj_tuple <span class="free">bs</span> <span class="free">as</span> <span class="main">=</span> replicate <span class="main">(</span>length <span class="free">bs</span><span class="main">)</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> proj_tuple.induct<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> proj_tuple_join_mask_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">as</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟹</span>
  proj_tuple <span class="main">(</span>join_mask <span class="free">n</span> <span class="main">{}</span><span class="main">)</span> <span class="free">as</span> <span class="main">=</span> replicate <span class="free">n</span> None"</span></span>
  <span class="keyword1"><span class="command">using</span></span> proj_tuple_replicate<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"join_mask <span class="free">n</span> <span class="main">{}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_mask_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> proj_tuple_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"proj_tuple <span class="free">bs</span> <span class="free">as</span> <span class="main">=</span> map2 <span class="main">(</span><span class="main">λ</span><span class="bound">b</span> <span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="bound">a</span> <span class="keyword1">else</span> None<span class="main">)</span> <span class="free">bs</span> <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> proj_tuple.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map2_map<span class="main">:</span> <span class="quoted"><span class="quoted">"map2 <span class="free">f</span> <span class="main">(</span>map <span class="free">g</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">as</span><span class="main">]</span><span class="main">)</span> <span class="free">as</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">as</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">as</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> proj_tuple_join_mask_restrict<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">as</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟹</span>
  proj_tuple <span class="main">(</span>join_mask <span class="free">n</span> <span class="free">X</span><span class="main">)</span> <span class="free">as</span> <span class="main">=</span> restrict <span class="free">X</span> <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_def proj_tuple_alt join_mask_def map2_map<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_tuple_proj_idle<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">X</span> <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"proj_tuple <span class="main">(</span>join_mask <span class="free">n</span> <span class="free">X</span><span class="main">)</span> <span class="free">as</span> <span class="main">=</span> <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> proj_tuple_join_mask_restrict<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">X</span></span><span class="main">,</span> <span class="operator">unfolded</span> restrict_idle<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf<span class="main"><span class="main">]</span></span><span class="main">]</span> wf
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_tuple_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_tuple_change_base<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">X</span> <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> mask<span class="main">:</span> <span class="quoted"><span class="quoted">"join_mask <span class="free">n</span> <span class="free">X</span> <span class="main">=</span> join_mask <span class="free">n</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">Y</span> <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf mask <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_tuple_def join_mask_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">proj_tuple_in_join</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> bool list <span class="main">⇒</span> <span class="tfree">'a</span> tuple <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">proj_tuple_in_join</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="keyword1">then</span> proj_tuple <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> proj_tuple <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">join_cond</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">as</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="keyword1">then</span> <span class="bound">as</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> <span class="bound">as</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">join_filter_cond</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">as</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> join_cond <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">as</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> proj_tuple_in_join_mask_idle<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">X</span> <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"proj_tuple_in_join <span class="free">pos</span> <span class="main">(</span>join_mask <span class="free">n</span> <span class="free">X</span><span class="main">)</span> <span class="free">as</span> <span class="free">t</span> <span class="main">⟷</span> join_cond <span class="free">pos</span> <span class="free">t</span> <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf_tuple_proj_idle<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> proj_tuple_in_join_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> join_sub<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">⊆</span> <span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">L</span> <span class="free">t1</span>"</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">R</span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"join <span class="free">t2</span> <span class="free">pos</span> <span class="free">t1</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="free">t2</span><span class="main">.</span> proj_tuple_in_join <span class="free">pos</span> <span class="main">(</span>join_mask <span class="free">n</span> <span class="free">L</span><span class="main">)</span> <span class="bound">as</span> <span class="free">t1</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms proj_tuple_join_mask_restrict<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">L</span></span><span class="main">]</span> join_restrict<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t2</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">L</span></span> <span class="quoted"><span class="free">pos</span></span><span class="main">]</span>
    wf_tuple_length restrict_idle
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> table_def proj_tuple_in_join_def sup.absorb1<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> join_sub'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">⊆</span> <span class="free">L</span>"</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">L</span> <span class="free">t1</span>"</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">R</span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"join <span class="free">t2</span> True <span class="free">t1</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="free">t1</span><span class="main">.</span> proj_tuple_in_join True <span class="main">(</span>join_mask <span class="free">n</span> <span class="free">R</span><span class="main">)</span> <span class="bound">as</span> <span class="free">t2</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms proj_tuple_join_mask_restrict<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">R</span></span><span class="main">]</span> join_restrict<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t2</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">L</span></span> <span class="quoted">True</span><span class="main">]</span>
    wf_tuple_length restrict_idle
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> table_def proj_tuple_in_join_def sup.absorb1 Un_absorb1<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> join_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tab<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">R</span> <span class="free">t1</span>"</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">R</span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"join <span class="free">t2</span> <span class="free">pos</span> <span class="free">t1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">pos</span> <span class="keyword1">then</span> <span class="free">t2</span> <span class="main">∩</span> <span class="free">t1</span> <span class="keyword1">else</span> <span class="free">t2</span> <span class="main">-</span> <span class="free">t1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> join_sub<span class="main">[</span><span class="operator">OF</span> _ tab<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">pos</span></span><span class="main">]</span> tab<span class="main">(</span>2<span class="main">)</span> proj_tuple_in_join_mask_idle<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">R</span></span> <span class="main">_</span> <span class="quoted"><span class="free">pos</span></span> <span class="quoted"><span class="free">t1</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> table_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> join_no_cols<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tab<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="main">{}</span> <span class="free">t1</span>"</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">R</span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"join <span class="free">t2</span> <span class="free">pos</span> <span class="free">t1</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free">pos</span> <span class="main">⟷</span> replicate <span class="free">n</span> None <span class="main">∈</span> <span class="free">t1</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free">t2</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> join_sub<span class="main">[</span><span class="operator">OF</span> _ tab<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">pos</span></span><span class="main">]</span> tab<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> table_def proj_tuple_in_join_def wf_tuple_length proj_tuple_join_mask_empty<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> join_empty_left<span class="main">:</span> <span class="quoted"><span class="quoted">"join <span class="main">{}</span> <span class="free">pos</span> <span class="free">t</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> join_empty_right<span class="main">:</span> <span class="quoted"><span class="quoted">"join <span class="free">t</span> <span class="free">pos</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">pos</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bin_join</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat set <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> bool <span class="main">⇒</span> nat set <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> <span class="tfree">'a</span> table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bin_join</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">{}</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="main">⟷</span> replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> None <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">then</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">.</span> proj_tuple_in_join <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="main">(</span>join_mask <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span><span class="main">)</span> <span class="bound">as</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">}</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="keyword1">then</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">.</span> proj_tuple_in_join <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="main">(</span>join_mask <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="bound">as</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">}</span>
    <span class="keyword1">else</span> join <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bin_join_table<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tab<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A'</span> <span class="free">t'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bin_join <span class="free">n</span> <span class="free">A</span> <span class="free">t</span> <span class="free">pos</span> <span class="free">A'</span> <span class="free">t'</span> <span class="main">=</span> join <span class="free">t</span> <span class="free">pos</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms join_empty_left<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">pos</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">]</span> join_empty_right<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">pos</span></span><span class="main">]</span>
    join_no_cols<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">t'</span></span> <span class="quoted"><span class="free">pos</span></span><span class="main">]</span> join_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">pos</span></span><span class="main">]</span> join_sub<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    join_sub'<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Multi-way join›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mmulti_join'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat set list <span class="main">⇒</span> nat set list <span class="main">⇒</span> <span class="tfree">'a</span> table list <span class="main">⇒</span> <span class="tfree">'a</span> table<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mmulti_join'</span> <span class="free"><span class="bound"><span class="entity">A_pos</span></span></span> <span class="free"><span class="bound"><span class="entity">A_neg</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">Q</span> <span class="main">=</span> set <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">A_pos</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">Q_neg</span> <span class="main">=</span> set <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">A_neg</span></span></span> <span class="main">(</span>drop <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">A_pos</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
    New_max_getIJ_wrapperGenericJoin <span class="bound">Q</span> <span class="bound">Q_neg</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mmulti_join'_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A_pos</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> table <span class="free">n</span> <span class="bound">A</span> <span class="bound">X</span> <span class="main">∧</span> wf_set <span class="free">n</span> <span class="bound">A</span><span class="main">)</span> <span class="main">(</span><span class="free">A_pos</span> <span class="main">@</span> <span class="free">A_neg</span><span class="main">)</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> mmulti_join' <span class="free">A_pos</span> <span class="free">A_neg</span> <span class="free">L</span> <span class="main">⟷</span> wf_tuple <span class="free">n</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">A</span><span class="main">∈</span>set <span class="free">A_pos</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span> <span class="free">z</span> <span class="main">∧</span>
    list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="free">A_pos</span> <span class="main">(</span>take <span class="main">(</span>length <span class="free">A_pos</span><span class="main">)</span> <span class="free">L</span><span class="main">)</span> <span class="main">∧</span>
    list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span> <span class="free">A_neg</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="free">A_pos</span><span class="main">)</span> <span class="free">L</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">=</span> set <span class="main">(</span>zip <span class="free">A_pos</span> <span class="free">L</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> Q_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">=</span> set <span class="main">(</span>zip <span class="free">A_pos</span> <span class="main">(</span>take <span class="main">(</span>length <span class="free">A_pos</span><span class="main">)</span> <span class="free">L</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Q_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_zip<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Q_neg</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q_neg</span> <span class="main">=</span> set <span class="main">(</span>zip <span class="free">A_neg</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="free">A_pos</span><span class="main">)</span> <span class="free">L</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mmulti_join' <span class="free">A_pos</span> <span class="free">A_neg</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">=</span> New_max_getIJ_wrapperGenericJoin <span class="skolem">Q</span> <span class="skolem">Q_neg</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Q_def Q_neg_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> New_max.wrapperGenericJoin.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">Q</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Q_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc_le_eq card_gt_0_iff zip_eq_Nil_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="skolem">Q</span> <span class="main">∪</span> <span class="skolem">Q_neg</span><span class="main">)</span><span class="main">.</span> table <span class="free">n</span> <span class="bound">A</span> <span class="bound">X</span> <span class="main">∧</span> wf_set <span class="free">n</span> <span class="bound">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Q_alt Q_neg_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zip_append1 list_all2_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> <span class="var">?r</span> <span class="main">⟷</span> wf_tuple <span class="free">n</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Q</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span> <span class="free">z</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Q_neg</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> New_max.wrapper_correctness case_prod_beta' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">A</span><span class="main">∈</span>set <span class="free">A_pos</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Q</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">A_pos</span> <span class="main">≤</span> length <span class="free">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Q_alt
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> in_set_impl_in_set_zip1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> ys<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="free">A_pos</span><span class="main">)</span> <span class="free">L</span>"</span></span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_zip_leftD<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">⟷</span>
    list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="free">A_pos</span> <span class="main">(</span>take <span class="main">(</span>length <span class="free">A_pos</span><span class="main">)</span> <span class="free">L</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Q_alt <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Q_neg</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span> <span class="main">⟷</span>
    list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span> <span class="free">A_neg</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="free">A_pos</span><span class="main">)</span> <span class="free">L</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Q_neg_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Q_def Q_neg_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> restrict_nested <span class="main">=</span> New_max.restrict_nested

<span class="keyword1"><span class="command">lemma</span></span> list_all2_opt_True<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> table <span class="free">n</span> <span class="bound">A</span> <span class="bound">X</span> <span class="main">∧</span> wf_set <span class="free">n</span> <span class="bound">A</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">A_zs</span> <span class="main">@</span> <span class="free">A_x</span> <span class="main">#</span> <span class="free">A_xs</span> <span class="main">@</span> <span class="free">A_y</span> <span class="main">#</span> <span class="free">A_ys</span><span class="main">)</span> <span class="main">@</span> <span class="free">A_neg</span><span class="main">)</span>
    <span class="main">(</span><span class="main">(</span><span class="free">zs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">@</span> <span class="free">L_neg</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">A_xs</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">A_ys</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">A_zs</span> <span class="main">=</span> length <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> table <span class="free">n</span> <span class="bound">A</span> <span class="bound">X</span> <span class="main">∧</span> wf_set <span class="free">n</span> <span class="bound">A</span><span class="main">)</span>
    <span class="main">(</span><span class="main">(</span><span class="free">A_zs</span> <span class="main">@</span> <span class="main">(</span><span class="free">A_x</span> <span class="main">∪</span> <span class="free">A_y</span><span class="main">)</span> <span class="main">#</span> <span class="free">A_xs</span> <span class="main">@</span> <span class="free">A_ys</span><span class="main">)</span> <span class="main">@</span> <span class="free">A_neg</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">zs</span> <span class="main">@</span> join <span class="free">x</span> True <span class="free">y</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">@</span> <span class="free">L_neg</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> assms_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A_x</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A_y</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="free">A_x</span>"</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="free">A_y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mmulti_join'.simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_append1 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tabs<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="main">(</span><span class="free">A_x</span> <span class="main">∪</span> <span class="free">A_y</span><span class="main">)</span> <span class="main">(</span>join <span class="free">x</span> True <span class="free">y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="main">(</span><span class="free">A_x</span> <span class="main">∪</span> <span class="free">A_y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> join_table<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">A_x</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">A_y</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted">True</span> <span class="quoted"><span class="quoted">"<span class="free">A_x</span> <span class="main">∪</span> <span class="free">A_y</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> assms_dest<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> assms_dest<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> table <span class="free">n</span> <span class="bound">A</span> <span class="bound">X</span> <span class="main">∧</span> wf_set <span class="free">n</span> <span class="bound">A</span><span class="main">)</span>
    <span class="main">(</span><span class="main">(</span><span class="free">A_zs</span> <span class="main">@</span> <span class="main">(</span><span class="free">A_x</span> <span class="main">∪</span> <span class="free">A_y</span><span class="main">)</span> <span class="main">#</span> <span class="free">A_xs</span> <span class="main">@</span> <span class="free">A_ys</span><span class="main">)</span> <span class="main">@</span> <span class="free">A_neg</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">zs</span> <span class="main">@</span> join <span class="free">x</span> True <span class="free">y</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">@</span> <span class="free">L_neg</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mmulti_join'.simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_append1 list_all2_append2
        list_all2_Cons1 list_all2_Cons2 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mmulti_join'_opt_True<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> table <span class="free">n</span> <span class="bound">A</span> <span class="bound">X</span> <span class="main">∧</span> wf_set <span class="free">n</span> <span class="bound">A</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">A_zs</span> <span class="main">@</span> <span class="free">A_x</span> <span class="main">#</span> <span class="free">A_xs</span> <span class="main">@</span> <span class="free">A_y</span> <span class="main">#</span> <span class="free">A_ys</span><span class="main">)</span> <span class="main">@</span> <span class="free">A_neg</span><span class="main">)</span>
    <span class="main">(</span><span class="main">(</span><span class="free">zs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">@</span> <span class="free">L_neg</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">A_xs</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">A_ys</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">A_zs</span> <span class="main">=</span> length <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mmulti_join' <span class="main">(</span><span class="free">A_zs</span> <span class="main">@</span> <span class="free">A_x</span> <span class="main">#</span> <span class="free">A_xs</span> <span class="main">@</span> <span class="free">A_y</span> <span class="main">#</span> <span class="free">A_ys</span><span class="main">)</span> <span class="free">A_neg</span> <span class="main">(</span><span class="main">(</span><span class="free">zs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">@</span> <span class="free">L_neg</span><span class="main">)</span> <span class="main">=</span>
    mmulti_join' <span class="main">(</span><span class="free">A_zs</span> <span class="main">@</span> <span class="main">(</span><span class="free">A_x</span> <span class="main">∪</span> <span class="free">A_y</span><span class="main">)</span> <span class="main">#</span> <span class="free">A_xs</span> <span class="main">@</span> <span class="free">A_ys</span><span class="main">)</span> <span class="free">A_neg</span>
    <span class="main">(</span><span class="main">(</span><span class="free">zs</span> <span class="main">@</span> join <span class="free">x</span> True <span class="free">y</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">@</span> <span class="free">L_neg</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> assms_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A_x</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A_y</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="free">A_x</span>"</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="free">A_y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mmulti_join'.simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_append1 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tabs<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="main">(</span><span class="free">A_x</span> <span class="main">∪</span> <span class="free">A_y</span><span class="main">)</span> <span class="main">(</span>join <span class="free">x</span> True <span class="free">y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="main">(</span><span class="free">A_x</span> <span class="main">∪</span> <span class="free">A_y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> join_table<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">A_x</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">A_y</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted">True</span> <span class="quoted"><span class="quoted">"<span class="free">A_x</span> <span class="main">∪</span> <span class="free">A_y</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> assms_dest<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> assms_dest<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_set_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> list_all2'<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> table <span class="free">n</span> <span class="bound">A</span> <span class="bound">X</span> <span class="main">∧</span> wf_set <span class="free">n</span> <span class="bound">A</span><span class="main">)</span>
    <span class="main">(</span><span class="main">(</span><span class="free">A_zs</span> <span class="main">@</span> <span class="main">(</span><span class="free">A_x</span> <span class="main">∪</span> <span class="free">A_y</span><span class="main">)</span> <span class="main">#</span> <span class="free">A_xs</span> <span class="main">@</span> <span class="free">A_ys</span><span class="main">)</span> <span class="main">@</span> <span class="free">A_neg</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">zs</span> <span class="main">@</span> join <span class="free">x</span> True <span class="free">y</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">@</span> <span class="free">L_neg</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mmulti_join'.simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_append1 list_all2_append2
        list_all2_Cons1 list_all2_Cons2 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span> <span class="bound">Z</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="bound">Z</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="free">A_x</span> <span class="main">∪</span> <span class="free">A_y</span> <span class="main">⊆</span> <span class="bound">Z</span> <span class="main">⟹</span>
    restrict <span class="main">(</span><span class="free">A_x</span> <span class="main">∪</span> <span class="free">A_y</span><span class="main">)</span> <span class="bound">z</span> <span class="main">∈</span> join <span class="free">x</span> True <span class="free">y</span> <span class="main">⟷</span> restrict <span class="free">A_x</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free">x</span> <span class="main">∧</span> restrict <span class="free">A_y</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> join_restrict<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">A_x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">A_y</span></span> <span class="quoted">True</span><span class="main">]</span> wf_tuple_restrict_simple<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="free">A_x</span> <span class="main">∪</span> <span class="free">A_y</span>"</span></span><span class="main">]</span>
      assms_dest<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> table_def restrict_nested Int_absorb2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> mmulti_join' <span class="main">(</span><span class="free">A_zs</span> <span class="main">@</span> <span class="free">A_x</span> <span class="main">#</span> <span class="free">A_xs</span> <span class="main">@</span> <span class="free">A_y</span> <span class="main">#</span> <span class="free">A_ys</span><span class="main">)</span> <span class="free">A_neg</span>
      <span class="main">(</span><span class="main">(</span><span class="free">zs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">@</span> <span class="free">L_neg</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> z_in_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span><span class="free">A_zs</span> <span class="main">@</span> <span class="free">A_x</span> <span class="main">#</span> <span class="free">A_xs</span> <span class="main">@</span> <span class="free">A_y</span> <span class="main">#</span> <span class="free">A_ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
      <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="main">(∈)</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="free">A_zs</span> <span class="free">zs</span>"</span></span>
      <span class="quoted"><span class="quoted">"restrict <span class="free">A_x</span> <span class="skolem">z</span> <span class="main">∈</span> <span class="free">x</span>"</span></span>
      <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="main">(∈)</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="free">A_ys</span> <span class="free">ys</span>"</span></span>
      <span class="quoted"><span class="quoted">"restrict <span class="free">A_y</span> <span class="skolem">z</span> <span class="main">∈</span> <span class="free">y</span>"</span></span>
      <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="main">(∈)</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="free">A_xs</span> <span class="free">xs</span>"</span></span>
      <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="main">(∉)</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="free">A_neg</span> <span class="free">L_neg</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mmulti_join'_correct<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mmulti_join'.simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms list_all2_append1
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> mmulti_join' <span class="main">(</span><span class="free">A_zs</span> <span class="main">@</span> <span class="main">(</span><span class="free">A_x</span> <span class="main">∪</span> <span class="free">A_y</span><span class="main">)</span> <span class="main">#</span> <span class="free">A_xs</span> <span class="main">@</span> <span class="free">A_ys</span><span class="main">)</span> <span class="free">A_neg</span>
      <span class="main">(</span><span class="main">(</span><span class="free">zs</span> <span class="main">@</span> join <span class="free">x</span> True <span class="free">y</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">@</span> <span class="free">L_neg</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mmulti_join'_correct<span class="main">[</span><span class="operator">OF</span> _ list_all2'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span> res<span class="main">[</span><span class="operator">OF</span> z_in_dest<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms list_all2_appendI le_supI2 Un_assoc <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mmulti_join'.simps
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> mmulti_join' <span class="main">(</span><span class="free">A_zs</span> <span class="main">@</span> <span class="main">(</span><span class="free">A_x</span> <span class="main">∪</span> <span class="free">A_y</span><span class="main">)</span> <span class="main">#</span> <span class="free">A_xs</span> <span class="main">@</span> <span class="free">A_ys</span><span class="main">)</span> <span class="free">A_neg</span>
      <span class="main">(</span><span class="main">(</span><span class="free">zs</span> <span class="main">@</span> join <span class="free">x</span> True <span class="free">y</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">@</span> <span class="free">L_neg</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> z_in_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span><span class="free">A_zs</span> <span class="main">@</span> <span class="free">A_x</span> <span class="main">#</span> <span class="free">A_xs</span> <span class="main">@</span> <span class="free">A_y</span> <span class="main">#</span> <span class="free">A_ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
      <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="main">(∈)</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="free">A_zs</span> <span class="free">zs</span>"</span></span>
      <span class="quoted"><span class="quoted">"restrict <span class="main">(</span><span class="free">A_x</span> <span class="main">∪</span> <span class="free">A_y</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">∈</span> join <span class="free">x</span> True <span class="free">y</span>"</span></span>
      <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="main">(∈)</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="free">A_ys</span> <span class="free">ys</span>"</span></span>
      <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="main">(∈)</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="free">A_xs</span> <span class="free">xs</span>"</span></span>
      <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="main">(∉)</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="free">A_neg</span> <span class="free">L_neg</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mmulti_join'_correct<span class="main">[</span><span class="operator">OF</span> _ list_all2'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mmulti_join'.simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms list_all2_append Un_assoc
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> mmulti_join' <span class="main">(</span><span class="free">A_zs</span> <span class="main">@</span> <span class="free">A_x</span> <span class="main">#</span> <span class="free">A_xs</span> <span class="main">@</span> <span class="free">A_y</span> <span class="main">#</span> <span class="free">A_ys</span><span class="main">)</span> <span class="free">A_neg</span>
      <span class="main">(</span><span class="main">(</span><span class="free">zs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="main">@</span> <span class="free">L_neg</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mmulti_join'_correct<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span> res<span class="main">[</span><span class="operator">OF</span> z_in_dest<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms list_all2_appendI le_supI2 Un_assoc <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mmulti_join'.simps
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_all2_opt_False<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> table <span class="free">n</span> <span class="bound">A</span> <span class="bound">X</span> <span class="main">∧</span> wf_set <span class="free">n</span> <span class="bound">A</span><span class="main">)</span>
    <span class="main">(</span><span class="main">(</span><span class="free">A_zs</span> <span class="main">@</span> <span class="free">A_x</span> <span class="main">#</span> <span class="free">A_xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">A_ws</span> <span class="main">@</span> <span class="free">A_y</span> <span class="main">#</span> <span class="free">A_ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">zs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">ws</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">A_ws</span> <span class="main">=</span> length <span class="free">ws</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">A_xs</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">A_ys</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">A_zs</span> <span class="main">=</span> length <span class="free">zs</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">A_y</span> <span class="main">⊆</span> <span class="free">A_x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> table <span class="free">n</span> <span class="bound">A</span> <span class="bound">X</span> <span class="main">∧</span> wf_set <span class="free">n</span> <span class="bound">A</span><span class="main">)</span>
    <span class="main">(</span><span class="main">(</span><span class="free">A_zs</span> <span class="main">@</span> <span class="free">A_x</span> <span class="main">#</span> <span class="free">A_xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">A_ws</span> <span class="main">@</span> <span class="free">A_ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">zs</span> <span class="main">@</span> join <span class="free">x</span> False <span class="free">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">ws</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> assms_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A_x</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A_y</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="free">A_x</span>"</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="free">A_y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mmulti_join'.simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_append <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> tabs<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A_x</span> <span class="main">(</span>join <span class="free">x</span> False <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> join_table<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">A_x</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">A_y</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted">False</span> <span class="quoted"><span class="free">A_x</span></span><span class="main">,</span> <span class="operator">OF</span> assms_dest<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> table <span class="free">n</span> <span class="bound">A</span> <span class="bound">X</span> <span class="main">∧</span> wf_set <span class="free">n</span> <span class="bound">A</span><span class="main">)</span>
    <span class="main">(</span><span class="main">(</span><span class="free">A_zs</span> <span class="main">@</span> <span class="free">A_x</span> <span class="main">#</span> <span class="free">A_xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">A_ws</span> <span class="main">@</span> <span class="free">A_ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">zs</span> <span class="main">@</span> join <span class="free">x</span> False <span class="free">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">ws</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms assms_dest<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mmulti_join'.simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_append1 list_all2_append2
        list_all2_Cons1 list_all2_Cons2 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mmulti_join'_opt_False<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> table <span class="free">n</span> <span class="bound">A</span> <span class="bound">X</span> <span class="main">∧</span> wf_set <span class="free">n</span> <span class="bound">A</span><span class="main">)</span>
    <span class="main">(</span><span class="main">(</span><span class="free">A_zs</span> <span class="main">@</span> <span class="free">A_x</span> <span class="main">#</span> <span class="free">A_xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">A_ws</span> <span class="main">@</span> <span class="free">A_y</span> <span class="main">#</span> <span class="free">A_ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">zs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">ws</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">A_ws</span> <span class="main">=</span> length <span class="free">ws</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">A_xs</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">A_ys</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">A_zs</span> <span class="main">=</span> length <span class="free">zs</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">A_y</span> <span class="main">⊆</span> <span class="free">A_x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mmulti_join' <span class="main">(</span><span class="free">A_zs</span> <span class="main">@</span> <span class="free">A_x</span> <span class="main">#</span> <span class="free">A_xs</span><span class="main">)</span> <span class="main">(</span><span class="free">A_ws</span> <span class="main">@</span> <span class="free">A_y</span> <span class="main">#</span> <span class="free">A_ys</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">zs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">ws</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    mmulti_join' <span class="main">(</span><span class="free">A_zs</span> <span class="main">@</span> <span class="free">A_x</span> <span class="main">#</span> <span class="free">A_xs</span><span class="main">)</span> <span class="main">(</span><span class="free">A_ws</span> <span class="main">@</span> <span class="free">A_ys</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">zs</span> <span class="main">@</span> join <span class="free">x</span> False <span class="free">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">ws</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> assms_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A_x</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A_y</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="free">A_x</span>"</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="free">A_y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mmulti_join'.simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_append <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> tabs<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A_x</span> <span class="main">(</span>join <span class="free">x</span> False <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> join_table<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">A_x</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">A_y</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted">False</span> <span class="quoted"><span class="free">A_x</span></span><span class="main">,</span> <span class="operator">OF</span> assms_dest<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> list_all2'<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> table <span class="free">n</span> <span class="bound">A</span> <span class="bound">X</span> <span class="main">∧</span> wf_set <span class="free">n</span> <span class="bound">A</span><span class="main">)</span>
    <span class="main">(</span><span class="main">(</span><span class="free">A_zs</span> <span class="main">@</span> <span class="free">A_x</span> <span class="main">#</span> <span class="free">A_xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">A_ws</span> <span class="main">@</span> <span class="free">A_ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">zs</span> <span class="main">@</span> join <span class="free">x</span> False <span class="free">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="free">ws</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms assms_dest<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mmulti_join'.simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_append1 list_all2_append2
        list_all2_Cons1 list_all2_Cons2 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> restrict <span class="free">A_x</span> <span class="bound">z</span> <span class="main">∈</span> join <span class="free">x</span> False <span class="free">y</span> <span class="main">⟷</span> restrict <span class="free">A_x</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free">x</span> <span class="main">∧</span> restrict <span class="free">A_y</span> <span class="bound">z</span> <span class="main">∉</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> join_restrict<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">A_x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">A_y</span></span> <span class="quoted">False</span><span class="main">,</span> <span class="operator">OF</span> _ _ assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">]</span> assms_dest<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> assms<span class="main">(</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> table_def restrict_nested Int_absorb2 Un_absorb2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> mmulti_join' <span class="main">(</span><span class="free">A_zs</span> <span class="main">@</span> <span class="free">A_x</span> <span class="main">#</span> <span class="free">A_xs</span><span class="main">)</span> <span class="main">(</span><span class="free">A_ws</span> <span class="main">@</span> <span class="free">A_y</span> <span class="main">#</span> <span class="free">A_ys</span><span class="main">)</span>
      <span class="main">(</span><span class="main">(</span><span class="free">zs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="free">ws</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> z_in_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span><span class="free">A_zs</span> <span class="main">@</span> <span class="free">A_x</span> <span class="main">#</span> <span class="free">A_xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
      <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="main">(∈)</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="free">A_zs</span> <span class="free">zs</span>"</span></span>
      <span class="quoted"><span class="quoted">"restrict <span class="free">A_x</span> <span class="skolem">z</span> <span class="main">∈</span> <span class="free">x</span>"</span></span>
      <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="main">(∈)</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="free">A_xs</span> <span class="free">xs</span>"</span></span>
      <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="main">(∉)</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="free">A_ws</span> <span class="free">ws</span>"</span></span>
      <span class="quoted"><span class="quoted">"restrict <span class="free">A_y</span> <span class="skolem">z</span> <span class="main">∉</span> <span class="free">y</span>"</span></span>
      <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="main">(∉)</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="free">A_ys</span> <span class="free">ys</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mmulti_join'_correct<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mmulti_join'.simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms list_all2_append1
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> mmulti_join' <span class="main">(</span><span class="free">A_zs</span> <span class="main">@</span> <span class="free">A_x</span> <span class="main">#</span> <span class="free">A_xs</span><span class="main">)</span> <span class="main">(</span><span class="free">A_ws</span> <span class="main">@</span> <span class="free">A_ys</span><span class="main">)</span>
      <span class="main">(</span><span class="main">(</span><span class="free">zs</span> <span class="main">@</span> join <span class="free">x</span> False <span class="free">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="free">ws</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mmulti_join'_correct<span class="main">[</span><span class="operator">OF</span> _ list_all2'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span> res
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms list_all2_appendI Un_assoc <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mmulti_join'.simps
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> mmulti_join' <span class="main">(</span><span class="free">A_zs</span> <span class="main">@</span> <span class="free">A_x</span> <span class="main">#</span> <span class="free">A_xs</span><span class="main">)</span> <span class="main">(</span><span class="free">A_ws</span> <span class="main">@</span> <span class="free">A_ys</span><span class="main">)</span>
      <span class="main">(</span><span class="main">(</span><span class="free">zs</span> <span class="main">@</span> join <span class="free">x</span> False <span class="free">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="free">ws</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> z_in_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span><span class="free">A_zs</span> <span class="main">@</span> <span class="free">A_x</span> <span class="main">#</span> <span class="free">A_xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
      <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="main">(∈)</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="free">A_zs</span> <span class="free">zs</span>"</span></span>
      <span class="quoted"><span class="quoted">"restrict <span class="free">A_x</span> <span class="skolem">z</span> <span class="main">∈</span> join <span class="free">x</span> False <span class="free">y</span>"</span></span>
      <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="main">(∈)</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="free">A_xs</span> <span class="free">xs</span>"</span></span>
      <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="main">(∉)</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="free">A_ws</span> <span class="free">ws</span>"</span></span>
      <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="main">(∉)</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">z</span><span class="main">)</span><span class="main">)</span> <span class="free">A_ys</span> <span class="free">ys</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mmulti_join'_correct<span class="main">[</span><span class="operator">OF</span> _ list_all2'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mmulti_join'.simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms list_all2_append1
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> mmulti_join' <span class="main">(</span><span class="free">A_zs</span> <span class="main">@</span> <span class="free">A_x</span> <span class="main">#</span> <span class="free">A_xs</span><span class="main">)</span> <span class="main">(</span><span class="free">A_ws</span> <span class="main">@</span> <span class="free">A_y</span> <span class="main">#</span> <span class="free">A_ys</span><span class="main">)</span>
      <span class="main">(</span><span class="main">(</span><span class="free">zs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="free">ws</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mmulti_join'_correct<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span> res
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms list_all2_appendI Un_assoc <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mmulti_join'.simps
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">find_sub_in</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set list <span class="main">⇒</span> bool <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'a</span> set list <span class="main">×</span> <span class="tfree">'a</span> set <span class="main">×</span> <span class="tfree">'a</span> set list<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_sub_in</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_sub_in</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">find_sub_in</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">z</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="bound">ys</span><span class="main">,</span> <span class="bound">z</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> find_sub_in_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"find_sub_in <span class="free">X</span> <span class="free">xs</span> <span class="free">b</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">z</span><span class="main">,</span> <span class="free">zs</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">z</span> <span class="main">#</span> <span class="free">zs</span> <span class="main">∧</span> <span class="main">(</span><span class="free">z</span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">∨</span> <span class="main">(</span><span class="free">b</span> <span class="main">∧</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_sub_in.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">find_sub_True</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set list <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'a</span> set list <span class="main">×</span> <span class="tfree">'a</span> set <span class="main">×</span> <span class="tfree">'a</span> set list <span class="main">×</span> <span class="tfree">'a</span> set <span class="main">×</span> <span class="tfree">'a</span> set list<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_sub_True</span> <span class="main">[]</span> <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_sub_True</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> find_sub_in <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> True <span class="keyword1">of</span> None <span class="main">⇒</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free">find_sub_True</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> None
    <span class="main">|</span> Some <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">w</span><span class="main">,</span> <span class="bound">ws</span><span class="main">,</span> <span class="bound">z</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="bound">ys</span><span class="main">,</span> <span class="bound">w</span><span class="main">,</span> <span class="bound">ws</span><span class="main">,</span> <span class="bound">z</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Some <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">z</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="bound">ys</span><span class="main">,</span> <span class="bound">z</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> find_sub_True_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"find_sub_True <span class="free">xs</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">w</span><span class="main">,</span> <span class="free">ws</span><span class="main">,</span> <span class="free">z</span><span class="main">,</span> <span class="free">zs</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">w</span> <span class="main">#</span> <span class="free">ws</span> <span class="main">@</span> <span class="free">z</span> <span class="main">#</span> <span class="free">zs</span> <span class="main">∧</span> <span class="main">(</span><span class="free">z</span> <span class="main">⊆</span> <span class="free">w</span> <span class="main">∨</span> <span class="free">w</span> <span class="main">⊆</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> find_sub_in_sound
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">ws</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_sub_True.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">find_sub_False</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set list <span class="main">⇒</span> <span class="tfree">'a</span> set list <span class="main">⇒</span>
  <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> set list <span class="main">×</span> <span class="tfree">'a</span> set <span class="main">×</span> <span class="tfree">'a</span> set list<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> set list <span class="main">×</span> <span class="tfree">'a</span> set <span class="main">×</span> <span class="tfree">'a</span> set list<span class="main">)</span><span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_sub_False</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_sub_False</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> find_sub_in <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> False <span class="keyword1">of</span> None <span class="main">⇒</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free">find_sub_False</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> None
    <span class="main">|</span> Some <span class="main">(</span><span class="main">(</span><span class="bound">rs</span><span class="main">,</span> <span class="bound">w</span><span class="main">,</span> <span class="bound">ws</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">z</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="bound">rs</span><span class="main">,</span> <span class="bound">w</span><span class="main">,</span> <span class="bound">ws</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">z</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Some <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">z</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">z</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> find_sub_False_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"find_sub_False <span class="free">xs</span> <span class="free">ns</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span><span class="free">rs</span><span class="main">,</span> <span class="free">w</span><span class="main">,</span> <span class="free">ws</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">z</span><span class="main">,</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">xs</span> <span class="main">=</span> <span class="free">rs</span> <span class="main">@</span> <span class="free">w</span> <span class="main">#</span> <span class="free">ws</span> <span class="main">∧</span> <span class="free">ns</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">z</span> <span class="main">#</span> <span class="free">zs</span> <span class="main">∧</span> <span class="main">(</span><span class="free">z</span> <span class="main">⊆</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> find_sub_in_sound
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ns</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">rs</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">ws</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_sub_False.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">proj_list_3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> list <span class="main">×</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'b</span> list<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">proj_list_3</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>take <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">,</span>
    take <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">zs</span></span></span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> proj_list_3_same<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"proj_list_3 <span class="free">xs</span> <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">z</span><span class="main">,</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ys'</span><span class="main">,</span> <span class="free">z'</span><span class="main">,</span> <span class="free">zs'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> length <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys'</span> <span class="main">@</span> <span class="free">z'</span> <span class="main">#</span> <span class="free">zs'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_take_nth_drop<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> proj_list_3_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"proj_list_3 <span class="free">xs</span> <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">z</span><span class="main">,</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ys'</span><span class="main">,</span> <span class="free">z'</span><span class="main">,</span> <span class="free">zs'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> length <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> length <span class="free">ys'</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">zs</span> <span class="main">=</span> length <span class="free">zs'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">proj_list_5</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'b</span> list <span class="main">×</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'b</span> list <span class="main">×</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'b</span> list<span class="main">)</span> <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">proj_list_5</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">zs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>take <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">,</span>
    take <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> length <span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">)</span><span class="main">,</span>
    drop <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> length <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> proj_list_5_same<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"proj_list_5 <span class="free">xs</span> <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">w</span><span class="main">,</span> <span class="free">ws</span><span class="main">,</span> <span class="free">z</span><span class="main">,</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ys'</span><span class="main">,</span> <span class="free">w'</span><span class="main">,</span> <span class="free">ws'</span><span class="main">,</span> <span class="free">z'</span><span class="main">,</span> <span class="free">zs'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> length <span class="free">ws</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> length <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys'</span> <span class="main">@</span> <span class="free">w'</span> <span class="main">#</span> <span class="free">ws'</span> <span class="main">@</span> <span class="free">z'</span> <span class="main">#</span> <span class="free">zs'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> length <span class="free">ys</span> <span class="main">#</span> take <span class="main">(</span>length <span class="free">ws</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="main">(</span>length <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="main">(</span>length <span class="free">ws</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="free">ys</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq nth_Cons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="main">(</span>length <span class="free">ws</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="free">ys</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> drop <span class="main">(</span>Suc <span class="main">(</span>length <span class="free">ys</span> <span class="main">+</span> length <span class="free">ws</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span>
      drop <span class="main">(</span>length <span class="free">ys</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Suc_eq_plus1 add.assoc<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> add.commute<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"length <span class="free">ws</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span>
      drop_drop<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="free">ws</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span> append_take_drop_id <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Cons_nth_drop_Suc append_Cons<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> proj_list_5_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"proj_list_5 <span class="free">xs</span> <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">w</span><span class="main">,</span> <span class="free">ws</span><span class="main">,</span> <span class="free">z</span><span class="main">,</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ys'</span><span class="main">,</span> <span class="free">w'</span><span class="main">,</span> <span class="free">ws'</span><span class="main">,</span> <span class="free">z'</span><span class="main">,</span> <span class="free">zs'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> length <span class="free">ws</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> length <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> length <span class="free">ys'</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ws</span> <span class="main">=</span> length <span class="free">ws'</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">zs</span> <span class="main">=</span> length <span class="free">zs'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">dominate_True</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set list <span class="main">⇒</span> <span class="tfree">'a</span> table list <span class="main">⇒</span>
  <span class="main">(</span><span class="main">(</span>nat set list <span class="main">×</span> nat set <span class="main">×</span> nat set list <span class="main">×</span> nat set <span class="main">×</span> nat set list<span class="main">)</span> <span class="main">×</span>
  <span class="main">(</span><span class="tfree">'a</span> table list <span class="main">×</span> <span class="tfree">'a</span> table <span class="main">×</span> <span class="tfree">'a</span> table list <span class="main">×</span> <span class="tfree">'a</span> table <span class="main">×</span> <span class="tfree">'a</span> table list<span class="main">)</span><span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dominate_True</span> <span class="free"><span class="bound"><span class="entity">A_pos</span></span></span> <span class="free"><span class="bound"><span class="entity">L_pos</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> find_sub_True <span class="free"><span class="bound"><span class="entity">A_pos</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> None
  <span class="main">|</span> Some <span class="bound">split</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">split</span><span class="main">,</span> proj_list_5 <span class="free"><span class="bound"><span class="entity">L_pos</span></span></span> <span class="bound">split</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> find_sub_True_proj_list_5_same<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"find_sub_True <span class="free">xs</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">w</span><span class="main">,</span> <span class="free">ws</span><span class="main">,</span> <span class="free">z</span><span class="main">,</span> <span class="free">zs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">xs'</span>"</span></span>
    <span class="quoted"><span class="quoted">"proj_list_5 <span class="free">xs'</span> <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">w</span><span class="main">,</span> <span class="free">ws</span><span class="main">,</span> <span class="free">z</span><span class="main">,</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ys'</span><span class="main">,</span> <span class="free">w'</span><span class="main">,</span> <span class="free">ws'</span><span class="main">,</span> <span class="free">z'</span><span class="main">,</span> <span class="free">zs'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs'</span> <span class="main">=</span> <span class="free">ys'</span> <span class="main">@</span> <span class="free">w'</span> <span class="main">#</span> <span class="free">ws'</span> <span class="main">@</span> <span class="free">z'</span> <span class="main">#</span> <span class="free">zs'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs'</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> length <span class="free">ws</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> length <span class="free">zs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> find_sub_True_sound<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> proj_list_5_same<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> len<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> find_sub_True_proj_list_5_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"find_sub_True <span class="free">xs</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">w</span><span class="main">,</span> <span class="free">ws</span><span class="main">,</span> <span class="free">z</span><span class="main">,</span> <span class="free">zs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">xs'</span>"</span></span>
    <span class="quoted"><span class="quoted">"proj_list_5 <span class="free">xs'</span> <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">w</span><span class="main">,</span> <span class="free">ws</span><span class="main">,</span> <span class="free">z</span><span class="main">,</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ys'</span><span class="main">,</span> <span class="free">w'</span><span class="main">,</span> <span class="free">ws'</span><span class="main">,</span> <span class="free">z'</span><span class="main">,</span> <span class="free">zs'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> length <span class="free">ys'</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ws</span> <span class="main">=</span> length <span class="free">ws'</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">zs</span> <span class="main">=</span> length <span class="free">zs'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> find_sub_True_sound<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> proj_list_5_length<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>3<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> dominate_True_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dominate_True <span class="free">A_pos</span> <span class="free">L_pos</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span><span class="free">A_zs</span><span class="main">,</span> <span class="free">A_x</span><span class="main">,</span> <span class="free">A_xs</span><span class="main">,</span> <span class="free">A_y</span><span class="main">,</span> <span class="free">A_ys</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">zs</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="free">y</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">A_pos</span> <span class="main">=</span> length <span class="free">L_pos</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A_pos</span> <span class="main">=</span> <span class="free">A_zs</span> <span class="main">@</span> <span class="free">A_x</span> <span class="main">#</span> <span class="free">A_xs</span> <span class="main">@</span> <span class="free">A_y</span> <span class="main">#</span> <span class="free">A_ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">L_pos</span> <span class="main">=</span> <span class="free">zs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">A_xs</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">A_ys</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">A_zs</span> <span class="main">=</span> length <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms find_sub_True_sound find_sub_True_proj_list_5_same find_sub_True_proj_list_5_length
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> proj_list_5.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">dominate_False</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set list <span class="main">⇒</span> <span class="tfree">'a</span> table list <span class="main">⇒</span> nat set list <span class="main">⇒</span> <span class="tfree">'a</span> table list <span class="main">⇒</span>
  <span class="main">(</span><span class="main">(</span><span class="main">(</span>nat set list <span class="main">×</span> nat set <span class="main">×</span> nat set list<span class="main">)</span> <span class="main">×</span> nat set list <span class="main">×</span> nat set <span class="main">×</span> nat set list<span class="main">)</span> <span class="main">×</span>
  <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> table list <span class="main">×</span> <span class="tfree">'a</span> table <span class="main">×</span> <span class="tfree">'a</span> table list<span class="main">)</span> <span class="main">×</span>
  <span class="tfree">'a</span> table list <span class="main">×</span> <span class="tfree">'a</span> table <span class="main">×</span> <span class="tfree">'a</span> table list<span class="main">)</span><span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dominate_False</span> <span class="free"><span class="bound"><span class="entity">A_pos</span></span></span> <span class="free"><span class="bound"><span class="entity">L_pos</span></span></span> <span class="free"><span class="bound"><span class="entity">A_neg</span></span></span> <span class="free"><span class="bound"><span class="entity">L_neg</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> find_sub_False <span class="free"><span class="bound"><span class="entity">A_pos</span></span></span> <span class="free"><span class="bound"><span class="entity">A_neg</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> None
  <span class="main">|</span> Some <span class="main">(</span><span class="bound">pos_split</span><span class="main">,</span> <span class="bound">neg_split</span><span class="main">)</span> <span class="main">⇒</span>
    Some <span class="main">(</span><span class="main">(</span><span class="bound">pos_split</span><span class="main">,</span> <span class="bound">neg_split</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>proj_list_3 <span class="free"><span class="bound"><span class="entity">L_pos</span></span></span> <span class="bound">pos_split</span><span class="main">,</span> proj_list_3 <span class="free"><span class="bound"><span class="entity">L_neg</span></span></span> <span class="bound">neg_split</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> find_sub_False_proj_list_3_same_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"find_sub_False <span class="free">xs</span> <span class="free">ns</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span><span class="free">rs</span><span class="main">,</span> <span class="free">w</span><span class="main">,</span> <span class="free">ws</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">z</span><span class="main">,</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">xs'</span>"</span></span> <span class="quoted"><span class="quoted">"proj_list_3 <span class="free">xs'</span> <span class="main">(</span><span class="free">rs</span><span class="main">,</span> <span class="free">w</span><span class="main">,</span> <span class="free">ws</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">rs'</span><span class="main">,</span> <span class="free">w'</span><span class="main">,</span> <span class="free">ws'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs'</span> <span class="main">=</span> <span class="free">rs'</span> <span class="main">@</span> <span class="free">w'</span> <span class="main">#</span> <span class="free">ws'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs'</span> <span class="main">=</span> length <span class="free">rs</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> length <span class="free">ws</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> find_sub_False_sound<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> proj_list_3_same<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> len<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> find_sub_False_proj_list_3_length_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"find_sub_False <span class="free">xs</span> <span class="free">ns</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span><span class="free">rs</span><span class="main">,</span> <span class="free">w</span><span class="main">,</span> <span class="free">ws</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">z</span><span class="main">,</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">xs'</span>"</span></span> <span class="quoted"><span class="quoted">"proj_list_3 <span class="free">xs'</span> <span class="main">(</span><span class="free">rs</span><span class="main">,</span> <span class="free">w</span><span class="main">,</span> <span class="free">ws</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">rs'</span><span class="main">,</span> <span class="free">w'</span><span class="main">,</span> <span class="free">ws'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">rs</span> <span class="main">=</span> length <span class="free">rs'</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ws</span> <span class="main">=</span> length <span class="free">ws'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> find_sub_False_sound<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> proj_list_3_length<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> find_sub_False_proj_list_3_same_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"find_sub_False <span class="free">xs</span> <span class="free">ns</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span><span class="free">rs</span><span class="main">,</span> <span class="free">w</span><span class="main">,</span> <span class="free">ws</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">z</span><span class="main">,</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">ns</span> <span class="main">=</span> length <span class="free">ns'</span>"</span></span> <span class="quoted"><span class="quoted">"proj_list_3 <span class="free">ns'</span> <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">z</span><span class="main">,</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ys'</span><span class="main">,</span> <span class="free">z'</span><span class="main">,</span> <span class="free">zs'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns'</span> <span class="main">=</span> <span class="free">ys'</span> <span class="main">@</span> <span class="free">z'</span> <span class="main">#</span> <span class="free">zs'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">ns'</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> length <span class="free">zs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> find_sub_False_sound<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> proj_list_3_same<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> len<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> find_sub_False_proj_list_3_length_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"find_sub_False <span class="free">xs</span> <span class="free">ns</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span><span class="free">rs</span><span class="main">,</span> <span class="free">w</span><span class="main">,</span> <span class="free">ws</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">z</span><span class="main">,</span> <span class="free">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">ns</span> <span class="main">=</span> length <span class="free">ns'</span>"</span></span> <span class="quoted"><span class="quoted">"proj_list_3 <span class="free">ns'</span> <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">z</span><span class="main">,</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ys'</span><span class="main">,</span> <span class="free">z'</span><span class="main">,</span> <span class="free">zs'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> length <span class="free">ys'</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">zs</span> <span class="main">=</span> length <span class="free">zs'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> find_sub_False_sound<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> proj_list_3_length<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> dominate_False_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dominate_False <span class="free">A_pos</span> <span class="free">L_pos</span> <span class="free">A_neg</span> <span class="free">L_neg</span> <span class="main">=</span>
    Some <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="free">A_zs</span><span class="main">,</span> <span class="free">A_x</span><span class="main">,</span> <span class="free">A_xs</span><span class="main">)</span><span class="main">,</span> <span class="free">A_ws</span><span class="main">,</span> <span class="free">A_y</span><span class="main">,</span> <span class="free">A_ys</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="free">zs</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="free">xs</span><span class="main">)</span><span class="main">,</span> <span class="free">ws</span><span class="main">,</span> <span class="free">y</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">A_pos</span> <span class="main">=</span> length <span class="free">L_pos</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">A_neg</span> <span class="main">=</span> length <span class="free">L_neg</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A_pos</span> <span class="main">=</span> <span class="main">(</span><span class="free">A_zs</span> <span class="main">@</span> <span class="free">A_x</span> <span class="main">#</span> <span class="free">A_xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A_neg</span> <span class="main">=</span> <span class="free">A_ws</span> <span class="main">@</span> <span class="free">A_y</span> <span class="main">#</span> <span class="free">A_ys</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">L_pos</span> <span class="main">=</span> <span class="main">(</span><span class="free">zs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">L_neg</span> <span class="main">=</span> <span class="free">ws</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">A_ws</span> <span class="main">=</span> length <span class="free">ws</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">A_xs</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="free">A_ys</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">A_zs</span> <span class="main">=</span> length <span class="free">zs</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">A_y</span> <span class="main">⊆</span> <span class="free">A_x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms find_sub_False_proj_list_3_same_left find_sub_False_proj_list_3_same_right
    find_sub_False_proj_list_3_length_left find_sub_False_proj_list_3_length_right
    find_sub_False_sound
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> proj_list_3.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">mmulti_join</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> nat set list <span class="main">⇒</span> nat set list <span class="main">⇒</span> <span class="tfree">'a</span> table list <span class="main">⇒</span> <span class="tfree">'a</span> table<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mmulti_join</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">A_pos</span></span></span> <span class="free"><span class="bound"><span class="entity">A_neg</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> length <span class="free"><span class="bound"><span class="entity">A_pos</span></span></span> <span class="main">+</span> length <span class="free"><span class="bound"><span class="entity">A_neg</span></span></span> <span class="main">≠</span> length <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span>
    <span class="keyword1">let</span> <span class="bound">L_pos</span> <span class="main">=</span> take <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">A_pos</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">;</span> <span class="bound">L_neg</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">A_pos</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="keyword1">case</span> dominate_True <span class="free"><span class="bound"><span class="entity">A_pos</span></span></span> <span class="bound">L_pos</span> <span class="keyword1">of</span> None <span class="main">⇒</span>
      <span class="main">(</span><span class="keyword1">case</span> dominate_False <span class="free"><span class="bound"><span class="entity">A_pos</span></span></span> <span class="bound">L_pos</span> <span class="free"><span class="bound"><span class="entity">A_neg</span></span></span> <span class="bound">L_neg</span> <span class="keyword1">of</span> None <span class="main">⇒</span> mmulti_join' <span class="free"><span class="bound"><span class="entity">A_pos</span></span></span> <span class="free"><span class="bound"><span class="entity">A_neg</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span>
      <span class="main">|</span> Some <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">A_zs</span><span class="main">,</span> <span class="bound">A_x</span><span class="main">,</span> <span class="bound">A_xs</span><span class="main">)</span><span class="main">,</span> <span class="bound">A_ws</span><span class="main">,</span> <span class="bound">A_y</span><span class="main">,</span> <span class="bound">A_ys</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span><span class="main">,</span> <span class="bound">ws</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span>
        <span class="free">mmulti_join</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="bound">A_zs</span> <span class="main">@</span> <span class="bound">A_x</span> <span class="main">#</span> <span class="bound">A_xs</span><span class="main">)</span> <span class="main">(</span><span class="bound">A_ws</span> <span class="main">@</span> <span class="bound">A_ys</span><span class="main">)</span>
        <span class="main">(</span><span class="main">(</span><span class="bound">zs</span> <span class="main">@</span> bin_join <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">A_x</span> <span class="bound">x</span> False <span class="bound">A_y</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="bound">ws</span> <span class="main">@</span> <span class="bound">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> Some <span class="main">(</span><span class="main">(</span><span class="bound">A_zs</span><span class="main">,</span> <span class="bound">A_x</span><span class="main">,</span> <span class="bound">A_xs</span><span class="main">,</span> <span class="bound">A_y</span><span class="main">,</span> <span class="bound">A_ys</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">xs</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="free">mmulti_join</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="bound">A_zs</span> <span class="main">@</span> <span class="main">(</span><span class="bound">A_x</span> <span class="main">∪</span> <span class="bound">A_y</span><span class="main">)</span> <span class="main">#</span> <span class="bound">A_xs</span> <span class="main">@</span> <span class="bound">A_ys</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">A_neg</span></span></span>
      <span class="main">(</span><span class="main">(</span><span class="bound">zs</span> <span class="main">@</span> bin_join <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">A_x</span> <span class="bound">x</span> True <span class="bound">A_y</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">@</span> <span class="bound">L_neg</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">A_pos</span><span class="main">,</span> <span class="bound">A_neg</span><span class="main">,</span> <span class="bound">L</span><span class="main">)</span><span class="main">.</span> length <span class="bound">A_pos</span> <span class="main">+</span> length <span class="bound">A_neg</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">use</span> find_sub_True_sound find_sub_False_sound <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main">:</span> option.splits›</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mmulti_join_link<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A_pos</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> table <span class="free">n</span> <span class="bound">A</span> <span class="bound">X</span> <span class="main">∧</span> wf_set <span class="free">n</span> <span class="bound">A</span><span class="main">)</span> <span class="main">(</span><span class="free">A_pos</span> <span class="main">@</span> <span class="free">A_neg</span><span class="main">)</span> <span class="free">L</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mmulti_join <span class="free">n</span> <span class="free">A_pos</span> <span class="free">A_neg</span> <span class="free">L</span> <span class="main">=</span> mmulti_join' <span class="free">A_pos</span> <span class="free">A_neg</span> <span class="free">L</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A_pos</span></span> <span class="quoted"><span class="free">A_neg</span></span> <span class="quoted"><span class="free">L</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mmulti_join.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">n</span> <span class="skolem">A_pos</span> <span class="skolem">A_neg</span> <span class="skolem">L</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L_pos</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L_pos</span> <span class="main">=</span> take <span class="main">(</span>length <span class="skolem">A_pos</span><span class="main">)</span> <span class="skolem">L</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L_neg</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L_neg</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="skolem">A_pos</span><span class="main">)</span> <span class="skolem">L</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> L_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> <span class="skolem">L_pos</span> <span class="main">@</span> <span class="skolem">L_neg</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> L_pos_def L_neg_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lens_match<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">A_pos</span> <span class="main">=</span> length <span class="skolem">L_pos</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">A_neg</span> <span class="main">=</span> length <span class="skolem">L_neg</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> L_pos_def L_neg_def 1<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> L_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lens_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">A_pos</span> <span class="main">+</span> length <span class="skolem">A_neg</span> <span class="main">=</span> length <span class="skolem">L</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"dominate_True <span class="skolem">A_pos</span> <span class="skolem">L_pos</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">note</span></span> dom_True <span class="main">=</span> None
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"dominate_False <span class="skolem">A_pos</span> <span class="skolem">L_pos</span> <span class="skolem">A_neg</span> <span class="skolem">L_neg</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> mmulti_join.simps<span class="main">)</span>
           <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> dominate_True.simps dominate_False.simps mmulti_join.simps
            mmulti_join'.simps <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def dom_True L_pos_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> None
            L_neg_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> lens_sum <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A_zs</span></span> <span class="skolem"><span class="skolem">A_x</span></span> <span class="skolem"><span class="skolem">A_xs</span></span> <span class="skolem"><span class="skolem">A_ws</span></span> <span class="skolem"><span class="skolem">A_y</span></span> <span class="skolem"><span class="skolem">A_ys</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        dom_False<span class="main">:</span> <span class="quoted"><span class="quoted">"dominate_False <span class="skolem">A_pos</span> <span class="skolem">L_pos</span> <span class="skolem">A_neg</span> <span class="skolem">L_neg</span> <span class="main">=</span>
        Some <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="skolem">A_zs</span><span class="main">,</span> <span class="skolem">A_x</span><span class="main">,</span> <span class="skolem">A_xs</span><span class="main">)</span><span class="main">,</span> <span class="skolem">A_ws</span><span class="main">,</span> <span class="skolem">A_y</span><span class="main">,</span> <span class="skolem">A_ys</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ws</span><span class="main">,</span> <span class="skolem">y</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> list_all2 <span class="main">=</span> 1<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> L_def dominate_False_sound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dom_False lens_match<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> lens<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">A_ws</span> <span class="main">=</span> length <span class="skolem">ws</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">A_xs</span> <span class="main">=</span> length <span class="skolem">xs</span>"</span></span>
        <span class="quoted"><span class="quoted">"length <span class="skolem">A_ys</span> <span class="main">=</span> length <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">A_zs</span> <span class="main">=</span> length <span class="skolem">zs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> dominate_False_sound<span class="main">[</span><span class="operator">OF</span> dom_False lens_match<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A_y</span> <span class="main">⊆</span> <span class="skolem">A_x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> dominate_False_sound<span class="main">[</span><span class="operator">OF</span> dom_False lens_match<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> list_all2'<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> table <span class="skolem">n</span> <span class="bound">A</span> <span class="bound">X</span> <span class="main">∧</span> wf_set <span class="skolem">n</span> <span class="bound">A</span><span class="main">)</span>
        <span class="main">(</span><span class="main">(</span><span class="skolem">A_zs</span> <span class="main">@</span> <span class="skolem">A_x</span> <span class="main">#</span> <span class="skolem">A_xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">A_ws</span> <span class="main">@</span> <span class="skolem">A_ys</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> join <span class="skolem">x</span> False <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">ws</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> list_all2_opt_False<span class="main">[</span><span class="operator">OF</span> list_all2 lens sub<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">have</span></span> tabs<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="skolem">A_x</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="skolem">A_y</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> list_all2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens list_all2_append<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> bin_join_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"join <span class="skolem">x</span> False <span class="skolem">y</span> <span class="main">=</span> bin_join <span class="skolem">n</span> <span class="skolem">A_x</span> <span class="skolem">x</span> False <span class="skolem">A_y</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bin_join_table<span class="main">[</span><span class="operator">OF</span> tabs<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">have</span></span> mmulti<span class="main">:</span> <span class="quoted"><span class="quoted">"mmulti_join <span class="skolem">n</span> <span class="skolem">A_pos</span> <span class="skolem">A_neg</span> <span class="skolem">L</span> <span class="main">=</span> mmulti_join <span class="skolem">n</span> <span class="main">(</span><span class="skolem">A_zs</span> <span class="main">@</span> <span class="skolem">A_x</span> <span class="main">#</span> <span class="skolem">A_xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">A_ws</span> <span class="main">@</span> <span class="skolem">A_ys</span><span class="main">)</span>
        <span class="main">(</span><span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> bin_join <span class="skolem">n</span> <span class="skolem">A_x</span> <span class="skolem">x</span> False <span class="skolem">A_y</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">ws</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> mmulti_join.simps<span class="main">)</span>
           <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> dominate_True.simps dominate_False.simps mmulti_join.simps
            <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def dom_True L_pos_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> L_neg_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> dom_False lens_sum<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mmulti
        <span class="keyword1"><span class="command">unfolding</span></span> L_def dominate_False_sound<span class="main">[</span><span class="operator">OF</span> dom_False lens_match<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> 1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ L_pos_def L_neg_def dom_True dom_False<span class="main"><span class="main">,</span></span>
            <span class="operator">OF</span> _ _ _ _ _ _ _ _ _ _ _ _ _ list_all2'<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> bin_join_conv<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span>
            <span class="operator">unfolded</span> mmulti_join'_opt_False<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> list_all2 lens sub<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">,</span></span></span>
            <span class="operator">unfolded</span> bin_join_conv<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
           <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_sum<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A_zs</span></span> <span class="skolem"><span class="skolem">A_x</span></span> <span class="skolem"><span class="skolem">A_xs</span></span> <span class="skolem"><span class="skolem">A_y</span></span> <span class="skolem"><span class="skolem">A_ys</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> dom_True<span class="main">:</span> <span class="quoted"><span class="quoted">"dominate_True <span class="skolem">A_pos</span> <span class="skolem">L_pos</span> <span class="main">=</span>
      Some <span class="main">(</span><span class="main">(</span><span class="skolem">A_zs</span><span class="main">,</span> <span class="skolem">A_x</span><span class="main">,</span> <span class="skolem">A_xs</span><span class="main">,</span> <span class="skolem">A_y</span><span class="main">,</span> <span class="skolem">A_ys</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">,</span> <span class="skolem">y</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> list_all2 <span class="main">=</span> 1<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> L_def dominate_True_sound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dom_True lens_match<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> lens<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">A_xs</span> <span class="main">=</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">A_ys</span> <span class="main">=</span> length <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">A_zs</span> <span class="main">=</span> length <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dominate_True_sound<span class="main">[</span><span class="operator">OF</span> dom_True lens_match<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> list_all2'<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> table <span class="skolem">n</span> <span class="bound">A</span> <span class="bound">X</span> <span class="main">∧</span> wf_set <span class="skolem">n</span> <span class="bound">A</span><span class="main">)</span>
      <span class="main">(</span><span class="main">(</span><span class="skolem">A_zs</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">A_x</span> <span class="main">∪</span> <span class="skolem">A_y</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">A_xs</span> <span class="main">@</span> <span class="skolem">A_ys</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">A_neg</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> join <span class="skolem">x</span> True <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">L_neg</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> list_all2_opt_True<span class="main">[</span><span class="operator">OF</span> list_all2 lens<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> tabs<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="skolem">A_x</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="skolem">A_y</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> list_all2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens list_all2_append<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> bin_join_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"join <span class="skolem">x</span> True <span class="skolem">y</span> <span class="main">=</span> bin_join <span class="skolem">n</span> <span class="skolem">A_x</span> <span class="skolem">x</span> True <span class="skolem">A_y</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bin_join_table<span class="main">[</span><span class="operator">OF</span> tabs<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> mmulti<span class="main">:</span> <span class="quoted"><span class="quoted">"mmulti_join <span class="skolem">n</span> <span class="skolem">A_pos</span> <span class="skolem">A_neg</span> <span class="skolem">L</span> <span class="main">=</span> mmulti_join <span class="skolem">n</span> <span class="main">(</span><span class="skolem">A_zs</span> <span class="main">@</span> <span class="main">(</span><span class="skolem">A_x</span> <span class="main">∪</span> <span class="skolem">A_y</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">A_xs</span> <span class="main">@</span> <span class="skolem">A_ys</span><span class="main">)</span>
      <span class="skolem">A_neg</span> <span class="main">(</span><span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> bin_join <span class="skolem">n</span> <span class="skolem">A_x</span> <span class="skolem">x</span> True <span class="skolem">A_y</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">L_neg</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> mmulti_join.simps<span class="main">)</span>
         <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> dominate_True.simps dominate_False.simps mmulti_join.simps
          <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def dom_True L_pos_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> L_neg_def lens_sum<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mmulti
      <span class="keyword1"><span class="command">unfolding</span></span> L_def dominate_True_sound<span class="main">[</span><span class="operator">OF</span> dom_True lens_match<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> 1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ L_pos_def L_neg_def dom_True<span class="main"><span class="main">,</span></span>
          <span class="operator">OF</span> _ _ _ _ _ _ _ _ _ _ _ list_all2'<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> bin_join_conv<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span>
          <span class="operator">unfolded</span> mmulti_join'_opt_True<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> list_all2 lens<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">,</span></span></span>
          <span class="operator">unfolded</span> bin_join_conv<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lens_sum<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mmulti_join_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A_pos</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> table <span class="free">n</span> <span class="bound">A</span> <span class="bound">X</span> <span class="main">∧</span> wf_set <span class="free">n</span> <span class="bound">A</span><span class="main">)</span> <span class="main">(</span><span class="free">A_pos</span> <span class="main">@</span> <span class="free">A_neg</span><span class="main">)</span> <span class="free">L</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> mmulti_join <span class="free">n</span> <span class="free">A_pos</span> <span class="free">A_neg</span> <span class="free">L</span> <span class="main">⟷</span> wf_tuple <span class="free">n</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">A</span><span class="main">∈</span>set <span class="free">A_pos</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span> <span class="free">z</span> <span class="main">∧</span>
    list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="free">A_pos</span> <span class="main">(</span>take <span class="main">(</span>length <span class="free">A_pos</span><span class="main">)</span> <span class="free">L</span><span class="main">)</span> <span class="main">∧</span>
    list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span> <span class="free">A_neg</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="free">A_pos</span><span class="main">)</span> <span class="free">L</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mmulti_join_link<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> mmulti_join'_correct<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</body>

</html>