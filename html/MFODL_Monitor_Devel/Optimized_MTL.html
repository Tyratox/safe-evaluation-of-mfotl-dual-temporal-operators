<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Optimized_MTL</title>
</head>


<body>
<div class="head">
<h1>Theory Optimized_MTL</h1>
</div>

<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Optimized_MTL
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Monitor.html">Monitor</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Efficient implementation of temporal operators›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Optimized queue data structure›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> less_enat_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> enat <span class="free">i</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> enat <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> queue_t <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">queue_invariant</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> queue_t <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">queue_invariant</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main">(</span><span class="bound">fs</span><span class="main">,</span> <span class="bound">l</span> <span class="main">#</span> <span class="bound">ls</span><span class="main">)</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="tfree">'a</span> queue <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">q</span> <span class="main">::</span> <span class="tfree">'a</span> queue_t<span class="main">.</span> queue_invariant <span class="bound">q</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> queue_invariant_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_queue

<span class="keyword1"><span class="command">lift_definition</span></span> linearize <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> queue <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">q</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">fs</span><span class="main">,</span> <span class="bound">ls</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">fs</span> <span class="main">@</span> rev <span class="bound">ls</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> empty_queue <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> queue"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> queue_invariant_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> empty_queue_rep<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize empty_queue <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_queue_def linearize_def<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> is_empty <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> queue <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">q</span> <span class="keyword1">of</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> linearize_t_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="free">q</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">fs</span><span class="main">,</span> <span class="bound">ls</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">fs</span> <span class="main">@</span> rev <span class="bound">ls</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_empty_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"is_empty <span class="free">q</span> <span class="main">⟷</span> linearize <span class="free">q</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linearize_t_Nil list.case_eq_if<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">prepend_queue_t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> queue_t <span class="main">⇒</span> <span class="tfree">'a</span> queue_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prepend_queue_t</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">prepend_queue_t</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">prepend_queue_t</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> undefined"</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> prepend_queue <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> queue <span class="main">⇒</span> <span class="tfree">'a</span> queue"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">prepend_queue_t</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> queue_invariant_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> prepend_queue_t.elims<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prepend_queue_rep<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="main">(</span>prepend_queue <span class="free">a</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="main">#</span> linearize <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> queue_invariant_def linearize_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> prepend_queue_t.elims <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> append_queue <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> queue <span class="main">⇒</span> <span class="tfree">'a</span> queue"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">q</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">q</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">fs</span><span class="main">,</span> <span class="bound">ls</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">fs</span><span class="main">,</span> <span class="bound">a</span> <span class="main">#</span> <span class="bound">ls</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> queue_invariant_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> append_queue_rep<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="main">(</span>append_queue <span class="free">a</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> linearize <span class="free">q</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> linearize_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">safe_last_t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> queue_t <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">×</span> <span class="tfree">'a</span> queue_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">safe_last_t</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>None<span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_last_t</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_last_t</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> undefined"</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> safe_last <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> queue <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">×</span> <span class="tfree">'a</span> queue"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">safe_last_t</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> queue_invariant_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits list.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> safe_last_rep<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_last <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">α</span><span class="main">,</span> <span class="free">q'</span><span class="main">)</span> <span class="main">⟹</span> linearize <span class="free">q</span> <span class="main">=</span> linearize <span class="free">q'</span> <span class="main">∧</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">α</span> <span class="keyword1">of</span> None <span class="main">⇒</span> linearize <span class="free">q</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">|</span> Some <span class="bound">a</span> <span class="main">⇒</span> linearize <span class="free">q</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">=</span> last <span class="main">(</span>linearize <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> queue_invariant_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> safe_last_t.elims<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">safe_hd_t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> queue_t <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">×</span> <span class="tfree">'a</span> queue_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">safe_hd_t</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>None<span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_hd_t</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_hd_t</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">fs</span> <span class="main">=</span> rev <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="keyword1">in</span> <span class="main">(</span>Some <span class="main">(</span>hd <span class="bound">fs</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">fs</span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_hd_t</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_hd_t</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> undefined"</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span><span class="main">(</span>code_dt<span class="main">)</span> safe_hd <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> queue <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">×</span> <span class="tfree">'a</span> queue"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">safe_hd_t</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> queue_t"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"queue_invariant <span class="skolem">q</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pred_prod <span class="main">⊤</span> queue_invariant <span class="main">(</span>safe_hd_t <span class="skolem">q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> safe_hd_t.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> queue_invariant_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.split<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> safe_hd_rep<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_hd <span class="free">q</span> <span class="main">=</span> <span class="main">(</span><span class="free">α</span><span class="main">,</span> <span class="free">q'</span><span class="main">)</span> <span class="main">⟹</span> linearize <span class="free">q</span> <span class="main">=</span> linearize <span class="free">q'</span> <span class="main">∧</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">α</span> <span class="keyword1">of</span> None <span class="main">⇒</span> linearize <span class="free">q</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">|</span> Some <span class="bound">a</span> <span class="main">⇒</span> linearize <span class="free">q</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">=</span> hd <span class="main">(</span>linearize <span class="free">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> queue_invariant_def Let_def hd_append <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> safe_hd_t.elims<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">replace_hd_t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> queue_t <span class="main">⇒</span> <span class="tfree">'a</span> queue_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">replace_hd_t</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">replace_hd_t</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">replace_hd_t</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">fs</span> <span class="main">=</span> rev <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> tl <span class="bound">fs</span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">replace_hd_t</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">replace_hd_t</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> undefined"</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> replace_hd <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> queue <span class="main">⇒</span> <span class="tfree">'a</span> queue"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">replace_hd_t</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> queue_invariant_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> replace_hd_t.elims<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tl_append<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> tl <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">=</span> tl <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> replace_hd_rep<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="free">q</span> <span class="main">=</span> <span class="free">f</span> <span class="main">#</span> <span class="free">fs</span> <span class="main">⟹</span> linearize <span class="main">(</span>replace_hd <span class="free">a</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="main">#</span> <span class="free">fs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">transfer</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">fs</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"queue_invariant <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="skolem">q</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">fs</span><span class="main">,</span> <span class="bound">ls</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">fs</span> <span class="main">@</span> rev <span class="bound">ls</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">#</span> <span class="free">fs</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> replace_hd_t <span class="free">a</span> <span class="skolem">q</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">fs</span><span class="main">,</span> <span class="bound">ls</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">fs</span> <span class="main">@</span> rev <span class="bound">ls</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="main">#</span> <span class="free">fs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> replace_hd_t.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> queue_invariant_def tl_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">replace_last_t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> queue_t <span class="main">⇒</span> <span class="tfree">'a</span> queue_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">replace_last_t</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">replace_last_t</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">replace_last_t</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> undefined"</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> replace_last <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> queue <span class="main">⇒</span> <span class="tfree">'a</span> queue"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">replace_last_t</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> queue_invariant_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> replace_last_t.elims<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> replace_last_rep<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="free">q</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">@</span> <span class="main">[</span><span class="free">f</span><span class="main">]</span> <span class="main">⟹</span> linearize <span class="main">(</span>replace_last <span class="free">a</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="free">fs</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> queue_invariant_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits prod.splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> replace_last_t.elims<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tl_queue_t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> queue_t <span class="main">⇒</span> <span class="tfree">'a</span> queue_t"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tl_queue_t</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tl_queue_t</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tl_queue_t</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>tl <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tl_queue_t</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> tl_queue <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> queue <span class="main">⇒</span> <span class="tfree">'a</span> queue"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">tl_queue_t</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> queue_invariant_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> tl_queue_t.elims<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tl_queue_rep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_empty <span class="free">q</span> <span class="main">⟹</span> linearize <span class="main">(</span>tl_queue <span class="free">q</span><span class="main">)</span> <span class="main">=</span> tl <span class="main">(</span>linearize <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tl_append <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits list.splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> tl_queue_t.elims<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> length_tl_queue_rep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_empty <span class="free">q</span> <span class="main">⟹</span>
  length <span class="main">(</span>linearize <span class="main">(</span>tl_queue <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="main">(</span>linearize <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits list.splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> tl_queue_t.elims<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> length_tl_queue_safe_hd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"safe_hd <span class="free">q</span> <span class="main">=</span> <span class="main">(</span>Some <span class="free">a</span><span class="main">,</span> <span class="free">q'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="main">(</span>tl_queue <span class="free">q'</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="main">(</span>linearize <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> safe_hd_rep<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_tl_queue_rep is_empty_alt<span class="main">)</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">dropWhile_queue</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> queue <span class="main">⇒</span> <span class="tfree">'a</span> queue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dropWhile_queue</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> safe_hd <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1">of</span> <span class="main">(</span>None<span class="main">,</span> <span class="bound">q'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">q'</span>
  <span class="main">|</span> <span class="main">(</span>Some <span class="bound">a</span><span class="main">,</span> <span class="bound">q'</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="keyword1">then</span> <span class="free">dropWhile_queue</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>tl_queue <span class="bound">q'</span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">q'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command">using</span></span> length_tl_queue_safe_hd<span class="main">[</span><span class="operator">OF</span> sym<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> length <span class="main">(</span>linearize <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dropWhile_hd_tl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span>
  dropWhile <span class="free">P</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span> <span class="keyword1">then</span> dropWhile <span class="free">P</span> <span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> dropWhile_queue_rep<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="main">(</span>dropWhile_queue <span class="free">f</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> dropWhile <span class="free">f</span> <span class="main">(</span>linearize <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dropWhile_queue.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tl_queue_rep dropWhile_hd_tl is_empty_alt
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits option.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> safe_hd_rep<span class="main">)</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">takeWhile_queue</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> queue <span class="main">⇒</span> <span class="tfree">'a</span> queue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">takeWhile_queue</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> safe_hd <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1">of</span> <span class="main">(</span>None<span class="main">,</span> <span class="bound">q'</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">q'</span>
  <span class="main">|</span> <span class="main">(</span>Some <span class="bound">a</span><span class="main">,</span> <span class="bound">q'</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span>
    <span class="keyword1">then</span> prepend_queue <span class="bound">a</span> <span class="main">(</span><span class="free">takeWhile_queue</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>tl_queue <span class="bound">q'</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> empty_queue<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command">using</span></span> length_tl_queue_safe_hd<span class="main">[</span><span class="operator">OF</span> sym<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> length <span class="main">(</span>linearize <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> takeWhile_hd_tl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span>
  takeWhile <span class="free">P</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span> <span class="keyword1">then</span> hd <span class="free">xs</span> <span class="main">#</span> takeWhile <span class="free">P</span> <span class="main">(</span>tl <span class="free">xs</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> takeWhile_queue_rep<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="main">(</span>takeWhile_queue <span class="free">f</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> takeWhile <span class="free">f</span> <span class="main">(</span>linearize <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> takeWhile_queue.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prepend_queue_rep tl_queue_rep empty_queue_rep takeWhile_hd_tl is_empty_alt
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits option.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> safe_hd_rep<span class="main">)</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">takedropWhile_queue</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> queue <span class="main">⇒</span> <span class="tfree">'a</span> queue <span class="main">×</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">takedropWhile_queue</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> safe_hd <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1">of</span> <span class="main">(</span>None<span class="main">,</span> <span class="bound">q'</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>
  <span class="main">|</span> <span class="main">(</span>Some <span class="bound">a</span><span class="main">,</span> <span class="bound">q'</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span>
    <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">takedropWhile_queue</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>tl_queue <span class="bound">q'</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">q''</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">q''</span><span class="main">,</span> <span class="bound">a</span> <span class="main">#</span> <span class="bound">as</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command">using</span></span> length_tl_queue_safe_hd<span class="main">[</span><span class="operator">OF</span> sym<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> length <span class="main">(</span>linearize <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> takedropWhile_queue_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>takedropWhile_queue <span class="free">f</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> dropWhile_queue <span class="free">f</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> takedropWhile_queue.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">f</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> takedropWhile_queue_snd<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>takedropWhile_queue <span class="free">f</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> takeWhile <span class="free">f</span> <span class="main">(</span>linearize <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> takedropWhile_queue.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">f</span> <span class="skolem">q</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold tl_queue_rep takeWhile_hd_tl is_empty_alt
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> safe_hd_rep<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Optimized data structure for Since›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> mmsaux <span class="main">=</span> <span class="quoted"><span class="quoted">"ts <span class="main">×</span> ts <span class="main">×</span> bool list <span class="main">×</span> bool list <span class="main">×</span>
  <span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> queue <span class="main">×</span> <span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> queue <span class="main">×</span>
  <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> tuple<span class="main">,</span> ts<span class="main">)</span> mapping<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> tuple<span class="main">,</span> ts<span class="main">)</span> mapping<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">time_mmsaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mmsaux <span class="main">⇒</span> ts"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">time_mmsaux</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">nt</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">nt</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ts_tuple_rel_f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> table<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> tuple<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ts_tuple_rel_f</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">ts_tuple_rel</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">≡</span> ts_tuple_rel_f id <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_fst_ts_tuple_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">tas</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">tas</span><span class="main">}</span> <span class="main">⊆</span> fst <span class="main">`</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> set <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ts_tuple_rel_ext_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tas</span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">{</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span><span class="main">}</span> <span class="main">⟹</span>
  <span class="free">tas</span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">#</span> <span class="free">tass</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ts_tuple_rel_ext_Cons'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tas</span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="free">tass</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">tas</span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">#</span> <span class="free">tass</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ts_tuple_rel_intro<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∈</span> <span class="free">f</span> <span class="free">X</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ys</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ts_tuple_rel_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="free">ys</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ys</span> <span class="main">∧</span> <span class="free">as</span> <span class="main">∈</span> <span class="free">f</span> <span class="bound">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ts_tuple_rel_Un<span class="main">:</span> <span class="quoted"><span class="quoted">"ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span><span class="free">ys</span> <span class="main">∪</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> ts_tuple_rel_f <span class="free">f</span> <span class="free">ys</span> <span class="main">∪</span> ts_tuple_rel_f <span class="free">f</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ts_tuple_rel_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tas</span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">{</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span><span class="main">}</span> <span class="main">⟹</span>
  <span class="main">∀</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="free">f</span> <span class="bound">A</span> <span class="main">∪</span> <span class="free">f</span> <span class="bound">B</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="bound">A</span> <span class="main">∪</span> <span class="bound">B</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">tas</span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">Y</span> <span class="main">∪</span> <span class="free">X</span><span class="main">)</span> <span class="main">#</span> <span class="free">tass</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tas</span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">{</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="free">f</span> <span class="bound">A</span> <span class="main">∪</span> <span class="free">f</span> <span class="bound">B</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="bound">A</span> <span class="main">∪</span> <span class="bound">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> tas_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tas</span> <span class="main">=</span> <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="free">f</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">tas</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">(</span><span class="free">Y</span> <span class="main">∪</span> <span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assm<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">tas</span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">Y</span> <span class="main">∪</span> <span class="free">X</span><span class="main">)</span> <span class="main">#</span> <span class="free">tass</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tas_def<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ts_tuple_rel_intro<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ts_tuple_rel_ext'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tas</span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">#</span> <span class="free">tass</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">∀</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="free">f</span> <span class="bound">A</span> <span class="main">∪</span> <span class="free">f</span> <span class="bound">B</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="bound">A</span> <span class="main">∪</span> <span class="bound">B</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">tas</span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">#</span> <span class="free">tass</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tas</span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">#</span> <span class="free">tass</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="free">f</span> <span class="bound">A</span> <span class="main">∪</span> <span class="free">f</span> <span class="bound">B</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="bound">A</span> <span class="main">∪</span> <span class="bound">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">tas</span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">{</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="free">tass</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ts_tuple_rel_Un <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">tas</span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">#</span> <span class="free">tass</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">tas</span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">{</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assm<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Un_commute <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ts_tuple_rel_ext<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">tas</span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="free">tass</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">tas</span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">#</span> <span class="free">tass</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ts_tuple_rel_ext_Cons'<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ts_tuple_rel_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">⊆</span> <span class="free">zs</span> <span class="main">⟹</span> ts_tuple_rel_f <span class="free">f</span> <span class="free">ys</span> <span class="main">⊆</span> ts_tuple_rel_f <span class="free">f</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ts_tuple_rel_filter<span class="main">:</span> <span class="quoted"><span class="quoted">"ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">t</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">{</span><span class="main">(</span><span class="bound"><span class="bound">t</span></span><span class="main">,</span> <span class="bound"><span class="bound">X</span></span><span class="main">)</span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">t</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ts_tuple_rel_set_filter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">x</span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">valid_tuple</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> tuple<span class="main">,</span> ts<span class="main">)</span> mapping<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> tuple<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valid_tuple</span> <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span> <span class="bound">as</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False
  <span class="main">|</span> Some <span class="bound">t'</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">≥</span> <span class="bound">t'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">safe_max</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder set <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">safe_max</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span>Max <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> safe_max_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_max <span class="free">X</span> <span class="main">=</span> None <span class="main">⟷</span> <span class="free">X</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_max_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> safe_max_empty_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_max <span class="free">X</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="free">X</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_max_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> safe_max_Some_intro<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> safe_max <span class="free">X</span> <span class="main">=</span> Some <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> safe_max_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> safe_max_Some_dest_in<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span> <span class="main">⟹</span> safe_max <span class="free">X</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Max_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_max_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> safe_max_Some_dest_le<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span> <span class="main">⟹</span> safe_max <span class="free">X</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Max_ge <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_max_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">newest_tuple_in_mapping</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"
  <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> table<span class="main">)</span> <span class="main">⇒</span>
  <span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> queue <span class="main">⇒</span>
  <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> tuple<span class="main">,</span> ts<span class="main">)</span> mapping<span class="main">)</span> <span class="main">⇒</span>
  <span class="main">(</span><span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> tuple<span class="main">)</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span>
  bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">newest_tuple_in_mapping</span> <span class="free"><span class="bound"><span class="entity">entry_to_db</span></span></span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span> <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span>
    <span class="comment1">― ‹iff something is present in the mapping then the value corresponds
       to the maximum timestamp of a db containing the tuple›</span>
    Mapping.lookup <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span> <span class="bound">tuple</span> <span class="main">=</span>
    safe_max <span class="main">(</span>
      fst <span class="main">`</span> <span class="main">{</span>
       <span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f <span class="free"><span class="bound"><span class="entity">entry_to_db</span></span></span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
       <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">tas</span> <span class="main">∧</span> <span class="bound">tuple</span> <span class="main">=</span> snd <span class="bound">tas</span>
      <span class="main">}</span>
    <span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"newest_tuple_in_mapping <span class="free">entry_to_db</span> <span class="free">data_in</span> <span class="free">tuple_in</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> valid_tuple <span class="free">tuple_since</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">as</span><span class="main">.</span> Mapping.lookup <span class="free">tuple_in</span> <span class="bound">as</span> <span class="main">=</span> safe_max <span class="main">(</span>fst <span class="main">`</span>
    <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">entry_to_db</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="bound">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> newest_tuple_in_mapping_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">valid_mmsaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'a</span> mmsaux <span class="main">⇒</span> <span class="tfree">'a</span> msaux <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valid_mmsaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">cur</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">⟷</span>
    <span class="main">(</span>args_L <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>args_R <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">maskL</span></span></span> <span class="main">=</span> join_mask <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_L <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">maskR</span></span></span> <span class="main">=</span> join_mask <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_R <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">.</span> table <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_R <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span>
    table <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_R <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>Mapping.keys <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span><span class="main">)</span> <span class="main">∧</span>
    table <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_R <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>Mapping.keys <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">cur</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span> <span class="bound">as</span> <span class="keyword1">of</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span>snd <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_R <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span> <span class="main">∧</span>
    ts_tuple_rel <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span>
      <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
      valid_tuple <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span> <span class="bound">tas</span><span class="main">}</span> <span class="main">∧</span>
    sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">∧</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">∧</span> memL <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    newest_tuple_in_mapping id <span class="free"><span class="bound"><span class="entity">data_in</span></span></span> <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> valid_tuple <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span> <span class="bound">x</span><span class="main">)</span>
  "</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_lookup_filter_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> Mapping.keys <span class="main">(</span>Mapping.filter <span class="free">f</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span>
  Mapping.lookup <span class="main">(</span>Mapping.filter <span class="free">f</span> <span class="free">m</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> Mapping.lookup <span class="free">m</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> default_def insert_subset keys_default keys_filter lookup_default lookup_default_filter<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_filter_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> Mapping.keys <span class="free">m</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Mapping.lookup <span class="free">m</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> Mapping.keys <span class="main">(</span>Mapping.filter <span class="free">f</span> <span class="free">m</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Mapping.lookup <span class="main">(</span>Mapping.filter <span class="free">f</span> <span class="free">m</span><span class="main">)</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Mapping_lookup_filter_keys Mapping.keys_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_filter_keys_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> Mapping.keys <span class="free">m</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>Mapping.lookup <span class="free">m</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> Mapping.keys <span class="free">m</span><span class="main">.</span> <span class="free">P'</span> <span class="main">(</span>Mapping.lookup <span class="free">m</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_keys_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> Mapping.keys <span class="free">f</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> Mapping.lookup <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> Some <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domD keys_dom_lookup<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_keys_intro<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">f</span> <span class="free">x</span> <span class="main">≠</span> None <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> Mapping.keys <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domIff keys_dom_lookup<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_mmsaux_tuple_in_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_mmsaux <span class="free">args</span> <span class="free">cur</span>
  <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">gc</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_since</span><span class="main">)</span> <span class="free">ys</span> <span class="main">⟹</span>
  Mapping.keys <span class="free">tuple_in</span> <span class="main">=</span> snd <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
  valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Mapping_keys_intro safe_max_Some_intro
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Mapping_keys_dest safe_max_Some_dest_in<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_fst_ts_tuple_rel<span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> newest_tuple_in_mapping_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">init_mmsaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> <span class="tfree">'a</span> mmsaux"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">init_mmsaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> join_mask <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_L <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span><span class="main">,</span>
  join_mask <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_R <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span><span class="main">,</span> empty_queue<span class="main">,</span> empty_queue<span class="main">,</span> Mapping.empty<span class="main">,</span> Mapping.empty<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_init_mmsaux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">⊆</span> <span class="free">R</span> <span class="main">⟹</span> valid_mmsaux <span class="main">(</span>init_args <span class="free">I</span> <span class="free">n</span> <span class="free">L</span> <span class="free">R</span> <span class="free">b</span><span class="main">)</span> <span class="main">0</span>
  <span class="main">(</span>init_mmsaux <span class="main">(</span>init_args <span class="free">I</span> <span class="free">n</span> <span class="free">L</span> <span class="free">R</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_args_def empty_queue_rep ts_tuple_rel_f_def join_mask_def
      Mapping.lookup_empty safe_max_def table_def newest_tuple_in_mapping_def<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">filter_cond</span> <span class="free"><span class="bound"><span class="entity">X'</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">as</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="bound">as</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X'</span></span></span> <span class="main">∧</span> Mapping.lookup <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="bound">as</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">filter_cond'</span> <span class="free"><span class="bound"><span class="entity">X'</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">as</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="bound">as</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X'</span></span></span> <span class="main">∧</span> Mapping.lookup <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="bound">as</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">t'</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dropWhile_filter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span>
  dropWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> filter_id_conv<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dropWhile_filter'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">nt</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span>
  dropWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memL <span class="free">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memL <span class="free">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> memL_mono diff_le_mono <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> filter_id_conv<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> takeWhile_filter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span>
  takeWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> memR_antimono <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> filter_empty_conv<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> takeWhile_filter'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">nt</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span>
  takeWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memL <span class="free">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memL <span class="free">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> memL_mono <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> filter_empty_conv<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fold_Mapping_filter_None<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">ts</span> <span class="free">as</span> <span class="main">=</span> None <span class="main">⟹</span>
  Mapping.lookup <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">ts</span><span class="main">.</span> Mapping.filter
  <span class="main">(</span>filter_cond <span class="main">(</span><span class="free">f</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">ts</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">ts</span><span class="main">)</span> <span class="free">ds</span> <span class="free">ts</span><span class="main">)</span> <span class="free">as</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ds</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping.lookup_filter<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_lookup_filter_Some_P<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>Mapping.filter <span class="free">P</span> <span class="free">m</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">k</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping.lookup_filter <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_lookup_filter_None<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="main">¬</span><span class="free">P</span> <span class="free">k</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟹</span>
  Mapping.lookup <span class="main">(</span>Mapping.filter <span class="free">P</span> <span class="free">m</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping.lookup_filter <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_lookup_filter_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="free">P</span> <span class="free">k</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟹</span>
  Mapping.lookup <span class="main">(</span>Mapping.filter <span class="free">P</span> <span class="free">m</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> Mapping.lookup <span class="free">m</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping.lookup_filter <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_lookup_filter_not_None<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>Mapping.filter <span class="free">P</span> <span class="free">m</span><span class="main">)</span> <span class="free">k</span> <span class="main">≠</span> None <span class="main">⟹</span>
  Mapping.lookup <span class="main">(</span>Mapping.filter <span class="free">P</span> <span class="free">m</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> Mapping.lookup <span class="free">m</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping.lookup_filter <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fold_Mapping_filter_Some_None<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">ts</span> <span class="free">as</span> <span class="main">=</span> Some <span class="free">t</span> <span class="main">⟹</span>
  <span class="free">as</span> <span class="main">∈</span> <span class="main">(</span><span class="free">f</span> <span class="free">X</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ds</span> <span class="main">⟹</span>
  Mapping.lookup <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">ts</span><span class="main">.</span> Mapping.filter <span class="main">(</span>filter_cond <span class="main">(</span><span class="free">f</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">ts</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">ts</span><span class="main">)</span> <span class="free">ds</span> <span class="free">ts</span><span class="main">)</span> <span class="free">as</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ds</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">ds</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">t'</span> <span class="skolem">X'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span>
        fold_Mapping_filter_None<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Mapping.filter <span class="main">(</span>filter_cond <span class="main">(</span><span class="free">f</span> <span class="skolem">X'</span><span class="main">)</span> <span class="skolem">ts</span> <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="skolem">ds</span></span><span class="main">]</span>
        Mapping_lookup_filter_not_None<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"filter_cond <span class="main">(</span><span class="free">f</span> <span class="skolem">X'</span><span class="main">)</span> <span class="skolem">ts</span> <span class="skolem">t'</span>"</span></span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quoted"><span class="free">as</span></span><span class="main">]</span>
        fold_Mapping_filter_None<span class="main">[</span><span class="operator">OF</span> Mapping_lookup_filter_None<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="skolem">ds</span></span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>Mapping.filter <span class="main">(</span>filter_cond <span class="main">(</span><span class="free">f</span> <span class="skolem">X'</span><span class="main">)</span> <span class="skolem">ts</span> <span class="skolem">t'</span><span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span> <span class="free">as</span> <span class="main">=</span> None"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> fold_Mapping_filter_Some_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">ts</span> <span class="free">as</span> <span class="main">=</span> Some <span class="free">t</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ds</span> <span class="main">⟹</span> <span class="free">as</span> <span class="main">∉</span> <span class="free">f</span> <span class="bound">X</span><span class="main">)</span> <span class="main">⟹</span>
  Mapping.lookup <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">ts</span><span class="main">.</span> Mapping.filter <span class="main">(</span>filter_cond <span class="main">(</span><span class="free">f</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">ts</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">ts</span><span class="main">)</span> <span class="free">ds</span> <span class="free">ts</span><span class="main">)</span> <span class="free">as</span> <span class="main">=</span> Some <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ds</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ts</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">ds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">t'</span> <span class="skolem">X'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Mapping_lookup_filter_Some<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"filter_cond <span class="main">(</span><span class="free">f</span> <span class="skolem">X'</span><span class="main">)</span> <span class="skolem">ts</span> <span class="skolem">t'</span>"</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="comment1">(*
  1. drops from data_prev and data_in the entries that are no longer inside the interval
  2. for the dropped dbs from data_in we filter a mapping and remove all entries where the entry
     stored points to a dropped db (via the timestamp stored)
*)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">shift_end</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> table<span class="main">)</span>  <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'c</span><span class="main">)</span> queue <span class="main">×</span> <span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> queue <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'b</span> tuple<span class="main">,</span> ts<span class="main">)</span> mapping<span class="main">)</span> <span class="main">×</span> <span class="tfree">'b</span> table<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'c</span><span class="main">)</span> queue <span class="main">×</span> <span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> queue <span class="main">×</span> <span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'b</span> tuple<span class="main">,</span> ts<span class="main">)</span> mapping<span class="main">)</span> <span class="main">×</span> <span class="tfree">'b</span> table<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">shift_end</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="free"><span class="bound"><span class="entity">to_table</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in_keys</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span>
      <span class="bound">data_prev</span> <span class="main">=</span> dropWhile_queue <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">data_in</span><span class="main">,</span> <span class="bound">in_discard</span><span class="main">)</span> <span class="main">=</span> takedropWhile_queue <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">tuple_in</span><span class="main">,</span> <span class="bound">tuple_in_keys'</span><span class="main">)</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">(</span><span class="bound">tuple_in</span><span class="main">,</span> <span class="bound">tuple_in_keys</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>
        <span class="main">(</span>
          Mapping.filter <span class="main">(</span>filter_cond <span class="main">(</span><span class="free"><span class="bound"><span class="entity">to_table</span></span></span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">,</span>
          <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="bound">tuple_in_keys</span><span class="main">.</span> <span class="main">(</span>filter_cond' <span class="main">(</span><span class="free"><span class="bound"><span class="entity">to_table</span></span></span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">as</span><span class="main">}</span>
        <span class="main">)</span>
      <span class="main">)</span><span class="main">)</span> <span class="bound">in_discard</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in_keys</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="main">(</span><span class="bound">data_prev</span><span class="main">,</span> <span class="bound">data_in</span><span class="main">,</span> <span class="bound">in_discard</span><span class="main">,</span> <span class="bound">tuple_in</span><span class="main">,</span> <span class="bound">tuple_in_keys'</span><span class="main">)</span>
    <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">shift_end_mmsaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'a</span> mmsaux <span class="main">⇒</span> <span class="tfree">'a</span> mmsaux"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">shift_end_mmsaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">data_prev'</span><span class="main">,</span> <span class="bound">data_in'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">tuple_in'</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">=</span>
      shift_end
      <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span>
      <span class="free"><span class="bound"><span class="entity">nt</span></span></span>
      id
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span>
    <span class="keyword1">in</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> <span class="bound">data_prev'</span><span class="main">,</span> <span class="bound">data_in'</span><span class="main">,</span> <span class="bound">tuple_in'</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fold_pair_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f1</span> <span class="bound">a</span> <span class="bound">x</span><span class="main">,</span> <span class="free">f2</span> <span class="bound">a</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">as</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="main">(</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f1</span> <span class="bound">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">as</span> <span class="main">(</span><span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> fold.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fold.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> fold_append fst_conv id_o o_apply split_beta<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="comment1">(* since shift_end only affects data_prev, data_in &amp; tuple_in, explicitly write the conditions out *)</span>
<span class="keyword1"><span class="command">lemma</span></span> valid_shift_end_unfolded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> table_tuple_in<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">V1</span> <span class="main">(</span>Mapping.keys <span class="free">tuple_in</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> auxlist_tuples<span class="main">:</span> <span class="quoted"><span class="quoted">"ts_tuple_rel_f <span class="free">f1_auxlist</span> <span class="main">(</span>set <span class="main">(</span><span class="free">filter_auxlist</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> <span class="main">(</span>ts_tuple_rel_f <span class="free">f1_prev</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>ts_tuple_rel_f <span class="free">f1_in</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    <span class="free">P1</span> <span class="bound">tas</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> data_prev_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="free">f2</span> <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">V2</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">t'</span> <span class="main">∧</span> <span class="main">¬</span> memL <span class="free">I</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> data_in_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">t'</span> <span class="main">∧</span> memL <span class="free">I</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> max_ts_tuple_in<span class="main">:</span> <span class="quoted"><span class="quoted">"newest_tuple_in_mapping <span class="free">f3</span> <span class="free">data_in</span> <span class="free">tuple_in</span> <span class="free">P2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nt_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nt</span> <span class="main">≥</span> <span class="free">cur</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> shift_end_appl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">data_prev'</span><span class="main">,</span> <span class="free">data_in'</span><span class="main">,</span> <span class="free">discard</span><span class="main">,</span> <span class="free">tuple_in'</span><span class="main">,</span> <span class="free">tuple_in_keys'</span><span class="main">)</span> <span class="main">=</span> shift_end <span class="free">I</span> <span class="free">nt</span> <span class="free">f3</span> <span class="main">(</span><span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_in_keys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">V1</span> <span class="main">(</span>Mapping.keys <span class="free">tuple_in'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"ts_tuple_rel_f <span class="free">f1_auxlist</span> <span class="main">(</span>set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">rel</span><span class="main">)</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">filter_auxlist</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> <span class="main">(</span>ts_tuple_rel_f <span class="free">f1_prev</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>ts_tuple_rel_f <span class="free">f1_in</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    <span class="free">P1</span> <span class="bound">tas</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="free">f2</span> <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">V2</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">t'</span> <span class="main">∧</span> <span class="main">¬</span> memL <span class="free">I</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_in'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_in'</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">t'</span> <span class="main">∧</span> mem <span class="free">I</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"newest_tuple_in_mapping <span class="free">f3</span> <span class="free">data_in'</span> <span class="free">tuple_in'</span> <span class="free">P2</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">discard</span> <span class="main">=</span> snd <span class="main">(</span>takedropWhile_queue <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">data_in</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"linearize <span class="free">data_in'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">tuple_in_keys</span> <span class="main">=</span> Mapping.keys <span class="free">tuple_in</span> <span class="main">⟹</span> <span class="free">tuple_in_keys'</span> <span class="main">=</span> Mapping.keys <span class="free">tuple_in'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">tuple_in'</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">.</span> Mapping.filter
    <span class="main">(</span>filter_cond <span class="main">(</span><span class="free">f3</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">)</span> <span class="free">discard</span> <span class="free">tuple_in</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>

  <span class="keyword3"><span class="command">show</span></span> discard_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">discard</span> <span class="main">=</span> snd <span class="main">(</span>takedropWhile_queue <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">data_in</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> shift_end_appl
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> shift_end.simps Let_def snd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> data_in'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">data_in'</span> <span class="main">=</span> fst <span class="main">(</span>takedropWhile_queue <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">data_in</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> shift_end_appl
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> shift_end.simps Let_def fst_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> data_prev'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">data_prev'</span> <span class="main">=</span> dropWhile_queue <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">data_prev</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> shift_end_appl takedropWhile_queue_fst<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">data_prev</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> shift_end.simps Let_def fst_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> f_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span>
              <span class="main">(</span><span class="main">(</span><span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">λ</span><span class="bound">tuple_in</span><span class="main">.</span> Mapping.filter <span class="main">(</span>filter_cond <span class="main">(</span><span class="free">f3</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">)</span> <span class="bound">x</span><span class="main">,</span>
               <span class="main">(</span><span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">λ</span><span class="bound">tuple_in</span> <span class="bound">tuple_in_keys</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="bound">tuple_in_keys</span><span class="main">.</span> filter_cond' <span class="main">(</span><span class="free">f3</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span> <span class="bound">as</span><span class="main">}</span><span class="main">)</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 
      <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">(</span><span class="bound">tuple_in</span><span class="main">,</span> <span class="bound">tuple_in_keys</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Mapping.filter <span class="main">(</span>filter_cond <span class="main">(</span><span class="free">f3</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">,</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="bound">tuple_in_keys</span><span class="main">.</span> filter_cond' <span class="main">(</span><span class="free">f3</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span> <span class="bound">as</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> in_fold<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">tuple_in'</span><span class="main">,</span> <span class="free">tuple_in_keys'</span><span class="main">)</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">(</span><span class="bound">tuple_in</span><span class="main">,</span> <span class="bound">tuple_in_keys</span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span>
        Mapping.filter <span class="main">(</span>filter_cond <span class="main">(</span><span class="free">f3</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">,</span>
        <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="bound">tuple_in_keys</span><span class="main">.</span> <span class="main">(</span>filter_cond' <span class="main">(</span><span class="free">f3</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">as</span><span class="main">}</span>
      <span class="main">)</span>
    <span class="main">)</span> <span class="free">discard</span> <span class="main">(</span><span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_in_keys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> shift_end_appl
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> shift_end.simps Let_def snd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">tuple_in'</span> <span class="main">=</span> fst <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">(</span><span class="bound">tuple_in</span><span class="main">,</span> <span class="bound">tuple_in_keys</span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span>
        Mapping.filter <span class="main">(</span>filter_cond <span class="main">(</span><span class="free">f3</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">,</span>
        <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="bound">tuple_in_keys</span><span class="main">.</span> <span class="main">(</span>filter_cond' <span class="main">(</span><span class="free">f3</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">as</span><span class="main">}</span>
      <span class="main">)</span>
    <span class="main">)</span> <span class="free">discard</span> <span class="main">(</span><span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_in_keys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fstI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> tuple_in'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tuple_in'</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">.</span> Mapping.filter
    <span class="main">(</span>filter_cond <span class="main">(</span><span class="free">f3</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">)</span> <span class="free">discard</span> <span class="free">tuple_in</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fold_pair_fst<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">.</span> Mapping.filter <span class="main">(</span>filter_cond <span class="main">(</span><span class="free">f3</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">tuple_in</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">tuple_in_keys</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="bound">tuple_in_keys</span><span class="main">.</span> <span class="main">(</span>filter_cond' <span class="main">(</span><span class="free">f3</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">as</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">discard</span></span> <span class="quoted"><span class="free">tuple_in</span></span> <span class="quoted"><span class="free">tuple_in_keys</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> f_simp<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> tuple_in_Some_None<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span> <span class="bound">t</span> <span class="bound">X</span><span class="main">.</span> Mapping.lookup <span class="free">tuple_in</span> <span class="bound">as</span> <span class="main">=</span> Some <span class="bound">t</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="bound">as</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">f3</span> <span class="bound">X</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">discard</span> <span class="main">⟹</span> Mapping.lookup <span class="free">tuple_in'</span> <span class="bound">as</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fold_Mapping_filter_Some_None <span class="keyword1"><span class="command">unfolding</span></span> tuple_in'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> tuple_in_Some_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span> <span class="bound">t</span><span class="main">.</span> Mapping.lookup <span class="free">tuple_in</span> <span class="bound">as</span> <span class="main">=</span> Some <span class="bound">t</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">discard</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">as</span><span class="main">)</span> <span class="main">∉</span> <span class="free">f3</span> <span class="bound">X</span><span class="main">)</span> <span class="main">⟹</span> Mapping.lookup <span class="free">tuple_in'</span> <span class="bound">as</span> <span class="main">=</span> Some <span class="bound">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fold_Mapping_filter_Some_Some <span class="keyword1"><span class="command">unfolding</span></span> tuple_in'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> tuple_in_None_None<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> Mapping.lookup <span class="free">tuple_in</span> <span class="bound">as</span> <span class="main">=</span> None <span class="main">⟹</span>
    Mapping.lookup <span class="free">tuple_in'</span> <span class="bound">as</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fold_Mapping_filter_None <span class="keyword1"><span class="command">unfolding</span></span> tuple_in'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> tuple_in'_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_in'</span> <span class="main">⟹</span> <span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_in</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tuple_in_Some_None tuple_in_Some_Some tuple_in_None_None
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Mapping_keys_intro <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> F1<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> data_in_props nt_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> F2<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> data_prev_props nt_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> lin_data_in'<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in'</span> <span class="main">=</span>
    filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> data_in'_def<span class="main">[</span><span class="operator">unfolded</span> takedropWhile_queue_fst<span class="main">]</span> dropWhile_queue_rep
      dropWhile_filter<span class="main">[</span><span class="operator">OF</span> F1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">thm</span></span> dropWhile_filter<span class="main">[</span><span class="operator">OF</span> F1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> set_lin_data_in'<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>linearize <span class="free">data_in'</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> sorted_lin_data_in'<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_in'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in' <span class="keyword1"><span class="command">using</span></span> sorted_filter data_in_props<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


  <span class="keyword1"><span class="command">have</span></span> discard_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">discard</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> discard_def<span class="main">[</span><span class="operator">unfolded</span> takedropWhile_queue_snd<span class="main">]</span> takeWhile_filter<span class="main">[</span><span class="operator">OF</span> F1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> lin_data_prev'<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_prev'</span> <span class="main">=</span>
    filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> data_prev'_def<span class="main">[</span><span class="operator">unfolded</span> takedropWhile_queue_fst<span class="main">]</span> dropWhile_queue_rep
      dropWhile_filter<span class="main">[</span><span class="operator">OF</span> F2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> sorted_lin_data_prev'<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lin_data_prev' <span class="keyword1"><span class="command">using</span></span> sorted_filter data_prev_props<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


  <span class="keyword1"><span class="command">have</span></span> lookup_tuple_in'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> Mapping.lookup <span class="free">tuple_in'</span> <span class="bound">as</span> <span class="main">=</span> safe_max <span class="main">(</span>fst <span class="main">`</span>
    <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f3</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">P2</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="bound">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">as</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_in'</span> <span class="skolem">as</span> <span class="main">=</span> safe_max <span class="main">(</span>fst <span class="main">`</span>
    <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f3</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">P2</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_in</span> <span class="skolem">as</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f3</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
        <span class="free">P2</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> max_ts_tuple_in
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> newest_tuple_in_mapping_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> safe_max_empty_dest<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f3</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
        <span class="free">P2</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ts_tuple_rel_mono<span class="main">[</span><span class="operator">OF</span> set_lin_data_in'<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> tuple_in_None_None<span class="main">[</span><span class="operator">OF</span> None<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> iffD2<span class="main">[</span><span class="operator">OF</span> safe_max_empty<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">t</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">discard</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">as</span><span class="main">)</span> <span class="main">∈</span> <span class="free">f3</span> <span class="bound">X</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> X_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">discard</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">as</span><span class="main">)</span> <span class="main">∈</span> <span class="free">f3</span> <span class="skolem">X</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> X_def<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> discard_alt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t'</span><span class="main">.</span> <span class="main">(</span><span class="bound">t'</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f3</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
          <span class="free">P2</span> <span class="main">(</span><span class="bound">t'</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> max_ts_tuple_in Some safe_max_Some_dest_le<span class="main">[</span><span class="operator">OF</span> finite_fst_ts_tuple_rel<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff newest_tuple_in_mapping_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f3</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
          <span class="free">P2</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in' <span class="keyword1"><span class="command">using</span></span> ts_tuple_rel_set_filter
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def memR_antimono<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> tuple_in_Some_None<span class="main">[</span><span class="operator">OF</span> Some X_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> iffD2<span class="main">[</span><span class="operator">OF</span> safe_max_empty<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lookup_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_in'</span> <span class="skolem">as</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> tuple_in_Some_Some<span class="main">[</span><span class="operator">OF</span> Some<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> t_as<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f3</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">P2</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> max_ts_tuple_in Some
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> newest_tuple_in_mapping_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> safe_max_Some_dest_in<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_fst_ts_tuple_rel<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> X_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="free">f3</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> X_def False <span class="keyword1"><span class="command">unfolding</span></span> discard_alt lin_data_in' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t_in_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f3</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
          <span class="free">P2</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> t_as<span class="main">(</span>2<span class="main">)</span> X_def<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def image_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t'</span><span class="main">.</span> <span class="main">(</span><span class="bound">t'</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f3</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
          <span class="free">P2</span> <span class="main">(</span><span class="bound">t'</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> max_ts_tuple_in Some safe_max_Some_dest_le<span class="main">[</span><span class="operator">OF</span> finite_fst_ts_tuple_rel<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff newest_tuple_in_mapping_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f3</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
          <span class="free">P2</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Max_eqI<span class="main">[</span><span class="operator">OF</span> finite_fst_ts_tuple_rel<span class="main">,</span> <span class="operator">OF</span> _ t_in_fst<span class="main">]</span>
            ts_tuple_rel_mono<span class="main">[</span><span class="operator">OF</span> set_lin_data_in'<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> lookup_Some <span class="keyword1"><span class="command">using</span></span> t_in_fst <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_max_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"newest_tuple_in_mapping <span class="free">f3</span> <span class="free">data_in'</span> <span class="free">tuple_in'</span> <span class="free">P2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> newest_tuple_in_mapping_def id_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> table_in<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">V1</span> <span class="main">(</span>Mapping.keys <span class="free">tuple_in'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tuple_in'_keys table_tuple_in
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> table_def<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="free">f2</span> <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">V2</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> data_prev_props<span class="main">(</span>1<span class="main">)</span> lin_data_prev'
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">t'</span> <span class="main">∧</span> <span class="main">¬</span> memL <span class="free">I</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lin_data_prev' data_prev_props
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_in'</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">t'</span> <span class="main">∧</span> mem <span class="free">I</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lin_data_in' data_in_props nt_mono
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ts_tuple_rel_f <span class="free">f1_auxlist</span> <span class="main">(</span>set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">rel</span><span class="main">)</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">filter_auxlist</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> <span class="main">(</span>ts_tuple_rel_f <span class="free">f1_prev</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>ts_tuple_rel_f <span class="free">f1_in</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    <span class="free">P1</span> <span class="bound">tas</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> auxlist_tuples
    <span class="keyword1"><span class="command">unfolding</span></span> lin_data_prev' lin_data_in' ts_tuple_rel_Un ts_tuple_rel_filter
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> option list<span class="main">,</span> ts<span class="main">)</span> mapping <span class="main">×</span> <span class="tfree">'a</span> option list set<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">mapping</span><span class="main">,</span> <span class="bound">mapping_keys</span><span class="main">)</span><span class="main">.</span> <span class="bound">mapping_keys</span> <span class="main">=</span> Mapping.keys <span class="bound">mapping</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tuple_in_keys</span> <span class="main">=</span> Mapping.keys <span class="free">tuple_in</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">(</span><span class="bound">tuple_in</span><span class="main">,</span> <span class="bound">tuple_in_keys</span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span>
        Mapping.filter <span class="main">(</span>filter_cond <span class="main">(</span><span class="free">f3</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">,</span>
        <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="bound">tuple_in_keys</span><span class="main">.</span> <span class="main">(</span>filter_cond' <span class="main">(</span><span class="free">f3</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">as</span><span class="main">}</span>
      <span class="main">)</span>
    <span class="main">)</span> <span class="free">discard</span> <span class="main">(</span><span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_in_keys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">discard</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assm <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">induct</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">induct</span> <span class="main">=</span> <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">(</span><span class="bound">tuple_in</span><span class="main">,</span> <span class="bound">tuple_in_keys</span><span class="main">)</span><span class="main">.</span>
        <span class="main">(</span>
          Mapping.filter <span class="main">(</span>filter_cond <span class="main">(</span><span class="free">f3</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">,</span>
          <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="bound">tuple_in_keys</span><span class="main">.</span> <span class="main">(</span>filter_cond' <span class="main">(</span><span class="free">f3</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">as</span><span class="main">}</span>
        <span class="main">)</span>
      <span class="main">)</span> <span class="skolem">xs</span> <span class="main">(</span><span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_in_keys</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">mapping</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mapping</span> <span class="main">=</span> fst <span class="skolem">induct</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">keys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">keys</span> <span class="main">=</span> snd <span class="skolem">induct</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> induct_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">induct</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">mapping</span><span class="main">,</span> <span class="skolem">keys</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mapping_def keys_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> fst <span class="skolem">x</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> snd <span class="skolem">x</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> x_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> t_def X_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">goal</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">goal</span> <span class="main">=</span> <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">(</span><span class="bound">tuple_in</span><span class="main">,</span> <span class="bound">tuple_in_keys</span><span class="main">)</span><span class="main">.</span>
        <span class="main">(</span>
          Mapping.filter <span class="main">(</span>filter_cond <span class="main">(</span><span class="free">f3</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">,</span>
          <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="bound">tuple_in_keys</span><span class="main">.</span> <span class="main">(</span>filter_cond' <span class="main">(</span><span class="free">f3</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">as</span><span class="main">}</span>
        <span class="main">)</span>
      <span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_in_keys</span><span class="main">)</span><span class="main">)</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> goal_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">goal</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">(</span><span class="bound">tuple_in</span><span class="main">,</span> <span class="bound">tuple_in_keys</span><span class="main">)</span><span class="main">.</span>
        <span class="main">(</span>
          Mapping.filter <span class="main">(</span>filter_cond <span class="main">(</span><span class="free">f3</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">,</span>
          <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="bound">tuple_in_keys</span><span class="main">.</span> <span class="main">(</span>filter_cond' <span class="main">(</span><span class="free">f3</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">as</span><span class="main">}</span>
        <span class="main">)</span>
      <span class="main">)</span> <span class="skolem">x</span> <span class="skolem">induct</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> goal_def induct_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> goal_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">goal</span> <span class="main">=</span> <span class="main">(</span>
          Mapping.filter <span class="main">(</span>filter_cond <span class="main">(</span><span class="free">f3</span> <span class="skolem">X</span><span class="main">)</span> <span class="skolem">mapping</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">mapping</span><span class="main">,</span>
          <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="skolem">keys</span><span class="main">.</span> <span class="main">(</span>filter_cond' <span class="main">(</span><span class="free">f3</span> <span class="skolem">X</span><span class="main">)</span> <span class="skolem">mapping</span> <span class="skolem">t</span><span class="main">)</span> <span class="bound">as</span><span class="main">}</span>
        <span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> x_eq induct_eq
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">induct</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> snoc
        <span class="keyword1"><span class="command">unfolding</span></span> induct_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">keys</span> <span class="main">=</span> Mapping.keys <span class="skolem">mapping</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> induct_eq P_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="skolem">keys</span><span class="main">.</span> <span class="main">(</span>filter_cond' <span class="main">(</span><span class="free">f3</span> <span class="skolem">X</span><span class="main">)</span> <span class="skolem">mapping</span> <span class="skolem">t</span><span class="main">)</span> <span class="bound">as</span><span class="main">}</span> <span class="main">=</span> Mapping.keys <span class="main">(</span>Mapping.filter <span class="main">(</span>filter_cond <span class="main">(</span><span class="free">f3</span> <span class="skolem">X</span><span class="main">)</span> <span class="skolem">mapping</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">mapping</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">as</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="skolem">keys</span><span class="main">.</span> <span class="main">(</span>filter_cond' <span class="main">(</span><span class="free">f3</span> <span class="skolem">X</span><span class="main">)</span> <span class="skolem">mapping</span> <span class="skolem">t</span><span class="main">)</span> <span class="bound">as</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">keys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>filter_cond' <span class="main">(</span><span class="free">f3</span> <span class="skolem">X</span><span class="main">)</span> <span class="skolem">mapping</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">as</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> Mapping.keys <span class="main">(</span>Mapping.filter <span class="main">(</span>filter_cond <span class="main">(</span><span class="free">f3</span> <span class="skolem">X</span><span class="main">)</span> <span class="skolem">mapping</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">mapping</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> IH
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> Mapping_keys_dest Mapping_keys_intro Mapping_lookup_filter_Some option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">as</span>
          <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> Mapping.keys <span class="main">(</span>Mapping.filter <span class="main">(</span>filter_cond <span class="main">(</span><span class="free">f3</span> <span class="skolem">X</span><span class="main">)</span> <span class="skolem">mapping</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">mapping</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> Mapping.keys <span class="skolem">mapping</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>z3<span class="main"><span class="main">)</span></span> Mapping_lookup_filter_not_None domIff keys_dom_lookup<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>filter_cond' <span class="main">(</span><span class="free">f3</span> <span class="skolem">X</span><span class="main">)</span> <span class="skolem">mapping</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">as</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assm
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Mapping_lookup_filter_None domIff keys_dom_lookup<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="skolem">keys</span><span class="main">.</span> <span class="main">(</span>filter_cond' <span class="main">(</span><span class="free">f3</span> <span class="skolem">X</span><span class="main">)</span> <span class="skolem">mapping</span> <span class="skolem">t</span><span class="main">)</span> <span class="bound">as</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> IH<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">goal</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> P_def goal_eq
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> goal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">(</span><span class="free">tuple_in'</span><span class="main">,</span> <span class="free">tuple_in_keys'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> in_fold
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">tuple_in_keys'</span> <span class="main">=</span> Mapping.keys <span class="free">tuple_in'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> P_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> valid_shift_end_mmsaux_unfolded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_before<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_mmsaux <span class="free">args</span> <span class="free">cur</span>
    <span class="main">(</span><span class="free">ot</span><span class="main">,</span> <span class="free">gc</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_since</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nt_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nt</span> <span class="main">≥</span> <span class="free">cur</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_mmsaux <span class="free">args</span> <span class="free">cur</span> <span class="main">(</span>shift_end_mmsaux <span class="free">args</span> <span class="free">nt</span>
    <span class="main">(</span><span class="free">ot</span><span class="main">,</span> <span class="free">gc</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_since</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">rel</span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">shift_res</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">shift_res</span> <span class="main">=</span> shift_end <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="free">nt</span> id <span class="main">(</span><span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">data_prev'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">data_prev'</span> <span class="main">=</span> fst <span class="skolem">shift_res</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">data_in'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">data_in'</span> <span class="main">=</span> <span class="main">(</span>fst <span class="keyword1">o</span> snd<span class="main">)</span> <span class="skolem">shift_res</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">in_discard</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">in_discard</span> <span class="main">=</span> <span class="main">(</span>fst <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="skolem">shift_res</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tuple_in'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_in'</span> <span class="main">=</span> <span class="main">(</span>fst <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="skolem">shift_res</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tuple_in_keys'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_in_keys'</span> <span class="main">=</span> <span class="main">(</span>snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="skolem">shift_res</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> shift_end_res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">data_prev'</span><span class="main">,</span> <span class="skolem">data_in'</span><span class="main">,</span> <span class="skolem">in_discard</span><span class="main">,</span> <span class="skolem">tuple_in'</span><span class="main">,</span> <span class="skolem">tuple_in_keys'</span><span class="main">)</span> <span class="main">=</span> shift_end <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="free">nt</span> id <span class="main">(</span><span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> data_prev'_def data_in'_def in_discard_def tuple_in'_def tuple_in_keys'_def shift_res_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> table_tuple_in<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Mapping.keys <span class="free">tuple_in</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ts_tuple_rel <span class="main">(</span>set <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> auxlist_tuples<span class="main">:</span> <span class="quoted"><span class="quoted">"ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>id <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> <span class="main">(</span>ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_Un id_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span>snd <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">cur</span> <span class="main">∧</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> valid_mmsaux.simps<span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> data_prev_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>id <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">cur</span> <span class="main">∧</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> data_in_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">cur</span> <span class="main">∧</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> max_ts_tuple_in<span class="main">:</span> <span class="quoted"><span class="quoted">"newest_tuple_in_mapping id <span class="free">data_in</span> <span class="free">tuple_in</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> valid_tuple <span class="free">tuple_since</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> time<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cur</span> <span class="main">=</span> <span class="free">ot</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> nt_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nt</span> <span class="main">≥</span> <span class="free">cur</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">cur</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nt_mono
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_mmsaux <span class="free">args</span> <span class="free">cur</span>
    <span class="main">(</span><span class="free">ot</span><span class="main">,</span> <span class="free">gc</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="skolem">data_prev'</span><span class="main">,</span> <span class="skolem">data_in'</span><span class="main">,</span> <span class="skolem">tuple_in'</span><span class="main">,</span> <span class="free">tuple_since</span><span class="main">)</span>
    <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">rel</span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before nt_mono
      valid_shift_end_unfolded <span class="main">[</span><span class="operator">of</span>
        <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span></span></span>args_n <span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free">args</span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span></span></span>"</span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span></span></span>args_R <span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free">args</span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span></span></span>"</span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">tuple_in</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">id</span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">id</span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">auxlist</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">id</span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">data_prev</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">id</span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">data_in</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>
        <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"valid_tuple <span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free">tuple_since</span></span></span></span></span></span></span></span></span></span></span></span>"</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">,</span>
        <span class="operator">OF</span> table_tuple_in auxlist_tuples data_prev_props
        data_in_props max_ts_tuple_in nt_mono shift_end_res
      <span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> valid_mmsaux.simps time<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_Un<span class="main">)</span>
  <span class="comment1">(* is slow *)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ot</span><span class="main">,</span> <span class="free">gc</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="skolem">data_prev'</span><span class="main">,</span> <span class="skolem">data_in'</span><span class="main">,</span> <span class="skolem">tuple_in'</span><span class="main">,</span> <span class="free">tuple_since</span><span class="main">)</span> <span class="main">=</span>
    shift_end_mmsaux <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span><span class="free">ot</span><span class="main">,</span> <span class="free">gc</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_since</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> shift_res_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>
        shift_end_mmsaux.simps Let_def data_prev'_def data_in'_def tuple_in'_def fst_def snd_def o_def
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits
    <span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_shift_end_mmsaux<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_mmsaux <span class="free">args</span> <span class="free">cur</span> <span class="free">aux</span> <span class="free">auxlist</span> <span class="main">⟹</span> <span class="free">nt</span> <span class="main">≥</span> <span class="free">cur</span> <span class="main">⟹</span>
  valid_mmsaux <span class="free">args</span> <span class="free">cur</span> <span class="main">(</span>shift_end_mmsaux <span class="free">args</span> <span class="free">nt</span> <span class="free">aux</span><span class="main">)</span>
  <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">rel</span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> valid_shift_end_mmsaux_unfolded <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">aux</span></span><span class="main">)</span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_mapping

<span class="keyword1"><span class="command">lift_definition</span></span> upd_set <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> mapping <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> mapping"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">m</span> <span class="bound">f</span> <span class="bound">X</span> <span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> <span class="bound">X</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="bound">f</span> <span class="bound">a</span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">m</span> <span class="bound">a</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_lookup_upd_set<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>upd_set <span class="free">m</span> <span class="free">f</span> <span class="free">X</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">X</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="keyword1">else</span> Mapping.lookup <span class="free">m</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping.lookup.rep_eq upd_set.rep_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_upd_set_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.keys <span class="main">(</span>upd_set <span class="free">m</span> <span class="free">f</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> Mapping.keys <span class="free">m</span> <span class="main">∪</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_lookup_upd_set <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Mapping_keys_dest <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Mapping_keys_intro<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> upd_keys_on <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> mapping <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> mapping"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">m</span> <span class="bound">f</span> <span class="bound">X</span> <span class="bound">a</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="bound">m</span> <span class="bound">a</span> <span class="keyword1">of</span> Some <span class="bound">b</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> <span class="bound">X</span> <span class="keyword1">then</span> <span class="bound">f</span> <span class="bound">a</span> <span class="bound">b</span> <span class="keyword1">else</span> <span class="bound">b</span><span class="main">)</span>
  <span class="main">|</span> None <span class="main">⇒</span> None"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_lookup_upd_keys_on<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>upd_keys_on <span class="free">m</span> <span class="free">f</span> <span class="free">X</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="free">m</span> <span class="free">a</span> <span class="keyword1">of</span> Some <span class="bound">b</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">X</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="free">a</span> <span class="bound">b</span> <span class="keyword1">else</span> <span class="bound">b</span><span class="main">)</span> <span class="main">|</span> None <span class="main">⇒</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping.lookup.rep_eq upd_keys_on.rep_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_upd_keys_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.keys <span class="main">(</span>upd_keys_on <span class="free">m</span> <span class="free">f</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> Mapping.keys <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_lookup_upd_keys_on <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Mapping_keys_dest <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Mapping_keys_intro
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fold_append_queue_rep<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">q</span><span class="main">.</span> append_queue <span class="bound">x</span> <span class="bound">q</span><span class="main">)</span> <span class="free">xs</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> linearize <span class="free">q</span> <span class="main">@</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_queue_rep<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Max_Un_absorb<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">≤</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> Max <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> Max_X_in_X<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="free">X</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Max_in<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> Max_X_in_XY<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="free">X</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Max_in<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> Y_le_Max_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">≤</span> Max <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ Max_X_in_X<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> XY_le_Max_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">≤</span> Max <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Max_ge<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> Y_le_Max_X <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Max_eqI<span class="main">[</span><span class="operator">OF</span> fin XY_le_Max_X Max_X_in_XY<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_lookup_fold_upd_set_idle<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound"><span class="bound">t</span></span><span class="main">,</span> <span class="bound"><span class="bound">X</span></span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">as</span> <span class="main">∈</span> <span class="free">Z</span> <span class="bound">X</span> <span class="bound">t</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
  Mapping.lookup <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">m</span><span class="main">.</span> upd_set <span class="bound">m</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="free">Z</span> <span class="bound">X</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="free">m</span><span class="main">)</span> <span class="free">as</span> <span class="main">=</span> Mapping.lookup <span class="free">m</span> <span class="free">as</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x1</span></span> <span class="skolem"><span class="skolem">x2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">m</span><span class="main">.</span> upd_set <span class="bound">m</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="free">Z</span> <span class="bound">X</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">(</span>upd_set <span class="skolem">m</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">(</span><span class="free">Z</span> <span class="skolem">x2</span> <span class="skolem">x1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">as</span> <span class="main">=</span>
    Mapping.lookup <span class="main">(</span>upd_set <span class="skolem">m</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">(</span><span class="free">Z</span> <span class="skolem">x2</span> <span class="skolem">x1</span><span class="main">)</span><span class="main">)</span> <span class="free">as</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>upd_set <span class="skolem">m</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">(</span><span class="free">Z</span> <span class="skolem">x2</span> <span class="skolem">x1</span><span class="main">)</span><span class="main">)</span> <span class="free">as</span> <span class="main">=</span> Mapping.lookup <span class="skolem">m</span> <span class="free">as</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span>›</span></span> Mapping_lookup_upd_set<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_lookup_fold_upd_set_max<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound"><span class="bound">t</span></span><span class="main">,</span> <span class="bound"><span class="bound">X</span></span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">as</span> <span class="main">∈</span> <span class="free">Z</span> <span class="bound">X</span> <span class="bound">t</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span>
  sorted <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span>
  Mapping.lookup <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">m</span><span class="main">.</span> upd_set <span class="bound">m</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="free">Z</span> <span class="bound">X</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="free">m</span><span class="main">)</span> <span class="free">as</span> <span class="main">=</span>
  Some <span class="main">(</span>Max <span class="main">(</span>fst <span class="main">`</span> <span class="main">{</span><span class="main">(</span><span class="bound"><span class="bound">t</span></span><span class="main">,</span> <span class="bound"><span class="bound">X</span></span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">as</span> <span class="main">∈</span> <span class="free">Z</span> <span class="bound">X</span> <span class="bound">t</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> tX_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> set_fst_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">`</span> <span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∧</span> <span class="free">as</span> <span class="main">∈</span> <span class="free">Z</span> <span class="bound">X</span> <span class="bound">t</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">(</span>fst <span class="main">`</span> <span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">xs</span> <span class="main">∧</span> <span class="free">as</span> <span class="main">∈</span> <span class="free">Z</span> <span class="bound">X</span> <span class="bound">t</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">as</span> <span class="main">∈</span> <span class="free">Z</span> <span class="skolem">X</span> <span class="skolem">t</span> <span class="keyword1">then</span> <span class="main">{</span><span class="skolem">t</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> image_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tX_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">xs</span> <span class="main">∧</span> <span class="free">as</span> <span class="main">∈</span> <span class="free">Z</span> <span class="bound">X</span> <span class="bound">t</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">xs</span> <span class="main">∧</span> <span class="free">as</span> <span class="main">∈</span> <span class="free">Z</span> <span class="bound">X</span> <span class="bound">t</span><span class="main">}</span> <span class="main">⊆</span> set <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>fst <span class="main">`</span> <span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">xs</span> <span class="main">∧</span> <span class="free">as</span> <span class="main">∈</span> <span class="free">Z</span> <span class="bound">X</span> <span class="bound">t</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>insert <span class="skolem">t</span> <span class="main">(</span>fst <span class="main">`</span> <span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">xs</span> <span class="main">∧</span> <span class="free">as</span> <span class="main">∈</span> <span class="free">Z</span> <span class="bound">X</span> <span class="bound">t</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      Max <span class="main">(</span>fst <span class="main">`</span> <span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">xs</span> <span class="main">∧</span> <span class="free">as</span> <span class="main">∈</span> <span class="free">Z</span> <span class="bound">X</span> <span class="bound">t</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Max_Un_absorb<span class="main">[</span><span class="operator">OF</span> fin<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">t</span><span class="main">}</span>"</span></span><span class="main">]</span> True Cons<span class="main">(</span>3<span class="main">)</span> tX_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons True <span class="keyword1"><span class="command">unfolding</span></span> set_fst_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">xs</span> <span class="main">∧</span> <span class="free">as</span> <span class="main">∈</span> <span class="free">Z</span> <span class="bound">X</span> <span class="bound">t</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∈</span> <span class="free">Z</span> <span class="skolem">X</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> set_fst_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Mapping_lookup_fold_upd_set_idle<span class="main">[</span><span class="operator">OF</span> empty<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> set_fst_eq empty
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_lookup_upd_set tX_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
                                            
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">add_new_ts_past</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> ts <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> table<span class="main">)</span> <span class="main">⇒</span>
  <span class="main">(</span><span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> queue <span class="main">×</span> <span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> queue <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'b</span> tuple<span class="main">,</span> ts<span class="main">)</span> mapping<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'b</span> tuple<span class="main">,</span> ts<span class="main">)</span> mapping<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span>
  <span class="main">(</span><span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> queue <span class="main">×</span> <span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> queue <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'b</span> tuple<span class="main">,</span> ts<span class="main">)</span> mapping<span class="main">)</span><span class="main">)</span>
"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_new_ts_past</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">data_prev</span><span class="main">,</span> <span class="bound">move</span><span class="main">)</span> <span class="main">=</span> takedropWhile_queue <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">;</span>
    <span class="bound">data_in</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">data_in</span><span class="main">.</span> append_queue <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">data_in</span><span class="main">)</span> <span class="bound">move</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">;</span>
    <span class="bound">tuple_in</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">.</span> upd_set <span class="bound">tuple_in</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">t</span><span class="main">)</span>
      <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">X</span><span class="main">.</span> valid_tuple <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="bound">move</span> <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="bound">data_prev</span><span class="main">,</span> <span class="bound">data_in</span><span class="main">,</span> <span class="bound">tuple_in</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">add_new_ts_mmsaux'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'a</span> mmsaux <span class="main">⇒</span> <span class="tfree">'a</span> mmsaux"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_new_ts_mmsaux'</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">data_prev</span><span class="main">,</span> <span class="bound">data_in</span><span class="main">,</span> <span class="bound">tuple_in</span><span class="main">)</span> <span class="main">=</span> add_new_ts_past <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> id <span class="main">(</span><span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span><span class="main">)</span>
    <span class="keyword1">in</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> <span class="bound">data_prev</span><span class="main">,</span> <span class="bound">data_in</span><span class="main">,</span> <span class="bound">tuple_in</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span><span class="main">)</span>
<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_keys_fold_upd_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> Mapping.keys <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">m</span><span class="main">.</span> upd_set <span class="bound">m</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="free">Z</span> <span class="bound">t</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>
  <span class="free">xs</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">∈</span> Mapping.keys <span class="free">m</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">k</span> <span class="main">∈</span> <span class="free">Z</span> <span class="bound">t</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_upd_set_keys<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="comment1">(* add_new_ts_mmsaux' only changes data_prev, data_in &amp; tuple_in. write conditions explicitly *)</span>
<span class="keyword1"><span class="command">lemma</span></span> valid_add_new_ts_past_unfolded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> table_tuple_in<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Mapping.keys <span class="free">tuple_in</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> auxlist_tuples<span class="main">:</span> <span class="quoted"><span class="quoted">"ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> data_prev_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">cur</span> <span class="main">∧</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> data_in_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">cur</span> <span class="main">∧</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> max_ts_tuple_in<span class="main">:</span> <span class="quoted"><span class="quoted">"newest_tuple_in_mapping <span class="free">f</span> <span class="free">data_in</span> <span class="free">tuple_in</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> valid_tuple <span class="free">tuple_since</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nt_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nt</span> <span class="main">≥</span> <span class="free">cur</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> add_new_ts_appl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">data_prev'</span><span class="main">,</span> <span class="free">data_in'</span><span class="main">,</span> <span class="free">tuple_in'</span><span class="main">)</span> <span class="main">=</span> add_new_ts_past <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="free">nt</span> <span class="free">f</span> <span class="main">(</span><span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_since</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Mapping.keys <span class="free">tuple_in'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span>"</span></span>
    <span class="quoted"><span class="quoted">"ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>linearize <span class="free">data_in'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span> <span class="main">∧</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_in'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_in'</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span> <span class="main">∧</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"newest_tuple_in_mapping <span class="free">f</span> <span class="free">data_in'</span> <span class="free">tuple_in'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> valid_tuple <span class="free">tuple_since</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> args_ivl <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> args_n <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> args_L <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> args_R <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pos</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pos</span> <span class="main">=</span> args_pos <span class="free">args</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> data_prev'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">data_prev'</span> <span class="main">=</span> fst <span class="main">(</span>takedropWhile_queue <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memL <span class="skolem">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">data_prev</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> add_new_ts_appl
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> add_new_ts_past.simps Let_def fst_def I_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">move</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">move</span> <span class="main">≡</span> snd <span class="main">(</span>takedropWhile_queue <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memL <span class="skolem">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">data_prev</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> data_in'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">data_in'</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">data_in</span><span class="main">.</span> append_queue <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">data_in</span><span class="main">)</span> <span class="skolem">move</span> <span class="free">data_in</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> add_new_ts_appl move_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> add_new_ts_past.simps Let_def snd_def I_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> tuple_in'_def<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">tuple_in'</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">.</span> upd_set <span class="bound">tuple_in</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">t</span><span class="main">)</span>
      <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="free">f</span> <span class="bound">X</span><span class="main">.</span> valid_tuple <span class="free">tuple_since</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="skolem">move</span> <span class="free">tuple_in</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> add_new_ts_appl move_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> add_new_ts_past.simps Let_def snd_def I_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> tuple_in'_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_in'</span> <span class="main">⟹</span> <span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_in</span> <span class="main">∨</span>
    <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">move</span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="free">f</span> <span class="bound">X</span><span class="main">.</span> valid_tuple <span class="free">tuple_since</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Mapping_keys_fold_upd_set<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span> <span class="bound">X</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="free">f</span> <span class="bound">X</span><span class="main">.</span> valid_tuple <span class="free">tuple_since</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">}</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tuple_in'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> F1<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">cur</span> <span class="main">∧</span> memL <span class="skolem">I</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> data_in_props nt_mono <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> F2<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">cur</span> <span class="main">∧</span> <span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> data_prev_props nt_mono <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 
  <span class="keyword1"><span class="command">have</span></span> lin_data_prev'<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_prev'</span> <span class="main">=</span>
    filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> data_prev'_def<span class="main">[</span><span class="operator">unfolded</span> takedropWhile_queue_fst<span class="main">]</span> dropWhile_queue_rep dropWhile_filter'<span class="main">[</span><span class="operator">OF</span> F2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> move_filter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">move</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memL <span class="skolem">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> move_def<span class="main">[</span><span class="operator">unfolded</span> takedropWhile_queue_snd<span class="main">]</span> takeWhile_filter'<span class="main">[</span><span class="operator">OF</span> F2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sorted_move<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="skolem">move</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sorted_filter F2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>fst <span class="main">`</span> set <span class="skolem">move</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">cur</span> <span class="main">∧</span> <span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> move_filter F2<span class="main">(</span>3<span class="main">)</span> set_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fst_set_before<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t'</span><span class="main">∈</span>fst <span class="main">`</span> set <span class="skolem">move</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="bound">t'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> F1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> le_diff_iff' memL_mono nat_le_linear<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fst_ts_tuple_rel_before<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>fst <span class="main">`</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    <span class="main">∀</span><span class="bound">t'</span><span class="main">∈</span>fst <span class="main">`</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="skolem">move</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="bound">t'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> sorted_lin_data_prev'<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lin_data_prev' <span class="keyword1"><span class="command">using</span></span> sorted_filter F2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lin_data_in'<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in'</span> <span class="main">=</span> linearize <span class="free">data_in</span> <span class="main">@</span> <span class="skolem">move</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> data_in'_def <span class="keyword1"><span class="command">using</span></span> fold_append_queue_rep <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> sorted_lin_data_in'<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_in'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in' <span class="keyword1"><span class="command">using</span></span> F1<span class="main">(</span>1<span class="main">)</span> sorted_move fst_set_before <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_append<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> set_lin_prev'_in'<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>linearize <span class="free">data_in'</span><span class="main">)</span> <span class="main">=</span>
    set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lin_data_prev' lin_data_in' move_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> ts_tuple_rel'<span class="main">:</span> <span class="quoted"><span class="quoted">"ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>linearize <span class="free">data_in'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> set_lin_prev'_in' <span class="keyword1"><span class="command">using</span></span> auxlist_tuples <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lookup'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> Mapping.lookup <span class="free">tuple_in'</span> <span class="bound">as</span> <span class="main">=</span> safe_max <span class="main">(</span>fst <span class="main">`</span>
    <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="bound">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">as</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_in'</span> <span class="skolem">as</span> <span class="main">=</span> safe_max <span class="main">(</span>fst <span class="main">`</span>
      <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
      valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound"><span class="bound">t</span></span><span class="main">,</span> <span class="bound"><span class="bound">X</span></span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">move</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="free">f</span> <span class="bound">X</span> <span class="main">∧</span> valid_tuple <span class="free">tuple_since</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> move_absorb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
        valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span> <span class="main">=</span>
        <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span> <span class="main">@</span> <span class="skolem">move</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
        valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_in</span> <span class="skolem">as</span> <span class="main">=</span>
        safe_max <span class="main">(</span>fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
        valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> max_ts_tuple_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> newest_tuple_in_mapping_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_in</span> <span class="skolem">as</span> <span class="main">=</span>
        safe_max <span class="main">(</span>fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
        valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in' move_absorb <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Mapping_lookup_fold_upd_set_idle<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">move</span>"</span></span> <span class="quoted"><span class="skolem">as</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">X</span> <span class="bound">t</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="free">f</span> <span class="bound">X</span><span class="main">.</span> valid_tuple <span class="free">tuple_since</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">}</span>"</span></span><span class="main">]</span> True
        <span class="keyword1"><span class="command">unfolding</span></span> tuple_in'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
        valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span> <span class="main">=</span>
        fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="skolem">move</span><span class="main">)</span><span class="main">.</span> valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span> <span class="main">∪</span>
        fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
        valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in' set_append ts_tuple_rel_Un <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> max_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="skolem">move</span><span class="main">)</span><span class="main">.</span>
        valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
        Max <span class="main">(</span>fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
        valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> split <span class="keyword1"><span class="command">using</span></span> False fst_ts_tuple_rel_before
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Max_Un_absorb<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_fst_ts_tuple_rel _ finite_fst_ts_tuple_rel<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> <span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">move</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="free">f</span> <span class="bound">X</span><span class="main">.</span> valid_tuple <span class="free">tuple_since</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span>
        fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="skolem">move</span><span class="main">)</span><span class="main">.</span> valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def image_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_in'</span> <span class="skolem">as</span> <span class="main">=</span> Some <span class="main">(</span>Max <span class="main">(</span>fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f <span class="free">f</span> <span class="main">(</span>set <span class="skolem">move</span><span class="main">)</span><span class="main">.</span>
        valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Mapping_lookup_fold_upd_set_max<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">move</span>"</span></span> <span class="quoted"><span class="skolem">as</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">X</span> <span class="bound">t</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="free">f</span> <span class="bound">X</span><span class="main">.</span> valid_tuple <span class="free">tuple_since</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">}</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> _ sorted_move<span class="main">]</span> False
        <span class="keyword1"><span class="command">unfolding</span></span> tuple_in'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> max_eq <span class="keyword1"><span class="command">using</span></span> False
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_max_def lin_data_in' ts_tuple_rel_f_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"newest_tuple_in_mapping <span class="free">f</span> <span class="free">data_in'</span> <span class="free">tuple_in'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> valid_tuple <span class="free">tuple_since</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> newest_tuple_in_mapping_def id_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> table_in'<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>Mapping.keys <span class="free">tuple_in'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">as</span>
      <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_in'</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">as</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> tuple_in'_keys<span class="main">[</span><span class="operator">OF</span> assm<span class="main">]</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_in</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">as</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> table_tuple_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> table_def n_def R_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">move</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="free">f</span> <span class="bound">X</span><span class="main">.</span> valid_tuple <span class="free">tuple_since</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> tX_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">move</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="free">f</span> <span class="skolem">X</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memL <span class="skolem">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> move_def <span class="keyword1"><span class="command">using</span></span> takedropWhile_queue_snd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memL <span class="skolem">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">data_prev</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> move_def <span class="keyword1"><span class="command">using</span></span> set_takeWhileD tX_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">as</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> data_prev_props<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def R_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> table_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Mapping.keys <span class="free">tuple_in'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n_def R_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> data_prev'_move<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">data_prev'</span><span class="main">,</span> <span class="skolem">move</span><span class="main">)</span> <span class="main">=</span>
    takedropWhile_queue <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memL <span class="skolem">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">data_prev</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> takedropWhile_queue_fst takedropWhile_queue_snd data_prev'_def move_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surjective_pairing<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> data_prev_props
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> data_prev_props lin_data_prev'
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span> <span class="main">∧</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> data_prev_props lin_data_prev' nt_mono
    <span class="keyword1"><span class="command">unfolding</span></span> I_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_in'</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span> <span class="main">∧</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lin_data_in' move_filter nt_mono data_in_props data_prev_props <span class="keyword1"><span class="command">unfolding</span></span> I_def
    <span class="comment1">(* by (auto simp add: memL_mono) is slower *)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> I_def Un_iff case_prod_beta' diff_commute diff_diff_cancel diff_le_self imageE image_eqI le_trans memL_mono move_def set_append set_takeWhileD takedropWhile_queue_snd<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_add_new_ts_mmsaux'_unfolded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_before<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_mmsaux <span class="free">args</span> <span class="free">cur</span>
    <span class="main">(</span><span class="free">ot</span><span class="main">,</span> <span class="free">gc</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_since</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> nt_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nt</span> <span class="main">≥</span> <span class="free">cur</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_mmsaux <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>add_new_ts_mmsaux' <span class="free">args</span> <span class="free">nt</span>
    <span class="main">(</span><span class="free">ot</span><span class="main">,</span> <span class="free">gc</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_since</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">res</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">res</span> <span class="main">=</span> add_new_ts_past <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="free">nt</span> id <span class="main">(</span><span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_since</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">data_prev'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">data_prev'</span> <span class="main">=</span> fst <span class="skolem">res</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">data_in'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">data_in'</span> <span class="main">=</span> <span class="main">(</span>fst <span class="keyword1">o</span> snd<span class="main">)</span> <span class="skolem">res</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tuple_in'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_in'</span> <span class="main">=</span> <span class="main">(</span>snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="skolem">res</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cur</span> <span class="main">=</span> <span class="free">ot</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> shift_end_res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">data_prev'</span><span class="main">,</span> <span class="skolem">data_in'</span><span class="main">,</span> <span class="skolem">tuple_in'</span><span class="main">)</span> <span class="main">=</span> add_new_ts_past <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="free">nt</span> id <span class="main">(</span><span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_since</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> data_prev'_def data_in'_def tuple_in'_def res_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> table_tuple_in<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Mapping.keys <span class="free">tuple_in</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> auxlist_tuples<span class="main">:</span> <span class="quoted"><span class="quoted">"ts_tuple_rel_f id <span class="main">(</span>set <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_f id <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> data_prev_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>id <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">cur</span> <span class="main">∧</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> data_in_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">cur</span> <span class="main">∧</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> max_ts_tuple_in<span class="main">:</span> <span class="quoted"><span class="quoted">"newest_tuple_in_mapping id <span class="free">data_in</span> <span class="free">tuple_in</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> valid_tuple <span class="free">tuple_since</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> since_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_since</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">tuple_since</span> <span class="bound">as</span> <span class="keyword1">of</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">ot</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">as</span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_since</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> Mapping.lookup <span class="free">tuple_since</span> <span class="skolem">as</span> <span class="keyword1">of</span> Some <span class="bound">t</span> <span class="main">⇒</span> True"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> Mapping.lookup <span class="free">tuple_since</span> <span class="skolem">as</span> <span class="keyword1">of</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_since</span> <span class="skolem">as</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> since_map assm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">t</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> <span class="free">ot</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> since_map assm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nt_mono t <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_since</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">tuple_since</span> <span class="bound">as</span> <span class="keyword1">of</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Mapping_keys_dest <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>


  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_mmsaux <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">gc</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="skolem">data_prev'</span><span class="main">,</span> <span class="skolem">data_in'</span><span class="main">,</span> <span class="skolem">tuple_in'</span><span class="main">,</span> <span class="free">tuple_since</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_add_new_ts_past_unfolded<span class="main">[</span><span class="operator">OF</span> table_tuple_in auxlist_tuples data_prev_props
          data_in_props max_ts_tuple_in nt_mono shift_end_res<span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> valid_mmsaux.simps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="comment1">(* is slow *)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">gc</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="skolem">data_prev'</span><span class="main">,</span> <span class="skolem">data_in'</span><span class="main">,</span> <span class="skolem">tuple_in'</span><span class="main">,</span> <span class="free">tuple_since</span><span class="main">)</span> <span class="main">=</span>
    add_new_ts_mmsaux' <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span><span class="free">ot</span><span class="main">,</span> <span class="free">gc</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_since</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>
        add_new_ts_mmsaux'.simps Let_def data_prev'_def data_in'_def tuple_in'_def res_def fst_def snd_def o_def
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits
    <span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_add_new_ts_mmsaux'<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_mmsaux <span class="free">args</span> <span class="free">cur</span> <span class="free">aux</span> <span class="free">auxlist</span> <span class="main">⟹</span> <span class="free">nt</span> <span class="main">≥</span> <span class="free">cur</span> <span class="main">⟹</span>
  valid_mmsaux <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>add_new_ts_mmsaux' <span class="free">args</span> <span class="free">nt</span> <span class="free">aux</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> valid_add_new_ts_mmsaux'_unfolded <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">aux</span></span><span class="main">)</span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">add_new_ts_mmsaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'a</span> mmsaux <span class="main">⇒</span> <span class="tfree">'a</span> mmsaux"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_new_ts_mmsaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">=</span> add_new_ts_mmsaux' <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">(</span>shift_end_mmsaux <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_add_new_ts_mmsaux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_mmsaux <span class="free">args</span> <span class="free">cur</span> <span class="free">aux</span> <span class="free">auxlist</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">nt</span> <span class="main">≥</span> <span class="free">cur</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_mmsaux <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>add_new_ts_mmsaux <span class="free">args</span> <span class="free">nt</span> <span class="free">aux</span><span class="main">)</span>
    <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">rel</span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> valid_add_new_ts_mmsaux'<span class="main">[</span><span class="operator">OF</span> valid_shift_end_mmsaux<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_new_ts_mmsaux_def <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">join_mmsaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> <span class="tfree">'a</span> mmsaux <span class="main">⇒</span> <span class="tfree">'a</span> mmsaux"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">join_mmsaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">pos</span> <span class="main">=</span> args_pos <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span> <span class="keyword1">then</span>
      <span class="main">(</span><span class="keyword1">let</span> <span class="bound">tuple_in</span> <span class="main">=</span> Mapping.filter <span class="main">(</span>join_filter_cond <span class="bound">pos</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span><span class="main">;</span>
      <span class="bound">tuple_since</span> <span class="main">=</span> Mapping.filter <span class="main">(</span>join_filter_cond <span class="bound">pos</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span> <span class="keyword1">in</span>
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">,</span> <span class="bound">tuple_in</span><span class="main">,</span> <span class="bound">tuple_since</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">.</span> <span class="main">¬</span><span class="bound">i</span><span class="main">)</span> <span class="keyword1">then</span>
      <span class="main">(</span><span class="keyword1">let</span> <span class="bound">nones</span> <span class="main">=</span> replicate <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">)</span> None<span class="main">;</span>
      <span class="bound">take_all</span> <span class="main">=</span> <span class="main">(</span><span class="bound">pos</span> <span class="main">⟷</span> <span class="bound">nones</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="bound">tuple_in</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">take_all</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span> <span class="keyword1">else</span> Mapping.empty<span class="main">)</span><span class="main">;</span>
      <span class="bound">tuple_since</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">take_all</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span> <span class="keyword1">else</span> Mapping.empty<span class="main">)</span> <span class="keyword1">in</span>
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">,</span> <span class="bound">tuple_in</span><span class="main">,</span> <span class="bound">tuple_since</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="main">(</span><span class="keyword1">let</span> <span class="bound">tuple_in</span> <span class="main">=</span> Mapping.filter <span class="main">(</span><span class="main">λ</span><span class="bound">as</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> proj_tuple_in_join <span class="bound">pos</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span> <span class="bound">as</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span><span class="main">;</span>
      <span class="bound">tuple_since</span> <span class="main">=</span> Mapping.filter <span class="main">(</span><span class="main">λ</span><span class="bound">as</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> proj_tuple_in_join <span class="bound">pos</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span> <span class="bound">as</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span> <span class="keyword1">in</span>
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">,</span> <span class="bound">tuple_in</span><span class="main">,</span> <span class="bound">tuple_since</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">join_mmsaux_abs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> <span class="tfree">'a</span> mmsaux <span class="main">⇒</span> <span class="tfree">'a</span> mmsaux"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">join_mmsaux_abs</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">pos</span> <span class="main">=</span> args_pos <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">tuple_in</span> <span class="main">=</span> Mapping.filter <span class="main">(</span><span class="main">λ</span><span class="bound">as</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> proj_tuple_in_join <span class="bound">pos</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span> <span class="bound">as</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span><span class="main">;</span>
    <span class="bound">tuple_since</span> <span class="main">=</span> Mapping.filter <span class="main">(</span><span class="main">λ</span><span class="bound">as</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> proj_tuple_in_join <span class="bound">pos</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span> <span class="bound">as</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">,</span> <span class="bound">tuple_in</span><span class="main">,</span> <span class="bound">tuple_since</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_filter_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">k</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> Mapping.keys <span class="free">m</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">k</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">f'</span> <span class="bound">k</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Mapping.filter <span class="free">f</span> <span class="free">m</span> <span class="main">=</span> Mapping.filter <span class="free">f'</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> Mapping.lookup <span class="main">(</span>Mapping.filter <span class="free">f</span> <span class="free">m</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> Mapping.lookup <span class="main">(</span>Mapping.filter <span class="free">f'</span> <span class="free">m</span><span class="main">)</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cong
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping.lookup_filter <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Mapping_keys_intro <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mapping_eqI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> join_mmsaux_abs_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_before<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_mmsaux <span class="free">args</span> <span class="free">cur</span>
    <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">gc</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_since</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> table_left<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"join_mmsaux <span class="free">args</span> <span class="free">X</span> <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">gc</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_since</span><span class="main">)</span> <span class="main">=</span>
    join_mmsaux_abs <span class="free">args</span> <span class="free">X</span> <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">gc</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_since</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">maskL</span> <span class="main">=</span> <span class="free">maskR</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> args_n <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> args_L <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pos</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pos</span> <span class="main">=</span> args_pos <span class="free">args</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> keys_wf_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_in</span> <span class="main">⟹</span> wf_tuple <span class="skolem">n</span> <span class="skolem">L</span> <span class="bound">as</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_tuple_change_base valid_before True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> table_def n_def L_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> cong_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_in</span> <span class="main">⟹</span>
    proj_tuple_in_join <span class="skolem">pos</span> <span class="free">maskL</span> <span class="bound">as</span> <span class="free">X</span> <span class="main">⟷</span> join_cond <span class="skolem">pos</span> <span class="free">X</span> <span class="bound">as</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> proj_tuple_in_join_mask_idle<span class="main">[</span><span class="operator">OF</span> keys_wf_in<span class="main">]</span> valid_before
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> valid_mmsaux.simps n_def L_def pos_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> keys_wf_since<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_since</span> <span class="main">⟹</span> wf_tuple <span class="skolem">n</span> <span class="skolem">L</span> <span class="bound">as</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_tuple_change_base valid_before True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> table_def n_def L_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> cong_since<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_since</span> <span class="main">⟹</span>
    proj_tuple_in_join <span class="skolem">pos</span> <span class="free">maskL</span> <span class="bound">as</span> <span class="free">X</span> <span class="main">⟷</span> join_cond <span class="skolem">pos</span> <span class="free">X</span> <span class="bound">as</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> proj_tuple_in_join_mask_idle<span class="main">[</span><span class="operator">OF</span> keys_wf_since<span class="main">]</span> valid_before
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> valid_mmsaux.simps n_def L_def pos_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> True Mapping_filter_cong<span class="main">[</span><span class="operator">OF</span> cong_in<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">tuple_in</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">k</span>"</span></span><span class="main">]</span>
      Mapping_filter_cong<span class="main">[</span><span class="operator">OF</span> cong_since<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">tuple_since</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">k</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pos_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> args_n <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> args_L <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> args_R <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pos</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pos</span> <span class="main">=</span> args_pos <span class="free">args</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> set <span class="free">maskL</span><span class="main">.</span> <span class="main">¬</span><span class="bound">i</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> length_maskL<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">maskL</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_mask_def n_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> proj_rep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> wf_tuple <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">as</span> <span class="main">⟹</span> proj_tuple <span class="free">maskL</span> <span class="bound">as</span> <span class="main">=</span> replicate <span class="main">(</span>length <span class="free">maskL</span><span class="main">)</span> None"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True proj_tuple_replicate <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_maskL wf_tuple_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> keys_wf_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_in</span> <span class="main">⟹</span> wf_tuple <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">as</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> table_def n_def R_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> keys_wf_since<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_since</span> <span class="main">⟹</span> wf_tuple <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">as</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> table_def n_def R_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> Mapping.lookup <span class="main">(</span>Mapping.filter <span class="main">(</span><span class="main">λ</span><span class="bound">as</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> proj_tuple_in_join <span class="skolem">pos</span> <span class="free">maskL</span> <span class="bound">as</span> <span class="free">X</span><span class="main">)</span>
      <span class="free">tuple_in</span><span class="main">)</span> <span class="bound">as</span> <span class="main">=</span> Mapping.lookup <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="skolem">pos</span> <span class="main">⟷</span> replicate <span class="main">(</span>length <span class="free">maskL</span><span class="main">)</span> None <span class="main">∈</span> <span class="free">X</span><span class="main">)</span>
      <span class="keyword1">then</span> <span class="free">tuple_in</span> <span class="keyword1">else</span> Mapping.empty<span class="main">)</span> <span class="bound">as</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> proj_rep<span class="main">[</span><span class="operator">OF</span> keys_wf_in<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping.lookup_filter Mapping.lookup_empty proj_tuple_in_join_def
          Mapping_keys_intro <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> Mapping.lookup <span class="main">(</span>Mapping.filter <span class="main">(</span><span class="main">λ</span><span class="bound">as</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> proj_tuple_in_join <span class="skolem">pos</span> <span class="free">maskL</span> <span class="bound">as</span> <span class="free">X</span><span class="main">)</span>
      <span class="free">tuple_since</span><span class="main">)</span> <span class="bound">as</span> <span class="main">=</span> Mapping.lookup <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="skolem">pos</span> <span class="main">⟷</span> replicate <span class="main">(</span>length <span class="free">maskL</span><span class="main">)</span> None <span class="main">∈</span> <span class="free">X</span><span class="main">)</span>
      <span class="keyword1">then</span> <span class="free">tuple_since</span> <span class="keyword1">else</span> Mapping.empty<span class="main">)</span> <span class="bound">as</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> proj_rep<span class="main">[</span><span class="operator">OF</span> keys_wf_since<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping.lookup_filter Mapping.lookup_empty proj_tuple_in_join_def
          Mapping_keys_intro <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> False True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mapping_eqI Let_def pos_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_join_mmsaux_unfolded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_before<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_mmsaux <span class="free">args</span> <span class="free">cur</span>
    <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">gc</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_since</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> table_left'<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_mmsaux <span class="free">args</span> <span class="free">cur</span>
    <span class="main">(</span>join_mmsaux <span class="free">args</span> <span class="free">X</span> <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">gc</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_since</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">rel</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> join <span class="bound">rel</span> <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> args_n <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> args_L <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> args_R <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pos</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pos</span> <span class="main">=</span> args_pos <span class="free">args</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> table_left <span class="main">=</span> table_left'<span class="main">[</span><span class="operator">unfolded</span> n_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> L_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tuple_in'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_in'</span> <span class="main">≡</span>
    Mapping.filter <span class="main">(</span><span class="main">λ</span><span class="bound">as</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> proj_tuple_in_join <span class="skolem">pos</span> <span class="free">maskL</span> <span class="bound">as</span> <span class="free">X</span><span class="main">)</span> <span class="free">tuple_in</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tuple_since'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_since'</span> <span class="main">≡</span>
    Mapping.filter <span class="main">(</span><span class="main">λ</span><span class="bound">as</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> proj_tuple_in_join <span class="skolem">pos</span> <span class="free">maskL</span> <span class="bound">as</span> <span class="free">X</span><span class="main">)</span> <span class="free">tuple_since</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> tuple_in_None_None<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> Mapping.lookup <span class="free">tuple_in</span> <span class="bound">as</span> <span class="main">=</span> None <span class="main">⟹</span>
    Mapping.lookup <span class="skolem">tuple_in'</span> <span class="bound">as</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tuple_in'_def <span class="keyword1"><span class="command">using</span></span> Mapping_lookup_filter_not_None <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> tuple_in'_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="skolem">tuple_in'</span> <span class="main">⟹</span> <span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_in</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tuple_in_None_None
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Mapping_keys_intro <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> tuple_since_None_None<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> Mapping.lookup <span class="free">tuple_since</span> <span class="bound">as</span> <span class="main">=</span> None <span class="main">⟹</span>
    Mapping.lookup <span class="skolem">tuple_since'</span> <span class="bound">as</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tuple_since'_def <span class="keyword1"><span class="command">using</span></span> Mapping_lookup_filter_not_None <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> tuple_since'_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="skolem">tuple_since'</span> <span class="main">⟹</span> <span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_since</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tuple_since_None_None
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Mapping_keys_intro <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ts_tuple_rel'<span class="main">:</span> <span class="quoted"><span class="quoted">"ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">rel</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> join <span class="bound">rel</span> <span class="skolem">pos</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tas</span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tas</span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">rel</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> join <span class="bound">rel</span> <span class="skolem">pos</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">Z</span></span> <span class="keyword2"><span class="keyword">where</span></span> tas_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tas</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> join <span class="skolem">Z</span> <span class="skolem">pos</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">auxlist</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> join <span class="skolem">Z</span> <span class="skolem">pos</span> <span class="free">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">rel</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> join <span class="bound">rel</span> <span class="skolem">pos</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> tas_def<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> table_Z<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">Z</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def R_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> proj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">Z</span>"</span></span> <span class="quoted"><span class="quoted">"proj_tuple_in_join <span class="skolem">pos</span> <span class="free">maskL</span> <span class="skolem">as</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tas_def<span class="main">(</span>2<span class="main">)</span> join_sub<span class="main">[</span><span class="operator">OF</span> _ table_left table_Z<span class="main">]</span> valid_before
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def L_def R_def pos_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span><span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tas_def<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tas_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">∈</span> ts_tuple_rel
      <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"valid_tuple <span class="free">tuple_since</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_since</span> <span class="skolem">as</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≥</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_tuple_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> valid_tuple_since'<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_tuple <span class="skolem">tuple_since'</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> proj<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tuple_since'_def Mapping_lookup_filter_Some valid_tuple_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tas</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
      valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tas_in valid_tuple_since' <span class="keyword1"><span class="command">unfolding</span></span> tas_def<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tas</span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tas</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel
      <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> tas_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tas</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"valid_tuple <span class="skolem">tuple_since'</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> tas_def<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_tuple <span class="free">tuple_since</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> tuple_since'_def <span class="keyword1"><span class="command">using</span></span> Mapping_lookup_filter_not_None
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_tuple_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="free">auxlist</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_before assm tas_def<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Z</span></span> <span class="keyword2"><span class="keyword">where</span></span> Z_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">Z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">auxlist</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> table_Z<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">Z</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def R_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> tas_def<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"proj_tuple_in_join <span class="skolem">pos</span> <span class="free">maskL</span> <span class="skolem">as</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> tuple_since'_def <span class="keyword1"><span class="command">using</span></span> Mapping_lookup_filter_Some_P
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_tuple_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> as_in_join<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> join <span class="skolem">Z</span> <span class="skolem">pos</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> join_sub<span class="main">[</span><span class="operator">OF</span> _ table_left table_Z<span class="main">]</span> Z_def<span class="main">(</span>1<span class="main">)</span> valid_before
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def L_def R_def pos_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tas</span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">rel</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> join <span class="bound">rel</span> <span class="skolem">pos</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Z_def <span class="keyword1"><span class="command">unfolding</span></span> tas_def<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> lookup_tuple_in'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> Mapping.lookup <span class="skolem">tuple_in'</span> <span class="bound">as</span> <span class="main">=</span> safe_max <span class="main">(</span>fst <span class="main">`</span>
    <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="bound">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">as</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">tuple_in'</span> <span class="skolem">as</span> <span class="main">=</span> safe_max <span class="main">(</span>fst <span class="main">`</span>
    <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_in</span> <span class="skolem">as</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
        valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid_before
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> newest_tuple_in_mapping_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> safe_max_empty_dest<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
        valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Mapping_lookup_filter_not_None
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_tuple_def tuple_since'_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> tuple_in_None_None<span class="main">[</span><span class="operator">OF</span> None<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> iffD2<span class="main">[</span><span class="operator">OF</span> safe_max_empty<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">t</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"proj_tuple_in_join <span class="skolem">pos</span> <span class="free">maskL</span> <span class="skolem">as</span> <span class="free">X</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lookup_tuple_in'<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">tuple_in'</span> <span class="skolem">as</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Some <span class="keyword1"><span class="command">unfolding</span></span> tuple_in'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_lookup_filter_Some<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"valid_tuple <span class="free">tuple_since</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> valid_before Some
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> newest_tuple_in_mapping_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> safe_max_Some_dest_in<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_fst_ts_tuple_rel<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t_in_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
          valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff valid_tuple_def tuple_since'_def
            Mapping_lookup_filter_Some <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t'</span><span class="main">.</span> valid_tuple <span class="skolem">tuple_since'</span> <span class="main">(</span><span class="bound">t'</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">⟹</span> valid_tuple <span class="free">tuple_since</span> <span class="main">(</span><span class="bound">t'</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Mapping_lookup_filter_not_None
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_tuple_def tuple_since'_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t'</span><span class="main">.</span> <span class="main">(</span><span class="bound">t'</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
          valid_tuple <span class="skolem">tuple_since'</span> <span class="main">(</span><span class="bound">t'</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> valid_before Some safe_max_Some_dest_le<span class="main">[</span><span class="operator">OF</span> finite_fst_ts_tuple_rel<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff newest_tuple_in_mapping_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
          valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Max_eqI<span class="main">[</span><span class="operator">OF</span> finite_fst_ts_tuple_rel<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span>
            <span class="operator">OF</span> _ t_in_fst<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> lookup_tuple_in' <span class="keyword1"><span class="command">using</span></span> t_in_fst <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_max_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lookup_tuple'<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">tuple_in'</span> <span class="skolem">as</span> <span class="main">=</span> None"</span></span>
          <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">tuple_since'</span> <span class="skolem">as</span> <span class="main">=</span> None"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> tuple_in'_def tuple_since'_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_lookup_filter_None<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">tas</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span>valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_tuple_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> lookup_tuple' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_max_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> table_join'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">auxlist</span> <span class="main">⟹</span> table <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>join <span class="bound">ys</span> <span class="skolem">pos</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">ys</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">auxlist</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> table_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_before
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def L_def R_def pos_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>join <span class="skolem">ys</span> <span class="skolem">pos</span> <span class="free">X</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> join_table<span class="main">[</span><span class="operator">OF</span> table_ys table_left<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">pos</span></span> <span class="quoted"><span class="skolem">R</span></span><span class="main">]</span> valid_before
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def L_def R_def pos_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> table_in'<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>Mapping.keys <span class="skolem">tuple_in'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tuple_in'_keys valid_before
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def L_def R_def pos_def table_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> table_since'<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>Mapping.keys <span class="skolem">tuple_since'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tuple_since'_keys valid_before
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def L_def R_def pos_def table_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> join_mmsaux_abs_eq<span class="main">[</span><span class="operator">OF</span> valid_before table_left'<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> valid_before ts_tuple_rel' lookup_tuple_in' tuple_in'_def tuple_since'_def table_join'
      Mapping_filter_keys<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">tuple_since</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">as</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">as</span> <span class="keyword1">of</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span><span class="main">]</span>
      table_in' table_since'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def L_def R_def pos_def table_def Let_def newest_tuple_in_mapping_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_join_mmsaux<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_mmsaux <span class="free">args</span> <span class="free">cur</span> <span class="free">aux</span> <span class="free">auxlist</span> <span class="main">⟹</span>
  table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="free">X</span> <span class="main">⟹</span> valid_mmsaux <span class="free">args</span> <span class="free">cur</span>
  <span class="main">(</span>join_mmsaux <span class="free">args</span> <span class="free">X</span> <span class="free">aux</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">rel</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> join <span class="bound">rel</span> <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> valid_join_mmsaux_unfolded <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">aux</span></span><span class="main">)</span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">gc_mmsaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mmsaux <span class="main">⇒</span> <span class="tfree">'a</span> mmsaux"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gc_mmsaux</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">all_tuples</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>snd <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">tuple_since'</span> <span class="main">=</span> Mapping.filter <span class="main">(</span><span class="main">λ</span><span class="bound">as</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> <span class="bound">all_tuples</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span><span class="main">,</span> <span class="bound">tuple_since'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_gc_mmsaux_unfolded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_before<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_mmsaux <span class="free">args</span> <span class="free">cur</span> <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">gc</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span>
    <span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_since</span><span class="main">)</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_mmsaux <span class="free">args</span> <span class="free">cur</span> <span class="main">(</span>gc_mmsaux <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">gc</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span>
    <span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_since</span><span class="main">)</span><span class="main">)</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> args_n <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> args_L <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> args_R <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pos</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pos</span> <span class="main">=</span> args_pos <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">all_tuples</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">all_tuples</span> <span class="main">≡</span> <span class="main">⋃</span><span class="main">(</span>snd <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">∪</span>
    set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tuple_since'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_since'</span> <span class="main">≡</span> Mapping.filter <span class="main">(</span><span class="main">λ</span><span class="bound">as</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> <span class="skolem">all_tuples</span><span class="main">)</span> <span class="free">tuple_since</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> tuple_since_None_None<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> Mapping.lookup <span class="free">tuple_since</span> <span class="bound">as</span> <span class="main">=</span> None <span class="main">⟹</span>
    Mapping.lookup <span class="skolem">tuple_since'</span> <span class="bound">as</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tuple_since'_def <span class="keyword1"><span class="command">using</span></span> Mapping_lookup_filter_not_None <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> tuple_since'_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="skolem">tuple_since'</span> <span class="main">⟹</span> <span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_since</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tuple_since_None_None
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Mapping_keys_intro <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> table_since'<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>Mapping.keys <span class="skolem">tuple_since'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> table_def n_def R_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> data_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">tas</span><span class="main">.</span> <span class="bound">tas</span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">∪</span>
    set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span> <span class="main">=</span> valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tas</span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tas</span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">∪</span>
    set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≡</span> fst <span class="skolem">tas</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">≡</span> snd <span class="skolem">tas</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">all_tuples</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> as_def all_tuples_def ts_tuple_rel_f_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">tuple_since'</span> <span class="skolem">as</span> <span class="main">=</span> Mapping.lookup <span class="free">tuple_since</span> <span class="skolem">as</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tuple_since'_def Mapping.lookup_filter <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"valid_tuple <span class="skolem">tuple_since'</span> <span class="skolem">tas</span> <span class="main">=</span> valid_tuple <span class="free">tuple_since</span> <span class="skolem">tas</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_tuple_def as_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> data_in_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">tas</span><span class="main">.</span> <span class="bound">tas</span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
    valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span> <span class="main">=</span> valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_Un<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ts_tuple_rel <span class="main">(</span>set <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> data_cong valid_before <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span><span class="main">.</span> Mapping.lookup <span class="free">tuple_in</span> <span class="bound">as</span> <span class="main">=</span> safe_max <span class="main">(</span>fst <span class="main">`</span>
    <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="bound">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> newest_tuple_in_mapping_def<span class="main">)</span> <span class="main">(</span><span class="operator">meson</span> data_in_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="skolem">tuple_since'</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">tuple_since'</span> <span class="bound">as</span> <span class="keyword1">of</span>
    Some <span class="bound">t</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Mapping.keys_filter valid_before
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tuple_since'_def Mapping.lookup_filter <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Mapping_keys_intro <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> all_tuples_def tuple_since'_def valid_before table_since'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> n_def R_def newest_tuple_in_mapping_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_gc_mmsaux<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_mmsaux <span class="free">args</span> <span class="free">cur</span> <span class="free">aux</span> <span class="free">ys</span> <span class="main">⟹</span> valid_mmsaux <span class="free">args</span> <span class="free">cur</span> <span class="main">(</span>gc_mmsaux <span class="free">aux</span><span class="main">)</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> valid_gc_mmsaux_unfolded <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">aux</span></span><span class="main">)</span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">gc_join_mmsaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> <span class="tfree">'a</span> mmsaux <span class="main">⇒</span> <span class="tfree">'a</span> mmsaux"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gc_join_mmsaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span><span class="main">)</span> <span class="keyword1">then</span> join_mmsaux <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>gc_mmsaux <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span>
      <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> join_mmsaux <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gc_join_mmsaux_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"gc_join_mmsaux <span class="free">args</span> <span class="free">rel1</span> <span class="free">aux</span> <span class="main">=</span> join_mmsaux <span class="free">args</span> <span class="free">rel1</span> <span class="main">(</span>gc_mmsaux <span class="free">aux</span><span class="main">)</span> <span class="main">∨</span>
  gc_join_mmsaux <span class="free">args</span> <span class="free">rel1</span> <span class="free">aux</span> <span class="main">=</span> join_mmsaux <span class="free">args</span> <span class="free">rel1</span> <span class="free">aux</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">aux</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> gc_join_mmsaux.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_gc_join_mmsaux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_mmsaux <span class="free">args</span> <span class="free">cur</span> <span class="free">aux</span> <span class="free">auxlist</span>"</span></span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="free">rel1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_mmsaux <span class="free">args</span> <span class="free">cur</span> <span class="main">(</span>gc_join_mmsaux <span class="free">args</span> <span class="free">rel1</span> <span class="free">aux</span><span class="main">)</span>
    <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">rel</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> join <span class="bound">rel</span> <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="free">rel1</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gc_join_mmsaux_alt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">args</span></span> <span class="quoted"><span class="free">rel1</span></span> <span class="quoted"><span class="free">aux</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> valid_join_mmsaux<span class="main">[</span><span class="operator">OF</span> valid_gc_mmsaux<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    valid_join_mmsaux<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">add_new_table_mmsaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> <span class="tfree">'a</span> mmsaux <span class="main">⇒</span> <span class="tfree">'a</span> mmsaux"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_new_table_mmsaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">tuple_since</span> <span class="main">=</span> upd_set <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">-</span> Mapping.keys <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="keyword1">if</span> memL <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">,</span> append_queue <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">,</span>
      upd_set <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">,</span> <span class="bound">tuple_since</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> append_queue <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span><span class="main">,</span> <span class="bound">tuple_since</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_add_new_table_mmsaux_unfolded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_before<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_mmsaux <span class="free">args</span> <span class="free">cur</span>
    <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">gc</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_since</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> table_X<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_mmsaux <span class="free">args</span> <span class="free">cur</span> <span class="main">(</span>add_new_table_mmsaux <span class="free">args</span> <span class="free">X</span>
    <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">gc</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_since</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free">auxlist</span> <span class="keyword1">of</span>
      <span class="main">[]</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">(</span><span class="free">cur</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span><span class="main">]</span>
    <span class="main">|</span> <span class="main">(</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">#</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">t</span> <span class="main">=</span> <span class="free">cur</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span> <span class="main">∪</span> <span class="free">X</span><span class="main">)</span> <span class="main">#</span> <span class="bound">ts</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">cur</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">#</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> cur_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cur</span> <span class="main">=</span> <span class="free">nt</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> args_ivl <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> args_n <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> args_L <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> args_R <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pos</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pos</span> <span class="main">=</span> args_pos <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tuple_in'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_in'</span> <span class="main">≡</span> upd_set <span class="free">tuple_in</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">nt</span><span class="main">)</span> <span class="free">X</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tuple_since'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_since'</span> <span class="main">≡</span> upd_set <span class="free">tuple_since</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">nt</span><span class="main">)</span>
    <span class="main">(</span><span class="free">X</span> <span class="main">-</span> Mapping.keys <span class="free">tuple_since</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">data_prev'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">data_prev'</span> <span class="main">≡</span> append_queue <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="free">data_prev</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">data_in'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">data_in'</span> <span class="main">≡</span> append_queue <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="free">data_in</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">auxlist'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">auxlist'</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">auxlist</span> <span class="keyword1">of</span>
    <span class="main">[]</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span><span class="main">]</span>
    <span class="main">|</span> <span class="main">(</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">#</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">t</span> <span class="main">=</span> <span class="free">nt</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span> <span class="main">∪</span> <span class="free">X</span><span class="main">)</span> <span class="main">#</span> <span class="bound">ts</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">#</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> table_in'<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>Mapping.keys <span class="skolem">tuple_in'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> table_X valid_before
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> table_def tuple_in'_def Mapping_upd_set_keys n_def R_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> table_since'<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>Mapping.keys <span class="skolem">tuple_since'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> table_X valid_before
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> table_def tuple_since'_def Mapping_upd_set_keys n_def R_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> tuple_since'_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.keys <span class="free">tuple_since</span> <span class="main">⊆</span> Mapping.keys <span class="skolem">tuple_since'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Mapping_upd_set_keys <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tuple_since'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> lin_data_prev'<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="skolem">data_prev'</span> <span class="main">=</span> linearize <span class="free">data_prev</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> data_prev'_def append_queue_rep <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> wf_data_prev'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span>snd <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_prev'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> wf_tuple <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">as</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lin_data_prev' <span class="keyword1"><span class="command">using</span></span> table_X valid_before
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> table_def n_def R_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> lin_data_in'<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="skolem">data_in'</span> <span class="main">=</span> linearize <span class="free">data_in</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> data_in'_def append_queue_rep <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> table_auxlist'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">auxlist'</span><span class="main">.</span> table <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> table_X table_Un valid_before
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> auxlist'_def n_def R_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> lookup_tuple_since'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="skolem">tuple_since'</span><span class="main">.</span>
    <span class="keyword1">case</span> Mapping.lookup <span class="skolem">tuple_since'</span> <span class="bound">as</span> <span class="keyword1">of</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tuple_since'_def <span class="keyword1"><span class="command">using</span></span> valid_before Mapping_lookup_upd_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">tuple_since</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Mapping_keys_intro <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ts_tuple_rel_auxlist'<span class="main">:</span> <span class="quoted"><span class="quoted">"ts_tuple_rel <span class="main">(</span>set <span class="skolem">auxlist'</span><span class="main">)</span> <span class="main">=</span>
    ts_tuple_rel <span class="main">(</span>set <span class="free">auxlist</span><span class="main">)</span> <span class="main">∪</span> ts_tuple_rel <span class="main">{</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def
    <span class="keyword1"><span class="command">using</span></span> ts_tuple_rel_ext<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted">id</span><span class="main">]</span> ts_tuple_rel_ext'<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted">id</span><span class="main">]</span>
      ts_tuple_rel_ext_Cons ts_tuple_rel_ext_Cons'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> valid_tuple_nt_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">tas</span><span class="main">.</span> <span class="bound">tas</span> <span class="main">∈</span> ts_tuple_rel <span class="main">{</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span><span class="main">}</span> <span class="main">⟹</span> valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def valid_tuple_def tuple_since'_def
        Mapping_lookup_upd_set <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> valid_tuple_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">tas</span><span class="main">.</span> valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span> <span class="main">⟹</span> valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_tuple_def tuple_since'_def Mapping_lookup_upd_set
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Mapping_keys_intro <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ts_tuple_rel_auxlist'<span class="main">:</span> <span class="quoted"><span class="quoted">"ts_tuple_rel <span class="main">(</span>set <span class="skolem">auxlist'</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">.</span>
    valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tas</span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tas</span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tas</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">∪</span>
      set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assm<span class="main">[</span><span class="operator">unfolded</span> ts_tuple_rel_auxlist' ts_tuple_rel_Un<span class="main">]</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> UnE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tas</span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="free">auxlist</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tas</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">∪</span>
        set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tas</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">∪</span>
        set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_Un <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valid_tuple_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tas</span> <span class="main">∈</span> ts_tuple_rel <span class="main">{</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tas</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">∪</span>
        set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assm valid_before <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_Un tuple_since'_def
            valid_tuple_def Mapping_lookup_upd_set ts_tuple_rel_f_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest
            <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tas</span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tas</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">∪</span>
      set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tas</span> <span class="main">∈</span> <span class="main">(</span>ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">∪</span>
      set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> ts_tuple_rel <span class="main">{</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">∪</span> ts_tuple_rel <span class="main">{</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_Un<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tas</span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> UnE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> assm'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tas</span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">∪</span>
        set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> ts_tuple_rel <span class="main">{</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tas_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tas</span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">∪</span>
        set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> tas_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tas</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">tas</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assm' <span class="keyword1"><span class="command">unfolding</span></span> tas_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t_le_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> valid_tas<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_tuple <span class="skolem">tuple_since'</span> <span class="skolem">tas</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_tuple <span class="free">tuple_since</span> <span class="skolem">tas</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_since</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> valid_tas tas_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_tuple_def tuple_since'_def
              Mapping_lookup_upd_set <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="free">nt</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> valid_tas t_le_nt <span class="keyword1"><span class="command">unfolding</span></span> tas_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_tuple_def tuple_since'_def Mapping_lookup_upd_set
              <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Mapping_keys_intro <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assm' <span class="keyword1"><span class="command">unfolding</span></span> tas_def ts_tuple_rel_f_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def id_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tas</span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> tas_in valid_before <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_auxlist'<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_auxlist'<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"memL <span class="skolem">I</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> add_def<span class="main">:</span> <span class="quoted"><span class="quoted">"add_new_table_mmsaux <span class="free">args</span> <span class="free">X</span> <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">gc</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span>
      <span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_since</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">gc</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="skolem">data_in'</span><span class="main">,</span>
      <span class="skolem">tuple_in'</span><span class="main">,</span> <span class="skolem">tuple_since'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> data_in'_def tuple_in'_def tuple_since'_def <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span> <span class="main">∧</span> memL <span class="skolem">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_before True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lin_data_in'<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> Mapping.lookup <span class="skolem">tuple_in'</span> <span class="bound">as</span> <span class="main">=</span> safe_max <span class="main">(</span>fst <span class="main">`</span>
      <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
      valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="bound">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">as</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">tuple_in'</span> <span class="skolem">as</span> <span class="main">=</span> safe_max <span class="main">(</span>fst <span class="main">`</span>
        <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
        valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="free">X</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_tuple <span class="skolem">tuple_since'</span> <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True valid_before <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_tuple_def tuple_since'_def
              Mapping_lookup_upd_set <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>insert <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> nt_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nt</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>insert <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span>
          <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_tuple <span class="skolem">tuple_since'</span> <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>insert <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="free">nt</span> <span class="main">=</span> fst <span class="bound">p</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>insert <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span>
            <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">p</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">p</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">nt</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>insert <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
            valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">p</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">p</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>insert <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span>
          <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
            <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> eq_imp_le fst_conv insertE ts_tuple_rel_dest<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>
          <span class="main">∪</span> set <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">nt</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Max_eqI<span class="main">[</span><span class="operator">OF</span> finite_fst_ts_tuple_rel<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"linearize <span class="skolem">data_in'</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span>
              <span class="operator">unfolded</span> lin_data_in' set_append<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> Un_empty_right Un_insert_right empty_set list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> nt_in True
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tuple_in'_def Mapping_lookup_upd_set safe_max_def lin_data_in'<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
          valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span> <span class="main">=</span>
          <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
          valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lin_data_in' ts_tuple_rel_f_def valid_tuple_def
              tuple_since'_def Mapping_lookup_upd_set <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Mapping_keys_intro
              <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> valid_before False
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tuple_in'_def Mapping_lookup_upd_set newest_tuple_in_mapping_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms table_auxlist' sorted_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"map fst <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span><span class="main">]</span>
        lookup_tuple_since' ts_tuple_rel_auxlist' table_in' table_since'
      <span class="keyword1"><span class="command">unfolding</span></span> add_def auxlist'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> cur_nt I_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> valid_mmsaux.simps lin_data_in' n_def R_def newest_tuple_in_mapping_def<span class="main">)</span>
          <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> add_def<span class="main">:</span> <span class="quoted"><span class="quoted">"add_new_table_mmsaux <span class="free">args</span> <span class="free">X</span> <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">gc</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span>
      <span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_since</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">gc</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="skolem">data_prev'</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span>
      <span class="free">tuple_in</span><span class="main">,</span> <span class="skolem">tuple_since'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> data_prev'_def tuple_since'_def <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="skolem">data_prev'</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span> <span class="main">∧</span> <span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_before False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lin_data_prev' I_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
      valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="bound">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span> <span class="main">=</span>
      <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
      valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="bound">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">as</span> <span class="skolem">tas</span>
      <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tas</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
        valid_tuple <span class="skolem">tuple_since'</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">Z</span></span> <span class="keyword2"><span class="keyword">where</span></span> Z_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tas</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">Z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"valid_tuple <span class="skolem">tuple_since'</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tas</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
        valid_tuple <span class="free">tuple_since</span> <span class="bound">tas</span> <span class="main">∧</span> <span class="skolem">as</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assm
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_since</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≥</span> <span class="free">nt</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Z_def<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_tuple_def tuple_since'_def
              Mapping_lookup_upd_set <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Mapping_keys_intro <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> Z_def<span class="main">(</span>3<span class="main">)</span> valid_before <span class="quoted"><span class="quoted">‹<span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_tuple_def tuple_since'_def Mapping_lookup_upd_set
           <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_lookup_upd_set valid_tuple_def tuple_since'_def
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Mapping_keys_intro <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms table_auxlist' sorted_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"map fst <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span><span class="main">]</span>
        False lookup_tuple_since' ts_tuple_rel_auxlist' table_in' table_since' wf_data_prev'
        valid_before
      <span class="keyword1"><span class="command">unfolding</span></span> add_def auxlist'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> cur_nt I_def n_def R_def
        valid_mmsaux.simps newest_tuple_in_mapping_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lin_data_prev'<span class="main">)</span> <span class="comment1">(* SLOW *)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_add_new_table_mmsaux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_before<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_mmsaux <span class="free">args</span> <span class="free">cur</span> <span class="free">aux</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> table_X<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_mmsaux <span class="free">args</span> <span class="free">cur</span> <span class="main">(</span>add_new_table_mmsaux <span class="free">args</span> <span class="free">X</span> <span class="free">aux</span><span class="main">)</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free">auxlist</span> <span class="keyword1">of</span>
      <span class="main">[]</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">(</span><span class="free">cur</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span><span class="main">]</span>
    <span class="main">|</span> <span class="main">(</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">#</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">t</span> <span class="main">=</span> <span class="free">cur</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span> <span class="main">∪</span> <span class="free">X</span><span class="main">)</span> <span class="main">#</span> <span class="bound">ts</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">cur</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">#</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> valid_add_new_table_mmsaux_unfolded assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">aux</span></span><span class="main">)</span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> foldr_ts_tuple_rel<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∈</span> foldr <span class="main">(∪)</span> <span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">rel</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">P</span> <span class="bound">t</span> <span class="keyword1">then</span> <span class="main">[</span><span class="bound">rel</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="main">{}</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="free">auxlist</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∈</span> foldr <span class="main">(∪)</span> <span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">rel</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">P</span> <span class="bound">t</span> <span class="keyword1">then</span> <span class="main">[</span><span class="bound">rel</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> tX_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">auxlist</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_foldr_UnE<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="free">auxlist</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="free">as</span><span class="main">)</span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="free">auxlist</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> tX_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">auxlist</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_f_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∈</span> foldr <span class="main">(∪)</span> <span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">rel</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">P</span> <span class="bound">t</span> <span class="keyword1">then</span> <span class="main">[</span><span class="bound">rel</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> in_foldr_UnI<span class="main">[</span><span class="operator">OF</span> tX_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> tX_def assm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">auxlist</span></span><span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> image_snd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈</span> snd <span class="main">`</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">result_mmsaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> <span class="tfree">'a</span> mmsaux <span class="main">⇒</span> <span class="tfree">'a</span> table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">result_mmsaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">gc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_since</span></span></span><span class="main">)</span> <span class="main">=</span>
    Mapping.keys <span class="free"><span class="bound"><span class="entity">tuple_in</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_result_mmsaux_unfolded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_mmsaux <span class="free">args</span> <span class="free">cur</span>
    <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">gc</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_since</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"result_mmsaux <span class="free">args</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">gc</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in</span><span class="main">,</span> <span class="free">tuple_since</span><span class="main">)</span> <span class="main">=</span>
    foldr <span class="main">(∪)</span> <span class="main">[</span><span class="bound">rel</span><span class="main">.</span> <span class="main">(</span>t<span class="main">,</span> rel<span class="main">)</span> <span class="main">←</span> <span class="free">auxlist</span><span class="main">,</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">]</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> valid_mmsaux_tuple_in_keys<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_Un ts_tuple_rel_Un foldr_ts_tuple_rel image_snd<span class="main">)</span>
     <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_intro <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_dest<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_result_mmsaux<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_mmsaux <span class="free">args</span> <span class="free">cur</span> <span class="free">aux</span> <span class="free">auxlist</span> <span class="main">⟹</span>
  result_mmsaux <span class="free">args</span> <span class="free">aux</span> <span class="main">=</span> foldr <span class="main">(∪)</span> <span class="main">[</span><span class="bound">rel</span><span class="main">.</span> <span class="main">(</span>t<span class="main">,</span> rel<span class="main">)</span> <span class="main">←</span> <span class="free">auxlist</span><span class="main">,</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">]</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> valid_result_mmsaux_unfolded <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">aux</span></span><span class="main">)</span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">interpretation</span></span> default_msaux<span class="main">:</span> msaux <span class="quoted">valid_mmsaux</span> <span class="quoted">init_mmsaux</span> <span class="quoted">add_new_ts_mmsaux</span> <span class="quoted">gc_join_mmsaux</span>
  <span class="quoted">add_new_table_mmsaux</span> <span class="quoted">result_mmsaux</span>
  <span class="keyword1"><span class="command">using</span></span> valid_init_mmsaux valid_add_new_ts_mmsaux valid_gc_join_mmsaux valid_add_new_table_mmsaux
    valid_result_mmsaux
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Optimized data structure for Until›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> tp <span class="main">=</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> mmuaux <span class="main">=</span> <span class="quoted"><span class="quoted">"tp <span class="main">×</span> ts queue <span class="main">×</span> nat <span class="main">×</span> bool list <span class="main">×</span> bool list <span class="main">×</span>
  <span class="main">(</span><span class="tfree">'a</span> tuple<span class="main">,</span> tp<span class="main">)</span> mapping <span class="main">×</span> <span class="main">(</span>tp<span class="main">,</span> <span class="main">(</span><span class="tfree">'a</span> tuple<span class="main">,</span> ts <span class="main">+</span> tp<span class="main">)</span> mapping<span class="main">)</span> mapping <span class="main">×</span> <span class="tfree">'a</span> table list <span class="main">×</span> nat"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tstp_lt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ts <span class="main">+</span> tp <span class="main">⇒</span> ts <span class="main">⇒</span> tp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tstp_lt</span> <span class="free"><span class="bound"><span class="entity">tstp</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">tp</span></span></span> <span class="main">=</span> case_sum <span class="main">(</span><span class="main">λ</span><span class="bound">ts'</span><span class="main">.</span> <span class="bound">ts'</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">tp'</span><span class="main">.</span> <span class="bound">tp'</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">tp</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tstp</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ts_tp_lt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">" ℐ <span class="main">⇒</span> ts <span class="main">⇒</span> tp <span class="main">⇒</span> ts <span class="main">+</span> tp <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ts_tp_lt</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">tp</span></span></span> <span class="free"><span class="bound"><span class="entity">tstp</span></span></span> <span class="main">=</span> case_sum <span class="main">(</span><span class="main">λ</span><span class="bound">ts'</span><span class="main">.</span> memL <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="bound">ts'</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">tp'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">tp</span></span></span> <span class="main">≤</span> <span class="bound">tp'</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tstp</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">max_tstp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ts <span class="main">+</span> tp <span class="main">⇒</span> ts <span class="main">+</span> tp <span class="main">⇒</span> ts <span class="main">+</span> tp"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_tstp</span> <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">ts'</span></span></span><span class="main">)</span> <span class="main">=</span> Inl <span class="main">(</span>max <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">ts'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">max_tstp</span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">tp</span></span></span><span class="main">)</span> <span class="main">(</span>Inr <span class="free"><span class="bound"><span class="entity">tp'</span></span></span><span class="main">)</span> <span class="main">=</span> Inr <span class="main">(</span>max <span class="free"><span class="bound"><span class="entity">tp</span></span></span> <span class="free"><span class="bound"><span class="entity">tp'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">max_tstp</span> <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Inl <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">max_tstp</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>Inl <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> Inl <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> max_tstp_idem<span class="main">:</span> <span class="quoted"><span class="quoted">"max_tstp <span class="main">(</span>max_tstp <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> max_tstp <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> max_tstp_idem'<span class="main">:</span> <span class="quoted"><span class="quoted">"max_tstp <span class="free">x</span> <span class="main">(</span>max_tstp <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> max_tstp <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> max_tstp_d_d<span class="main">:</span> <span class="quoted"><span class="quoted">"max_tstp <span class="free">d</span> <span class="free">d</span> <span class="main">=</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">d</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> max_cases<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>max <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>max <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> max_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> max_tstpE<span class="main">:</span> <span class="quoted"><span class="quoted">"isl <span class="free">tstp</span> <span class="main">⟷</span> isl <span class="free">tstp'</span> <span class="main">⟹</span> <span class="main">(</span>max_tstp <span class="free">tstp</span> <span class="free">tstp'</span> <span class="main">=</span> <span class="free">tstp</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span>max_tstp <span class="free">tstp</span> <span class="free">tstp'</span> <span class="main">=</span> <span class="free">tstp'</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">tstp</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">tstp'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> max_cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> max_tstp_intro<span class="main">:</span> <span class="quoted"><span class="quoted">"tstp_lt <span class="free">tstp</span> <span class="free">ts</span> <span class="free">tp</span> <span class="main">⟹</span> tstp_lt <span class="free">tstp'</span> <span class="free">ts</span> <span class="free">tp</span> <span class="main">⟹</span> isl <span class="free">tstp</span> <span class="main">⟷</span> isl <span class="free">tstp'</span> <span class="main">⟹</span>
  tstp_lt <span class="main">(</span>max_tstp <span class="free">tstp</span> <span class="free">tstp'</span><span class="main">)</span> <span class="free">ts</span> <span class="free">tp</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tstp_lt_def max_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> max_tstp_intro'<span class="main">:</span> <span class="quoted"><span class="quoted">"isl <span class="free">tstp</span> <span class="main">⟷</span> isl <span class="free">tstp'</span> <span class="main">⟹</span>
  ts_tp_lt <span class="free">I</span> <span class="free">ts'</span> <span class="free">tp'</span> <span class="free">tstp</span> <span class="main">⟹</span> ts_tp_lt <span class="free">I</span> <span class="free">ts'</span> <span class="free">tp'</span> <span class="main">(</span>max_tstp <span class="free">tstp</span> <span class="free">tstp'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">tstp</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">tstp'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tp_lt_def max_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> max_tstp_intro''<span class="main">:</span> <span class="quoted"><span class="quoted">"isl <span class="free">tstp</span> <span class="main">⟷</span> isl <span class="free">tstp'</span> <span class="main">⟹</span>
  ts_tp_lt <span class="free">I</span> <span class="free">ts'</span> <span class="free">tp'</span> <span class="free">tstp'</span> <span class="main">⟹</span> ts_tp_lt <span class="free">I</span> <span class="free">ts'</span> <span class="free">tp'</span> <span class="main">(</span>max_tstp <span class="free">tstp</span> <span class="free">tstp'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">tstp</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">tstp'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tp_lt_def max_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> contrapos_np <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> max_tstp_isl<span class="main">:</span> <span class="quoted"><span class="quoted">"isl <span class="free">tstp</span> <span class="main">⟷</span> isl <span class="free">tstp'</span> <span class="main">⟹</span> isl <span class="main">(</span>max_tstp <span class="free">tstp</span> <span class="free">tstp'</span><span class="main">)</span> <span class="main">⟷</span> isl <span class="free">tstp</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">tstp</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">tstp'</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">filter_a1_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> tp <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> tuple<span class="main">,</span> tp<span class="main">)</span> mapping <span class="main">⇒</span> <span class="tfree">'a</span> table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">filter_a1_map</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">tp</span></span></span> <span class="free"><span class="bound"><span class="entity">a1_map</span></span></span> <span class="main">=</span>
    <span class="main">{</span><span class="bound"><span class="bound">xs</span></span> <span class="main">∈</span> Mapping.keys <span class="free"><span class="bound"><span class="entity">a1_map</span></span></span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free"><span class="bound"><span class="entity">a1_map</span></span></span> <span class="bound">xs</span> <span class="keyword1">of</span> Some <span class="bound">tp'</span> <span class="main">⇒</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="main">⟶</span> <span class="bound">tp'</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">tp</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span><span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">tp</span></span></span> <span class="main">≤</span> <span class="bound">tp'</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">filter_a2_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> ts <span class="main">⇒</span> tp <span class="main">⇒</span> <span class="main">(</span>tp<span class="main">,</span> <span class="main">(</span><span class="tfree">'a</span> tuple<span class="main">,</span> ts <span class="main">+</span> tp<span class="main">)</span> mapping<span class="main">)</span> mapping <span class="main">⇒</span>
  <span class="tfree">'a</span> table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">filter_a2_map</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">tp</span></span></span> <span class="free"><span class="bound"><span class="entity">a2_map</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">tp'</span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">tp</span></span></span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="free"><span class="bound"><span class="entity">a2_map</span></span></span> <span class="bound">tp'</span> <span class="keyword1">of</span> Some <span class="bound">m</span> <span class="main">⇒</span>
    <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="bound">m</span> <span class="bound">xs</span> <span class="keyword1">of</span> Some <span class="bound">tstp</span> <span class="main">⇒</span> ts_tp_lt <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">tp</span></span></span> <span class="bound">tstp</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">triple_eq_pair</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">triple_eq_pair</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ts'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tp'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ts'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">tp'</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">ts'</span></span></span> <span class="free"><span class="bound"><span class="entity">tp'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">valid_mmuaux'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> ts <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'a</span> mmuaux <span class="main">⇒</span> <span class="tfree">'a</span> muaux <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valid_mmuaux'</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">cur</span></span></span> <span class="free"><span class="bound"><span class="entity">dt</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tp</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tss</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">len</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a1_map</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a2_map</span></span></span><span class="main">,</span>
    <span class="free"><span class="bound"><span class="entity">done</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">done_length</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span> <span class="main">⟷</span>
    args_L <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">⊆</span> args_R <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">maskL</span></span></span> <span class="main">=</span> join_mask <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_L <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">maskR</span></span></span> <span class="main">=</span> join_mask <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_R <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">len</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">tp</span></span></span> <span class="main">∧</span>
    length <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">tss</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">len</span></span></span> <span class="main">∧</span> sorted <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">tss</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">tss</span></span></span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">cur</span></span></span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cur</span></span></span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    table <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_L <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>Mapping.keys <span class="free"><span class="bound"><span class="entity">a1_map</span></span></span><span class="main">)</span> <span class="main">∧</span>
    Mapping.keys <span class="free"><span class="bound"><span class="entity">a2_map</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">tp</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">len</span></span></span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">tp</span></span></span><span class="main">}</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> Mapping.keys <span class="free"><span class="bound"><span class="entity">a1_map</span></span></span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free"><span class="bound"><span class="entity">a1_map</span></span></span> <span class="bound">xs</span> <span class="keyword1">of</span> Some <span class="bound">tp'</span> <span class="main">⇒</span> <span class="bound">tp'</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">tp</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">tp'</span> <span class="main">∈</span> Mapping.keys <span class="free"><span class="bound"><span class="entity">a2_map</span></span></span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free"><span class="bound"><span class="entity">a2_map</span></span></span> <span class="bound">tp'</span> <span class="keyword1">of</span> Some <span class="bound">m</span> <span class="main">⇒</span>
      table <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_R <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>Mapping.keys <span class="bound">m</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> Mapping.keys <span class="bound">m</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="bound">m</span> <span class="bound">xs</span> <span class="keyword1">of</span> Some <span class="bound">tstp</span> <span class="main">⇒</span>
      tstp_lt <span class="bound">tstp</span> <span class="free"><span class="bound"><span class="entity">cur</span></span></span> <span class="free"><span class="bound"><span class="entity">tp</span></span></span> <span class="main">∧</span> <span class="main">(</span>isl <span class="bound">tstp</span> <span class="main">⟷</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    length <span class="free"><span class="bound"><span class="entity">done</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">done_length</span></span></span> <span class="main">∧</span> length <span class="free"><span class="bound"><span class="entity">done</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">len</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span> <span class="main">∧</span>
    rev <span class="free"><span class="bound"><span class="entity">done</span></span></span> <span class="main">=</span> map proj_thd <span class="main">(</span>take <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">done</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">done</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span><span class="main">)</span><span class="main">.</span> check_before <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">dt</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
    sorted <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span><span class="main">)</span> <span class="main">∧</span>
    list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> triple_eq_pair <span class="bound">x</span> <span class="bound">y</span> <span class="main">(</span><span class="main">λ</span><span class="bound">tp'</span><span class="main">.</span> filter_a1_map <span class="main">(</span>args_pos <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="bound">tp'</span> <span class="free"><span class="bound"><span class="entity">a1_map</span></span></span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">ts'</span> <span class="bound">tp'</span><span class="main">.</span> filter_a2_map <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="bound">ts'</span> <span class="bound">tp'</span> <span class="free"><span class="bound"><span class="entity">a2_map</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">done</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span><span class="main">)</span>
      <span class="main">(</span>zip <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">tss</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">tp</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">len</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">tp</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">valid_mmuaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'a</span> mmuaux <span class="main">⇒</span> <span class="tfree">'a</span> muaux <span class="main">⇒</span>
  bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valid_mmuaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">cur</span></span></span> <span class="main">=</span> valid_mmuaux' <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">cur</span></span></span> <span class="free"><span class="bound"><span class="entity">cur</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_step_mmuaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> <span class="tfree">'a</span> mmuaux <span class="main">⇒</span> <span class="tfree">'a</span> mmuaux"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_step_mmuaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tp</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tss</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">len</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a1_map</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a2_map</span></span></span><span class="main">,</span>
    <span class="free"><span class="bound"><span class="entity">done</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">done_length</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> safe_hd <span class="free"><span class="bound"><span class="entity">tss</span></span></span> <span class="keyword1">of</span> <span class="main">(</span>Some <span class="bound">ts</span><span class="main">,</span> <span class="bound">tss'</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="free"><span class="bound"><span class="entity">a2_map</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tp</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">len</span></span></span><span class="main">)</span> <span class="keyword1">of</span> Some <span class="bound">m</span> <span class="main">⇒</span>
        <span class="keyword1">let</span> <span class="bound">m</span> <span class="main">=</span> Mapping.filter <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="bound">tstp</span><span class="main">.</span> ts_tp_lt <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="bound">ts</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tp</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">len</span></span></span><span class="main">)</span> <span class="bound">tstp</span><span class="main">)</span> <span class="bound">m</span><span class="main">;</span>
        <span class="bound">T</span> <span class="main">=</span> Mapping.keys <span class="bound">m</span><span class="main">;</span>
        <span class="bound">a2_map</span> <span class="main">=</span> Mapping.update <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tp</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">len</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>
          <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="free"><span class="bound"><span class="entity">a2_map</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tp</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">len</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">of</span> Some <span class="bound">m'</span> <span class="main">⇒</span>
          Mapping.combine <span class="main">(</span><span class="main">λ</span><span class="bound">tstp</span> <span class="bound">tstp'</span><span class="main">.</span> max_tstp <span class="bound">tstp</span> <span class="bound">tstp'</span><span class="main">)</span> <span class="bound">m</span> <span class="bound">m'</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a2_map</span></span></span><span class="main">;</span>
        <span class="bound">a2_map</span> <span class="main">=</span> Mapping.delete <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tp</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">len</span></span></span><span class="main">)</span> <span class="bound">a2_map</span> <span class="keyword1">in</span>
        <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tp</span></span></span><span class="main">,</span> tl_queue <span class="bound">tss'</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">len</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a1_map</span></span></span><span class="main">,</span> <span class="bound">a2_map</span><span class="main">,</span>
        <span class="bound">T</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">done</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">done_length</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_update_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.keys <span class="main">(</span>Mapping.update <span class="free">a</span> <span class="free">b</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> Mapping.keys <span class="free">m</span> <span class="main">∪</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> drop_is_Cons_take<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="free">n</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span> <span class="main">⟹</span> take <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> take <span class="free">n</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_all2_weaken<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">f'</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> list_all2 <span class="free">f'</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_all2_induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_lookup_delete<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>Mapping.delete <span class="free">k</span> <span class="free">m</span><span class="main">)</span> <span class="free">k'</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free">k</span> <span class="main">=</span> <span class="free">k'</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Mapping.lookup <span class="free">m</span> <span class="free">k'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_lookup_update<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>Mapping.update <span class="free">k</span> <span class="free">v</span> <span class="free">m</span><span class="main">)</span> <span class="free">k'</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free">k</span> <span class="main">=</span> <span class="free">k'</span> <span class="keyword1">then</span> Some <span class="free">v</span> <span class="keyword1">else</span> Mapping.lookup <span class="free">m</span> <span class="free">k'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> hd_le_set<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> hd <span class="free">xs</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_iff list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_ConsD sorted.elims<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_lookup_combineE<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>Mapping.combine <span class="free">f</span> <span class="free">m</span> <span class="free">m'</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span>
  <span class="main">(</span>Mapping.lookup <span class="free">m</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span>Mapping.lookup <span class="free">m'</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">v'</span> <span class="bound">v''</span><span class="main">.</span> Mapping.lookup <span class="free">m</span> <span class="free">k</span> <span class="main">=</span> Some <span class="bound">v'</span> <span class="main">⟹</span> Mapping.lookup <span class="free">m'</span> <span class="free">k</span> <span class="main">=</span> Some <span class="bound">v''</span> <span class="main">⟹</span>
  <span class="free">f</span> <span class="bound">v'</span> <span class="bound">v''</span> <span class="main">=</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Mapping.lookup_combine
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> combine_options_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_keys_filterI<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">m</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">k</span> <span class="free">v</span> <span class="main">⟹</span>
  <span class="free">k</span> <span class="main">∈</span> Mapping.keys <span class="main">(</span>Mapping.filter <span class="free">f</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_keys_filterD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> Mapping.keys <span class="main">(</span>Mapping.filter <span class="free">f</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> Mapping.lookup <span class="free">m</span> <span class="free">k</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">∧</span> <span class="free">f</span> <span class="free">k</span> <span class="bound">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lin_ts_mmuaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mmuaux <span class="main">⇒</span> ts list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lin_ts_mmuaux</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tp</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tss</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">len</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a1_map</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a2_map</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">done</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">done_length</span></span></span><span class="main">)</span> <span class="main">=</span>
    linearize <span class="free"><span class="bound"><span class="entity">tss</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_eval_step_mmuaux'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_mmuaux' <span class="free">args</span> <span class="free">cur</span> <span class="free">dt</span> <span class="free">aux</span> <span class="free">auxlist</span>"</span></span>
    <span class="quoted"><span class="quoted">"lin_ts_mmuaux <span class="free">aux</span> <span class="main">=</span> <span class="free">ts</span> <span class="main">#</span> <span class="free">tss''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">dt</span> <span class="main">-</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_mmuaux' <span class="free">args</span> <span class="free">cur</span> <span class="free">dt</span> <span class="main">(</span>eval_step_mmuaux <span class="free">args</span> <span class="free">aux</span><span class="main">)</span> <span class="free">auxlist</span> <span class="main">∧</span>
    lin_ts_mmuaux <span class="main">(</span>eval_step_mmuaux <span class="free">args</span> <span class="free">aux</span><span class="main">)</span> <span class="main">=</span> <span class="free">tss''</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> args_ivl <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> args_n <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> args_L <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> args_R <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pos</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pos</span> <span class="main">=</span> args_pos <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tp</span></span> <span class="skolem"><span class="skolem">len</span></span> <span class="skolem"><span class="skolem">tss</span></span> <span class="skolem"><span class="skolem">maskL</span></span> <span class="skolem"><span class="skolem">maskR</span></span> <span class="skolem"><span class="skolem">a1_map</span></span> <span class="skolem"><span class="skolem">a2_map</span></span> <span class="quoted">"<span class="skolem"><span class="skolem">done</span></span>"</span> <span class="skolem"><span class="skolem">done_length</span></span> <span class="keyword2"><span class="keyword">where</span></span> aux_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">aux</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">tp</span><span class="main">,</span> <span class="skolem">tss</span><span class="main">,</span> <span class="skolem">len</span><span class="main">,</span> <span class="skolem">maskL</span><span class="main">,</span> <span class="skolem">maskR</span><span class="main">,</span> <span class="skolem">a1_map</span><span class="main">,</span> <span class="skolem">a2_map</span><span class="main">,</span> <span class="skolem">done</span><span class="main">,</span> <span class="skolem">done_length</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">aux</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tss'</span></span> <span class="keyword2"><span class="keyword">where</span></span> safe_hd_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_hd <span class="skolem">tss</span> <span class="main">=</span> <span class="main">(</span>Some <span class="free">ts</span><span class="main">,</span> <span class="skolem">tss'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> safe_hd_rep case_optionE
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"safe_hd <span class="skolem">tss</span>"</span></span><span class="main">)</span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">note</span></span> valid_before <span class="main">=</span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> aux_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> lin_tss_not_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="skolem">tss</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> safe_hd_rep<span class="main">[</span><span class="operator">OF</span> safe_hd_eq<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> ts_hd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">=</span> hd <span class="main">(</span>linearize <span class="skolem">tss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> safe_hd_rep<span class="main">[</span><span class="operator">OF</span> safe_hd_eq<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lin_tss'<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="skolem">tss'</span> <span class="main">=</span> linearize <span class="skolem">tss</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> safe_hd_rep<span class="main">[</span><span class="operator">OF</span> safe_hd_eq<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> tss'_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_empty <span class="skolem">tss'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> is_empty_alt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">tss'</span></span><span class="main">]</span> lin_tss_not_Nil <span class="keyword1"><span class="command">unfolding</span></span> lin_tss' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> len_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">len</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lin_tss_not_Nil valid_before <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> a2_map_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.keys <span class="skolem">a2_map</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">..</span><span class="skolem">tp</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> len_tp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">len</span> <span class="main">≤</span> <span class="skolem">tp</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> tp_minus_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span> <span class="main">∈</span> Mapping.keys <span class="skolem">a2_map</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a2_map_keys <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> tp_minus_keys'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span> <span class="main">+</span> <span class="main">1</span> <span class="main">∈</span> Mapping.keys <span class="skolem">a2_map</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a2_map_keys len_pos len_tp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map</span> <span class="main">(</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tp_minus_keys <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>Mapping.keys <span class="skolem">m</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> Mapping.keys <span class="skolem">m</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">m</span> <span class="bound">xs</span> <span class="keyword1">of</span> Some <span class="bound">tstp</span> <span class="main">⇒</span>
    tstp_lt <span class="bound">tstp</span> <span class="free">cur</span> <span class="skolem">tp</span> <span class="main">∧</span> <span class="main">(</span>isl <span class="bound">tstp</span> <span class="main">⟷</span> <span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tp_minus_keys m_def valid_before
    <span class="keyword1"><span class="command">unfolding</span></span> valid_mmuaux'.simps n_def I_def R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> m_inst<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>Mapping.keys <span class="skolem">m</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">tstp</span><span class="main">.</span> Mapping.lookup <span class="skolem">m</span> <span class="bound">xs</span> <span class="main">=</span> Some <span class="bound">tstp</span> <span class="main">⟹</span>
    tstp_lt <span class="bound">tstp</span> <span class="free">cur</span> <span class="skolem">tp</span> <span class="main">∧</span> <span class="main">(</span>isl <span class="bound">tstp</span> <span class="main">⟷</span> <span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Mapping_keys_intro <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> m_inst_isl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">tstp</span><span class="main">.</span> Mapping.lookup <span class="skolem">m</span> <span class="bound">xs</span> <span class="main">=</span> Some <span class="bound">tstp</span> <span class="main">⟹</span> isl <span class="bound">tstp</span> <span class="main">⟷</span> <span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> m_inst<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> m'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map</span> <span class="main">(</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">m'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tp_minus_keys' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>Mapping.keys <span class="skolem">m'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> Mapping.keys <span class="skolem">m'</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">m'</span> <span class="bound">xs</span> <span class="keyword1">of</span> Some <span class="bound">tstp</span> <span class="main">⇒</span>
    tstp_lt <span class="bound">tstp</span> <span class="free">cur</span> <span class="skolem">tp</span> <span class="main">∧</span> <span class="main">(</span>isl <span class="bound">tstp</span> <span class="main">⟷</span> <span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tp_minus_keys' m'_def valid_before
    <span class="keyword1"><span class="command">unfolding</span></span> valid_mmuaux'.simps I_def n_def R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> m'_inst<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>Mapping.keys <span class="skolem">m'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">tstp</span><span class="main">.</span> Mapping.lookup <span class="skolem">m'</span> <span class="bound">xs</span> <span class="main">=</span> Some <span class="bound">tstp</span> <span class="main">⟹</span>
    tstp_lt <span class="bound">tstp</span> <span class="free">cur</span> <span class="skolem">tp</span> <span class="main">∧</span> <span class="main">(</span>isl <span class="bound">tstp</span> <span class="main">⟷</span> <span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Mapping_keys_intro <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> m'_inst_isl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">tstp</span><span class="main">.</span> Mapping.lookup <span class="skolem">m'</span> <span class="bound">xs</span> <span class="main">=</span> Some <span class="bound">tstp</span> <span class="main">⟹</span> isl <span class="bound">tstp</span> <span class="main">⟷</span> <span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> m'_inst<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m_upd</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m_upd</span> <span class="main">=</span> Mapping.filter <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="bound">tstp</span><span class="main">.</span> ts_tp_lt <span class="skolem">I</span> <span class="free">ts</span> <span class="main">(</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">)</span> <span class="bound">tstp</span><span class="main">)</span> <span class="skolem">m</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> Mapping.keys <span class="skolem">m_upd</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">mc</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mc</span> <span class="main">=</span> Mapping.combine <span class="main">(</span><span class="main">λ</span><span class="bound">tstp</span> <span class="bound">tstp'</span><span class="main">.</span> max_tstp <span class="bound">tstp</span> <span class="bound">tstp'</span><span class="main">)</span> <span class="skolem">m_upd</span> <span class="skolem">m'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a2_map'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a2_map'</span> <span class="main">=</span> Mapping.update <span class="main">(</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">mc</span> <span class="skolem">a2_map</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a2_map''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a2_map''</span> <span class="main">=</span> Mapping.delete <span class="main">(</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">)</span> <span class="skolem">a2_map'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> m_upd_lookup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">tstp</span><span class="main">.</span> Mapping.lookup <span class="skolem">m_upd</span> <span class="bound">xs</span> <span class="main">=</span> Some <span class="bound">tstp</span> <span class="main">⟹</span>
    tstp_lt <span class="bound">tstp</span> <span class="free">cur</span> <span class="skolem">tp</span> <span class="main">∧</span> <span class="main">(</span>isl <span class="bound">tstp</span> <span class="main">⟷</span> <span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> m_upd_def Mapping.lookup_filter
    <span class="keyword1"><span class="command">using</span></span> m_inst<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> mc_lookup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">tstp</span><span class="main">.</span> Mapping.lookup <span class="skolem">mc</span> <span class="bound">xs</span> <span class="main">=</span> Some <span class="bound">tstp</span> <span class="main">⟹</span>
    tstp_lt <span class="bound">tstp</span> <span class="free">cur</span> <span class="skolem">tp</span> <span class="main">∧</span> <span class="main">(</span>isl <span class="bound">tstp</span> <span class="main">⟷</span> <span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mc_def Mapping.lookup_combine
    <span class="keyword1"><span class="command">using</span></span> m_upd_lookup m'_inst<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> combine_options_def max_tstp_isl <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> max_tstp_intro <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> mc_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.keys <span class="skolem">mc</span> <span class="main">⊆</span> Mapping.keys <span class="skolem">m</span> <span class="main">∪</span> Mapping.keys <span class="skolem">m'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mc_def Mapping.keys_combine m_upd_def
    <span class="keyword1"><span class="command">using</span></span> Mapping.keys_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> tp_len_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">tp</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">len</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> len_pos len_tp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> a2_map''_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.keys <span class="skolem">a2_map''</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">tp</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">len</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">..</span><span class="skolem">tp</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> a2_map''_def a2_map'_def Mapping.keys_delete Mapping_update_keys a2_map_keys
    <span class="keyword1"><span class="command">using</span></span> tp_len_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lin_tss_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="skolem">tss</span> <span class="main">=</span> <span class="free">ts</span> <span class="main">#</span> linearize <span class="main">(</span>tl_queue <span class="skolem">tss'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lin_tss_not_Nil
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tl_queue_rep<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tss'_not_empty<span class="main"><span class="main">]</span></span> lin_tss' ts_hd<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> tp_len_tp_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">..&lt;</span><span class="skolem">tp</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">)</span> <span class="main">#</span> <span class="main">[</span><span class="skolem">tp</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">len</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">tp</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tp_len_assoc<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> len_pos len_tp Suc_diff_le upt_conv_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">tp</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">len</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span><span class="main">..</span><span class="skolem">tp</span><span class="main">}</span> <span class="main">⟹</span>
    Mapping.lookup <span class="skolem">a2_map''</span> <span class="bound">x</span> <span class="main">=</span> Mapping.lookup <span class="skolem">a2_map</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> a2_map''_def a2_map'_def Mapping_lookup_delete Mapping_lookup_update tp_len_assoc
    <span class="keyword1"><span class="command">using</span></span> len_tp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> list_all2<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> triple_eq_pair <span class="bound">x</span> <span class="bound">y</span> <span class="main">(</span><span class="main">λ</span><span class="bound">tp'</span><span class="main">.</span> filter_a1_map <span class="skolem">pos</span> <span class="bound">tp'</span> <span class="skolem">a1_map</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">ts'</span> <span class="bound">tp'</span><span class="main">.</span> filter_a2_map <span class="skolem">I</span> <span class="bound">ts'</span> <span class="bound">tp'</span> <span class="skolem">a2_map</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>linearize <span class="skolem">tss</span><span class="main">)</span> <span class="main">[</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">..&lt;</span><span class="skolem">tp</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">unfolding</span></span> I_def pos_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">hd_aux</span></span> <span class="skolem"><span class="skolem">tl_aux</span></span> <span class="keyword2"><span class="keyword">where</span></span> aux_split<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="free">auxlist</span> <span class="main">=</span> <span class="skolem">hd_aux</span> <span class="main">#</span> <span class="skolem">tl_aux</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">hd_aux</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">a1</span><span class="main">,</span> <span class="bound">a2</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">a1</span><span class="main">,</span> <span class="bound">a2</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="free">ts</span><span class="main">,</span> filter_a1_map <span class="skolem">pos</span> <span class="main">(</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">)</span> <span class="skolem">a1_map</span><span class="main">,</span> filter_a2_map <span class="skolem">I</span> <span class="free">ts</span> <span class="main">(</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">)</span> <span class="skolem">a2_map</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> list_all2'<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> triple_eq_pair <span class="bound">x</span> <span class="bound">y</span> <span class="main">(</span><span class="main">λ</span><span class="bound">tp'</span><span class="main">.</span> filter_a1_map <span class="skolem">pos</span> <span class="bound">tp'</span> <span class="skolem">a1_map</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">ts'</span> <span class="bound">tp'</span><span class="main">.</span> filter_a2_map <span class="skolem">I</span> <span class="bound">ts'</span> <span class="bound">tp'</span> <span class="skolem">a2_map</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tl_aux</span>
      <span class="main">(</span>zip <span class="main">(</span>linearize <span class="main">(</span>tl_queue <span class="skolem">tss'</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="skolem">tp</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">len</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">tp</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> list_all2<span class="main">[</span><span class="operator">unfolded</span> lin_tss_Cons tp_len_tp_unfold zip_Cons_Cons list_all2_Cons2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lookup''_tp_minus<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map''</span> <span class="main">(</span><span class="skolem">tp</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">len</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">mc</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> a2_map''_def a2_map'_def Mapping_lookup_delete Mapping_lookup_update
      tp_len_assoc<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> len_tp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> filter_a2_map_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ts'</span> <span class="bound">tp'</span><span class="main">.</span> <span class="bound">ts'</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="skolem">tss</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="bound">tp'</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">tp</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">len</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">tp</span><span class="main">}</span> <span class="main">⟹</span> filter_a2_map <span class="skolem">I</span> <span class="bound">ts'</span> <span class="bound">tp'</span> <span class="skolem">a2_map</span> <span class="main">=</span>
    filter_a2_map <span class="skolem">I</span> <span class="bound">ts'</span> <span class="bound">tp'</span> <span class="skolem">a2_map''</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">xs</span>
    <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts'</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="skolem">tss</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">tp'</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">tp</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">len</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">tp</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> filter_a2_map <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">a2_map</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tp_bef</span></span> <span class="skolem"><span class="skolem">m_bef</span></span> <span class="skolem"><span class="skolem">tstp</span></span> <span class="keyword2"><span class="keyword">where</span></span> defs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp_bef</span> <span class="main">≤</span> <span class="skolem">tp'</span>"</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map</span> <span class="skolem">tp_bef</span> <span class="main">=</span> Some <span class="skolem">m_bef</span>"</span></span>
      <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m_bef</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="skolem">tstp</span>"</span></span> <span class="quoted"><span class="quoted">"ts_tp_lt <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">tstp</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> filter_a2_map_def<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> ts_le_ts'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">≤</span> <span class="skolem">ts'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> hd_le_set<span class="main">[</span><span class="operator">OF</span> _ lin_tss_not_Nil assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> valid_before
      <span class="keyword1"><span class="command">unfolding</span></span> ts_hd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> tp_bef_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp_bef</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">..</span><span class="skolem">tp</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs<span class="main">(</span>2<span class="main">)</span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Mapping_keys_intro<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> tp_minus_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">len</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">tp'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> filter_a2_map <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">a2_map''</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp_bef</span> <span class="main">≤</span> <span class="skolem">tp</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">len</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp_bef</span> <span class="main">=</span> <span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">have</span></span> m_bef_m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m_bef</span> <span class="main">=</span> <span class="skolem">m</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> defs<span class="main">(</span>2<span class="main">)</span> m_def
          <span class="keyword1"><span class="command">unfolding</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m_upd</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="skolem">tstp</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> defs<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> ts_le_ts' <span class="keyword1"><span class="command">unfolding</span></span> m_bef_m m_upd_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping.lookup_filter ts_tp_lt_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Mapping_keys_intro
              <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> contrapos_np<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> Mapping.lookup <span class="skolem">mc</span> <span class="skolem">xs</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="bound">tstp</span> <span class="main">⇒</span>
          ts_tp_lt <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="bound">tstp</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> mc_def Mapping.lookup_combine
          <span class="keyword1"><span class="command">using</span></span> m'_inst<span class="main">(</span>2<span class="main">)</span> m_upd_lookup
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> combine_options_def defs<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> max_tstp_intro'
              <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> lookup''_tp_minus tp_minus_le defs
          <span class="keyword1"><span class="command">unfolding</span></span> m_bef_m filter_a2_map_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tp_bef</span> <span class="main">=</span> <span class="skolem">tp</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">len</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True tp_bef_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> m_bef_m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m_bef</span> <span class="main">=</span> <span class="skolem">m'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> defs<span class="main">(</span>2<span class="main">)</span> m'_def
          <span class="keyword1"><span class="command">unfolding</span></span> tp_len_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> Mapping.lookup <span class="skolem">mc</span> <span class="skolem">xs</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="bound">tstp</span> <span class="main">⇒</span>
          ts_tp_lt <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="bound">tstp</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> mc_def Mapping.lookup_combine
          <span class="keyword1"><span class="command">using</span></span> m'_inst<span class="main">(</span>2<span class="main">)</span> m_upd_lookup defs<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> m_bef_m<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> combine_options_def defs<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> max_tstp_intro''
              <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> lookup''_tp_minus tp_minus_le defs
          <span class="keyword1"><span class="command">unfolding</span></span> m_bef_m filter_a2_map_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map''</span> <span class="skolem">tp_bef</span> <span class="main">=</span> Mapping.lookup <span class="skolem">a2_map</span> <span class="skolem">tp_bef</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> id tp_bef_in len_tp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> filter_a2_map_def
        <span class="keyword1"><span class="command">using</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">xs</span>
    <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts'</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="skolem">tss</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tp'</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">tp</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">len</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">tp</span><span class="main">}</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> filter_a2_map <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">a2_map''</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tp_bef</span></span> <span class="skolem"><span class="skolem">m_bef</span></span> <span class="skolem"><span class="skolem">tstp</span></span> <span class="keyword2"><span class="keyword">where</span></span> defs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp_bef</span> <span class="main">≤</span> <span class="skolem">tp'</span>"</span></span>
      <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map''</span> <span class="skolem">tp_bef</span> <span class="main">=</span> Some <span class="skolem">m_bef</span>"</span></span>
      <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m_bef</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="skolem">tstp</span>"</span></span> <span class="quoted"><span class="quoted">"ts_tp_lt <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">tstp</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> filter_a2_map_def<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> ts_le_ts'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">≤</span> <span class="skolem">ts'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> hd_le_set<span class="main">[</span><span class="operator">OF</span> _ lin_tss_not_Nil assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> valid_before
      <span class="keyword1"><span class="command">unfolding</span></span> ts_hd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> tp_bef_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp_bef</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">tp</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">len</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">..</span><span class="skolem">tp</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs<span class="main">(</span>2<span class="main">)</span> a2_map''_keys <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Mapping_keys_intro<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> tp_minus_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span> <span class="main">≤</span> <span class="skolem">tp'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tp</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">len</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">tp'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> filter_a2_map <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">a2_map</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp_bef</span> <span class="main">=</span> <span class="skolem">tp</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">len</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> m_beg_mc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m_bef</span> <span class="main">=</span> <span class="skolem">mc</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> defs<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> True a2_map''_def a2_map'_def tp_len_assoc Mapping_lookup_delete
          Mapping.lookup_update
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> defs<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> m_beg_mc mc_def<span class="main">]</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Mapping_lookup_combineE<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> lassm<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m_upd</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="skolem">tstp</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> filter_a2_map <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">a2_map</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> m_upd_def Mapping.lookup_filter
          <span class="keyword1"><span class="command">using</span></span> m_def tp_minus_le<span class="main">(</span>1<span class="main">)</span> defs
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_a2_map_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> lassm<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m'</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="skolem">tstp</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> filter_a2_map <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">a2_map</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> m'_def defs<span class="main">(</span>4<span class="main">)</span> tp_minus_le defs
          <span class="keyword1"><span class="command">unfolding</span></span> filter_a2_map_def tp_len_assoc
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v'</span> <span class="skolem">v''</span>
        <span class="keyword3"><span class="command">assume</span></span> lassms<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m_upd</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="skolem">v'</span>"</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m'</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="skolem">v''</span>"</span></span>
          <span class="quoted"><span class="quoted">"max_tstp <span class="skolem">v'</span> <span class="skolem">v''</span> <span class="main">=</span> <span class="skolem">tstp</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> filter_a2_map <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">a2_map</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> max_tstpE<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"isl <span class="skolem">v'</span> <span class="main">=</span> isl <span class="skolem">v''</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> lassms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> m_upd_lookup m'_inst<span class="main">(</span>2<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"max_tstp <span class="skolem">v'</span> <span class="skolem">v''</span> <span class="main">=</span> <span class="skolem">v'</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> filter_a2_map <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">a2_map</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> lassms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> m_def defs tp_minus_le<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span> tp_len_assoc m_upd_def Mapping.lookup_filter
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_a2_map_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"max_tstp <span class="skolem">v'</span> <span class="skolem">v''</span> <span class="main">=</span> <span class="skolem">v''</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> filter_a2_map <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">a2_map</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> lassms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> m'_def defs tp_minus_le<span class="main">(</span>2<span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span> tp_len_assoc
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_a2_map_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map''</span> <span class="skolem">tp_bef</span> <span class="main">=</span> Mapping.lookup <span class="skolem">a2_map</span> <span class="skolem">tp_bef</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> id tp_bef_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> filter_a2_map_def
        <span class="keyword1"><span class="command">using</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> set_tl_tss'<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>linearize <span class="main">(</span>tl_queue <span class="skolem">tss'</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>linearize <span class="skolem">tss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tl_queue_rep<span class="main">[</span><span class="operator">OF</span> tss'_not_empty<span class="main">]</span> lin_tss_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> list_all2''<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> triple_eq_pair <span class="bound">x</span> <span class="bound">y</span> <span class="main">(</span><span class="main">λ</span><span class="bound">tp'</span><span class="main">.</span> filter_a1_map <span class="skolem">pos</span> <span class="bound">tp'</span> <span class="skolem">a1_map</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">ts'</span> <span class="bound">tp'</span><span class="main">.</span> filter_a2_map <span class="skolem">I</span> <span class="bound">ts'</span> <span class="bound">tp'</span> <span class="skolem">a2_map''</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tl_aux</span>
      <span class="main">(</span>zip <span class="main">(</span>linearize <span class="main">(</span>tl_queue <span class="skolem">tss'</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="skolem">tp</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">len</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">tp</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> filter_a2_map_cong set_tl_tss'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> list_all2_weaken<span class="main"><span class="main">[</span></span><span class="operator">OF</span> list_all2'<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_set_zipE <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> lookup''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">tp'</span> <span class="main">∈</span> Mapping.keys <span class="skolem">a2_map''</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">a2_map''</span> <span class="bound">tp'</span> <span class="keyword1">of</span> Some <span class="bound">m</span> <span class="main">⇒</span>
    table <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>Mapping.keys <span class="bound">m</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> Mapping.keys <span class="bound">m</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="bound">m</span> <span class="bound">xs</span> <span class="keyword1">of</span> Some <span class="bound">tstp</span> <span class="main">⇒</span>
    tstp_lt <span class="bound">tstp</span> <span class="free">cur</span> <span class="skolem">tp</span> <span class="main">∧</span> isl <span class="bound">tstp</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tp'</span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp'</span> <span class="main">∈</span> Mapping.keys <span class="skolem">a2_map''</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map''</span> <span class="skolem">tp'</span> <span class="main">=</span> Some <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> tp'_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp'</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">tp</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">len</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">..</span><span class="skolem">tp</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assm <span class="keyword1"><span class="command">unfolding</span></span> a2_map''_keys <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tp'_in_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp'</span> <span class="main">∈</span> Mapping.keys <span class="skolem">a2_map</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>Mapping.keys <span class="skolem">f</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> Mapping.keys <span class="skolem">f</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">f</span> <span class="bound">xs</span> <span class="keyword1">of</span> Some <span class="bound">tstp</span> <span class="main">⇒</span>
      tstp_lt <span class="bound">tstp</span> <span class="free">cur</span> <span class="skolem">tp</span> <span class="main">∧</span> isl <span class="bound">tstp</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp'</span> <span class="main">=</span> <span class="skolem">tp</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">len</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f_mc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">mc</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f_def
        <span class="keyword1"><span class="command">unfolding</span></span> a2_map''_def a2_map'_def Mapping_lookup_delete Mapping_lookup_update tp_len_assoc
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>Mapping.keys <span class="skolem">f</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> f_mc
        <span class="keyword1"><span class="command">using</span></span> mc_keys m_def m'_def m_inst m'_inst
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> table_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> Mapping.keys <span class="skolem">f</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">f</span> <span class="bound">xs</span> <span class="keyword1">of</span> Some <span class="bound">tstp</span> <span class="main">⇒</span>
        tstp_lt <span class="bound">tstp</span> <span class="free">cur</span> <span class="skolem">tp</span> <span class="main">∧</span> isl <span class="bound">tstp</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assm Mapping.keys_filter m_inst<span class="main">(</span>2<span class="main">)</span> m_inst_isl m'_inst<span class="main">(</span>2<span class="main">)</span> m'_inst_isl max_tstp_isl
        <span class="keyword1"><span class="command">unfolding</span></span> f_mc mc_def Mapping.lookup_combine
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> combine_options_def m_upd_def Mapping.lookup_filter
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> max_tstp_intro Mapping_keys_intro <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Mapping_keys_dest
            <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map</span> <span class="skolem">tp'</span> <span class="main">=</span> Some <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> tp'_in id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">tp'</span></span><span class="main">]</span> f_def False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> tp'_in_keys valid_before
        <span class="keyword1"><span class="command">unfolding</span></span> valid_mmuaux'.simps I_def n_def R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> Mapping.lookup <span class="skolem">a2_map''</span> <span class="skolem">tp'</span> <span class="keyword1">of</span> Some <span class="bound">m</span> <span class="main">⇒</span>
      table <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>Mapping.keys <span class="bound">m</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> Mapping.keys <span class="bound">m</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="bound">m</span> <span class="bound">xs</span> <span class="keyword1">of</span> Some <span class="bound">tstp</span> <span class="main">⇒</span>
      tstp_lt <span class="bound">tstp</span> <span class="free">cur</span> <span class="skolem">tp</span> <span class="main">∧</span> isl <span class="bound">tstp</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> tl_aux_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tl_aux</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="skolem">done</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> aux_split<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 add_Suc drop0 drop_Suc_Cons drop_drop<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> T_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> filter_a2_map <span class="skolem">I</span> <span class="free">ts</span> <span class="main">(</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">)</span> <span class="skolem">a2_map</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> filter_a2_map <span class="skolem">I</span> <span class="free">ts</span> <span class="main">(</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">)</span> <span class="skolem">a2_map</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tp_bef</span></span> <span class="skolem"><span class="skolem">m_bef</span></span> <span class="skolem"><span class="skolem">tstp</span></span> <span class="keyword2"><span class="keyword">where</span></span> defs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp_bef</span> <span class="main">≤</span> <span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span>"</span></span>
      <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map</span> <span class="skolem">tp_bef</span> <span class="main">=</span> Some <span class="skolem">m_bef</span>"</span></span>
      <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m_bef</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="skolem">tstp</span>"</span></span> <span class="quoted"><span class="quoted">"ts_tp_lt <span class="skolem">I</span> <span class="free">ts</span> <span class="main">(</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">)</span> <span class="skolem">tstp</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_a2_map_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tp_bef_minus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp_bef</span> <span class="main">=</span> <span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_before Mapping_keys_intro <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> m_bef_m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m_bef</span> <span class="main">=</span> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs<span class="main">(</span>2<span class="main">)</span> m_def
      <span class="keyword1"><span class="command">unfolding</span></span> tp_bef_minus <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="skolem">T</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs
      <span class="keyword1"><span class="command">unfolding</span></span> T_def m_upd_def m_bef_m
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Mapping_keys_filterI Mapping_keys_intro<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="skolem">T</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> filter_a2_map <span class="skolem">I</span> <span class="free">ts</span> <span class="main">(</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">)</span> <span class="skolem">a2_map</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> m_def Mapping.keys_filter
      <span class="keyword1"><span class="command">unfolding</span></span> T_def m_upd_def filter_a2_map_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_a2_map_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Mapping_keys_filterD <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> min_auxlist_done<span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">done</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">.</span> check_before <span class="skolem">I</span> <span class="free">dt</span> <span class="bound">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"rev <span class="skolem">done</span> <span class="main">=</span> map proj_thd <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> list_all'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="main">(</span>length <span class="main">(</span><span class="skolem">T</span> <span class="main">#</span> <span class="skolem">done</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">.</span> check_before <span class="skolem">I</span> <span class="free">dt</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"rev <span class="main">(</span><span class="skolem">T</span> <span class="main">#</span> <span class="skolem">done</span><span class="main">)</span> <span class="main">=</span> map proj_thd <span class="main">(</span>take <span class="main">(</span>length <span class="main">(</span><span class="skolem">T</span> <span class="main">#</span> <span class="skolem">done</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> drop_is_Cons_take<span class="main">[</span><span class="operator">OF</span> aux_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> aux_split<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_eq I_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> eval_step_mmuaux_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_step_mmuaux <span class="free">args</span> <span class="main">(</span><span class="skolem">tp</span><span class="main">,</span> <span class="skolem">tss</span><span class="main">,</span> <span class="skolem">len</span><span class="main">,</span> <span class="skolem">maskL</span><span class="main">,</span> <span class="skolem">maskR</span><span class="main">,</span> <span class="skolem">a1_map</span><span class="main">,</span> <span class="skolem">a2_map</span><span class="main">,</span>
    <span class="skolem">done</span><span class="main">,</span> <span class="skolem">done_length</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">tp</span><span class="main">,</span> tl_queue <span class="skolem">tss'</span><span class="main">,</span> <span class="skolem">len</span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span>  <span class="skolem">maskL</span><span class="main">,</span> <span class="skolem">maskR</span><span class="main">,</span> <span class="skolem">a1_map</span><span class="main">,</span> <span class="skolem">a2_map''</span><span class="main">,</span>
    <span class="skolem">T</span> <span class="main">#</span> <span class="skolem">done</span><span class="main">,</span> <span class="skolem">done_length</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> safe_hd_eq m_def m'_def m_upd_def T_def mc_def a2_map'_def a2_map''_def I_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lin_ts_mmuaux <span class="main">(</span>eval_step_mmuaux <span class="free">args</span> <span class="free">aux</span><span class="main">)</span> <span class="main">=</span> <span class="free">tss''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lin_tss_Cons assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> aux_def eval_step_mmuaux_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before a2_map''_keys sorted_tl list_all' lookup'' list_all2''
    <span class="keyword1"><span class="command">unfolding</span></span> eval_step_mmuaux_eq valid_mmuaux'.simps tl_aux_def aux_def I_def n_def R_def pos_def
    <span class="keyword1"><span class="command">using</span></span> lin_tss_not_Nil safe_hd_eq len_pos
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.set_sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> lin_tss' tl_queue_rep<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tss'_not_empty<span class="main"><span class="main">]</span></span> min_auxlist_done<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> done_empty_valid_mmuaux'_intro<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_mmuaux' <span class="free">args</span> <span class="free">cur</span> <span class="free">dt</span>
    <span class="main">(</span><span class="free">tp</span><span class="main">,</span> <span class="free">tss</span><span class="main">,</span> <span class="free">len</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">a1_map</span><span class="main">,</span> <span class="free">a2_map</span><span class="main">,</span> <span class="free">done</span><span class="main">,</span> <span class="free">done_length</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_mmuaux' <span class="free">args</span> <span class="free">cur</span> <span class="free">dt'</span>
    <span class="main">(</span><span class="free">tp</span><span class="main">,</span> <span class="free">tss</span><span class="main">,</span> <span class="free">len</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">a1_map</span><span class="main">,</span> <span class="free">a2_map</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>
    <span class="main">(</span>drop <span class="main">(</span>length <span class="free">done</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms sorted_drop <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drop_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_mmuaux'_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_mmuaux' <span class="free">args</span> <span class="free">cur</span> <span class="free">dt</span> <span class="free">aux</span> <span class="free">auxlist</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">dt</span> <span class="main">≤</span> <span class="free">dt'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_mmuaux' <span class="free">args</span> <span class="free">cur</span> <span class="free">dt'</span> <span class="free">aux</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms less_le_trans <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">aux</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> memR_antimono<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_foldl_eval_step_mmuaux'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_before<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_mmuaux' <span class="free">args</span> <span class="free">cur</span> <span class="free">dt</span> <span class="free">aux</span> <span class="free">auxlist</span>"</span></span>
    <span class="quoted"><span class="quoted">"lin_ts_mmuaux <span class="free">aux</span> <span class="main">=</span> <span class="free">tss</span> <span class="main">@</span> <span class="free">tss'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ts</span><span class="main">.</span> <span class="bound">ts</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="main">(</span>length <span class="free">tss</span><span class="main">)</span> <span class="main">(</span>lin_ts_mmuaux <span class="free">aux</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">dt</span> <span class="main">-</span> <span class="bound">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_mmuaux' <span class="free">args</span> <span class="free">cur</span> <span class="free">dt</span> <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">aux</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> eval_step_mmuaux <span class="free">args</span> <span class="bound">aux</span><span class="main">)</span> <span class="free">aux</span> <span class="free">tss</span><span class="main">)</span> <span class="free">auxlist</span> <span class="main">∧</span>
    lin_ts_mmuaux <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">aux</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> eval_step_mmuaux <span class="free">args</span> <span class="bound">aux</span><span class="main">)</span> <span class="free">aux</span> <span class="free">tss</span><span class="main">)</span> <span class="main">=</span> <span class="free">tss'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">tss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">aux</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">ts</span> <span class="skolem">tss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> app_ass<span class="main">:</span> <span class="quoted"><span class="quoted">"lin_ts_mmuaux <span class="skolem">aux</span> <span class="main">=</span> <span class="skolem">ts</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">tss</span> <span class="main">@</span> <span class="free">tss'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">dt</span> <span class="main">-</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> valid_step<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_mmuaux' <span class="free">args</span> <span class="free">cur</span> <span class="free">dt</span> <span class="main">(</span>eval_step_mmuaux <span class="free">args</span> <span class="skolem">aux</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
    <span class="quoted"><span class="quoted">"lin_ts_mmuaux <span class="main">(</span>eval_step_mmuaux <span class="free">args</span> <span class="skolem">aux</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">tss</span> <span class="main">@</span> <span class="free">tss'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_eval_step_mmuaux'<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> app_ass<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> valid_step<span class="main">]</span> valid_step Cons<span class="main">(</span>4<span class="main">)</span> app_ass <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_dropWhile_filter<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="free">xs</span> <span class="main">⟹</span> dropWhile <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">¬</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span>
  filter <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> neg<span class="main">:</span> <span class="quoted"><span class="quoted">"memR <span class="free">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> set <span class="skolem">xs</span> <span class="main">⟹</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_le_mono2<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> filter_empty_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">shift_mmuaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'a</span> mmuaux <span class="main">⇒</span> <span class="tfree">'a</span> mmuaux"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">shift_mmuaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tp</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tss</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">len</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a1_map</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a2_map</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">done</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">done_length</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">tss_list</span> <span class="main">=</span> linearize <span class="main">(</span>takeWhile_queue <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tss</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    foldl <span class="main">(</span><span class="main">λ</span><span class="bound">aux</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> eval_step_mmuaux <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="bound">aux</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tp</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tss</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">len</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span>
      <span class="free"><span class="bound"><span class="entity">a1_map</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a2_map</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">done</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">done_length</span></span></span><span class="main">)</span> <span class="bound">tss_list</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_shift_mmuaux'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_mmuaux' <span class="free">args</span> <span class="free">cur</span> <span class="free">cur</span> <span class="free">aux</span> <span class="free">auxlist</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">nt</span> <span class="main">≥</span> <span class="free">cur</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_mmuaux' <span class="free">args</span> <span class="free">cur</span> <span class="free">nt</span> <span class="main">(</span>shift_mmuaux <span class="free">args</span> <span class="free">nt</span> <span class="free">aux</span><span class="main">)</span> <span class="free">auxlist</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">ts</span> <span class="main">∈</span> set <span class="main">(</span>lin_ts_mmuaux <span class="main">(</span>shift_mmuaux <span class="free">args</span> <span class="free">nt</span> <span class="free">aux</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> args_ivl <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pos</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pos</span> <span class="main">=</span> args_pos <span class="free">args</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> valid_folded<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_mmuaux' <span class="free">args</span> <span class="free">cur</span> <span class="free">nt</span> <span class="free">aux</span> <span class="free">auxlist</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> valid_mmuaux'_mono <span class="keyword1"><span class="command">unfolding</span></span> valid_mmuaux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tp</span></span> <span class="skolem"><span class="skolem">len</span></span> <span class="skolem"><span class="skolem">tss</span></span> <span class="skolem"><span class="skolem">maskL</span></span> <span class="skolem"><span class="skolem">maskR</span></span> <span class="skolem"><span class="skolem">a1_map</span></span> <span class="skolem"><span class="skolem">a2_map</span></span> <span class="quoted">"<span class="skolem"><span class="skolem">done</span></span>"</span> <span class="skolem"><span class="skolem">done_length</span></span> <span class="keyword2"><span class="keyword">where</span></span> aux_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">aux</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">tp</span><span class="main">,</span> <span class="skolem">tss</span><span class="main">,</span> <span class="skolem">len</span><span class="main">,</span> <span class="skolem">maskL</span><span class="main">,</span> <span class="skolem">maskR</span><span class="main">,</span> <span class="skolem">a1_map</span><span class="main">,</span> <span class="skolem">a2_map</span><span class="main">,</span> <span class="skolem">done</span><span class="main">,</span> <span class="skolem">done_length</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">aux</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> valid_before <span class="main">=</span> valid_folded<span class="main">[</span><span class="operator">unfolded</span> aux_def<span class="main">]</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tss_list</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tss_list</span> <span class="main">=</span>
    linearize <span class="main">(</span>takeWhile_queue <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> tss_list_takeWhile<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tss_list</span> <span class="main">=</span> takeWhile <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="skolem">tss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tss_list_def <span class="keyword1"><span class="command">unfolding</span></span> takeWhile_queue_rep <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tss_list'</span></span> <span class="keyword2"><span class="keyword">where</span></span> tss_list'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="skolem">tss</span> <span class="main">=</span> <span class="skolem">tss_list</span> <span class="main">@</span> <span class="skolem">tss_list'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">tss_list'</span> <span class="main">=</span> dropWhile <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="skolem">tss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tp'</span></span> <span class="skolem"><span class="skolem">len'</span></span> <span class="skolem"><span class="skolem">tss'</span></span> <span class="skolem"><span class="skolem">maskL'</span></span> <span class="skolem"><span class="skolem">maskR'</span></span> <span class="skolem"><span class="skolem">a1_map'</span></span> <span class="skolem"><span class="skolem">a2_map'</span></span> <span class="quoted">"<span class="skolem"><span class="skolem">done'</span></span>"</span> <span class="skolem"><span class="skolem">done_length'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    foldl_aux_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">tp'</span><span class="main">,</span> <span class="skolem">tss'</span><span class="main">,</span> <span class="skolem">len'</span><span class="main">,</span> <span class="skolem">maskL'</span><span class="main">,</span> <span class="skolem">maskR'</span><span class="main">,</span> <span class="skolem">a1_map'</span><span class="main">,</span> <span class="skolem">a2_map'</span><span class="main">,</span>
      <span class="skolem">done'</span><span class="main">,</span> <span class="skolem">done_length'</span><span class="main">)</span> <span class="main">=</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">aux</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> eval_step_mmuaux <span class="free">args</span> <span class="bound">aux</span><span class="main">)</span> <span class="free">aux</span> <span class="skolem">tss_list</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"foldl <span class="main">(</span><span class="main">λ</span><span class="bound">aux</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> eval_step_mmuaux <span class="free">args</span> <span class="bound">aux</span><span class="main">)</span> <span class="free">aux</span> <span class="skolem">tss_list</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lin_tss_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"lin_ts_mmuaux <span class="free">aux</span> <span class="main">=</span> linearize <span class="skolem">tss</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> aux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">tss_list</span><span class="main">)</span> <span class="main">(</span>lin_ts_mmuaux <span class="free">aux</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">tss_list</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lin_tss_aux <span class="keyword1"><span class="command">using</span></span> tss_list'_def<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> valid_foldl<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_mmuaux' <span class="free">args</span> <span class="free">cur</span> <span class="free">nt</span>
    <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">aux</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> eval_step_mmuaux <span class="free">args</span> <span class="bound">aux</span><span class="main">)</span> <span class="free">aux</span> <span class="skolem">tss_list</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
    <span class="quoted"><span class="quoted">"lin_ts_mmuaux <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">aux</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> eval_step_mmuaux <span class="free">args</span> <span class="bound">aux</span><span class="main">)</span> <span class="free">aux</span> <span class="skolem">tss_list</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">tss_list'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_foldl_eval_step_mmuaux'<span class="main">[</span><span class="operator">OF</span> valid_before<span class="main"><span class="main">[</span></span><span class="operator">folded</span> aux_def<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> lin_tss_aux<span class="main">,</span>
      <span class="operator">OF</span> tss_list'_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> tss_list_takeWhile set_takeWhileD
    <span class="keyword1"><span class="command">unfolding</span></span> lin_tss_aux I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> shift_mmuaux_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"shift_mmuaux <span class="free">args</span> <span class="free">nt</span> <span class="free">aux</span> <span class="main">=</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">aux</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> eval_step_mmuaux <span class="free">args</span> <span class="bound">aux</span><span class="main">)</span> <span class="free">aux</span> <span class="skolem">tss_list</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tss_list_def <span class="keyword1"><span class="command">unfolding</span></span> aux_def I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ts</span><span class="main">.</span> <span class="bound">ts</span> <span class="main">∈</span> set <span class="skolem">tss_list'</span> <span class="main">⟹</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sorted_dropWhile_filter tss_list'_def<span class="main">(</span>2<span class="main">)</span> valid_before <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_foldl<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> shift_mmuaux_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> valid_foldl<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> shift_mmuaux_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> upd_set' <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> mapping <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> mapping"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">m</span> <span class="bound">d</span> <span class="bound">f</span> <span class="bound">X</span> <span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> <span class="bound">X</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="bound">m</span> <span class="bound">a</span> <span class="keyword1">of</span> Some <span class="bound">b</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">f</span> <span class="bound">b</span><span class="main">)</span> <span class="main">|</span> None <span class="main">⇒</span> Some <span class="bound">d</span><span class="main">)</span>
    <span class="keyword1">else</span> Mapping.lookup <span class="bound">m</span> <span class="bound">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> upd_set'_lookup<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>upd_set' <span class="free">m</span> <span class="free">d</span> <span class="free">f</span> <span class="free">X</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">X</span> <span class="keyword1">then</span>
  <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="free">m</span> <span class="free">a</span> <span class="keyword1">of</span> Some <span class="bound">b</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="free">f</span> <span class="bound">b</span><span class="main">)</span> <span class="main">|</span> None <span class="main">⇒</span> Some <span class="free">d</span><span class="main">)</span> <span class="keyword1">else</span> Mapping.lookup <span class="free">m</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping.lookup.rep_eq upd_set'.rep_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> upd_set'_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.keys <span class="main">(</span>upd_set' <span class="free">m</span> <span class="free">d</span> <span class="free">f</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> Mapping.keys <span class="free">m</span> <span class="main">∪</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upd_set'_lookup <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Mapping_keys_intro
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Mapping_keys_dest <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> upd_nested <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> mapping<span class="main">)</span> mapping <span class="main">⇒</span>
  <span class="tfree">'c</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> mapping<span class="main">)</span> mapping"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">m</span> <span class="bound">d</span> <span class="bound">f</span> <span class="bound">X</span> <span class="bound">a</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="bound">m</span> <span class="bound">a</span> <span class="keyword1">of</span> Some <span class="bound">m'</span> <span class="main">⇒</span> Some <span class="main">(</span>upd_set' <span class="bound">m'</span> <span class="bound">d</span> <span class="bound">f</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">}</span><span class="main">)</span>
  <span class="main">|</span> None <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="bound">X</span> <span class="keyword1">then</span> Some <span class="main">(</span>upd_set' Mapping.empty <span class="bound">d</span> <span class="bound">f</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">else</span> None"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> upd_nested_lookup<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>upd_nested <span class="free">m</span> <span class="free">d</span> <span class="free">f</span> <span class="free">X</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="free">m</span> <span class="free">a</span> <span class="keyword1">of</span> Some <span class="bound">m'</span> <span class="main">⇒</span> Some <span class="main">(</span>upd_set' <span class="bound">m'</span> <span class="free">d</span> <span class="free">f</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span><span class="main">)</span>
  <span class="main">|</span> None <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free">a</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="free">X</span> <span class="keyword1">then</span> Some <span class="main">(</span>upd_set' Mapping.empty <span class="free">d</span> <span class="free">f</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping.lookup.abs_eq upd_nested.abs_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> upd_nested_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.keys <span class="main">(</span>upd_nested <span class="free">m</span> <span class="free">d</span> <span class="free">f</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> Mapping.keys <span class="free">m</span> <span class="main">∪</span> fst <span class="main">`</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upd_nested_lookup Domain.DomainI fst_eq_Domain <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Mapping_keys_intro
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Mapping_keys_dest <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">add_new_mmuaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'a</span> mmuaux <span class="main">⇒</span> <span class="tfree">'a</span> mmuaux"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_new_mmuaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">rel1</span></span></span> <span class="free"><span class="bound"><span class="entity">rel2</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">tp</span><span class="main">,</span> <span class="bound">tss</span><span class="main">,</span> <span class="bound">len</span><span class="main">,</span> <span class="bound">maskL</span><span class="main">,</span> <span class="bound">maskR</span><span class="main">,</span> <span class="bound">a1_map</span><span class="main">,</span> <span class="bound">a2_map</span><span class="main">,</span> <span class="bound">done</span><span class="main">,</span> <span class="bound">done_length</span><span class="main">)</span> <span class="main">=</span>
    shift_mmuaux <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">;</span>
    <span class="bound">I</span> <span class="main">=</span> args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">;</span> <span class="bound">pos</span> <span class="main">=</span> args_pos <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">;</span>
    <span class="bound">new_tstp</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> memL <span class="bound">I</span> <span class="main">0</span> <span class="keyword1">then</span> Inr <span class="bound">tp</span> <span class="keyword1">else</span> Inl <span class="free"><span class="bound"><span class="entity">nt</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="bound">tmp</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">as</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="bound">a1_map</span> <span class="main">(</span>proj_tuple <span class="bound">maskL</span> <span class="bound">as</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="main">¬</span><span class="bound">pos</span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">(</span><span class="bound">tp</span> <span class="main">-</span> <span class="bound">len</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>
      <span class="main">|</span> Some <span class="bound">tp'</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">pos</span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">(</span>max <span class="main">(</span><span class="bound">tp</span> <span class="main">-</span> <span class="bound">len</span><span class="main">)</span> <span class="bound">tp'</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">}</span>
      <span class="keyword1">else</span> <span class="main">{</span><span class="main">(</span>max <span class="main">(</span><span class="bound">tp</span> <span class="main">-</span> <span class="bound">len</span><span class="main">)</span> <span class="main">(</span><span class="bound">tp'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">rel2</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> memL <span class="bound">I</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">{</span><span class="bound">tp</span><span class="main">}</span> <span class="main">×</span> <span class="free"><span class="bound"><span class="entity">rel2</span></span></span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">a2_map</span> <span class="main">=</span> Mapping.update <span class="main">(</span><span class="bound">tp</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> Mapping.empty
      <span class="main">(</span>upd_nested <span class="bound">a2_map</span> <span class="bound">new_tstp</span> <span class="main">(</span>max_tstp <span class="bound">new_tstp</span><span class="main">)</span> <span class="bound">tmp</span><span class="main">)</span><span class="main">;</span>
    <span class="bound">a1_map</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">pos</span> <span class="keyword1">then</span> Mapping.filter <span class="main">(</span><span class="main">λ</span><span class="bound">as</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">rel1</span></span></span><span class="main">)</span>
      <span class="main">(</span>upd_set <span class="bound">a1_map</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">tp</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rel1</span></span></span> <span class="main">-</span> Mapping.keys <span class="bound">a1_map</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> upd_set <span class="bound">a1_map</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">tp</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rel1</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="bound">tss</span> <span class="main">=</span> append_queue <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="bound">tss</span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="bound">tp</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="bound">tss</span><span class="main">,</span> <span class="bound">len</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="bound">maskL</span><span class="main">,</span> <span class="bound">maskR</span><span class="main">,</span> <span class="bound">a1_map</span><span class="main">,</span> <span class="bound">a2_map</span><span class="main">,</span> <span class="bound">done</span><span class="main">,</span> <span class="bound">done_length</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fst_case<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> fst <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">a1</span><span class="main">,</span> <span class="bound">a2</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="free">y</span> <span class="bound">t</span> <span class="bound">a1</span> <span class="bound">a2</span><span class="main">,</span> <span class="free">z</span> <span class="bound">t</span> <span class="bound">a1</span> <span class="bound">a2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all2_in_setE<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">Q</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_iff set_zip in_set_conv_nth<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all2_zip<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> triple_eq_pair <span class="bound">x</span> <span class="bound">y</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">xs</span> <span class="main">(</span>zip <span class="free">ys</span> <span class="free">zs</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_zip <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all2_in_setE triple_eq_pair.elims<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_appendE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> set <span class="free">ys</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> set <span class="free">zs</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> take_takeWhile<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> length <span class="free">ys</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="free">n</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="free">n</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span><span class="free">P</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span>
  take <span class="free">n</span> <span class="free">ys</span> <span class="main">=</span> takeWhile <span class="free">P</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_add_new_mmuaux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_before<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_mmuaux <span class="free">args</span> <span class="free">cur</span> <span class="free">aux</span> <span class="free">auxlist</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> tabs<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="free">rel1</span>"</span></span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="free">rel2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nt_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nt</span> <span class="main">≥</span> <span class="free">cur</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_mmuaux <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>add_new_mmuaux <span class="free">args</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="free">nt</span> <span class="free">aux</span><span class="main">)</span>
    <span class="main">(</span>update_until <span class="free">args</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="free">nt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> args_ivl <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> args_n <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> args_L <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> args_R <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pos</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pos</span> <span class="main">=</span> args_pos <span class="free">args</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> valid_folded<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_mmuaux' <span class="free">args</span> <span class="free">cur</span> <span class="free">nt</span> <span class="free">aux</span> <span class="free">auxlist</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> valid_mmuaux'_mono <span class="keyword1"><span class="command">unfolding</span></span> valid_mmuaux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tp</span></span> <span class="skolem"><span class="skolem">len</span></span> <span class="skolem"><span class="skolem">tss</span></span> <span class="skolem"><span class="skolem">maskL</span></span> <span class="skolem"><span class="skolem">maskR</span></span> <span class="skolem"><span class="skolem">a1_map</span></span> <span class="skolem"><span class="skolem">a2_map</span></span> <span class="quoted">"<span class="skolem"><span class="skolem">done</span></span>"</span> <span class="skolem"><span class="skolem">done_length</span></span> <span class="keyword2"><span class="keyword">where</span></span> shift_aux_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"shift_mmuaux <span class="free">args</span> <span class="free">nt</span> <span class="free">aux</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">tp</span><span class="main">,</span> <span class="skolem">tss</span><span class="main">,</span> <span class="skolem">len</span><span class="main">,</span> <span class="skolem">maskL</span><span class="main">,</span> <span class="skolem">maskR</span><span class="main">,</span> <span class="skolem">a1_map</span><span class="main">,</span> <span class="skolem">a2_map</span><span class="main">,</span> <span class="skolem">done</span><span class="main">,</span> <span class="skolem">done_length</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"shift_mmuaux <span class="free">args</span> <span class="free">nt</span> <span class="free">aux</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> valid_shift_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_mmuaux' <span class="free">args</span> <span class="free">cur</span> <span class="free">nt</span> <span class="main">(</span><span class="skolem">tp</span><span class="main">,</span> <span class="skolem">tss</span><span class="main">,</span> <span class="skolem">len</span><span class="main">,</span> <span class="skolem">maskL</span><span class="main">,</span> <span class="skolem">maskR</span><span class="main">,</span>
    <span class="skolem">a1_map</span><span class="main">,</span> <span class="skolem">a2_map</span><span class="main">,</span> <span class="skolem">done</span><span class="main">,</span> <span class="skolem">done_length</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ts</span><span class="main">.</span> <span class="bound">ts</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="skolem">tss</span><span class="main">)</span> <span class="main">⟹</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_shift_mmuaux'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> valid_mmuaux_def<span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> shift_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">new_tstp</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">new_tstp</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> memL <span class="skolem">I</span> <span class="main">0</span> <span class="keyword1">then</span> Inr <span class="skolem">tp</span> <span class="keyword1">else</span> Inl <span class="free">nt</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> new_tstp_lt_isl<span class="main">:</span> <span class="quoted"><span class="quoted">"tstp_lt <span class="skolem">new_tstp</span> <span class="free">nt</span> <span class="main">(</span><span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"isl <span class="skolem">new_tstp</span> <span class="main">⟷</span> <span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> new_tstp_def tstp_lt_def<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tmp</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tmp</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">as</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">a1_map</span> <span class="main">(</span>proj_tuple <span class="skolem">maskL</span> <span class="bound">as</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">¬</span><span class="skolem">pos</span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">(</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>
    <span class="main">|</span> Some <span class="bound">tp'</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="skolem">pos</span> <span class="keyword1">then</span> <span class="main">{</span><span class="main">(</span>max <span class="main">(</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">)</span> <span class="bound">tp'</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">}</span>
    <span class="keyword1">else</span> <span class="main">{</span><span class="main">(</span>max <span class="main">(</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">)</span> <span class="main">(</span><span class="bound">tp'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">`</span> <span class="free">rel2</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> memL <span class="skolem">I</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">{</span><span class="skolem">tp</span><span class="main">}</span> <span class="main">×</span> <span class="free">rel2</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> a1_map_lookup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span> <span class="bound">tp'</span><span class="main">.</span> Mapping.lookup <span class="skolem">a1_map</span> <span class="bound">as</span> <span class="main">=</span> Some <span class="bound">tp'</span> <span class="main">⟹</span> <span class="bound">tp'</span> <span class="main">&lt;</span> <span class="skolem">tp</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_shift_aux<span class="main">(</span>1<span class="main">)</span> Mapping_keys_intro <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fst_tmp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">tp'</span><span class="main">.</span> <span class="bound">tp'</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="skolem">tmp</span> <span class="main">⟹</span> <span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span> <span class="main">≤</span> <span class="bound">tp'</span> <span class="main">∧</span> <span class="bound">tp'</span> <span class="main">&lt;</span> <span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tmp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_SucI <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> snd_tmp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">tp'</span><span class="main">.</span> table <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">tmp</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tabs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> tmp_def n_def R_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> table_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a2_map'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a2_map'</span> <span class="main">=</span> Mapping.update <span class="main">(</span><span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> Mapping.empty
    <span class="main">(</span>upd_nested <span class="skolem">a2_map</span> <span class="skolem">new_tstp</span> <span class="main">(</span>max_tstp <span class="skolem">new_tstp</span><span class="main">)</span> <span class="skolem">tmp</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a1_map'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a1_map'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">pos</span> <span class="keyword1">then</span> Mapping.filter <span class="main">(</span><span class="main">λ</span><span class="bound">as</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> <span class="free">rel1</span><span class="main">)</span>
    <span class="main">(</span>upd_set <span class="skolem">a1_map</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">tp</span><span class="main">)</span> <span class="main">(</span><span class="free">rel1</span> <span class="main">-</span> Mapping.keys <span class="skolem">a1_map</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> upd_set <span class="skolem">a1_map</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">tp</span><span class="main">)</span> <span class="free">rel1</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tss'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tss'</span> <span class="main">=</span> append_queue <span class="free">nt</span> <span class="skolem">tss</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> add_new_mmuaux_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"add_new_mmuaux <span class="free">args</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="free">nt</span> <span class="free">aux</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">tss'</span><span class="main">,</span> <span class="skolem">len</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span>
    <span class="skolem">maskL</span><span class="main">,</span> <span class="skolem">maskR</span><span class="main">,</span> <span class="skolem">a1_map'</span><span class="main">,</span> <span class="skolem">a2_map'</span><span class="main">,</span> <span class="skolem">done</span><span class="main">,</span> <span class="skolem">done_length</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> shift_aux_def new_tstp_def tmp_def a2_map'_def a1_map'_def tss'_def
    <span class="keyword1"><span class="command">unfolding</span></span> I_def pos_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> add_new_mmuaux.simps Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> update_until_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"update_until <span class="free">args</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="free">nt</span> <span class="free">auxlist</span> <span class="main">=</span>
    <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">a1</span><span class="main">,</span> <span class="bound">a2</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="keyword1">if</span> <span class="skolem">pos</span> <span class="keyword1">then</span> join <span class="bound">a1</span> True <span class="free">rel1</span> <span class="keyword1">else</span> <span class="bound">a1</span> <span class="main">∪</span> <span class="free">rel1</span><span class="main">,</span>
      <span class="keyword1">if</span> mem <span class="skolem">I</span> <span class="main">(</span><span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="bound">a2</span> <span class="main">∪</span> join <span class="free">rel2</span> <span class="skolem">pos</span> <span class="bound">a1</span> <span class="keyword1">else</span> <span class="bound">a2</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">@</span>
    <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">rel1</span><span class="main">,</span> <span class="keyword1">if</span> memL <span class="skolem">I</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">rel2</span> <span class="keyword1">else</span> empty_table<span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> update_until_def I_def pos_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> len_done_auxlist<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">done</span> <span class="main">≤</span> length <span class="free">auxlist</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_shift_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> auxlist_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">auxlist</span> <span class="main">=</span> take <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="free">auxlist</span> <span class="main">@</span> drop <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> len_done_auxlist <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lin_tss'<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="skolem">tss'</span> <span class="main">=</span> linearize <span class="skolem">tss</span> <span class="main">@</span> <span class="main">[</span><span class="free">nt</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tss'_def append_queue_rep <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> len_lin_tss'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="skolem">tss'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">len</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lin_tss' <span class="keyword1"><span class="command">using</span></span> valid_shift_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> tmp<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>linearize <span class="skolem">tss</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="skolem">tss</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">cur</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_shift_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> sorted_lin_tss'<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>linearize <span class="skolem">tss'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lin_tss' <span class="keyword1"><span class="command">using</span></span> tmp<span class="main">(</span>1<span class="main">)</span> le_trans<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">OF</span> tmp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_append<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> in_lin_tss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="skolem">tss</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="bound">t</span> <span class="main">≤</span> <span class="free">cur</span> <span class="main">∧</span> memR <span class="skolem">I</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_shift_aux<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> set_lin_tss'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="skolem">tss'</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span> <span class="main">∧</span> memR <span class="skolem">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lin_tss' I_def <span class="keyword1"><span class="command">using</span></span> le_trans<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> valid_shift_aux<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_less<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> a1_map'_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.keys <span class="skolem">a1_map'</span> <span class="main">⊆</span> Mapping.keys <span class="skolem">a1_map</span> <span class="main">∪</span> <span class="free">rel1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> a1_map'_def <span class="keyword1"><span class="command">using</span></span> Mapping.keys_filter Mapping_upd_set_keys
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_upd_set_keys <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_filterD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tab_a1_map'_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="skolem">L</span> <span class="main">(</span>Mapping.keys <span class="skolem">a1_map'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_shift_aux<span class="main">(</span>1<span class="main">)</span> tabs<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> table_def n_def L_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> a2_map_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.keys <span class="skolem">a2_map</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">..</span><span class="skolem">tp</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_shift_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> a2_map'_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.keys <span class="skolem">a2_map'</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">..</span><span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> a2_map'_def Mapping.keys_update upd_nested_keys a2_map_keys <span class="keyword1"><span class="command">using</span></span> fst_tmp
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a2_map'_keys'<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.keys <span class="skolem">a2_map'</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">len</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">..</span><span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> len_upd_until<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">done</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">len</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>update_until <span class="free">args</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="free">nt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_shift_aux <span class="keyword1"><span class="command">unfolding</span></span> update_until_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> set_take_auxlist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">⟹</span> check_before <span class="skolem">I</span> <span class="free">nt</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_shift_aux <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> list_all2_triple<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> triple_eq_pair <span class="bound">x</span> <span class="bound">y</span> <span class="main">(</span><span class="main">λ</span><span class="bound">tp'</span><span class="main">.</span> filter_a1_map <span class="skolem">pos</span> <span class="bound">tp'</span> <span class="skolem">a1_map</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">ts'</span> <span class="bound">tp'</span><span class="main">.</span> filter_a2_map <span class="skolem">I</span> <span class="bound">ts'</span> <span class="bound">tp'</span> <span class="skolem">a2_map</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>
    <span class="main">(</span>zip <span class="main">(</span>linearize <span class="skolem">tss</span><span class="main">)</span> <span class="main">[</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">..&lt;</span><span class="skolem">tp</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_shift_aux <span class="keyword1"><span class="command">unfolding</span></span> I_def pos_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> set_drop_auxlist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span>check_before <span class="skolem">I</span> <span class="free">nt</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_shift_aux<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> list_all2_zip<span class="main"><span class="main">[</span></span><span class="operator">OF</span> list_all2_triple<span class="main"><span class="main">,</span></span>
      <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="skolem">tss</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> length_done_auxlist<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">done</span> <span class="main">≤</span> length <span class="free">auxlist</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_shift_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> take_auxlist_takeWhile<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="free">auxlist</span> <span class="main">=</span> takeWhile <span class="main">(</span>check_before <span class="skolem">I</span> <span class="free">nt</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> take_takeWhile<span class="main">[</span><span class="operator">OF</span> length_done_auxlist set_take_auxlist set_drop_auxlist<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">done</span> <span class="main">=</span> length <span class="main">(</span>takeWhile <span class="main">(</span>check_before <span class="skolem">I</span> <span class="free">nt</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> add_diff_cancel_right' auxlist_split diff_diff_cancel
        length_append length_done_auxlist length_drop take_auxlist_takeWhile<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> set_take_auxlist'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span>
    <span class="main">(</span>update_until <span class="free">args</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="free">nt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> check_before <span class="skolem">I</span> <span class="free">nt</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> I_def length_map map_proj_thd_update_until set_takeWhileD takeWhile_eq_take<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> rev_done<span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="skolem">done</span> <span class="main">=</span> map proj_thd <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_shift_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> map proj_thd <span class="main">(</span>takeWhile <span class="main">(</span>check_before <span class="skolem">I</span> <span class="free">nt</span><span class="main">)</span>
    <span class="main">(</span>update_until <span class="free">args</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="free">nt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_auxlist_takeWhile map_proj_thd_update_until I_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> rev_done'<span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="skolem">done</span> <span class="main">=</span> map proj_thd <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span>
    <span class="main">(</span>update_until <span class="free">args</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="free">nt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_map length_rev takeWhile_eq_take<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> map_fst_auxlist_take<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_take_auxlist linear <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> map_fst_auxlist_drop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> in_lin_tss<span class="main">[</span><span class="operator">OF</span> list_all2_zip<span class="main"><span class="main">[</span></span><span class="operator">OF</span> list_all2_triple<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="skolem">tss</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      assms<span class="main">(</span>4<span class="main">)</span> dual_order.trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> set_drop_auxlist_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">t</span> <span class="bound">a1</span> <span class="bound">a2</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">a1</span><span class="main">,</span> <span class="bound">a2</span><span class="main">)</span> <span class="main">⟹</span> mem <span class="skolem">I</span> <span class="main">(</span><span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> memL <span class="skolem">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">t</span> <span class="skolem">a1</span> <span class="skolem">a2</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">a1</span><span class="main">,</span> <span class="skolem">a2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> set_drop_auxlist not_less
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">⟷</span> memL <span class="skolem">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> sorted_fst_auxlist<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_shift_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> set_map_fst_auxlist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">auxlist</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> auxlist_split<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"map fst"</span></span><span class="main">,</span> <span class="operator">unfolded</span> map_append<span class="main">]</span> map_fst_auxlist_take
      map_fst_auxlist_drop <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lookup_a1_map_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">tp'</span><span class="main">.</span> Mapping.lookup <span class="skolem">a1_map</span> <span class="bound">xs</span> <span class="main">=</span> Some <span class="bound">tp'</span> <span class="main">⟹</span> <span class="bound">tp'</span> <span class="main">&lt;</span> <span class="skolem">tp</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_shift_aux Mapping_keys_intro <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> lookup_a1_map_keys'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> Mapping.keys <span class="skolem">a1_map'</span><span class="main">.</span>
    <span class="keyword1">case</span> Mapping.lookup <span class="skolem">a1_map'</span> <span class="bound">xs</span> <span class="keyword1">of</span> Some <span class="bound">tp'</span> <span class="main">⇒</span> <span class="bound">tp'</span> <span class="main">&lt;</span> <span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lookup_a1_map_keys <span class="keyword1"><span class="command">unfolding</span></span> a1_map'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping.lookup_filter Mapping_lookup_upd_set Mapping_upd_set_keys
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> sorted_upd_until<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>update_until <span class="free">args</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="free">nt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sorted_fst_auxlist set_map_fst_auxlist
    <span class="keyword1"><span class="command">unfolding</span></span> update_until_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_append comp_def fst_case<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> lookup_a2_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">tp'</span> <span class="bound">m</span><span class="main">.</span> Mapping.lookup <span class="skolem">a2_map</span> <span class="bound">tp'</span> <span class="main">=</span> Some <span class="bound">m</span> <span class="main">⟹</span>
    table <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>Mapping.keys <span class="bound">m</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> Mapping.keys <span class="bound">m</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="bound">m</span> <span class="bound">xs</span> <span class="keyword1">of</span> Some <span class="bound">tstp</span> <span class="main">⇒</span>
      tstp_lt <span class="bound">tstp</span> <span class="free">cur</span> <span class="skolem">tp</span> <span class="main">∧</span> <span class="main">(</span>isl <span class="bound">tstp</span> <span class="main">⟷</span> <span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_shift_aux<span class="main">(</span>1<span class="main">)</span> Mapping_keys_intro <span class="keyword1"><span class="command">unfolding</span></span> I_def n_def R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lookup_a2_map'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">tp'</span> <span class="bound">m</span> <span class="bound">xs</span> <span class="bound">tstp</span><span class="main">.</span> Mapping.lookup <span class="skolem">a2_map</span> <span class="bound">tp'</span> <span class="main">=</span> Some <span class="bound">m</span> <span class="main">⟹</span>
    Mapping.lookup <span class="bound">m</span> <span class="bound">xs</span> <span class="main">=</span> Some <span class="bound">tstp</span> <span class="main">⟹</span> tstp_lt <span class="bound">tstp</span> <span class="free">nt</span> <span class="skolem">tp</span> <span class="main">∧</span>
    isl <span class="bound">tstp</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Mapping_keys_intro assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tstp_lt_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> lookup_a2_map'_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">tp'</span> <span class="main">∈</span> Mapping.keys <span class="skolem">a2_map'</span><span class="main">.</span>
    <span class="keyword1">case</span> Mapping.lookup <span class="skolem">a2_map'</span> <span class="bound">tp'</span> <span class="keyword1">of</span> Some <span class="bound">m</span> <span class="main">⇒</span> table <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>Mapping.keys <span class="bound">m</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> Mapping.keys <span class="bound">m</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="bound">m</span> <span class="bound">xs</span> <span class="keyword1">of</span> Some <span class="bound">tstp</span> <span class="main">⇒</span>
    tstp_lt <span class="bound">tstp</span> <span class="free">nt</span> <span class="main">(</span><span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> isl <span class="bound">tstp</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tp'</span>
    <span class="keyword3"><span class="command">assume</span></span> tp'_assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp'</span> <span class="main">∈</span> Mapping.keys <span class="skolem">a2_map'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> m'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map'</span> <span class="skolem">tp'</span> <span class="main">=</span> Some <span class="skolem">m'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>Mapping.keys <span class="skolem">m'</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> Mapping.keys <span class="skolem">m'</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">m'</span> <span class="bound">xs</span> <span class="keyword1">of</span> Some <span class="bound">tstp</span> <span class="main">⇒</span>
      tstp_lt <span class="bound">tstp</span> <span class="free">nt</span> <span class="main">(</span><span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> isl <span class="bound">tstp</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp'</span> <span class="main">=</span> <span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> m'_def <span class="keyword1"><span class="command">unfolding</span></span> a2_map'_def True Mapping.lookup_update
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> table_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tp'_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp'</span> <span class="main">∈</span> Mapping.keys <span class="skolem">a2_map</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> tp'_assm <span class="keyword1"><span class="command">unfolding</span></span> a2_map_keys a2_map'_keys <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map</span> <span class="skolem">tp'</span> <span class="main">=</span> Some <span class="skolem">m</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> m'_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">=</span> upd_set' <span class="skolem">m</span> <span class="skolem">new_tstp</span> <span class="main">(</span>max_tstp <span class="skolem">new_tstp</span><span class="main">)</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">tp'</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">tmp</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> m_def m'_def <span class="keyword1"><span class="command">unfolding</span></span> a2_map'_def Mapping.lookup_update_neq<span class="main">[</span><span class="operator">OF</span> False<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
          upd_nested_lookup
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>Mapping.keys <span class="skolem">m'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> lookup_a2_map<span class="main">[</span><span class="operator">OF</span> m_def<span class="main">]</span> snd_tmp <span class="keyword1"><span class="command">unfolding</span></span> m'_alt upd_set'_keys
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> table_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> Mapping.keys <span class="skolem">m'</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">m'</span> <span class="bound">xs</span> <span class="keyword1">of</span> Some <span class="bound">tstp</span> <span class="main">⇒</span>
        tstp_lt <span class="bound">tstp</span> <span class="free">nt</span> <span class="main">(</span><span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> isl <span class="bound">tstp</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
        <span class="keyword3"><span class="command">assume</span></span> xs_assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> Mapping.keys <span class="skolem">m'</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tstp</span></span> <span class="keyword2"><span class="keyword">where</span></span> tstp_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m'</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="skolem">tstp</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tstp_lt <span class="skolem">tstp</span> <span class="free">nt</span> <span class="main">(</span><span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> isl <span class="skolem">tstp</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m</span> <span class="skolem">xs</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> None
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> tstp_def<span class="main">[</span><span class="operator">unfolded</span> m'_alt upd_set'_lookup<span class="main">]</span> new_tstp_lt_isl
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">tstp'</span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">tp'</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">tmp</span><span class="main">}</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tstp_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tstp</span> <span class="main">=</span> max_tstp <span class="skolem">new_tstp</span> <span class="skolem">tstp'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> tstp_def<span class="main">[</span><span class="operator">unfolded</span> m'_alt upd_set'_lookup<span class="main">]</span> Some
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> lookup_a2_map'<span class="main">[</span><span class="operator">OF</span> m_def Some<span class="main">]</span> new_tstp_lt_isl
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tstp_lt_def tstp_eq max_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> tstp_def<span class="main">[</span><span class="operator">unfolded</span> m'_alt upd_set'_lookup<span class="main">]</span> lookup_a2_map'<span class="main">[</span><span class="operator">OF</span> m_def Some<span class="main">]</span> Some
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tstp_lt_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> Mapping.lookup <span class="skolem">m'</span> <span class="skolem">xs</span> <span class="keyword1">of</span> Some <span class="bound">tstp</span> <span class="main">⇒</span>
          tstp_lt <span class="bound">tstp</span> <span class="free">nt</span> <span class="main">(</span><span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> isl <span class="bound">tstp</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">0</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> tstp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> Mapping.lookup <span class="skolem">a2_map'</span> <span class="skolem">tp'</span> <span class="keyword1">of</span> Some <span class="bound">m</span> <span class="main">⇒</span> table <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>Mapping.keys <span class="bound">m</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">xs</span> <span class="main">∈</span> Mapping.keys <span class="bound">m</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="bound">m</span> <span class="bound">xs</span> <span class="keyword1">of</span> Some <span class="bound">tstp</span> <span class="main">⇒</span>
      tstp_lt <span class="bound">tstp</span> <span class="free">nt</span> <span class="main">(</span><span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> isl <span class="bound">tstp</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> m'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> tp_upt_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">len</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">..&lt;</span><span class="skolem">tp</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">tp</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> upt_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> map_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">a1</span><span class="main">,</span> <span class="bound">a2</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="keyword1">if</span> <span class="skolem">pos</span> <span class="keyword1">then</span> join <span class="bound">a1</span> True <span class="free">rel1</span> <span class="keyword1">else</span> <span class="bound">a1</span> <span class="main">∪</span> <span class="free">rel1</span><span class="main">,</span>
      <span class="keyword1">if</span> mem <span class="skolem">I</span> <span class="main">(</span><span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="bound">a2</span> <span class="main">∪</span> join <span class="free">rel2</span> <span class="skolem">pos</span> <span class="bound">a1</span> <span class="keyword1">else</span> <span class="bound">a2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span>
    map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">a1</span><span class="main">,</span> <span class="bound">a2</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="keyword1">if</span> <span class="skolem">pos</span> <span class="keyword1">then</span> join <span class="bound">a1</span> True <span class="free">rel1</span> <span class="keyword1">else</span> <span class="bound">a1</span> <span class="main">∪</span> <span class="free">rel1</span><span class="main">,</span>
      <span class="keyword1">if</span> memL <span class="skolem">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">then</span> <span class="bound">a2</span> <span class="main">∪</span> join <span class="free">rel2</span> <span class="skolem">pos</span> <span class="bound">a1</span> <span class="keyword1">else</span> <span class="bound">a2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_drop_auxlist_cong <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="main">(</span>update_until <span class="free">args</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="free">nt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span>
    map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">a1</span><span class="main">,</span> <span class="bound">a2</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="keyword1">if</span> <span class="skolem">pos</span> <span class="keyword1">then</span> join <span class="bound">a1</span> True <span class="free">rel1</span> <span class="keyword1">else</span> <span class="bound">a1</span> <span class="main">∪</span> <span class="free">rel1</span><span class="main">,</span>
      <span class="keyword1">if</span> mem <span class="skolem">I</span> <span class="main">(</span><span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="bound">a2</span> <span class="main">∪</span> join <span class="free">rel2</span> <span class="skolem">pos</span> <span class="bound">a1</span> <span class="keyword1">else</span> <span class="bound">a2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">@</span>
    <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">rel1</span><span class="main">,</span> <span class="keyword1">if</span> memL <span class="skolem">I</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">rel2</span> <span class="keyword1">else</span> empty_table<span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> update_until_eq <span class="keyword1"><span class="command">using</span></span> len_done_auxlist drop_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> drop_update_until <span class="main">=</span> this<span class="main">[</span><span class="operator">unfolded</span> map_eq<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> list_all2_old<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> triple_eq_pair <span class="bound">x</span> <span class="bound">y</span> <span class="main">(</span><span class="main">λ</span><span class="bound">tp'</span><span class="main">.</span> filter_a1_map <span class="skolem">pos</span> <span class="bound">tp'</span> <span class="skolem">a1_map'</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">ts'</span> <span class="bound">tp'</span><span class="main">.</span> filter_a2_map <span class="skolem">I</span> <span class="bound">ts'</span> <span class="bound">tp'</span> <span class="skolem">a2_map'</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">a1</span><span class="main">,</span> <span class="bound">a2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="keyword1">if</span> <span class="skolem">pos</span> <span class="keyword1">then</span> join <span class="bound">a1</span> True <span class="free">rel1</span> <span class="keyword1">else</span> <span class="bound">a1</span> <span class="main">∪</span> <span class="free">rel1</span><span class="main">,</span>
      <span class="keyword1">if</span> memL <span class="skolem">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">then</span> <span class="bound">a2</span> <span class="main">∪</span> join <span class="free">rel2</span> <span class="skolem">pos</span> <span class="bound">a1</span> <span class="keyword1">else</span> <span class="bound">a2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>zip <span class="main">(</span>linearize <span class="skolem">tss</span><span class="main">)</span> <span class="main">[</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">..&lt;</span><span class="skolem">tp</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_all2_map1
    <span class="keyword1"><span class="command">using</span></span> list_all2_triple
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> list.rel_mono_strong<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tri</span> <span class="skolem">pair</span>
    <span class="keyword3"><span class="command">assume</span></span> tri_pair_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tri</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">pair</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">(</span>linearize <span class="skolem">tss</span><span class="main">)</span> <span class="main">[</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">..&lt;</span><span class="skolem">tp</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">a1</span></span> <span class="skolem"><span class="skolem">a2</span></span> <span class="keyword2"><span class="keyword">where</span></span> tri_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tri</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">a1</span><span class="main">,</span> <span class="skolem">a2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">tri</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ts'</span></span> <span class="skolem"><span class="skolem">tp'</span></span> <span class="keyword2"><span class="keyword">where</span></span> pair_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pair</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ts'</span><span class="main">,</span> <span class="skolem">tp'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">pair</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"triple_eq_pair <span class="skolem">tri</span> <span class="skolem">pair</span> <span class="main">(</span><span class="main">λ</span><span class="bound">tp'</span><span class="main">.</span> filter_a1_map <span class="skolem">pos</span> <span class="bound">tp'</span> <span class="skolem">a1_map</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">ts'</span> <span class="bound">tp'</span><span class="main">.</span> filter_a2_map <span class="skolem">I</span> <span class="bound">ts'</span> <span class="bound">tp'</span> <span class="skolem">a2_map</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eqs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="skolem">ts'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a1</span> <span class="main">=</span> filter_a1_map <span class="skolem">pos</span> <span class="skolem">tp'</span> <span class="skolem">a1_map</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">a2</span> <span class="main">=</span> filter_a2_map <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">a2_map</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> tri_def pair_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> tp'_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp'</span> <span class="main">≥</span> <span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tri_pair_in<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> pair_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> in_set_zipE<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> tp'_lt_tp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp'</span> <span class="main">&lt;</span> <span class="skolem">tp</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tri_pair_in<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> pair_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> in_set_zipE<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> ts'_in_lin_tss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts'</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="skolem">tss</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tri_pair_in<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> pair_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> in_set_zipE<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ts'_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts'</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_shift_aux<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> eqs<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="skolem">L</span> <span class="main">(</span>Mapping.keys <span class="skolem">a1_map</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_shift_aux <span class="keyword1"><span class="command">unfolding</span></span> n_def L_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> a1_tab<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="skolem">L</span> <span class="skolem">a1</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> eqs<span class="main">(</span>2<span class="main">)</span> filter_a1_map_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> table_def<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> tabR <span class="main">=</span> tabs<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> n_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> R_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> join_rel2_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">⊆</span> <span class="skolem">R</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">maskL</span> <span class="main">=</span> join_mask <span class="skolem">n</span> <span class="skolem">L</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_shift_aux <span class="keyword1"><span class="command">unfolding</span></span> n_def L_def R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> join_rel2_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"join <span class="free">rel2</span> <span class="skolem">pos</span> <span class="skolem">a1</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">xs</span></span> <span class="main">∈</span> <span class="free">rel2</span><span class="main">.</span> proj_tuple_in_join <span class="skolem">pos</span> <span class="skolem">maskL</span> <span class="bound">xs</span> <span class="skolem">a1</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> join_sub<span class="main">[</span><span class="operator">OF</span> join_rel2_assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> a1_tab tabR<span class="main">]</span> join_rel2_assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> filter_sub_a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">m'</span> <span class="bound">tp''</span> <span class="bound">tstp</span><span class="main">.</span> <span class="bound">tp''</span> <span class="main">≤</span> <span class="skolem">tp'</span> <span class="main">⟹</span>
      Mapping.lookup <span class="skolem">a2_map'</span> <span class="bound">tp''</span> <span class="main">=</span> Some <span class="bound">m'</span> <span class="main">⟹</span> Mapping.lookup <span class="bound">m'</span> <span class="bound">xs</span> <span class="main">=</span> Some <span class="bound">tstp</span> <span class="main">⟹</span>
      ts_tp_lt <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="bound">tstp</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">tstp</span> <span class="main">=</span> <span class="skolem">new_tstp</span> <span class="main">⟹</span> False<span class="main">)</span> <span class="main">⟹</span>
      <span class="bound">xs</span> <span class="main">∈</span> filter_a2_map <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">a2_map'</span> <span class="main">⟹</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="skolem">a2</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">m'</span> <span class="skolem">tp''</span> <span class="skolem">tstp</span>
      <span class="keyword3"><span class="command">assume</span></span> m'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp''</span> <span class="main">≤</span> <span class="skolem">tp'</span>"</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map'</span> <span class="skolem">tp''</span> <span class="main">=</span> Some <span class="skolem">m'</span>"</span></span>
        <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m'</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="skolem">tstp</span>"</span></span> <span class="quoted"><span class="quoted">"ts_tp_lt <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">tstp</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> tp''_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≠</span> <span class="skolem">tp''</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> le_less_trans<span class="main">[</span><span class="operator">OF</span> m'_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tp'_lt_tp<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">assume</span></span> new_tstp_False<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tstp</span> <span class="main">=</span> <span class="skolem">new_tstp</span> <span class="main">⟹</span> False"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="skolem">a2</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map</span> <span class="skolem">tp''</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> None
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> m'_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">=</span> upd_set' Mapping.empty <span class="skolem">new_tstp</span> <span class="main">(</span>max_tstp <span class="skolem">new_tstp</span><span class="main">)</span>
          <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">tp''</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">tmp</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> m'_def<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> a2_map'_def Mapping.lookup_update_neq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tp''_neq<span class="main"><span class="main">]</span></span>
            upd_nested_lookup<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> new_tstp_False m'_def<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> m'_alt upd_set'_lookup Mapping.lookup_empty<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">m</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> m'_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">=</span> upd_set' <span class="skolem">m</span> <span class="skolem">new_tstp</span> <span class="main">(</span>max_tstp <span class="skolem">new_tstp</span><span class="main">)</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">tp''</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">tmp</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> m'_def<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> a2_map'_def Mapping.lookup_update_neq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tp''_neq<span class="main"><span class="main">]</span></span>
            upd_nested_lookup<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> lookup_m <span class="main">=</span> Some
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m</span> <span class="skolem">xs</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> None
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> new_tstp_False m'_def<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> m'_alt upd_set'_lookup<span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">tstp'</span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> tstp_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tstp</span> <span class="main">=</span> <span class="skolem">tstp'</span> <span class="main">⟹</span> <span class="skolem">xs</span> <span class="main">∈</span> <span class="skolem">a2</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> eqs<span class="main">(</span>3<span class="main">)</span> lookup_m Some m'_def <span class="keyword1"><span class="command">unfolding</span></span> filter_a2_map_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">tp''</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">tmp</span><span class="main">}</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tstp_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tstp</span> <span class="main">=</span> max_tstp <span class="skolem">new_tstp</span> <span class="skolem">tstp'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> m'_def<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> m'_alt upd_set'_lookup Some<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> lookup_a2_map'<span class="main">[</span><span class="operator">OF</span> lookup_m Some<span class="main">]</span> new_tstp_lt_isl<span class="main">(</span>2<span class="main">)</span>
                tstp_eq new_tstp_False tstp_ok
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> max_tstpE<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">new_tstp</span></span> <span class="quoted"><span class="skolem">tstp'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tstp</span> <span class="main">=</span> <span class="skolem">tstp'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> m'_def<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> m'_alt upd_set'_lookup Some<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> tstp_ok <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> a2_sub_filter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a2</span> <span class="main">⊆</span> filter_a2_map <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">a2_map'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
      <span class="keyword3"><span class="command">assume</span></span> xs_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="skolem">a2</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tp''</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">tstp</span></span> <span class="keyword2"><span class="keyword">where</span></span> m_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp''</span> <span class="main">≤</span> <span class="skolem">tp'</span>"</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map</span> <span class="skolem">tp''</span> <span class="main">=</span> Some <span class="skolem">m</span>"</span></span>
        <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="skolem">tstp</span>"</span></span> <span class="quoted"><span class="quoted">"ts_tp_lt <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">tstp</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> eqs<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> filter_a2_map_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> tp''_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp''</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">..</span><span class="skolem">tp</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> m_def<span class="main">(</span>2<span class="main">)</span> a2_map_keys <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Mapping_keys_intro<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> m'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map'</span> <span class="skolem">tp''</span> <span class="main">=</span> Some <span class="skolem">m'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a2_map'_keys
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Mapping_keys_dest One_nat_def add_Suc_right add_diff_cancel_right'
            atLeastatMost_subset_iff diff_zero le_eq_less_or_eq le_less_Suc_eq subsetD<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> tp''_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≠</span> <span class="skolem">tp''</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> m_def<span class="main">(</span>1<span class="main">)</span> tp'_lt_tp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> m'_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">=</span> upd_set' <span class="skolem">m</span> <span class="skolem">new_tstp</span> <span class="main">(</span>max_tstp <span class="skolem">new_tstp</span><span class="main">)</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">tp''</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">tmp</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> m'_def<span class="main">[</span><span class="operator">unfolded</span> a2_map'_def Mapping.lookup_update_neq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tp''_neq<span class="main"><span class="main">]</span></span> m_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
          upd_nested_lookup<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> filter_a2_map <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">a2_map'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">tp''</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">tmp</span><span class="main">}</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m'</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="main">(</span>max_tstp <span class="skolem">new_tstp</span> <span class="skolem">tstp</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> m'_alt upd_set'_lookup m_def<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ts_tp_lt <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="main">(</span>max_tstp <span class="skolem">new_tstp</span> <span class="skolem">tstp</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> new_tstp_lt_isl<span class="main">(</span>2<span class="main">)</span> lookup_a2_map'<span class="main">[</span><span class="operator">OF</span> m_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> max_tstp_intro''<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ m_def<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> filter_a2_map_def <span class="keyword1"><span class="command">using</span></span> m_def<span class="main">(</span>1<span class="main">)</span> m'_def m_def<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m'</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="skolem">tstp</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> m'_alt upd_set'_lookup m_def<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> filter_a2_map_def <span class="keyword1"><span class="command">using</span></span> m_def<span class="main">(</span>1<span class="main">)</span> m'_def m_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pos</span> <span class="main">⟹</span> filter_a1_map <span class="skolem">pos</span> <span class="skolem">tp'</span> <span class="skolem">a1_map'</span> <span class="main">=</span> join <span class="skolem">a1</span> True <span class="free">rel1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> pos<span class="main">:</span> <span class="quoted"><span class="skolem">pos</span></span>
      <span class="keyword1"><span class="command">note</span></span> tabL <span class="main">=</span> tabs<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> n_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> L_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> join_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"join <span class="skolem">a1</span> True <span class="free">rel1</span> <span class="main">=</span> <span class="skolem">a1</span> <span class="main">∩</span> <span class="free">rel1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> join_eq<span class="main">[</span><span class="operator">OF</span> tabL a1_tab<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"filter_a1_map <span class="skolem">pos</span> <span class="skolem">tp'</span> <span class="skolem">a1_map'</span> <span class="main">=</span> join <span class="skolem">a1</span> True <span class="free">rel1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> eqs<span class="main">(</span>2<span class="main">)</span> pos tp'_lt_tp <span class="keyword1"><span class="command">unfolding</span></span> filter_a1_map_def a1_map'_def join_eq
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping.lookup_filter Mapping_lookup_upd_set <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Mapping_keys_intro <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest Mapping_keys_filterD<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="skolem">pos</span> <span class="main">⟹</span> filter_a1_map <span class="skolem">pos</span> <span class="skolem">tp'</span> <span class="skolem">a1_map'</span> <span class="main">=</span> <span class="skolem">a1</span> <span class="main">∪</span> <span class="free">rel1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eqs<span class="main">(</span>2<span class="main">)</span> tp'_lt_tp <span class="keyword1"><span class="command">unfolding</span></span> filter_a1_map_def a1_map'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping.lookup_filter Mapping_lookup_upd_set <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Mapping_keys_intro
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_filterD Mapping_keys_dest <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memL <span class="skolem">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">⟹</span> filter_a2_map <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">a2_map'</span> <span class="main">=</span> <span class="skolem">a2</span> <span class="main">∪</span> join <span class="free">rel2</span> <span class="skolem">pos</span> <span class="skolem">a1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
      <span class="keyword3"><span class="command">assume</span></span> in_int<span class="main">:</span> <span class="quoted"><span class="quoted">"memL <span class="skolem">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> xs_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> filter_a2_map <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">a2_map'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="skolem"><span class="skolem">tp''</span></span> <span class="skolem"><span class="skolem">tstp</span></span> <span class="keyword2"><span class="keyword">where</span></span> m'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp''</span> <span class="main">≤</span> <span class="skolem">tp'</span>"</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map'</span> <span class="skolem">tp''</span> <span class="main">=</span> Some <span class="skolem">m'</span>"</span></span>
        <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m'</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="skolem">tstp</span>"</span></span> <span class="quoted"><span class="quoted">"ts_tp_lt <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">tstp</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> filter_a2_map_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="skolem">a2</span> <span class="main">∪</span> join <span class="free">rel2</span> <span class="skolem">pos</span> <span class="skolem">a1</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">tstp</span> <span class="main">=</span> <span class="skolem">new_tstp</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">note</span></span> tstp_new_tstp <span class="main">=</span> True
        <span class="keyword1"><span class="command">have</span></span> tp''_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≠</span> <span class="skolem">tp''</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> m'_def<span class="main">(</span>1<span class="main">)</span> tp'_lt_tp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> tp''_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp''</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">..</span><span class="skolem">tp</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> m'_def<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> tp'_lt_tp a2_map'_keys
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Mapping_keys_intro<span class="main">)</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map</span> <span class="skolem">tp''</span> <span class="main">=</span> Some <span class="skolem">m</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">=</span> upd_set' <span class="skolem">m</span> <span class="skolem">new_tstp</span> <span class="main">(</span>max_tstp <span class="skolem">new_tstp</span><span class="main">)</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">tp''</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">tmp</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> m'_def<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> a2_map'_def Mapping.lookup_update_neq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tp''_neq<span class="main"><span class="main">]</span></span>
            upd_nested_lookup<span class="main">]</span> tp''_in a2_map_keys
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="skolem">new_tstp</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> eqs<span class="main">(</span>3<span class="main">)</span> m'_def<span class="main">(</span>1<span class="main">)</span> m_def<span class="main">(</span>1<span class="main">)</span> m'_def tstp_new_tstp
            <span class="keyword1"><span class="command">unfolding</span></span> filter_a2_map_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> xs_in_snd_tmp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">tp''</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">tmp</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> m'_def<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> m_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> upd_set'_lookup True<span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> xs_in_rel2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="free">rel2</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> tmp_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">pos</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tp'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> tp'''_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a1_map</span> <span class="main">(</span>proj_tuple <span class="skolem">maskL</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">tp'''</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> <span class="skolem">pos</span> <span class="keyword1">then</span> <span class="skolem">tp''</span> <span class="main">=</span> max <span class="main">(</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">)</span> <span class="skolem">tp'''</span> <span class="keyword1">else</span> <span class="skolem">tp''</span> <span class="main">=</span> max <span class="main">(</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">)</span> <span class="main">(</span><span class="skolem">tp'''</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> xs_in_snd_tmp m'_def<span class="main">(</span>1<span class="main">)</span> tp'_lt_tp True
              <span class="keyword1"><span class="command">unfolding</span></span> tmp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"proj_tuple <span class="skolem">maskL</span> <span class="skolem">xs</span> <span class="main">∈</span> <span class="skolem">a1</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> eqs<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> filter_a1_map_def<span class="main">]</span> True m'_def<span class="main">(</span>1<span class="main">)</span> tp'''_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Mapping_keys_intro<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> True xs_in_rel2 <span class="keyword1"><span class="command">unfolding</span></span> proj_tuple_in_join_def join_rel2_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a1_map</span> <span class="main">(</span>proj_tuple <span class="skolem">maskL</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> None
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">using</span></span> xs_in_rel2 False eqs<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> filter_a1_map_def<span class="main">]</span>
                <span class="keyword1"><span class="command">unfolding</span></span> proj_tuple_in_join_def join_rel2_eq
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest<span class="main">)</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">tp'''</span><span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tp''</span> <span class="main">=</span> max <span class="main">(</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">)</span> <span class="main">(</span><span class="skolem">tp'''</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> xs_in_snd_tmp m'_def<span class="main">(</span>1<span class="main">)</span> tp'_lt_tp False
                <span class="keyword1"><span class="command">unfolding</span></span> tmp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tp'''</span> <span class="main">&lt;</span> <span class="skolem">tp'</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> m'_def<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"proj_tuple <span class="skolem">maskL</span> <span class="skolem">xs</span> <span class="main">∉</span> <span class="skolem">a1</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> eqs<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> filter_a1_map_def<span class="main">]</span> True m'_def<span class="main">(</span>1<span class="main">)</span> Some False
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Mapping_keys_intro<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">using</span></span> xs_in_rel2 False <span class="keyword1"><span class="command">unfolding</span></span> proj_tuple_in_join_def join_rel2_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> filter_sub_a2<span class="main">[</span><span class="operator">OF</span> m'_def _ xs_in<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
      <span class="keyword3"><span class="command">assume</span></span> in_int<span class="main">:</span> <span class="quoted"><span class="quoted">"memL <span class="skolem">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> xs_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="skolem">a2</span> <span class="main">∪</span> join <span class="free">rel2</span> <span class="skolem">pos</span> <span class="skolem">a1</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="skolem">a2</span> <span class="main">∪</span> <span class="main">(</span>join <span class="free">rel2</span> <span class="skolem">pos</span> <span class="skolem">a1</span> <span class="main">-</span> <span class="skolem">a2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> filter_a2_map <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">a2_map'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> UnE<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="skolem">a2</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> filter_a2_map <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">a2_map'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> a2_sub_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> join <span class="free">rel2</span> <span class="skolem">pos</span> <span class="skolem">a1</span> <span class="main">-</span> <span class="skolem">a2</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> xs_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="free">rel2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∉</span> <span class="skolem">a2</span>"</span></span> <span class="quoted"><span class="quoted">"proj_tuple_in_join <span class="skolem">pos</span> <span class="skolem">maskL</span> <span class="skolem">xs</span> <span class="skolem">a1</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> join_rel2_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> ts_tp_lt_new_tstp<span class="main">:</span> <span class="quoted"><span class="quoted">"ts_tp_lt <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">new_tstp</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> tp'_lt_tp in_int t_nt eqs<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> new_tstp_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tp_lt_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> contrapos_np<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> filter_a2_map <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">a2_map'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">pos</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tp'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> tp'''_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp'''</span> <span class="main">≤</span> <span class="skolem">tp'</span>"</span></span>
            <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a1_map</span> <span class="main">(</span>proj_tuple <span class="skolem">maskL</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">tp'''</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> eqs<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> filter_a1_map_def<span class="main">]</span> xs_props<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> proj_tuple_in_join_def<span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest<span class="main">)</span>
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">wtp</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">wtp</span> <span class="main">≡</span> max <span class="main">(</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">)</span> <span class="skolem">tp'''</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> wtp_xs_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">wtp</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">tmp</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> wtp_def <span class="keyword1"><span class="command">using</span></span> tp'''_def tmp_def xs_props<span class="main">(</span>1<span class="main">)</span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">have</span></span> wtp_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">wtp</span> <span class="main">≤</span> <span class="skolem">tp'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> tp'''_def<span class="main">(</span>1<span class="main">)</span> tp'_ge <span class="keyword1"><span class="command">unfolding</span></span> wtp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> wtp_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">wtp</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">..</span><span class="skolem">tp</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> tp'''_def<span class="main">(</span>1<span class="main">)</span> tp'_lt_tp <span class="keyword1"><span class="command">unfolding</span></span> wtp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> wtp_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≠</span> <span class="skolem">wtp</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> wtp_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map</span> <span class="skolem">wtp</span> <span class="main">=</span> Some <span class="skolem">m</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> wtp_in a2_map_keys Mapping_keys_dest <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> m'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map'</span> <span class="skolem">wtp</span> <span class="main">=</span> Some <span class="skolem">m'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> wtp_in a2_map'_keys Mapping_keys_dest <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">have</span></span> m'_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">=</span> upd_set' <span class="skolem">m</span> <span class="skolem">new_tstp</span> <span class="main">(</span>max_tstp <span class="skolem">new_tstp</span><span class="main">)</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">wtp</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">tmp</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> m'_def<span class="main">[</span><span class="operator">unfolded</span> a2_map'_def Mapping.lookup_update_neq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wtp_neq<span class="main"><span class="main">]</span></span>
              upd_nested_lookup m_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m</span> <span class="skolem">xs</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> None
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m'</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="skolem">new_tstp</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> wtp_xs_in <span class="keyword1"><span class="command">unfolding</span></span> m'_alt upd_set'_lookup None <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> filter_a2_map_def <span class="keyword1"><span class="command">using</span></span> wtp_le m'_def ts_tp_lt_new_tstp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">tstp'</span><span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m'</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="main">(</span>max_tstp <span class="skolem">new_tstp</span> <span class="skolem">tstp'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> wtp_xs_in <span class="keyword1"><span class="command">unfolding</span></span> m'_alt upd_set'_lookup Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ts_tp_lt <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="main">(</span>max_tstp <span class="skolem">new_tstp</span> <span class="skolem">tstp'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> max_tstp_intro' ts_tp_lt_new_tstp lookup_a2_map'<span class="main">[</span><span class="operator">OF</span> m_def Some<span class="main">]</span> new_tstp_lt_isl
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> lookup_a2_map'<span class="main">[</span><span class="operator">OF</span> m_def Some<span class="main">]</span> wtp_le m'_def
              <span class="keyword1"><span class="command">unfolding</span></span> filter_a2_map_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a1_map</span> <span class="main">(</span>proj_tuple <span class="skolem">maskL</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> None
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> in_tmp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">tmp</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> tmp_def False xs_props<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map</span> <span class="main">(</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">m</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> a2_map_keys <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest<span class="main">)</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> m'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map'</span> <span class="main">(</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">m'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> a2_map'_keys <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> tp_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≠</span> <span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> m'_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">=</span> upd_set' <span class="skolem">m</span> <span class="skolem">new_tstp</span> <span class="main">(</span>max_tstp <span class="skolem">new_tstp</span><span class="main">)</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">tmp</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> m'_def<span class="main">[</span><span class="operator">unfolded</span> a2_map'_def Mapping.lookup_update_neq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tp_neq<span class="main"><span class="main">]</span></span>
                upd_nested_lookup m_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m</span> <span class="skolem">xs</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> None
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m'</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="skolem">new_tstp</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> m'_alt upd_set'_lookup None <span class="keyword1"><span class="command">using</span></span> in_tmp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> filter_a2_map_def <span class="keyword1"><span class="command">using</span></span> tp'_ge m'_def ts_tp_lt_new_tstp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">tstp'</span><span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m'</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="main">(</span>max_tstp <span class="skolem">new_tstp</span> <span class="skolem">tstp'</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> m'_alt upd_set'_lookup Some <span class="keyword1"><span class="command">using</span></span> in_tmp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ts_tp_lt <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="main">(</span>max_tstp <span class="skolem">new_tstp</span> <span class="skolem">tstp'</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> max_tstp_intro' ts_tp_lt_new_tstp lookup_a2_map'<span class="main">[</span><span class="operator">OF</span> m_def Some<span class="main">]</span> new_tstp_lt_isl
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> filter_a2_map_def <span class="keyword1"><span class="command">using</span></span> tp'_ge m'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">tp'''</span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tp'_gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp'</span> <span class="main">&gt;</span> <span class="skolem">tp'''</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> xs_props<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> proj_tuple_in_join_def<span class="main">]</span> eqs<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> filter_a1_map_def<span class="main">]</span>
                False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Mapping_keys_intro<span class="main">)</span>
            <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">wtp</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">wtp</span> <span class="main">≡</span> max <span class="main">(</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">)</span> <span class="main">(</span><span class="skolem">tp'''</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> wtp_xs_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">wtp</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">tmp</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> wtp_def tmp_def <span class="keyword1"><span class="command">using</span></span> xs_props<span class="main">(</span>1<span class="main">)</span> Some False <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
            <span class="keyword1"><span class="command">have</span></span> wtp_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">wtp</span> <span class="main">≤</span> <span class="skolem">tp'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> tp'_ge tp'_gt <span class="keyword1"><span class="command">unfolding</span></span> wtp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> wtp_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">wtp</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">..</span><span class="skolem">tp</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> tp'_lt_tp tp'_gt <span class="keyword1"><span class="command">unfolding</span></span> wtp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> wtp_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≠</span> <span class="skolem">wtp</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> wtp_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map</span> <span class="skolem">wtp</span> <span class="main">=</span> Some <span class="skolem">m</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> wtp_in a2_map_keys Mapping_keys_dest <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> m'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map'</span> <span class="skolem">wtp</span> <span class="main">=</span> Some <span class="skolem">m'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> wtp_in a2_map'_keys Mapping_keys_dest <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
            <span class="keyword1"><span class="command">have</span></span> m'_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">=</span> upd_set' <span class="skolem">m</span> <span class="skolem">new_tstp</span> <span class="main">(</span>max_tstp <span class="skolem">new_tstp</span><span class="main">)</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">wtp</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">tmp</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> m'_def<span class="main">[</span><span class="operator">unfolded</span> a2_map'_def Mapping.lookup_update_neq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wtp_neq<span class="main"><span class="main">]</span></span>
                upd_nested_lookup m_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m</span> <span class="skolem">xs</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> None
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m'</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="skolem">new_tstp</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> wtp_xs_in <span class="keyword1"><span class="command">unfolding</span></span> m'_alt upd_set'_lookup None <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> filter_a2_map_def <span class="keyword1"><span class="command">using</span></span> wtp_le m'_def ts_tp_lt_new_tstp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">tstp'</span><span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m'</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="main">(</span>max_tstp <span class="skolem">new_tstp</span> <span class="skolem">tstp'</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> wtp_xs_in <span class="keyword1"><span class="command">unfolding</span></span> m'_alt upd_set'_lookup Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ts_tp_lt <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="main">(</span>max_tstp <span class="skolem">new_tstp</span> <span class="skolem">tstp'</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> max_tstp_intro' ts_tp_lt_new_tstp lookup_a2_map'<span class="main">[</span><span class="operator">OF</span> m_def Some<span class="main">]</span> new_tstp_lt_isl
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">using</span></span> lookup_a2_map'<span class="main">[</span><span class="operator">OF</span> m_def Some<span class="main">]</span> wtp_le m'_def
                <span class="keyword1"><span class="command">unfolding</span></span> filter_a2_map_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">⟹</span> filter_a2_map <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">a2_map'</span> <span class="main">=</span> <span class="skolem">a2</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
      <span class="keyword3"><span class="command">assume</span></span> out<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memL <span class="skolem">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> xs_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> filter_a2_map <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">a2_map'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="skolem"><span class="skolem">tp''</span></span> <span class="skolem"><span class="skolem">tstp</span></span> <span class="keyword2"><span class="keyword">where</span></span> m'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp''</span> <span class="main">≤</span> <span class="skolem">tp'</span>"</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map'</span> <span class="skolem">tp''</span> <span class="main">=</span> Some <span class="skolem">m'</span>"</span></span>
        <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m'</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="skolem">tstp</span>"</span></span> <span class="quoted"><span class="quoted">"ts_tp_lt <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">tstp</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> filter_a2_map_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> new_tstp_False<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tstp</span> <span class="main">=</span> <span class="skolem">new_tstp</span> <span class="main">⟹</span> False"</span></span>
        <span class="keyword1"><span class="command">using</span></span> m'_def t_nt out tp'_lt_tp <span class="keyword1"><span class="command">unfolding</span></span> eqs<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tp_lt_def new_tstp_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> contrapos_np<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="skolem">a2</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> filter_sub_a2<span class="main">[</span><span class="operator">OF</span> m'_def new_tstp_False xs_in<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="skolem">a2</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> filter_a2_map <span class="skolem">I</span> <span class="skolem">ts'</span> <span class="skolem">tp'</span> <span class="skolem">a2_map'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a2_sub_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"triple_eq_pair <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">tri</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">a1</span><span class="main">,</span> <span class="bound">a2</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="keyword1">if</span> <span class="skolem">pos</span> <span class="keyword1">then</span> join <span class="bound">a1</span> True <span class="free">rel1</span> <span class="keyword1">else</span> <span class="bound">a1</span> <span class="main">∪</span> <span class="free">rel1</span><span class="main">,</span>
      <span class="keyword1">if</span> memL <span class="skolem">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">then</span> <span class="bound">a2</span> <span class="main">∪</span> join <span class="free">rel2</span> <span class="skolem">pos</span> <span class="bound">a1</span> <span class="keyword1">else</span> <span class="bound">a2</span><span class="main">)</span><span class="main">)</span>
      <span class="skolem">pair</span> <span class="main">(</span><span class="main">λ</span><span class="bound">tp'</span><span class="main">.</span> filter_a1_map <span class="skolem">pos</span> <span class="bound">tp'</span> <span class="skolem">a1_map'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ts'</span> <span class="bound">tp'</span><span class="main">.</span> filter_a2_map <span class="skolem">I</span> <span class="bound">ts'</span> <span class="bound">tp'</span> <span class="skolem">a2_map'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eqs <span class="keyword1"><span class="command">unfolding</span></span> tri_def pair_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> filter_a1_map_rel1<span class="main">:</span> <span class="quoted"><span class="quoted">"filter_a1_map <span class="skolem">pos</span> <span class="skolem">tp</span> <span class="skolem">a1_map'</span> <span class="main">=</span> <span class="free">rel1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> filter_a1_map_def a1_map'_def <span class="keyword1"><span class="command">using</span></span> leD lookup_a1_map_keys
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> a1_map_lookup less_imp_le_nat Mapping.lookup_filter
        Mapping_lookup_upd_set keys_is_none_rep <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_filterD
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Mapping_keys_intro <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> filter_a1_map_rel2<span class="main">:</span> <span class="quoted"><span class="quoted">"filter_a2_map <span class="skolem">I</span> <span class="free">nt</span> <span class="skolem">tp</span> <span class="skolem">a2_map'</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> memL <span class="skolem">I</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">rel2</span> <span class="keyword1">else</span> empty_table<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"memL <span class="skolem">I</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">note</span></span> left_I_zero <span class="main">=</span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">tp'</span> <span class="bound">m'</span> <span class="bound">xs</span> <span class="bound">tstp</span><span class="main">.</span> <span class="bound">tp'</span> <span class="main">≤</span> <span class="skolem">tp</span> <span class="main">⟹</span> Mapping.lookup <span class="skolem">a2_map'</span> <span class="bound">tp'</span> <span class="main">=</span> Some <span class="bound">m'</span> <span class="main">⟹</span>
      Mapping.lookup <span class="bound">m'</span> <span class="bound">xs</span> <span class="main">=</span> Some <span class="bound">tstp</span> <span class="main">⟹</span> ts_tp_lt <span class="skolem">I</span> <span class="free">nt</span> <span class="skolem">tp</span> <span class="bound">tstp</span> <span class="main">⟹</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="free">rel2</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tp'</span> <span class="skolem">m'</span> <span class="skolem">xs</span> <span class="skolem">tstp</span>
      <span class="keyword3"><span class="command">assume</span></span> lassms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp'</span> <span class="main">≤</span> <span class="skolem">tp</span>"</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map'</span> <span class="skolem">tp'</span> <span class="main">=</span> Some <span class="skolem">m'</span>"</span></span>
        <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m'</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="skolem">tstp</span>"</span></span> <span class="quoted"><span class="quoted">"ts_tp_lt <span class="skolem">I</span> <span class="free">nt</span> <span class="skolem">tp</span> <span class="skolem">tstp</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> tp'_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≠</span> <span class="skolem">tp'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> lassms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> tp'_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp'</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">..</span><span class="skolem">tp</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> lassms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> a2_map'_keys tp'_neq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Mapping_keys_intro<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map</span> <span class="skolem">tp'</span> <span class="main">=</span> Some <span class="skolem">m</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">=</span> upd_set' <span class="skolem">m</span> <span class="skolem">new_tstp</span> <span class="main">(</span>max_tstp <span class="skolem">new_tstp</span><span class="main">)</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">tp'</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">tmp</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> lassms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> a2_map'_def Mapping.lookup_update_neq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tp'_neq<span class="main"><span class="main">]</span></span>
          upd_nested_lookup<span class="main">]</span> tp'_in a2_map_keys
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Mapping_keys_intro <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">tp'</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">tmp</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∉</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">tp'</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">tmp</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Some<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="skolem">tstp</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> lassms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> m_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> upd_set'_lookup<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
          <span class="keyword1"><span class="command">using</span></span> lookup_a2_map'<span class="main">[</span><span class="operator">OF</span> m_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Some<span class="main">]</span> lassms<span class="main">(</span>4<span class="main">)</span> left_I_zero
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tstp_lt_def ts_tp_lt_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="free">rel2</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> tmp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="free">rel2</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">m'</span> <span class="bound">tstp</span><span class="main">.</span> Mapping.lookup <span class="skolem">a2_map'</span> <span class="skolem">tp</span> <span class="main">=</span> Some <span class="bound">m'</span> <span class="main">∧</span>
      Mapping.lookup <span class="bound">m'</span> <span class="bound">xs</span> <span class="main">=</span> Some <span class="bound">tstp</span> <span class="main">∧</span> ts_tp_lt <span class="skolem">I</span> <span class="free">nt</span> <span class="skolem">tp</span> <span class="bound">tstp</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span>
      <span class="keyword3"><span class="command">assume</span></span> lassms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="free">rel2</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> m'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map'</span> <span class="skolem">tp</span> <span class="main">=</span> Some <span class="skolem">m'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a2_map'_keys <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> tp_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≠</span> <span class="skolem">tp</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map</span> <span class="skolem">tp</span> <span class="main">=</span> Some <span class="skolem">m</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">=</span> upd_set' <span class="skolem">m</span> <span class="skolem">new_tstp</span> <span class="main">(</span>max_tstp <span class="skolem">new_tstp</span><span class="main">)</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">tp</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">tmp</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> m'_def a2_map_keys <span class="keyword1"><span class="command">unfolding</span></span> a2_map'_def Mapping.lookup_update_neq<span class="main">[</span><span class="operator">OF</span> tp_neq<span class="main">]</span>
          upd_nested_lookup
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
           <span class="main">(</span><span class="operator">metis</span> Mapping_keys_dest atLeastAtMost_iff diff_le_self le_eq_less_or_eq
            option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> xs_in_tmp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">tp</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">tmp</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> lassms left_I_zero <span class="keyword1"><span class="command">unfolding</span></span> tmp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">m'</span> <span class="bound">tstp</span><span class="main">.</span> Mapping.lookup <span class="skolem">a2_map'</span> <span class="skolem">tp</span> <span class="main">=</span> Some <span class="bound">m'</span> <span class="main">∧</span>
        Mapping.lookup <span class="bound">m'</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="bound">tstp</span> <span class="main">∧</span> ts_tp_lt <span class="skolem">I</span> <span class="free">nt</span> <span class="skolem">tp</span> <span class="bound">tstp</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m</span> <span class="skolem">xs</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> None
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m'</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="skolem">new_tstp</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> xs_in_tmp <span class="keyword1"><span class="command">unfolding</span></span> m_def<span class="main">(</span>2<span class="main">)</span> upd_set'_lookup None <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ts_tp_lt <span class="skolem">I</span> <span class="free">nt</span> <span class="skolem">tp</span> <span class="skolem">new_tstp</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> left_I_zero new_tstp_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tp_lt_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> xs_in_tmp m_def
          <span class="keyword1"><span class="command">unfolding</span></span> a2_map'_def Mapping.lookup_update_neq<span class="main">[</span><span class="operator">OF</span> tp_neq<span class="main">]</span> upd_nested_lookup <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">tstp'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m'</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="main">(</span>max_tstp <span class="skolem">new_tstp</span> <span class="skolem">tstp'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> xs_in_tmp <span class="keyword1"><span class="command">unfolding</span></span> m_def<span class="main">(</span>2<span class="main">)</span> upd_set'_lookup Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ts_tp_lt <span class="skolem">I</span> <span class="free">nt</span> <span class="skolem">tp</span> <span class="main">(</span>max_tstp <span class="skolem">new_tstp</span> <span class="skolem">tstp'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> max_tstpE<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">new_tstp</span></span> <span class="quoted"><span class="skolem">tstp'</span></span><span class="main">]</span> lookup_a2_map'<span class="main">[</span><span class="operator">OF</span> m_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Some<span class="main">]</span> new_tstp_lt_isl left_I_zero
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.discI<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> new_tstp_def ts_tp_lt_def tstp_lt_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> xs_in_tmp m_def
          <span class="keyword1"><span class="command">unfolding</span></span> a2_map'_def Mapping.lookup_update_neq<span class="main">[</span><span class="operator">OF</span> tp_neq<span class="main">]</span> upd_nested_lookup <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_a2_map_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">note</span></span> left_I_pos <span class="main">=</span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">tp'</span> <span class="bound">m</span> <span class="bound">xs</span> <span class="bound">tstp</span><span class="main">.</span> <span class="bound">tp'</span> <span class="main">≤</span> <span class="skolem">tp</span> <span class="main">⟹</span> Mapping.lookup <span class="skolem">a2_map'</span> <span class="bound">tp'</span> <span class="main">=</span> Some <span class="bound">m</span> <span class="main">⟹</span>
      Mapping.lookup <span class="bound">m</span> <span class="bound">xs</span> <span class="main">=</span> Some <span class="bound">tstp</span> <span class="main">⟹</span> <span class="main">¬</span><span class="main">(</span>ts_tp_lt <span class="skolem">I</span> <span class="free">nt</span> <span class="skolem">tp</span> <span class="bound">tstp</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tp'</span> <span class="skolem">m'</span> <span class="skolem">xs</span> <span class="skolem">tstp</span>
      <span class="keyword3"><span class="command">assume</span></span> lassms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp'</span> <span class="main">≤</span> <span class="skolem">tp</span>"</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map'</span> <span class="skolem">tp'</span> <span class="main">=</span> Some <span class="skolem">m'</span>"</span></span>
        <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m'</span> <span class="skolem">xs</span> <span class="main">=</span> Some <span class="skolem">tstp</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> lassms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> tp'_neq_Suc_tp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≠</span> <span class="skolem">tp'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span>ts_tp_lt <span class="skolem">I</span> <span class="free">nt</span> <span class="skolem">tp</span> <span class="skolem">tstp</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">a2_map</span> <span class="skolem">tp'</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> None
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tp'_in_tmp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp'</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="skolem">tmp</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          m'_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">=</span> upd_set' Mapping.empty <span class="skolem">new_tstp</span> <span class="main">(</span>max_tstp <span class="skolem">new_tstp</span><span class="main">)</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">tp'</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">tmp</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> lassms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> a2_map'_def Mapping.lookup_update_neq<span class="main">[</span><span class="operator">OF</span> tp'_neq_Suc_tp<span class="main">]</span>
            upd_nested_lookup <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tstp</span> <span class="main">=</span> <span class="skolem">new_tstp</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> lassms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> m'_alt upd_set'_lookup<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping.lookup_empty <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tp_lt_def new_tstp_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits sum.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">m</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> m'_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">=</span> upd_set' <span class="skolem">m</span> <span class="skolem">new_tstp</span> <span class="main">(</span>max_tstp <span class="skolem">new_tstp</span><span class="main">)</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">tp'</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">tmp</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> lassms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> a2_map'_def Mapping.lookup_update_neq<span class="main">[</span><span class="operator">OF</span> tp'_neq_Suc_tp<span class="main">]</span>
            upd_nested_lookup <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">note</span></span> lookup_a2_map_tp' <span class="main">=</span> Some
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">m</span> <span class="skolem">xs</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> None
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tstp</span> <span class="main">=</span> <span class="skolem">new_tstp</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> lassms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> m'_alt upd_set'_lookup <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tp_lt_def new_tstp_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits sum.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">tstp'</span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">tp'</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">tmp</span><span class="main">}</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tstp_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tstp</span> <span class="main">=</span> max_tstp <span class="skolem">new_tstp</span> <span class="skolem">tstp'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> lassms<span class="main">(</span>3<span class="main">)</span>
              <span class="keyword1"><span class="command">unfolding</span></span> m'_alt upd_set'_lookup Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> max_tstpE<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">new_tstp</span></span> <span class="quoted"><span class="skolem">tstp'</span></span><span class="main">]</span> lookup_a2_map'<span class="main">[</span><span class="operator">OF</span> lookup_a2_map_tp' Some<span class="main">]</span> new_tstp_lt_isl left_I_pos
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tstp_eq tstp_lt_def ts_tp_lt_def new_tstp_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> lassms<span class="main">(</span>3<span class="main">)</span> lookup_a2_map'<span class="main">[</span><span class="operator">OF</span> lookup_a2_map_tp' Some<span class="main">]</span>
                nat_le_linear<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">nt</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">tstp</span> <span class="keyword1">of</span> Inl <span class="bound">ts</span> <span class="main">⇒</span> <span class="bound">ts</span>"</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">unfolding</span></span> m'_alt upd_set'_lookup Some
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tp_lt_def tstp_lt_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> sum.splits<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_a2_map_def empty_table_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> zip_dist<span class="main">:</span> <span class="quoted"><span class="quoted">"zip <span class="main">(</span>linearize <span class="skolem">tss</span> <span class="main">@</span> <span class="main">[</span><span class="free">nt</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">..&lt;</span><span class="skolem">tp</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">tp</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
    zip <span class="main">(</span>linearize <span class="skolem">tss</span><span class="main">)</span> <span class="main">[</span><span class="skolem">tp</span> <span class="main">-</span> <span class="skolem">len</span><span class="main">..&lt;</span><span class="skolem">tp</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="skolem">tp</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_shift_aux<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> list_all2'<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> triple_eq_pair <span class="bound">x</span> <span class="bound">y</span> <span class="main">(</span><span class="main">λ</span><span class="bound">tp'</span><span class="main">.</span> filter_a1_map <span class="skolem">pos</span> <span class="bound">tp'</span> <span class="skolem">a1_map'</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">ts'</span> <span class="bound">tp'</span><span class="main">.</span> filter_a2_map <span class="skolem">I</span> <span class="bound">ts'</span> <span class="bound">tp'</span> <span class="skolem">a2_map'</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="main">(</span>update_until <span class="free">args</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="free">nt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>zip <span class="main">(</span>linearize <span class="skolem">tss'</span><span class="main">)</span> <span class="main">[</span><span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">len</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">tp</span> <span class="main">+</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lin_tss' tp_upt_Suc drop_update_until zip_dist
    <span class="keyword1"><span class="command">using</span></span> filter_a1_map_rel1 filter_a1_map_rel2 list_all2_appendI<span class="main">[</span><span class="operator">OF</span> list_all2_old<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_shift_aux len_lin_tss' sorted_lin_tss' set_lin_tss' tab_a1_map'_keys a2_map'_keys'
      len_upd_until sorted_upd_until lookup_a1_map_keys' rev_done' set_take_auxlist'
      lookup_a2_map'_keys list_all2'
    <span class="keyword1"><span class="command">unfolding</span></span> valid_mmuaux_def add_new_mmuaux_eq valid_mmuaux'.simps
      I_def n_def L_def R_def pos_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_all2_check_before<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> triple_eq_pair <span class="bound">x</span> <span class="bound">y</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">xs</span> <span class="main">(</span>zip <span class="free">ys</span> <span class="free">zs</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span> <span class="main">⟹</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="main">¬</span>check_before <span class="free">I</span> <span class="free">nt</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_zip <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all2_in_setE triple_eq_pair.elims<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_mmuaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'a</span> mmuaux <span class="main">⇒</span> <span class="tfree">'a</span> table list <span class="main">×</span> <span class="tfree">'a</span> mmuaux"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_mmuaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">tp</span><span class="main">,</span> <span class="bound">tss</span><span class="main">,</span> <span class="bound">len</span><span class="main">,</span> <span class="bound">maskL</span><span class="main">,</span> <span class="bound">maskR</span><span class="main">,</span> <span class="bound">a1_map</span><span class="main">,</span> <span class="bound">a2_map</span><span class="main">,</span> <span class="bound">done</span><span class="main">,</span> <span class="bound">done_length</span><span class="main">)</span> <span class="main">=</span>
    shift_mmuaux <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="keyword1">in</span>
    <span class="main">(</span>rev <span class="bound">done</span><span class="main">,</span> <span class="main">(</span><span class="bound">tp</span><span class="main">,</span> <span class="bound">tss</span><span class="main">,</span> <span class="bound">len</span><span class="main">,</span> <span class="bound">maskL</span><span class="main">,</span> <span class="bound">maskR</span><span class="main">,</span> <span class="bound">a1_map</span><span class="main">,</span> <span class="bound">a2_map</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_eval_mmuaux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_mmuaux <span class="free">args</span> <span class="free">cur</span> <span class="free">aux</span> <span class="free">auxlist</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">nt</span> <span class="main">≥</span> <span class="free">cur</span>"</span></span>
    <span class="quoted"><span class="quoted">"eval_mmuaux <span class="free">args</span> <span class="free">nt</span> <span class="free">aux</span> <span class="main">=</span> <span class="main">(</span><span class="free">res</span><span class="main">,</span> <span class="free">aux'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"eval_until <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="free">nt</span> <span class="free">auxlist</span> <span class="main">=</span> <span class="main">(</span><span class="free">res'</span><span class="main">,</span> <span class="free">auxlist'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">res</span> <span class="main">=</span> <span class="free">res'</span> <span class="main">∧</span> valid_mmuaux <span class="free">args</span> <span class="free">cur</span> <span class="free">aux'</span> <span class="free">auxlist'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> args_ivl <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pos</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pos</span> <span class="main">=</span> args_pos <span class="free">args</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> valid_folded<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_mmuaux' <span class="free">args</span> <span class="free">cur</span> <span class="free">nt</span> <span class="free">aux</span> <span class="free">auxlist</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> valid_mmuaux'_mono <span class="keyword1"><span class="command">unfolding</span></span> valid_mmuaux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tp</span></span> <span class="skolem"><span class="skolem">len</span></span> <span class="skolem"><span class="skolem">tss</span></span> <span class="skolem"><span class="skolem">maskL</span></span> <span class="skolem"><span class="skolem">maskR</span></span> <span class="skolem"><span class="skolem">a1_map</span></span> <span class="skolem"><span class="skolem">a2_map</span></span> <span class="quoted">"<span class="skolem"><span class="skolem">done</span></span>"</span> <span class="skolem"><span class="skolem">done_length</span></span> <span class="keyword2"><span class="keyword">where</span></span> shift_aux_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"shift_mmuaux <span class="free">args</span> <span class="free">nt</span> <span class="free">aux</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">tp</span><span class="main">,</span> <span class="skolem">tss</span><span class="main">,</span> <span class="skolem">len</span><span class="main">,</span> <span class="skolem">maskL</span><span class="main">,</span> <span class="skolem">maskR</span><span class="main">,</span> <span class="skolem">a1_map</span><span class="main">,</span> <span class="skolem">a2_map</span><span class="main">,</span> <span class="skolem">done</span><span class="main">,</span> <span class="skolem">done_length</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"shift_mmuaux <span class="free">args</span> <span class="free">nt</span> <span class="free">aux</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> valid_shift_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_mmuaux' <span class="free">args</span> <span class="free">cur</span> <span class="free">nt</span> <span class="main">(</span><span class="skolem">tp</span><span class="main">,</span> <span class="skolem">tss</span><span class="main">,</span> <span class="skolem">len</span><span class="main">,</span> <span class="skolem">maskL</span><span class="main">,</span> <span class="skolem">maskR</span><span class="main">,</span>
    <span class="skolem">a1_map</span><span class="main">,</span> <span class="skolem">a2_map</span><span class="main">,</span> <span class="skolem">done</span><span class="main">,</span> <span class="skolem">done_length</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ts</span><span class="main">.</span> <span class="bound">ts</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="skolem">tss</span><span class="main">)</span> <span class="main">⟹</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_shift_mmuaux'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> valid_mmuaux_def<span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> shift_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> len_done_auxlist<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">done</span> <span class="main">≤</span> length <span class="free">auxlist</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_shift_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> list_all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">⟹</span> check_before <span class="skolem">I</span> <span class="free">nt</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_shift_aux <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> set_drop_auxlist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span>check_before <span class="skolem">I</span> <span class="free">nt</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_shift_aux<span class="main">[</span><span class="operator">unfolded</span> valid_mmuaux'.simps<span class="main">]</span>
      list_all2_check_before<span class="main">[</span><span class="operator">OF</span> _ valid_shift_aux<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">have</span></span> take_auxlist_takeWhile<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="free">auxlist</span> <span class="main">=</span> takeWhile <span class="main">(</span>check_before <span class="skolem">I</span> <span class="free">nt</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> len_done_auxlist list_all set_drop_auxlist
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> take_takeWhile<span class="main">)</span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> rev_done<span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="skolem">done</span> <span class="main">=</span> map proj_thd <span class="main">(</span>take <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_shift_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> res'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">res'</span> <span class="main">=</span> rev <span class="skolem">done</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval_until_res<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> take_auxlist_takeWhile I_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> auxlist'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">auxlist'</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="skolem">done</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval_until_auxlist'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> eval_mmuaux_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_mmuaux <span class="free">args</span> <span class="free">nt</span> <span class="free">aux</span> <span class="main">=</span> <span class="main">(</span>rev <span class="skolem">done</span><span class="main">,</span> <span class="main">(</span><span class="skolem">tp</span><span class="main">,</span> <span class="skolem">tss</span><span class="main">,</span> <span class="skolem">len</span><span class="main">,</span> <span class="skolem">maskL</span><span class="main">,</span> <span class="skolem">maskR</span><span class="main">,</span>
    <span class="skolem">a1_map</span><span class="main">,</span> <span class="skolem">a2_map</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> shift_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> done_empty_valid_mmuaux'_intro<span class="main">[</span><span class="operator">OF</span> valid_shift_aux<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> shift_aux_def eval_mmuaux_eq pos_def auxlist'_def res'_def valid_mmuaux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">init_mmuaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> <span class="tfree">'a</span> mmuaux"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">init_mmuaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> empty_queue<span class="main">,</span> <span class="main">0</span><span class="main">,</span>
  join_mask <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_L <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span><span class="main">,</span> join_mask <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_R <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span><span class="main">,</span>
  Mapping.empty<span class="main">,</span> Mapping.update <span class="main">0</span> Mapping.empty Mapping.empty<span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_init_mmuaux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">⊆</span> <span class="free">R</span> <span class="main">⟹</span> valid_mmuaux <span class="main">(</span>init_args <span class="free">I</span> <span class="free">n</span> <span class="free">L</span> <span class="free">R</span> <span class="free">b</span><span class="main">)</span> <span class="main">0</span>
  <span class="main">(</span>init_mmuaux <span class="main">(</span>init_args <span class="free">I</span> <span class="free">n</span> <span class="free">L</span> <span class="free">R</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> init_mmuaux_def valid_mmuaux_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_args_def empty_queue_rep table_def Mapping.lookup_update<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">length_mmuaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> <span class="tfree">'a</span> mmuaux <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">length_mmuaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tp</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tss</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">len</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a1_map</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a2_map</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">done</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">done_length</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="free"><span class="bound"><span class="entity">len</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">done_length</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_length_mmuaux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_mmuaux <span class="free">args</span> <span class="free">cur</span> <span class="free">aux</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length_mmuaux <span class="free">args</span> <span class="free">aux</span> <span class="main">=</span> length <span class="free">auxlist</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">aux</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_mmuaux_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span>

<span class="comment1">(* begin trigger (mtaux) *)</span>

<span class="comment1">(* simply stores all tables for φ and ψ in [0, b] *)</span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> mtaux <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> table <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">time</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> table <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> <span class="main">⇒</span> ts"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">time</span> <span class="main">=</span> fst"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">relL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> table <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">relL</span> <span class="main">=</span> <span class="main">(</span>fst <span class="keyword1">o</span> snd<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">relR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> table <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">relR</span> <span class="main">=</span> <span class="main">(</span>snd <span class="keyword1">o</span> snd<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> mmtaux <span class="main">=</span> <span class="quoted"><span class="quoted">"
  ts <span class="main">×</span>                                 <span class="comment1">― ‹the newest timestamp›</span>
  nat <span class="main">×</span> nat <span class="main">×</span> nat <span class="main">×</span>                   <span class="comment1">― ‹index of the first queue entry in data_prev, data_in and the last index of data_in›</span>
  bool list <span class="main">×</span>                          <span class="comment1">― ‹maskL, i.e. all free variables of R \\ L are masked›</span>
  bool list <span class="main">×</span>                          <span class="comment1">― ‹maskR, i.e. all free variables of L \\ R are masked›</span>
  <span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> table <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> queue <span class="main">×</span>  <span class="comment1">― ‹data_prev: all databases containing the tuples satisfying the lhs or the rhs where the timestamp doesn't yet satisfy memL›</span>
  <span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> queue <span class="main">×</span>              <span class="comment1">― ‹data_in: all databases containing the tuples satisfying the rhs where the ts is in the interval›</span>
  <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> tuple<span class="main">,</span> ts<span class="main">)</span> mapping<span class="main">)</span> <span class="main">×</span>           <span class="comment1">― ‹tuple_in for once›</span>
  <span class="tfree">'a</span> table <span class="main">×</span>                            <span class="comment1">― ‹Mapping.keys tuple_in_once, just here for performance improvements›</span>
  <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> tuple<span class="main">,</span> nat<span class="main">)</span> mapping<span class="main">)</span> <span class="main">×</span>          <span class="comment1">― ‹tuple_since for historically. stores the index since when the rhs of the formula holds›</span>
  <span class="main">(</span><span class="tfree">'a</span> table<span class="main">)</span> <span class="main">×</span>
  <span class="main">(</span><span class="tfree">'a</span> table<span class="main">)</span>                            <span class="comment1">― ‹the set of tuples currently satisfying ψ S_[0, ∞] (ψ ∧ φ)›</span>
"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mmtaux_data_prev</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mmtaux <span class="main">⇒</span> <span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> table <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> queue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mmtaux_data_prev</span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mmtaux_data_in</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mmtaux <span class="main">⇒</span> <span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> queue"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mmtaux_data_in</span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ts_tuple_rel_binary</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> table <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> tuple <span class="main">×</span> <span class="tfree">'a</span> tuple<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ts_tuple_rel_binary</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">as</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">bs</span> <span class="main">∈</span> <span class="bound">Y</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">ts_tuple_rel_binary_lhs</span> <span class="main">≡</span> ts_tuple_rel_f fst"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">ts_tuple_rel_binary_rhs</span> <span class="main">≡</span> ts_tuple_rel_f snd"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">auxlist_data_prev</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> table <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> table <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">auxlist_data_prev</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">mt</span></span></span> <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memL <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mt</span></span></span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">auxlist_data_in</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> table <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> table <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">auxlist_data_in</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">mt</span></span></span> <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mt</span></span></span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tuple_since_tp</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tuple_since_tp</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">lin_data_in</span></span></span> <span class="free"><span class="bound"><span class="entity">idx_oldest</span></span></span> <span class="free"><span class="bound"><span class="entity">idx_mid</span></span></span> <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lin_data_in</span></span></span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">idx_mid</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="main">(</span><span class="free"><span class="bound"><span class="entity">idx</span></span></span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">idx_oldest</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">lin_data_in</span></span></span><span class="main">)</span><span class="main">.</span> 
      <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">∈</span> <span class="bound">r</span>
    <span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">idx</span></span></span> <span class="main">&gt;</span> <span class="free"><span class="bound"><span class="entity">idx_oldest</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">∉</span> <span class="main">(</span>snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">lin_data_in</span></span></span><span class="main">!</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">idx</span></span></span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">idx_oldest</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tuple_since_lhs</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tuple_since_lhs</span> <span class="free"><span class="bound"><span class="entity">tuple</span></span></span> <span class="free"><span class="bound"><span class="entity">lin_data_in</span></span></span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span> <span class="free"><span class="bound"><span class="entity">auxlist_in</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">lin_data_in</span></span></span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span> <span class="comment1">― ‹with an empty data_in, all tuples satisfy trigger›</span>
    <span class="main">∃</span><span class="bound">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free"><span class="bound"><span class="entity">lin_data_in</span></span></span><span class="main">}</span><span class="main">.</span> <span class="comment1">― ‹dropping less then length guarantees length suffix &gt; 0›</span>
      <span class="keyword1">let</span> <span class="bound">suffix</span> <span class="main">=</span> drop <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">auxlist_in</span></span></span> <span class="keyword1">in</span> <span class="main">(</span>
        <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">suffix</span><span class="main">.</span>
          <span class="free"><span class="bound"><span class="entity">tuple</span></span></span> <span class="main">∈</span> <span class="bound">r</span>
        <span class="main">)</span> <span class="main">∧</span>
        <span class="main">(</span>
          join_cond <span class="main">(</span>args_pos <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="bound">suffix</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free"><span class="bound"><span class="entity">maskL</span></span></span> <span class="free"><span class="bound"><span class="entity">tuple</span></span></span><span class="main">)</span>
        <span class="main">)</span>
    <span class="main">)</span>
  <span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">valid_mmtaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'a</span> mmtaux <span class="main">⇒</span> <span class="tfree">'a</span> mtaux <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valid_mmtaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">cur</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mt</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">idx_next</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">idx_mid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">idx_oldest</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in_once</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in_once_keys</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_since_hist</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">hist_sat</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">since_sat</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span> <span class="main">⟷</span>
    <span class="main">(</span><span class="keyword1">if</span> mem <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span>args_L <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>args_R <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>args_L <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>args_R <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">¬</span>mem <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="main">⟶</span> args_pos <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">maskL</span></span></span> <span class="main">=</span> join_mask <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_L <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">maskR</span></span></span> <span class="main">=</span> join_mask <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_R <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">relL</span><span class="main">,</span> <span class="bound">relR</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span><span class="main">.</span> table <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_L <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="bound">relL</span> <span class="main">∧</span> table <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_R <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="bound">relR</span><span class="main">)</span> <span class="main">∧</span>
    table <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_L <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>Mapping.keys <span class="free"><span class="bound"><span class="entity">tuple_in_once</span></span></span><span class="main">)</span> <span class="main">∧</span>
    table <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_R <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>Mapping.keys <span class="free"><span class="bound"><span class="entity">tuple_since_hist</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>relL<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_L <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>relR<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_R <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>snd<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_R <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">cur</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">mt</span></span></span> <span class="main">∧</span>
    <span class="comment1">― ‹all valid rhs/ψ tuples in data_in should have a valid entry in tuple_since_hist, as it is shifted›</span>
    ts_tuple_rel_binary_rhs <span class="main">(</span>set <span class="main">(</span>auxlist_data_in <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">mt</span></span></span> <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="comment1">― ‹the entries stored should be the same, hence they're sorted as well›</span>
    sorted <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span><span class="main">)</span> <span class="main">∧</span>
    auxlist_data_prev <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">mt</span></span></span> <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">)</span> <span class="main">∧</span>
    auxlist_data_prev <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">mt</span></span></span> <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span> <span class="main">=</span> drop <span class="main">(</span>length <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span> <span class="main">∧</span>
    length <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">idx_mid</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">idx_next</span></span></span>  <span class="main">∧</span>  <span class="comment1">― ‹length (linearize data_prev) = idx_next - idx_mid›</span>
    map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">mt</span></span></span> <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">)</span> <span class="main">∧</span>
    auxlist_data_in <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">mt</span></span></span> <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span> <span class="main">=</span> take <span class="main">(</span>length <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span> <span class="main">∧</span>
    length <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">)</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">idx_oldest</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">idx_mid</span></span></span> <span class="main">∧</span> <span class="comment1">― ‹length (linearize data_in) = idx_mid - idx_oldest›</span>
    <span class="comment1">― ‹also all tuples in auxlist (and hence data_prev/data_in) satisfy memR ›</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span><span class="main">.</span> time <span class="bound">db</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">mt</span></span></span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mt</span></span></span> <span class="main">-</span> time <span class="bound">db</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
     <span class="comment1">― ‹check whether tuple_in once contains the newest occurence of the tuple satisfying the lhs›</span>
    newest_tuple_in_mapping fst <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span> <span class="free"><span class="bound"><span class="entity">tuple_in_once</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="free"><span class="bound"><span class="entity">tuple_in_once</span></span></span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free"><span class="bound"><span class="entity">tuple_in_once</span></span></span> <span class="bound">as</span> <span class="keyword1">of</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="main">∃</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">)</span> <span class="main">∧</span> join_cond <span class="main">(</span>args_pos <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span>proj_tuple <span class="free"><span class="bound"><span class="entity">maskL</span></span></span> <span class="bound">as</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">as</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="free"><span class="bound"><span class="entity">tuple_since_hist</span></span></span> <span class="bound">as</span> <span class="keyword1">of</span>
      Some <span class="bound">idx</span> <span class="main">⇒</span> tuple_since_tp <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="bound">as</span> <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">idx_oldest</span></span></span> <span class="free"><span class="bound"><span class="entity">idx_mid</span></span></span> <span class="bound">idx</span>
      <span class="main">|</span> None   <span class="main">⇒</span> <span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span>tuple_since_tp <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="bound">as</span> <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">idx_oldest</span></span></span> <span class="free"><span class="bound"><span class="entity">idx_mid</span></span></span> <span class="bound">idx</span><span class="main">)</span>
    <span class="main">)</span> <span class="main">∧</span>
    <span class="comment1">― ‹conditions for sat / trigger conditions›</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">hist_sat</span></span></span> <span class="main">⟷</span>
      <span class="main">(</span><span class="main">¬</span>is_empty <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span> <span class="comment1">― ‹with an empty data_in, all tuples satisfy trigger›</span>
        <span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">mt</span></span></span> <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span><span class="main">)</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="bound">r</span>
    <span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">since_sat</span></span></span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">(</span><span class="bound">tuple</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">hist_sat</span></span></span><span class="main">)</span> <span class="main">∨</span> tuple_since_lhs <span class="bound">tuple</span> <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span> <span class="main">(</span>auxlist_data_in <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">mt</span></span></span> <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> tuple_since_lhs <span class="bound">tuple</span> <span class="main">(</span>linearize <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span> <span class="main">(</span>auxlist_data_in <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">mt</span></span></span> <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span><span class="main">)</span> <span class="main">⟶</span>
      <span class="bound">tuple</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">since_sat</span></span></span>
    <span class="main">)</span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">tuple_in_once_keys</span></span></span> <span class="main">=</span> Mapping.keys <span class="free"><span class="bound"><span class="entity">tuple_in_once</span></span></span>
  "</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">init_mmtaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> <span class="tfree">'a</span> mmtaux"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">init_mmtaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> <span class="main">0</span><span class="main">,</span> join_mask <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_L <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span><span class="main">,</span>
  join_mask <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_R <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span><span class="main">,</span> empty_queue<span class="main">,</span> empty_queue<span class="main">,</span> Mapping.empty<span class="main">,</span> <span class="main">{}</span><span class="main">,</span> Mapping.empty<span class="main">,</span> <span class="main">{}</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_init_mmtaux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>
    <span class="keyword1">if</span> <span class="main">(</span>mem <span class="free">I</span> <span class="main">0</span><span class="main">)</span>
      <span class="keyword1">then</span>
        <span class="free">L</span> <span class="main">⊆</span> <span class="free">R</span>
      <span class="keyword1">else</span> 
        <span class="free">L</span> <span class="main">=</span> <span class="free">R</span>
    <span class="main">)</span> <span class="main">⟹</span>
    <span class="main">¬</span>mem <span class="free">I</span> <span class="main">0</span> <span class="main">⟶</span> <span class="free">pos</span> <span class="main">⟹</span>
    <span class="keyword1">let</span> <span class="bound">args</span> <span class="main">=</span> init_args <span class="free">I</span> <span class="free">n</span> <span class="free">L</span> <span class="free">R</span> <span class="free">pos</span> <span class="keyword1">in</span>
    valid_mmtaux <span class="bound">args</span> <span class="main">0</span> <span class="main">(</span>init_mmtaux <span class="bound">args</span><span class="main">)</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> init_mmtaux_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_args_def empty_queue_rep
      Mapping.lookup_empty safe_max_def table_def newest_tuple_in_mapping_def
      ts_tuple_rel_binary_def ts_tuple_rel_f_def
      auxlist_data_prev_def auxlist_data_in_def is_empty_alt tuple_since_tp_def tuple_since_lhs_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">result_mmtaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> event_data mmtaux <span class="main">⇒</span> <span class="main">(</span>nat set <span class="main">×</span> event_data table<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">result_mmtaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">mt</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">idx_next</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">idx_mid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">idx_oldest</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in_once</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in_once_keys</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_since_hist</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">hist_sat</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">since_sat</span></span></span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span>
    <span class="comment1">― ‹with an empty data_in, all tuples satisfy trigger›</span>
    <span class="keyword1">if</span> <span class="main">(</span>is_empty <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
      <span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="main">{</span>replicate <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> None<span class="main">}</span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="main">(</span>args_R <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in_once_keys</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">hist_sat</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">since_sat</span></span></span><span class="main">)</span>
  <span class="main">)</span>
"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_filter_dropWhile_memL<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> dropWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span><span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">=</span> dropWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span><span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span><span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dropWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> dropWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> not_mem<span class="main">:</span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> filter_IH<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span><span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">#</span><span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span><span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> dropWhile_IH<span class="main">:</span> <span class="quoted"><span class="quoted">"dropWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> not_mem
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">db</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span><span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> filter_IH
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> dropWhile_IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">!</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">xs</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> atLeastLessThan_iff case_prod_beta' in_set_conv_nth leI not_less_zero<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">!</span><span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">!</span><span class="main">0</span><span class="main">)</span> <span class="main">≤</span> fst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">!</span><span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> j_props
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> not_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_filter_dropWhile_memR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> dropWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">=</span> dropWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dropWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> dropWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> mem<span class="main">:</span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> filter_IH<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">#</span><span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> dropWhile_IH<span class="main">:</span> <span class="quoted"><span class="quoted">"dropWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mem
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">db</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> filter_IH
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> dropWhile_IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">!</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">xs</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> atLeastLessThan_iff case_prod_beta' in_set_conv_nth leI not_less_zero<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">!</span><span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">!</span><span class="main">0</span><span class="main">)</span> <span class="main">≤</span> fst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">!</span><span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> j_props
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> memR_antimono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_filter_takeWhile_memL<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> takeWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">=</span> takeWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">#</span><span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">#</span><span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> not_mem<span class="main">:</span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> filter_IH<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> takeWhile_IH<span class="main">:</span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> not_mem
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">db</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> filter_IH
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> takeWhile_IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">!</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">xs</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> atLeastLessThan_iff case_prod_beta' in_set_conv_nth leI not_less_zero<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">!</span><span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">!</span><span class="main">0</span><span class="main">)</span> <span class="main">≤</span> fst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">!</span><span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> j_props
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> not_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_filter_takeWhile_not_memR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> takeWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">=</span> takeWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">#</span><span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span><span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">#</span><span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> not_mem<span class="main">:</span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> filter_IH<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> takeWhile_IH<span class="main">:</span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> not_mem
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">db</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> filter_IH
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> takeWhile_IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">!</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">xs</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> atLeastLessThan_iff case_prod_beta' in_set_conv_nth leI not_less_zero<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">!</span><span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">!</span><span class="main">0</span><span class="main">)</span> <span class="main">≤</span> fst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">!</span><span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> j_props
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> memR_antimono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> not_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> data_in_mem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_mmtaux <span class="free">args</span> <span class="free">cur</span> <span class="main">(</span><span class="free">mt</span><span class="main">,</span> <span class="free">idx_next</span><span class="main">,</span> <span class="free">idx_mid</span><span class="main">,</span> <span class="free">idx_oldest</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in_once</span><span class="main">,</span> <span class="free">tuple_in_once_keys</span><span class="main">,</span> <span class="free">tuple_since_hist</span><span class="main">,</span> <span class="free">hist_sat</span><span class="main">,</span> <span class="free">since_sat</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">db</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="main">(</span>fst <span class="free">db</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">db</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pair <span class="skolem">t</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Pair assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def
    <span class="keyword1"><span class="command">using</span></span> set_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">auxlist</span></span><span class="main">]</span> Pair
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> data_prev_mem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_mmtaux <span class="free">args</span> <span class="free">cur</span> <span class="main">(</span><span class="free">mt</span><span class="main">,</span> <span class="free">idx_next</span><span class="main">,</span> <span class="free">idx_mid</span><span class="main">,</span> <span class="free">idx_oldest</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in_once</span><span class="main">,</span> <span class="free">tuple_in_once_keys</span><span class="main">,</span> <span class="free">tuple_since_hist</span><span class="main">,</span> <span class="free">hist_sat</span><span class="main">,</span> <span class="free">since_sat</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">db</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="main">(</span>time <span class="free">db</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">=</span> linearize <span class="free">data_prev</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">db</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_prev_def time_def
    <span class="keyword1"><span class="command">using</span></span> set_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">auxlist</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> data_sorted<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_mmtaux <span class="free">args</span> <span class="free">cur</span> <span class="main">(</span><span class="free">mt</span><span class="main">,</span> <span class="free">idx_next</span><span class="main">,</span> <span class="free">idx_mid</span><span class="main">,</span> <span class="free">idx_oldest</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in_once</span><span class="main">,</span> <span class="free">tuple_in_once_keys</span><span class="main">,</span> <span class="free">tuple_since_hist</span><span class="main">,</span> <span class="free">hist_sat</span><span class="main">,</span> <span class="free">since_sat</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t'</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">&lt;</span> <span class="bound">t'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> sorted<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> data_props<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> data_props<span class="main">(</span>1<span class="main">)</span> sorted sorted_filter
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_prev_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> fst <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">tuple</span><span class="main">)</span> <span class="main">=</span> fst <span class="bound">tuple</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map fst <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map fst <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> sorted <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def
    <span class="keyword1"><span class="command">using</span></span> sorted_filter
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> data_props<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">t'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> memL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> data_in_mem<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> data_prev_mem<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> time_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≥</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> memL memL_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&lt;</span> <span class="skolem">t'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_le_imp_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t'</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">&lt;</span> <span class="bound">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tuple_in_once_mem0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_mmtaux <span class="free">args</span> <span class="free">cur</span> <span class="main">(</span><span class="free">mt</span><span class="main">,</span> <span class="free">idx_next</span><span class="main">,</span> <span class="free">idx_mid</span><span class="main">,</span> <span class="free">idx_oldest</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in_once</span><span class="main">,</span> <span class="free">tuple_in_once_keys</span><span class="main">,</span> <span class="free">tuple_since_hist</span><span class="main">,</span> <span class="free">hist_sat</span><span class="main">,</span> <span class="free">since_sat</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">tuple_in_once</span> <span class="main">=</span> Mapping.empty"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> memL_all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="bound">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">=</span> linearize <span class="free">data_prev</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_prev</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> memL_all
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_prev_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_in_once</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">tuple_in_once</span> <span class="bound">as</span> <span class="keyword1">of</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="main">∃</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">∧</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="bound">as</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.keys <span class="free">tuple_in_once</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Mapping_keys_dest
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping.lookup_empty keys_dom_lookup mapping_eqI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> auxlist_mem_or<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_mmtaux <span class="free">args</span> <span class="free">cur</span> <span class="main">(</span><span class="free">mt</span><span class="main">,</span> <span class="free">idx_next</span><span class="main">,</span> <span class="free">idx_mid</span><span class="main">,</span> <span class="free">idx_oldest</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in_once</span><span class="main">,</span> <span class="free">tuple_in_once_keys</span><span class="main">,</span> <span class="free">tuple_since_hist</span><span class="main">,</span> <span class="free">hist_sat</span><span class="main">,</span> <span class="free">since_sat</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">db</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">auxlist</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="free">db</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">∧</span> <span class="free">db</span> <span class="main">∉</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> time <span class="free">db</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="free">db</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">∧</span> <span class="free">db</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> time <span class="free">db</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="main">(</span>time <span class="free">db</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">db'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">db'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="free">db</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> data_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">=</span> linearize <span class="free">data_prev</span>"</span></span>
    <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> linearize <span class="free">data_in</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> time <span class="free">db</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">db</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">db</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> data_props<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="main">(</span>time <span class="free">db</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_prev_def time_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> not_prev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">db</span> <span class="main">∉</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> db_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">db</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> True assms<span class="main">(</span>2<span class="main">)</span> mem
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def time_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="free">db</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">db'</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> data_props<span class="main">(</span>2<span class="main">)</span> db'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> time <span class="free">db</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> db_mem
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def time_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> db'_def not_prev <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">db'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">db'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="free">db</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> data_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">=</span> linearize <span class="free">data_prev</span>"</span></span>
    <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> linearize <span class="free">data_in</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> time <span class="free">db</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> time_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="free">db</span> <span class="main">=</span> fst <span class="skolem">db'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> db'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">db'</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">db'</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> data_props<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span><span class="main">.</span> <span class="main">(</span>fst <span class="skolem">db'</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> snd <span class="skolem">db'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="main">(</span>time <span class="free">db</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> time_eq
      <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def time_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> not_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">db'</span> <span class="main">∉</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">db</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> False assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_prev_def time_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">db</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> data_props<span class="main">(</span>1<span class="main">)</span> db'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> not_in db'_def False <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> auxlist_mem_data_in<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_mmtaux <span class="free">args</span> <span class="free">cur</span> <span class="main">(</span><span class="free">mt</span><span class="main">,</span> <span class="free">idx_next</span><span class="main">,</span> <span class="free">idx_mid</span><span class="main">,</span> <span class="free">idx_oldest</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in_once</span><span class="main">,</span> <span class="free">tuple_in_once_keys</span><span class="main">,</span> <span class="free">tuple_since_hist</span><span class="main">,</span> <span class="free">hist_sat</span><span class="main">,</span> <span class="free">since_sat</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">db</span> <span class="main">∈</span> set <span class="free">auxlist</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="main">(</span>time <span class="free">db</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="free">db</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> auxlist_mem_or<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">lemma</span></span> data_prev_ts_props<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_mmtaux <span class="free">args</span> <span class="free">cur</span> <span class="main">(</span><span class="free">mt</span><span class="main">,</span> <span class="free">idx_next</span><span class="main">,</span> <span class="free">idx_mid</span><span class="main">,</span> <span class="free">idx_oldest</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in_once</span><span class="main">,</span> <span class="free">tuple_in_once_keys</span><span class="main">,</span> <span class="free">tuple_since_hist</span><span class="main">,</span> <span class="free">hist_sat</span><span class="main">,</span> <span class="free">since_sat</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">mt</span> <span class="main">∧</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> data_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="free">auxlist</span><span class="main">.</span> time <span class="bound">db</span> <span class="main">≤</span> <span class="free">mt</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> time <span class="bound">db</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> time<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cur</span> <span class="main">=</span> <span class="free">mt</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> memR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="free">auxlist</span><span class="main">.</span> time <span class="bound">db</span> <span class="main">≤</span> <span class="free">mt</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> time <span class="bound">db</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">db</span></span> <span class="keyword2"><span class="keyword">where</span></span> db_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> fst <span class="skolem">db</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> data_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">∈</span> set <span class="free">auxlist</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_prev_def db_props<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> time
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> <span class="free">mt</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>2<span class="main">)</span> memR
      <span class="keyword1"><span class="command">unfolding</span></span> time_def db_props<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> <span class="free">mt</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> data_in_ts_props<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_mmtaux <span class="free">args</span> <span class="free">cur</span> <span class="main">(</span><span class="free">mt</span><span class="main">,</span> <span class="free">idx_next</span><span class="main">,</span> <span class="free">idx_mid</span><span class="main">,</span> <span class="free">idx_oldest</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in_once</span><span class="main">,</span> <span class="free">tuple_in_once_keys</span><span class="main">,</span> <span class="free">tuple_since_hist</span><span class="main">,</span> <span class="free">hist_sat</span><span class="main">,</span> <span class="free">since_sat</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">mt</span> <span class="main">∧</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> data_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">=</span> take <span class="main">(</span>length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="free">auxlist</span><span class="main">.</span> time <span class="bound">db</span> <span class="main">≤</span> <span class="free">mt</span> <span class="main">∧</span>  memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> time <span class="bound">db</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> time<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cur</span> <span class="main">=</span> <span class="free">mt</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> memR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="free">auxlist</span><span class="main">.</span> time <span class="bound">db</span> <span class="main">≤</span> <span class="free">mt</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> time <span class="bound">db</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">db</span></span> <span class="keyword2"><span class="keyword">where</span></span> db_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> fst <span class="skolem">db</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">db'</span></span> <span class="keyword2"><span class="keyword">where</span></span> db'_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">db'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">db'</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> data_props<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> image_iff image_set<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> same_time<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">db'</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> db_props<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta<span class="main">)</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">db'</span> <span class="main">∈</span> set <span class="free">auxlist</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> db'_props<span class="main">(</span>2<span class="main">)</span> time
      <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> <span class="free">mt</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>2<span class="main">)</span> memR same_time
      <span class="keyword1"><span class="command">unfolding</span></span> time_def db_props<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> <span class="free">mt</span>"</span></span> <span class="quoted"><span class="quoted">"memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> auxlist_index_time_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_mmtaux <span class="free">args</span> <span class="free">cur</span> <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">idx_next</span><span class="main">,</span> <span class="free">idx_mid</span><span class="main">,</span> <span class="free">idx_oldest</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in_once</span><span class="main">,</span> <span class="free">tuple_in_once_keys</span><span class="main">,</span> <span class="free">tuple_since_hist</span><span class="main">,</span> <span class="free">hist_sat</span><span class="main">,</span> <span class="free">since_sat</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="free">i</span><span class="main">)</span> <span class="main">≤</span> fst <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="free">auxlist</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sorted<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
    <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟶</span> fst <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> fst <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_iff_nth_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="free">i</span><span class="main">)</span> <span class="main">≤</span> fst <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sorted assms<span class="main">(</span>2-3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> auxlist_time_index_strict_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_mmtaux <span class="free">args</span> <span class="free">cur</span> <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">idx_next</span><span class="main">,</span> <span class="free">idx_mid</span><span class="main">,</span> <span class="free">idx_oldest</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in_once</span><span class="main">,</span> <span class="free">tuple_in_once_keys</span><span class="main">,</span> <span class="free">tuple_since_hist</span><span class="main">,</span> <span class="free">hist_sat</span><span class="main">,</span> <span class="free">since_sat</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="free">i</span><span class="main">)</span> <span class="main">&lt;</span> fst <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="free">j</span><span class="main">)</span>"</span></span> <span class="comment1">(* t &lt; t' *)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
        <span class="keyword1"><span class="command">using</span></span> auxlist_index_time_mono<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assm assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_le_imp_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> data_in_auxlist_nonempty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_mmtaux <span class="free">args</span> <span class="free">cur</span> <span class="main">(</span><span class="free">mt</span><span class="main">,</span> <span class="free">idx_next</span><span class="main">,</span> <span class="free">idx_mid</span><span class="main">,</span> <span class="free">idx_oldest</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in_once</span><span class="main">,</span> <span class="free">tuple_in_once_keys</span><span class="main">,</span> <span class="free">tuple_since_hist</span><span class="main">,</span> <span class="free">hist_sat</span><span class="main">,</span> <span class="free">since_sat</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> is_empty <span class="main">(</span><span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> assm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">db</span></span> <span class="keyword2"><span class="keyword">where</span></span> db_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">∈</span> set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">∈</span> set <span class="free">auxlist</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> fst <span class="skolem">db</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">db</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> auxlist_mem_data_in<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">db</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> time_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_empty <span class="main">(</span><span class="free">data_in</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> is_empty_alt
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> data_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">=</span> linearize <span class="free">data_prev</span>"</span></span>
    <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> linearize <span class="free">data_in</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_empty <span class="main">(</span><span class="free">data_in</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> is_empty_alt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">db</span></span> <span class="keyword2"><span class="keyword">where</span></span> db_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> equals0I<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> db_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> data_props<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="skolem">db</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> snd <span class="skolem">db</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> auxlist_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> length_pos_if_in_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="skolem">db</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> snd <span class="skolem">db</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_mmtaux_nonempty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_mmtaux <span class="free">args</span> <span class="free">cur</span> <span class="main">(</span><span class="free">mt</span><span class="main">,</span> <span class="free">idx_next</span><span class="main">,</span> <span class="free">idx_mid</span><span class="main">,</span> <span class="free">idx_oldest</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in_once</span><span class="main">,</span> <span class="free">tuple_in_once_keys</span><span class="main">,</span> <span class="free">tuple_since_hist</span><span class="main">,</span> <span class="free">hist_sat</span><span class="main">,</span> <span class="free">since_sat</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> is_empty <span class="free">data_in</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> data_in_equiv<span class="main">:</span>
    <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> linearize <span class="free">data_in</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> auxlist_data_in_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">args</span></span> <span class="quoted"><span class="free">mt</span></span> <span class="quoted"><span class="free">auxlist</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">≠</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>        
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> data_in_equiv
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_empty <span class="free">data_in</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> is_empty_alt
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_empty <span class="free">data_in</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> is_empty_alt nth_mem
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">≠</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> data_in_equiv
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">≠</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_result_mmtaux_unfolded<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_mmtaux <span class="free">args</span> <span class="free">cur</span> <span class="main">(</span><span class="free">mt</span><span class="main">,</span> <span class="free">idx_next</span><span class="main">,</span> <span class="free">idx_mid</span><span class="main">,</span> <span class="free">idx_oldest</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in_once</span><span class="main">,</span> <span class="free">tuple_in_once_keys</span><span class="main">,</span> <span class="free">tuple_since_hist</span><span class="main">,</span> <span class="free">hist_sat</span><span class="main">,</span> <span class="free">since_sat</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"result_mmtaux <span class="free">args</span> <span class="main">(</span><span class="free">mt</span><span class="main">,</span> <span class="free">idx_next</span><span class="main">,</span> <span class="free">idx_mid</span><span class="main">,</span> <span class="free">idx_oldest</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in_once</span><span class="main">,</span> <span class="free">tuple_in_once_keys</span><span class="main">,</span> <span class="free">tuple_since_hist</span><span class="main">,</span> <span class="free">hist_sat</span><span class="main">,</span> <span class="free">since_sat</span><span class="main">)</span> <span class="main">=</span> trigger_results <span class="free">args</span> <span class="free">cur</span> <span class="free">auxlist</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">aux</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aux</span> <span class="main">=</span> <span class="main">(</span><span class="free">mt</span><span class="main">,</span> <span class="free">idx_next</span><span class="main">,</span> <span class="free">idx_mid</span><span class="main">,</span> <span class="free">idx_oldest</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in_once</span><span class="main">,</span> <span class="free">tuple_in_once_keys</span><span class="main">,</span> <span class="free">tuple_since_hist</span><span class="main">,</span> <span class="free">hist_sat</span><span class="main">,</span> <span class="free">since_sat</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> args_ivl <span class="free">args</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> time<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mt</span> <span class="main">=</span> <span class="free">cur</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> data_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">=</span> linearize <span class="free">data_prev</span>"</span></span>
    <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> linearize <span class="free">data_in</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> sorted<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> non_empty_assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_empty <span class="free">data_in</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> non_empty_alt <span class="main">=</span> non_empty_assm data_in_auxlist_nonempty<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> time
  
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tuple</span>
      <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> snd <span class="main">(</span>result_mmtaux <span class="free">args</span> <span class="skolem">aux</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> non_empty_assm valid_mmtaux_nonempty<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="free">hist_sat</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> hist<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span>is_empty <span class="free">data_in</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>snd<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> is_empty_alt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">data_in</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_greater_0_conv length_map nth_mem proj_thd.cases<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> hist<span class="main">(</span>1<span class="main">)</span> set_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> hist<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_image_eqI<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="skolem">tuple</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> hist<span class="main">(</span>4<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
          <span class="keyword3"><span class="command">assume</span></span> i_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> fst <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">auxlist</span><span class="main">!</span><span class="skolem">i</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> auxlist_data_in_def case_prod_unfold<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="main">(</span>snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hist <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
          <span class="keyword1">let</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">auxlist</span><span class="main">!</span><span class="bound">i</span> <span class="keyword1">in</span>
          mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">r</span>
        <span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> snd <span class="main">(</span>trigger_results <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> non_empty wf
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> hist_sat_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="free">hist_sat</span> <span class="main">⟹</span> <span class="skolem">tuple</span> <span class="main">∈</span> snd <span class="main">(</span>trigger_results <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">tuple_in_once_keys</span> <span class="main">=</span> Mapping.keys <span class="free">tuple_in_once</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="main">(</span>Mapping.keys <span class="free">tuple_in_once</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">tuple</span> <span class="main">∈</span> <span class="free">hist_sat</span> <span class="main">∨</span> <span class="skolem">tuple</span> <span class="main">∈</span> <span class="free">since_sat</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assm non_empty_assm
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> aux_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="main">(</span>Mapping.keys <span class="free">tuple_in_once</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"newest_tuple_in_mapping fst <span class="free">data_prev</span> <span class="free">tuple_in_once</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_in_once</span> <span class="skolem">tuple</span> <span class="main">=</span>
          safe_max <span class="main">(</span>
            fst <span class="main">`</span> <span class="main">{</span>
             <span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
             <span class="skolem">tuple</span> <span class="main">=</span> snd <span class="bound">tas</span>
            <span class="main">}</span>
          <span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> newest_tuple_in_mapping_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> Mapping.lookup <span class="free">tuple_in_once</span> <span class="skolem">tuple</span> <span class="main">=</span> Some <span class="bound">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assm
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_props<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_in_once</span> <span class="skolem">tuple</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_in_once</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">tuple_in_once</span> <span class="bound">as</span> <span class="keyword1">of</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="main">∃</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">∧</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">∧</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assm t_props
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">db</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> db_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="skolem">l</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> ts_tuple_rel_f_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">=</span> <span class="free">auxlist</span><span class="main">!</span><span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> data_props<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_prev_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> atLeastLessThan_iff filter_is_subset in_set_conv_nth leI not_less_zero subsetD<span class="main">)</span>
        
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">dbi</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">dbi</span> <span class="main">=</span> <span class="free">auxlist</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> i_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> time <span class="skolem">dbi</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">auxlist</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≤</span> fst <span class="main">(</span><span class="free">auxlist</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> sorted i_props<span class="main">(</span>1<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_iff_nth_mono<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_memL<span class="main">:</span> <span class="quoted"><span class="quoted">"memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> time <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> i_props<span class="main">(</span>2<span class="main">)</span> memL_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"args_ivl <span class="free">args</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mt</span> <span class="main">-</span> time <span class="skolem">dbi</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">mt</span> <span class="main">-</span> time <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="skolem">j</span><span class="main">)</span>"</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">unfolding</span></span> time_def dbi_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">auxlist</span><span class="main">!</span><span class="skolem">j</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> j_props db_props
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> time <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> data_prev_mem<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> j_memL <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_ge_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_le_imp_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span><span class="main">&lt;..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_props<span class="main">(</span>2<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>fst <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> db_props j_props<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span><span class="main">&lt;..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
              join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>
            <span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> relL_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">maskL</span> <span class="main">=</span> join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
          <span class="keyword1">let</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">auxlist</span><span class="main">!</span><span class="bound">i</span> <span class="keyword1">in</span>
          mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span>
            <span class="main">(</span><span class="main">∃</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">&lt;..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
              join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="main">(</span>join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tuple</span><span class="main">)</span>
            <span class="main">)</span>
        <span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta' time_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="skolem">tuple</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> db_props
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> memL_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"args_ivl <span class="free">args</span>"</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_prev_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Mapping.keys <span class="free">tuple_in_once</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> assm
            <span class="keyword1"><span class="command">unfolding</span></span> table_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>                
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> snd <span class="main">(</span>trigger_results <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> non_empty
          <span class="keyword1"><span class="command">unfolding</span></span> relL_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="free">since_sat</span>"</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="free">since_sat</span> <span class="main">⟶</span>
          <span class="main">(</span><span class="main">(</span><span class="bound">tuple</span> <span class="main">∈</span> <span class="free">hist_sat</span><span class="main">)</span> <span class="main">∨</span> tuple_since_lhs <span class="bound">tuple</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>
        <span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> valid_mmtaux.simps
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_map<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">tuple</span> <span class="main">∈</span> <span class="free">hist_sat</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
          <span class="keyword1">let</span> <span class="bound">suffix</span> <span class="main">=</span> drop <span class="bound">n</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span>
            <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">suffix</span><span class="main">.</span>
              <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">r</span>
            <span class="main">)</span> <span class="main">∧</span>
            <span class="main">(</span>
              join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="bound">suffix</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>
            <span class="main">)</span>
          <span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_lhs_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="free">hist_sat</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> snd <span class="main">(</span>trigger_results <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> hist_sat_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
          <span class="keyword1">let</span> <span class="bound">suffix</span> <span class="main">=</span> drop <span class="bound">n</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span>
            <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">suffix</span><span class="main">.</span>
              <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">r</span>
            <span class="main">)</span> <span class="main">∧</span>
            <span class="main">(</span>
              join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="bound">suffix</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>
            <span class="main">)</span>
          <span class="main">)</span>"</span></span>
  
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n_def<span class="main">:</span>
            <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">suffix</span> <span class="main">=</span> drop <span class="skolem">n</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span>
                <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">suffix</span><span class="main">.</span>
                  <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">r</span>
                <span class="main">)</span> <span class="main">∧</span>
                <span class="main">(</span>
                  join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="bound">suffix</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>
                <span class="main">)</span>
            <span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">suffix</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">suffix</span> <span class="main">=</span> drop <span class="skolem">n</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> suffix_rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">suffix</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> n_def<span class="main">(</span>2<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
          
  
          <span class="keyword1"><span class="command">have</span></span> suffix_length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">suffix</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">suffix</span> <span class="main">=</span> length <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">n</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> suffix_def n_def<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> tlr<span class="main">:</span>
            <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="skolem">r</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> suffix_rhs
            <span class="keyword1"><span class="command">unfolding</span></span> suffix_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> case_prodE hd_in_set in_set_dropD length_greater_0_conv<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> in_props<span class="main">:</span>
            <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>snd<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prod_conv list.set_map pair_imageI<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="skolem">tuple</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> tlr in_props<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
          <span class="keyword1"><span class="command">have</span></span> idx_shift<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">suffix</span><span class="main">}</span><span class="main">.</span> <span class="skolem">suffix</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">!</span><span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="skolem">n</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> suffix_def n_def<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> suffix_lhs<span class="main">:</span> <span class="quoted"><span class="quoted">"join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="skolem">suffix</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> suffix_def n_def<span class="main">(</span>2<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
          
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> data_in_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">=</span> take <span class="main">(</span>length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">!</span><span class="skolem">n</span> <span class="main">=</span> <span class="free">auxlist</span><span class="main">!</span><span class="skolem">n</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> n_def<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> since<span class="main">:</span> <span class="quoted"><span class="quoted">"join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> idx_shift suffix_length
            <span class="keyword1"><span class="command">unfolding</span></span> suffix_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_drop_conv_nth<span class="main">)</span>
          
          <span class="keyword1"><span class="command">have</span></span> n_le_auxlist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> n_def<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> atLeastLessThan_iff diff_le_self length_filter_le less_le_trans<span class="main">)</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
            <span class="keyword3"><span class="command">assume</span></span> i_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span><span class="main">&lt;..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> n_le_auxlist
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
              <span class="quoted"><span class="quoted">"join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> since
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span><span class="main">&lt;..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
                join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>
              <span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> relL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span>
            <span class="keyword1">let</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">auxlist</span><span class="main">!</span><span class="bound">i</span> <span class="keyword1">in</span>
            mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span> 
              <span class="main">(</span><span class="main">∃</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">&lt;..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
                join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>
              <span class="main">)</span>
          <span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> trigger_res_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span>
            <span class="keyword1">let</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">auxlist</span><span class="main">!</span><span class="bound">i</span> <span class="keyword1">in</span>
            mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span> 
            <span class="main">(</span>
              <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">r</span> <span class="main">∨</span>
              <span class="main">(</span><span class="main">∃</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">&lt;..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
                join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>
              <span class="main">)</span>
            <span class="main">)</span>
          <span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
            <span class="keyword3"><span class="command">assume</span></span> i_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">n</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> time <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> <span class="skolem">n</span> <span class="main">+</span> length <span class="skolem">suffix</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> length <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> suffix_length n_def<span class="main">(</span>1<span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> idx_shift<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">auxlist</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">!</span><span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> length <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> data_in_equiv<span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span>
                <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
                <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> data_prev_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_map<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">auxlist</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">!</span><span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> length <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> idx_shift
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">auxlist</span><span class="main">!</span><span class="skolem">i</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> i_ge i_props<span class="main">(</span>1<span class="main">)</span> data_prev_equiv
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> add.commute atLeastLessThan_iff in_set_conv_nth le_add_diff_inverse length_drop less_diff_conv<span class="main">)</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">auxlist</span><span class="main">!</span><span class="skolem">i</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> time <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> data_prev_mem<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">auxlist</span><span class="main">!</span><span class="skolem">i</span>"</span></span><span class="main">]</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> i_props<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="main">+</span> length <span class="skolem">suffix</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_le_imp_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> suffix_length
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i_props'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">n</span><span class="main">..&lt;</span>length <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> i_props
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">suffix</span><span class="main">!</span><span class="main">(</span><span class="skolem">i</span><span class="main">-</span><span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> suffix_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="free">auxlist</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> data_in_equiv i_props'
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">suffix</span><span class="main">!</span><span class="main">(</span><span class="skolem">i</span><span class="main">-</span><span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">auxlist</span><span class="main">!</span><span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">auxlist</span><span class="main">!</span><span class="skolem">i</span> <span class="main">∈</span> set <span class="skolem">suffix</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> i_props'
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> atLeastLessThan_iff dual_order.trans less_diff_iff less_or_eq_imp_le nth_mem suffix_length<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="comment1">(* "∀i∈{0..&lt;length suffix}. suffix!i = (auxlist_data_in args mt auxlist)!(i+n)" *)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="main">(</span>snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> suffix_rhs
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">n</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
            <span class="keyword1">let</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">auxlist</span><span class="main">!</span><span class="bound">i</span> <span class="keyword1">in</span>
            mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">r</span>
          <span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> time_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">n</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
            <span class="keyword1">let</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">auxlist</span><span class="main">!</span><span class="bound">i</span> <span class="keyword1">in</span>
            mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span> 
            <span class="main">(</span>
              <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">r</span> <span class="main">∨</span>
              <span class="main">(</span><span class="main">∃</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">&lt;..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
                join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>
              <span class="main">)</span>
            <span class="main">)</span>
          <span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
            <span class="keyword1">let</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">auxlist</span><span class="main">!</span><span class="bound">i</span> <span class="keyword1">in</span>
            mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span> 
            <span class="main">(</span>
              <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">r</span> <span class="main">∨</span>
              <span class="main">(</span><span class="main">∃</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">&lt;..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
                join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>
              <span class="main">)</span>
            <span class="main">)</span>
          <span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> trigger_res_1
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> atLeastLessThan_iff not_le_imp_less<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">maskL</span> <span class="main">=</span> join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> snd <span class="main">(</span>trigger_results <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> non_empty wf
            <span class="keyword1"><span class="command">unfolding</span></span> relL_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> snd <span class="main">(</span>trigger_results <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> snd <span class="main">(</span>trigger_results <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> hist_sat_mem
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> snd <span class="main">(</span>trigger_results <span class="free">args</span> <span class="free">cur</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> time
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>result_mmtaux <span class="free">args</span> <span class="skolem">aux</span><span class="main">)</span> <span class="main">⊆</span> snd <span class="main">(</span>trigger_results <span class="free">args</span> <span class="free">cur</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tuple</span>
      <span class="keyword3"><span class="command">assume</span></span> el<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> snd <span class="main">(</span>trigger_results <span class="free">args</span> <span class="free">cur</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="skolem">tuple</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> non_empty_alt
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> maskL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">maskL</span> <span class="main">=</span> join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
          <span class="keyword1">let</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">auxlist</span><span class="main">!</span><span class="bound">i</span> <span class="keyword1">in</span>
          mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span> 
          <span class="main">(</span>
            <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">r</span> <span class="main">∨</span>
            <span class="main">(</span><span class="main">∃</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">&lt;..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
              join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>
            <span class="main">)</span>
          <span class="main">)</span>
        <span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> el non_empty_alt
        <span class="keyword1"><span class="command">unfolding</span></span> relL_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tuple_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
          mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> time <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> 
          <span class="main">(</span>
            <span class="skolem">tuple</span> <span class="main">∈</span> relR <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">∨</span>
            <span class="main">(</span><span class="main">∃</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">&lt;..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
              join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>
            <span class="main">)</span>
          <span class="main">)</span>
        <span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> el
        <span class="keyword1"><span class="command">unfolding</span></span> relR_def time_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> hist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
          mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> time <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">tuple</span> <span class="main">∈</span> relR <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">db</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> db_props<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> time <span class="skolem">db</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">∈</span> set <span class="free">auxlist</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> time
            <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def time_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> db_props<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span>
              <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">=</span> <span class="free">auxlist</span><span class="main">!</span><span class="skolem">j</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeastLessThan_iff in_set_conv_nth leI not_less0<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> relR <span class="skolem">db</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> hist db_props j_props
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">∈</span> relR <span class="bound">db</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> relR_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="free">hist_sat</span> <span class="main">⟷</span>
          <span class="main">(</span><span class="main">¬</span>is_empty <span class="free">data_in</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>
            <span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="bound">r</span>
        <span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="free">hist_sat</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> non_empty_alt
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> snd <span class="main">(</span>result_mmtaux <span class="free">args</span> <span class="skolem">aux</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> non_empty_alt
          <span class="keyword1"><span class="command">unfolding</span></span> aux_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
          mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> time <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">tuple</span> <span class="main">∉</span> relR <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span>"</span></span>      
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_props<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span>"</span></span>
          <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> time <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∉</span> relR <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span><span class="main">&lt;..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Max <span class="skolem">A</span>"</span></span>
  
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span><span class="main">&lt;..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
          join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>
        "</span></span>
          <span class="keyword1"><span class="command">using</span></span> i_props el tuple_props
          <span class="keyword1"><span class="command">unfolding</span></span> time_def relR_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> A_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> j_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_props<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span><span class="main">&lt;..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span>"</span></span>
          <span class="quoted"><span class="quoted">"join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> A_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">suffix</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">suffix</span> <span class="main">=</span> drop <span class="skolem">j</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> j_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
          <span class="comment1">(* length (auxlist_data_in args mt auxlist)-1 *)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> data_in_props<span class="main">:</span> <span class="quoted"><span class="quoted">"auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">=</span> take <span class="main">(</span>length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="skolem">suffix</span> <span class="main">=</span> <span class="free">auxlist</span><span class="main">!</span><span class="skolem">j</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> data_props<span class="main">(</span>2<span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span> suffix_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> hd_drop_conv_nth length_map nth_take<span class="main">)</span>
          
  
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> suffix_first<span class="main">:</span> <span class="quoted"><span class="quoted">"join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="skolem">suffix</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> j_props
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> data_props<span class="main">(</span>2<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_map<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> j_le
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">db</span>
            <span class="keyword3"><span class="command">assume</span></span> suffix_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">∈</span> set <span class="skolem">suffix</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k_props<span class="main">:</span>
              <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">suffix</span><span class="main">}</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="skolem">suffix</span><span class="main">!</span><span class="skolem">k</span> <span class="main">=</span> <span class="skolem">db</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> atLeastLessThan_iff less_eq_nat.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nth_the_index the_index_bounded<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> kj_props<span class="main">:</span>
              <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">!</span><span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">db</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> suffix_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">auxlist</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_le_trans<span class="main">)</span>
  
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cond<span class="main">:</span> <span class="quoted"><span class="quoted">"
              mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> time <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> 
              <span class="main">(</span>
                <span class="skolem">tuple</span> <span class="main">∈</span> relR <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
                <span class="main">(</span><span class="main">∃</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">&lt;..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
                  join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>
                <span class="main">)</span>
              <span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tuple_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> kj_props
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> time <span class="skolem">db</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> time
              <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def time_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> auxlist_idx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">!</span><span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">auxlist</span><span class="main">!</span><span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> data_in_props kj_props<span class="main">(</span>1<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> time <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> kj_props<span class="main">(</span>2<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> relR <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
                <span class="main">(</span><span class="main">∃</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">&lt;..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
                  join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>
                <span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> cond
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">&lt;..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
                  join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>
                <span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> j'_props<span class="main">:</span>
                <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">&lt;..&lt;</span><span class="main">(</span>length <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span>"</span></span>
                <span class="quoted"><span class="quoted">"join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="skolem">j'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_def j_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_props j_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> j'_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
  
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> relR <span class="main">(</span><span class="free">auxlist</span><span class="main">!</span><span class="main">(</span><span class="skolem">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> relR <span class="skolem">db</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> kj_props auxlist_idx <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">suffix</span><span class="main">.</span>
                <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">r</span>
              <span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="skolem">suffix</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> suffix_first
            <span class="keyword1"><span class="command">unfolding</span></span> relR_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> relR_def case_prod_beta'<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
            <span class="keyword1">let</span> <span class="bound">suffix</span> <span class="main">=</span> drop <span class="bound">n</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span>
              <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">suffix</span><span class="main">.</span>
                <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">r</span>
              <span class="main">)</span> <span class="main">∧</span>
              join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="bound">suffix</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>
          <span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> j_le suffix_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> atLeastLessThan_iff less_eq_nat.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">n</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
                <span class="keyword1">let</span> <span class="bound">suffix</span> <span class="main">=</span> drop <span class="bound">n</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span>
                  <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">suffix</span><span class="main">.</span>
                    <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">r</span>
                  <span class="main">)</span> <span class="main">∧</span>
                  <span class="main">(</span>
                    join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="bound">suffix</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>
                  <span class="main">)</span>
              <span class="main">)</span>
            <span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_map<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_since_lhs <span class="skolem">tuple</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> non_empty_alt is_empty_alt
            <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_lhs_def 
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="free">since_sat</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> snd <span class="main">(</span>result_mmtaux <span class="free">args</span> <span class="skolem">aux</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> non_empty_alt
            <span class="keyword1"><span class="command">unfolding</span></span> aux_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">-</span> length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> j_geq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> data_prev_props<span class="main">:</span> <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> prev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">auxlist</span><span class="main">!</span><span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span>auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">!</span><span class="skolem">j'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> j_props<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span> j'_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> idx_shift<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">auxlist</span><span class="main">!</span><span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">!</span><span class="skolem">j'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> data_props<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&lt;</span> length <span class="main">(</span>auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> data_prev_props j_props i_props j_geq
            <span class="keyword1"><span class="command">unfolding</span></span> j'_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> not_mem_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> memL_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"args_ivl <span class="free">args</span>"</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_prev_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mask_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
          <span class="keyword1"><span class="command">have</span></span> data_in_props<span class="main">:</span> <span class="quoted"><span class="quoted">"auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">=</span> take <span class="main">(</span>length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">+</span> length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">=</span> length <span class="free">auxlist</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> data_in_props data_prev_props data_props
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> add.commute append_take_drop_id length_append length_map<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j'_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&lt;</span> length <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> j_geq j_props<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span> j'_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> fst <span class="main">`</span> <span class="main">{</span>
            <span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
            <span class="skolem">tuple</span> <span class="main">=</span> snd <span class="bound">tas</span>
          <span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"newest_tuple_in_mapping fst <span class="free">data_prev</span> <span class="free">tuple_in_once</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mapping_val<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_in_once</span> <span class="skolem">tuple</span> <span class="main">=</span> safe_max <span class="skolem">B</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> newest_tuple_in_mapping_def B_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> fst <span class="main">(</span><span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j'</span><span class="main">)</span>"</span></span>
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> snd <span class="main">(</span><span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> tuple_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span> <span class="main">=</span> <span class="skolem">tuple</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> mask_eq wf wf_tuple_proj_idle<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"args_n <span class="free">args</span>"</span></span> <span class="quoted"><span class="quoted">"args_L <span class="free">args</span>"</span></span> <span class="quoted"><span class="skolem">tuple</span></span><span class="main">]</span> maskL
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"args_pos <span class="free">args</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> not_mem_0 assms<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span> <span class="main">∈</span> fst <span class="skolem">X</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> j_props idx_shift
            <span class="keyword1"><span class="command">unfolding</span></span> relL_def X_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> j'_le
            <span class="keyword1"><span class="command">unfolding</span></span> t_def X_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span> <span class="main">∈</span> ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> ts_tuple_rel_f_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t_mem_B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> B_def
            <span class="keyword1"><span class="command">using</span></span> tuple_eq
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_iff<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> B_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">B</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> B_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_fst_ts_tuple_rel<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"safe_max <span class="skolem">B</span> <span class="main">=</span> Some <span class="main">(</span>Max <span class="skolem">B</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> safe_max_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_in_once</span> <span class="skolem">tuple</span> <span class="main">=</span> Some <span class="main">(</span>Max <span class="skolem">B</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> mapping_val
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_in_once</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_keys_intro<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">tuple_in_once_keys</span> <span class="main">=</span> Mapping.keys <span class="free">tuple_in_once</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> snd <span class="main">(</span>result_mmtaux <span class="free">args</span> <span class="skolem">aux</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> non_empty_alt
            <span class="keyword1"><span class="command">unfolding</span></span> aux_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> snd <span class="main">(</span>result_mmtaux <span class="free">args</span> <span class="skolem">aux</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_le_imp_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> snd <span class="main">(</span>result_mmtaux <span class="free">args</span> <span class="skolem">aux</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>trigger_results <span class="free">args</span> <span class="free">cur</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">⊆</span> snd <span class="main">(</span>result_mmtaux <span class="free">args</span> <span class="skolem">aux</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>trigger_results <span class="free">args</span> <span class="free">cur</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>result_mmtaux <span class="free">args</span> <span class="skolem">aux</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subset
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> aux_def non_empty_alt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"is_empty <span class="free">data_in</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> data_in_auxlist_nonempty<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> time <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_result_mmtaux<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_mmtaux <span class="free">args</span> <span class="free">cur</span> <span class="free">aux</span> <span class="free">auxlist</span> <span class="main">⟹</span> result_mmtaux <span class="free">args</span> <span class="free">aux</span> <span class="main">=</span> trigger_results <span class="free">args</span> <span class="free">cur</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> valid_result_mmtaux_unfolded
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">aux</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> drop_list_shift<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="free">m</span> <span class="main">⟹</span> drop <span class="free">n</span> <span class="free">xs</span> <span class="main">=</span> drop <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span>drop <span class="free">m</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* analogous to join_mmsaux *)</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">proj_tuple_in_join_optim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> bool list <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> bool list <span class="main">⇒</span> <span class="tfree">'a</span> table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">proj_tuple_in_join_optim</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>
      <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> 
    <span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">(</span><span class="main">∀</span><span class="bound">b</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">.</span> <span class="main">¬</span><span class="bound">b</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>
      <span class="keyword1">let</span> <span class="bound">nones</span> <span class="main">=</span> replicate <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">)</span> None <span class="keyword1">in</span> <span class="main">(</span>
      <span class="comment1">― ‹if there are no free variables then we either take all or nothing›</span>
        <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="main">⟷</span> <span class="bound">nones</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span>
          <span class="free"><span class="bound"><span class="entity">r</span></span></span>
         <span class="keyword1">else</span>
          <span class="main">{}</span>
        <span class="main">)</span>
      <span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">.</span> proj_tuple_in_join <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span> <span class="bound">as</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">}</span>
    <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> proj_tuple_in_join_optim_equiv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">V_L</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">V_R</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"proj_tuple_in_join_optim <span class="free">pos</span> <span class="free">r</span> <span class="main">(</span>join_mask <span class="free">n</span> <span class="free">V_R</span><span class="main">)</span> <span class="free">l</span> <span class="main">(</span>join_mask <span class="free">n</span> <span class="free">V_L</span><span class="main">)</span> <span class="main">=</span>
         <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="free">r</span><span class="main">.</span> proj_tuple_in_join <span class="free">pos</span> <span class="main">(</span>join_mask <span class="free">n</span> <span class="free">V_L</span><span class="main">)</span> <span class="bound">as</span> <span class="free">l</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">maskL</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">maskL</span> <span class="main">=</span> <span class="main">(</span>join_mask <span class="free">n</span> <span class="free">V_L</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">maskR</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">maskR</span> <span class="main">=</span> <span class="main">(</span>join_mask <span class="free">n</span> <span class="free">V_R</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> maskL_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">maskL</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> maskL_def join_mask_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">maskL</span> <span class="main">=</span> <span class="skolem">maskR</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">⟹</span> proj_tuple <span class="skolem">maskL</span> <span class="bound">as</span> <span class="main">=</span> <span class="bound">as</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf_tuple_proj_idle assms<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> table_def maskR_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="free">r</span><span class="main">.</span> proj_tuple_in_join <span class="free">pos</span> <span class="main">(</span>join_mask <span class="free">n</span> <span class="free">V_L</span><span class="main">)</span> <span class="bound">as</span> <span class="free">l</span><span class="main">}</span> <span class="main">=</span>
               <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="free">r</span><span class="main">.</span> join_cond <span class="free">pos</span> <span class="free">l</span> <span class="bound">as</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> proj_tuple_in_join_def maskL_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> True
      <span class="keyword1"><span class="command">unfolding</span></span> maskL_def maskR_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> not_eq<span class="main">:</span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">b</span> <span class="main">∈</span> set <span class="skolem">maskL</span><span class="main">.</span> <span class="main">¬</span><span class="bound">b</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> no_fvs<span class="main">:</span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∉</span> <span class="free">V_L</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> maskL_def join_mask_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">l</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> replicate <span class="free">n</span> None"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> table_def wf_tuple_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> New_max.simple_list_index_equality<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="free">l</span> <span class="main">=</span> unit_table <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> unit_table_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">pos</span> <span class="main">⟷</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="skolem">maskL</span><span class="main">)</span> None<span class="main">)</span> <span class="main">∈</span> <span class="free">l</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">pos</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"replicate <span class="free">n</span> None <span class="main">∉</span> <span class="free">l</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True maskL_len
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> l_eq
          <span class="keyword1"><span class="command">unfolding</span></span> unit_table_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="free">r</span><span class="main">.</span> proj_tuple_in_join <span class="free">pos</span> <span class="skolem">maskL</span> <span class="bound">as</span> <span class="free">l</span><span class="main">}</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> no_fvs assm
          <span class="keyword1"><span class="command">unfolding</span></span> proj_tuple_in_join_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pos</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> unit_table <span class="free">n</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True maskL_len l_eq
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        
        <span class="keyword1"><span class="command">have</span></span> as_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">⟹</span> length <span class="bound">as</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> table_def wf_tuple_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">⟹</span> proj_tuple <span class="skolem">maskL</span> <span class="bound">as</span> <span class="main">=</span> replicate <span class="free">n</span> None"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">as</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="free">r</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">as</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> as_props
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">maskL</span> <span class="main">=</span> length <span class="skolem">as</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> maskL_len
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"proj_tuple <span class="skolem">maskL</span> <span class="skolem">as</span> <span class="main">=</span> replicate <span class="free">n</span> None"</span></span>
            <span class="keyword1"><span class="command">using</span></span> no_fvs proj_tuple_replicate<span class="main">[</span><span class="operator">OF</span> _ len_eq<span class="main">]</span> maskL_len
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">⟹</span> proj_tuple <span class="skolem">maskL</span> <span class="bound">as</span> <span class="main">∈</span> <span class="free">l</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> l_eq unit_table_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="free">r</span><span class="main">.</span> proj_tuple_in_join <span class="free">pos</span> <span class="skolem">maskL</span> <span class="bound">as</span> <span class="free">l</span><span class="main">}</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assm
          <span class="keyword1"><span class="command">unfolding</span></span> proj_tuple_in_join_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="free">r</span><span class="main">.</span> proj_tuple_in_join <span class="free">pos</span> <span class="skolem">maskL</span> <span class="bound">as</span> <span class="free">l</span><span class="main">}</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"proj_tuple_in_join_optim <span class="free">pos</span> <span class="free">r</span> <span class="main">(</span>join_mask <span class="free">n</span> <span class="free">V_R</span><span class="main">)</span> <span class="free">l</span> <span class="main">(</span>join_mask <span class="free">n</span> <span class="free">V_L</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> not_eq no_fvs True
        <span class="keyword1"><span class="command">unfolding</span></span> maskL_def maskR_def proj_tuple_in_join_optim.simps Let_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> maskL_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pos</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"replicate <span class="free">n</span> None <span class="main">∉</span> <span class="free">l</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False maskL_len
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> l_eq
          <span class="keyword1"><span class="command">unfolding</span></span> unit_table_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="free">r</span><span class="main">.</span> proj_tuple_in_join <span class="free">pos</span> <span class="skolem">maskL</span> <span class="bound">as</span> <span class="free">l</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> no_fvs assm
          <span class="keyword1"><span class="command">unfolding</span></span> proj_tuple_in_join_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">pos</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> unit_table <span class="free">n</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False maskL_len l_eq
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        
        <span class="keyword1"><span class="command">have</span></span> as_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">⟹</span> length <span class="bound">as</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> table_def wf_tuple_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">⟹</span> proj_tuple <span class="skolem">maskL</span> <span class="bound">as</span> <span class="main">=</span> replicate <span class="free">n</span> None"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">as</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="free">r</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">as</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> as_props
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">maskL</span> <span class="main">=</span> length <span class="skolem">as</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> maskL_len
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"proj_tuple <span class="skolem">maskL</span> <span class="skolem">as</span> <span class="main">=</span> replicate <span class="free">n</span> None"</span></span>
            <span class="keyword1"><span class="command">using</span></span> no_fvs proj_tuple_replicate<span class="main">[</span><span class="operator">OF</span> _ len_eq<span class="main">]</span> maskL_len
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">as</span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">⟹</span> proj_tuple <span class="skolem">maskL</span> <span class="bound">as</span> <span class="main">∈</span> <span class="free">l</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> l_eq unit_table_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="free">r</span><span class="main">.</span> proj_tuple_in_join <span class="free">pos</span> <span class="skolem">maskL</span> <span class="bound">as</span> <span class="free">l</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assm
          <span class="keyword1"><span class="command">unfolding</span></span> proj_tuple_in_join_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="free">r</span><span class="main">.</span> proj_tuple_in_join <span class="free">pos</span> <span class="skolem">maskL</span> <span class="bound">as</span> <span class="free">l</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"proj_tuple_in_join_optim <span class="free">pos</span> <span class="free">r</span> <span class="main">(</span>join_mask <span class="free">n</span> <span class="free">V_R</span><span class="main">)</span> <span class="free">l</span> <span class="main">(</span>join_mask <span class="free">n</span> <span class="free">V_L</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> not_eq no_fvs False
        <span class="keyword1"><span class="command">unfolding</span></span> maskL_def maskR_def proj_tuple_in_join_optim.simps Let_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> maskL_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> not_eq
      <span class="keyword1"><span class="command">unfolding</span></span> maskL_def maskR_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">update_mmtaux'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> ts <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool list <span class="main">⇒</span> bool list <span class="main">⇒</span> <span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> table <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> queue <span class="main">⇒</span> <span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> queue <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> tuple<span class="main">,</span> ts<span class="main">)</span> mapping<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> tuple<span class="main">,</span> nat<span class="main">)</span> mapping<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat <span class="main">×</span> <span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> table <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> queue <span class="main">×</span> <span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> queue <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> tuple<span class="main">,</span> ts<span class="main">)</span> mapping<span class="main">)</span> <span class="main">×</span> <span class="tfree">'a</span> table <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> tuple<span class="main">,</span> nat<span class="main">)</span> mapping<span class="main">)</span> <span class="main">×</span> <span class="tfree">'a</span> table <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_mmtaux'</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="free"><span class="bound"><span class="entity">idx_mid</span></span></span> <span class="free"><span class="bound"><span class="entity">idx_oldest</span></span></span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span> <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span> <span class="free"><span class="bound"><span class="entity">tuple_in_once</span></span></span> <span class="free"><span class="bound"><span class="entity">tuple_in_once_keys</span></span></span> <span class="free"><span class="bound"><span class="entity">tuple_since_hist</span></span></span> <span class="free"><span class="bound"><span class="entity">hist_sat</span></span></span> <span class="free"><span class="bound"><span class="entity">since_sat</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="comment1">― ‹in a first step, we update tuple_in_once by removing all tuples where currently a ts
       is stored, that points to a db that with the new ts (nt) no longer is part of
       [0, a-1] / data_prev›</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">data_prev'</span><span class="main">,</span> <span class="bound">move</span><span class="main">,</span> <span class="bound">tuple_in_once'</span><span class="main">,</span> <span class="bound">tuple_in_once_keys'</span><span class="main">)</span> <span class="main">=</span> shift_end
      <span class="main">(</span>flip_int_less_lower <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span><span class="main">)</span> <span class="comment1">― ‹[0, a-1]›</span>
      <span class="free"><span class="bound"><span class="entity">nt</span></span></span>  <span class="comment1">― ‹the new timestamp›</span>
      fst <span class="comment1">― ‹here we look at the lhs tuples / φ›</span>
      <span class="main">(</span>empty_queue<span class="main">::</span><span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> option list set <span class="main">×</span> <span class="tfree">'a</span> option list set<span class="main">)</span> queue<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in_once</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in_once_keys</span></span></span><span class="main">)</span><span class="main">;</span> <span class="comment1">― ‹add type›</span>
    <span class="comment1">― ‹pass empty_queue as the first argument as it would filter out all: [0, a-1] ∩ [a, b] = {}.
       idx_mid can be moved forward by the number of all tuples dropped from data_prev (move)›</span>
    <span class="bound">move_len</span> <span class="main">=</span> length <span class="bound">move</span><span class="main">;</span>
    <span class="bound">idx_mid'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">idx_mid</span></span></span> <span class="main">+</span> <span class="bound">move_len</span><span class="main">;</span>
    <span class="comment1">― ‹in a next step, we drop all entries from data_in that are no longer relevant ›</span>
    <span class="main">(</span><span class="bound">data_in'</span><span class="main">,</span> <span class="bound">drop</span><span class="main">)</span> <span class="main">=</span> takedropWhile_queue <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">;</span>
     <span class="comment1">― ‹instead of first appending and then filtering, we filter move separately. this saves us the append
       operation for all entries in move›</span>
    <span class="bound">move'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">move</span><span class="main">;</span>
    <span class="comment1">― ‹idx_ildest has to be moved forward by the number of dbs dropped from data_in and the ones
        dropped from data_prev because they don't satisfy memR anymore (move')›</span>
    <span class="bound">drop_prev_len</span> <span class="main">=</span> <span class="bound">move_len</span> <span class="main">-</span> length <span class="bound">move'</span><span class="main">;</span>
    <span class="bound">idx_oldest'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">idx_oldest</span></span></span> <span class="main">+</span> length <span class="bound">drop</span> <span class="main">+</span> <span class="bound">drop_prev_len</span><span class="main">;</span>
    
    <span class="comment1">― ‹next, the right hand side of entries in move have to be appended to data_in. these all already
       satisfy memR as we just filtered them for it›</span>
    <span class="bound">data_in''</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">data_in</span><span class="main">.</span> append_queue <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">data_in</span><span class="main">)</span> <span class="bound">move'</span> <span class="bound">data_in'</span><span class="main">;</span>
    
    <span class="comment1">― ‹we now have to update hist_since using the tables in move. in particular, for all dbs inside move,
       we have to do some sort of join with the keys of hist_since›</span>
    <span class="main">(</span><span class="bound">tuple_since_hist'</span><span class="main">,</span> <span class="bound">hist_sat'</span><span class="main">,</span> <span class="bound">idx_move</span><span class="main">,</span> <span class="bound">since_sat'</span><span class="main">)</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="bound">tuple_since_hist</span><span class="main">,</span> <span class="bound">hist_sat</span><span class="main">,</span> <span class="bound">idx_move</span><span class="main">,</span> <span class="bound">since_sat</span><span class="main">)</span><span class="main">.</span>
      <span class="keyword1">let</span> <span class="bound">tuple_since_hist</span> <span class="main">=</span> Mapping.filter <span class="main">(</span><span class="main">λ</span><span class="bound">as</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">tuple_since_hist</span><span class="main">;</span>
          <span class="bound">hist_sat</span>         <span class="main">=</span> <span class="bound">hist_sat</span> <span class="main">∩</span> <span class="bound">r</span><span class="main">;</span>
          <span class="bound">since_sat</span>        <span class="main">=</span> <span class="bound">since_sat</span> <span class="main">∩</span> <span class="bound">r</span>

      <span class="keyword1">in</span> <span class="comment1">― ‹filter entries that are not present in the current db›</span>
      <span class="main">(</span>
        upd_set <span class="bound">tuple_since_hist</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">idx_move</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="main">-</span> Mapping.keys <span class="bound">tuple_since_hist</span><span class="main">)</span><span class="main">,</span> <span class="comment1">― ‹then add entries for the ones that are present in the current db›</span>
        <span class="bound">hist_sat</span><span class="main">,</span>
        <span class="bound">idx_move</span><span class="main">+</span><span class="main">1</span><span class="main">,</span> <span class="comment1">― ‹increase index by one every db›</span>
        <span class="bound">since_sat</span> <span class="main">∪</span> proj_tuple_in_join_optim <span class="main">(</span>args_pos <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="bound">r</span> <span class="main">(</span>join_mask <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_R <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span>join_mask <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_L <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">)</span> 
    <span class="main">)</span> <span class="bound">move</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tuple_since_hist</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">hist_sat</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">idx_mid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">since_sat</span></span></span><span class="main">)</span><span class="main">;</span> <span class="comment1">― ‹use original idx_mid, not idx_mid' where the length of move already is included›</span>
    <span class="bound">tuple_since_hist''</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="bound">idx_mid'</span> <span class="main">=</span> <span class="bound">idx_oldest'</span><span class="main">)</span> <span class="keyword1">then</span> Mapping.empty <span class="keyword1">else</span> <span class="bound">tuple_since_hist'</span><span class="main">)</span><span class="main">;</span> <span class="comment1">― ‹if data_in'' is empty, empty the mapping›</span>
    <span class="bound">since_sat''</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="bound">idx_mid'</span> <span class="main">=</span> <span class="bound">idx_oldest'</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="bound">since_sat'</span><span class="main">)</span><span class="main">;</span>
    <span class="comment1">― ‹in contrast to mmsaux, we don't have to look at what tuples were dropped from data_in as
       we do not have any 'in mappings', just 'since mappings'. What has to be done though,
       is to check whether there are now new tuples that satisfy historically.
       In order to do this, we look at the latest db, iterate over all tuples and check,
       whether hist_since points to an index that is older than the current oldest ts, i.e.
       whether the rhs is satisfied in the whole interval›</span>
    <span class="bound">hist_sat''</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> fst <span class="main">(</span>safe_hd <span class="bound">data_in''</span><span class="main">)</span>
      <span class="keyword1">of</span> None <span class="main">⇒</span>
        <span class="main">{}</span> <span class="comment1">― ‹if data_in is empty, no tuples should be in the set.
              (mmtaux only returns results if data_in isn't empty)›</span>
      <span class="main">|</span> Some <span class="bound">db</span> <span class="main">⇒</span>
        <span class="comment1">― ‹select all tuples where tuple_since_hist points to the smallest ts›</span>
        <span class="bound">hist_sat'</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">tuple</span></span> <span class="main">∈</span> <span class="main">(</span>snd <span class="bound">db</span><span class="main">)</span><span class="main">.</span>
          <span class="keyword1">case</span> <span class="main">(</span>Mapping.lookup <span class="bound">tuple_since_hist''</span> <span class="bound">tuple</span><span class="main">)</span> <span class="keyword1">of</span>
            Some <span class="bound">idx</span> <span class="main">⇒</span> <span class="bound">idx</span> <span class="main">≤</span> <span class="bound">idx_oldest'</span>
          <span class="main">|</span> None <span class="main">⇒</span> False
        <span class="main">}</span>
    <span class="main">)</span>
    <span class="keyword1">in</span>
    <span class="main">(</span><span class="bound">idx_mid'</span><span class="main">,</span> <span class="bound">idx_oldest'</span><span class="main">,</span> <span class="bound">data_prev'</span><span class="main">,</span> <span class="bound">data_in''</span><span class="main">,</span> <span class="bound">tuple_in_once'</span><span class="main">,</span> <span class="bound">tuple_in_once_keys'</span><span class="main">,</span> <span class="bound">tuple_since_hist''</span><span class="main">,</span> <span class="bound">hist_sat''</span><span class="main">,</span> <span class="bound">since_sat''</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">lemma</span></span> ts_tuple_rel_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"ts_tuple_rel_f <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ts_tuple_rel_f_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_empty_filter<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.filter <span class="free">f</span> Mapping.empty <span class="main">=</span> Mapping.empty"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Mapping.lookup_empty Mapping_lookup_filter_not_None mapping_eqI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fold_Mapping_filter_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="bound">el</span> <span class="bound">tuple_in</span><span class="main">.</span> Mapping.filter <span class="main">(</span><span class="free">f</span> <span class="bound">el</span> <span class="bound">tuple_in</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">)</span> <span class="free">xs</span> Mapping.empty <span class="main">=</span> Mapping.empty"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="bound">el</span> <span class="bound">tuple_in</span><span class="main">.</span> Mapping.filter <span class="main">(</span><span class="free">f</span> <span class="bound">el</span> <span class="bound">tuple_in</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">)</span> <span class="skolem">xs</span> Mapping.empty<span class="main">)</span> <span class="main">=</span> Mapping.empty"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="bound">el</span> <span class="bound">tuple_in</span><span class="main">.</span> Mapping.filter <span class="main">(</span><span class="free">f</span> <span class="bound">el</span> <span class="bound">tuple_in</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">(</span>Mapping.filter <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> Mapping.empty<span class="main">)</span> Mapping.empty<span class="main">)</span><span class="main">)</span> <span class="main">=</span> Mapping.empty"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Mapping_empty_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> Mapping.empty"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="bound">el</span> <span class="bound">tuple_in</span><span class="main">.</span> Mapping.filter <span class="main">(</span><span class="free">f</span> <span class="bound">el</span> <span class="bound">tuple_in</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">el</span> <span class="bound">tuple_in</span><span class="main">.</span> Mapping.filter <span class="main">(</span><span class="free">f</span> <span class="bound">el</span> <span class="bound">tuple_in</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> Mapping.empty <span class="main">=</span> Mapping.empty"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_filter_Some<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">mapping</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">k</span> <span class="free">v</span> <span class="main">=</span> True"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>Mapping.filter <span class="free">f</span> <span class="free">mapping</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_keys_filterI Mapping_lookup_filter_keys<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_filter_None<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">mapping</span> <span class="free">k</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>Mapping.filter <span class="free">f</span> <span class="free">mapping</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms Mapping_lookup_filter_not_None
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_double_appl<span class="main">:</span> <span class="quoted"><span class="quoted">"restrict <span class="free">M</span> <span class="free">t</span> <span class="main">=</span> restrict <span class="free">M</span> <span class="main">(</span>restrict <span class="free">M</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> restrict_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> filter_order_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="free">f</span> <span class="main">(</span>filter <span class="free">g</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> filter <span class="free">g</span> <span class="main">(</span>filter <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> filter_cong filter_filter<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_memL_imp_memR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="free">t</span> <span class="main">⟹</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> memL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">t</span><span class="main">.</span> <span class="main">¬</span>mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="bound">t'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> memL_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span><span class="main">,</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span><span class="main">,</span> bounded <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">memL</span><span class="main">,</span> <span class="bound">memR</span><span class="main">,</span> <span class="bound">bounded</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="bound">memL</span> <span class="bound">m</span> <span class="main">∧</span> <span class="bound">memR</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∧</span> upclosed <span class="bound">memL</span> <span class="main">∧</span> downclosed <span class="bound">memR</span> <span class="main">∧</span> <span class="bound">bounded</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">memR</span> <span class="bound">m</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Rep_ℐ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bounded.rep_eq memL.rep_eq memR.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t_ex</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_ex_props<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="skolem">t_ex</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> memR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t'</span>
      <span class="keyword3"><span class="command">assume</span></span> t'_leq_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">≥</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> memR memR_antimono
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≥</span><span class="free">t</span><span class="main">.</span> <span class="main">¬</span>mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="bound">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t'</span><span class="main">.</span> <span class="main">¬</span>mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="bound">t'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> memL nat_le_linear
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> t_ex_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_memR_imp_memL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="free">t</span> <span class="main">⟹</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> memR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≥</span><span class="free">t</span><span class="main">.</span> <span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="bound">t'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> memR_antimono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span><span class="main">,</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span><span class="main">,</span> bounded <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">memL</span><span class="main">,</span> <span class="bound">memR</span><span class="main">,</span> <span class="bound">bounded</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="bound">memL</span> <span class="bound">m</span> <span class="main">∧</span> <span class="bound">memR</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∧</span> upclosed <span class="bound">memL</span> <span class="main">∧</span> downclosed <span class="bound">memR</span> <span class="main">∧</span> <span class="bound">bounded</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">memR</span> <span class="bound">m</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Rep_ℐ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bounded.rep_eq memL.rep_eq memR.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t_ex</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_ex_props<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="skolem">t_ex</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> memL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t'</span>
      <span class="keyword3"><span class="command">assume</span></span> t'_leq_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">≤</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> memL memL_mono
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="free">t</span><span class="main">.</span> <span class="main">¬</span>mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="bound">t'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t'</span><span class="main">.</span> <span class="main">¬</span>mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="bound">t'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> memR nat_le_linear
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> t_ex_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fold_append_queue_map<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">q</span><span class="main">.</span> append_queue <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span> <span class="free">xs</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> linearize <span class="free">q</span> <span class="main">@</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_queue_rep<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> filter_imp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> length <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>filter <span class="free">Q</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> filter_cong filter_filter length_filter_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> filter_take_drop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="free">xs</span> <span class="main">=</span> take <span class="free">n</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> drop <span class="free">n</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a xs n
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_empty_conv filter_eq_Cons_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a xs n
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_empty_conv filter_eq_Cons_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> mem_mt_and_memR_imp_mem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">nt</span> <span class="main">≥</span> <span class="free">mt</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="free">t</span><span class="main">)</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="free">t</span><span class="main">)</span> <span class="main">∧</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> take_filter_mem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> time <span class="bound">db</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> take <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">=</span> take <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> x_memR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> time_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">#</span><span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">#</span><span class="main">(</span>take <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> not_mem<span class="main">:</span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> filter_IH<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> takeWhile_IH<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> take <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">nat</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> takeWhile_IH<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="main">(</span>take <span class="skolem">nat</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> takeWhile_IH
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>mem <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">db</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> filter_IH
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> takeWhile_IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">!</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">xs</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> atLeastLessThan_iff case_prod_beta' in_set_conv_nth leI not_less_zero<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">!</span><span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">!</span><span class="main">0</span><span class="main">)</span> <span class="main">≤</span> fst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">!</span><span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span> j_props
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_memR <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> not_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> fold_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"fold <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">acc</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span> <span class="main">(</span>fold <span class="free">f</span> <span class="free">xs</span> <span class="free">acc</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> drop_last<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">⟹</span> drop <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[</span>last <span class="free">xs</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> One_nat_def append_butlast_last_id append_eq_append_conv append_take_drop_id diff_diff_cancel diff_is_0_eq' le_add_diff_inverse le_numeral_extra<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> length_drop length_greater_0_conv length_nth_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> zero_le_one<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> filter_sublist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">#</span><span class="free">xs</span> <span class="main">=</span> filter <span class="free">f</span> <span class="free">zs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">≤</span>length <span class="free">zs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> filter <span class="free">f</span> <span class="main">(</span>drop <span class="bound">n</span> <span class="free">zs</span><span class="main">)</span> <span class="main">∧</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> filter <span class="free">f</span> <span class="main">(</span>take <span class="bound">n</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">zs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">z</span> <span class="skolem">zs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">z</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">≤</span>length <span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> filter <span class="free">f</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> filter <span class="free">f</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> False
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">+</span><span class="main">1</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">1</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> idx_filter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">(</span>filter <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">!</span><span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>filter <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i'</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">}</span><span class="main">.</span> <span class="free">xs</span><span class="main">!</span><span class="bound">i'</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Set.member_filter atLeastLessThan_iff filter_set in_set_conv_nth zero_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> idx_filter_pair<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">(</span>filter <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">!</span><span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="main">(</span>filter <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">!</span><span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>filter <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i'</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">}</span><span class="main">.</span> <span class="main">∃</span><span class="bound">j'</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">i'</span><span class="main">}</span><span class="main">.</span> <span class="free">xs</span><span class="main">!</span><span class="bound">j'</span> <span class="main">=</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">xs</span><span class="main">!</span><span class="bound">i'</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"filter <span class="free">f</span> <span class="free">xs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span> <span class="skolem">zs</span><span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> i'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> Suc <span class="skolem">i'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc Cons<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> zs'_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">≤</span>length <span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> filter <span class="free">f</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">=</span> filter <span class="free">f</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons filter_sublist<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">as</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="skolem">zs</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i''</span></span> <span class="keyword2"><span class="keyword">where</span></span> i''_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i''</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>drop <span class="skolem">n</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>drop <span class="skolem">n</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">!</span><span class="skolem">i''</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> idx_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>drop <span class="skolem">n</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">i'</span></span><span class="main">]</span> Cons<span class="main">(</span>3-<span class="main">)</span><span class="main">[</span><span class="operator">folded</span> Cons<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span> zs'_props
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> i'_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 Cons<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> Cons<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> y_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">=</span> filter <span class="free">f</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> zs'_props<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="free">f</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">!</span><span class="main">0</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nth_Cons_0<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="main">(</span>filter <span class="free">f</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> y_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j''</span></span> <span class="keyword2"><span class="keyword">where</span></span> j''_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j''</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">!</span><span class="skolem">j''</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> idx_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="skolem">n</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">+</span> <span class="skolem">i''</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command">using</span></span> i''_props j''_props
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j''</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j'</span><span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> zs'_props<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">folded</span> zs'_props<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i'</span></span> <span class="quoted"><span class="skolem">j'</span></span><span class="main">]</span> Cons<span class="main">(</span>3-<span class="main">)</span><span class="main">[</span><span class="operator">folded</span> Cons<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc i'_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> i'' j''
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">+</span> <span class="skolem">i''</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> no_hist_last_not_sat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> data_in_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">+</span> <span class="free">idx_oldest</span> <span class="main">=</span> <span class="free">idx_mid</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tuple_since_tp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span> tuple_since_tp <span class="free">args</span> <span class="free">as</span> <span class="free">xs</span> <span class="free">idx_oldest</span> <span class="free">idx_mid</span> <span class="bound">idx</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∉</span> snd <span class="main">(</span>last <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> idx_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">idx</span></span><span class="main">&lt;</span><span class="free">idx_mid</span><span class="main">.</span> <span class="main">(</span>
      <span class="main">¬</span><span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="main">(</span><span class="bound">idx</span><span class="main">-</span><span class="free">idx_oldest</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> 
        <span class="free">as</span> <span class="main">∈</span> <span class="bound">r</span>
      <span class="main">)</span> <span class="main">∨</span>
      <span class="main">¬</span><span class="main">(</span><span class="bound">idx</span> <span class="main">&gt;</span> <span class="free">idx_oldest</span> <span class="main">⟶</span> <span class="free">as</span> <span class="main">∉</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="main">(</span><span class="bound">idx</span><span class="main">-</span><span class="free">idx_oldest</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tuple_since_tp non_empty
    <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">db</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">=</span> last <span class="free">xs</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∈</span> snd <span class="skolem">db</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> in_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> non_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> db_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">=</span> <span class="free">xs</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> db_def i_def
      <span class="keyword1"><span class="command">using</span></span> last_conv_nth
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">}</span><span class="main">.</span> <span class="free">as</span> <span class="main">∉</span> snd <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Max <span class="skolem">A</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">idx</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">=</span> <span class="free">idx_oldest</span> <span class="main">+</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">idx</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">=</span> <span class="free">idx_oldest</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> hist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">as</span> <span class="main">∈</span> snd <span class="bound">db</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&lt;</span> <span class="free">idx_mid</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span><span class="main">-</span><span class="free">idx_oldest</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="free">as</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> idx_def
        <span class="keyword1"><span class="command">using</span></span> data_in_len in_len hist
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&gt;</span> <span class="free">idx_oldest</span> <span class="main">⟶</span> <span class="free">as</span> <span class="main">∉</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="main">(</span><span class="skolem">idx</span><span class="main">-</span><span class="free">idx_oldest</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> idx_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
        <span class="keyword1"><span class="command">using</span></span> idx_props assm<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">db'</span></span> <span class="keyword2"><span class="keyword">where</span></span> db'_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">db'</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∉</span> snd <span class="skolem">db'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="free">xs</span><span class="main">!</span><span class="bound">j</span> <span class="main">=</span> <span class="skolem">db'</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> atLeastLessThan_iff leI not_less0 nth_the_index the_index_bounded<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> A_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> A_def
      <span class="keyword1"><span class="command">using</span></span> db'_props<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> j_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∉</span> snd <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> A_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_le_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">i</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> db_i assm
      <span class="keyword1"><span class="command">unfolding</span></span> i_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_leI Suc_pred atLeastLessThan_iff in_len leD linorder_neqE_nat<span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span><span class="main">&lt;..&lt;</span>length <span class="free">xs</span><span class="main">}</span><span class="main">.</span> <span class="free">as</span> <span class="main">∉</span> snd <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span><span class="main">&lt;..&lt;</span>length <span class="free">xs</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∉</span> snd <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="skolem">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> k_props<span class="main">(</span>1<span class="main">)</span> A_props j_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> suffix_hist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span><span class="main">&lt;..&lt;</span>length <span class="free">xs</span><span class="main">}</span><span class="main">.</span> <span class="free">as</span> <span class="main">∈</span> snd <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">db</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">!</span><span class="skolem">k</span> <span class="main">=</span> <span class="skolem">db</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> atLeastLessThan_iff in_set_conv_nth zero_le<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span><span class="main">!</span><span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">db</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∈</span> snd <span class="skolem">db</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> suffix_hist
        <span class="keyword1"><span class="command">using</span></span> k_props<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="free">as</span> <span class="main">∈</span> snd <span class="bound">db</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span><span class="main">-</span><span class="free">idx_oldest</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="free">as</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> idx_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∉</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="main">(</span><span class="skolem">idx</span><span class="main">-</span><span class="free">idx_oldest</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> idx_def
      <span class="keyword1"><span class="command">using</span></span> j_props<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&lt;</span> <span class="free">idx_mid</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> data_in_len j_le_i
      <span class="keyword1"><span class="command">unfolding</span></span> idx_def i_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
      <span class="keyword1"><span class="command">using</span></span> idx_props assm<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∉</span> snd <span class="main">(</span>last <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> idx_append_snd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="main">{</span>length <span class="free">ys</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span> <span class="main">⟹</span> <span class="free">xs</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> <span class="free">zs</span><span class="main">!</span><span class="main">(</span><span class="free">i</span> <span class="main">-</span> length <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_set_member<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">xs</span><span class="main">!</span><span class="free">i</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> tuple_since_hist_lookup_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="free">tuple_since_hist</span> <span class="bound">as</span> <span class="keyword1">of</span>
    Some <span class="bound">idx</span> <span class="main">⇒</span> tuple_since_tp <span class="free">args</span> <span class="bound">as</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="free">idx_oldest</span> <span class="free">idx_mid</span> <span class="bound">idx</span>
    <span class="main">|</span> None   <span class="main">⇒</span> <span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span>tuple_since_tp <span class="free">args</span> <span class="bound">as</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="free">idx_oldest</span> <span class="free">idx_mid</span> <span class="bound">idx</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"tuple_since_tp <span class="free">args</span> <span class="free">as</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="free">idx_oldest</span> <span class="free">idx_mid</span> <span class="free">jdx</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">jdx</span> <span class="main">&gt;</span> <span class="free">idx_oldest</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">+</span> <span class="free">idx_oldest</span> <span class="main">=</span> <span class="free">idx_mid</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_since_hist</span> <span class="free">as</span> <span class="main">=</span> Some <span class="free">jdx</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">(* (idx_oldest + j + 1) = jdx *)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="free">jdx</span> <span class="main">-</span> <span class="free">idx_oldest</span> <span class="main">-</span> <span class="main">1</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> in_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2-3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> jdx_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">jdx</span> <span class="main">&lt;</span> <span class="free">idx_mid</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">jdx</span> <span class="main">&gt;</span> <span class="free">idx_oldest</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∉</span> snd <span class="main">(</span><span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">!</span><span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> jdx_props<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def j_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∉</span> snd <span class="main">(</span><span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">!</span><span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> j_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> all_relR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="main">(</span><span class="main">(</span><span class="free">idx_oldest</span> <span class="main">+</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="free">idx_oldest</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">as</span> <span class="main">∈</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> jdx_props<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def j_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">idx</span></span> <span class="keyword2"><span class="keyword">where</span></span> idx_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_since_hist</span> <span class="free">as</span> <span class="main">=</span> Some <span class="skolem">idx</span>"</span></span>
    <span class="quoted"><span class="quoted">"tuple_since_tp <span class="free">args</span> <span class="free">as</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="free">idx_oldest</span> <span class="free">idx_mid</span> <span class="skolem">idx</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> idx_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&lt;</span> <span class="free">idx_mid</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">idx_oldest</span> <span class="main">+</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_th<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">!</span><span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="free">idx_oldest</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">!</span><span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="free">idx_oldest</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> idx_props<span class="main">(</span>2<span class="main">)</span> j_props<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_leI add.right_neutral add_Suc_right add_diff_cancel_left' add_diff_cancel_right' diff_Suc_Suc diff_le_mono le_add_diff_inverse less_imp_le_nat nth_drop<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">!</span><span class="skolem">j</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="free">idx_oldest</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> j_props<span class="main">(</span>1<span class="main">)</span> assm
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">idx_oldest</span> <span class="main">&lt;</span> <span class="skolem">idx</span>"</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">)</span></span> Suc_pred j_th add_diff_inverse_nat add_le_cancel_left add_less_cancel_left le_add1 le_less_trans le_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_drop nat_diff_split_asm nth_mem zero_less_diff zero_order<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="free">idx_oldest</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">as</span> <span class="main">∈</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> idx_props<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∈</span> snd <span class="main">(</span><span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">!</span><span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> j_props<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&gt;</span> <span class="free">idx_oldest</span> <span class="main">+</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> geq_drop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">-</span> <span class="free">idx_oldest</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≥</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> l_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="free">idx_oldest</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> idx_l assms<span class="main">(</span>4<span class="main">)</span> in_nonempty assm
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="free">idx_oldest</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">!</span><span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="free">idx_oldest</span> <span class="main">-</span> <span class="main">1</span> <span class="main">-</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> diff_diff_left le_add_diff_inverse le_less_trans less_imp_le_nat nth_drop<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>linearize <span class="free">data_in</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="free">idx_oldest</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> l_len geq_drop diff_diff_left diff_less_mono length_drop nth_mem<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∈</span> snd <span class="main">(</span>linearize <span class="free">data_in</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="free">idx_oldest</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> all_relR
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∉</span> snd <span class="main">(</span>linearize <span class="free">data_in</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="free">idx_oldest</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assm idx_props<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">=</span> <span class="main">(</span><span class="free">idx_oldest</span> <span class="main">+</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> linorder_neqE_nat
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">=</span> <span class="free">jdx</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> jdx_props
    <span class="keyword1"><span class="command">unfolding</span></span> j_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> idx_props<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tuple_since_hist_lookup_leq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="free">tuple_since_hist</span> <span class="free">as</span> <span class="keyword1">of</span>
    Some <span class="bound">idx</span> <span class="main">⇒</span> tuple_since_tp <span class="free">args</span> <span class="free">as</span> <span class="free">lin_data_in</span> <span class="free">idx_oldest</span> <span class="free">idx_mid</span> <span class="bound">idx</span>
    <span class="main">|</span> None   <span class="main">⇒</span> <span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span>tuple_since_tp <span class="free">args</span> <span class="free">as</span> <span class="free">lin_data_in</span> <span class="free">idx_oldest</span> <span class="free">idx_mid</span> <span class="bound">idx</span><span class="main">)</span>
  "</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"tuple_since_tp <span class="free">args</span> <span class="free">as</span> <span class="free">lin_data_in</span> <span class="free">idx_oldest</span> <span class="free">idx_mid</span> <span class="free">idx_oldest</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">lin_data_in</span> <span class="main">+</span> <span class="free">idx_oldest</span> <span class="main">=</span> <span class="free">idx_mid</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">idx</span><span class="main">.</span> Mapping.lookup <span class="free">tuple_since_hist</span> <span class="free">as</span> <span class="main">=</span> Some <span class="bound">idx</span> <span class="main">∧</span> <span class="bound">idx</span> <span class="main">≤</span> <span class="free">idx_oldest</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">idx</span><span class="main">.</span> Mapping.lookup <span class="free">tuple_since_hist</span> <span class="free">as</span> <span class="main">=</span> Some <span class="bound">idx</span> <span class="main">∧</span> <span class="bound">idx</span> <span class="main">≤</span> <span class="free">idx_oldest</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_since_hist</span> <span class="free">as</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">idx</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_since_tp <span class="free">args</span> <span class="free">as</span> <span class="free">lin_data_in</span> <span class="free">idx_oldest</span> <span class="free">idx_mid</span> <span class="skolem">idx</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&gt;</span> <span class="free">idx_oldest</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Some assm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&lt;</span> <span class="free">idx_mid</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&gt;</span> <span class="free">idx_oldest</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∉</span> snd <span class="main">(</span><span class="free">lin_data_in</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="free">idx_oldest</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span><span class="free">lin_data_in</span><span class="main">)</span><span class="main">.</span> <span class="free">as</span> <span class="main">∈</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> idx_append<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">!</span><span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_update_mmtaux'_unfolded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_before<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_mmtaux <span class="free">args</span> <span class="free">cur</span>
    <span class="main">(</span><span class="free">mt</span><span class="main">,</span> <span class="free">idx_next</span><span class="main">,</span> <span class="free">idx_mid</span><span class="main">,</span> <span class="free">idx_oldest</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in_once</span><span class="main">,</span> <span class="free">tuple_in_once_keys</span><span class="main">,</span> <span class="free">tuple_since_hist</span><span class="main">,</span> <span class="free">hist_sat</span><span class="main">,</span> <span class="free">since_sat</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nt_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nt</span> <span class="main">≥</span> <span class="free">cur</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">idx_mid'</span><span class="main">,</span> <span class="free">idx_oldest'</span><span class="main">,</span> <span class="free">data_prev'</span><span class="main">,</span> <span class="free">data_in''</span><span class="main">,</span> <span class="free">tuple_in_once'</span><span class="main">,</span> <span class="free">tuple_in_once_keys'</span><span class="main">,</span> <span class="free">tuple_since_hist''</span><span class="main">,</span> <span class="free">hist_sat''</span><span class="main">,</span> <span class="free">since_sat''</span><span class="main">)</span> <span class="main">=</span> update_mmtaux' <span class="free">args</span> <span class="free">nt</span> <span class="free">idx_mid</span> <span class="free">idx_oldest</span> <span class="free">maskL</span> <span class="free">maskR</span> <span class="free">data_prev</span> <span class="free">data_in</span> <span class="free">tuple_in_once</span> <span class="free">tuple_in_once_keys</span> <span class="free">tuple_since_hist</span> <span class="free">hist_sat</span> <span class="free">since_sat</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Mapping.keys <span class="free">tuple_in_once'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Mapping.keys <span class="free">tuple_since_hist''</span><span class="main">)</span>"</span></span>
    <span class="comment1">― ‹data_prev›</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>relL<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>relR<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"newest_tuple_in_mapping fst <span class="free">data_prev'</span> <span class="free">tuple_in_once'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_in_once'</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">tuple_in_once'</span> <span class="bound">as</span> <span class="keyword1">of</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="main">∃</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span> <span class="main">∧</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="bound">as</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span> <span class="main">+</span> <span class="free">idx_mid'</span> <span class="main">=</span> <span class="free">idx_next</span>"</span></span>

    <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="comment1">― ‹data_in›</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>snd<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"ts_tuple_rel_binary_rhs <span class="main">(</span>set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> take <span class="main">(</span>length <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="main">+</span> <span class="free">idx_oldest'</span> <span class="main">=</span> <span class="free">idx_mid'</span>"</span></span>
    <span class="comment1">― ‹tuple_since_hist›</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="free">tuple_since_hist''</span> <span class="bound">as</span> <span class="keyword1">of</span>
      Some <span class="bound">idx</span> <span class="main">⇒</span> tuple_since_tp <span class="free">args</span> <span class="bound">as</span> <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="free">idx_oldest'</span> <span class="free">idx_mid'</span> <span class="bound">idx</span>
      <span class="main">|</span> None   <span class="main">⇒</span> <span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span>tuple_since_tp <span class="free">args</span> <span class="bound">as</span> <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="free">idx_oldest'</span> <span class="free">idx_mid'</span> <span class="bound">idx</span><span class="main">)</span>
    <span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="free">hist_sat''</span> <span class="main">⟷</span>
      <span class="main">(</span><span class="main">¬</span>is_empty <span class="free">data_in''</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>
        <span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="bound">r</span>
    <span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="comment1">― ‹since_sat›</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="free">since_sat''</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">(</span><span class="bound">tuple</span> <span class="main">∈</span> <span class="free">hist_sat''</span><span class="main">)</span> <span class="main">∨</span> tuple_since_lhs <span class="bound">tuple</span> <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> tuple_since_lhs <span class="bound">tuple</span> <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="bound">tuple</span> <span class="main">∈</span> <span class="free">since_sat''</span>
    <span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">tuple_in_once_keys'</span> <span class="main">=</span> Mapping.keys <span class="free">tuple_in_once'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">shift_res</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">shift_res</span> <span class="main">=</span> shift_end
      <span class="main">(</span>flip_int_less_lower <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span><span class="main">)</span>
      <span class="free">nt</span>
      fst
      <span class="main">(</span>empty_queue<span class="main">::</span><span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> option list set <span class="main">×</span> <span class="tfree">'a</span> option list set<span class="main">)</span> queue<span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">tuple_in_once</span><span class="main">,</span> <span class="free">tuple_in_once_keys</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">empty_queue'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">empty_queue'</span> <span class="main">=</span> fst <span class="skolem">shift_res</span>"</span></span>
  
  <span class="keyword1"><span class="command">have</span></span> data_prev'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">data_prev'</span> <span class="main">=</span> <span class="main">(</span>fst <span class="keyword1">o</span> snd<span class="main">)</span> <span class="skolem">shift_res</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> shift_res_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> 
  
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">move</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">move</span> <span class="main">=</span> <span class="main">(</span>fst <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="skolem">shift_res</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">move'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">move'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">move</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> tuple_in_once'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tuple_in_once'</span> <span class="main">=</span> <span class="main">(</span>fst <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="skolem">shift_res</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> shift_res_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> tuple_in_once_keys'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tuple_in_once_keys'</span> <span class="main">=</span> <span class="main">(</span>snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="skolem">shift_res</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> shift_res_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">data_in'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">data_in'</span> <span class="main">=</span> fst <span class="main">(</span>takedropWhile_queue <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">data_in</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">in_drop</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">in_drop</span> <span class="main">=</span> snd <span class="main">(</span>takedropWhile_queue <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">data_in</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> data_in''_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">data_in''</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">data_in</span><span class="main">.</span> append_queue <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">data_in</span><span class="main">)</span> <span class="skolem">move'</span> <span class="skolem">data_in'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> shift_res_def data_in'_def data_in'_def move'_def move_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">data_in''</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">data_in</span><span class="main">.</span> append_queue <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">data_in</span><span class="main">)</span> <span class="skolem">move'</span> <span class="main">(</span>dropWhile_queue <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">data_in</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> data_in'_def move'_def
    <span class="keyword1"><span class="command">using</span></span> takedropWhile_queue_fst<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">data_in</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">drop_prev_len</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">drop_prev_len</span> <span class="main">=</span> length <span class="skolem">move</span> <span class="main">-</span> length <span class="skolem">move'</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> idx_mid'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">idx_mid'</span> <span class="main">=</span> <span class="free">idx_mid</span> <span class="main">+</span> length <span class="skolem">move</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> shift_res_def move_def drop_prev_len_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> idx_oldest'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">idx_oldest'</span> <span class="main">=</span> <span class="free">idx_oldest</span> <span class="main">+</span> length <span class="skolem">in_drop</span> <span class="main">+</span> <span class="skolem">drop_prev_len</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> shift_res_def in_drop_def drop_prev_len_def move'_def move_def
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> takedropWhile_queue_snd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">data_in</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> shift_end_res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">empty_queue'</span><span class="main">,</span> <span class="free">data_prev'</span><span class="main">,</span> <span class="skolem">move</span><span class="main">,</span> <span class="free">tuple_in_once'</span><span class="main">,</span> <span class="free">tuple_in_once_keys'</span><span class="main">)</span> <span class="main">=</span> shift_end
      <span class="main">(</span>flip_int_less_lower <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span><span class="main">)</span>
      <span class="free">nt</span>
      fst
      <span class="main">(</span>empty_queue<span class="main">::</span><span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> option list set <span class="main">×</span> <span class="tfree">'a</span> option list set<span class="main">)</span> queue<span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">tuple_in_once</span><span class="main">,</span> <span class="free">tuple_in_once_keys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> empty_queue'_def data_prev'_def move_def tuple_in_once'_def tuple_in_once_keys'_def shift_res_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">fold_op_f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fold_op_f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">::</span>ts<span class="main">,</span> <span class="bound">l</span><span class="main">::</span><span class="tfree">'a</span> option list set<span class="main">,</span> <span class="bound">r</span><span class="main">::</span><span class="tfree">'a</span> option list set<span class="main">)</span> <span class="main">(</span><span class="bound">tuple_since_hist</span><span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> option list<span class="main">,</span> nat<span class="main">)</span> mapping<span class="main">,</span> <span class="bound">hist_sat</span><span class="main">::</span> <span class="tfree">'a</span> option list set<span class="main">,</span> <span class="bound">idx_move</span><span class="main">,</span> <span class="bound">since_sat</span><span class="main">)</span><span class="main">.</span>
      <span class="keyword1">let</span> <span class="bound">tuple_since_hist</span> <span class="main">=</span> Mapping.filter <span class="main">(</span><span class="main">λ</span><span class="bound">as</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">tuple_since_hist</span><span class="main">;</span>
          <span class="bound">hist_sat</span>         <span class="main">=</span> <span class="bound">hist_sat</span> <span class="main">∩</span> <span class="bound">r</span><span class="main">;</span>
          <span class="bound">since_sat</span>        <span class="main">=</span> <span class="bound">since_sat</span> <span class="main">∩</span> <span class="bound">r</span>

      <span class="keyword1">in</span> 
      <span class="main">(</span>
        upd_set <span class="bound">tuple_since_hist</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">idx_move</span><span class="main">)</span> <span class="main">(</span><span class="bound">r</span> <span class="main">-</span> Mapping.keys <span class="bound">tuple_since_hist</span><span class="main">)</span><span class="main">,</span>
        <span class="bound">hist_sat</span><span class="main">,</span>
        <span class="bound">idx_move</span><span class="main">+</span><span class="main">1</span><span class="main">,</span> 
        <span class="bound">since_sat</span> <span class="main">∪</span> proj_tuple_in_join_optim <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="bound">r</span> <span class="main">(</span>join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span>join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span><span class="main">)</span>
      <span class="main">)</span> 
    <span class="main">)</span>"</span></span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tuple_since_hist'</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">hist_sat'</span></span> <span class="skolem"><span class="skolem">since_sat'</span></span> <span class="keyword2"><span class="keyword">where</span></span> fold_tuple_res<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">tuple_since_hist'</span><span class="main">,</span> <span class="skolem">hist_sat'</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">since_sat'</span><span class="main">)</span> <span class="main">=</span> fold <span class="skolem">fold_op_f</span> <span class="skolem">move</span> <span class="main">(</span><span class="free">tuple_since_hist</span><span class="main">,</span> <span class="free">hist_sat</span><span class="main">,</span> <span class="free">idx_mid</span><span class="main">,</span> <span class="free">since_sat</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> fold_op_f_def move_def shift_res_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> update_mmtaux'.simps Let_def fst_def snd_def o_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tuple_since_hist''_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tuple_since_hist''</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free">idx_mid'</span> <span class="main">=</span> <span class="free">idx_oldest'</span><span class="main">)</span> <span class="keyword1">then</span> Mapping.empty <span class="keyword1">else</span> <span class="skolem">tuple_since_hist'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> fold_op_f_def move_def shift_res_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> update_mmtaux'.simps Let_def fst_def snd_def o_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> since_sat''_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">since_sat''</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free">idx_mid'</span> <span class="main">=</span> <span class="free">idx_oldest'</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="skolem">since_sat'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> fold_tuple_res
    <span class="keyword1"><span class="command">unfolding</span></span> fold_op_f_def move_def shift_res_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> update_mmtaux'.simps Let_def fst_def snd_def o_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> hist_sat''_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">hist_sat''</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> fst <span class="main">(</span>safe_hd <span class="free">data_in''</span><span class="main">)</span>
    <span class="keyword1">of</span> None <span class="main">⇒</span>
      <span class="main">{}</span> 
    <span class="main">|</span> Some <span class="bound">db</span> <span class="main">⇒</span>
      <span class="skolem">hist_sat'</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">tuple</span></span> <span class="main">∈</span> <span class="main">(</span>snd <span class="bound">db</span><span class="main">)</span><span class="main">.</span>
        <span class="keyword1">case</span> <span class="main">(</span>Mapping.lookup <span class="free">tuple_since_hist''</span> <span class="bound">tuple</span><span class="main">)</span> <span class="keyword1">of</span>
          Some <span class="bound">idx</span> <span class="main">⇒</span> <span class="bound">idx</span> <span class="main">≤</span> <span class="free">idx_oldest'</span>
         <span class="main">|</span> None <span class="main">⇒</span> False
      <span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> fold_tuple_res
    <span class="keyword1"><span class="command">unfolding</span></span> fold_op_f_def move_def shift_res_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> update_mmtaux'.simps Let_def fst_def snd_def o_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> table_tuple_in<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Mapping.keys <span class="free">tuple_in_once</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> time<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cur</span> <span class="main">=</span> <span class="free">mt</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> auxlist_tuples_lhs<span class="main">:</span> <span class="quoted"><span class="quoted">"ts_tuple_rel_f <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span><span class="main">(</span>auxlist_data_prev <span class="free">args</span> <span class="free">mt</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> <span class="main">(</span>ts_tuple_rel_f <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{}</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span>linearize empty_queue<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
    False<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ts_tuple_rel_empty
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="comment1">(* ts_tuple_rel_binary_lhs (set (auxlist_data_prev args mt auxlist)) =
    {tas ∈ ts_tuple_rel_binary_lhs (set (linearize empty_queue)) ∪ ts_tuple_rel_f (λ_. {}) (set (linearize data_prev)). valid_tuple tuple_in_once tas}*)</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>relL<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>relR<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> valid_mmtaux.simps<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> data_sorted<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span> <span class="main">∧</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> data_prev_ts_props<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> nt_mono time
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="comment1">(*"(∀as ∈ ⋃(relL ` (set (linearize data_prev))). wf_tuple (args_n args) (args_L args) as)"
    "(∀as ∈ ⋃(relR ` (set (linearize data_prev))). wf_tuple (args_n args) (args_R args) as)"*)</span>
    <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span> <span class="main">∧</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> data_prev_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span> <span class="main">∧</span> memL <span class="main">(</span>flip_int_less_lower <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> flip_int_less_lower_memL
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">have</span></span> data_in_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span> <span class="main">∧</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> data_sorted<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span> data_in_ts_props<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> nt_mono time
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> empty_queue_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>fst <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize empty_queue<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize empty_queue<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize empty_queue<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> set <span class="main">(</span>linearize empty_queue<span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span> <span class="main">∧</span> <span class="main">¬</span> memL <span class="main">(</span>flip_int_less_lower <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> empty_queue_rep<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> max_ts_tuple_in<span class="main">:</span>
    <span class="quoted"><span class="quoted">"newest_tuple_in_mapping fst <span class="free">data_prev</span> <span class="free">tuple_in_once</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="comment1">(*

  "ts_tuple_rel_binary_lhs (set ((auxlist_data_prev args mt) auxlist)) =
    {tas ∈ (ts_tuple_rel_binary_lhs (set (linearize data_prev))) ∪ (ts_tuple_rel_f (λ_. {}) (set (linearize data_in))).
    valid_tuple tuple_in_once tas}"

*)</span>
  <span class="keyword1"><span class="command">have</span></span> nt_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nt</span> <span class="main">≥</span> <span class="free">cur</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">nt</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nt_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> shift_end_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Mapping.keys <span class="free">tuple_in_once'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"newest_tuple_in_mapping fst <span class="free">data_prev'</span> <span class="free">tuple_in_once'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span> <span class="main">∧</span> mem <span class="main">(</span>flip_int_less_lower <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">move</span> <span class="main">=</span> snd <span class="main">(</span>takedropWhile_queue <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>flip_int_less_lower <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">data_prev</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"linearize <span class="free">data_prev'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>flip_int_less_lower <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">tuple_in_once'</span> <span class="main">=</span>
    fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">.</span> Mapping.filter <span class="main">(</span>filter_cond <span class="main">(</span>fst <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">)</span> <span class="skolem">move</span> <span class="free">tuple_in_once</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">tuple_in_once_keys</span> <span class="main">=</span> Mapping.keys <span class="free">tuple_in_once</span> <span class="main">⟹</span> <span class="free">tuple_in_once_keys'</span> <span class="main">=</span> Mapping.keys <span class="free">tuple_in_once'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> relL_def relR_def
    <span class="keyword1"><span class="command">using</span></span> valid_shift_end_unfolded <span class="main">[</span><span class="operator">of</span>
        <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span></span></span>args_n <span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free">args</span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span></span></span>"</span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span></span></span>args_L <span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free">args</span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span></span></span>"</span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">tuple_in_once</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">λ</span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">.</span></span></span></span></span></span></span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">{}</span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span></span></span>"</span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span></span></span>auxlist_data_prev <span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free">args</span></span></span></span></span></span></span></span></span></span></span></span> <span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free">mt</span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span></span></span>"</span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">auxlist</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>
        <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">λ</span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">.</span></span></span></span></span></span></span></span></span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">{}</span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span></span></span>"</span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">empty_queue</span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">fst</span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">data_prev</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">λ</span></span></span></span></span></span></span></span></span></span></span></span><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">db</span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">.</span></span></span></span></span></span></span></span></span></span></span></span> False<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span></span></span>"</span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">fst</span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span></span></span>args_L <span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free">args</span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span></span></span>"</span></span></span></span></span></span></span></span></span></span></span></span></span>
        <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">nt</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"flip_int_less_lower <span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span></span></span>args_ivl <span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free"><span class="free">args</span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span></span></span>"</span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">cur</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">fst</span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">λ</span></span></span></span></span></span></span></span></span></span></span></span><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound"><span class="bound">x</span></span></span></span></span></span></span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">.</span></span></span></span></span></span></span></span></span></span></span></span> True<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span></span></span>"</span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">nt</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">empty_queue'</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">data_prev'</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">move</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">tuple_in_once'</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">,</span>
        <span class="operator">OF</span> table_tuple_in auxlist_tuples_lhs empty_queue_props<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span></span></span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span></span></span></span></span></span></span></span></span></span> 3-4<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span></span></span></span></span></span></span> 
        data_prev_props max_ts_tuple_in nt_mono shift_end_res
      <span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_tuple_rel_empty<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Mapping.keys <span class="free">tuple_in_once'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"newest_tuple_in_mapping fst <span class="free">data_prev'</span> <span class="free">tuple_in_once'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> shift_end_props<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">tuple_in_once_keys</span> <span class="main">=</span> Mapping.keys <span class="free">tuple_in_once</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">tuple_in_once_keys'</span> <span class="main">=</span> Mapping.keys <span class="free">tuple_in_once'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> shift_end_props<span class="main">(</span>8<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> auxlist_prev<span class="main">:</span> <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> auxlist_prev memL_mono
      <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_prev_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_prev'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> shift_end_props<span class="main">(</span>6<span class="main">)</span> calculation<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> data_prev_eq_mem_0<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  
  <span class="keyword1"><span class="command">have</span></span> data_prev'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_prev'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> data_prev_eq_mem_0
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> not_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> shift_end_props<span class="main">(</span>6<span class="main">)</span> flip_int_less_lower_memR<span class="main">[</span><span class="operator">OF</span> not_mem<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> move_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">move</span> <span class="main">=</span> snd <span class="main">(</span>takedropWhile_queue <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">data_prev</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> shift_end_props<span class="main">(</span>5<span class="main">)</span> data_prev_eq_mem_0
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> takeWhile.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> takedropWhile_queue_snd<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> not_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> shift_end_props<span class="main">(</span>5<span class="main">)</span> flip_int_less_lower_memR<span class="main">[</span><span class="operator">OF</span> not_mem<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> move_takeWhile<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">move</span> <span class="main">=</span> takeWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> takedropWhile_queue_snd
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> move_filter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">move</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> data_sorted<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span> sorted_filter_takeWhile_memL<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_prev</span>"</span></span> <span class="quoted"><span class="free">args</span></span> <span class="quoted"><span class="free">nt</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> filter_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> move'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">move'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> move'_def move_filter filter_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_simp<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> filter_data_prev_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> auxlist_prev data_prev'_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> auxlist_prev_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_prev_def
    <span class="keyword1"><span class="command">using</span></span> filter_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">auxlist</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> filter_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span>  <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> filter_and<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span>  <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> auxlist_prev_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> not_memL_nt_mt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span>  <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nt_mono time memL_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"args_ivl <span class="free">args</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> filter_auxlist_data_prev'<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">¬</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_memL_imp_memR<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">args</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> filter_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> filter_cong prod.case_eq_if<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> auxlist_prev_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_prev_def
    <span class="keyword1"><span class="command">using</span></span> filter_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">auxlist</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> filter_data_prev_nt<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">rel</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> auxlist_data_prev <span class="free">args</span> <span class="free">nt</span> <span class="free">auxlist</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> filter_data_prev_nt filter_auxlist_data_prev'
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_prev_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">¬</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_memL_imp_memR<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">args</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> auxlist_data_prev_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">nt</span> <span class="free">auxlist</span> <span class="main">=</span> auxlist_data_prev <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">rel</span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_prev_def filter_filter
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_eq filter_auxlist_data_prev'<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tuple_in_once_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tuple_in_once</span> <span class="main">=</span> Mapping.empty"</span></span> <span class="keyword1"><span class="command">using</span></span> tuple_in_once_mem0<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> filter_simp<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">el</span> <span class="bound">tuple_in</span><span class="main">.</span> Mapping.filter <span class="main">(</span><span class="main">(</span><span class="keyword1">case</span> <span class="bound">el</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">λ</span><span class="bound">tuple_in</span><span class="main">.</span> filter_cond <span class="main">(</span>fst <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">.</span> Mapping.filter <span class="main">(</span>filter_cond <span class="main">(</span>fst <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">.</span> Mapping.filter <span class="main">(</span>filter_cond <span class="main">(</span>fst <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">)</span>
   <span class="main">(</span>snd <span class="main">(</span>takedropWhile_queue <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>flip_int_less_lower <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span> Mapping.empty <span class="main">=</span> Mapping.empty"</span></span>
      <span class="comment1">(* Mapping.filter (filter_cond_r (fst X) (proj_tuple maskL) tuple_in t) *)</span>
      <span class="keyword1"><span class="command">using</span></span> 
        fold_Mapping_filter_empty<span class="main">[</span><span class="operator">of</span>
          <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">.</span> <span class="main">(</span>filter_cond <span class="main">(</span>fst <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="main">(</span>takedropWhile_queue <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>flip_int_less_lower <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> filter_simp<span class="main">)</span>
   
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">tuple_in_once'</span> <span class="main">=</span> Mapping.empty"</span></span> <span class="quoted"><span class="quoted">"<span class="free">tuple_in_once</span> <span class="main">=</span> Mapping.empty"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tuple_in_once_empty shift_end_props<span class="main">(</span>5<span class="main">)</span> shift_end_props<span class="main">(</span>7<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mem0<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">tuple_in_once</span> <span class="main">=</span> Mapping.empty <span class="main">∧</span> <span class="free">tuple_in_once'</span> <span class="main">=</span> Mapping.empty"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> False<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">tuple_in_once'</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">.</span> Mapping.filter <span class="main">(</span>filter_cond <span class="main">(</span>fst <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">)</span>
        <span class="skolem">move</span> <span class="free">tuple_in_once</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> shift_end_props<span class="main">(</span>7<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tuple_in_once'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tuple_in_once'</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">.</span> Mapping.filter <span class="main">(</span>filter_cond <span class="main">(</span>fst <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">)</span>
      <span class="main">(</span>snd <span class="main">(</span>takedropWhile_queue <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span> <span class="free">tuple_in_once</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> move_def
      <span class="keyword1"><span class="command">using</span></span> flip_int_less_lower_memR<span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">fold_fn</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'a</span> option list set <span class="main">×</span> <span class="tfree">'a</span> option list set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> option list<span class="main">,</span> nat<span class="main">)</span> mapping <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> option list<span class="main">,</span> nat<span class="main">)</span> mapping"</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fold_fn</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">.</span> Mapping.filter <span class="main">(</span>filter_cond <span class="main">(</span>fst <span class="bound">X</span><span class="main">)</span> <span class="bound">tuple_in</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">tuple_in</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">fold_list</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fold_list</span> <span class="main">=</span> <span class="main">(</span>snd <span class="main">(</span>takedropWhile_queue <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tuple_in_once'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tuple_in_once'</span> <span class="main">=</span> fold <span class="skolem">fold_fn</span> <span class="skolem">fold_list</span> <span class="free">tuple_in_once</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tuple_in_once'_eq
      <span class="keyword1"><span class="command">unfolding</span></span> fold_fn_def fold_list_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">from</span></span> fold_list_def <span class="keyword1"><span class="command">have</span></span> fold_list_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">fold_list</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> takedropWhile_queue_snd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">data_prev</span></span><span class="main">]</span>
      set_takeWhileD
      <span class="keyword1"><span class="command">unfolding</span></span> fold_list_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tuple</span>
      <span class="keyword3"><span class="command">assume</span></span> t'_props<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_in_once</span> <span class="skolem">tuple</span> <span class="main">=</span> None"</span></span>     
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>fold <span class="skolem">fold_fn</span> <span class="skolem">fold_list</span> <span class="free">tuple_in_once</span><span class="main">)</span> <span class="skolem">tuple</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fold_Mapping_filter_None<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">tuple_in_once</span></span> <span class="quoted"><span class="skolem">tuple</span></span> <span class="quoted">fst</span> <span class="quoted"><span class="skolem">fold_list</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> fold_fn_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_in_once</span> <span class="skolem">tuple</span> <span class="main">=</span> Mapping.lookup <span class="free">tuple_in_once'</span> <span class="skolem">tuple</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> tuple_in_once'_eq t'_props
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> none<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> Mapping.lookup <span class="free">tuple_in_once</span> <span class="bound">tuple</span> <span class="main">=</span> None <span class="main">⟶</span> Mapping.lookup <span class="free">tuple_in_once</span> <span class="bound">tuple</span> <span class="main">=</span> Mapping.lookup <span class="free">tuple_in_once'</span> <span class="bound">tuple</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">tuple</span>
      <span class="keyword3"><span class="command">assume</span></span> t_props<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_in_once</span> <span class="skolem">tuple</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_in_once</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">tuple_in_once</span> <span class="bound">as</span> <span class="keyword1">of</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="main">∃</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">∧</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="bound">as</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> X_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">X</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> t_props
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Mapping_keys_intro fst_conv option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span>mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span> <span class="main">⟶</span> args_pos <span class="free">args</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"args_pos <span class="free">args</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> memL_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"args_ivl <span class="free">args</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_prev_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> X_props
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> atLeastLessThan_iff leI not_less0 nth_the_index the_index_bounded<span class="main">)</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span><span class="main">&lt;</span><span class="skolem">i</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="comment1">(* generated subproof *)</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> length <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> length <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assm i_props<span class="main">(</span>2<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> in_set_conv_nth linorder_neqE_nat takeWhile_nth<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> X_props<span class="main">(</span>1<span class="main">)</span> assm
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> length_takeWhile_less takeWhile_eq_all_conv<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> f1 i_props<span class="main">(</span>2<span class="main">)</span> t_props<span class="main">(</span>2<span class="main">)</span> nth_length_takeWhile
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">&lt;</span><span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="main">(</span>fst <span class="main">(</span><span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">!</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">!</span><span class="skolem">j</span><span class="main">)</span> <span class="main">≤</span> fst <span class="main">(</span><span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> i_props<span class="main">(</span>1<span class="main">)</span> j_props<span class="main">(</span>1<span class="main">)</span> data_sorted<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> atLeastLessThan_iff le_less_trans length_map less_imp_le_nat nth_map sorted_nth_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="main">(</span>fst <span class="main">(</span><span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> j_props memL_mono
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> i_props t_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> t_props<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">fold_list</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> fold_list_def
        <span class="keyword1"><span class="command">using</span></span> takedropWhile_queue_snd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">data_prev</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> fst <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> maskL<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="free">maskL</span> <span class="main">=</span> join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="skolem">tuple</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Mapping_keys_intro option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> t_props<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> table_def table_tuple_in<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">using</span></span> X_props<span class="main">(</span>2<span class="main">)</span> maskL wf_tuple_proj_idle<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"args_n <span class="free">args</span>"</span></span> <span class="quoted"><span class="quoted">"args_L <span class="free">args</span>"</span></span> <span class="quoted"><span class="skolem">tuple</span></span><span class="main">]</span> pos
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>fold <span class="skolem">fold_fn</span> <span class="skolem">fold_list</span> <span class="free">tuple_in_once</span><span class="main">)</span> <span class="skolem">tuple</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fold_Mapping_filter_Some_None<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">tuple_in_once</span></span> <span class="quoted"><span class="skolem">tuple</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted">fst</span> <span class="main">_</span> <span class="quoted"><span class="skolem">fold_list</span></span><span class="main">]</span> t_props<span class="main">(</span>1<span class="main">)</span> X_props<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> fold_fn_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_in_once'</span> <span class="skolem">tuple</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">using</span></span> tuple_in_once'_eq
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Some_none<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> Mapping.lookup <span class="free">tuple_in_once</span> <span class="bound">tuple</span> <span class="main">=</span> Some <span class="bound">t</span> <span class="main">∧</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> Mapping.lookup <span class="free">tuple_in_once'</span> <span class="bound">tuple</span> <span class="main">=</span> None"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">tuple</span>
      <span class="keyword3"><span class="command">assume</span></span> t_props<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_in_once</span> <span class="skolem">tuple</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">fold_list</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> fold_list_props
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> t_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">fold_list</span> <span class="main">⟹</span> <span class="skolem">tuple</span> <span class="main">∉</span> fst <span class="bound">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_in_once</span> <span class="skolem">tuple</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>fold <span class="skolem">fold_fn</span> <span class="skolem">fold_list</span> <span class="free">tuple_in_once</span><span class="main">)</span> <span class="skolem">tuple</span> <span class="main">=</span> Mapping.lookup <span class="free">tuple_in_once</span> <span class="skolem">tuple</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fold_Mapping_filter_Some_Some<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">tuple_in_once</span></span> <span class="quoted"><span class="skolem">tuple</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">fold_list</span></span> <span class="quoted">fst</span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> fold_fn_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_in_once</span> <span class="skolem">tuple</span> <span class="main">=</span> Mapping.lookup <span class="free">tuple_in_once'</span> <span class="skolem">tuple</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> tuple_in_once'_eq
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tuple_in_once_eq_Some<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> Mapping.lookup <span class="free">tuple_in_once</span> <span class="bound">tuple</span> <span class="main">=</span> Some <span class="bound">t</span> <span class="main">∧</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> Mapping.lookup <span class="free">tuple_in_once</span> <span class="bound">tuple</span> <span class="main">=</span> Mapping.lookup <span class="free">tuple_in_once'</span> <span class="bound">tuple</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> Mapping.lookup <span class="free">tuple_in_once</span> <span class="bound">tuple</span> <span class="main">=</span> Some <span class="bound">t</span> <span class="main">∧</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> Mapping.lookup <span class="free">tuple_in_once'</span> <span class="bound">tuple</span> <span class="main">=</span> None"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> Mapping.lookup <span class="free">tuple_in_once</span> <span class="bound">tuple</span> <span class="main">=</span> None <span class="main">⟶</span> Mapping.lookup <span class="free">tuple_in_once</span> <span class="bound">tuple</span> <span class="main">=</span> Mapping.lookup <span class="free">tuple_in_once'</span> <span class="bound">tuple</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> none Some_none
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> Mapping.lookup <span class="free">tuple_in_once</span> <span class="bound">tuple</span> <span class="main">=</span> Some <span class="bound">t</span>  <span class="main">∧</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> Mapping.lookup <span class="free">tuple_in_once</span> <span class="bound">tuple</span> <span class="main">=</span> Mapping.lookup <span class="free">tuple_in_once'</span> <span class="bound">tuple</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> Mapping.lookup <span class="free">tuple_in_once</span> <span class="bound">tuple</span> <span class="main">=</span> Some <span class="bound">t</span> <span class="main">∧</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> Mapping.lookup <span class="free">tuple_in_once'</span> <span class="bound">tuple</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> Mapping.lookup <span class="free">tuple_in_once</span> <span class="bound">tuple</span> <span class="main">=</span> None <span class="main">⟶</span> Mapping.lookup <span class="free">tuple_in_once</span> <span class="bound">tuple</span> <span class="main">=</span> Mapping.lookup <span class="free">tuple_in_once'</span> <span class="bound">tuple</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> Mapping.lookup <span class="free">tuple_in_once</span> <span class="bound">tuple</span> <span class="main">=</span> Mapping.lookup <span class="free">tuple_in_once'</span> <span class="bound">tuple</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mem0
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> tuple_in_once_lookup<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> Mapping.lookup <span class="free">tuple_in_once</span> <span class="bound">tuple</span> <span class="main">=</span> Some <span class="bound">t</span>  <span class="main">∧</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> Mapping.lookup <span class="free">tuple_in_once</span> <span class="bound">tuple</span> <span class="main">=</span> Mapping.lookup <span class="free">tuple_in_once'</span> <span class="bound">tuple</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> Mapping.lookup <span class="free">tuple_in_once</span> <span class="bound">tuple</span> <span class="main">=</span> Some <span class="bound">t</span> <span class="main">∧</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> Mapping.lookup <span class="free">tuple_in_once'</span> <span class="bound">tuple</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> Mapping.lookup <span class="free">tuple_in_once</span> <span class="bound">tuple</span> <span class="main">=</span> None <span class="main">⟶</span> Mapping.lookup <span class="free">tuple_in_once</span> <span class="bound">tuple</span> <span class="main">=</span> Mapping.lookup <span class="free">tuple_in_once'</span> <span class="bound">tuple</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> Mapping.lookup <span class="free">tuple_in_once</span> <span class="bound">tuple</span> <span class="main">=</span> Mapping.lookup <span class="free">tuple_in_once'</span> <span class="bound">tuple</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> tuple_in_once'_subseteq<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.keys <span class="free">tuple_in_once'</span> <span class="main">⊆</span> Mapping.keys <span class="free">tuple_in_once</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mem0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_in_once'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_in_once</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> False tuple_in_once_lookup<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domIff keys_dom_lookup<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> data_prev_wf<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>relL<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>relR<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>relL<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>relR<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> shift_end_props<span class="main">(</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> tuple_in_once_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_in_once</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">tuple_in_once</span> <span class="bound">as</span> <span class="keyword1">of</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="main">∃</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">∧</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="bound">as</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">as</span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_in_once'</span> <span class="skolem">as</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span> <span class="main">∧</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assm mem0
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping.lookup_empty<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> assm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_in_once'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_keys_intro<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> as_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_in_once</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assm tuple_in_once'_subseteq
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'_props<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_in_once</span> <span class="skolem">as</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Mapping_keys_dest<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">as</span></span> <span class="quoted"><span class="free">tuple_in_once</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_in_once'</span> <span class="skolem">as</span> <span class="main">=</span> None"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False t'_props tuple_in_once_lookup<span class="main">(</span>2<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> not_memL<span class="main">:</span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_in_once'</span> <span class="skolem">as</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False t'_props tuple_in_once_lookup<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">=</span><span class="skolem">t'</span>"</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_in_once</span> <span class="skolem">as</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assm t'_props
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> tlr_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="skolem">l</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">as</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> as_mem tuple_in_once_props
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False not_memL data_prev'_eq t_eq<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> tlr_props
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_in_once'</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">tuple_in_once'</span> <span class="bound">as</span> <span class="keyword1">of</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="main">∃</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span> <span class="main">∧</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="bound">as</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Mapping_keys_dest
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">have</span></span> filter_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">drop_prev_len</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> drop_prev_len_def move_filter move'_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">drop_prev_len</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">drop_prev_len</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> filter_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_prev</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
    length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_length_filter_compl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">drop_prev_len</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">drop_prev_len</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">drop_prev_len</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> filter_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_prev</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">drop_prev_len</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_memR_imp_memL<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">args</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> drop_prev_len_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">drop_prev_len</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> data_prev_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">+</span> <span class="free">idx_mid</span> <span class="main">=</span> <span class="free">idx_next</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> data_prev'_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lin_prev'_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prod_beta' filter_cong<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> idx_mid'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">idx_mid'</span> <span class="main">=</span> <span class="free">idx_mid</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> idx_mid'_def move_filter
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">idx_mid'</span> <span class="main">-</span> <span class="free">idx_mid</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">idx_mid'</span> <span class="main">-</span> <span class="free">idx_mid</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lin_prev'_len sum_length_filter_compl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span> <span class="main">+</span> <span class="free">idx_mid'</span> <span class="main">=</span> <span class="free">idx_next</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> data_prev_len
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> idx_mid'_def<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> data_in_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">+</span> <span class="free">idx_oldest</span> <span class="main">=</span> <span class="free">idx_mid</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mid_geq_old<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">idx_mid</span> <span class="main">≥</span> <span class="free">idx_oldest</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> idx_oldest'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">idx_oldest'</span> <span class="main">=</span> <span class="free">idx_oldest</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">drop_prev_len</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> idx_oldest'_def
    <span class="keyword1"><span class="command">unfolding</span></span> in_drop_def
    <span class="keyword1"><span class="command">using</span></span> takedropWhile_queue_snd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">data_in</span></span><span class="main">]</span>
      data_sorted<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span> sorted_filter_takeWhile_not_memR<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in</span>"</span></span> <span class="quoted"><span class="free">args</span></span> <span class="quoted"><span class="free">nt</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">idx_mid'</span> <span class="main">+</span> <span class="free">idx_oldest</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">drop_prev_len</span> <span class="main">=</span> <span class="free">idx_oldest'</span> <span class="main">+</span> <span class="free">idx_mid</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> idx_mid'_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">idx_mid'</span> <span class="main">+</span> <span class="free">idx_oldest</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">drop_prev_len</span> <span class="main">=</span> <span class="free">idx_oldest'</span> <span class="main">+</span> <span class="free">idx_mid</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_memR_imp_memL<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">args</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> prev_not_memR_leq_prev_memL<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> filter_imp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_prev</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">idx_oldest'</span> <span class="main">≤</span> <span class="free">idx_mid</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> idx_oldest'_eq drop_prev_len_eq
    <span class="keyword1"><span class="command">using</span></span> data_in_len
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mid'_geq_old'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">idx_oldest'</span> <span class="main">≤</span> <span class="free">idx_mid'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> idx_mid'_eq
    <span class="keyword1"><span class="command">using</span></span> prev_not_memR_leq_prev_memL
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in''</span> <span class="main">=</span> linearize <span class="skolem">data_in'</span> <span class="main">@</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">move</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> data_in''_def fold_append_queue_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">move'</span></span> <span class="quoted"><span class="skolem">data_in'</span></span><span class="main">]</span> move'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in''</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">@</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> data_in'_def takedropWhile_queue_fst<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">data_in</span></span><span class="main">]</span>
          data_sorted<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span>
          dropWhile_queue_rep<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">data_in</span></span><span class="main">]</span>
          sorted_filter_dropWhile_memR<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in</span>"</span></span> <span class="quoted"><span class="free">args</span></span> <span class="quoted"><span class="free">nt</span></span><span class="main">]</span> move_def
          takedropWhile_queue_snd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">data_prev</span></span><span class="main">]</span>
          sorted_filter_takeWhile_memL<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_prev</span>"</span></span> <span class="quoted"><span class="free">args</span></span> <span class="quoted"><span class="free">nt</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> lin_data_in''_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in''</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">@</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> filter_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> filter_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_length_filter_compl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> data_in''_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> filter_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_length_filter_compl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span><span class="main">]</span>
          filter_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_prev</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_memR_imp_memL<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">args</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> filter_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_prev</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">idx_mid'</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">+</span> <span class="free">idx_oldest'</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> len_eq idx_mid'_eq data_in_len drop_prev_len_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">idx_mid'</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">+</span> <span class="free">idx_oldest'</span> <span class="main">+</span> <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prev_not_memR_leq_prev_memL
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">idx_mid'</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">+</span> <span class="free">idx_oldest'</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> len_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> data_in''_len'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="main">+</span> <span class="free">idx_oldest'</span> <span class="main">=</span> <span class="free">idx_mid'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> data_in''_len
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tuple_since_hist''_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tuple_since_hist''</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>is_empty <span class="free">data_in''</span><span class="main">)</span> <span class="keyword1">then</span> Mapping.empty <span class="keyword1">else</span> <span class="skolem">tuple_since_hist'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tuple_since_hist''_def is_empty_alt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">data_in''</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>snd<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>snd<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> data_prev_wf<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> relR_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>snd<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> filter_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> data_in_auxlist_filter_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="free">auxlist</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def filter_filter
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_simp<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">timed_tuple</span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">timed_tuple</span> <span class="main">∈</span> ts_tuple_rel_binary_rhs <span class="main">(</span>set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> fst <span class="skolem">timed_tuple</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tuple</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">=</span> snd <span class="skolem">timed_tuple</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> assm <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> l_r_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ts_tuple_rel_f_def t_def tuple_def auxlist_data_in_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">auxlist</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">timed_tuple</span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> mem<span class="main">(</span>2<span class="main">)</span> auxlist_mem_or<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> time_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_eq
        <span class="keyword1"><span class="command">using</span></span> mem<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> l_r_def<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> ts_tuple_rel_f_def t_def tuple_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> mem<span class="main">(</span>2<span class="main">)</span> auxlist_mem_or<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> time_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> mem<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_eq
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> l_r_def<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> ts_tuple_rel_f_def t_def tuple_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">timed_tuple</span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">timed_tuple</span> <span class="main">∈</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> fst <span class="skolem">timed_tuple</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tuple</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">=</span> snd <span class="skolem">timed_tuple</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> assm <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> tuple_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">@</span>
                  map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ts_tuple_rel_f_def lin_data_in''_eq t_def tuple_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> memR<span class="main">:</span> <span class="quoted"><span class="quoted">"memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> data_in_mem<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> memL_mono nt_mono time <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> memR <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> memR<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> memR<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">auxlist</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def
        <span class="keyword1"><span class="command">using</span></span> mem
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">timed_tuple</span> <span class="main">∈</span> ts_tuple_rel_binary_rhs <span class="main">(</span>set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> ts_tuple_rel_f_def auxlist_data_in_def
        <span class="keyword1"><span class="command">using</span></span> tuple_props<span class="main">(</span>1<span class="main">)</span> t_def tuple_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_prev_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">auxlist</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def
        <span class="keyword1"><span class="command">using</span></span> mem
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">timed_tuple</span> <span class="main">∈</span> ts_tuple_rel_binary_rhs <span class="main">(</span>set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> ts_tuple_rel_f_def auxlist_data_in_def
        <span class="keyword1"><span class="command">using</span></span> tuple_props<span class="main">(</span>1<span class="main">)</span> t_def tuple_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">timed_tuple</span> <span class="main">∈</span> ts_tuple_rel_binary_rhs <span class="main">(</span>set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ts_tuple_rel_binary_rhs <span class="main">(</span>set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ts_tuple_rel_binary_rhs <span class="main">(</span>set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> data_in_auxlist_filter_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> filter_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> filter_simp'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> filter_simp''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> auxlist_eqs<span class="main">:</span>
    <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
    <span class="quoted"><span class="quoted">"auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">=</span> take <span class="main">(</span>length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> auxlist_concat<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span> <span class="main">@</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span> <span class="main">=</span> <span class="free">auxlist</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_prev_def auxlist_data_in_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in''</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">@</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lin_data_in''_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> in_eqs<span class="main">:</span>
      <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in''</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def auxlist_data_prev_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in''</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> filter_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_simp'<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in''</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in''</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> filter_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">auxlist</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_simp''<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in''</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mem_mt_and_memR_imp_mem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">mt</span></span> <span class="quoted"><span class="free">nt</span></span> <span class="quoted"><span class="free">args</span></span><span class="main">]</span> nt_mono time
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> filter_simp'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in''</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> filter_simp'<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> filter_simp'<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> filter_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">auxlist</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in''</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">@</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> filter_simp'
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in''</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> linearize <span class="free">data_in''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> auxlist_concat
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> linearize <span class="free">data_in''</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lin_data_in''_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> linearize <span class="free">data_in''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> filter_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">auxlist</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> auxlist_data_in<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> linearize <span class="free">data_in''</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> filter_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> filter_simp'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span>"</span></span>
                     <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> prev_drop_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> data_in''_len
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">-</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  
  <span class="keyword1"><span class="command">have</span></span> memR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> time <span class="bound">db</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> time_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="free">auxlist</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sorted<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sorted_filter
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lin_data_in''_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> length_map<span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> filter_take_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> take <span class="main">(</span>length <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> take_filter_mem<span class="main">[</span><span class="operator">OF</span> memR sorted<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> auxlist_data_in_take_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> take <span class="main">(</span>length <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> filter_take_eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> take <span class="main">(</span>length <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> filter_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">auxlist</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> filter_auxlist_take<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> take <span class="main">(</span>length <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> filter_simp'<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> filter_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> filter_simp'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> filter_simp''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> take <span class="main">(</span>length <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> filter_auxlist_take
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> take <span class="main">(</span>length <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> filter_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">auxlist</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_simp'<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> filter_take_drop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> filter_simp''<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span>
    drop <span class="main">(</span>length <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_prev_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">as</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">idx_oldest_mv</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx_oldest_mv</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">move</span><span class="main">::</span><span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> option list set <span class="main">×</span> <span class="tfree">'a</span> option list set<span class="main">)</span> list<span class="main">.</span>
      <span class="free">idx_oldest</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> length <span class="bound">move</span> <span class="main">-</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">move</span><span class="main">)</span>
    <span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">idx_mid_mv</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx_mid_mv</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">move</span><span class="main">::</span><span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> option list set <span class="main">×</span> <span class="tfree">'a</span> option list set<span class="main">)</span> list<span class="main">.</span>
      <span class="free">idx_mid</span> <span class="main">+</span> length <span class="bound">move</span>
    <span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">lin_data_in''_mv</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">move</span><span class="main">::</span><span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> option list set <span class="main">×</span> <span class="tfree">'a</span> option list set<span class="main">)</span> list<span class="main">.</span>
      linearize <span class="skolem">data_in'</span> <span class="main">@</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">move</span><span class="main">)</span>
    <span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> filter_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> data_in'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="skolem">data_in'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> data_in'_def
      <span class="keyword1"><span class="command">using</span></span> takedropWhile_queue_fst<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">data_in</span></span><span class="main">]</span>
            dropWhile_queue_rep<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">data_in</span></span><span class="main">]</span>
            data_sorted<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span> sorted_filter_dropWhile_memR<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in</span>"</span></span> <span class="quoted"><span class="free">args</span></span> <span class="quoted"><span class="free">nt</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">move</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> option list set <span class="main">×</span> <span class="tfree">'a</span> option list set<span class="main">)</span> list"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="free">idx_oldest</span> <span class="main">=</span> <span class="free">idx_mid</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> data_in_len
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">move</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">idx_oldest_mv</span> <span class="skolem">move</span> <span class="main">=</span> <span class="skolem">idx_mid_mv</span> <span class="skolem">move</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_mv_def idx_oldest_mv_def idx_mid_mv_def
        <span class="keyword1"><span class="command">unfolding</span></span> data_in'_eq
        <span class="keyword1"><span class="command">using</span></span> sum_length_filter_compl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">move</span>"</span></span><span class="main">]</span>
              sum_length_filter_compl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_simp<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mv_ln_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">move</span><span class="main">.</span> length <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="bound">move</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">idx_oldest_mv</span> <span class="bound">move</span> <span class="main">=</span> <span class="skolem">idx_mid_mv</span> <span class="bound">move</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tuple_since_hist_mv</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_since_hist_mv</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">move</span><span class="main">::</span><span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> option list set <span class="main">×</span> <span class="tfree">'a</span> option list set<span class="main">)</span> list<span class="main">)</span> <span class="bound">tuple</span><span class="main">.</span>
      <span class="keyword1">if</span> <span class="main">(</span><span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="bound">move</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="bound">move</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
        Mapping.empty
      <span class="keyword1">else</span>
        fst <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="bound">move</span> <span class="bound">tuple</span><span class="main">)</span>
    <span class="main">)</span>"</span></span>
   
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">hist_sat_mv</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hist_sat_mv</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">move</span> <span class="bound">tuple</span><span class="main">.</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="bound">move</span><span class="main">)</span>
        <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span>
          <span class="main">{}</span> 
        <span class="main">|</span> <span class="main">(</span><span class="bound">db</span><span class="main">#</span><span class="bound">dbs</span><span class="main">)</span> <span class="main">⇒</span>
          <span class="main">(</span><span class="main">(</span>fst <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="bound">move</span> <span class="bound">tuple</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="main">(</span>snd <span class="bound">db</span><span class="main">)</span><span class="main">.</span>
            <span class="keyword1">case</span> <span class="main">(</span>Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="bound">move</span> <span class="bound">tuple</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span> <span class="keyword1">of</span>
              Some <span class="bound">idx</span> <span class="main">⇒</span> <span class="bound">idx</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="bound">move</span><span class="main">)</span>
            <span class="main">|</span> None <span class="main">⇒</span> False
          <span class="main">}</span><span class="main">)</span>
    <span class="main">)</span>"</span></span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">since_sat_mv</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">since_sat_mv</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">move</span> <span class="bound">tuple</span><span class="main">.</span>
      <span class="keyword1">if</span> <span class="main">(</span><span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="bound">move</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="bound">move</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
        <span class="main">{}</span>
      <span class="keyword1">else</span>
        <span class="main">(</span>snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="bound">move</span> <span class="bound">tuple</span><span class="main">)</span>
    <span class="main">)</span>"</span></span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">data_in'_aux</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">data_in'_aux</span> <span class="main">=</span>
      filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">(</span>take <span class="main">(</span>length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>
    "</span></span>

    <span class="keyword1"><span class="command">have</span></span> filter_map_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prod_beta' fst_conv o_apply<span class="main">)</span>

    <span class="comment1">(* check if defined correctly *)</span>
    <span class="keyword1"><span class="command">have</span></span> data_in'_aux_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">data_in'_aux</span> <span class="main">=</span> linearize <span class="skolem">data_in'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> in_eqs<span class="main">(</span>1<span class="main">)</span> auxlist_eqs<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> data_in'_aux_def data_in'_eq
      <span class="keyword1"><span class="command">using</span></span> filter_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="main">(</span>length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_map_simp<span class="main">)</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">lin_data_in''_aux_mv</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_aux_mv</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">move</span><span class="main">::</span><span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> option list set <span class="main">×</span> <span class="tfree">'a</span> option list set<span class="main">)</span> list<span class="main">.</span>
      <span class="skolem">data_in'_aux</span> <span class="main">@</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">move</span>
    <span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> data_in''_aux_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">move</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="bound">move</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">lin_data_in''_mv</span> <span class="bound">move</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> data_in'_aux_eq
      <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_aux_mv_def lin_data_in''_mv_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">init_tuple</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">init_tuple</span> <span class="main">=</span> <span class="main">(</span><span class="free">tuple_since_hist</span><span class="main">,</span> <span class="free">hist_sat</span><span class="main">,</span> <span class="free">idx_mid</span><span class="main">,</span> <span class="free">since_sat</span><span class="main">)</span>"</span></span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">get_idx_move</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> option list<span class="main">,</span> nat<span class="main">)</span> mapping <span class="main">×</span> <span class="tfree">'a</span> option list set <span class="main">×</span> nat <span class="main">×</span> <span class="tfree">'a</span> option list set<span class="main">)</span> <span class="main">⇒</span> nat"</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">get_idx_move</span> <span class="main">=</span> fst <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd"</span></span>

    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> tuple_init_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="free">tuple_since_hist</span> <span class="bound">as</span> <span class="keyword1">of</span>
      Some <span class="bound">idx</span> <span class="main">⇒</span> tuple_since_tp <span class="free">args</span> <span class="bound">as</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="free">idx_oldest</span> <span class="free">idx_mid</span> <span class="bound">idx</span>
      <span class="main">|</span> None   <span class="main">⇒</span> <span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span>tuple_since_tp <span class="free">args</span> <span class="bound">as</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="free">idx_oldest</span> <span class="free">idx_mid</span> <span class="bound">idx</span><span class="main">)</span>
    <span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="comment1">(* map (λ (t, l, r). (t, r)) (auxlist_data_in args mt auxlist) = (linearize data_in)*)</span>


    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> in_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">r</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> in_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">r</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">r</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> in_eq
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="free">hist_sat</span> <span class="main">⟷</span>
        <span class="main">(</span><span class="main">¬</span>is_empty <span class="free">data_in</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>
          <span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="bound">r</span>
      <span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> tuple_init_props_hist_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="free">hist_sat</span> <span class="main">⟷</span>
      <span class="main">(</span><span class="main">¬</span>is_empty <span class="free">data_in</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>
        <span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="bound">r</span>
    <span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> tuple_init_props_since<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="free">since_sat</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">(</span><span class="bound">tuple</span> <span class="main">∈</span> <span class="free">hist_sat</span><span class="main">)</span> <span class="main">∨</span> tuple_since_lhs <span class="bound">tuple</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>
      <span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> tuple_since_lhs <span class="bound">tuple</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="bound">tuple</span> <span class="main">∈</span> <span class="free">since_sat</span>
      <span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> valid_mmtaux.simps
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    
    <span class="keyword1"><span class="command">have</span></span> mv_data_in''<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in''</span> <span class="main">=</span> <span class="skolem">lin_data_in''_mv</span> <span class="skolem">move</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> data_in''_def fold_append_queue_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">move'</span></span> <span class="quoted"><span class="skolem">data_in'</span></span><span class="main">]</span> move'_def
      <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_mv_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> mv_idx_oldest'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">idx_oldest'</span> <span class="main">=</span> <span class="skolem">idx_oldest_mv</span> <span class="skolem">move</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> idx_oldest'_eq
      <span class="keyword1"><span class="command">unfolding</span></span> idx_oldest_mv_def drop_prev_len_def move'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> mv_idx_mid'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">idx_mid'</span> <span class="main">=</span> <span class="skolem">idx_mid_mv</span> <span class="skolem">move</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> idx_mid_mv_def idx_mid'_def init_tuple_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">move</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="skolem">move</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="skolem">move</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> data_in''_len'
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="skolem">move</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t'</span><span class="main">∈</span>fst <span class="main">`</span> set <span class="skolem">move</span><span class="main">.</span> <span class="bound">t</span> <span class="main">&lt;</span> <span class="bound">t'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> move_filter
      <span class="keyword1"><span class="command">using</span></span> data_sorted<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_filter<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">move</span><span class="main">.</span> table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="bound">l</span> <span class="main">∧</span> table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">r</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>relL<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>relR<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> move_filter table_def relL_def relR_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"
    <span class="comment1">― ‹historically›</span>
    <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="skolem">move</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="skolem">as</span> <span class="keyword1">of</span>
      Some <span class="bound">idx</span> <span class="main">⇒</span> tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">move</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="skolem">move</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="skolem">move</span><span class="main">)</span> <span class="bound">idx</span>
      <span class="main">|</span> None   <span class="main">⇒</span> <span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span>tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">move</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="skolem">move</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="skolem">move</span><span class="main">)</span> <span class="bound">idx</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">hist_sat_mv</span> <span class="skolem">move</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="main">⟷</span>
      <span class="main">(</span><span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">move</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>
        <span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">move</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span>
    <span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
     <span class="comment1">― ‹since›</span>
    <span class="main">(</span><span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">since_sat_mv</span> <span class="skolem">move</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="main">⟶</span>        
      <span class="main">(</span><span class="main">(</span><span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">hist_sat_mv</span> <span class="skolem">move</span> <span class="skolem">init_tuple</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> tuple_since_lhs <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">move</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="skolem">move</span><span class="main">)</span><span class="main">)</span>
    <span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>tuple_since_lhs <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">move</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="skolem">move</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">since_sat_mv</span> <span class="skolem">move</span> <span class="skolem">init_tuple</span><span class="main">)</span>
    <span class="main">)</span> <span class="main">∧</span>
    <span class="comment1">― ‹other required properties›</span>
    <span class="skolem">get_idx_move</span> <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="skolem">move</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="skolem">move</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="main">(</span>fst <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="skolem">move</span> <span class="skolem">init_tuple</span><span class="main">)</span><span class="main">)</span> <span class="skolem">as</span> <span class="keyword1">of</span> Some <span class="bound">idx</span> <span class="main">⇒</span> <span class="bound">idx</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="skolem">move</span><span class="main">)</span> <span class="main">|</span> None <span class="main">⇒</span> True<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">move</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lin_data_in''_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_mv_def data_in'_def
        <span class="keyword1"><span class="command">using</span></span> takedropWhile_queue_fst<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">data_in</span></span><span class="main">]</span>
              dropWhile_queue_rep<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">data_in</span></span><span class="main">]</span>
              data_sorted<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span> sorted_filter_dropWhile_memR<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in</span>"</span></span> <span class="quoted"><span class="free">args</span></span> <span class="quoted"><span class="free">nt</span></span><span class="main">]</span>
              drop_filter_memR<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">nt</span></span> <span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> idx_oldest'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx_oldest_mv</span> <span class="main">[]</span> <span class="main">=</span> <span class="free">idx_oldest</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> idx_oldest_mv_def
        <span class="keyword1"><span class="command">using</span></span> Nil
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> idx_mid'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx_mid_mv</span> <span class="main">[]</span> <span class="main">=</span> <span class="free">idx_mid</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> idx_mid_mv_def
        <span class="keyword1"><span class="command">using</span></span> Nil
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
      
      <span class="keyword1"><span class="command">have</span></span> tuple_since_hist'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="main">[]</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="main">=</span> fst <span class="skolem">init_tuple</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Nil
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">[]</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="skolem">as</span> <span class="keyword1">of</span>
        Some <span class="bound">idx</span> <span class="main">⇒</span> tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">idx</span>
        <span class="main">|</span> None   <span class="main">⇒</span> <span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span>tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">idx</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">[]</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_since_hist_mv</span> <span class="main">[]</span> <span class="skolem">init_tuple</span> <span class="main">=</span> Mapping.empty"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True
          <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_hist_mv_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">[]</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="skolem">as</span> <span class="main">=</span> None"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping.empty_def Mapping.lookup.abs_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span>tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">idx</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True Nil
          <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">idx_move</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx_move</span> <span class="main">=</span> <span class="skolem">get_idx_move</span> <span class="skolem">init_tuple</span>"</span></span>
        <span class="keyword3"><span class="command">case</span></span> non_empty<span class="main">:</span> False
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> Mapping.lookup <span class="main">(</span>fst <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="main">[]</span> <span class="skolem">init_tuple</span><span class="main">)</span><span class="main">)</span> <span class="skolem">as</span> <span class="keyword1">of</span>
            None     <span class="main">⇒</span> <span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span> tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">idx</span>
          <span class="main">|</span> Some <span class="bound">idx</span> <span class="main">⇒</span> tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">idx</span>
        "</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>fst <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="main">[]</span> <span class="skolem">init_tuple</span><span class="main">)</span><span class="main">)</span> <span class="skolem">as</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> None
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tuple_since_tp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span>tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="free">idx_oldest</span> <span class="free">idx_mid</span> <span class="bound">idx</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> tuple_since_hist'_eq Nil idx_mid'_eq tuple_init_props
            <span class="keyword1"><span class="command">unfolding</span></span> idx_move_def get_idx_move_def init_tuple_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> option.case_eq_if<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> idx_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">idx</span></span><span class="main">&lt;</span><span class="free">idx_mid</span><span class="main">.</span> <span class="main">(</span>
              linearize <span class="free">data_in</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span>
              <span class="main">¬</span><span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="main">(</span><span class="bound">idx</span><span class="main">-</span><span class="free">idx_oldest</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
                <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span>
              <span class="main">)</span> <span class="main">∨</span>
              <span class="main">¬</span><span class="main">(</span><span class="bound">idx</span> <span class="main">&gt;</span> <span class="free">idx_oldest</span> <span class="main">⟶</span> <span class="skolem">as</span> <span class="main">∉</span> <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">!</span><span class="main">(</span><span class="bound">idx</span><span class="main">-</span><span class="free">idx_oldest</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> idx_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">idx</span></span><span class="main">&lt;</span><span class="free">idx_mid</span><span class="main">.</span> <span class="main">(</span>
              <span class="main">¬</span><span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="main">(</span><span class="bound">idx</span><span class="main">-</span><span class="free">idx_oldest</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
                <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span>
              <span class="main">)</span> <span class="main">∨</span>
              <span class="main">¬</span><span class="main">(</span><span class="bound">idx</span> <span class="main">&gt;</span> <span class="free">idx_oldest</span> <span class="main">⟶</span> <span class="skolem">as</span> <span class="main">∉</span> <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">!</span><span class="main">(</span><span class="bound">idx</span><span class="main">-</span><span class="free">idx_oldest</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> idx_props
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∉</span> snd <span class="main">(</span>last <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> no_hist_last_not_sat<span class="main">[</span><span class="operator">OF</span> data_in_len tuple_since_tp assm<span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="skolem">as</span> <span class="main">∉</span> snd <span class="main">(</span>last <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span>last <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">=</span> last <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> lin_data_in''_eq
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> last_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="skolem">as</span> <span class="main">∉</span> snd <span class="main">(</span>last <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">idx</span>
            <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">idx</span> <span class="main">&gt;</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">as</span> <span class="main">∉</span> <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">!</span><span class="main">(</span><span class="skolem">idx</span><span class="main">-</span><span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> Nil
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_is_0_eq leI length_greater_0_conv less_diff_conv2 nat_less_le<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span><span class="main">-</span><span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> drop_eq_Nil last_drop last_in_set leD<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∉</span> snd <span class="main">(</span>last <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> assm<span class="main">(</span>1<span class="main">)</span> last_props
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">db</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span><span class="main">-</span><span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∉</span> snd <span class="bound">db</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span>tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="bound">idx</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> None <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">idx</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="free">idx_oldest</span> <span class="free">idx_mid</span> <span class="skolem">idx</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> tuple_since_hist'_eq Nil idx_mid'_eq tuple_init_props
            <span class="keyword1"><span class="command">unfolding</span></span> init_tuple_def
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> option.case_eq_if<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.sel option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> idx_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&lt;</span> <span class="free">idx_mid</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span><span class="main">-</span><span class="free">idx_oldest</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
                <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span>
              <span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">idx</span> <span class="main">&gt;</span> <span class="free">idx_oldest</span> <span class="main">⟶</span> <span class="skolem">as</span> <span class="main">∉</span> <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">!</span><span class="main">(</span><span class="skolem">idx</span><span class="main">-</span><span class="free">idx_oldest</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> idx_mid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> idx_mid'_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">db</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span><span class="main">-</span><span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∉</span> snd <span class="bound">db</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">db</span></span> <span class="keyword2"><span class="keyword">where</span></span> db_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="free">idx_oldest</span> <span class="main">-</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">r</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∉</span> snd <span class="skolem">db</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> idx_oldest'_eq lin_data_in''_eq
              <span class="keyword1"><span class="command">unfolding</span></span> r_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="free">idx_oldest</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> drop_list_shift in_set_dropD leI less_imp_le_nat<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> idx_props<span class="main">(</span>3<span class="main">)</span> db_props<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span><span class="main">-</span><span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&gt;</span> <span class="skolem">idx_oldest_mv</span> <span class="main">[]</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> idx_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&gt;</span> <span class="free">idx_oldest</span> <span class="main">+</span> <span class="skolem">r</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> idx_oldest'_eq
              <span class="keyword1"><span class="command">unfolding</span></span> r_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">!</span><span class="main">(</span><span class="skolem">idx</span><span class="main">-</span><span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> linearize <span class="free">data_in</span><span class="main">!</span><span class="main">(</span><span class="skolem">idx</span><span class="main">-</span><span class="free">idx_oldest</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> idx_oldest'_eq lin_data_in''_eq
              <span class="keyword1"><span class="command">unfolding</span></span> r_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∉</span> <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">!</span><span class="main">(</span><span class="skolem">idx</span><span class="main">-</span><span class="free">idx_oldest</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> idx_props<span class="main">(</span>4<span class="main">)</span> idx_g
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∉</span> <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">!</span><span class="main">(</span><span class="skolem">idx</span><span class="main">-</span><span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="skolem">idx</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> idx_mid non_empty Nil
            <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_since_hist_mv</span> <span class="main">[]</span> <span class="skolem">init_tuple</span> <span class="main">=</span> fst <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="main">[]</span> <span class="skolem">init_tuple</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> non_empty
          <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_hist_mv_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> hist_sat_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">hist_sat_mv</span> <span class="main">[]</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="main">⟷</span>
        <span class="main">(</span><span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>
          <span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span>
        <span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">hist_sat_mv</span> <span class="main">[]</span> <span class="skolem">init_tuple</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> hist_sat_mv_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">db</span></span> <span class="skolem"><span class="skolem">dbs</span></span> <span class="keyword2"><span class="keyword">where</span></span> db_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span> <span class="main">=</span> <span class="skolem">db</span> <span class="main">#</span> <span class="skolem">dbs</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> list.exhaust
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">r</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> list_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_mv_def data_in'_eq
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="main">[]</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="main">=</span> <span class="free">hist_sat</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> init_tuple_def 
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_since_hist_mv</span> <span class="main">[]</span> <span class="skolem">init_tuple</span> <span class="main">=</span> <span class="free">tuple_since_hist</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> non_empty Nil<span class="main">(</span>1<span class="main">)</span>
                <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_hist_mv_def init_tuple_def 
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="free">hist_sat</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> snd <span class="skolem">db</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">tuple_since_hist</span> <span class="bound">as</span> <span class="keyword1">of</span> Some <span class="bound">idx</span> <span class="main">⇒</span> <span class="bound">idx</span> <span class="main">≤</span> <span class="skolem">idx_oldest_mv</span> <span class="main">[]</span> <span class="main">|</span> None <span class="main">⇒</span> False<span class="main">}</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> assm db_props
                <span class="keyword1"><span class="command">unfolding</span></span> hist_sat_mv_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="free">hist_sat</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tuple_init_props_hist_sat <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> list_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">}</span></span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> snd <span class="skolem">db</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">tuple_since_hist</span> <span class="bound">as</span> <span class="keyword1">of</span> Some <span class="bound">idx</span> <span class="main">⇒</span> <span class="bound">idx</span> <span class="main">≤</span> <span class="skolem">idx_oldest_mv</span> <span class="main">[]</span> <span class="main">|</span> None <span class="main">⇒</span> False<span class="main">}</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> snd <span class="skolem">db</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="free">tuple_since_hist</span> <span class="skolem">as</span> <span class="keyword1">of</span> Some <span class="bound">idx</span> <span class="main">⇒</span> <span class="bound">idx</span> <span class="main">≤</span> <span class="skolem">idx_oldest_mv</span> <span class="main">[]</span> <span class="main">|</span> None <span class="main">⇒</span> False<span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">idx</span></span> <span class="keyword2"><span class="keyword">where</span></span> idx_props<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_since_hist</span> <span class="skolem">as</span> <span class="main">=</span> Some <span class="skolem">idx</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">≤</span> <span class="skolem">idx_oldest_mv</span> <span class="main">[]</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> case_optionE
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="free">idx_oldest</span> <span class="free">idx_mid</span> <span class="skolem">idx</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> tuple_init_props
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="free">idx_oldest</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">[]</span> <span class="main">-</span> <span class="free">idx_oldest</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> idx_props<span class="main">(</span>2<span class="main">)</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> diff_le_mono set_drop_subset_set_drop subsetD<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> data_sorted<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span> drop_filter_memR<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in</span>"</span></span> <span class="quoted"><span class="quoted">"args_ivl <span class="free">args</span>"</span></span> <span class="quoted"><span class="free">nt</span></span><span class="main">]</span>
                  <span class="keyword1"><span class="command">unfolding</span></span> idx_oldest_mv_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> list_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">}</span></span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>
            <span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span>
          <span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> non_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span>
            <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span>"</span></span> 
            <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">db</span></span> <span class="skolem"><span class="skolem">dbs</span></span> <span class="keyword2"><span class="keyword">where</span></span> db_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span> <span class="main">=</span> <span class="skolem">db</span> <span class="main">#</span> <span class="skolem">dbs</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> list.exhaust
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> db_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> db_props in_set_dropD lin_data_in''_eq list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> db_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">db</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> db_props
            <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_mv_def data_in'_eq
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> append_Nil2 filter.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> mem_Collect_eq set_filter<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> assm<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> all_relR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_mv_def data_in'_eq
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">have</span></span> db_relR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> snd <span class="skolem">db</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> db_props assm<span class="main">(</span>2<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">have</span></span> in_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assm<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_mv_def data_in'_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">in_but_last</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">in_but_last</span> <span class="main">=</span> <span class="main">(</span>take <span class="main">(</span>length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>

          <span class="keyword1"><span class="command">have</span></span> l_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
               <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">l</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assm data_sorted<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span> drop_filter_memR<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in</span>"</span></span> <span class="quoted"><span class="quoted">"args_ivl <span class="free">args</span>"</span></span> <span class="quoted"><span class="free">nt</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_mv_def data_in'_eq l_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> last_l_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">l</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> l_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> drop_eq_Nil last_drop last_in_set leI<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> last_relR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> snd <span class="main">(</span>last <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> l_props<span class="main">(</span>2<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> data_in_split<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in</span> <span class="main">=</span> <span class="skolem">in_but_last</span> <span class="main">@</span> <span class="main">[</span>last <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">]</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> in_nonempty
                  drop_last<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in</span>"</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">unfolding</span></span> in_but_last_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_butlast_last_id butlast_conv_take<span class="main">)</span>

          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> assm_all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">in_but_last</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> assm_all l_props<span class="main">(</span>2<span class="main">)</span> data_in_split last_l_mem
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> list_appendE set_ConsD<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="free">hist_sat</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tuple_init_props_hist_sat in_nonempty is_empty_alt
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∉</span> snd <span class="main">(</span><span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
            <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Max <span class="skolem">A</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">in_but_last</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∉</span> <span class="bound">r</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∉</span> snd <span class="main">(</span><span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> in_but_last_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prodE diff_le_self imageE nth_image snd_conv<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> A_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> j_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∉</span> snd <span class="main">(</span><span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">!</span><span class="skolem">j</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> A_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">idx_oldest</span> <span class="main">+</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">idx_mid</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> data_in_len
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&gt;</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_geq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">=</span> takeWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> data_sorted<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span> sorted_filter_takeWhile_not_memR<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in</span>"</span></span> <span class="quoted"><span class="free">args</span></span> <span class="quoted"><span class="free">nt</span></span><span class="main">]</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in</span> <span class="main">=</span> <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>dropWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">!</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>dropWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">!</span><span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> j_props<span class="main">(</span>1<span class="main">)</span> idx_append_snd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dropWhile <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> jth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">!</span><span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">!</span><span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> data_sorted<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span> sorted_filter_dropWhile_memR<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in</span>"</span></span> <span class="quoted"><span class="free">args</span></span> <span class="quoted"><span class="free">nt</span></span><span class="main">]</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> j_geq j_props<span class="main">(</span>1<span class="main">)</span> sum_length_filter_compl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span><span class="main">]</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_simp<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">!</span><span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> nth_set_member<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span><span class="main">]</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> snd <span class="main">(</span><span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">!</span><span class="skolem">j</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> jth all_relR
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> j_props<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_suc_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> not_le_imp_less
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">y</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="main">(</span><span class="main">(</span><span class="free">idx_oldest</span> <span class="main">+</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="free">idx_oldest</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="main">(</span><span class="main">(</span><span class="free">idx_oldest</span> <span class="main">+</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="free">idx_oldest</span><span class="main">)</span> <span class="main">(</span><span class="skolem">in_but_last</span> <span class="main">@</span> <span class="main">[</span>last <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> data_in_split
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">y</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="main">(</span><span class="main">(</span><span class="free">idx_oldest</span> <span class="main">+</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="free">idx_oldest</span><span class="main">)</span> <span class="skolem">in_but_last</span><span class="main">)</span>"</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">case</span></span> True
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> k'_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">in_but_last</span> <span class="main">-</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>drop <span class="main">(</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="skolem">in_but_last</span><span class="main">)</span><span class="main">!</span><span class="skolem">k'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> One_nat_def add.right_neutral add_Suc_right atLeastLessThan_iff diff_add_inverse diff_diff_left in_set_conv_nth leI length_drop not_less_zero<span class="main">)</span>
                
                <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="skolem">k'</span> <span class="main">+</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">in_but_last</span><span class="main">!</span><span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="skolem">in_but_last</span><span class="main">}</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> k'_props j_props<span class="main">(</span>1<span class="main">)</span>
                  <span class="keyword1"><span class="command">unfolding</span></span> k_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">!</span><span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span><span class="main">+</span><span class="main">1</span><span class="main">..&lt;</span>length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span>"</span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> in_but_last_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">{</span></span>
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∉</span> <span class="skolem">y</span>"</span></span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> k_props <span class="keyword1"><span class="command">unfolding</span></span> A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_props <span class="keyword1"><span class="command">unfolding</span></span> j_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> k_props<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">}</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">case</span></span> False
                <span class="keyword1"><span class="command">{</span></span>
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">≠</span> last <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>drop <span class="main">(</span><span class="main">(</span><span class="free">idx_oldest</span> <span class="main">+</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="free">idx_oldest</span><span class="main">)</span> <span class="main">(</span><span class="skolem">in_but_last</span> <span class="main">@</span> <span class="main">[</span>last <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> False
                    <span class="keyword1"><span class="command">using</span></span> in_set_dropD
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> assm
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">}</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> last <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                  <span class="keyword1"><span class="command">using</span></span> last_relR
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> snd_conv<span class="main">)</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> all_relR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="main">(</span><span class="main">(</span><span class="free">idx_oldest</span> <span class="main">+</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="free">idx_oldest</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∉</span> snd <span class="main">(</span>linearize <span class="free">data_in</span> <span class="main">!</span> <span class="main">(</span><span class="main">(</span><span class="free">idx_oldest</span> <span class="main">+</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="free">idx_oldest</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> j_props<span class="main">(</span>2<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> tp<span class="main">:</span> <span class="quoted"><span class="quoted">"tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="free">idx_oldest</span> <span class="free">idx_mid</span> <span class="main">(</span><span class="free">idx_oldest</span> <span class="main">+</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> in_nonempty j_l
              <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">idx</span></span> <span class="keyword2"><span class="keyword">where</span></span> idx_props<span class="main">:</span>
              <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_since_hist</span> <span class="skolem">as</span> <span class="main">=</span> Some <span class="skolem">idx</span>"</span></span>
              <span class="quoted"><span class="quoted">"tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="free">idx_oldest</span> <span class="free">idx_mid</span> <span class="skolem">idx</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> tuple_init_props
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">=</span> <span class="main">(</span><span class="free">idx_oldest</span> <span class="main">+</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> tuple_since_hist_lookup_eq<span class="main">[</span><span class="operator">OF</span> tuple_init_props tp _ data_in_len<span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>                              
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">idx_oldest</span> <span class="main">+</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="skolem">idx_oldest_mv</span> <span class="main">[]</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> j_suc_leq
              <span class="keyword1"><span class="command">unfolding</span></span> idx_oldest_mv_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> snd <span class="skolem">db</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">tuple_since_hist</span> <span class="bound">as</span> <span class="keyword1">of</span> Some <span class="bound">idx</span> <span class="main">⇒</span> <span class="bound">idx</span> <span class="main">≤</span> <span class="skolem">idx_oldest_mv</span> <span class="main">[]</span> <span class="main">|</span> None <span class="main">⇒</span> False<span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> db_relR idx_props<span class="main">(</span>1<span class="main">)</span>
              <span class="keyword1"><span class="command">unfolding</span></span> idx_oldest_mv_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>

          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="free">hist_sat</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> snd <span class="skolem">db</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">tuple_since_hist</span> <span class="bound">as</span> <span class="keyword1">of</span> Some <span class="bound">idx</span> <span class="main">⇒</span> <span class="bound">idx</span> <span class="main">≤</span> <span class="skolem">idx_oldest_mv</span> <span class="main">[]</span> <span class="main">|</span> None <span class="main">⇒</span> False<span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">hist_sat_mv</span> <span class="main">[]</span> <span class="skolem">init_tuple</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assm<span class="main">(</span>1<span class="main">)</span> db_props Nil<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span> hist_sat_mv_def init_tuple_def tuple_since_hist_mv_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">since_sat_mv</span> <span class="main">[]</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">(</span><span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">hist_sat_mv</span> <span class="main">[]</span> <span class="skolem">init_tuple</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> tuple_since_lhs <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>
      <span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">since_sat_mv</span> <span class="main">[]</span> <span class="skolem">init_tuple</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> since_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx_mid_mv</span> <span class="main">[]</span> <span class="main">≠</span> <span class="skolem">idx_oldest_mv</span> <span class="main">[]</span>"</span></span>
                    <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="free">since_sat</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> since_sat_mv_def init_tuple_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> mv_ln_eq
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_cancel_left_left list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

          <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> in_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> auxlist_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="free">auxlist</span><span class="main">.</span> time <span class="bound">db</span> <span class="main">≤</span> <span class="free">mt</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> time <span class="bound">db</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> in_memR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">db</span><span class="main">∈</span>set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> time <span class="bound">db</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="free">hist_sat</span> <span class="main">∨</span> tuple_since_lhs <span class="skolem">as</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> since_mem tuple_init_props_since<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="free">hist_sat</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> tuple_init_props_hist_sat
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_mv_def data_in'_eq
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">hist_sat_mv</span> <span class="main">[]</span> <span class="skolem">init_tuple</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> non_empty hist_sat_props
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"tuple_since_lhs <span class="skolem">as</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n_props<span class="main">:</span>
              <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">}</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">suffix</span> <span class="main">=</span> drop <span class="skolem">n</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="bound">suffix</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="bound">suffix</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"linearize <span class="free">data_in</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_lhs_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> n_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> auxlist_eqs<span class="main">(</span>2<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeastLessThan_iff in_eq length_map<span class="main">)</span>
            <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">suffix</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">suffix</span> <span class="main">=</span> drop <span class="skolem">n</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
            
            <span class="keyword1"><span class="command">have</span></span> sorted_auxlist<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="free">auxlist</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sorted_in<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> suffix_def auxlist_data_in_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> sorted_filter<span class="main">)</span>


            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> suffix_props<span class="main">:</span>
              <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">suffix</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="skolem">suffix</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="skolem">suffix</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> n_props n_l
              <span class="keyword1"><span class="command">unfolding</span></span> suffix_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> hd_suffix<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">suffix</span> <span class="main">=</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">!</span><span class="skolem">n</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> suffix_props<span class="main">(</span>3<span class="main">)</span>
              <span class="keyword1"><span class="command">unfolding</span></span> suffix_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_drop_conv_nth<span class="main">)</span>

            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> relL<span class="main">:</span> <span class="quoted"><span class="quoted">"join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span><span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_aux_mv</span> <span class="main">[]</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> auxlist_eqs<span class="main">(</span>2<span class="main">)</span>
                <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_aux_mv_def data_in'_aux_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lin_data_in''_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_aux_mv</span> <span class="main">[]</span> <span class="main">=</span> drop <span class="skolem">l</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> drop_filter_memR<span class="main">[</span><span class="operator">OF</span> sorted_in<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"args_ivl <span class="free">args</span>"</span></span> <span class="quoted"><span class="free">nt</span></span><span class="main">]</span>
                <span class="keyword1"><span class="command">unfolding</span></span> l_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

              <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">-</span> <span class="skolem">l</span>"</span></span>
              <span class="keyword1"><span class="command">{</span></span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&gt;</span> <span class="skolem">n</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="skolem">l</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> n_l n_props<span class="main">(</span>1<span class="main">)</span> 
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeastLessThan_iff image_eqI nat_le_linear nth_image take_all<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> take_filter_not_memR<span class="main">[</span><span class="operator">OF</span> sorted_in<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"args_ivl <span class="free">args</span>"</span></span> <span class="quoted"><span class="free">nt</span></span><span class="main">]</span>
                  <span class="keyword1"><span class="command">unfolding</span></span> l_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> assm
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">}</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_le_imp_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">n</span><span class="main">-</span><span class="skolem">l</span><span class="main">)</span> <span class="main">(</span>drop <span class="skolem">l</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> suffix_props<span class="main">(</span>1<span class="main">)</span> n_l
                <span class="keyword1"><span class="command">unfolding</span></span> suffix_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">n</span><span class="main">-</span><span class="skolem">l</span><span class="main">)</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> lin_data_in''_eq
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="main">(</span>drop <span class="main">(</span><span class="skolem">n</span><span class="main">-</span><span class="skolem">l</span><span class="main">)</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> lin_data_in''_eq l_leq suffix_props<span class="main">(</span>2<span class="main">)</span>
                <span class="keyword1"><span class="command">unfolding</span></span> suffix_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>
                <span class="keyword1">let</span> <span class="bound">suffix</span> <span class="main">=</span> drop <span class="skolem">n'</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">[]</span><span class="main">)</span>
                <span class="keyword1">in</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="bound">suffix</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="bound">suffix</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">as</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Let_def n'_def<span class="main">)</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">}</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> n'_def
                <span class="keyword1"><span class="command">using</span></span> n_l lin_data_in''_eq l_leq data_in''_aux_eq
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> atLeastLessThan_iff diff_less_mono length_drop length_map zero_le<span class="main">)</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_since_lhs <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> non_empty
                <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_lhs_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">{</span></span>
                <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">r</span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> data_in_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_mv_def data_in'_eq
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> memR<span class="main">:</span> <span class="quoted"><span class="quoted">"memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

                <span class="keyword1"><span class="command">have</span></span> filter_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> in_eq filter_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span><span class="main">]</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_simp<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> data_in_mem
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> tlr_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> nt_mono<span class="main">(</span>1<span class="main">)</span> time
                  <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> tlr_mem
                  <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_props<span class="main">:</span>
                  <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length<span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">}</span>"</span></span>
                  <span class="quoted"><span class="quoted">"<span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> atLeastLessThan_iff nth_the_index the_index_bounded zero_le<span class="main">)</span>
                <span class="keyword1"><span class="command">{</span></span>
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> fst <span class="main">(</span><span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> i_props<span class="main">(</span>2<span class="main">)</span> sorted_in n_l
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> fst_conv le_less_trans length_map nth_map sorted_iff_nth_mono<span class="main">)</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">!</span><span class="skolem">n</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> memR memR_antimono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"args_ivl <span class="free">args</span>"</span></span><span class="main">]</span>
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> assm <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">}</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_le_imp_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">suffix</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> i_props
                  <span class="keyword1"><span class="command">unfolding</span></span> suffix_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeastLessThan_iff in_set_conv_nth le_add_diff_inverse length_drop less_imp_le_nat n_l nat_add_left_cancel_less nth_drop<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> suffix_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">}</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">hist_sat_mv</span> <span class="main">[]</span> <span class="skolem">init_tuple</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> non_empty hist_sat_props
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>

            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">hist_sat_mv</span> <span class="main">[]</span> <span class="skolem">init_tuple</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> tuple_since_lhs <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">hist_sat_mv</span> <span class="main">[]</span> <span class="skolem">init_tuple</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> tuple_since_lhs <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>tuple_since_lhs <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">since_sat_mv</span> <span class="main">[]</span> <span class="skolem">init_tuple</span><span class="main">)</span>
      <span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"tuple_since_lhs <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_lhs_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          
          <span class="keyword1"><span class="command">have</span></span> sorted_auxlist<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="free">auxlist</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sorted_in<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> sorted_filter<span class="main">)</span>

          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_aux_mv</span> <span class="main">[]</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> auxlist_eqs<span class="main">(</span>2<span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_aux_mv_def data_in'_aux_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lin_data_in''_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_aux_mv</span> <span class="main">[]</span> <span class="main">=</span> drop <span class="skolem">l</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> drop_filter_memR<span class="main">[</span><span class="operator">OF</span> sorted_in<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"args_ivl <span class="free">args</span>"</span></span> <span class="quoted"><span class="free">nt</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">unfolding</span></span> l_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n_props<span class="main">:</span>
            <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">[]</span><span class="main">)</span><span class="main">}</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">suffix</span> <span class="main">=</span> drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">[]</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="bound">suffix</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="bound">suffix</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assm
            <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_lhs_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">suffix</span> <span class="main">=</span> drop <span class="main">(</span><span class="skolem">l</span><span class="main">+</span><span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span>
            <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="bound">suffix</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span>
            join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="bound">suffix</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">as</span><span class="main">)</span>
          <span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>

          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">+</span> <span class="skolem">n</span> <span class="main">&lt;</span> length <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> n_props data_in''_aux_eq lin_data_in''_eq in_eq
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> add.commute atLeastLessThan_iff drop_drop length_drop length_map zero_less_diff<span class="main">)</span>

          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_since_lhs <span class="skolem">as</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> non_empty
            <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_lhs_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="free">since_sat</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> tuple_init_props_since<span class="main">(</span>2<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">since_sat_mv</span> <span class="main">[]</span> <span class="skolem">init_tuple</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> mv_ln_eq non_empty
            <span class="keyword1"><span class="command">unfolding</span></span> since_sat_mv_def init_tuple_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> List.fold_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> add_cancel_left_left comp_apply length_0_conv snd_conv<span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">get_idx_move</span> <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="main">[]</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">idx_mid_mv</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> get_idx_move_def init_tuple_def idx_mid_mv_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="main">(</span>fst <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="main">[]</span> <span class="skolem">init_tuple</span><span class="main">)</span><span class="main">)</span> <span class="skolem">as</span> <span class="keyword1">of</span> Some <span class="bound">idx</span> <span class="main">⇒</span> <span class="bound">idx</span> <span class="main">&lt;</span> <span class="skolem">idx_mid_mv</span> <span class="main">[]</span> <span class="main">|</span> None <span class="main">⇒</span> True<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="main">[]</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="main">=</span> <span class="free">tuple_since_hist</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> init_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx_mid_mv</span> <span class="main">[]</span> <span class="main">=</span> <span class="free">idx_mid</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> idx_mid_mv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="free">tuple_since_hist</span> <span class="skolem">as</span> <span class="keyword1">of</span> Some <span class="bound">idx</span> <span class="main">⇒</span> <span class="bound">idx</span> <span class="main">&lt;</span> <span class="free">idx_mid</span> <span class="main">|</span> None <span class="main">⇒</span> True<span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> tuple_init_props
          <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> assm<span class="main">:</span>
        <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> snoc
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> r_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≤</span> length <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> r_def
        <span class="keyword1"><span class="command">using</span></span> length_filter_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> r'_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">≤</span> length <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> r'_def
        <span class="keyword1"><span class="command">using</span></span> length_filter_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span> <span class="main">+</span> <span class="free">idx_oldest</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> length <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">idx_mid_mv</span> <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assm<span class="main">(</span>1<span class="main">)</span> r_leq snoc<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_mv_def idx_mid_mv_def idx_oldest_mv_def r_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">r'</span> <span class="main">+</span> <span class="main">(</span><span class="free">idx_oldest</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> length <span class="skolem">xs</span> <span class="main">-</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">idx_mid_mv</span> <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> r'_leq
        <span class="keyword1"><span class="command">unfolding</span></span> idx_mid_mv_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">idx_oldest_mv</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">idx_mid_mv</span> <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> r'_def idx_oldest_mv_def lin_data_in''_mv_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> xs_sorted<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="skolem">xs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_append<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> xs_ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>fst <span class="main">`</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t'</span><span class="main">∈</span>fst <span class="main">`</span> set <span class="skolem">xs</span><span class="main">.</span> <span class="bound">t</span> <span class="main">&lt;</span> <span class="bound">t'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>4<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">.</span> table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="bound">l</span> <span class="main">∧</span> table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">r</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>5<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="skolem">xs</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="skolem">as</span> <span class="keyword1">of</span>
          None   <span class="main">⇒</span> <span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span> tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="bound">idx</span>
        <span class="main">|</span> Some <span class="bound">idx</span> <span class="main">⇒</span> tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="bound">idx</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">get_idx_move</span> <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="skolem">xs</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">idx_mid_mv</span> <span class="skolem">xs</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="main">(</span>fst <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="skolem">xs</span> <span class="skolem">init_tuple</span><span class="main">)</span><span class="main">)</span> <span class="skolem">as</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">idx</span> <span class="main">⇒</span> <span class="bound">idx</span> <span class="main">&lt;</span> <span class="skolem">idx_mid_mv</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">hist_sat_mv</span> <span class="skolem">xs</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="main">⟷</span>
          <span class="main">(</span><span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>
            <span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span>
        <span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">since_sat_mv</span> <span class="skolem">xs</span> <span class="skolem">init_tuple</span> <span class="main">⟶</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">hist_sat_mv</span> <span class="skolem">xs</span> <span class="skolem">init_tuple</span> <span class="main">∨</span> tuple_since_lhs <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span>tuple_since_lhs <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">since_sat_mv</span> <span class="skolem">xs</span> <span class="skolem">init_tuple</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tuple</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">=</span> <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="skolem">xs</span> <span class="skolem">init_tuple</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tuple_since_hist'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_since_hist'</span> <span class="main">=</span> fst <span class="skolem">tuple</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">joined_mapping</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">joined_mapping</span> <span class="main">=</span> Mapping.filter <span class="main">(</span><span class="main">λ</span><span class="bound">as</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> <span class="main">(</span>relR <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tuple_since_hist'</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> fold_IH_since_hist<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="skolem">fold_op_f</span> <span class="skolem">x</span> <span class="skolem">tuple</span><span class="main">)</span> <span class="main">=</span> upd_set <span class="skolem">joined_mapping</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">(</span><span class="skolem">get_idx_move</span> <span class="skolem">tuple</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>relR <span class="skolem">x</span><span class="main">)</span> <span class="main">-</span> Mapping.keys <span class="skolem">joined_mapping</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> fold_op_f_def relR_def relL_def joined_mapping_def get_idx_move_def tuple_since_hist'_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def case_prod_beta'<span class="main">)</span>

      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">hist_sat'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hist_sat'</span> <span class="main">=</span> <span class="main">(</span>fst <span class="keyword1">o</span> snd<span class="main">)</span> <span class="skolem">tuple</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> fold_IH_hist_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">(</span><span class="skolem">fold_op_f</span> <span class="skolem">x</span> <span class="skolem">tuple</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">hist_sat'</span> <span class="main">∩</span> <span class="main">(</span>relR <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> fold_op_f_def relR_def hist_sat'_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def case_prod_beta'<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> x_table<span class="main">:</span>
        <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relR <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>5<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> relL_def relR_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> maskL_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">maskL</span> <span class="main">=</span> join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">since_sat'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">since_sat'</span> <span class="main">=</span> <span class="main">(</span>snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="skolem">tuple</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> fold_IH_since_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">(</span><span class="skolem">fold_op_f</span> <span class="skolem">x</span> <span class="skolem">tuple</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">since_sat'</span> <span class="main">∩</span> <span class="main">(</span>relR <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> proj_tuple_in_join_optim <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relR <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>relL <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> fold_op_f_def relR_def relL_def since_sat'_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def case_prod_beta'<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fold_IH_since_sat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">(</span><span class="skolem">fold_op_f</span> <span class="skolem">x</span> <span class="skolem">tuple</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">since_sat'</span> <span class="main">∩</span> <span class="main">(</span>relR <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="main">(</span>relR <span class="skolem">x</span><span class="main">)</span><span class="main">.</span> proj_tuple_in_join <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="free">maskL</span> <span class="bound">as</span> <span class="main">(</span>relL <span class="skolem">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> proj_tuple_in_join_optim_equiv<span class="main">[</span><span class="operator">OF</span> x_table<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"args_pos <span class="free">args</span>"</span></span><span class="main">]</span> maskL_eq
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">db</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">db</span> <span class="main">≤</span> fst <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>3<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_append<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">db</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> mem memR_antimono
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">db</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">db</span> <span class="main">&lt;</span> fst <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>4<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">db</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> mem memR_antimono
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> mem
          <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_mv_def data_in'_eq
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> non_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> tuple_since_hist_mv_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="skolem">as</span> <span class="keyword1">of</span>
        None    <span class="main">⇒</span> <span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span> tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="bound">idx</span>
       <span class="main">|</span> Some <span class="bound">idx</span> <span class="main">⇒</span> tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="bound">idx</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span> <span class="main">=</span> Mapping.empty"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_hist_mv_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="skolem">as</span> <span class="main">=</span> None"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping.empty_def Mapping.lookup.abs_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span>tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="bound">idx</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True snoc
          <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>

        <span class="keyword3"><span class="command">case</span></span> non_empty<span class="main">:</span> False
        
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span> <span class="main">=</span> fst <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_hist_mv_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span> <span class="main">=</span> fst <span class="main">(</span><span class="skolem">fold_op_f</span> <span class="skolem">x</span> <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> fold_alt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">fold_op_f</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span>"</span></span> <span class="quoted"><span class="skolem">init_tuple</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">unfolding</span></span> tuple_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>              
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mapping_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span> <span class="main">=</span> upd_set <span class="skolem">joined_mapping</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">(</span><span class="skolem">get_idx_move</span> <span class="skolem">tuple</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>relR <span class="skolem">x</span><span class="main">)</span> <span class="main">-</span> Mapping.keys <span class="skolem">joined_mapping</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> fold_IH_since_hist
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        
        <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> mem non_empty snoc<span class="main">(</span>2<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">have</span></span> data_in''_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> mem
          <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_mv_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

        <span class="keyword1"><span class="command">have</span></span> data_in''_last<span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> mem snoc<span class="main">(</span>2<span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_mv_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_le_lessD take_Suc_conv_app_nth<span class="main">)</span>

        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="skolem">as</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> None
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> not_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∉</span> <span class="main">(</span><span class="main">(</span>relR <span class="skolem">x</span><span class="main">)</span> <span class="main">-</span> Mapping.keys <span class="skolem">joined_mapping</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> mapping_eq
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Mapping_lookup_upd_set option.discI<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∉</span> <span class="main">(</span>relR <span class="skolem">x</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">as</span> <span class="main">∈</span> Mapping.keys <span class="skolem">joined_mapping</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="skolem">as</span> <span class="main">=</span> Mapping.lookup <span class="skolem">joined_mapping</span> <span class="skolem">as</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> not_mem mapping_eq
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Mapping_lookup_upd_set<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> not_relR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∉</span> <span class="main">(</span>relR <span class="skolem">x</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> None keys_is_none_rep<span class="main">)</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">idx</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&lt;</span> <span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>2<span class="main">)</span> non_empty
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> add_cancel_left_left diff_is_0_eq dual_order.strict_iff_order last_drop last_in_set leI length_drop length_greater_0_conv less_diff_conv2<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∉</span> snd <span class="main">(</span>last <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> not_relR data_in''_last
              <span class="keyword1"><span class="command">unfolding</span></span> relR_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span> tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="bound">idx</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> None
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">idx</span><span class="main">)</span>

          <span class="keyword1"><span class="command">have</span></span> data_in_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>2<span class="main">)</span> non_empty
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">have</span></span> idx_oldest_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> mem
            <span class="keyword1"><span class="command">unfolding</span></span> idx_oldest_mv_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx_mid_mv</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">idx_oldest_mv</span> <span class="skolem">xs</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH_none<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="skolem">xs</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="skolem">as</span> <span class="main">=</span> None"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_hist_mv_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping.lookup_empty<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span> tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="bound">idx</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> IH_none IH<span class="main">(</span>1<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> mv_ln_eq True
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Ex_list_of_length append_Nil append_eq_append_conv length_append<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> data_in''_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> data_in''_eq
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span>relR <span class="skolem">x</span> <span class="main">-</span> Mapping.keys <span class="skolem">joined_mapping</span><span class="main">)</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> mem<span class="main">:</span> True
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> relR <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> relR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> snd <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> relR_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>

              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="skolem">as</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">get_idx_move</span> <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> mapping_eq mem
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_lookup_upd_set<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> idx_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">=</span> <span class="skolem">idx_mid_mv</span> <span class="skolem">xs</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> Some IH<span class="main">(</span>2<span class="main">)</span>
                <span class="keyword1"><span class="command">unfolding</span></span> get_idx_move_def tuple_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&lt;</span> <span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> idx_mid_mv_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> idx_eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">idx</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> idx_oldest_eq True idx_eq
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> idx_eq' data_in''_eq relR
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">idx</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> data_in_nonempty
                <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> False
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lookup_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="skolem">as</span> <span class="main">=</span> Mapping.lookup <span class="skolem">joined_mapping</span> <span class="skolem">as</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> mapping_eq
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Mapping_lookup_upd_set<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> relR <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> joined_mapping_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Mapping_lookup_filter_Some_P Some<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> relR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> snd <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> relR_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>

              <span class="keyword1"><span class="command">have</span></span> lookup_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="skolem">as</span> <span class="main">=</span> Mapping.lookup <span class="skolem">tuple_since_hist'</span> <span class="skolem">as</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> Mapping_lookup_filter_not_None Some lookup_eq
                <span class="keyword1"><span class="command">unfolding</span></span> joined_mapping_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> idx_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">≤</span> <span class="skolem">idx_mid_mv</span> <span class="skolem">xs</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>3<span class="main">)</span> Some
                <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_hist'_def tuple_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&lt;</span> <span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> idx_mid_mv_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> idx_leq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> idx_oldest_eq True idx_leq
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> idx_leq' data_in''_eq relR
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">idx</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> data_in_nonempty
                <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> IH_nonempty<span class="main">:</span> False
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> idx_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&lt;</span> <span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="main">(</span>relR <span class="skolem">x</span><span class="main">)</span> <span class="main">-</span> Mapping.keys <span class="skolem">joined_mapping</span><span class="main">)</span>"</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">case</span></span> True
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="skolem">as</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">get_idx_move</span> <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> mapping_eq
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_lookup_upd_set<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">=</span> <span class="skolem">get_idx_move</span> <span class="skolem">tuple</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> Some
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">=</span> <span class="skolem">idx_mid_mv</span> <span class="skolem">xs</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>2<span class="main">)</span>
                  <span class="keyword1"><span class="command">unfolding</span></span> tuple_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> idx_mid_mv_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">case</span></span> False
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="skolem">as</span> <span class="main">=</span> Mapping.lookup <span class="skolem">joined_mapping</span> <span class="skolem">as</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> mapping_eq
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Mapping_lookup_upd_set<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="skolem">as</span> <span class="main">=</span> Mapping.lookup <span class="skolem">tuple_since_hist'</span> <span class="skolem">as</span>"</span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> joined_mapping_def
                  <span class="keyword1"><span class="command">using</span></span> Some Mapping_lookup_filter_not_None
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>fst <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="skolem">xs</span> <span class="skolem">init_tuple</span><span class="main">)</span><span class="main">)</span> <span class="skolem">as</span> <span class="main">=</span> Some <span class="skolem">idx</span>"</span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_hist'_def tuple_def
                  <span class="keyword1"><span class="command">using</span></span> Some
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">idx</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>1<span class="main">)</span> IH_nonempty
                  <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_hist_mv_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">≤</span> <span class="skolem">idx_mid_mv</span> <span class="skolem">xs</span>"</span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> idx_mid_mv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">y</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="main">(</span>relR <span class="skolem">x</span><span class="main">)</span> <span class="main">-</span> Mapping.keys <span class="skolem">joined_mapping</span><span class="main">)</span>"</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">case</span></span> True
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="skolem">as</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">get_idx_move</span> <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> mapping_eq
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_lookup_upd_set<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">=</span> <span class="skolem">get_idx_move</span> <span class="skolem">tuple</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> Some
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>2<span class="main">)</span>
                  <span class="keyword1"><span class="command">unfolding</span></span> tuple_def idx_mid_mv_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>2<span class="main">)</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> data_in''_last drop_last<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">]</span> data_in_nonempty
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> data_in''_eq<span class="main">)</span>
                <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span>relR <span class="skolem">x</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> True
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> relR_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">case</span></span> not_mem<span class="main">:</span> False
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lookup_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="skolem">as</span> <span class="main">=</span> Mapping.lookup <span class="skolem">joined_mapping</span> <span class="skolem">as</span>"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> not_mem mapping_eq
                    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Mapping_lookup_upd_set<span class="main">)</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∉</span> <span class="main">(</span>relR <span class="skolem">x</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">as</span> <span class="main">∈</span> Mapping.keys <span class="skolem">joined_mapping</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
                  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∉</span> <span class="main">(</span>relR <span class="skolem">x</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">joined_mapping</span> <span class="skolem">as</span> <span class="main">=</span> None"</span></span>
                    <span class="keyword1"><span class="command">unfolding</span></span> joined_mapping_def
                    <span class="keyword1"><span class="command">using</span></span> Mapping_keys_filterD keys_dom_lookup
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> lookup_eq Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">}</span></span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> Mapping.keys <span class="skolem">joined_mapping</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> relR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> relR <span class="skolem">x</span>"</span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> joined_mapping_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Mapping_keys_filterD<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="skolem">as</span> <span class="main">=</span> Mapping.lookup <span class="skolem">tuple_since_hist'</span> <span class="skolem">as</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> lookup_eq
                  <span class="keyword1"><span class="command">unfolding</span></span> joined_mapping_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_lookup_filter_Some<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">idx</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>1<span class="main">)</span> Some IH_nonempty
                  <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_hist'_def tuple_def tuple_since_hist_mv_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH_hist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> mem
                  <span class="keyword1"><span class="command">unfolding</span></span> idx_oldest_mv_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> mem
                  <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_mv_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> idx_leq snoc<span class="main">(</span>2<span class="main">)</span> non_empty
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> list_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> snd <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> relR
                  <span class="keyword1"><span class="command">unfolding</span></span> relR_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> IH_hist
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                  <span class="keyword1"><span class="command">using</span></span> list_eq
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">idx</span> <span class="main">⟹</span> <span class="skolem">as</span> <span class="main">∉</span> snd <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">idx</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">idx</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> idx_oldest_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="main">(</span>relR <span class="skolem">x</span><span class="main">)</span> <span class="main">-</span> Mapping.keys <span class="skolem">joined_mapping</span><span class="main">)</span>"</span></span><span class="main">)</span>
                <span class="keyword3"><span class="command">case</span></span> True
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> relR <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∉</span> Mapping.keys <span class="skolem">joined_mapping</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">tuple_since_hist'</span> <span class="skolem">as</span> <span class="main">=</span> None"</span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> joined_mapping_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Mapping_keys_filterI option.exhaust<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tuple_since_tp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span> tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="bound">idx</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>1<span class="main">)</span> IH_nonempty
                  <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_hist'_def tuple_def tuple_since_hist_mv_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> mv_ln_eq
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> IH_nonempty
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> not_relR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∉</span> snd <span class="main">(</span>last <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> no_hist_last_not_sat<span class="main">[</span><span class="operator">OF</span> len tuple_since_tp<span class="main">]</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="skolem">as</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">get_idx_move</span> <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> True mapping_eq
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_lookup_upd_set<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> idx_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">=</span> <span class="skolem">idx_mid_mv</span> <span class="skolem">xs</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>2<span class="main">)</span> Some
                  <span class="keyword1"><span class="command">unfolding</span></span> tuple_def 
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> idx_mid_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx_mid_mv</span> <span class="skolem">xs</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> mem
                  <span class="keyword1"><span class="command">unfolding</span></span> idx_mid_mv_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> idx_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> length <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
                    <span class="keyword1"><span class="command">using</span></span> len idx_oldest_eq idx_mid_eq
                    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> data_in''_eq idx_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span><span class="main">]</span>
                  <span class="keyword1"><span class="command">using</span></span> idx_eq idx_oldest_eq assm len
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> idx_oldest_eq idx_mid_eq len idx_rel idx_eq
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> last <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> len IH_nonempty
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_cancel_right' last_conv_nth<span class="main">)</span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> not_relR <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">next</span></span>
                <span class="keyword3"><span class="command">case</span></span> not_mem<span class="main">:</span> False
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lookup_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="skolem">as</span> <span class="main">=</span> Mapping.lookup <span class="skolem">joined_mapping</span> <span class="skolem">as</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> mapping_eq
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Mapping_lookup_upd_set<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> relR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> relR <span class="skolem">x</span>"</span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> joined_mapping_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Mapping_lookup_filter_Some_P Some<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lookup_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="skolem">as</span> <span class="main">=</span> Mapping.lookup <span class="skolem">tuple_since_hist'</span> <span class="skolem">as</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> Mapping_lookup_filter_not_None Some lookup_eq
                  <span class="keyword1"><span class="command">unfolding</span></span> joined_mapping_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lookup_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="skolem">as</span> <span class="main">=</span> Mapping.lookup <span class="main">(</span>fst <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="skolem">xs</span> <span class="skolem">init_tuple</span><span class="main">)</span><span class="main">)</span> <span class="skolem">as</span>"</span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_hist'_def tuple_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">idx</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>1<span class="main">)</span> IH_nonempty Some
                  <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_hist_mv_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> idx_props<span class="main">:</span>
                  <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&lt;</span> <span class="skolem">idx_mid_mv</span> <span class="skolem">xs</span>"</span></span>
                  <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&gt;</span> <span class="skolem">idx_oldest_mv</span> <span class="skolem">xs</span> <span class="main">⟶</span> <span class="skolem">as</span> <span class="main">∉</span> snd <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest_mv</span> <span class="skolem">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∉</span> snd <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> assm idx_oldest_eq
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> assm idx_oldest_eq idx_props<span class="main">(</span>1<span class="main">)</span> mv_ln_eq less_diff_conv2
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                  <span class="keyword1"><span class="command">using</span></span> idx_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span><span class="main">]</span>
                        data_in''_eq
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">idx</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> data_in_nonempty
              <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> hist_sat_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">hist_sat_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>
          <span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span>
        <span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> fold_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span><span class="skolem">fold_op_f</span> <span class="skolem">x</span> <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> fold_alt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">fold_op_f</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">init_tuple</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">unfolding</span></span> tuple_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">hist_sat_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>
          <span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span>
        <span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">hist_sat_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">unfolding</span></span> hist_sat_mv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">hist_sat_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> non_empty<span class="main">:</span> False
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> True
                <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_mv_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> non_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lin_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> True
              <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_mv_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">hist_sat_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="skolem">xs</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="main">∩</span> relR <span class="skolem">x</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="main">(</span>snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="skolem">x</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="bound">as</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="bound">idx</span> <span class="main">⇒</span> <span class="bound">idx</span> <span class="main">≤</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> lin_eq fold_alt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">fold_op_f</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">init_tuple</span></span><span class="main">]</span> fold_IH_hist_sat
                <span class="keyword1"><span class="command">unfolding</span></span> hist_sat_mv_def tuple_def hist_sat'_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="skolem">xs</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="main">∩</span> relR <span class="skolem">x</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> snd <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> relR_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> lin_eq
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">}</span></span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="main">(</span>snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="skolem">x</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="bound">as</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="bound">idx</span> <span class="main">⇒</span> <span class="bound">idx</span> <span class="main">≤</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">}</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> snd <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> lin_eq
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">}</span></span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tp<span class="main">:</span> <span class="quoted"><span class="quoted">"tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> mv_ln_eq
                <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_cancel_right' in_set_dropD length_greater_0_conv less_irrefl zero_less_diff<span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> mv_ln_eq
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">idx</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="skolem">as</span> <span class="main">=</span> Some <span class="skolem">idx</span> <span class="main">∧</span> <span class="skolem">idx</span> <span class="main">≤</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> tuple_since_hist_lookup_leq<span class="main">[</span><span class="operator">OF</span> tuple_since_hist_mv_props tp len<span class="main">]</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> relR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> relR <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> assm lin_eq
                <span class="keyword1"><span class="command">unfolding</span></span> relR_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="main">(</span>snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="skolem">x</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="bound">as</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="bound">idx</span> <span class="main">⇒</span> <span class="bound">idx</span> <span class="main">≤</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">}</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> relR_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">hist_sat_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> lin_eq relR
                <span class="keyword1"><span class="command">unfolding</span></span> hist_sat_mv_def relR_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
              <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">hist_sat_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">db</span></span> <span class="skolem"><span class="skolem">dbs</span></span> <span class="keyword2"><span class="keyword">where</span></span> db_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span><span class="main">#</span><span class="skolem">dbs</span> <span class="main">=</span> <span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> hist_sat_mv_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span><span class="skolem">fold_op_f</span> <span class="skolem">x</span> <span class="skolem">tuple</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> snd <span class="skolem">db</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="bound">as</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="bound">idx</span> <span class="main">⇒</span> <span class="bound">idx</span> <span class="main">≤</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> assm fold_eq
                <span class="keyword1"><span class="command">unfolding</span></span> hist_sat_mv_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
                <span class="keyword3"><span class="command">assume</span></span> as_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span><span class="skolem">fold_op_f</span> <span class="skolem">x</span> <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> as_props<span class="main">:</span>
                    <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">hist_sat'</span>"</span></span>
                    <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> snd <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> fold_IH_hist_sat
                  <span class="keyword1"><span class="command">unfolding</span></span> relR_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
                <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> as_props<span class="main">(</span>1<span class="main">)</span> IH<span class="main">(</span>4<span class="main">)</span> False
                  <span class="keyword1"><span class="command">unfolding</span></span> hist_sat_mv_def hist_sat'_def tuple_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_mv_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">}</span></span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> snd <span class="skolem">db</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="bound">as</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="bound">idx</span> <span class="main">⇒</span> <span class="bound">idx</span> <span class="main">≤</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">}</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">idx</span></span> <span class="keyword2"><span class="keyword">where</span></span> idx_props<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="skolem">as</span> <span class="main">=</span> Some <span class="skolem">idx</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">≤</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">y</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> tuple_since_hist_mv_props
                  <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> idx_props<span class="main">(</span>2<span class="main">)</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">}</span></span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> db_props
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tp<span class="main">:</span> <span class="quoted"><span class="quoted">"tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> mv_ln_eq
                <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_cancel_right' in_set_dropD length_greater_0_conv less_irrefl zero_less_diff<span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> mv_ln_eq
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">idx</span></span> <span class="keyword2"><span class="keyword">where</span></span> idx_props<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="skolem">as</span> <span class="main">=</span> Some <span class="skolem">idx</span> <span class="main">∧</span> <span class="skolem">idx</span> <span class="main">≤</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> tuple_since_hist_lookup_leq<span class="main">[</span><span class="operator">OF</span> tuple_since_hist_mv_props tp len<span class="main">]</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> mem non_empty snoc<span class="main">(</span>2<span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> relR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> relR <span class="skolem">x</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> assm
                <span class="keyword1"><span class="command">unfolding</span></span> relR_def lin_data_in''_mv_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="main">(</span>snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="skolem">x</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="bound">as</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="bound">idx</span> <span class="main">⇒</span> <span class="bound">idx</span> <span class="main">≤</span> <span class="skolem">idx_oldest_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">}</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> idx_props
                <span class="keyword1"><span class="command">unfolding</span></span> relR_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">hist_sat_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> assm
                <span class="keyword1"><span class="command">unfolding</span></span> hist_sat_mv_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="comment1">(* fold_IH_since_sat *)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">since_sat_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span> <span class="main">⟶</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">hist_sat_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span> <span class="main">∨</span> tuple_since_lhs <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">since_sat_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> mv_ln_eq
            <span class="keyword1"><span class="command">unfolding</span></span> since_sat_mv_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comm_monoid_add_class.add_0 equals0D length_nth_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> mem
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span>snd <span class="main">∘</span> snd <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assm
            <span class="keyword1"><span class="command">unfolding</span></span> since_sat_mv_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span>snd <span class="main">∘</span> snd <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span><span class="skolem">fold_op_f</span> <span class="skolem">x</span> <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="skolem">xs</span> <span class="skolem">init_tuple</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> fold_alt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">fold_op_f</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">init_tuple</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> as_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">since_sat'</span> <span class="main">∩</span> relR <span class="skolem">x</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> relR <span class="skolem">x</span><span class="main">.</span> proj_tuple_in_join <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="free">maskL</span> <span class="bound">as</span> <span class="main">(</span>relL <span class="skolem">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> fold_IH_since_sat
            <span class="keyword1"><span class="command">unfolding</span></span> tuple_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">hist_sat_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span> <span class="main">∨</span> tuple_since_lhs <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">since_sat'</span> <span class="main">∩</span> relR <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> relR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> relR <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
              <span class="keyword3"><span class="command">case</span></span> empty<span class="main">:</span> True
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> mem
                <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_mv_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> snd <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> relR
                <span class="keyword1"><span class="command">unfolding</span></span> relR_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta<span class="main">)</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">hist_sat_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> non_empty hist_sat_props
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">next</span></span>
              <span class="keyword3"><span class="command">case</span></span> IH_nonempty<span class="main">:</span> False
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx_mid_mv</span> <span class="skolem">xs</span> <span class="main">≠</span> <span class="skolem">idx_oldest_mv</span> <span class="skolem">xs</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> mv_ln_eq
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_cancel_left_left length_0_conv<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">hist_sat_mv</span> <span class="skolem">xs</span> <span class="skolem">init_tuple</span> <span class="main">∨</span> tuple_since_lhs <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> True IH<span class="main">(</span>5<span class="main">)</span> IH_nonempty
                <span class="keyword1"><span class="command">unfolding</span></span> since_sat'_def tuple_def since_sat_mv_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">hist_sat_mv</span> <span class="skolem">xs</span> <span class="skolem">init_tuple</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>4<span class="main">)</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> mem
                  <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_mv_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> snd <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> relR
                  <span class="keyword1"><span class="command">unfolding</span></span> relR_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta<span class="main">)</span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">hist_sat_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> non_empty hist_sat_props
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">}</span></span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"tuple_since_lhs <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n_props<span class="main">:</span>
                  <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">}</span>"</span></span>
                  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">y</span>"</span></span>
                  <span class="quoted"><span class="quoted">"join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_lhs_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
                <span class="keyword1"><span class="command">have</span></span> n_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> n_props<span class="main">(</span>1<span class="main">)</span> data_in''_aux_eq
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeastLessThan_iff length_map<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> drop_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> mem
                  <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_aux_mv_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> all_relR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">y</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> n_props<span class="main">(</span>2<span class="main">)</span> relR
                  <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_aux_mv_def relR_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> hd <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> n_l drop_eq hd_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span><span class="main">]</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> n_props<span class="main">(</span>3<span class="main">)</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">suffix</span> <span class="main">=</span> drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="bound">suffix</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="bound">suffix</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> non_empty all_relR
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> n_props<span class="main">(</span>1<span class="main">)</span>
                  <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_mv_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_since_lhs <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> non_empty
                  <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_lhs_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">}</span></span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> as_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> relR <span class="skolem">x</span><span class="main">.</span> proj_tuple_in_join <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="free">maskL</span> <span class="bound">as</span> <span class="main">(</span>relL <span class="skolem">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> as_mem
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
              <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> relR <span class="skolem">x</span>"</span></span>
              <span class="quoted"><span class="quoted">"proj_tuple_in_join <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="free">maskL</span> <span class="skolem">as</span> <span class="main">(</span>relL <span class="skolem">x</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> x_props<span class="main">:</span>
              <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> relR <span class="skolem">x</span>"</span></span>
              <span class="quoted"><span class="quoted">"join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> proj_tuple_in_join_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> drop_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> mem
              <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_aux_mv_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">y</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> x_props<span class="main">(</span>1<span class="main">)</span>
              <span class="keyword1"><span class="command">unfolding</span></span> relR_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> drop_eq x_props<span class="main">(</span>2<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">let</span> <span class="bound">suffix</span> <span class="main">=</span> drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
              <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="bound">suffix</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span>
              join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="bound">suffix</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">as</span><span class="main">)</span>
            <span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> n_def non_empty data_in''_aux_eq
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> One_nat_def atLeastLessThan_iff diff_Suc_less length_greater_0_conv length_map zero_le<span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_since_lhs <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> non_empty
              <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_lhs_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>tuple_since_lhs <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">since_sat_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"tuple_since_lhs <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_lhs_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> mem
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n_props<span class="main">:</span>
            <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assm 
            <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_lhs_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
          
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">since_sat'</span> <span class="main">∩</span> relR <span class="skolem">x</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> relR <span class="skolem">x</span><span class="main">.</span> proj_tuple_in_join <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="free">maskL</span> <span class="bound">as</span> <span class="main">(</span>relL <span class="skolem">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lin_data_in''_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> mem
              <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_mv_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> True data_in''_aux_eq data_in'_aux_eq mem
              <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_aux_mv_def lin_data_in''_mv_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
              <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> relR <span class="skolem">x</span>"</span></span>
              <span class="quoted"><span class="quoted">"join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> n_props lin_data_in''_eq
              <span class="keyword1"><span class="command">unfolding</span></span> relR_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> relR <span class="skolem">x</span><span class="main">.</span> proj_tuple_in_join <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="free">maskL</span> <span class="bound">as</span> <span class="main">(</span>relL <span class="skolem">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> proj_tuple_in_join_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            
            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">assume</span></span> n_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">{</span></span>
                <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">l</span> <span class="skolem">r</span>
                <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_aux_mv_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">}</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> relR<span class="main">:</span>
                <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> n_props<span class="main">(</span>2<span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> hd <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="main">(</span><span class="skolem">data_in'_aux</span> <span class="main">@</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_aux_mv_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">data_in'_aux</span> <span class="main">@</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">≥</span> <span class="skolem">n</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> n_l data_in'_aux_eq
                <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_mv_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeastLessThan_iff data_in''_aux_eq length_map less_imp_le_nat lin_data_in''_aux_mv_def n_l<span class="main">)</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> hd <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">data_in'_aux</span> <span class="main">@</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> n_l drop_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">data_in'_aux</span> <span class="main">@</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span><span class="main">]</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">data_in'_aux</span> <span class="main">@</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> False data_in''_aux_eq n_l
                <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_aux_mv_def lin_data_in''_mv_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> atLeastLessThan_iff length_drop length_map length_nth_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> not_less0 zero_less_diff<span class="main">)</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> hd <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">data_in'_aux</span> <span class="main">@</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> hd_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">data_in'_aux</span> <span class="main">@</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span><span class="main">]</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> hd <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_aux_mv_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> n_props<span class="main">(</span>3<span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">let</span> <span class="bound">suffix</span> <span class="main">=</span> drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="bound">suffix</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="bound">suffix</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">as</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> relR
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_since_lhs <span class="skolem">as</span> <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> n_l False
                <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_lhs_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span>snd <span class="main">∘</span> snd <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="skolem">xs</span> <span class="skolem">init_tuple</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>6<span class="main">)</span> mv_ln_eq False
                <span class="keyword1"><span class="command">unfolding</span></span> since_sat_mv_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> equals0D<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">since_sat'</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> since_sat'_def tuple_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> relR <span class="skolem">x</span>"</span></span>
              <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> n_props<span class="main">(</span>1<span class="main">)</span> data_in'_aux_eq
                  <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_aux_mv_def lin_data_in''_mv_def
                  <span class="keyword1"><span class="command">using</span></span> length_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
                  <span class="comment1">(* generated subproof *)</span>
                  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
                    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">data_in'_aux</span> <span class="main">@</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
                      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeastLessThan_iff data_in''_aux_eq length_map lin_data_in''_aux_mv_def n_props<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
                  <span class="keyword1"><span class="command">qed</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> mem
                  <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_aux_mv_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> n_props<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> relR_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">qed</span></span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">since_sat'</span> <span class="main">∩</span> relR <span class="skolem">x</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> relR <span class="skolem">x</span><span class="main">.</span> proj_tuple_in_join <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="free">maskL</span> <span class="bound">as</span> <span class="main">(</span>relL <span class="skolem">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∉</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">∈</span><span class="main">{</span>length <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">..&lt;</span>length <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> n_props<span class="main">(</span>1<span class="main">)</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> mem
                <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_mv_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">lin_data_in''_mv</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> n_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> data_in''_aux_eq
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_map<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
                <span class="quoted"><span class="quoted">"<span class="main">(</span>hd <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
                <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> mem
                <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_aux_mv_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
                <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> relR <span class="skolem">x</span>"</span></span>
                <span class="quoted"><span class="quoted">"join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> n_props<span class="main">(</span>2-3<span class="main">)</span>
                <span class="keyword1"><span class="command">unfolding</span></span> relR_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> relR <span class="skolem">x</span><span class="main">.</span> proj_tuple_in_join <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="free">maskL</span> <span class="bound">as</span> <span class="main">(</span>relL <span class="skolem">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> proj_tuple_in_join_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span>snd <span class="main">∘</span> snd <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span><span class="skolem">fold_op_f</span> <span class="skolem">x</span> <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="skolem">xs</span> <span class="skolem">init_tuple</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> fold_IH_since_sat
            <span class="keyword1"><span class="command">unfolding</span></span> tuple_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span>snd <span class="main">∘</span> snd <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> fold_alt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">fold_op_f</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">init_tuple</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">since_sat_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> mv_ln_eq non_empty
            <span class="keyword1"><span class="command">unfolding</span></span> since_sat_mv_def since_sat'_def tuple_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_cancel_left_left length_0_conv<span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">get_idx_move</span> <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fold <span class="skolem">fold_op_f</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span> <span class="main">=</span> <span class="skolem">fold_op_f</span> <span class="skolem">x</span> <span class="skolem">tuple</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> fold_alt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">fold_op_f</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span>"</span></span> <span class="quoted"><span class="skolem">init_tuple</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">unfolding</span></span> tuple_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">get_idx_move</span> <span class="main">(</span><span class="skolem">fold_op_f</span> <span class="skolem">x</span> <span class="skolem">tuple</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">get_idx_move</span> <span class="skolem">tuple</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> get_idx_move_def fold_op_f_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> case_prod_beta' comp_apply fst_conv prod.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">get_idx_move</span> <span class="skolem">tuple</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>2<span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> tuple_def idx_mid_mv_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="main">(</span>fst <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span><span class="main">)</span> <span class="skolem">as</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">idx</span> <span class="main">⇒</span> <span class="bound">idx</span> <span class="main">&lt;</span> <span class="skolem">idx_mid_mv</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fold <span class="skolem">fold_op_f</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span> <span class="main">=</span> <span class="skolem">fold_op_f</span> <span class="skolem">x</span> <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="skolem">xs</span> <span class="skolem">init_tuple</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> fold_alt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">fold_op_f</span></span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">init_tuple</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mapping_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="main">=</span> upd_set <span class="skolem">joined_mapping</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">get_idx_move</span> <span class="skolem">tuple</span><span class="main">)</span> <span class="main">(</span>relR <span class="skolem">x</span> <span class="main">-</span> Mapping.keys <span class="skolem">joined_mapping</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> fold_IH_since_hist
          <span class="keyword1"><span class="command">unfolding</span></span> tuple_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>fst <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span><span class="main">)</span> <span class="skolem">as</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">idx</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span>relR <span class="skolem">x</span> <span class="main">-</span> Mapping.keys <span class="skolem">joined_mapping</span><span class="main">)</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">=</span> <span class="skolem">get_idx_move</span> <span class="skolem">tuple</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> Some mapping_eq
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_lookup_upd_set<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>2-3<span class="main">)</span> Some
              <span class="keyword1"><span class="command">unfolding</span></span> tuple_def idx_mid_mv_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>fst <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span><span class="main">)</span> <span class="skolem">as</span> <span class="main">=</span> Mapping.lookup <span class="skolem">joined_mapping</span> <span class="skolem">as</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> mapping_eq
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Mapping_lookup_upd_set<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>fst <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">init_tuple</span><span class="main">)</span><span class="main">)</span> <span class="skolem">as</span> <span class="main">=</span> Mapping.lookup <span class="skolem">tuple_since_hist'</span> <span class="skolem">as</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> joined_mapping_def
              <span class="keyword1"><span class="command">using</span></span> Some Mapping_lookup_filter_not_None
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_hist'_def tuple_def
              <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>3<span class="main">)</span> Some idx_mid_mv_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> is_empty_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">idx_mid_mv</span> <span class="skolem">move</span> <span class="main">=</span> <span class="skolem">idx_oldest_mv</span> <span class="skolem">move</span><span class="main">)</span> <span class="main">=</span> is_empty <span class="free">data_in''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mv_idx_mid' mv_idx_oldest' data_in''_len' is_empty_alt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">data_in''</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> since_hist''_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_since_hist_mv</span> <span class="skolem">move</span> <span class="skolem">init_tuple</span> <span class="main">=</span> <span class="free">tuple_since_hist''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> is_empty_eq fold_tuple_res
      <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_hist''_def tuple_since_hist_mv_def init_tuple_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hist_sat_mv</span> <span class="skolem">move</span> <span class="skolem">init_tuple</span> <span class="main">=</span> <span class="free">hist_sat''</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> hist_sat'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="skolem">move</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">hist_sat'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fold_tuple_res
        <span class="keyword1"><span class="command">unfolding</span></span> init_tuple_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_apply fst_conv snd_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">hist_sat_mv</span> <span class="skolem">move</span> <span class="skolem">init_tuple</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">db</span></span> <span class="skolem"><span class="skolem">dbs</span></span> <span class="keyword2"><span class="keyword">where</span></span> db_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span><span class="main">#</span><span class="skolem">dbs</span> <span class="main">=</span> linearize <span class="free">data_in''</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> hist_sat_mv_def mv_data_in''
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lin_non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="main">(</span><span class="free">data_in''</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_empty <span class="main">(</span><span class="free">data_in''</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> is_empty_alt
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">have</span></span> hd_in<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">db</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> db_props mv_data_in''
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">dbs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> safe_hd_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_hd <span class="free">data_in''</span> <span class="main">=</span> <span class="main">(</span>Some <span class="skolem">db</span><span class="main">,</span> <span class="skolem">dbs'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> safe_hd_rep<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">data_in''</span></span><span class="main">]</span> db_props
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> lin_non_empty case_optionE hd_in safe_hd_rep surjective_pairing<span class="main">)</span>
        
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="skolem">move</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> snd <span class="skolem">db</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">tuple_since_hist''</span> <span class="bound">as</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="bound">idx</span> <span class="main">⇒</span> <span class="bound">idx</span> <span class="main">≤</span> <span class="free">idx_oldest'</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> db_props assm since_hist''_eq mv_idx_oldest' mv_data_in''
          <span class="keyword1"><span class="command">unfolding</span></span> hist_sat_mv_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">hist_sat'</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> snd <span class="skolem">db</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">tuple_since_hist''</span> <span class="bound">as</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="bound">idx</span> <span class="main">⇒</span> <span class="bound">idx</span> <span class="main">≤</span> <span class="free">idx_oldest'</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> hist_sat'_eq
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>safe_hd <span class="free">data_in''</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">db</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> safe_hd_eq
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">hist_sat''</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> hist_sat''_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">hist_sat''</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">db</span></span> <span class="skolem"><span class="skolem">dbs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> safe_hd_eq<span class="main">:</span>
          <span class="quoted"><span class="quoted">"safe_hd <span class="free">data_in''</span> <span class="main">=</span> <span class="main">(</span>Some <span class="skolem">db</span><span class="main">,</span> <span class="skolem">dbs'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> hist_sat''_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> empty_iff eq_fst_iff option.exhaust option.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> x_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">hist_sat'</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">tuple</span></span> <span class="main">∈</span> snd <span class="skolem">db</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">tuple_since_hist''</span> <span class="bound">tuple</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="bound">idx</span> <span class="main">⇒</span> <span class="bound">idx</span> <span class="main">≤</span> <span class="free">idx_oldest'</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assm
          <span class="keyword1"><span class="command">unfolding</span></span> hist_sat''_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> hd_props<span class="main">:</span>
          <span class="quoted"><span class="quoted">"linearize <span class="free">data_in''</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">=</span> hd <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> safe_hd_eq safe_hd_rep<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">data_in''</span></span> <span class="quoted"><span class="quoted">"Some <span class="skolem">db</span>"</span></span> <span class="quoted"><span class="skolem">dbs'</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">dbs</span></span> <span class="keyword2"><span class="keyword">where</span></span> dbs_props<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="free">data_in''</span> <span class="main">=</span> <span class="skolem">db</span><span class="main">#</span><span class="skolem">dbs</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hd_Cons_tl<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span>fold <span class="skolem">fold_op_f</span> <span class="skolem">move</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> snd <span class="skolem">db</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="main">(</span><span class="skolem">tuple_since_hist_mv</span> <span class="skolem">move</span> <span class="skolem">init_tuple</span><span class="main">)</span> <span class="bound">as</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False <span class="main">|</span> Some <span class="bound">idx</span> <span class="main">⇒</span> <span class="bound">idx</span> <span class="main">≤</span> <span class="skolem">idx_oldest_mv</span> <span class="skolem">move</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> x_mem mv_data_in''
          <span class="keyword1"><span class="command">unfolding</span></span> mv_idx_oldest' since_hist''_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> hist_sat'_eq
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">hist_sat_mv</span> <span class="skolem">move</span> <span class="skolem">init_tuple</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> mv_data_in'' hd_props<span class="main">(</span>1<span class="main">)</span> dbs_props
          <span class="keyword1"><span class="command">unfolding</span></span> hist_sat_mv_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">since_sat_mv</span> <span class="skolem">move</span> <span class="skolem">init_tuple</span> <span class="main">=</span> <span class="free">since_sat''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fold_tuple_res
      <span class="keyword1"><span class="command">unfolding</span></span> since_sat''_def since_sat_mv_def mv_idx_oldest'<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> mv_idx_mid'<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
                init_tuple_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> snd_conv<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="skolem">move</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>

      <span class="keyword1"><span class="command">have</span></span> filter_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nt_mono<span class="main">(</span>1<span class="main">)</span> time not_memL_nt_mt
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">have</span></span> filter_simp'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="skolem">move</span><span class="main">)</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">@</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_prev</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> auxlist_eqs<span class="main">(</span>2<span class="main">)</span> filter_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> lin_data_in''_aux_mv_def data_in'_aux_def move_filter
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def
        <span class="keyword1"><span class="command">using</span></span> filter_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">auxlist</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_simp<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">=</span> linearize <span class="free">data_prev</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="skolem">move</span><span class="main">)</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span> <span class="main">@</span> auxlist_data_prev <span class="free">args</span> <span class="free">mt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="skolem">move</span><span class="main">)</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> auxlist_eqs
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lin_data_in''_aux_mv</span> <span class="skolem">move</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> filter_filter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">auxlist</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_simp'<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> data_in_auxlist_filter_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="main">(</span><span class="free">tuple_since_hist''</span><span class="main">)</span> <span class="skolem">as</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> <span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span> tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="free">idx_oldest'</span> <span class="free">idx_mid'</span> <span class="bound">idx</span>
      <span class="main">|</span> Some <span class="bound">idx</span> <span class="main">⇒</span> tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="free">idx_oldest'</span> <span class="free">idx_mid'</span> <span class="bound">idx</span><span class="main">)</span>"</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">as</span> <span class="main">∈</span> <span class="free">hist_sat''</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_in''</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">as</span> <span class="main">∈</span> <span class="free">since_sat''</span> <span class="main">⟶</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="free">hist_sat''</span> <span class="main">∨</span> tuple_since_lhs <span class="skolem">as</span> <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">(</span>tuple_since_lhs <span class="skolem">as</span> <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="free">since_sat''</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mv_data_in''<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> mv_idx_oldest'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> mv_idx_mid'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fold_induct_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">as</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="main">(</span><span class="free">tuple_since_hist''</span><span class="main">)</span> <span class="bound">as</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> <span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span> tuple_since_tp <span class="free">args</span> <span class="bound">as</span> <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="free">idx_oldest'</span> <span class="free">idx_mid'</span> <span class="bound">idx</span>
      <span class="main">|</span> Some <span class="bound">idx</span> <span class="main">⇒</span> tuple_since_tp <span class="free">args</span> <span class="bound">as</span> <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="free">idx_oldest'</span> <span class="free">idx_mid'</span> <span class="bound">idx</span><span class="main">)</span>"</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">as</span><span class="main">.</span> <span class="main">(</span><span class="bound">as</span> <span class="main">∈</span> <span class="free">hist_sat''</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_in''</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">as</span><span class="main">.</span> <span class="main">(</span><span class="bound">as</span> <span class="main">∈</span> <span class="free">since_sat''</span> <span class="main">⟶</span> <span class="bound">as</span> <span class="main">∈</span> <span class="free">hist_sat''</span> <span class="main">∨</span> tuple_since_lhs <span class="bound">as</span> <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">as</span><span class="main">.</span> <span class="main">(</span>tuple_since_lhs <span class="bound">as</span> <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">as</span> <span class="main">∈</span> <span class="free">since_sat''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> tuple_since_hist''_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">as</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="main">(</span><span class="free">tuple_since_hist''</span><span class="main">)</span> <span class="bound">as</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> <span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span> tuple_since_tp <span class="free">args</span> <span class="bound">as</span> <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="free">idx_oldest'</span> <span class="free">idx_mid'</span> <span class="bound">idx</span>
      <span class="main">|</span> Some <span class="bound">idx</span> <span class="main">⇒</span> tuple_since_tp <span class="free">args</span> <span class="bound">as</span> <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="free">idx_oldest'</span> <span class="free">idx_mid'</span> <span class="bound">idx</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fold_induct_props<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="main">(</span><span class="free">tuple_since_hist''</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">as</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> Mapping.keys <span class="main">(</span><span class="free">tuple_since_hist''</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">idx</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">tuple_since_hist''</span> <span class="skolem">as</span> <span class="main">=</span> Some <span class="skolem">idx</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Mapping_keys_dest<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> idx_props<span class="main">:</span>
        <span class="quoted"><span class="quoted">"linearize <span class="free">data_in''</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&lt;</span> <span class="free">idx_mid'</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="free">idx_oldest'</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> tuple_since_hist''_props
        <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">-</span> <span class="free">idx_oldest'</span> <span class="main">&lt;</span> length <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> data_in''_len'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add_diff_cancel_left' diff_is_0_eq diff_less_mono not_le_imp_less length_0_conv less_imp_le_nat<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="free">idx_oldest'</span><span class="main">)</span> <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> idx_props<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> drop_eq_Nil last_drop last_in_set leD<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> as_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> snd <span class="main">(</span>last <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> idx_props<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_r_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> last <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> prod.collapse
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> idx_props<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> last_in_set<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> auxlist_data_in
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> case_prod_beta' fst_conv imageE prod.collapse set_map snd_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">auxlist</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">relL</span><span class="main">,</span> <span class="bound">relR</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">auxlist</span><span class="main">.</span> table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="bound">relL</span> <span class="main">∧</span> table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">relR</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="skolem">as</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> as_in t_r_def
        <span class="keyword1"><span class="command">unfolding</span></span> table_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> snd_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Mapping.keys <span class="free">tuple_since_hist''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> table_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="free">hist_sat''</span> <span class="main">⟷</span>
      <span class="main">(</span><span class="main">¬</span>is_empty <span class="free">data_in''</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>
        <span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="bound">r</span>
    <span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tuple</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="free">hist_sat''</span> <span class="main">⟷</span>
      <span class="main">(</span><span class="main">¬</span>is_empty <span class="free">data_in''</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>
        <span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="free">hist_sat''</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> props<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span>is_empty <span class="free">data_in''</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> fold_induct_props<span class="main">(</span>2<span class="main">)</span> is_empty_alt
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">l</span> <span class="skolem">r</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> data_in_auxlist_filter_eq
            <span class="keyword1"><span class="command">using</span></span> set_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="free">auxlist</span>"</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="skolem">r</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> props<span class="main">(</span>2<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span>is_empty <span class="free">data_in''</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>
        <span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> data_in_auxlist_filter_eq props<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span>is_empty <span class="free">data_in''</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>
        <span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> auxlist_data_in data_in_auxlist_filter_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> set_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="free">auxlist</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="free">hist_sat''</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assm fold_induct_props<span class="main">(</span>2<span class="main">)</span> is_empty_alt
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="free">since_sat''</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">(</span><span class="bound">tuple</span> <span class="main">∈</span> <span class="free">hist_sat''</span><span class="main">)</span> <span class="main">∨</span> tuple_since_lhs <span class="bound">tuple</span> <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fold_induct_props<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> tuple_since_lhs <span class="bound">tuple</span> <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="bound">tuple</span> <span class="main">∈</span> <span class="free">since_sat''</span>
    <span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fold_induct_props<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_update_mmtaux'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_before<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_mmtaux <span class="free">args</span> <span class="free">cur</span>
    <span class="main">(</span><span class="free">mt</span><span class="main">,</span> <span class="free">idx_next</span><span class="main">,</span> <span class="free">idx_mid</span><span class="main">,</span> <span class="free">idx_oldest</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in_once</span><span class="main">,</span> <span class="free">tuple_in_once_keys</span><span class="main">,</span> <span class="free">tuple_since_hist</span><span class="main">,</span> <span class="free">hist_sat</span><span class="main">,</span> <span class="free">since_sat</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nt_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nt</span> <span class="main">≥</span> <span class="free">cur</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">idx_mid'</span><span class="main">,</span> <span class="free">idx_oldest'</span><span class="main">,</span> <span class="free">data_prev'</span><span class="main">,</span> <span class="free">data_in''</span><span class="main">,</span> <span class="free">tuple_in_once'</span><span class="main">,</span> <span class="free">tuple_in_once_keys'</span><span class="main">,</span> <span class="free">tuple_since_hist''</span><span class="main">,</span> <span class="free">hist_sat''</span><span class="main">,</span> <span class="free">since_sat''</span><span class="main">)</span> <span class="main">=</span> update_mmtaux' <span class="free">args</span> <span class="free">nt</span> <span class="free">idx_mid</span> <span class="free">idx_oldest</span> <span class="free">maskL</span> <span class="free">maskR</span> <span class="free">data_prev</span> <span class="free">data_in</span> <span class="free">tuple_in_once</span> <span class="free">tuple_in_once_keys</span> <span class="free">tuple_since_hist</span> <span class="free">hist_sat</span> <span class="free">since_sat</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_mmtaux <span class="free">args</span> <span class="free">nt</span>
    <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">idx_next</span><span class="main">,</span> <span class="free">idx_mid'</span><span class="main">,</span> <span class="free">idx_oldest'</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev'</span><span class="main">,</span> <span class="free">data_in''</span><span class="main">,</span> <span class="free">tuple_in_once'</span><span class="main">,</span> <span class="free">tuple_in_once_keys'</span><span class="main">,</span> <span class="free">tuple_since_hist''</span><span class="main">,</span> <span class="free">hist_sat''</span><span class="main">,</span> <span class="free">since_sat''</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">auxlist'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">auxlist'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span> <span class="main">⟶</span> args_pos <span class="free">args</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">maskL</span> <span class="main">=</span> join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">maskR</span> <span class="main">=</span> join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">relL</span><span class="main">,</span> <span class="bound">relR</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">auxlist'</span><span class="main">.</span> table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="bound">relL</span> <span class="main">∧</span> table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">relR</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Mapping.keys <span class="free">tuple_in_once'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_update_mmtaux'_unfolded<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Mapping.keys <span class="free">tuple_since_hist''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_update_mmtaux'_unfolded<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>relL<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_update_mmtaux'_unfolded<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>relR<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_update_mmtaux'_unfolded<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>snd<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_update_mmtaux'_unfolded<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ts_tuple_rel_binary_rhs <span class="main">(</span>set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_update_mmtaux'_unfolded<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> sorted_filter
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_update_mmtaux'_unfolded<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_update_mmtaux'_unfolded<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span> <span class="main">+</span> <span class="free">idx_mid'</span> <span class="main">=</span> <span class="free">idx_next</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_update_mmtaux'_unfolded<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_update_mmtaux'_unfolded<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span> <span class="main">=</span> take <span class="main">(</span>length <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_update_mmtaux'_unfolded<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="main">+</span> <span class="free">idx_oldest'</span> <span class="main">=</span> <span class="free">idx_mid'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_update_mmtaux'_unfolded<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="skolem">auxlist'</span><span class="main">.</span> time <span class="bound">db</span> <span class="main">≤</span> <span class="free">nt</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> time <span class="bound">db</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">db</span>
      <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">∈</span> set <span class="skolem">auxlist'</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="free">auxlist</span><span class="main">.</span> time <span class="bound">db</span> <span class="main">≤</span> <span class="free">mt</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> time <span class="bound">db</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">db</span> <span class="main">∈</span> set <span class="free">auxlist</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assm
        <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"time <span class="skolem">db</span> <span class="main">≤</span> <span class="free">mt</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"time <span class="skolem">db</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nt_mono assms<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> time <span class="skolem">db</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assm
        <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def time_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"time <span class="skolem">db</span> <span class="main">≤</span> <span class="free">nt</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> time <span class="skolem">db</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"newest_tuple_in_mapping fst <span class="free">data_prev'</span> <span class="free">tuple_in_once'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_update_mmtaux'_unfolded<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="free">tuple_in_once'</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">tuple_in_once'</span> <span class="bound">as</span> <span class="keyword1">of</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="main">∃</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="free">data_prev'</span><span class="main">)</span> <span class="main">∧</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="bound">as</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">as</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="free">tuple_since_hist''</span> <span class="bound">as</span> <span class="keyword1">of</span>
      Some <span class="bound">idx</span> <span class="main">⇒</span> tuple_since_tp <span class="free">args</span> <span class="bound">as</span> <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="free">idx_oldest'</span> <span class="free">idx_mid'</span> <span class="bound">idx</span>
      <span class="main">|</span> None   <span class="main">⇒</span> <span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span>tuple_since_tp <span class="free">args</span> <span class="bound">as</span> <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="free">idx_oldest'</span> <span class="free">idx_mid'</span> <span class="bound">idx</span><span class="main">)</span>
    <span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_update_mmtaux'_unfolded<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="free">hist_sat''</span> <span class="main">⟷</span>
      <span class="main">(</span><span class="main">¬</span>is_empty <span class="free">data_in''</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>
        <span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="bound">r</span>
    <span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_update_mmtaux'_unfolded<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="free">since_sat''</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">(</span><span class="bound">tuple</span> <span class="main">∈</span> <span class="free">hist_sat''</span><span class="main">)</span> <span class="main">∨</span> tuple_since_lhs <span class="bound">tuple</span> <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span><span class="main">)</span>
    <span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_update_mmtaux'_unfolded<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> tuple_since_lhs <span class="bound">tuple</span> <span class="main">(</span>linearize <span class="free">data_in''</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="bound">tuple</span> <span class="main">∈</span> <span class="free">since_sat''</span>
    <span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_update_mmtaux'_unfolded<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">tuple_in_once_keys'</span> <span class="main">=</span> Mapping.keys <span class="free">tuple_in_once'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_update_mmtaux'_unfolded<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">update_mmtaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> <span class="tfree">'a</span> mmtaux <span class="main">⇒</span> <span class="tfree">'a</span> mmtaux"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_mmtaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cur</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">idx_next</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">idx_mid</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">idx_oldest</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in_once</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_in_once_keys</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tuple_since_hist</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">hist_sat</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">since_sat</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">let</span> <span class="main">(</span><span class="bound">idx_mid'</span><span class="main">,</span> <span class="bound">idx_oldest'</span><span class="main">,</span> <span class="bound">data_prev'</span><span class="main">,</span> <span class="bound">data_in'</span><span class="main">,</span> <span class="bound">tuple_in_once'</span><span class="main">,</span> <span class="bound">tuple_in_once_keys'</span><span class="main">,</span> <span class="bound">tuple_since_hist'</span><span class="main">,</span> <span class="bound">hist_sat'</span><span class="main">,</span> <span class="bound">since_sat'</span><span class="main">)</span> <span class="main">=</span>
    update_mmtaux' <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="free"><span class="bound"><span class="entity">idx_mid</span></span></span> <span class="free"><span class="bound"><span class="entity">idx_oldest</span></span></span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span> <span class="free"><span class="bound"><span class="entity">maskR</span></span></span> <span class="free"><span class="bound"><span class="entity">data_prev</span></span></span> <span class="free"><span class="bound"><span class="entity">data_in</span></span></span> <span class="free"><span class="bound"><span class="entity">tuple_in_once</span></span></span> <span class="free"><span class="bound"><span class="entity">tuple_in_once_keys</span></span></span> <span class="free"><span class="bound"><span class="entity">tuple_since_hist</span></span></span> <span class="free"><span class="bound"><span class="entity">hist_sat</span></span></span> <span class="free"><span class="bound"><span class="entity">since_sat</span></span></span>
  <span class="keyword1">in</span> <span class="main">(</span>
    <span class="keyword1">if</span> mem <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span>
      <span class="keyword1">let</span> <span class="bound">tuple_since_hist''</span> <span class="main">=</span> Mapping.filter <span class="main">(</span><span class="main">λ</span><span class="bound">as</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="bound">tuple_since_hist'</span> <span class="keyword1">in</span>
        <span class="main">(</span>
          <span class="free"><span class="bound"><span class="entity">nt</span></span></span><span class="main">,</span>
          <span class="free"><span class="bound"><span class="entity">idx_next</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">,</span>
          <span class="bound">idx_mid'</span><span class="main">+</span><span class="main">1</span><span class="main">,</span>
          <span class="bound">idx_oldest'</span><span class="main">,</span>
          <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span>
          <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span>
          <span class="bound">data_prev'</span><span class="main">,</span>
          <span class="main">(</span>append_queue <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="bound">data_in'</span><span class="main">)</span><span class="main">,</span>
          <span class="bound">tuple_in_once'</span><span class="main">,</span>
          <span class="bound">tuple_in_once_keys'</span><span class="main">,</span>
          upd_set <span class="bound">tuple_since_hist''</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">idx_mid'</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">-</span> Mapping.keys <span class="bound">tuple_since_hist''</span><span class="main">)</span><span class="main">,</span>
          <span class="main">(</span><span class="keyword1">if</span> is_empty <span class="bound">data_in'</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">else</span> <span class="bound">hist_sat'</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">,</span>
          <span class="main">(</span><span class="bound">since_sat'</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">.</span> proj_tuple_in_join <span class="main">(</span>args_pos <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">maskL</span></span></span> <span class="bound">as</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">}</span>
        <span class="main">)</span>
      <span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="main">(</span>
        <span class="free"><span class="bound"><span class="entity">nt</span></span></span><span class="main">,</span>
        <span class="free"><span class="bound"><span class="entity">idx_next</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">,</span>
        <span class="bound">idx_mid'</span><span class="main">,</span>
        <span class="bound">idx_oldest'</span><span class="main">,</span>
        <span class="free"><span class="bound"><span class="entity">maskL</span></span></span><span class="main">,</span>
        <span class="free"><span class="bound"><span class="entity">maskR</span></span></span><span class="main">,</span>
        append_queue <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="bound">data_prev'</span><span class="main">,</span>
        <span class="bound">data_in'</span><span class="main">,</span>
        upd_set <span class="bound">tuple_in_once'</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span>
        <span class="bound">tuple_in_once_keys'</span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span>
        <span class="bound">tuple_since_hist'</span><span class="main">,</span>
        <span class="bound">hist_sat'</span><span class="main">,</span>
        <span class="bound">since_sat'</span>
      <span class="main">)</span>
  <span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_update_mmtaux_unfolded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">nt</span> <span class="main">≥</span> <span class="free">cur</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_mmtaux <span class="free">args</span> <span class="free">cur</span> <span class="main">(</span><span class="free">mt</span><span class="main">,</span> <span class="free">idx_next</span><span class="main">,</span> <span class="free">idx_mid</span><span class="main">,</span> <span class="free">idx_oldest</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in_once</span><span class="main">,</span> <span class="free">tuple_in_once_keys</span><span class="main">,</span> <span class="free">tuple_since_hist</span><span class="main">,</span> <span class="free">hist_sat</span><span class="main">,</span> <span class="free">since_sat</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_mmtaux
      <span class="free">args</span>
      <span class="free">nt</span>
      <span class="main">(</span>update_mmtaux <span class="free">args</span> <span class="free">nt</span> <span class="free">l</span> <span class="free">r</span> <span class="main">(</span><span class="free">mt</span><span class="main">,</span> <span class="free">idx_next</span><span class="main">,</span> <span class="free">idx_mid</span><span class="main">,</span> <span class="free">idx_oldest</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in_once</span><span class="main">,</span> <span class="free">tuple_in_once_keys</span><span class="main">,</span> <span class="free">tuple_since_hist</span><span class="main">,</span> <span class="free">hist_sat</span><span class="main">,</span> <span class="free">since_sat</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
  "</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">update_mmtaux'_res</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">update_mmtaux'_res</span> <span class="main">=</span> update_mmtaux' <span class="free">args</span> <span class="free">nt</span> <span class="free">idx_mid</span> <span class="free">idx_oldest</span> <span class="free">maskL</span> <span class="free">maskR</span> <span class="free">data_prev</span> <span class="free">data_in</span> <span class="free">tuple_in_once</span> <span class="free">tuple_in_once_keys</span> <span class="free">tuple_since_hist</span> <span class="free">hist_sat</span> <span class="free">since_sat</span>"</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">idx_mid'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx_mid'</span> <span class="main">=</span> fst <span class="skolem">update_mmtaux'_res</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">idx_oldest'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx_oldest'</span> <span class="main">=</span> <span class="main">(</span>fst <span class="keyword1">o</span> snd<span class="main">)</span> <span class="skolem">update_mmtaux'_res</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">data_prev'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">data_prev'</span> <span class="main">=</span> <span class="main">(</span>fst <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="skolem">update_mmtaux'_res</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">data_in'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">data_in'</span> <span class="main">=</span> <span class="main">(</span>fst <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="skolem">update_mmtaux'_res</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tuple_in_once'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_in_once'</span> <span class="main">=</span> <span class="main">(</span>fst <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="skolem">update_mmtaux'_res</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tuple_in_once_keys'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_in_once_keys'</span> <span class="main">=</span> <span class="main">(</span>fst <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="skolem">update_mmtaux'_res</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tuple_since_hist'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_since_hist'</span>     <span class="main">=</span> <span class="main">(</span>fst <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="skolem">update_mmtaux'_res</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">hist_sat'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hist_sat'</span>                     <span class="main">=</span> <span class="main">(</span>fst <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="skolem">update_mmtaux'_res</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">since_sat'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">since_sat'</span>                   <span class="main">=</span> <span class="main">(</span>snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="skolem">update_mmtaux'_res</span>"</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">auxlist'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">auxlist'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> update_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">idx_mid'</span><span class="main">,</span> <span class="skolem">idx_oldest'</span><span class="main">,</span> <span class="skolem">data_prev'</span><span class="main">,</span> <span class="skolem">data_in'</span><span class="main">,</span> <span class="skolem">tuple_in_once'</span><span class="main">,</span> <span class="skolem">tuple_in_once_keys'</span><span class="main">,</span> <span class="skolem">tuple_since_hist'</span><span class="main">,</span> <span class="skolem">hist_sat'</span><span class="main">,</span> <span class="skolem">since_sat'</span><span class="main">)</span> <span class="main">=</span>
    update_mmtaux' <span class="free">args</span> <span class="free">nt</span> <span class="free">idx_mid</span> <span class="free">idx_oldest</span> <span class="free">maskL</span> <span class="free">maskR</span> <span class="free">data_prev</span> <span class="free">data_in</span> <span class="free">tuple_in_once</span> <span class="free">tuple_in_once_keys</span> <span class="free">tuple_since_hist</span> <span class="free">hist_sat</span> <span class="free">since_sat</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> update_mmtaux'_res_def
    <span class="keyword1"><span class="command">unfolding</span></span> idx_mid'_def idx_oldest'_def data_prev'_def data_in'_def tuple_in_once'_def tuple_in_once_keys'_def tuple_since_hist'_def hist_sat'_def since_sat'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_mmtaux <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">idx_next</span><span class="main">,</span> <span class="skolem">idx_mid'</span><span class="main">,</span> <span class="skolem">idx_oldest'</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="skolem">data_prev'</span><span class="main">,</span> <span class="skolem">data_in'</span><span class="main">,</span> <span class="skolem">tuple_in_once'</span><span class="main">,</span> <span class="skolem">tuple_in_once_keys'</span><span class="main">,</span> <span class="skolem">tuple_since_hist'</span><span class="main">,</span> <span class="skolem">hist_sat'</span><span class="main">,</span> <span class="skolem">since_sat'</span><span class="main">)</span>
     <span class="skolem">auxlist'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def
    <span class="keyword1"><span class="command">using</span></span> valid_update_mmtaux'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> update_eq<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">update_mmtaux_res</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">update_mmtaux_res</span> <span class="main">=</span> update_mmtaux <span class="free">args</span> <span class="free">nt</span> <span class="free">l</span> <span class="free">r</span> <span class="main">(</span><span class="free">cur</span><span class="main">,</span> <span class="free">idx_next</span><span class="main">,</span> <span class="free">idx_mid</span><span class="main">,</span> <span class="free">idx_oldest</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in_once</span><span class="main">,</span> <span class="free">tuple_in_once_keys</span><span class="main">,</span> <span class="free">tuple_since_hist</span><span class="main">,</span> <span class="free">hist_sat</span><span class="main">,</span> <span class="free">since_sat</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">auxlist''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">auxlist''</span> <span class="main">=</span> <span class="skolem">auxlist'</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> data_in'_len_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span> <span class="main">≤</span> length <span class="skolem">auxlist'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> length_filter_le length_map<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> maskL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">maskL</span> <span class="main">=</span> join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> proj_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="free">l</span><span class="main">.</span> <span class="bound">as</span> <span class="main">=</span> proj_tuple <span class="free">maskL</span> <span class="bound">as</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> table_def
    <span class="keyword1"><span class="command">using</span></span> wf_tuple_proj_idle<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"args_n <span class="free">args</span>"</span></span> <span class="quoted"><span class="quoted">"args_L <span class="free">args</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>


  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span>"</span></span><span class="main">)</span>    
    <span class="keyword3"><span class="command">case</span></span> True

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">idx_mid''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx_mid''</span> <span class="main">=</span> <span class="skolem">idx_mid'</span><span class="main">+</span><span class="main">1</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">idx_next''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx_next''</span> <span class="main">=</span> <span class="free">idx_next</span><span class="main">+</span><span class="main">1</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">data_in''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">data_in''</span> <span class="main">=</span> <span class="main">(</span>append_queue <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="skolem">data_in'</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tuple_since_hist''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_since_hist''</span> <span class="main">=</span> Mapping.filter <span class="main">(</span><span class="main">λ</span><span class="bound">as</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">as</span> <span class="main">∈</span> <span class="free">r</span><span class="main">)</span> <span class="skolem">tuple_since_hist'</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tuple_since_hist'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_since_hist'''</span> <span class="main">=</span> upd_set <span class="skolem">tuple_since_hist''</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">idx_mid'</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">-</span> Mapping.keys <span class="skolem">tuple_since_hist''</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">hist_sat''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">hist_sat''</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> is_empty <span class="skolem">data_in'</span> <span class="keyword1">then</span> <span class="free">r</span> <span class="keyword1">else</span> <span class="skolem">hist_sat'</span> <span class="main">∩</span> <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">since_sat''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">since_sat''</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">since_sat'</span> <span class="main">∩</span> <span class="free">r</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="free">r</span><span class="main">.</span> proj_tuple_in_join <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="free">maskL</span> <span class="bound">as</span> <span class="free">l</span><span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> res_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>
        <span class="free">nt</span><span class="main">,</span>
        <span class="skolem">idx_next''</span><span class="main">,</span>
        <span class="skolem">idx_mid''</span><span class="main">,</span>
        <span class="skolem">idx_oldest'</span><span class="main">,</span>
        <span class="free">maskL</span><span class="main">,</span>
        <span class="free">maskR</span><span class="main">,</span>
        <span class="skolem">data_prev'</span><span class="main">,</span>
        <span class="skolem">data_in''</span><span class="main">,</span>
        <span class="skolem">tuple_in_once'</span><span class="main">,</span>
        <span class="skolem">tuple_in_once_keys'</span><span class="main">,</span>
        <span class="skolem">tuple_since_hist'''</span><span class="main">,</span>
        <span class="skolem">hist_sat''</span><span class="main">,</span>
        <span class="skolem">since_sat''</span>
      <span class="main">)</span> <span class="main">=</span> update_mmtaux <span class="free">args</span> <span class="free">nt</span> <span class="free">l</span> <span class="free">r</span> <span class="main">(</span><span class="free">mt</span><span class="main">,</span> <span class="free">idx_next</span><span class="main">,</span> <span class="free">idx_mid</span><span class="main">,</span> <span class="free">idx_oldest</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in_once</span><span class="main">,</span> <span class="free">tuple_in_once_keys</span><span class="main">,</span> <span class="free">tuple_since_hist</span><span class="main">,</span> <span class="free">hist_sat</span><span class="main">,</span> <span class="free">since_sat</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> update_mmtaux_res_def idx_mid''_def idx_next''_def data_in''_def tuple_since_hist'''_def tuple_since_hist''_def hist_sat''_def since_sat''_def
      <span class="keyword1"><span class="command">using</span></span> True
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> update_mmtaux.simps Let_def update_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> auxlist_in_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True
      <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def auxlist''_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> auxlist_prev_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>auxlist_data_prev <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>auxlist_data_prev <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True
      <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_prev_def auxlist''_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="skolem">data_prev'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> memL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="bound">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> lin_data_prev'_eq<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>linearize <span class="skolem">data_prev'</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
      <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_prev_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> data_in'_len<span class="main">:</span><span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">auxlist'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> data_in'_len_leq
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span> <span class="main">=</span> take <span class="main">(</span>length <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> auxlist_in_eq<span class="main">:</span>
      <span class="quoted"><span class="quoted">"auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span> <span class="main">=</span> <span class="skolem">auxlist'</span>"</span></span>
      <span class="quoted"><span class="quoted">"auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span> <span class="main">=</span> <span class="skolem">auxlist'</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> auxlist_in_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span> <span class="main">⟶</span> args_pos <span class="free">args</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">maskL</span> <span class="main">=</span> join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">maskR</span> <span class="main">=</span> join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">relL</span><span class="main">,</span> <span class="bound">relR</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">auxlist''</span><span class="main">.</span> table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="bound">relL</span> <span class="main">∧</span> table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">relR</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">relL</span><span class="main">,</span> <span class="bound">relR</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">auxlist'</span><span class="main">.</span> table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="bound">relL</span> <span class="main">∧</span> table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">relR</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> auxlist''_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Mapping.keys <span class="skolem">tuple_in_once'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Mapping.keys <span class="skolem">tuple_since_hist'''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Mapping.keys <span class="skolem">tuple_since_hist'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Mapping.keys <span class="skolem">tuple_since_hist''</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_hist''_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> New_max.wf_atable_subset keys_filter<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="main">-</span> Mapping.keys <span class="skolem">tuple_since_hist''</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> table_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> DiffD1<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_hist'''_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Mapping_upd_set_keys table_Un<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>relL<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_prev'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>relR<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_prev'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>snd<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>snd<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> data_in''_def append_queue_rep table_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ts_tuple_rel_binary_rhs <span class="main">(</span>set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ts_tuple_rel_binary_rhs <span class="main">(</span>set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ts_tuple_rel_binary_rhs <span class="main">(</span>set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ts_tuple_rel_binary_rhs <span class="main">(</span>set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> ts_tuple_rel_binary_rhs <span class="main">(</span>set <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> auxlist_in_eq
        <span class="keyword1"><span class="command">unfolding</span></span> ts_tuple_rel_f_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> ts_tuple_rel <span class="main">(</span>set <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> data_in''_def ts_tuple_rel_f_def append_queue_rep
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> ts_tuple_rel_f_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="skolem">auxlist''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="skolem">auxlist'</span><span class="main">.</span> time <span class="bound">db</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> auxlist''_def time_def
        <span class="keyword1"><span class="command">using</span></span> sorted_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"map fst <span class="skolem">auxlist'</span>"</span></span> <span class="quoted"><span class="quoted">"map fst <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="skolem">data_prev'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> auxlist_prev_eq
      <span class="keyword1"><span class="command">using</span></span> valid
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True data_in'_len memL
      <span class="keyword1"><span class="command">unfolding</span></span> auxlist''_def data_in''_def append_queue_rep auxlist_data_prev_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="skolem">data_prev'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">idx_mid''</span> <span class="main">=</span> <span class="skolem">idx_next''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid
      <span class="keyword1"><span class="command">unfolding</span></span> idx_mid''_def idx_next''_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> auxlist_in_eq data_in''_def append_queue_rep
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span> <span class="main">=</span> take <span class="main">(</span>length <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist''</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> auxlist_in_eq<span class="main">(</span>2<span class="main">)</span> data_in''_def append_queue_rep
      <span class="keyword1"><span class="command">unfolding</span></span> auxlist''_def
      <span class="keyword1"><span class="command">using</span></span> take_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="skolem">auxlist'</span>"</span></span> <span class="quoted"><span class="skolem">auxlist'</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main">]</span> length_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"linearize <span class="skolem">data_in'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> data_in'_len<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> data_in''_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">idx_oldest'</span> <span class="main">=</span> <span class="skolem">idx_mid''</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">idx_oldest'</span> <span class="main">=</span> <span class="skolem">idx_mid'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> idx_mid''_def data_in''_def append_queue_rep
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="skolem">auxlist''</span><span class="main">.</span> time <span class="bound">db</span> <span class="main">≤</span> <span class="free">nt</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> time <span class="bound">db</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="skolem">auxlist'</span><span class="main">.</span> time <span class="bound">db</span> <span class="main">≤</span> <span class="free">nt</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> time <span class="bound">db</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> auxlist''_def time_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"newest_tuple_in_mapping fst <span class="skolem">data_prev'</span> <span class="skolem">tuple_in_once'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="skolem">tuple_in_once'</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">tuple_in_once'</span> <span class="bound">as</span> <span class="keyword1">of</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="main">∃</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="skolem">data_prev'</span><span class="main">)</span> <span class="main">∧</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="bound">as</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="skolem">tuple_since_hist'''</span> <span class="bound">as</span> <span class="keyword1">of</span>
      Some <span class="bound">idx</span> <span class="main">⇒</span> tuple_since_tp <span class="free">args</span> <span class="bound">as</span> <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span> <span class="skolem">idx_oldest'</span> <span class="skolem">idx_mid''</span> <span class="bound">idx</span>
      <span class="main">|</span> None   <span class="main">⇒</span> <span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span>tuple_since_tp <span class="free">args</span> <span class="bound">as</span> <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span> <span class="skolem">idx_oldest'</span> <span class="skolem">idx_mid''</span> <span class="bound">idx</span><span class="main">)</span>
    <span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> before<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="skolem">tuple_since_hist'</span> <span class="bound">as</span> <span class="keyword1">of</span>
        Some <span class="bound">idx</span> <span class="main">⇒</span> tuple_since_tp <span class="free">args</span> <span class="bound">as</span> <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span> <span class="skolem">idx_oldest'</span> <span class="skolem">idx_mid'</span> <span class="bound">idx</span>
        <span class="main">|</span> None   <span class="main">⇒</span> <span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span>tuple_since_tp <span class="free">args</span> <span class="bound">as</span> <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span> <span class="skolem">idx_oldest'</span> <span class="skolem">idx_mid'</span> <span class="bound">idx</span><span class="main">)</span>
      <span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="skolem">data_in''</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> data_in''_def append_queue_rep
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> data_in''_last<span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> data_in''_def append_queue_rep
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> before_len<span class="main">:</span>
        <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">idx_oldest'</span> <span class="main">=</span> <span class="skolem">idx_mid'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">as</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="skolem">tuple_since_hist'''</span> <span class="skolem">as</span> <span class="keyword1">of</span>
          Some <span class="bound">idx</span> <span class="main">⇒</span> tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span> <span class="skolem">idx_oldest'</span> <span class="skolem">idx_mid''</span> <span class="bound">idx</span>
          <span class="main">|</span> None   <span class="main">⇒</span> <span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span>tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span> <span class="skolem">idx_oldest'</span> <span class="skolem">idx_mid''</span> <span class="bound">idx</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">tuple_since_hist'''</span> <span class="skolem">as</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> None
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
            <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∉</span> <span class="main">(</span><span class="free">r</span> <span class="main">-</span> Mapping.keys <span class="skolem">tuple_since_hist''</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_hist'''_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Mapping_lookup_upd_set option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> hist''<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">tuple_since_hist''</span> <span class="skolem">as</span> <span class="main">=</span> None"</span></span>
            <span class="keyword1"><span class="command">using</span></span> None
            <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_hist'''_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Mapping_lookup_upd_set option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> not_relR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∉</span> <span class="free">r</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keys_is_none_rep<span class="main">)</span>
          
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">idx</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&lt;</span> <span class="skolem">idx_mid''</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest'</span><span class="main">)</span> <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> non_empty data_in''_len
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add_diff_inverse_nat add_less_cancel_left diff_is_0_eq dual_order.strict_iff_order last_drop last_in_set length_drop length_greater_0_conv zero_less_diff<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∉</span> snd <span class="main">(</span>last <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> not_relR data_in''_last
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest'</span><span class="main">)</span> <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span> tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_oldest'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">idx_mid''</span><span class="main">)</span> <span class="bound">idx</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> None <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">idx</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span> <span class="skolem">idx_oldest'</span> <span class="skolem">idx_mid''</span> <span class="skolem">idx</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="main">(</span><span class="free">r</span> <span class="main">-</span> Mapping.keys <span class="skolem">tuple_since_hist''</span><span class="main">)</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> idx_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">=</span> <span class="skolem">idx_mid'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> Some
              <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_hist'''_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_lookup_upd_set<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> drop_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest'</span><span class="main">)</span> <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> data_in''_len
              <span class="keyword1"><span class="command">unfolding</span></span> idx_mid''_def data_in''_def append_queue_rep
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest'</span><span class="main">)</span> <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">y</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> True
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx_oldest'</span> <span class="main">&lt;</span> <span class="skolem">idx</span> <span class="main">⟶</span> <span class="skolem">as</span> <span class="main">∉</span> snd <span class="main">(</span>linearize <span class="skolem">data_in''</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">{</span></span>
                <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx_oldest'</span> <span class="main">&lt;</span> <span class="skolem">idx</span>"</span></span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> before_non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="skolem">data_in'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> before_len idx_eq
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">tuple_since_hist'</span> <span class="skolem">as</span> <span class="main">=</span> None"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> True
                  <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_hist''_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> DiffD1 DiffD2 Mapping_keys_intro Mapping_lookup_filter_Some<span class="main">)</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> not_hist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span> tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span> <span class="skolem">idx_oldest'</span> <span class="skolem">idx_mid'</span> <span class="bound">idx</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> before
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> option.case_eq_if<span class="main">)</span>

                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∉</span> snd <span class="main">(</span>last <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> no_hist_last_not_sat<span class="main">[</span><span class="operator">OF</span> before_len not_hist before_non_empty<span class="main">]</span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∉</span> snd <span class="main">(</span>linearize <span class="skolem">data_in''</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> data_in'_len idx_eq
                  <span class="keyword1"><span class="command">unfolding</span></span> data_in''_def
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_cancel_right' append_eq_conv_conj append_queue_rep assm before_len before_non_empty diff_less last_conv_nth leI not_one_le_zero nth_take zero_less_diff<span class="main">)</span>
              <span class="keyword1"><span class="command">}</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span> <span class="skolem">idx_oldest'</span> <span class="skolem">idx_mid''</span> <span class="skolem">idx</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> non_empty idx_eq
              <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def idx_mid''_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">tuple_since_hist''</span> <span class="skolem">as</span> <span class="main">=</span> Some <span class="skolem">idx</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> Some
              <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_hist'''_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Mapping_lookup_upd_set<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> as_mem<span class="main">:</span>
              <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">∧</span> Mapping.lookup <span class="skolem">tuple_since_hist'</span> <span class="skolem">as</span> <span class="main">=</span> Some <span class="skolem">idx</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_hist''_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Mapping_lookup_filter_None Mapping_lookup_filter_not_None option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tuple_since<span class="main">:</span> <span class="quoted"><span class="quoted">"tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span> <span class="skolem">idx_oldest'</span> <span class="skolem">idx_mid'</span> <span class="skolem">idx</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> before
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> idx_props<span class="main">:</span>
              <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&lt;</span> <span class="skolem">idx_mid'</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest'</span><span class="main">)</span> <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">y</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="skolem">idx_oldest'</span> <span class="main">&lt;</span> <span class="skolem">idx</span> <span class="main">⟶</span> <span class="skolem">as</span> <span class="main">∉</span> snd <span class="main">(</span>linearize <span class="skolem">data_in'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest'</span> <span class="main">≤</span> length <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> before_len idx_props<span class="main">(</span>1<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest'</span><span class="main">)</span> <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="bound">y</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> idx_props<span class="main">(</span>2<span class="main">)</span> as_mem
              <span class="keyword1"><span class="command">unfolding</span></span> data_in''_def append_queue_rep
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linearize <span class="skolem">data_in''</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> linearize <span class="skolem">data_in'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">idx</span> <span class="main">-</span> <span class="skolem">idx_oldest'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> before_len idx_props
              <span class="keyword1"><span class="command">unfolding</span></span> data_in''_def append_queue_rep
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> diff_is_0_eq idx_append not_le_imp_less length_greater_0_conv less_diff_conv2 less_imp_diff_less less_or_eq_imp_le tuple_since tuple_since_tp_def<span class="main">)</span>

            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_since_tp <span class="free">args</span> <span class="skolem">as</span> <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span> <span class="skolem">idx_oldest'</span> <span class="skolem">idx_mid''</span> <span class="skolem">idx</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> non_empty idx_props
              <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_tp_def idx_mid''_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> Some
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="skolem">hist_sat''</span> <span class="main">⟷</span>
        <span class="main">(</span><span class="main">¬</span>is_empty <span class="skolem">data_in''</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>
          <span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="bound">r</span>
      <span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> before<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="skolem">hist_sat'</span> <span class="main">⟷</span>
        <span class="main">(</span><span class="main">¬</span>is_empty <span class="skolem">data_in'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>
          <span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="bound">r</span>
      <span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tuple</span>

        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"is_empty <span class="skolem">data_in'</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> valid
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assm is_empty_alt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">data_in'</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> auxlist_in_eq
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> empty_data_in'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_empty <span class="skolem">data_in'</span> <span class="main">⟶</span> auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="skolem">hist_sat''</span> <span class="main">⟷</span>
          <span class="main">(</span><span class="main">¬</span>is_empty <span class="skolem">data_in''</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>
            <span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">r</span>
        <span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="skolem">hist_sat''</span>"</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span>is_empty <span class="skolem">data_in''</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>
              <span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">r</span>
          <span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_empty <span class="skolem">data_in'</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tuple_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="free">r</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> assm
              <span class="keyword1"><span class="command">unfolding</span></span> hist_sat''_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> empty_data_in' True tuple_mem
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linearize <span class="skolem">data_in''</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> data_in''_def append_queue_rep
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> is_empty_alt
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tuple_mem<span class="main">:</span>
              <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="skolem">hist_sat'</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="free">r</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> assm
              <span class="keyword1"><span class="command">unfolding</span></span> hist_sat''_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span>is_empty <span class="skolem">data_in'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>
                <span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">r</span>
            <span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> before
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> tuple_mem<span class="main">(</span>2<span class="main">)</span>
              <span class="keyword1"><span class="command">unfolding</span></span> auxlist_in_eq set_append
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linearize <span class="skolem">data_in'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> props is_empty_alt
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linearize <span class="skolem">data_in''</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> data_in''_def append_queue_rep
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> all is_empty_alt
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span>is_empty <span class="skolem">data_in''</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>
              <span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">r</span>
          <span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="skolem">hist_sat''</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_empty <span class="skolem">data_in'</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="free">r</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> assm empty_data_in'
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> hist_sat''_def
              <span class="keyword1"><span class="command">using</span></span> True
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tuple_mem<span class="main">:</span>
              <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="free">r</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">r</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> assm auxlist_in_eq
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="skolem">hist_sat'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> before False
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> hist_sat''_def
              <span class="keyword1"><span class="command">using</span></span> False tuple_mem<span class="main">(</span>1<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="skolem">since_sat''</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">(</span><span class="bound">tuple</span> <span class="main">∈</span> <span class="skolem">hist_sat''</span><span class="main">)</span> <span class="main">∨</span> tuple_since_lhs <span class="bound">tuple</span> <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span><span class="main">)</span>
      <span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> before<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="skolem">since_sat'</span> <span class="main">⟶</span>
          <span class="main">(</span><span class="main">(</span><span class="bound">tuple</span> <span class="main">∈</span> <span class="skolem">hist_sat'</span><span class="main">)</span> <span class="main">∨</span> tuple_since_lhs <span class="bound">tuple</span> <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span><span class="main">)</span>
        <span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid
        <span class="keyword1"><span class="command">unfolding</span></span> valid_mmtaux.simps
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tuple</span>
        <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="skolem">since_sat''</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="skolem">data_in''</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> data_in''_def append_queue_rep
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">since_sat'</span> <span class="main">∩</span> <span class="free">r</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="free">r</span><span class="main">.</span> proj_tuple_in_join <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="free">maskL</span> <span class="bound">as</span> <span class="free">l</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assm since_sat''_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">since_sat'</span> <span class="main">∩</span> <span class="free">r</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="skolem">hist_sat'</span> <span class="main">∨</span> tuple_since_lhs <span class="skolem">tuple</span> <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> before
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> hist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="skolem">hist_sat'</span>"</span></span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="skolem">hist_sat'</span> <span class="main">⟷</span>
              <span class="main">(</span><span class="main">¬</span>is_empty <span class="skolem">data_in'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>
                <span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="bound">r</span>
            <span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> valid
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span>is_empty <span class="skolem">data_in'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="skolem">hist_sat''</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> assm hist
              <span class="keyword1"><span class="command">unfolding</span></span> hist_sat''_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> since<span class="main">:</span> <span class="quoted"><span class="quoted">"tuple_since_lhs <span class="skolem">tuple</span> <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linearize <span class="skolem">data_in'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_lhs_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n_props<span class="main">:</span>
              <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span><span class="main">}</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">suffix</span> <span class="main">=</span> drop <span class="skolem">n</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="bound">suffix</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="bound">suffix</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> since
              <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_lhs_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> valid
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> length_map
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> n_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> n_props<span class="main">(</span>1<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> auxlist_in_eq
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> drop_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="skolem">n</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span> <span class="main">=</span> drop <span class="skolem">n</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">suffix</span> <span class="main">=</span> drop <span class="skolem">n</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="bound">suffix</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="bound">suffix</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> n_props<span class="main">(</span>2<span class="main">)</span> n_le len_eq assm
              <span class="keyword1"><span class="command">unfolding</span></span> drop_eq Let_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> n_props<span class="main">(</span>1<span class="main">)</span>
              <span class="keyword1"><span class="command">unfolding</span></span> data_in''_def append_queue_rep
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_since_lhs <span class="skolem">tuple</span> <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> non_empty
              <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_lhs_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="skolem">hist_sat''</span> <span class="main">∨</span> tuple_since_lhs <span class="skolem">tuple</span> <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="free">r</span><span class="main">.</span> proj_tuple_in_join <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="free">maskL</span> <span class="bound">as</span> <span class="free">l</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tuple_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"proj_tuple_in_join <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="free">maskL</span> <span class="skolem">tuple</span> <span class="free">l</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> drop_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="skolem">n</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> n_def
            <span class="keyword1"><span class="command">using</span></span> auxlist_in_eq
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">y</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> drop_eq tuple_props
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> tuple_props
            <span class="keyword1"><span class="command">unfolding</span></span> drop_eq relL_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> proj_tuple_in_join_def<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> valid
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> auxlist_in_eq length_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">unfolding</span></span> data_in''_def append_queue_rep n_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_since_lhs <span class="skolem">tuple</span> <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> non_empty
            <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_lhs_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="skolem">hist_sat''</span> <span class="main">∨</span> tuple_since_lhs <span class="skolem">tuple</span> <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> tuple_since_lhs <span class="bound">tuple</span> <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="bound">tuple</span> <span class="main">∈</span> <span class="skolem">since_sat''</span>
      <span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> before<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> tuple_since_lhs <span class="bound">tuple</span> <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="bound">tuple</span> <span class="main">∈</span> <span class="skolem">since_sat'</span>
      <span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tuple</span>
        <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"tuple_since_lhs <span class="skolem">tuple</span> <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"linearize <span class="skolem">data_in''</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_lhs_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n_props<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>linearize <span class="skolem">data_in''</span><span class="main">)</span><span class="main">}</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">suffix</span> <span class="main">=</span> drop <span class="skolem">n</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="bound">suffix</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="bound">suffix</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assm
          <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_lhs_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> n_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>drop <span class="skolem">n</span> <span class="skolem">auxlist'</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> data_in'_len
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>drop <span class="skolem">n</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> auxlist_in_eq Let_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> data_in'_len<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">suffix</span> <span class="main">=</span> drop <span class="skolem">n</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="bound">suffix</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">∈</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span>relL <span class="main">(</span>hd <span class="bound">suffix</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> n_props<span class="main">(</span>2<span class="main">)</span> n_l
            <span class="keyword1"><span class="command">unfolding</span></span> auxlist_in_eq Let_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linearize <span class="skolem">data_in'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> n_l
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="skolem">since_sat'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> n_l before
            <span class="keyword1"><span class="command">unfolding</span></span> tuple_since_lhs_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="free">r</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> n_l n_props auxlist_in_eq
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> data_in'_len<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="skolem">since_sat'</span> <span class="main">∩</span> <span class="free">r</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∉</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> n_props
            <span class="keyword1"><span class="command">unfolding</span></span> data_in''_def append_queue_rep
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> valid
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="skolem">n</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> auxlist_in_eq length_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="free">l</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> n_props<span class="main">(</span>2<span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span> relL_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">as</span></span> <span class="main">∈</span> <span class="free">r</span><span class="main">.</span> proj_tuple_in_join <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="free">maskL</span> <span class="bound">as</span> <span class="free">l</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> proj_tuple_in_join_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="skolem">since_sat''</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> since_sat''_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_in_once_keys'</span> <span class="main">=</span> Mapping.keys <span class="skolem">tuple_in_once'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> time_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> res_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> auxlist''_def auxlist'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> valid_mmtaux.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">data_prev''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">data_prev''</span> <span class="main">=</span> <span class="main">(</span>append_queue <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="skolem">data_prev'</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">idx_next''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">idx_next''</span> <span class="main">=</span> <span class="free">idx_next</span><span class="main">+</span><span class="main">1</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tuple_in_once''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_in_once''</span> <span class="main">=</span> upd_set <span class="skolem">tuple_in_once'</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">nt</span><span class="main">)</span> <span class="free">l</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tuple_in_once_keys''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_in_once_keys''</span> <span class="main">=</span> <span class="skolem">tuple_in_once_keys'</span> <span class="main">∪</span> <span class="free">l</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> auxlist_in_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False
      <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_in_def auxlist''_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> auxlist_prev_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>auxlist_data_prev <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>auxlist_data_prev <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False
      <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_prev_def auxlist''_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> res_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>
        <span class="free">nt</span><span class="main">,</span>
        <span class="skolem">idx_next''</span><span class="main">,</span>
        <span class="skolem">idx_mid'</span><span class="main">,</span>
        <span class="skolem">idx_oldest'</span><span class="main">,</span>
        <span class="free">maskL</span><span class="main">,</span>
        <span class="free">maskR</span><span class="main">,</span>
        <span class="skolem">data_prev''</span><span class="main">,</span>
        <span class="skolem">data_in'</span><span class="main">,</span>
        <span class="skolem">tuple_in_once''</span><span class="main">,</span>
        <span class="skolem">tuple_in_once_keys''</span><span class="main">,</span>
        <span class="skolem">tuple_since_hist'</span><span class="main">,</span>
        <span class="skolem">hist_sat'</span><span class="main">,</span>
        <span class="skolem">since_sat'</span>
      <span class="main">)</span> <span class="main">=</span> update_mmtaux <span class="free">args</span> <span class="free">nt</span> <span class="free">l</span> <span class="free">r</span> <span class="main">(</span><span class="free">mt</span><span class="main">,</span> <span class="free">idx_next</span><span class="main">,</span> <span class="free">idx_mid</span><span class="main">,</span> <span class="free">idx_oldest</span><span class="main">,</span> <span class="free">maskL</span><span class="main">,</span> <span class="free">maskR</span><span class="main">,</span> <span class="free">data_prev</span><span class="main">,</span> <span class="free">data_in</span><span class="main">,</span> <span class="free">tuple_in_once</span><span class="main">,</span> <span class="free">tuple_in_once_keys</span><span class="main">,</span> <span class="free">tuple_since_hist</span><span class="main">,</span> <span class="free">hist_sat</span><span class="main">,</span> <span class="free">since_sat</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> update_mmtaux_res_def data_prev''_def idx_next''_def tuple_in_once''_def tuple_in_once_keys''_def
      <span class="keyword1"><span class="command">using</span></span> False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> update_mmtaux.simps Let_def update_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">0</span> <span class="main">⟶</span> args_pos <span class="free">args</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">maskL</span> <span class="main">=</span> join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">maskR</span> <span class="main">=</span> join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">relL</span><span class="main">,</span> <span class="bound">relR</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">auxlist''</span><span class="main">.</span> table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="bound">relL</span> <span class="main">∧</span> table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">relR</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">relL</span><span class="main">,</span> <span class="bound">relR</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">auxlist'</span><span class="main">.</span> table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="bound">relL</span> <span class="main">∧</span> table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">relR</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> auxlist''_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> table_in_once''<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Mapping.keys <span class="skolem">tuple_in_once''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Mapping.keys <span class="skolem">tuple_in_once'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> tuple_in_once''_def
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_upd_set_keys<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Mapping.keys <span class="skolem">tuple_since_hist'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> data_prev''_relL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>relL<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_prev''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>relL<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_prev'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> data_prev''_def append_queue_rep relL_def table_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>relR<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_prev''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>relR<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_prev'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> data_prev''_def append_queue_rep relR_def table_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span>snd<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">as</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ts_tuple_rel_binary_rhs <span class="main">(</span>set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      ts_tuple_rel <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> auxlist_in_eq
      <span class="keyword1"><span class="command">using</span></span> valid
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="skolem">auxlist''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="skolem">auxlist'</span><span class="main">.</span> time <span class="bound">db</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> auxlist''_def time_def
        <span class="keyword1"><span class="command">using</span></span> sorted_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"map fst <span class="skolem">auxlist'</span>"</span></span> <span class="quoted"><span class="quoted">"map fst <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> data_prev''_auxlist<span class="main">:</span> <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="skolem">data_prev''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="skolem">data_prev'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> False
        <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_prev_def auxlist''_def data_prev''_def append_queue_rep
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist''</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> False data_in'_len_leq
        <span class="keyword1"><span class="command">unfolding</span></span> auxlist''_def auxlist_data_prev_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="skolem">data_prev''</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">idx_mid'</span> <span class="main">=</span> <span class="skolem">idx_next''</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="skolem">data_prev'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">idx_mid'</span> <span class="main">=</span> <span class="free">idx_next</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> data_prev''_def idx_next''_def append_queue_rep
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> auxlist_in_eq
      <span class="keyword1"><span class="command">using</span></span> valid
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span> <span class="main">=</span> take <span class="main">(</span>length <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist''</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span> <span class="main">=</span> take <span class="main">(</span>length <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> data_in'_len_leq False
        <span class="keyword1"><span class="command">unfolding</span></span> auxlist''_def auxlist_data_in_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">idx_oldest'</span> <span class="main">=</span> <span class="skolem">idx_mid'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="skolem">auxlist''</span><span class="main">.</span> time <span class="bound">db</span> <span class="main">≤</span> <span class="free">nt</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> time <span class="bound">db</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="skolem">auxlist'</span><span class="main">.</span> time <span class="bound">db</span> <span class="main">≤</span> <span class="free">nt</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> time <span class="bound">db</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> auxlist''_def time_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"newest_tuple_in_mapping fst <span class="skolem">data_prev''</span> <span class="skolem">tuple_in_once''</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> before<span class="main">:</span> <span class="quoted"><span class="quoted">"newest_tuple_in_mapping fst <span class="skolem">data_prev'</span> <span class="skolem">tuple_in_once'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> True<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tuple</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option list"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="skolem">tuple</span>"</span></span>

        <span class="keyword1"><span class="command">have</span></span> ts_rel_union<span class="main">:</span> <span class="quoted"><span class="quoted">"ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_prev''</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_prev'</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> ts_tuple_rel_f_def data_prev''_def append_queue_rep
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">have</span></span> tuple_not_mem_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∉</span> <span class="free">l</span> <span class="main">⟶</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">assume</span></span> tuple_not_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∉</span> <span class="free">l</span>"</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> True <span class="main">∧</span> proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> as_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">as</span><span class="main">)</span> <span class="main">∈</span> ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"proj_tuple <span class="free">maskL</span> <span class="skolem">tuple</span> <span class="main">=</span> <span class="skolem">as</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> as_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">=</span> <span class="skolem">as</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> maskL wf_tuple_proj_idle<span class="main">[</span><span class="operator">OF</span> wf<span class="main">]</span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="skolem">l'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l'</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> as_props 
                <span class="keyword1"><span class="command">unfolding</span></span> ts_tuple_rel_f_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="free">l</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
                <span class="keyword1"><span class="command">using</span></span> as_eq tuple_not_mem
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">tuple_in_once''</span> <span class="skolem">tuple</span> <span class="main">=</span> safe_max <span class="main">(</span>fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_prev''</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">tuple_in_once''</span> <span class="skolem">tuple</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> None
          <span class="keyword1"><span class="command">have</span></span> tuple_not_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∉</span> <span class="free">l</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> None
            <span class="keyword1"><span class="command">unfolding</span></span> tuple_in_once''_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Mapping_lookup_upd_set option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">tuple_in_once'</span> <span class="skolem">tuple</span> <span class="main">=</span> None"</span></span>
            <span class="keyword1"><span class="command">using</span></span> None
            <span class="keyword1"><span class="command">unfolding</span></span> tuple_in_once''_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Mapping_lookup_upd_set option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_prev'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> before
            <span class="keyword1"><span class="command">unfolding</span></span> newest_tuple_in_mapping_def safe_max_def
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">tas</span> <span class="main">∈</span> ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_prev'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">≠</span> snd <span class="bound">tas</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_prev''</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> tuple_not_mem tuple_not_mem_empty
            <span class="keyword1"><span class="command">unfolding</span></span> data_prev''_def append_queue_rep ts_tuple_rel_f_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> None
            <span class="keyword1"><span class="command">unfolding</span></span> safe_max_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">t</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="free">l</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="free">nt</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> Some
              <span class="keyword1"><span class="command">unfolding</span></span> tuple_in_once''_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_lookup_upd_set<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="skolem">tuple</span><span class="main">)</span> <span class="main">∈</span> ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> True
              <span class="keyword1"><span class="command">unfolding</span></span> ts_tuple_rel_f_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="skolem">tuple</span><span class="main">)</span> <span class="main">∈</span> ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_prev''</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> ts_rel_union
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> nt_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nt</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_prev''</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> proj_l True
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> fst_conv imageI mem_Collect_eq snd_conv<span class="main">)</span>

            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_prev''</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> ts_tuple_rel_f_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_prev'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword1"><span class="command">have</span></span>
                <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="skolem">auxlist'</span><span class="main">.</span> time <span class="bound">db</span> <span class="main">≤</span> <span class="free">nt</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> time <span class="bound">db</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="quoted"><span class="quoted">"auxlist_data_prev <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span> <span class="main">=</span> <span class="main">(</span>linearize <span class="skolem">data_prev'</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> valid
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="skolem">data_prev'</span><span class="main">)</span><span class="main">.</span> time <span class="bound">db</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> auxlist_data_prev_def
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Set.member_filter filter_set<span class="main">)</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> time_def ts_tuple_rel_f_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_prev''</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> ts_rel_union
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> <span class="main">(</span>fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_prev''</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_prev''</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">nt</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> nt_mem
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Max_eqI finite_nat_set_iff_bounded_le<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> Some t_eq non_empty
              <span class="keyword1"><span class="command">unfolding</span></span> safe_max_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">tuple_in_once''</span> <span class="skolem">tuple</span> <span class="main">=</span> Mapping.lookup <span class="skolem">tuple_in_once'</span> <span class="skolem">tuple</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> Some
              <span class="keyword1"><span class="command">unfolding</span></span> tuple_in_once''_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_lookup_upd_set<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_prev''</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span> <span class="main">=</span> fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_prev'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> False tuple_not_mem_empty ts_rel_union
              <span class="keyword1"><span class="command">unfolding</span></span> ts_tuple_rel_f_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> before
              <span class="keyword1"><span class="command">unfolding</span></span> newest_tuple_in_mapping_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">tuple</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option list"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="skolem">tuple</span>"</span></span>

        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lookup<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">tuple_in_once''</span> <span class="skolem">tuple</span> <span class="main">=</span> None"</span></span>
          <span class="keyword1"><span class="command">using</span></span> table_in_once''
          <span class="keyword1"><span class="command">unfolding</span></span> table_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Mapping_keys_intro<span class="main">)</span>

        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_prev''</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">∈</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="skolem">data_prev''</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> ts_tuple_rel_f_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="skolem">tuple</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> data_prev''_relL
            <span class="keyword1"><span class="command">unfolding</span></span> relL_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
            <span class="keyword1"><span class="command">using</span></span> wf
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_prev''</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">tuple_in_once''</span> <span class="skolem">tuple</span> <span class="main">=</span> safe_max <span class="main">(</span>fst <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">tas</span></span> <span class="main">∈</span> ts_tuple_rel_binary_lhs <span class="main">(</span>set <span class="main">(</span>linearize <span class="skolem">data_prev''</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">tuple</span> <span class="main">=</span> snd <span class="bound">tas</span><span class="main">}</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> lookup
          <span class="keyword1"><span class="command">unfolding</span></span> safe_max_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> newest_tuple_in_mapping_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="skolem">tuple_in_once''</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">tuple_in_once''</span> <span class="bound">as</span> <span class="keyword1">of</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="main">∃</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="skolem">data_prev''</span><span class="main">)</span> <span class="main">∧</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="bound">as</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> before<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span> <span class="main">∈</span> Mapping.keys <span class="skolem">tuple_in_once'</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">tuple_in_once'</span> <span class="bound">as</span> <span class="keyword1">of</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="main">∃</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="skolem">data_prev'</span><span class="main">)</span> <span class="main">∧</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="bound">as</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">as</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> Mapping.keys <span class="skolem">tuple_in_once''</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_props<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">tuple_in_once''</span> <span class="skolem">as</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Mapping_keys_dest<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> Mapping.lookup <span class="skolem">tuple_in_once''</span> <span class="skolem">as</span> <span class="keyword1">of</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="main">∃</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="skolem">data_prev''</span><span class="main">)</span> <span class="main">∧</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> <span class="free">l</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="free">nt</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> t_props
            <span class="keyword1"><span class="command">unfolding</span></span> tuple_in_once''_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_lookup_upd_set<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> tlr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="skolem">data_prev''</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> data_prev''_def append_queue_rep
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"args_pos <span class="free">args</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> valid False
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"proj_tuple <span class="free">maskL</span> <span class="skolem">as</span> <span class="main">∈</span> <span class="free">l</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> True proj_l
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="free">l</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> pos
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> t_props tlr pos t_eq
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">tuple_in_once''</span> <span class="skolem">as</span> <span class="main">=</span> Mapping.lookup <span class="skolem">tuple_in_once'</span> <span class="skolem">as</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> tuple_in_once''_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_lookup_upd_set<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>linearize <span class="skolem">data_prev'</span><span class="main">)</span> <span class="main">∧</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="bound">l</span> <span class="main">(</span>proj_tuple <span class="free">maskL</span> <span class="skolem">as</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> before t_props
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Mapping_keys_intro option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> t_props
            <span class="keyword1"><span class="command">unfolding</span></span> data_prev''_def append_queue_rep
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">as</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="skolem">tuple_since_hist'</span> <span class="bound">as</span> <span class="keyword1">of</span>
      Some <span class="bound">idx</span> <span class="main">⇒</span> tuple_since_tp <span class="free">args</span> <span class="bound">as</span> <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span> <span class="skolem">idx_oldest'</span> <span class="skolem">idx_mid'</span> <span class="bound">idx</span>
      <span class="main">|</span> None   <span class="main">⇒</span> <span class="main">∀</span><span class="bound">idx</span><span class="main">.</span> <span class="main">¬</span>tuple_since_tp <span class="free">args</span> <span class="bound">as</span> <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span> <span class="skolem">idx_oldest'</span> <span class="skolem">idx_mid'</span> <span class="bound">idx</span><span class="main">)</span>
    <span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="skolem">hist_sat'</span> <span class="main">⟷</span>
        <span class="main">(</span><span class="main">¬</span>is_empty <span class="skolem">data_in'</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>
          <span class="main">∀</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="bound">r</span>
      <span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> auxlist_in_eq
      <span class="keyword1"><span class="command">using</span></span> valid
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="skolem">since_sat'</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">(</span><span class="bound">tuple</span> <span class="main">∈</span> <span class="skolem">hist_sat'</span><span class="main">)</span> <span class="main">∨</span> tuple_since_lhs <span class="bound">tuple</span> <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span><span class="main">)</span>
      <span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> <span class="bound">tuple</span> <span class="main">∈</span> <span class="skolem">since_sat'</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">(</span><span class="bound">tuple</span> <span class="main">∈</span> <span class="skolem">hist_sat'</span><span class="main">)</span> <span class="main">∨</span> tuple_since_lhs <span class="bound">tuple</span> <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span><span class="main">)</span>
      <span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid
        <span class="keyword1"><span class="command">unfolding</span></span> valid_mmtaux.simps
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> auxlist_in_eq
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">tuple</span><span class="main">.</span> tuple_since_lhs <span class="bound">tuple</span> <span class="main">(</span>linearize <span class="skolem">data_in'</span><span class="main">)</span> <span class="free">args</span> <span class="free">maskL</span> <span class="main">(</span>auxlist_data_in <span class="free">args</span> <span class="free">nt</span> <span class="skolem">auxlist''</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="bound">tuple</span> <span class="main">∈</span> <span class="skolem">since_sat'</span>
      <span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> auxlist_in_eq
      <span class="keyword1"><span class="command">using</span></span> valid
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_in_once_keys''</span> <span class="main">=</span> Mapping.keys <span class="skolem">tuple_in_once''</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple_in_once_keys'</span> <span class="main">=</span> Mapping.keys <span class="skolem">tuple_in_once'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> tuple_in_once_keys''_def tuple_in_once''_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_upd_set_keys<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="main">≤</span> <span class="free">nt</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> time_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> res_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> auxlist''_def auxlist'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> valid_mmtaux.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_update_mmtaux<span class="main">:</span> <span class="quoted"><span class="quoted">"
    <span class="free">nt</span> <span class="main">≥</span> <span class="free">cur</span> <span class="main">⟹</span>
    table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="free">l</span> <span class="main">⟹</span>
    table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="free">r</span> <span class="main">⟹</span>
    valid_mmtaux <span class="free">args</span> <span class="free">cur</span> <span class="free">aux</span> <span class="free">auxlist</span> <span class="main">⟹</span>
    valid_mmtaux
      <span class="free">args</span>
      <span class="free">nt</span>
      <span class="main">(</span>update_mmtaux <span class="free">args</span> <span class="free">nt</span> <span class="free">l</span> <span class="free">r</span> <span class="free">aux</span><span class="main">)</span>
      <span class="main">(</span><span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
  "</span></span>
  <span class="keyword1"><span class="command">using</span></span> valid_update_mmtaux_unfolded
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">aux</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fast</span><span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> mmtaux<span class="main">:</span> mtaux <span class="quoted">valid_mmtaux</span> <span class="quoted">init_mmtaux</span> <span class="quoted">update_mmtaux</span> <span class="quoted">result_mmtaux</span>
  <span class="keyword1"><span class="command">using</span></span> valid_init_mmtaux valid_update_mmtaux valid_result_mmtaux
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</body>

</html>