<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Monitor</title>
</head>


<body>
<div class="head">
<h1>Theory Monitor</h1>
</div>

<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Monitor
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="Formula.html">Formula</a>
    <a href="Optimized_Join.html">Optimized_Join</a>
    <span class="quoted">"<a href="../MFOTL_Monitor_Devel/Abstract_Monitor.html">MFOTL_Monitor_Devel.Abstract_Monitor</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/While_Combinator.html">HOL-Library.While_Combinator</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Mapping.html">HOL-Library.Mapping</a>"</span>
    <span class="quoted">"<a href="../Deriving/Derive.html">Deriving.Derive</a>"</span>
    <span class="quoted">"<a href="../Generic_Join_Devel/Generic_Join_Correctness.html">Generic_Join_Devel.Generic_Join_Correctness</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Generic monitoring algorithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The algorithm defined here abstracts over the implementation of the temporal operators.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Monitorable formulas›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⟷</span> safe_formula <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> Formula.future_bounded <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_regex</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟷</span> safe_regex <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> Regex.pred_regex Formula.future_bounded <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_simple_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Formula.trm <span class="main">⇒</span> Formula.trm <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_simple_eq</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span>Formula.is_Const <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">∧</span> <span class="main">(</span>Formula.is_Const <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">∨</span> Formula.is_Var <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">∨</span>
    Formula.is_Var <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">∧</span> Formula.is_Const <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">)</span> <span class="entity">mmonitorable_exec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Formula.formula <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>Formula.Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> is_simple_eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>Formula.Neg <span class="main">(</span>Formula.Eq <span class="main">(</span>Formula.Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>Formula.Pred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> list_all <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> Formula.is_Var <span class="bound">t</span> <span class="main">∨</span> Formula.is_Const <span class="bound">t</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>Formula.Let <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>Formula.nfv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">}</span> <span class="main">⊆</span> Formula.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>Formula.Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> <span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>Formula.Or <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span> <span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>Formula.And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span>
    <span class="main">(</span>safe_assignment <span class="main">(</span>fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∨</span> <span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∨</span>
      fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">⊆</span> fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="main">(</span>is_constraint <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">of</span> Formula.Neg <span class="bound">ψ'</span> <span class="main">⇒</span> <span class="free">mmonitorable_exec</span> <span class="bound">ψ'</span>
        <span class="main">|</span> <span class="main">(</span>Formula.Trigger <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">)</span> <span class="main">⇒</span> safe_formula_dual True <span class="free">mmonitorable_exec</span> <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span>
        <span class="main">|</span> <span class="main">(</span>Formula.Release <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>
          bounded <span class="bound">I</span> <span class="main">∧</span> <span class="main">¬</span>mem <span class="bound">I</span> <span class="main">0</span> <span class="main">∧</span>
          <span class="free">mmonitorable_exec</span> <span class="bound">φ'</span> <span class="main">∧</span> <span class="free">mmonitorable_exec</span> <span class="bound">ψ'</span> <span class="main">∧</span> fv <span class="bound">φ'</span> <span class="main">=</span> fv <span class="bound">ψ'</span> <span class="main">∧</span>
          <span class="free">mmonitorable_exec</span> <span class="main">(</span>and_release_safe_bounded <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">)</span>
        <span class="main">)</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False
      <span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>Formula.Ands <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">pos</span><span class="main">,</span> <span class="bound">neg</span><span class="main">)</span> <span class="main">=</span> partition <span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">in</span>
    <span class="bound">pos</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> list_all <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span>
        <span class="main">(</span>Formula.Neg <span class="bound">φ'</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">mmonitorable_exec</span> <span class="bound">φ'</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free">mmonitorable_exec</span> <span class="bound">φ</span>
      <span class="main">)</span>
    <span class="main">)</span> <span class="bound">neg</span> <span class="main">∧</span>
    <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map fv <span class="bound">neg</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span>set <span class="main">(</span>map fv <span class="bound">pos</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>Formula.Exists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>Formula.Agg <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∉</span> Formula.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">}</span> <span class="main">⊆</span> Formula.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> Formula.fv_trm <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⊆</span> Formula.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>Formula.Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>Formula.Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>Formula.Since <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Formula.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⊆</span> Formula.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span> Formula.Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="free">mmonitorable_exec</span> <span class="bound">φ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>Formula.Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Formula.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⊆</span> Formula.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span> bounded <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span> Formula.Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="free">mmonitorable_exec</span> <span class="bound">φ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>Formula.Trigger <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> safe_formula_dual False <span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>Formula.Release <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">0</span> <span class="main">∧</span> bounded <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span> <span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span> fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⊆</span> fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span> <span class="free">mmonitorable_exec</span> <span class="main">(</span>release_safe_0 <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>Formula.MatchP <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Regex.safe_regex Formula.fv <span class="main">(</span><span class="main">λ</span><span class="bound">g</span> <span class="bound">φ</span><span class="main">.</span> <span class="free">mmonitorable_exec</span> <span class="bound">φ</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">g</span> <span class="main">=</span> Lax <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span> Formula.Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="free">mmonitorable_exec</span> <span class="bound">φ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span> Past Strict <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>Formula.MatchF <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Regex.safe_regex Formula.fv <span class="main">(</span><span class="main">λ</span><span class="bound">g</span> <span class="bound">φ</span><span class="main">.</span> <span class="free">mmonitorable_exec</span> <span class="bound">φ</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">g</span> <span class="main">=</span> Lax <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span> Formula.Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="free">mmonitorable_exec</span> <span class="bound">φ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span> Futu Strict <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> bounded <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command">using</span></span> size'_and_release size'_Release size'_Or size'_release_aux
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure size'"</span></span><span class="main">)</span> 
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Nat.less_Suc_eq_le release_safe_0_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_list_mem_leq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">size'</span><span class="main"><span class="main">]</span></span> regex_atms_size'<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> cases_Neg_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="free">φ</span> <span class="keyword1">of</span> formula.Neg <span class="bound">ψ</span> <span class="main">⇒</span> <span class="free">P</span> <span class="bound">ψ</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ψ</span><span class="main">.</span> <span class="free">φ</span> <span class="main">=</span> formula.Neg <span class="bound">ψ</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> safe_formula_mmonitorable_exec<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span> <span class="main">⟹</span> Formula.future_bounded <span class="free">φ</span> <span class="main">⟹</span> mmonitorable_exec <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> safe_formula.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>9 <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fv <span class="skolem">ψ</span> <span class="main">⊆</span> fv <span class="skolem">φ</span> <span class="main">∧</span> <span class="main">(</span>is_constraint <span class="skolem">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">ψ</span> <span class="keyword1">of</span> Formula.Neg <span class="bound">ψ'</span> <span class="main">⇒</span> safe_formula <span class="bound">ψ'</span>
      <span class="main">|</span> <span class="main">(</span>Formula.Trigger <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">)</span> <span class="main">⇒</span> safe_formula_dual True safe_formula <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span>
      <span class="main">|</span> <span class="main">(</span>Formula.Release <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>
        bounded <span class="bound">I</span> <span class="main">∧</span> <span class="main">¬</span>mem <span class="bound">I</span> <span class="main">0</span> <span class="main">∧</span>
        safe_formula <span class="bound">φ'</span> <span class="main">∧</span> safe_formula <span class="bound">ψ'</span> <span class="main">∧</span> fv <span class="bound">φ'</span> <span class="main">=</span> fv <span class="bound">ψ'</span> <span class="main">∧</span>
        safe_formula <span class="main">(</span>and_release_safe_bounded <span class="skolem">φ</span> <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">)</span>
      <span class="main">)</span>
      <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False
    <span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fvs<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="skolem">ψ</span> <span class="main">⊆</span> fv <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> True 9
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_constraint <span class="skolem">ψ</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ψ_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="skolem">ψ</span> <span class="keyword1">of</span> Formula.Neg <span class="bound">ψ'</span> <span class="main">⇒</span> safe_formula <span class="bound">ψ'</span>
        <span class="main">|</span> <span class="main">(</span>Formula.Trigger <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">)</span> <span class="main">⇒</span> safe_formula_dual True safe_formula <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span>
        <span class="main">|</span> <span class="main">(</span>Formula.Release <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>
          bounded <span class="bound">I</span> <span class="main">∧</span> <span class="main">¬</span>mem <span class="bound">I</span> <span class="main">0</span> <span class="main">∧</span>
          safe_formula <span class="bound">φ'</span> <span class="main">∧</span> safe_formula <span class="bound">ψ'</span> <span class="main">∧</span> fv <span class="bound">φ'</span> <span class="main">=</span> fv <span class="bound">ψ'</span> <span class="main">∧</span>
          safe_formula <span class="main">(</span>and_release_safe_bounded <span class="skolem">φ</span> <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">)</span>
        <span class="main">)</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False
      <span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">ψ</span> <span class="keyword1">of</span> Formula.Neg <span class="bound">ψ'</span> <span class="main">⇒</span> safe_formula <span class="bound">ψ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ψ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">=</span> Formula.Neg <span class="skolem">ψ'</span>"</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">ψ'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>formula.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 9 ψ_props <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> f1<span class="main">:</span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">ψ</span> <span class="keyword1">of</span> Formula.Trigger <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span> <span class="main">⇒</span> safe_formula_dual True safe_formula <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ'</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">ψ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">=</span> Formula.Trigger <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span>"</span></span> <span class="quoted"><span class="quoted">"safe_formula_dual True safe_formula <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> ψ_props
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>formula.splits<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 9 ψ_props <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_formula_dual_def<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ'</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">ψ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> release_props<span class="main">:</span>
            <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">=</span> Formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span>"</span></span>
            <span class="quoted"><span class="quoted">"bounded <span class="skolem">I</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="skolem">I</span> <span class="main">0</span>"</span></span>
            <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">φ'</span>"</span></span>
            <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">ψ'</span>"</span></span>
            <span class="quoted"><span class="quoted">"fv <span class="skolem">φ'</span> <span class="main">=</span> fv <span class="skolem">ψ'</span>"</span></span>
            <span class="quoted"><span class="quoted">"safe_formula <span class="main">(</span>and_release_safe_bounded <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> f1 ψ_props
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>formula.splits<span class="main">)</span>
          
          <span class="keyword1"><span class="command">have</span></span> safe<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="main">(</span>and_release_safe_bounded <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> and_release_safe_bounded_def
            <span class="keyword1"><span class="command">using</span></span> safe_formula_release_bounded release_props fvs release_fvi<span class="main">(</span>2<span class="main">)</span> 9<span class="main">(</span>8<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          
          <span class="keyword1"><span class="command">have</span></span> bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.future_bounded <span class="main">(</span>and_release_safe_bounded <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> release_bounded_future_bounded<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">φ'</span></span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="skolem">ψ'</span></span><span class="main">]</span> release_props<span class="main">(</span>1-3<span class="main">)</span> 9<span class="main">(</span>9<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> and_release_safe_bounded_def<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mmonitorable_exec <span class="main">(</span>and_release_safe_bounded <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 9<span class="main">(</span>7<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> release_props<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> safe bounded<span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 9 release_props <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_assignment_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>10 <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"10.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.future_bounded <span class="skolem">φ</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">φ</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list.pred_set<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">poss</span></span> <span class="skolem"><span class="skolem">negs</span></span> <span class="keyword2"><span class="keyword">where</span></span> posnegs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">poss</span><span class="main">,</span> <span class="skolem">negs</span><span class="main">)</span> <span class="main">=</span> partition safe_formula <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">posm</span></span> <span class="skolem"><span class="skolem">negm</span></span> <span class="keyword2"><span class="keyword">where</span></span> posnegm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">posm</span><span class="main">,</span> <span class="skolem">negm</span><span class="main">)</span> <span class="main">=</span> partition mmonitorable_exec <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">poss</span> <span class="main">⊆</span> set <span class="skolem">posm</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">poss</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> posnegs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mmonitorable_exec <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"10.hyps"</span><span class="main">(</span>1<span class="main">)</span> bounded <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">posm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">poss</span>›</span></span> posnegm posnegs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">negm</span> <span class="main">⊆</span> set <span class="skolem">negs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> posnegm posnegs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> s_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">poss</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span>
        Formula.Neg <span class="bound">φ'</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> safe_formula <span class="bound">φ</span>
      <span class="main">)</span>
    <span class="main">)</span> <span class="skolem">negs</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">negs</span><span class="main">.</span> fv <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">poss</span><span class="main">.</span> fv <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"10.prems"</span><span class="main">(</span>1<span class="main">)</span> posnegs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">posm</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">poss</span> <span class="main">⊆</span> set <span class="skolem">posm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span>
        Formula.Neg <span class="bound">φ'</span> <span class="main">⇒</span> mmonitorable_exec <span class="bound">φ'</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> mmonitorable_exec <span class="bound">φ</span>
      <span class="main">)</span>
    <span class="main">)</span> <span class="skolem">negm</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span><span class="main">.</span> <span class="bound">φ</span> <span class="main">∈</span> set <span class="skolem">negm</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span>
        Formula.Neg <span class="bound">φ'</span> <span class="main">⇒</span> mmonitorable_exec <span class="bound">φ'</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> mmonitorable_exec <span class="bound">φ</span>
      <span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">negm</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> x_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">negs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">negm</span> <span class="main">⊆</span> set <span class="skolem">negs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> x_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="skolem">x</span> <span class="keyword1">of</span>
          Formula.Neg <span class="bound">φ'</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span>
          <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> safe_formula <span class="skolem">x</span>
        <span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> s_props<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_def<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">x</span> <span class="keyword1">of</span>
        Formula.Neg <span class="bound">φ'</span> <span class="main">⇒</span> mmonitorable_exec <span class="bound">φ'</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> mmonitorable_exec <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> Formula.Neg <span class="bound">z</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Formula.Neg <span class="skolem">z</span>"</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"10.hyps"</span><span class="main">(</span>7<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> posnegs refl x_mem z_props<span class="main">]</span> posnegs bounded<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> x_mem
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> not_neg<span class="main">:</span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> safe<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> not_neg x_props
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> x_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">l</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> posnegs x_mem
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mmonitorable_exec <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 10<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> x_mem safe<span class="main">]</span> posnegs bounded<span class="main">[</span><span class="operator">OF</span> x_mem<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">negm</span>›</span></span> posnegm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">negm</span><span class="main">.</span> fv <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span>set <span class="skolem">posm</span><span class="main">.</span> fv <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋃</span> <span class="main">(</span>fv <span class="main">`</span> set <span class="skolem">negs</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span> <span class="main">(</span>fv <span class="main">`</span> set <span class="skolem">poss</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">poss</span> <span class="main">⊆</span> set <span class="skolem">posm</span>›</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">negm</span> <span class="main">⊆</span> set <span class="skolem">negs</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> posnegm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>19 <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> safe_regex_mono<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cases_Neg_iff regex.pred_set<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>20 <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> safe_regex_mono<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cases_Neg_iff regex.pred_set<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_simple_eq_def list.pred_set cases_Neg_iff safe_formula_dual_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> safe_assignment_future_bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_assignment <span class="free">X</span> <span class="free">φ</span> <span class="main">⟹</span> Formula.future_bounded <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> safe_assignment_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_constraint_future_bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"is_constraint <span class="free">φ</span> <span class="main">⟹</span> Formula.future_bounded <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> is_constraint.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> mmonitorable_exec_mmonitorable<span class="main">:</span> <span class="quoted"><span class="quoted">"mmonitorable_exec <span class="free">φ</span> <span class="main">⟹</span> mmonitorable <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mmonitorable_exec.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ψ'</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> Formula.Neg <span class="bound">ψ'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 7
      <span class="keyword1"><span class="command">unfolding</span></span> mmonitorable_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> safe_assignment_future_bounded is_constraint_future_bounded<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> non_neg<span class="main">:</span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> Formula.Trigger <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ'</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">ψ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ψ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">=</span> Formula.Trigger <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> 7<span class="main">(</span>1-2<span class="main">,</span>8<span class="main">)</span> 7<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ψ_def<span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> mmonitorable_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_assignment_def safe_formula_dual_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_constraint_future_bounded<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> no_trigger<span class="main">:</span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> Formula.Release <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ'</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">ψ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ψ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">=</span> Formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> φ_props<span class="main">:</span> <span class="quoted"><span class="quoted">"mmonitorable <span class="skolem">φ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 7<span class="main">(</span>1<span class="main">,</span>8<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mmonitorable_exec <span class="skolem">ψ</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ψ_props<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">ψ</span> <span class="main">∧</span> Formula.future_bounded <span class="skolem">ψ</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 7<span class="main">(</span>2<span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span> mmonitorable_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"bounded <span class="skolem">I</span>"</span></span> <span class="quoted"><span class="quoted">"fv <span class="skolem">φ'</span> <span class="main">⊆</span> fv <span class="skolem">ψ'</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> ψ_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> φ_props ψ_props
            <span class="keyword1"><span class="command">unfolding</span></span> mmonitorable_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_assignment_def<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="skolem">φ</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 7<span class="main">(</span>8<span class="main">)</span> φ_props
            <span class="keyword1"><span class="command">unfolding</span></span> mmonitorable_exec.simps ψ_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_assignment_def<span class="main">)</span>

          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded <span class="skolem">I</span> <span class="main">∧</span> <span class="main">¬</span>mem <span class="skolem">I</span> <span class="main">0</span> <span class="main">∧</span>
            mmonitorable_exec <span class="skolem">φ'</span> <span class="main">∧</span> mmonitorable_exec <span class="skolem">ψ'</span> <span class="main">∧</span> fv <span class="skolem">φ'</span> <span class="main">=</span> fv <span class="skolem">ψ'</span> <span class="main">∧</span>
            mmonitorable_exec <span class="main">(</span>and_release_safe_bounded <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 7<span class="main">(</span>8<span class="main">)</span> False
            <span class="keyword1"><span class="command">unfolding</span></span> ψ_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_assignment_def<span class="main">)</span>
         
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> 7<span class="main">(</span>5-7<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ψ_def<span class="main">]</span> φ_props
            <span class="keyword1"><span class="command">unfolding</span></span> mmonitorable_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ψ_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mmonitorable_exec <span class="skolem">φ</span> <span class="main">∧</span> <span class="main">(</span>safe_assignment <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">ψ</span> <span class="main">∨</span> mmonitorable_exec <span class="skolem">ψ</span> <span class="main">∨</span> fv <span class="skolem">ψ</span> <span class="main">⊆</span> fv <span class="skolem">φ</span> <span class="main">∧</span> is_constraint <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> non_neg no_trigger 7<span class="main">(</span>8<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> non_neg 7
          <span class="keyword1"><span class="command">unfolding</span></span> mmonitorable_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> safe_assignment_future_bounded is_constraint_future_bounded<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>8 <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">poss</span></span> <span class="skolem"><span class="skolem">negs</span></span> <span class="keyword2"><span class="keyword">where</span></span> posnegs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">poss</span><span class="main">,</span> <span class="skolem">negs</span><span class="main">)</span> <span class="main">=</span> partition safe_formula <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">posm</span></span> <span class="skolem"><span class="skolem">negm</span></span> <span class="keyword2"><span class="keyword">where</span></span> posnegm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">posm</span><span class="main">,</span> <span class="skolem">negm</span><span class="main">)</span> <span class="main">=</span> partition mmonitorable_exec <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> pos_monitorable<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all mmonitorable_exec <span class="skolem">posm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> posnegm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> neg_monitorable<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span>
        <span class="main">(</span>Formula.Neg <span class="bound">φ'</span><span class="main">)</span> <span class="main">⇒</span> mmonitorable_exec <span class="bound">φ'</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> mmonitorable_exec <span class="bound">φ</span>
      <span class="main">)</span>
    <span class="main">)</span> <span class="skolem">negm</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"8.prems"</span> posnegm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">posm</span> <span class="main">⊆</span> set <span class="skolem">poss</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"8.hyps"</span><span class="main">(</span>1<span class="main">)</span> posnegs posnegm <span class="keyword1"><span class="command">unfolding</span></span> mmonitorable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> neg_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">negs</span> <span class="main">⊆</span> set <span class="skolem">negm</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> posnegs posnegm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> list_all_mmonitorable<span class="main">:</span>
    <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span>
        <span class="main">(</span>Formula.Neg <span class="bound">φ'</span><span class="main">)</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> safe_formula <span class="bound">φ</span>
      <span class="main">)</span>
    <span class="main">)</span> <span class="skolem">negm</span>"</span></span>
    <span class="quoted"><span class="quoted">"list_all Formula.future_bounded <span class="skolem">negm</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span>
      <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">negm</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">φ</span> <span class="keyword1">of</span>
        <span class="main">(</span>Formula.Neg <span class="bound">φ'</span><span class="main">)</span> <span class="main">⇒</span> mmonitorable <span class="bound">φ'</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> mmonitorable <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">φ'</span><span class="main">.</span> <span class="skolem">φ</span> <span class="main">=</span> Formula.Neg <span class="bound">φ'</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> φ_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">=</span> Formula.Neg <span class="skolem">φ'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mmonitorable_exec <span class="skolem">φ'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> neg_monitorable assm
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> 8<span class="main">(</span>7<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> posnegm refl _ φ_def<span class="main">]</span> assm φ_def
          <span class="keyword1"><span class="command">unfolding</span></span> mmonitorable_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> no_neg<span class="main">:</span> False
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">φ</span> <span class="keyword1">of</span>
          <span class="main">(</span>Formula.Neg <span class="bound">φ'</span><span class="main">)</span> <span class="main">⇒</span> mmonitorable_exec <span class="bound">φ'</span>
          <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> mmonitorable_exec <span class="skolem">φ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> neg_monitorable assm
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mmonitorable_exec <span class="skolem">φ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> no_neg neg_monitorable assm
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mmonitorable <span class="skolem">φ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 8<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> assm posnegm
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> no_neg <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> φ_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">φ</span> <span class="main">∈</span> set <span class="skolem">negm</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span>
      <span class="main">(</span>Formula.Neg <span class="bound">φ'</span><span class="main">)</span> <span class="main">⇒</span> mmonitorable <span class="bound">φ'</span>
      <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> mmonitorable <span class="bound">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">negm</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> φ_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">φ</span> <span class="keyword1">of</span>
        <span class="main">(</span>Formula.Neg <span class="bound">φ'</span><span class="main">)</span> <span class="main">⇒</span> mmonitorable <span class="bound">φ'</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> mmonitorable <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> φ_props
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">φ</span> <span class="keyword1">of</span>
      <span class="main">(</span>Formula.Neg <span class="bound">φ'</span><span class="main">)</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span>
      <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> safe_formula <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> safe_formula_dual_impl<span class="main">[</span><span class="operator">of</span> <span class="quoted">mmonitorable</span> <span class="quoted">safe_formula</span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> mmonitorable_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">φ</span> <span class="keyword1">of</span>
      <span class="main">(</span>Formula.Neg <span class="bound">φ'</span><span class="main">)</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span>
      <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> safe_formula <span class="bound">φ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">negm</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">negm</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> φ_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">φ</span> <span class="keyword1">of</span>
        <span class="main">(</span>Formula.Neg <span class="bound">φ'</span><span class="main">)</span> <span class="main">⇒</span> mmonitorable <span class="bound">φ'</span>
        <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> mmonitorable <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> φ_props
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> trigger_future_bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">I</span> <span class="bound">ψ</span><span class="main">.</span> safe_formula_dual True Formula.future_bounded <span class="bound">φ</span> <span class="bound">I</span> <span class="bound">ψ</span> <span class="main">⟹</span> Formula.future_bounded <span class="main">(</span>Formula.Trigger <span class="bound">φ</span> <span class="bound">I</span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> safe_formula_dual_def mmonitorable_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits formula.splits<span class="main">)</span>

      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.future_bounded <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> φ_props
        <span class="keyword1"><span class="command">unfolding</span></span> mmonitorable_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all Formula.future_bounded <span class="skolem">negm</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>


  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">poss</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"8.prems"</span> posnegm <span class="quoted"><span class="quoted">‹set <span class="skolem">posm</span> <span class="main">⊆</span> set <span class="skolem">poss</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>fv <span class="main">`</span> set <span class="skolem">negm</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span> <span class="main">(</span>fv <span class="main">`</span> set <span class="skolem">posm</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"8.prems"</span> posnegm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>fv <span class="main">`</span> set <span class="skolem">negs</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span> <span class="main">(</span>fv <span class="main">`</span> set <span class="skolem">poss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">posm</span> <span class="main">⊆</span> set <span class="skolem">poss</span>›</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">negs</span> <span class="main">⊆</span> set <span class="skolem">negm</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="main">(</span>Formula.Ands <span class="skolem">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> posnegs list_all_mmonitorable<span class="main">(</span>1<span class="main">)</span> neg_subset
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.future_bounded <span class="main">(</span>Formula.Ands <span class="skolem">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all Formula.future_bounded <span class="skolem">posm</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pos_monitorable <span class="quoted">"8.hyps"</span><span class="main">(</span>1<span class="main">)</span> posnegm <span class="keyword1"><span class="command">unfolding</span></span> mmonitorable_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.pred_mono_strong<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all Formula.future_bounded <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> list_all_mmonitorable<span class="main">(</span>2<span class="main">)</span> posnegm
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mmonitorable_def <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>13 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mmonitorable_def mmonitorable_exec.simps safe_formula.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cases_Neg_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>14 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mmonitorable_def mmonitorable_exec.simps safe_formula.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> one_enat_def cases_Neg_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>15 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> mem<span class="main">:</span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 15
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cases_Neg_iff mmonitorable_def safe_formula_dual_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 15
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cases_Neg_iff mmonitorable_def safe_formula_dual_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>16 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> mem<span class="main">:</span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 16
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cases_Neg_iff mmonitorable_def safe_formula_dual_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 16
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cases_Neg_iff mmonitorable_def safe_formula_dual_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>17 <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> safe_regex_mono<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> safe_regex_safe<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmonitorable_regex_def mmonitorable_def cases_Neg_iff regex.pred_set<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>18 <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> safe_regex_mono<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> safe_regex_safe<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmonitorable_regex_def mmonitorable_def cases_Neg_iff regex.pred_set<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mmonitorable_def mmonitorable_regex_def is_simple_eq_def one_enat_def list.pred_set <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> monitorable_formula_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mmonitorable <span class="free">φ</span> <span class="main">=</span> mmonitorable_exec <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mmonitorable_exec_mmonitorable safe_formula_mmonitorable_exec mmonitorable_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Handling regular expressions›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> mregex <span class="main">=</span>
  MSkip <span class="quoted">nat</span>
  <span class="main">|</span> MTestPos <span class="quoted">nat</span>
  <span class="main">|</span> MTestNeg <span class="quoted">nat</span>
  <span class="main">|</span> MPlus <span class="quoted">mregex</span> <span class="quoted">mregex</span>
  <span class="main">|</span> MTimes <span class="quoted">mregex</span> <span class="quoted">mregex</span>
  <span class="main">|</span> MStar <span class="quoted">mregex</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">ok</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ok</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>MSkip <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ok</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>MTestPos <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ok</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>MTestNeg <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ok</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>MPlus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ok</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="free">ok</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ok</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>MTimes <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ok</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="free">ok</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ok</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>MStar <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">ok</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">from_mregex</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">from_mregex</span> <span class="main">(</span>MSkip <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> Regex.Skip <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">from_mregex</span> <span class="main">(</span>MTestPos <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">=</span> Regex.Test <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">from_mregex</span> <span class="main">(</span>MTestNeg <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> safe_formula <span class="main">(</span>Formula.Neg <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">then</span> Regex.Test <span class="main">(</span>Formula.Neg <span class="main">(</span>Formula.Neg <span class="main">(</span>Formula.Neg <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> Regex.Test <span class="main">(</span>Formula.Neg <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">from_mregex</span> <span class="main">(</span>MPlus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">=</span> Regex.Plus <span class="main">(</span><span class="free">from_mregex</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">from_mregex</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">from_mregex</span> <span class="main">(</span>MTimes <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">=</span> Regex.Times <span class="main">(</span><span class="free">from_mregex</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">from_mregex</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">from_mregex</span> <span class="main">(</span>MStar <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">=</span> Regex.Star <span class="main">(</span><span class="free">from_mregex</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">to_mregex_exec</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">to_mregex_exec</span> <span class="main">(</span>Regex.Skip <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span>MSkip <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">to_mregex_exec</span> <span class="main">(</span>Regex.Test <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> safe_formula <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>MTestPos <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">]</span><span class="main">)</span>
     <span class="keyword1">else</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span> Formula.Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="main">(</span>MTestNeg <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="bound">φ'</span><span class="main">]</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">(</span>MSkip <span class="main">0</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">to_mregex_exec</span> <span class="main">(</span>Regex.Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">mr</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">=</span> <span class="free">to_mregex_exec</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span> <span class="main">(</span><span class="bound">ms</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">=</span> <span class="free">to_mregex_exec</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">ys</span>
     <span class="keyword1">in</span> <span class="main">(</span>MPlus <span class="bound">mr</span> <span class="bound">ms</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">to_mregex_exec</span> <span class="main">(</span>Regex.Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">mr</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">=</span> <span class="free">to_mregex_exec</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span> <span class="main">(</span><span class="bound">ms</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">=</span> <span class="free">to_mregex_exec</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">ys</span>
     <span class="keyword1">in</span> <span class="main">(</span>MTimes <span class="bound">mr</span> <span class="bound">ms</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">to_mregex_exec</span> <span class="main">(</span>Regex.Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">mr</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">=</span> <span class="free">to_mregex_exec</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">in</span> <span class="main">(</span>MStar <span class="bound">mr</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">shift</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">shift</span> <span class="main">(</span>MSkip <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> MSkip <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">shift</span> <span class="main">(</span>MTestPos <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> MTestPos <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">shift</span> <span class="main">(</span>MTestNeg <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> MTestNeg <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">shift</span> <span class="main">(</span>MPlus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> MPlus <span class="main">(</span><span class="free">shift</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">shift</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">shift</span> <span class="main">(</span>MTimes <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> MTimes <span class="main">(</span><span class="free">shift</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">shift</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">shift</span> <span class="main">(</span>MStar <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> MStar <span class="main">(</span><span class="free">shift</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">to_mregex</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">to_mregex</span> <span class="main">(</span>Regex.Skip <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>MSkip <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">to_mregex</span> <span class="main">(</span>Regex.Test <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> safe_formula <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>MTestPos <span class="main">0</span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">]</span><span class="main">)</span>
     <span class="keyword1">else</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span> Formula.Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="main">(</span>MTestNeg <span class="main">0</span><span class="main">,</span> <span class="main">[</span><span class="bound">φ'</span><span class="main">]</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">(</span>MSkip <span class="main">0</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">to_mregex</span> <span class="main">(</span>Regex.Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">mr</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">=</span> <span class="free">to_mregex</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span> <span class="main">(</span><span class="bound">ms</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">=</span> <span class="free">to_mregex</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
     <span class="keyword1">in</span> <span class="main">(</span>MPlus <span class="bound">mr</span> <span class="main">(</span>shift <span class="bound">ms</span> <span class="main">(</span>length <span class="bound">ys</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">ys</span> <span class="main">@</span> <span class="bound">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">to_mregex</span> <span class="main">(</span>Regex.Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">mr</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">=</span> <span class="free">to_mregex</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span> <span class="main">(</span><span class="bound">ms</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">=</span> <span class="free">to_mregex</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>
     <span class="keyword1">in</span> <span class="main">(</span>MTimes <span class="bound">mr</span> <span class="main">(</span>shift <span class="bound">ms</span> <span class="main">(</span>length <span class="bound">ys</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">ys</span> <span class="main">@</span> <span class="bound">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">to_mregex</span> <span class="main">(</span>Regex.Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">mr</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">=</span> <span class="free">to_mregex</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">in</span> <span class="main">(</span>MStar <span class="bound">mr</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> shift_0<span class="main">:</span> <span class="quoted"><span class="quoted">"shift <span class="free">r</span> <span class="main">0</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> shift_shift<span class="main">:</span> <span class="quoted"><span class="quoted">"shift <span class="main">(</span>shift <span class="free">r</span> <span class="free">k</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> shift <span class="free">r</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> to_mregex_to_mregex_exec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> to_mregex <span class="free">r</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">mr</span><span class="main">,</span> <span class="bound">φs</span><span class="main">)</span> <span class="main">⇒</span> to_mregex_exec <span class="free">r</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span>shift <span class="bound">mr</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span><span class="main">,</span> <span class="free">xs</span> <span class="main">@</span> <span class="bound">φs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_shift <span class="dynamic"><span class="dynamic">ac_simps</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> to_mregex_to_mregex_exec_Nil<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"to_mregex <span class="free">r</span> <span class="main">=</span> to_mregex_exec <span class="free">r</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> to_mregex_to_mregex_exec<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> xs<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> r <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shift_0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ok_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"ok <span class="free">m</span> <span class="free">mr</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> ok <span class="free">n</span> <span class="free">mr</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">mr</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> from_mregex_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"ok <span class="free">m</span> <span class="free">mr</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> from_mregex <span class="free">mr</span> <span class="free">xs</span> <span class="main">=</span> from_mregex <span class="free">mr</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">mr</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> not_Neg_cases<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span><span class="main">.</span> <span class="free">φ</span> <span class="main">≠</span> Formula.Neg <span class="bound">ψ</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">φ</span> <span class="keyword1">of</span> formula.Neg <span class="bound">ψ</span> <span class="main">⇒</span> <span class="free">f</span> <span class="bound">ψ</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> to_mregex_exec_ok<span class="main">:</span>
  <span class="quoted"><span class="quoted">"to_mregex_exec <span class="free">r</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="free">mr</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">zs</span><span class="main">.</span> <span class="free">ys</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">@</span> <span class="bound">zs</span> <span class="main">∧</span> set <span class="bound">zs</span> <span class="main">=</span> atms <span class="free">r</span> <span class="main">∧</span> ok <span class="main">(</span>length <span class="free">ys</span><span class="main">)</span> <span class="free">mr</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">mr</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Skip <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atms_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ok_mono<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Test <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x'</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> Formula.Neg <span class="bound">x'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> Test <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atms_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ok_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> Test <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atms_def not_Neg_cases <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ok_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits formula.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atms_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ok_mono<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Times <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits formula.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atms_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ok_mono<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atms_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ok_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ok_shift<span class="main">:</span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span>Monitor.shift <span class="free">r</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟷</span> ok <span class="free">m</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> to_mregex_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"to_mregex <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">mr</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> set <span class="free">ys</span> <span class="main">=</span> atms <span class="free">r</span> <span class="main">∧</span> ok <span class="main">(</span>length <span class="free">ys</span><span class="main">)</span> <span class="free">mr</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mr</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Skip <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atms_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ok_mono <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Test <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x'</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> Formula.Neg <span class="bound">x'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> Test <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atms_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ok_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> Test <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atms_def not_Neg_cases <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ok_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ok_shift atms_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ok_mono <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Times <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ok_shift atms_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ok_mono <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atms_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ok_mono <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> from_mregex_shift<span class="main">:</span> <span class="quoted"><span class="quoted">"from_mregex <span class="main">(</span>shift <span class="free">r</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> from_mregex <span class="free">r</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> from_mregex_to_mregex<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex <span class="free">m</span> <span class="free">g</span> <span class="free">r</span> <span class="main">⟹</span> case_prod from_mregex <span class="main">(</span>to_mregex <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> safe_regex.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> to_mregex_ok <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> from_mregex_cong <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append from_mregex_shift cases_Neg_iff
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits modality.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> from_mregex_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex <span class="free">m</span> <span class="free">g</span> <span class="free">r</span> <span class="main">⟹</span> to_mregex <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">mr</span><span class="main">,</span> <span class="free">φs</span><span class="main">)</span> <span class="main">⟹</span> from_mregex <span class="free">mr</span> <span class="free">φs</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> from_mregex_to_mregex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> from_mregex_to_mregex_exec<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex <span class="free">m</span> <span class="free">g</span> <span class="free">r</span> <span class="main">⟹</span> case_prod from_mregex <span class="main">(</span>to_mregex_exec <span class="free">r</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> safe_regex_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">b</span> <span class="skolem">g</span> <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Plus<span class="main">(</span>3<span class="main">)</span> Plus<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span> Plus<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>to_mregex_exec <span class="skolem">r</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> to_mregex_exec_ok
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> from_mregex_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>snd <span class="main">(</span>to_mregex_exec <span class="skolem">r</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>TimesF <span class="skolem">g</span> <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> TimesF<span class="main">(</span>3<span class="main">)</span> TimesF<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span> TimesF<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>to_mregex_exec <span class="skolem">r</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> to_mregex_exec_ok
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> from_mregex_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>snd <span class="main">(</span>to_mregex_exec <span class="skolem">r</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>TimesP <span class="skolem">g</span> <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> TimesP<span class="main">(</span>3<span class="main">)</span> TimesP<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span> TimesP<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>to_mregex_exec <span class="skolem">r</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> to_mregex_exec_ok
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> from_mregex_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>snd <span class="main">(</span>to_mregex_exec <span class="skolem">r</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Star <span class="skolem">b</span> <span class="skolem">g</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Star<span class="main">(</span>2<span class="main">)</span> Star<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cases_Neg_iff<span class="main">)</span>


<span class="keyword1"><span class="command">derive</span></span> linorder <span class="quoted">mregex</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹LPD›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">saturate</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">saturate</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> while <span class="main">(</span><span class="main">λ</span><span class="bound">S</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">S</span> <span class="main">≠</span> <span class="bound">S</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> saturate_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"saturate <span class="free">f</span> <span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">S'</span> <span class="main">=</span> <span class="free">f</span> <span class="free">S</span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">S'</span> <span class="main">=</span> <span class="free">S</span> <span class="keyword1">then</span> <span class="free">S</span> <span class="keyword1">else</span> saturate <span class="free">f</span> <span class="bound">S'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> saturate_def Let_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> while_unfold<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">MTimesL</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> MTimes <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">MTimesR</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> MTimes <span class="bound">r</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">LPD</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LPD</span> <span class="main">(</span>MSkip <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="main">{}</span> <span class="main">|</span> Suc <span class="bound">m</span> <span class="main">⇒</span> <span class="main">{</span>MSkip <span class="bound">m</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">LPD</span> <span class="main">(</span>MTestPos <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">LPD</span> <span class="main">(</span>MTestNeg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">LPD</span> <span class="main">(</span>MPlus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">LPD</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∪</span> <span class="free">LPD</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">LPD</span> <span class="main">(</span>MTimes <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> MTimesR <span class="main">(</span><span class="free">LPD</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∪</span> <span class="free">LPD</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">LPD</span> <span class="main">(</span>MStar <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> MTimesR <span class="main">(</span><span class="free">LPD</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>MStar <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">LPDi</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LPDi</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">LPDi</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">s</span> <span class="main">∈</span> LPD <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">.</span> <span class="free">LPDi</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LPDi_Suc_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"LPDi <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">s</span> <span class="main">∈</span> LPDi <span class="free">i</span> <span class="free">r</span><span class="main">.</span> LPD <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">LPDs</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> LPDi <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LPDs_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> LPDs <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LPDs_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> LPDs_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> LPD <span class="free">s</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">∈</span> LPDs <span class="free">t</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∈</span> LPDs <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LPDs_def LPDi_Suc_alt <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> LPDi.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LPDi_Test<span class="main">:</span>
  <span class="quoted"><span class="quoted">"LPDi <span class="free">i</span> <span class="main">(</span>MSkip <span class="main">0</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>MSkip <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="quoted"><span class="quoted">"LPDi <span class="free">i</span> <span class="main">(</span>MTestPos <span class="free">φ</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>MTestPos <span class="free">φ</span><span class="main">}</span>"</span></span>
  <span class="quoted"><span class="quoted">"LPDi <span class="free">i</span> <span class="main">(</span>MTestNeg <span class="free">φ</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>MTestNeg <span class="free">φ</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> LPDs_Test<span class="main">:</span>
  <span class="quoted"><span class="quoted">"LPDs <span class="main">(</span>MSkip <span class="main">0</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>MSkip <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="quoted"><span class="quoted">"LPDs <span class="main">(</span>MTestPos <span class="free">φ</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>MTestPos <span class="free">φ</span><span class="main">}</span>"</span></span>
  <span class="quoted"><span class="quoted">"LPDs <span class="main">(</span>MTestNeg <span class="free">φ</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>MTestNeg <span class="free">φ</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> LPDs_def <span class="keyword1"><span class="command">using</span></span> LPDi_Test <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LPDi_MSkip<span class="main">:</span> <span class="quoted"><span class="quoted">"LPDi <span class="free">i</span> <span class="main">(</span>MSkip <span class="free">n</span><span class="main">)</span> <span class="main">⊆</span> MSkip <span class="main">`</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> LPDi_Test<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_Suc_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LPDs_MSkip<span class="main">:</span> <span class="quoted"><span class="quoted">"LPDs <span class="main">(</span>MSkip <span class="free">n</span><span class="main">)</span> <span class="main">⊆</span> MSkip <span class="main">`</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> LPDs_def <span class="keyword1"><span class="command">using</span></span> LPDi_MSkip <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> LPDi_Plus<span class="main">:</span> <span class="quoted"><span class="quoted">"LPDi <span class="free">i</span> <span class="main">(</span>MPlus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>MPlus <span class="free">r</span> <span class="free">s</span><span class="main">}</span> <span class="main">∪</span> LPDi <span class="free">i</span> <span class="free">r</span> <span class="main">∪</span> LPDi <span class="free">i</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> LPDs_Plus<span class="main">:</span> <span class="quoted"><span class="quoted">"LPDs <span class="main">(</span>MPlus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>MPlus <span class="free">r</span> <span class="free">s</span><span class="main">}</span> <span class="main">∪</span> LPDs <span class="free">r</span> <span class="main">∪</span> LPDs <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> LPDs_def <span class="keyword1"><span class="command">using</span></span> LPDi_Plus<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> LPDi_Times<span class="main">:</span>
  <span class="quoted"><span class="quoted">"LPDi <span class="free">i</span> <span class="main">(</span>MTimes <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>MTimes <span class="free">r</span> <span class="free">s</span><span class="main">}</span> <span class="main">∪</span> MTimesR <span class="main">(</span><span class="main">⋃</span><span class="bound">j</span> <span class="main">≤</span> <span class="free">i</span><span class="main">.</span> LPDi <span class="bound">j</span> <span class="free">r</span><span class="main">)</span> <span class="free">s</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">j</span> <span class="main">≤</span> <span class="free">i</span><span class="main">.</span> LPDi <span class="bound">j</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MTimesR_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> bspec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> set_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Suc<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> LPDs_Times<span class="main">:</span> <span class="quoted"><span class="quoted">"LPDs <span class="main">(</span>MTimes <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>MTimes <span class="free">r</span> <span class="free">s</span><span class="main">}</span> <span class="main">∪</span> MTimesR <span class="main">(</span>LPDs <span class="free">r</span><span class="main">)</span> <span class="free">s</span> <span class="main">∪</span> LPDs <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> LPDs_def <span class="keyword1"><span class="command">using</span></span> LPDi_Times<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MTimesR_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LPDi_Star<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟹</span> LPDi <span class="free">j</span> <span class="main">(</span>MStar <span class="free">r</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>MStar <span class="free">r</span><span class="main">}</span> <span class="main">∪</span> MTimesR <span class="main">(</span><span class="main">⋃</span><span class="bound">j</span> <span class="main">≤</span> <span class="free">i</span><span class="main">.</span> LPDi <span class="bound">j</span> <span class="free">r</span><span class="main">)</span> <span class="main">(</span>MStar <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 5 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MTimesR_def image_iff le_Suc_eq
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> bspec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span>"</span></span><span class="main"><span class="main">]</span></span> bspec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> set_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Suc<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> set_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> LPDi_Times<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> LPDs_Star<span class="main">:</span> <span class="quoted"><span class="quoted">"LPDs <span class="main">(</span>MStar <span class="free">r</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>MStar <span class="free">r</span><span class="main">}</span> <span class="main">∪</span> MTimesR <span class="main">(</span>LPDs <span class="free">r</span><span class="main">)</span> <span class="main">(</span>MStar <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> LPDs_def <span class="keyword1"><span class="command">using</span></span> LPDi_Star<span class="main">[</span><span class="operator">OF</span> order_refl<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MTimesR_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_LPDs<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>LPDs <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MSkip <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> LPDs_MSkip<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MTestPos <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> LPDs_Test<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MTestNeg <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> LPDs_Test<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MPlus <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> LPDs_Plus<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MTimes <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> LPDs_Times<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MTimesR_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MStar <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> LPDs_Star<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MTimesR_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">addLPD</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">S</span><span class="main">.</span> insert <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">S</span> <span class="main">∪</span> Set.bind <span class="main">(</span>insert <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">S</span><span class="main">)</span> LPD"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> mono_addLPD<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span>addLPD <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mono_def Set.bind_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> LPDs_aux1<span class="main">:</span> <span class="quoted"><span class="quoted">"lfp <span class="main">(</span>addLPD <span class="free">r</span><span class="main">)</span> <span class="main">⊆</span> LPDs <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lfp_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mono_addLPD<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> LPDs_refl LPDs_trans <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Set.bind_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> LPDs_aux2<span class="main">:</span> <span class="quoted"><span class="quoted">"LPDi <span class="free">i</span> <span class="free">r</span> <span class="main">⊆</span> lfp <span class="main">(</span>addLPD <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lfp_unfold<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mono_addLPD<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lfp_unfold<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mono_addLPD<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LPDi_Suc_alt <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> LPDi.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LPDs_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"LPDs <span class="free">r</span> <span class="main">=</span> lfp <span class="main">(</span>addLPD <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> LPDs_aux1 LPDs_aux2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LPDs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LPDs_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"LPDs <span class="free">r</span> <span class="main">=</span> saturate <span class="main">(</span>addLPD <span class="free">r</span><span class="main">)</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> LPDs_alt saturate_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lfp_while<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mono_addLPD _ finite_LPDs<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">r</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> LPDs_refl LPDs_trans Set.bind_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹RPD›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">RPD</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">RPD</span> <span class="main">(</span>MSkip <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="main">{}</span> <span class="main">|</span> Suc <span class="bound">m</span> <span class="main">⇒</span> <span class="main">{</span>MSkip <span class="bound">m</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">RPD</span> <span class="main">(</span>MTestPos <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">RPD</span> <span class="main">(</span>MTestNeg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">RPD</span> <span class="main">(</span>MPlus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">RPD</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∪</span> <span class="free">RPD</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">RPD</span> <span class="main">(</span>MTimes <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> MTimesL <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free">RPD</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="free">RPD</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">RPD</span> <span class="main">(</span>MStar <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> MTimesL <span class="main">(</span>MStar <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">RPD</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">RPDi</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">RPDi</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">RPDi</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">s</span> <span class="main">∈</span> RPD <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">.</span> <span class="free">RPDi</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> RPDi_Suc_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"RPDi <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">s</span> <span class="main">∈</span> RPDi <span class="free">i</span> <span class="free">r</span><span class="main">.</span> RPD <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">RPDs</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> RPDi <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> RPDs_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> RPDs <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> RPDs_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> RPDs_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> RPD <span class="free">s</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">∈</span> RPDs <span class="free">t</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">∈</span> RPDs <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> RPDs_def RPDi_Suc_alt <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> RPDi.simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> RPDi_Test<span class="main">:</span>
  <span class="quoted"><span class="quoted">"RPDi <span class="free">i</span> <span class="main">(</span>MSkip <span class="main">0</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>MSkip <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="quoted"><span class="quoted">"RPDi <span class="free">i</span> <span class="main">(</span>MTestPos <span class="free">φ</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>MTestPos <span class="free">φ</span><span class="main">}</span>"</span></span>
  <span class="quoted"><span class="quoted">"RPDi <span class="free">i</span> <span class="main">(</span>MTestNeg <span class="free">φ</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>MTestNeg <span class="free">φ</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> RPDs_Test<span class="main">:</span>
  <span class="quoted"><span class="quoted">"RPDs <span class="main">(</span>MSkip <span class="main">0</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>MSkip <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="quoted"><span class="quoted">"RPDs <span class="main">(</span>MTestPos <span class="free">φ</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>MTestPos <span class="free">φ</span><span class="main">}</span>"</span></span>
  <span class="quoted"><span class="quoted">"RPDs <span class="main">(</span>MTestNeg <span class="free">φ</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>MTestNeg <span class="free">φ</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RPDs_def <span class="keyword1"><span class="command">using</span></span> RPDi_Test <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> RPDi_MSkip<span class="main">:</span> <span class="quoted"><span class="quoted">"RPDi <span class="free">i</span> <span class="main">(</span>MSkip <span class="free">n</span><span class="main">)</span> <span class="main">⊆</span> MSkip <span class="main">`</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> RPDi_Test<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_Suc_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> RPDs_MSkip<span class="main">:</span> <span class="quoted"><span class="quoted">"RPDs <span class="main">(</span>MSkip <span class="free">n</span><span class="main">)</span> <span class="main">⊆</span> MSkip <span class="main">`</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RPDs_def <span class="keyword1"><span class="command">using</span></span> RPDi_MSkip <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> RPDi_Plus<span class="main">:</span> <span class="quoted"><span class="quoted">"RPDi <span class="free">i</span> <span class="main">(</span>MPlus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>MPlus <span class="free">r</span> <span class="free">s</span><span class="main">}</span> <span class="main">∪</span> RPDi <span class="free">i</span> <span class="free">r</span> <span class="main">∪</span> RPDi <span class="free">i</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> RPDi_Suc_RPD_Plus<span class="main">:</span>
  <span class="quoted"><span class="quoted">"RPDi <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">r</span> <span class="main">⊆</span> RPDs <span class="main">(</span>MPlus <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"RPDi <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">s</span> <span class="main">⊆</span> RPDs <span class="main">(</span>MPlus <span class="free">r</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RPDs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">i</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> RPDs_Plus<span class="main">:</span> <span class="quoted"><span class="quoted">"RPDs <span class="main">(</span>MPlus <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>MPlus <span class="free">r</span> <span class="free">s</span><span class="main">}</span> <span class="main">∪</span> RPDs <span class="free">r</span> <span class="main">∪</span> RPDs <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RPDs_def <span class="keyword1"><span class="command">using</span></span> RPDi_Plus<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> RPDi_Times<span class="main">:</span>
  <span class="quoted"><span class="quoted">"RPDi <span class="free">i</span> <span class="main">(</span>MTimes <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>MTimes <span class="free">r</span> <span class="free">s</span><span class="main">}</span> <span class="main">∪</span> MTimesL <span class="free">r</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">j</span> <span class="main">≤</span> <span class="free">i</span><span class="main">.</span> RPDi <span class="bound">j</span> <span class="free">s</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">j</span> <span class="main">≤</span> <span class="free">i</span><span class="main">.</span> RPDi <span class="bound">j</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MTimesL_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> bspec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> set_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Suc<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> RPDs_Times<span class="main">:</span> <span class="quoted"><span class="quoted">"RPDs <span class="main">(</span>MTimes <span class="free">r</span> <span class="free">s</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>MTimes <span class="free">r</span> <span class="free">s</span><span class="main">}</span> <span class="main">∪</span> MTimesL <span class="free">r</span> <span class="main">(</span>RPDs <span class="free">s</span><span class="main">)</span> <span class="main">∪</span> RPDs <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RPDs_def <span class="keyword1"><span class="command">using</span></span> RPDi_Times<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MTimesL_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> RPDi_Star<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟹</span> RPDi <span class="free">j</span> <span class="main">(</span>MStar <span class="free">r</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>MStar <span class="free">r</span><span class="main">}</span> <span class="main">∪</span> MTimesL <span class="main">(</span>MStar <span class="free">r</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">j</span> <span class="main">≤</span> <span class="free">i</span><span class="main">.</span> RPDi <span class="bound">j</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 5 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MTimesL_def image_iff le_Suc_eq
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> bspec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span>"</span></span><span class="main"><span class="main">]</span></span> bspec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> set_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Suc<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> set_mp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> RPDi_Times<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> RPDs_Star<span class="main">:</span> <span class="quoted"><span class="quoted">"RPDs <span class="main">(</span>MStar <span class="free">r</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>MStar <span class="free">r</span><span class="main">}</span> <span class="main">∪</span> MTimesL <span class="main">(</span>MStar <span class="free">r</span><span class="main">)</span> <span class="main">(</span>RPDs <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RPDs_def <span class="keyword1"><span class="command">using</span></span> RPDi_Star<span class="main">[</span><span class="operator">OF</span> order_refl<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MTimesL_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_RPDs<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>RPDs <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> MSkip
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> RPDs_MSkip<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MTestPos <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> RPDs_Test<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MTestNeg <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> RPDs_Test<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MPlus <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> RPDs_Plus<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MTimes <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> RPDs_Times<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MTimesL_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MStar <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> RPDs_Star<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> MTimesL_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">addRPD</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">S</span><span class="main">.</span> insert <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">S</span> <span class="main">∪</span> Set.bind <span class="main">(</span>insert <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">S</span><span class="main">)</span> RPD"</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> mono_addRPD<span class="main">:</span> <span class="quoted"><span class="quoted">"mono <span class="main">(</span>addRPD <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mono_def Set.bind_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> RPDs_aux1<span class="main">:</span> <span class="quoted"><span class="quoted">"lfp <span class="main">(</span>addRPD <span class="free">r</span><span class="main">)</span> <span class="main">⊆</span> RPDs <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lfp_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mono_addRPD<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> RPDs_refl RPDs_trans <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Set.bind_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">lemma</span></span> RPDs_aux2<span class="main">:</span> <span class="quoted"><span class="quoted">"RPDi <span class="free">i</span> <span class="free">r</span> <span class="main">⊆</span> lfp <span class="main">(</span>addRPD <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lfp_unfold<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mono_addRPD<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> lfp_unfold<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mono_addRPD<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> RPDi_Suc_alt <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> RPDi.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> RPDs_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"RPDs <span class="free">r</span> <span class="main">=</span> lfp <span class="main">(</span>addRPD <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> RPDs_aux1 RPDs_aux2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> RPDs_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> RPDs_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"RPDs <span class="free">r</span> <span class="main">=</span> saturate <span class="main">(</span>addRPD <span class="free">r</span><span class="main">)</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RPDs_alt saturate_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> lfp_while<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mono_addRPD _ finite_RPDs<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">r</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> RPDs_refl RPDs_trans Set.bind_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The executable monitor›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> ts <span class="main">=</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> mbuf2 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> table<span class="main">)</span> list <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> table<span class="main">)</span> list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> mbuft2 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> table<span class="main">)</span> list <span class="main">×</span> <span class="main">(</span>nat set <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> mbufn <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> table<span class="main">)</span> list list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> msaux <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> mtaux <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> table <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> muaux <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> table <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> mrδaux <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ts <span class="main">×</span> <span class="main">(</span>mregex<span class="main">,</span> <span class="tfree">'a</span> table<span class="main">)</span> mapping<span class="main">)</span> list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> mlδaux <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> table list <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> mconstraint <span class="main">=</span> MEq <span class="main">|</span> MLess <span class="main">|</span> MLessEq

<span class="keyword1"><span class="command">record</span></span> args <span class="main">=</span>
  args_ivl <span class="main">::</span> <span class="quoted">ℐ</span>
  args_n <span class="main">::</span> <span class="quoted">nat</span>
  args_L <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span>
  args_R <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span>
  args_pos <span class="main">::</span> <span class="quoted">bool</span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span>dead <span class="tfree">'msaux</span><span class="main">,</span> dead <span class="tfree">'muaux</span><span class="main">,</span> dead <span class="tfree">'mtaux</span><span class="main">)</span> mformula <span class="main">=</span>
  MRel <span class="quoted"><span class="quoted">"event_data table"</span></span>
  <span class="main">|</span> MPred <span class="quoted">Formula.name</span> <span class="quoted"><span class="quoted">"Formula.trm list"</span></span>
  <span class="main">|</span> MLet <span class="quoted">Formula.name</span> <span class="quoted">nat</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula"</span></span>
  <span class="main">|</span> MAnd <span class="quoted"><span class="quoted">"nat set"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula"</span></span> <span class="quoted">bool</span> <span class="quoted"><span class="quoted">"nat set"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula"</span></span> <span class="quoted"><span class="quoted">"event_data mbuf2"</span></span>
  <span class="main">|</span> MAndAssign <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula"</span></span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> Formula.trm"</span></span>
  <span class="main">|</span> MAndRel <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula"</span></span> <span class="quoted"><span class="quoted">"Formula.trm <span class="main">×</span> bool <span class="main">×</span> mconstraint <span class="main">×</span> Formula.trm"</span></span>
  <span class="main">|</span> MAndTrigger <span class="quoted"><span class="quoted">"nat set"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula"</span></span> <span class="quoted"><span class="quoted">"event_data mbuft2"</span></span> <span class="quoted">args</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula"</span></span> <span class="quoted"><span class="quoted">"event_data mbuf2"</span></span> <span class="quoted"><span class="quoted">"ts list"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'mtaux</span>"</span></span>
  <span class="main">|</span> MAnds <span class="quoted"><span class="quoted">"nat set list"</span></span> <span class="quoted"><span class="quoted">"nat set list"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula list"</span></span> <span class="quoted"><span class="quoted">"event_data mbufn"</span></span>
  <span class="main">|</span> MOr <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula"</span></span> <span class="quoted"><span class="quoted">"event_data mbuf2"</span></span>
  <span class="main">|</span> MNeg <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula"</span></span>
  <span class="main">|</span> MExists <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula"</span></span>
  <span class="main">|</span> MAgg <span class="quoted">bool</span> <span class="quoted">nat</span> <span class="quoted">Formula.agg_op</span> <span class="quoted">nat</span> <span class="quoted"><span class="quoted">"Formula.trm"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula"</span></span>
  <span class="main">|</span> MPrev <span class="quoted">ℐ</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula"</span></span> <span class="quoted">bool</span> <span class="quoted"><span class="quoted">"event_data table list"</span></span> <span class="quoted"><span class="quoted">"ts list"</span></span>
  <span class="main">|</span> MNext <span class="quoted">ℐ</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula"</span></span> <span class="quoted">bool</span> <span class="quoted"><span class="quoted">"ts list"</span></span>
  <span class="main">|</span> MSince <span class="quoted">args</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula"</span></span> <span class="quoted"><span class="quoted">"event_data mbuf2"</span></span> <span class="quoted"><span class="quoted">"ts list"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'msaux</span>"</span></span>
  <span class="main">|</span> MUntil <span class="quoted">args</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula"</span></span> <span class="quoted"><span class="quoted">"event_data mbuf2"</span></span> <span class="quoted"><span class="quoted">"ts list"</span></span> <span class="quoted">ts</span> <span class="quoted"><span class="quoted">"<span class="tfree">'muaux</span>"</span></span>
  <span class="main">|</span> MTrigger <span class="quoted">args</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula"</span></span> <span class="quoted"><span class="quoted">"event_data mbuf2"</span></span> <span class="quoted"><span class="quoted">"ts list"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'mtaux</span>"</span></span>
  <span class="main">|</span> MMatchP <span class="quoted">ℐ</span> <span class="quoted"><span class="quoted">"mregex"</span></span> <span class="quoted"><span class="quoted">"mregex list"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula list"</span></span> <span class="quoted"><span class="quoted">"event_data mbufn"</span></span> <span class="quoted"><span class="quoted">"ts list"</span></span> <span class="quoted"><span class="quoted">"event_data mrδaux"</span></span>
  <span class="main">|</span> MMatchF <span class="quoted">ℐ</span> <span class="quoted"><span class="quoted">"mregex"</span></span> <span class="quoted"><span class="quoted">"mregex list"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula list"</span></span> <span class="quoted"><span class="quoted">"event_data mbufn"</span></span> <span class="quoted"><span class="quoted">"ts list"</span></span> <span class="quoted">ts</span> <span class="quoted"><span class="quoted">"event_data mlδaux"</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mstate <span class="main">=</span>
  mstate_i <span class="main">::</span> <span class="quoted">nat</span>
  mstate_m <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula"</span></span>
  mstate_n <span class="main">::</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eq_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> Formula.trm <span class="main">⇒</span> Formula.trm <span class="main">⇒</span> event_data table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eq_rel</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.Const <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.Const <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> unit_table <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">else</span> empty_table<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eq_rel</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.Const <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> singleton_table <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eq_rel</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.Const <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> singleton_table <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eq_rel</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> undefined"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> regex_atms_size<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> regex.atms <span class="free">r</span> <span class="main">⟹</span> size <span class="free">x</span> <span class="main">&lt;</span> regex.size_regex size <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> regex_atms_size'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> regex.atms <span class="free">r</span> <span class="main">⟹</span> size' <span class="free">x</span> <span class="main">&lt;</span> regex.size_regex size' <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> atms_size<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> atms <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size <span class="free">x</span> <span class="main">&lt;</span> Regex.size_regex size <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> regex.atms <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">y</span> <span class="keyword1">of</span> formula.Neg <span class="bound">z</span> <span class="main">⇒</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">z</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size <span class="free">x</span> <span class="main">&lt;</span> Regex.size_regex size <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> formula.exhaust<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> regex_atms_size<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> atms_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> regex_atms_size<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> atms_size'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> atms <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"size' <span class="free">x</span> <span class="main">&lt;</span> Regex.size_regex size' <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> regex.atms <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">y</span> <span class="keyword1">of</span> formula.Neg <span class="bound">z</span> <span class="main">⇒</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">z</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"size' <span class="free">x</span> <span class="main">&lt;</span> Regex.size_regex size' <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> formula.exhaust<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> regex_atms_size'<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> atms_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> regex_atms_size'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">init_args</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> nat <span class="main">⇒</span> nat set <span class="main">⇒</span> nat set <span class="main">⇒</span> bool <span class="main">⇒</span> args"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">init_args</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="main">=</span> <span class="main">⦇</span>args_ivl <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">,</span> args_n <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> args_L <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">,</span> args_R <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">,</span> args_pos <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> msaux <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">valid_msaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'msaux</span> <span class="main">⇒</span> event_data msaux <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">init_msaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> <span class="tfree">'msaux</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">add_new_ts_msaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'msaux</span> <span class="main">⇒</span> <span class="tfree">'msaux</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">join_msaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> event_data table <span class="main">⇒</span> <span class="tfree">'msaux</span> <span class="main">⇒</span> <span class="tfree">'msaux</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">add_new_table_msaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> event_data table <span class="main">⇒</span> <span class="tfree">'msaux</span> <span class="main">⇒</span> <span class="tfree">'msaux</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">result_msaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> <span class="tfree">'msaux</span> <span class="main">⇒</span> event_data table"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_init_msaux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">⊆</span> <span class="free">R</span> <span class="main">⟹</span>
    <span class="free">valid_msaux</span> <span class="main">(</span>init_args <span class="free">I</span> <span class="free">n</span> <span class="free">L</span> <span class="free">R</span> <span class="free">pos</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span><span class="free">init_msaux</span> <span class="main">(</span>init_args <span class="free">I</span> <span class="free">n</span> <span class="free">L</span> <span class="free">R</span> <span class="free">pos</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_add_new_ts_msaux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">valid_msaux</span> <span class="free">args</span> <span class="free">cur</span> <span class="free">aux</span> <span class="free">auxlist</span> <span class="main">⟹</span> <span class="free">nt</span> <span class="main">≥</span> <span class="free">cur</span> <span class="main">⟹</span>
    <span class="free">valid_msaux</span> <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span><span class="free">add_new_ts_msaux</span> <span class="free">args</span> <span class="free">nt</span> <span class="free">aux</span><span class="main">)</span>
    <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">rel</span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_join_msaux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">valid_msaux</span> <span class="free">args</span> <span class="free">cur</span> <span class="free">aux</span> <span class="free">auxlist</span> <span class="main">⟹</span>
    table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="free">rel1</span> <span class="main">⟹</span>
    <span class="free">valid_msaux</span> <span class="free">args</span> <span class="free">cur</span> <span class="main">(</span><span class="free">join_msaux</span> <span class="free">args</span> <span class="free">rel1</span> <span class="free">aux</span><span class="main">)</span>
    <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">rel</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> join <span class="bound">rel</span> <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="free">rel1</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_add_new_table_msaux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">valid_msaux</span> <span class="free">args</span> <span class="free">cur</span> <span class="free">aux</span> <span class="free">auxlist</span> <span class="main">⟹</span>
    table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="free">rel2</span> <span class="main">⟹</span>
    <span class="free">valid_msaux</span> <span class="free">args</span> <span class="free">cur</span> <span class="main">(</span><span class="free">add_new_table_msaux</span> <span class="free">args</span> <span class="free">rel2</span> <span class="free">aux</span><span class="main">)</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free">auxlist</span> <span class="keyword1">of</span>
      <span class="main">[]</span> <span class="main">=&gt;</span> <span class="main">[</span><span class="main">(</span><span class="free">cur</span><span class="main">,</span> <span class="free">rel2</span><span class="main">)</span><span class="main">]</span>
    <span class="main">|</span> <span class="main">(</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">#</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">t</span> <span class="main">=</span> <span class="free">cur</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">y</span> <span class="main">∪</span> <span class="free">rel2</span><span class="main">)</span> <span class="main">#</span> <span class="bound">ts</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">cur</span><span class="main">,</span> <span class="free">rel2</span><span class="main">)</span> <span class="main">#</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> valid_result_msaux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">valid_msaux</span> <span class="free">args</span> <span class="free">cur</span> <span class="free">aux</span> <span class="free">auxlist</span> <span class="main">⟹</span> <span class="free">result_msaux</span> <span class="free">args</span> <span class="free">aux</span> <span class="main">=</span>
    foldr <span class="main">(∪)</span> <span class="main">[</span><span class="bound">rel</span><span class="main">.</span> <span class="main">(</span>t<span class="main">,</span> rel<span class="main">)</span> <span class="main">←</span> <span class="free">auxlist</span><span class="main">,</span> memL <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">]</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">trigger_results</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> ts <span class="main">⇒</span> event_data mtaux <span class="main">⇒</span> <span class="main">(</span>nat set <span class="main">×</span> event_data table<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trigger_results</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">cur</span></span></span> <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cur</span></span></span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span>
      <span class="main">(</span>args_R <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">{</span>
      <span class="bound">tuple</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_R <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="bound">tuple</span> <span class="main">∧</span>
        <span class="comment1">― ‹pretty much the definition of trigger›</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
          <span class="keyword1">let</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span><span class="main">!</span><span class="bound">i</span> <span class="keyword1">in</span>
          mem <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">cur</span></span></span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span> 
          <span class="comment1">― ‹either ψ holds or there is a later database where the same tuple satisfies φ›</span>
          <span class="main">(</span>
            <span class="bound">tuple</span> <span class="main">∈</span> <span class="bound">r</span> <span class="main">∨</span>
            <span class="main">(</span><span class="main">∃</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">&lt;..&lt;</span><span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
              join_cond <span class="main">(</span>args_pos <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>fst <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">auxlist</span></span></span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="main">(</span>join_mask <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>args_L <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">tuple</span><span class="main">)</span> <span class="comment1">― ‹t &lt; t' is given as the list is sorted›</span>
            <span class="main">)</span>
          <span class="main">)</span>
        <span class="main">)</span>
      <span class="main">}</span>
    <span class="main">)</span> <span class="keyword1">else</span>
    <span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="main">{</span>replicate <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> None<span class="main">}</span><span class="main">)</span>
<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> mtaux <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">valid_mtaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'mtaux</span> <span class="main">⇒</span> event_data mtaux <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">init_mtaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> <span class="tfree">'mtaux</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">update_mtaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> ts <span class="main">⇒</span> event_data table <span class="main">⇒</span> event_data table <span class="main">⇒</span> <span class="tfree">'mtaux</span> <span class="main">⇒</span> <span class="tfree">'mtaux</span>"</span></span>
    <span class="comment1">(* and update_mtaux_constraint :: "args ⇒ ts ⇒ 'a table ⇒ 'a table ⇒ 'mtaux ⇒ 'mtaux" *)</span>
    <span class="comment1">(* and update_mtaux_safe_assignment :: "args ⇒ ts ⇒ 'a table ⇒ 'a table ⇒ 'mtaux ⇒ 'mtaux" *)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">result_mtaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> <span class="tfree">'mtaux</span> <span class="main">⇒</span> <span class="main">(</span>nat set <span class="main">×</span> event_data table<span class="main">)</span>"</span></span>

  <span class="comment1">(* the initial state should be valid *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_init_mtaux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>
    <span class="keyword1">if</span> <span class="main">(</span>mem <span class="free">I</span> <span class="main">0</span><span class="main">)</span>
      <span class="keyword1">then</span>
        <span class="free">L</span> <span class="main">⊆</span> <span class="free">R</span>
      <span class="keyword1">else</span> 
        <span class="free">L</span> <span class="main">=</span> <span class="free">R</span>
    <span class="main">)</span> <span class="main">⟹</span>
    <span class="main">¬</span>mem <span class="free">I</span> <span class="main">0</span> <span class="main">⟶</span> <span class="free">pos</span> <span class="main">⟹</span>
    <span class="keyword1">let</span> <span class="bound">args</span> <span class="main">=</span> init_args <span class="free">I</span> <span class="free">n</span> <span class="free">L</span> <span class="free">R</span> <span class="free">pos</span> <span class="keyword1">in</span>
    <span class="free">valid_mtaux</span> <span class="bound">args</span> <span class="main">0</span> <span class="main">(</span><span class="free">init_mtaux</span> <span class="bound">args</span><span class="main">)</span> <span class="main">[]</span>"</span></span>

  <span class="comment1">(* assuming the previous state outputted the same result, the next will as well *)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_update_mtaux<span class="main">:</span> <span class="quoted"><span class="quoted">"
    <span class="free">nt</span> <span class="main">≥</span> <span class="free">cur</span> <span class="main">⟹</span>
    table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="free">l</span> <span class="main">⟹</span>
    table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="free">r</span> <span class="main">⟹</span>
    <span class="free">valid_mtaux</span> <span class="free">args</span> <span class="free">cur</span> <span class="free">aux</span> <span class="free">auxlist</span> <span class="main">⟹</span>
    <span class="free">valid_mtaux</span>
      <span class="free">args</span>
      <span class="free">nt</span>
      <span class="main">(</span><span class="free">update_mtaux</span> <span class="free">args</span> <span class="free">nt</span> <span class="free">l</span> <span class="free">r</span> <span class="free">aux</span><span class="main">)</span>
      <span class="main">(</span><span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="free">nt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">nt</span><span class="main">,</span> <span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
  "</span></span>

  <span class="keyword2"><span class="keyword">and</span></span> valid_result_mtaux<span class="main">:</span> <span class="quoted"><span class="quoted">"
    <span class="free">valid_mtaux</span> <span class="free">args</span> <span class="free">cur</span> <span class="free">aux</span> <span class="free">auxlist</span> <span class="main">⟹</span>
    <span class="free">result_mtaux</span> <span class="free">args</span> <span class="free">aux</span> <span class="main">=</span> trigger_results <span class="free">args</span> <span class="free">cur</span> <span class="free">auxlist</span>
  "</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">check_before</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">check_before</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">dt</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">¬</span> memR <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">dt</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">proj_thd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">proj_thd</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">update_until</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> event_data table <span class="main">⇒</span> event_data table <span class="main">⇒</span> ts <span class="main">⇒</span> event_data muaux <span class="main">⇒</span> event_data muaux"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_until</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">rel1</span></span></span> <span class="free"><span class="bound"><span class="entity">rel2</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">=</span>
    <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">a1</span><span class="main">,</span> <span class="bound">a2</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="keyword1">if</span> <span class="main">(</span>args_pos <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="keyword1">then</span> join <span class="bound">a1</span> True <span class="free"><span class="bound"><span class="entity">rel1</span></span></span> <span class="keyword1">else</span> <span class="bound">a1</span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">rel1</span></span></span><span class="main">,</span>
      <span class="keyword1">if</span> mem  <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">then</span> <span class="bound">a2</span> <span class="main">∪</span> join <span class="free"><span class="bound"><span class="entity">rel2</span></span></span> <span class="main">(</span>args_pos <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="bound">a1</span> <span class="keyword1">else</span> <span class="bound">a2</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">@</span>
    <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rel1</span></span></span><span class="main">,</span> <span class="keyword1">if</span> memL <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">rel2</span></span></span> <span class="keyword1">else</span> empty_table<span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_proj_thd_update_until<span class="main">:</span> <span class="quoted"><span class="quoted">"map proj_thd <span class="main">(</span>takeWhile <span class="main">(</span>check_before <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="free">nt</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="main">=</span>
  map proj_thd <span class="main">(</span>takeWhile <span class="main">(</span>check_before <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="free">nt</span><span class="main">)</span> <span class="main">(</span>update_until <span class="free">args</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="free">nt</span> <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">auxlist</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> update_until_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">auxlist</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> update_until_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_until</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> ts <span class="main">⇒</span> event_data muaux <span class="main">⇒</span> event_data table list <span class="main">×</span> event_data muaux"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_until</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_until</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">¬</span> memR <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span> <span class="main">=</span> <span class="free">eval_until</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="main">#</span> <span class="bound">xs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_until_length<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eval_until <span class="free">I</span> <span class="free">nt</span> <span class="free">auxlist</span> <span class="main">=</span> <span class="main">(</span><span class="free">res</span><span class="main">,</span> <span class="free">auxlist'</span><span class="main">)</span> <span class="main">⟹</span> length <span class="free">auxlist</span> <span class="main">=</span> length <span class="free">res</span> <span class="main">+</span> length <span class="free">auxlist'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">nt</span></span> <span class="quoted"><span class="free">auxlist</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span> <span class="quoted"><span class="free">auxlist'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eval_until.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_until_res<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_until <span class="free">I</span> <span class="free">nt</span> <span class="free">auxlist</span> <span class="main">=</span> <span class="main">(</span><span class="free">res</span><span class="main">,</span> <span class="free">auxlist'</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">res</span> <span class="main">=</span> map proj_thd <span class="main">(</span>takeWhile <span class="main">(</span>check_before <span class="free">I</span> <span class="free">nt</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">nt</span></span> <span class="quoted"><span class="free">auxlist</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span> <span class="quoted"><span class="free">auxlist'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eval_until.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_until_auxlist'<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_until <span class="free">I</span> <span class="free">nt</span> <span class="free">auxlist</span> <span class="main">=</span> <span class="main">(</span><span class="free">res</span><span class="main">,</span> <span class="free">auxlist'</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">auxlist'</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="free">res</span><span class="main">)</span> <span class="free">auxlist</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">nt</span></span> <span class="quoted"><span class="free">auxlist</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">res</span></span> <span class="quoted"><span class="free">auxlist'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> eval_until.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">locale</span></span> muaux <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">valid_muaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'muaux</span> <span class="main">⇒</span> event_data muaux <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">init_muaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> <span class="tfree">'muaux</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">add_new_muaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> event_data table <span class="main">⇒</span> event_data table <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'muaux</span> <span class="main">⇒</span> <span class="tfree">'muaux</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">length_muaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> <span class="tfree">'muaux</span> <span class="main">⇒</span> nat"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">eval_muaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'muaux</span> <span class="main">⇒</span> event_data table list <span class="main">×</span> <span class="tfree">'muaux</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_init_muaux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">⊆</span> <span class="free">R</span> <span class="main">⟹</span>
    <span class="free">valid_muaux</span> <span class="main">(</span>init_args <span class="free">I</span> <span class="free">n</span> <span class="free">L</span> <span class="free">R</span> <span class="free">pos</span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span><span class="free">init_muaux</span> <span class="main">(</span>init_args <span class="free">I</span> <span class="free">n</span> <span class="free">L</span> <span class="free">R</span> <span class="free">pos</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_add_new_muaux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">valid_muaux</span> <span class="free">args</span> <span class="free">cur</span> <span class="free">aux</span> <span class="free">auxlist</span> <span class="main">⟹</span>
    table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="free">rel1</span> <span class="main">⟹</span>
    table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="free">rel2</span> <span class="main">⟹</span>
    <span class="free">nt</span> <span class="main">≥</span> <span class="free">cur</span> <span class="main">⟹</span>
    <span class="free">valid_muaux</span> <span class="free">args</span> <span class="free">nt</span> <span class="main">(</span><span class="free">add_new_muaux</span> <span class="free">args</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="free">nt</span> <span class="free">aux</span><span class="main">)</span>
    <span class="main">(</span>update_until <span class="free">args</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="free">nt</span> <span class="free">auxlist</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_length_muaux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">valid_muaux</span> <span class="free">args</span> <span class="free">cur</span> <span class="free">aux</span> <span class="free">auxlist</span> <span class="main">⟹</span> <span class="free">length_muaux</span> <span class="free">args</span> <span class="free">aux</span> <span class="main">=</span> length <span class="free">auxlist</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_eval_muaux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">valid_muaux</span> <span class="free">args</span> <span class="free">cur</span> <span class="free">aux</span> <span class="free">auxlist</span> <span class="main">⟹</span> <span class="free">nt</span> <span class="main">≥</span> <span class="free">cur</span> <span class="main">⟹</span>
    <span class="free">eval_muaux</span> <span class="free">args</span> <span class="free">nt</span> <span class="free">aux</span> <span class="main">=</span> <span class="main">(</span><span class="free">res</span><span class="main">,</span> <span class="free">aux'</span><span class="main">)</span> <span class="main">⟹</span> eval_until <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="free">nt</span> <span class="free">auxlist</span> <span class="main">=</span> <span class="main">(</span><span class="free">res'</span><span class="main">,</span> <span class="free">auxlist'</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">res</span> <span class="main">=</span> <span class="free">res'</span> <span class="main">∧</span> <span class="free">valid_muaux</span> <span class="free">args</span> <span class="free">cur</span> <span class="free">aux'</span> <span class="free">auxlist'</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> maux <span class="main">=</span> msaux <span class="quoted"><span class="free">valid_msaux</span></span> <span class="quoted"><span class="free">init_msaux</span></span> <span class="quoted"><span class="free">add_new_ts_msaux</span></span> <span class="quoted"><span class="free">join_msaux</span></span> <span class="quoted"><span class="free">add_new_table_msaux</span></span> <span class="quoted"><span class="free">result_msaux</span></span> <span class="main">+</span>
  muaux <span class="quoted"><span class="free">valid_muaux</span></span> <span class="quoted"><span class="free">init_muaux</span></span> <span class="quoted"><span class="free">add_new_muaux</span></span> <span class="quoted"><span class="free">length_muaux</span></span> <span class="quoted"><span class="free">eval_muaux</span></span> <span class="main">+</span> 
  mtaux <span class="quoted"><span class="free">valid_mtaux</span></span> <span class="quoted"><span class="free">init_mtaux</span></span> <span class="quoted"><span class="free">update_mtaux</span></span> <span class="quoted"><span class="free">result_mtaux</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">valid_msaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'msaux</span> <span class="main">⇒</span> event_data msaux <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">init_msaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> <span class="tfree">'msaux</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">add_new_ts_msaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'msaux</span> <span class="main">⇒</span> <span class="tfree">'msaux</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">join_msaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> event_data table <span class="main">⇒</span> <span class="tfree">'msaux</span> <span class="main">⇒</span> <span class="tfree">'msaux</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">add_new_table_msaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> event_data table <span class="main">⇒</span> <span class="tfree">'msaux</span> <span class="main">⇒</span> <span class="tfree">'msaux</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">result_msaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> <span class="tfree">'msaux</span> <span class="main">⇒</span> event_data table"</span></span>

    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">valid_muaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'muaux</span> <span class="main">⇒</span> event_data muaux <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">init_muaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> <span class="tfree">'muaux</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">add_new_muaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> event_data table <span class="main">⇒</span> event_data table <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'muaux</span> <span class="main">⇒</span> <span class="tfree">'muaux</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">length_muaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> <span class="tfree">'muaux</span> <span class="main">⇒</span> nat"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">eval_muaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'muaux</span> <span class="main">⇒</span> event_data table list <span class="main">×</span> <span class="tfree">'muaux</span>"</span></span>

    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">valid_mtaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'mtaux</span> <span class="main">⇒</span> event_data mtaux <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">init_mtaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> <span class="tfree">'mtaux</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">update_mtaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> ts <span class="main">⇒</span> event_data table <span class="main">⇒</span> event_data table <span class="main">⇒</span> <span class="tfree">'mtaux</span> <span class="main">⇒</span> <span class="tfree">'mtaux</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">result_mtaux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> <span class="tfree">'mtaux</span> <span class="main">⇒</span> <span class="main">(</span>nat set <span class="main">×</span> event_data table<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">split_assignment</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set <span class="main">⇒</span> Formula.formula <span class="main">⇒</span> nat <span class="main">×</span> Formula.trm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">split_assignment</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span>Formula.Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
      <span class="main">(</span>Formula.Var <span class="bound">x</span><span class="main">,</span> Formula.Var <span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span>Formula.Var <span class="bound">x</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>
    <span class="main">|</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> Formula.Var <span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">split_assignment</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> undefined"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">split_constraint</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Formula.formula <span class="main">⇒</span> Formula.trm <span class="main">×</span> bool <span class="main">×</span> mconstraint <span class="main">×</span> Formula.trm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">split_constraint</span> <span class="main">(</span>Formula.Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> True<span class="main">,</span> MEq<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">split_constraint</span> <span class="main">(</span>Formula.Less <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> True<span class="main">,</span> MLess<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">split_constraint</span> <span class="main">(</span>Formula.LessEq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> True<span class="main">,</span> MLessEq<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">split_constraint</span> <span class="main">(</span>Formula.Neg <span class="main">(</span>Formula.Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> False<span class="main">,</span> MEq<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">split_constraint</span> <span class="main">(</span>Formula.Neg <span class="main">(</span>Formula.Less <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> False<span class="main">,</span> MLess<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">split_constraint</span> <span class="main">(</span>Formula.Neg <span class="main">(</span>Formula.LessEq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> False<span class="main">,</span> MLessEq<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">split_constraint</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> undefined"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> size_remove_neg<span class="main">[</span><span class="operator">termination_simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>remove_neg <span class="free">φ</span><span class="main">)</span> <span class="main">≤</span> size <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> size'_remove_neg<span class="main">[</span><span class="operator">termination_simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size' <span class="main">(</span>remove_neg <span class="free">φ</span><span class="main">)</span> <span class="main">≤</span> size' <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> fv_remove_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="free">φ</span> <span class="main">=</span> fv <span class="main">(</span>remove_neg <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> maux<span class="main">)</span> <span class="main">(</span>sequential<span class="main">)</span> <span class="entity">minit0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> Formula.formula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">V</span> <span class="main">=</span> fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">V</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> MNeg <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="keyword1">else</span> MRel empty_table<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> MRel <span class="main">(</span>eq_rel <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.Pred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> MPred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.Let <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> MLet <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>Formula.nfv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">minit0</span> <span class="main">(</span>Formula.nfv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.Or <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> MOr <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> safe_assignment <span class="main">(</span>fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">then</span>
      MAndAssign <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>split_assignment <span class="main">(</span>fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> safe_formula <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">then</span>
      MAnd <span class="main">(</span>fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> True <span class="main">(</span>fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> is_constraint <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">then</span>
      MAndRel <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>split_constraint <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">of</span>
        <span class="main">(</span>Formula.Neg <span class="bound">ψ</span><span class="main">)</span> <span class="main">⇒</span> MAnd <span class="main">(</span>fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> False <span class="main">(</span>fv <span class="bound">ψ</span><span class="main">)</span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>
      <span class="main">|</span> <span class="main">(</span>Formula.Trigger <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>
          <span class="keyword1">if</span> <span class="main">(</span>safe_formula <span class="bound">φ'</span><span class="main">)</span> <span class="keyword1">then</span>
            MAndTrigger <span class="main">(</span>fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span>init_args <span class="bound">I</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.fv <span class="bound">φ'</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="bound">ψ'</span><span class="main">)</span> True<span class="main">)</span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">φ'</span><span class="main">)</span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">ψ'</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[]</span> <span class="main">(</span><span class="free">init_mtaux</span> <span class="main">(</span>init_args <span class="bound">I</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.fv <span class="bound">φ'</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="bound">ψ'</span><span class="main">)</span> True<span class="main">)</span><span class="main">)</span>
          <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">φ'</span> <span class="keyword1">of</span> <span class="main">(</span>Formula.Neg <span class="bound">φ'</span><span class="main">)</span> <span class="main">⇒</span>
            MAndTrigger <span class="main">(</span>fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span>init_args <span class="bound">I</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.fv <span class="bound">φ'</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="bound">ψ'</span><span class="main">)</span> False<span class="main">)</span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">φ'</span><span class="main">)</span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">ψ'</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[]</span> <span class="main">(</span><span class="free">init_mtaux</span> <span class="main">(</span>init_args <span class="bound">I</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.fv <span class="bound">φ'</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="bound">ψ'</span><span class="main">)</span> False<span class="main">)</span><span class="main">)</span>
          <span class="main">)</span>
        <span class="main">)</span>
      <span class="main">|</span> <span class="main">(</span>Formula.Release <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">)</span> <span class="main">⇒</span> <span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>and_release_safe_bounded <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="bound">φ'</span> <span class="bound">I</span> <span class="bound">ψ'</span><span class="main">)</span>
      <span class="main">)</span>
<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.Ands <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">pos</span><span class="main">,</span> <span class="bound">neg</span><span class="main">)</span> <span class="main">=</span> partition safe_formula <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">mpos</span> <span class="main">=</span> map <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="bound">pos</span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">mneg</span> <span class="main">=</span> map <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>map remove_neg <span class="bound">neg</span><span class="main">)</span> <span class="keyword1">in</span> <span class="comment1">― ‹Trigger is passed as is›</span>
    <span class="keyword1">let</span> <span class="bound">vpos</span> <span class="main">=</span> map fv <span class="bound">pos</span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">vneg</span> <span class="main">=</span> map fv <span class="bound">neg</span> <span class="keyword1">in</span>
    MAnds <span class="bound">vpos</span> <span class="bound">vneg</span> <span class="main">(</span><span class="bound">mpos</span> <span class="main">@</span> <span class="bound">mneg</span><span class="main">)</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.Exists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> MExists <span class="main">(</span><span class="free">minit0</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.Agg <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> MAgg <span class="main">(</span>fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free">minit0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> MPrev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> True <span class="main">[]</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> MNext <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> True <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.Since <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> safe_formula <span class="free"><span class="bound"><span class="entity">φ</span></span></span>
    <span class="keyword1">then</span> MSince <span class="main">(</span>init_args <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> True<span class="main">)</span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[]</span> <span class="main">(</span><span class="free">init_msaux</span> <span class="main">(</span>init_args <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> True<span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span>
      Formula.Neg <span class="bound">φ</span> <span class="main">⇒</span> MSince <span class="main">(</span>init_args <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.fv <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> False<span class="main">)</span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[]</span> <span class="main">(</span><span class="free">init_msaux</span> <span class="main">(</span>init_args <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.fv <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> False<span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> undefined<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> safe_formula <span class="free"><span class="bound"><span class="entity">φ</span></span></span>
    <span class="keyword1">then</span> MUntil <span class="main">(</span>init_args <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> True<span class="main">)</span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[]</span> <span class="main">0</span> <span class="main">(</span><span class="free">init_muaux</span> <span class="main">(</span>init_args <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> True<span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span>
      Formula.Neg <span class="bound">φ</span> <span class="main">⇒</span> MUntil <span class="main">(</span>init_args <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.fv <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> False<span class="main">)</span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[]</span> <span class="main">0</span> <span class="main">(</span><span class="free">init_muaux</span> <span class="main">(</span>init_args <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.fv <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> False<span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> undefined<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.Trigger <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> safe_formula <span class="free"><span class="bound"><span class="entity">φ</span></span></span>
    <span class="keyword1">then</span> MTrigger <span class="main">(</span>init_args <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> True<span class="main">)</span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[]</span> <span class="main">(</span><span class="free">init_mtaux</span> <span class="main">(</span>init_args <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> True<span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span>
      Formula.Neg <span class="bound">φ</span> <span class="main">⇒</span> MTrigger <span class="main">(</span>init_args <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.fv <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> False<span class="main">)</span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[]</span> <span class="main">(</span><span class="free">init_mtaux</span> <span class="main">(</span>init_args <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.fv <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> False<span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> undefined<span class="main">)</span><span class="main">)</span>
"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.Release <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">if</span> mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">0</span>
    <span class="keyword1">then</span>
      <span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>release_safe_0 <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>release_safe_bounded <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>
  <span class="main">)</span>
"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.MatchP <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">mr</span><span class="main">,</span> <span class="bound">φs</span><span class="main">)</span> <span class="main">=</span> to_mregex <span class="free"><span class="bound"><span class="entity">r</span></span></span>
    <span class="keyword1">in</span> MMatchP <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">mr</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span>RPDs <span class="bound">mr</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="bound">φs</span><span class="main">)</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="bound">φs</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[]</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.MatchF <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">mr</span><span class="main">,</span> <span class="bound">φs</span><span class="main">)</span> <span class="main">=</span> to_mregex <span class="free"><span class="bound"><span class="entity">r</span></span></span>
    <span class="keyword1">in</span> MMatchF <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">mr</span> <span class="main">(</span>sorted_list_of_set <span class="main">(</span>LPDs <span class="bound">mr</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="bound">φs</span><span class="main">)</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="bound">φs</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[]</span> <span class="main">0</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> undefined"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> maux<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span><span class="main">.</span> size' <span class="bound">φ</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_Suc_eq_le size_list_estimation' <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> to_mregex_ok<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sym<span class="main"><span class="main">]</span></span> atms_size'<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> size'_and_release size'_Release size'_Or size'_release_aux
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_list_mem_leq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">size'</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> size'_remove_neg le_trans
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  

<span class="keyword1"><span class="command">context</span></span> maux <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">declare</span></span> minit0.simps<span class="main">(</span>15<span class="main">)</span> <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> safe_assignment_next<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>safe_assignment <span class="main">(</span>fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>formula.Next <span class="free">I</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> safe_assignment_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> constraint_eventually<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_constraint <span class="main">(</span>formula.Neg <span class="main">(</span>Formula.eventually <span class="free">I</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> eventually_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> maux<span class="main">)</span> minit0_release_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"minit0 <span class="free">n</span> <span class="main">(</span>Formula.Release <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> minit0 <span class="free">n</span> <span class="main">(</span>release_safe_0 <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minit0.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> maux<span class="main">)</span> minit0_release_bounded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>mem <span class="free">I</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"minit0 <span class="free">n</span> <span class="main">(</span>Formula.Release <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> minit0 <span class="free">n</span> <span class="main">(</span>release_safe_bounded <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minit0.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> maux<span class="main">)</span> <span class="entity">minit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Formula.formula <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mstate"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">minit</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> Formula.nfv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">in</span> <span class="main">⦇</span>mstate_i <span class="main">=</span> <span class="main">0</span><span class="main">,</span> mstate_m <span class="main">=</span> minit0 <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">,</span> mstate_n <span class="main">=</span> <span class="bound">n</span><span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> maux<span class="main">)</span> <span class="entity">minit_safe</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">minit_safe</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> mmonitorable_exec <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">then</span> minit <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">else</span> undefined<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mprev_next</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> <span class="main">(</span>event_data table<span class="main">)</span> list <span class="main">⇒</span> ts list <span class="main">⇒</span> <span class="main">(</span>event_data table<span class="main">)</span> list <span class="main">×</span> <span class="main">(</span>event_data table<span class="main">)</span> list <span class="main">×</span> ts list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mprev_next</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mprev_next</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mprev_next</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mprev_next</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">=</span> <span class="free">mprev_next</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> <span class="main">(</span>empty_table<span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mbuf2_add</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mbuf2_add</span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span> <span class="free"><span class="bound"><span class="entity">ys'</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">ys'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mbuf2_take</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mbuf2_take</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">buf</span><span class="main">)</span> <span class="main">=</span> <span class="free">mbuf2_take</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="bound">zs</span><span class="main">,</span> <span class="bound">buf</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mbuf2_take</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mbuf2t_take</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mbuf2t_take</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">mbuf2t_take</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mbuf2t_take</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> size_list_length_diff1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="main">[]</span> <span class="main">∉</span> set <span class="free">xs</span> <span class="main">⟹</span>
  size_list <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> length <span class="bound">xs</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="free">xs</span> <span class="main">&lt;</span> size_list length <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mbufn_add</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>event_data table<span class="main">)</span> list list <span class="main">⇒</span> event_data mbufn <span class="main">⇒</span> event_data mbufn"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mbufn_add</span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> List.map2 <span class="main">(@)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span>"</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">mbufn_take</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>event_data table<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> event_data mbufn <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">×</span> event_data mbufn"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mbufn_take</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="main">[]</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="free">mbufn_take</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>map hd <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span> <span class="main">(</span>map tl <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">buf</span><span class="main">)</span><span class="main">.</span> size_list length <span class="bound">buf</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def Suc_le_eq size_list_length_diff1<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mbufnt_take</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>event_data table<span class="main">)</span> list <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="tfree">'b</span> <span class="main">⇒</span> event_data mbufn <span class="main">⇒</span> ts list <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">×</span> event_data mbufn <span class="main">×</span> ts list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mbufnt_take</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">[]</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="free">mbufnt_take</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>map hd <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span> <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span> <span class="main">(</span>map tl <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span> <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">match</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Formula.trm list <span class="main">⇒</span> event_data list <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇀</span> event_data<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">=</span> Some Map.empty"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="main">(</span>Formula.Const <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free">match</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="main">(</span>Formula.Var <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">match</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> None
    <span class="main">|</span> Some <span class="bound">f</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">f</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span>
        None <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">|</span> Some <span class="bound">z</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="bound">z</span> <span class="keyword1">then</span> Some <span class="bound">f</span> <span class="keyword1">else</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">meval_trm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Formula.trm <span class="main">⇒</span> event_data tuple <span class="main">⇒</span> event_data"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">meval_trm</span> <span class="main">(</span>Formula.Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval_trm</span> <span class="main">(</span>Formula.Const <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval_trm</span> <span class="main">(</span>Formula.Plus <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free">meval_trm</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">+</span> <span class="free">meval_trm</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval_trm</span> <span class="main">(</span>Formula.Minus <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free">meval_trm</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">-</span> <span class="free">meval_trm</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval_trm</span> <span class="main">(</span>Formula.UMinus <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">-</span> <span class="free">meval_trm</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval_trm</span> <span class="main">(</span>Formula.Mult <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free">meval_trm</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">*</span> <span class="free">meval_trm</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval_trm</span> <span class="main">(</span>Formula.Div <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free">meval_trm</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">div</span> <span class="free">meval_trm</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval_trm</span> <span class="main">(</span>Formula.Mod <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="free">meval_trm</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">mod</span> <span class="free">meval_trm</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval_trm</span> <span class="main">(</span>Formula.F2i <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> EInt <span class="main">(</span>integer_of_event_data <span class="main">(</span><span class="free">meval_trm</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval_trm</span> <span class="main">(</span>Formula.I2f <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> EFloat <span class="main">(</span>double_of_event_data <span class="main">(</span><span class="free">meval_trm</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eval_agg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bool <span class="main">⇒</span> nat <span class="main">⇒</span> Formula.agg_op <span class="main">⇒</span> nat <span class="main">⇒</span> Formula.trm <span class="main">⇒</span>
  event_data table <span class="main">⇒</span> event_data table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_agg</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">g0</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">g0</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span> <span class="main">=</span> empty_table
    <span class="keyword1">then</span> singleton_table <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span>eval_agg_op <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="main">{}</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span>
      <span class="keyword1">let</span> <span class="bound">group</span> <span class="main">=</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> drop <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">k</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span><span class="main">;</span>
        <span class="bound">M</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> ecard <span class="main">(</span>Set.filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> meval_trm <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">group</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> meval_trm <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">`</span> <span class="bound">group</span>
      <span class="keyword1">in</span> <span class="bound">k</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">:=</span>Some <span class="main">(</span>eval_agg_op <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="bound">M</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>drop <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> maux<span class="main">)</span> <span class="entity">update_since</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"args <span class="main">⇒</span> event_data table <span class="main">⇒</span> event_data table <span class="main">⇒</span> ts <span class="main">⇒</span>
  <span class="tfree">'msaux</span> <span class="main">⇒</span> event_data table <span class="main">×</span> <span class="tfree">'msaux</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_since</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">rel1</span></span></span> <span class="free"><span class="bound"><span class="entity">rel2</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">aux0</span> <span class="main">=</span> <span class="free">join_msaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">rel1</span></span></span> <span class="main">(</span><span class="free">add_new_ts_msaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span><span class="main">;</span>
         <span class="bound">aux'</span> <span class="main">=</span> <span class="free">add_new_table_msaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">rel2</span></span></span> <span class="bound">aux0</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="free">result_msaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="bound">aux'</span><span class="main">,</span> <span class="bound">aux'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lookup</span> <span class="main">=</span> Mapping.lookup_default empty_table"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ε_lax</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ε_lax</span> <span class="free"><span class="bound"><span class="entity">guard</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MSkip <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">guard</span></span></span> <span class="keyword1">else</span> empty_table<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε_lax</span> <span class="free"><span class="bound"><span class="entity">guard</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MTestPos <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> join <span class="free"><span class="bound"><span class="entity">guard</span></span></span> True <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε_lax</span> <span class="free"><span class="bound"><span class="entity">guard</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MTestNeg <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> join <span class="free"><span class="bound"><span class="entity">guard</span></span></span> False <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε_lax</span> <span class="free"><span class="bound"><span class="entity">guard</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MPlus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">ε_lax</span> <span class="free"><span class="bound"><span class="entity">guard</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∪</span> <span class="free">ε_lax</span> <span class="free"><span class="bound"><span class="entity">guard</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε_lax</span> <span class="free"><span class="bound"><span class="entity">guard</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MTimes <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> join <span class="main">(</span><span class="free">ε_lax</span> <span class="free"><span class="bound"><span class="entity">guard</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> True <span class="main">(</span><span class="free">ε_lax</span> <span class="free"><span class="bound"><span class="entity">guard</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ε_lax</span> <span class="free"><span class="bound"><span class="entity">guard</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MStar <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">guard</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rε_strict</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rε_strict</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MSkip <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> unit_table <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">else</span> empty_table<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rε_strict</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MTestPos <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rε_strict</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MTestNeg <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> empty_table <span class="keyword1">then</span> unit_table <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">else</span> empty_table<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rε_strict</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MPlus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">rε_strict</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∪</span> <span class="free">rε_strict</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rε_strict</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MTimes <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> ε_lax <span class="main">(</span><span class="free">rε_strict</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rε_strict</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MStar <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> unit_table <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lε_strict</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lε_strict</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MSkip <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> unit_table <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">else</span> empty_table<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lε_strict</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MTestPos <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lε_strict</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MTestNeg <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> empty_table <span class="keyword1">then</span> unit_table <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">else</span> empty_table<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lε_strict</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MPlus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">lε_strict</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∪</span> <span class="free">lε_strict</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lε_strict</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MTimes <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> ε_lax <span class="main">(</span><span class="free">lε_strict</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lε_strict</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MStar <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> unit_table <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rδ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mregex <span class="main">⇒</span> mregex<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>mregex<span class="main">,</span> <span class="tfree">'a</span> table<span class="main">)</span> mapping <span class="main">⇒</span> <span class="tfree">'a</span> table list <span class="main">⇒</span> mregex <span class="main">⇒</span> <span class="tfree">'a</span> table"</span></span>  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rδ</span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MSkip <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> empty_table <span class="main">|</span> Suc <span class="bound">m</span> <span class="main">⇒</span> lookup <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="main">(</span>MSkip <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rδ</span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MTestPos <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> empty_table"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rδ</span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MTestNeg <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> empty_table"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rδ</span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MPlus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">rδ</span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∪</span> <span class="free">rδ</span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rδ</span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MTimes <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">rδ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="main">(</span>MTimes <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∪</span> ε_lax <span class="main">(</span><span class="free">rδ</span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rδ</span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MStar <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">rδ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="main">(</span>MTimes <span class="main">(</span>MStar <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lδ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mregex <span class="main">⇒</span> mregex<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>mregex<span class="main">,</span> <span class="tfree">'a</span> table<span class="main">)</span> mapping <span class="main">⇒</span> <span class="tfree">'a</span> table list <span class="main">⇒</span> mregex <span class="main">⇒</span> <span class="tfree">'a</span> table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lδ</span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MSkip <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> empty_table <span class="main">|</span> Suc <span class="bound">m</span> <span class="main">⇒</span> lookup <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="main">(</span>MSkip <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lδ</span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MTestPos <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> empty_table"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lδ</span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MTestNeg <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> empty_table"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lδ</span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MPlus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">lδ</span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∪</span> <span class="free">lδ</span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lδ</span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MTimes <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">lδ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="main">(</span>MTimes <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∪</span> ε_lax <span class="main">(</span><span class="free">lδ</span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lδ</span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="main">(</span>MStar <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">lδ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="main">(</span>MTimes <span class="bound">t</span> <span class="main">(</span>MStar <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> mrtabulate <span class="main">::</span> <span class="quoted"><span class="quoted">"mregex list <span class="main">⇒</span> <span class="main">(</span>mregex <span class="main">⇒</span> <span class="tfree">'b</span> table<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>mregex<span class="main">,</span> <span class="tfree">'b</span> table<span class="main">)</span> mapping"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ks</span> <span class="bound">f</span><span class="main">.</span> <span class="main">(</span>map_of <span class="main">(</span>List.map_filter <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">fk</span> <span class="main">=</span> <span class="bound">f</span> <span class="bound">k</span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">fk</span> <span class="main">=</span> empty_table <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">fk</span><span class="main">)</span><span class="main">)</span> <span class="bound">ks</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lookup_tabulate<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span> <span class="main">⟹</span> lookup <span class="main">(</span>mrtabulate <span class="free">xs</span> <span class="free">f</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="free">x</span> <span class="keyword1">else</span> empty_table<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lookup_default_def lookup_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def map_filter_def map_of_eq_None_iff o_def image_image <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_of_SomeD
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">update_matchP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> ℐ <span class="main">⇒</span> mregex <span class="main">⇒</span> mregex list <span class="main">⇒</span> event_data table list <span class="main">⇒</span> ts <span class="main">⇒</span>
  event_data mrδaux <span class="main">⇒</span> event_data table <span class="main">×</span> event_data mrδaux"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_matchP</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">mr</span></span></span> <span class="free"><span class="bound"><span class="entity">mrs</span></span></span> <span class="free"><span class="bound"><span class="entity">rels</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">aux</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">[</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> mrtabulate <span class="free"><span class="bound"><span class="entity">mrs</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">mr</span><span class="main">.</span>
        rδ id <span class="bound">rel</span> <span class="free"><span class="bound"><span class="entity">rels</span></span></span> <span class="bound">mr</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">t</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="keyword1">then</span> rε_strict <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">rels</span></span></span> <span class="bound">mr</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
      <span class="main">(</span>t<span class="main">,</span> rel<span class="main">)</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">,</span> memR <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">]</span>
      <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span><span class="main">,</span> mrtabulate <span class="free"><span class="bound"><span class="entity">mrs</span></span></span> <span class="main">(</span>rε_strict <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">rels</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">]</span>
      <span class="main">|</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">aux'</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> fst <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="keyword1">then</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">aux'</span>
                     <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span><span class="main">,</span> mrtabulate <span class="free"><span class="bound"><span class="entity">mrs</span></span></span> <span class="main">(</span>rε_strict <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">rels</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">aux'</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="main">(</span>foldr <span class="main">(∪)</span> <span class="main">[</span>lookup <span class="bound">rel</span> <span class="free"><span class="bound"><span class="entity">mr</span></span></span><span class="main">.</span> <span class="main">(</span>t<span class="main">,</span> rel<span class="main">)</span> <span class="main">←</span> <span class="bound">aux</span><span class="main">,</span> memL <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">]</span> <span class="main">{}</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">update_matchF_base</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_matchF_base</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">mr</span></span></span> <span class="free"><span class="bound"><span class="entity">mrs</span></span></span> <span class="free"><span class="bound"><span class="entity">rels</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="bound">X</span> <span class="main">=</span> mrtabulate <span class="free"><span class="bound"><span class="entity">mrs</span></span></span> <span class="main">(</span>lε_strict <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">rels</span></span></span><span class="main">)</span>
     <span class="keyword1">in</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rels</span></span></span><span class="main">,</span> <span class="keyword1">if</span> memL <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">0</span> <span class="keyword1">then</span> lookup <span class="bound">X</span> <span class="free"><span class="bound"><span class="entity">mr</span></span></span> <span class="keyword1">else</span> empty_table<span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">update_matchF_step</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_matchF_step</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">mr</span></span></span> <span class="free"><span class="bound"><span class="entity">mrs</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">rels'</span><span class="main">,</span> <span class="bound">rel</span><span class="main">)</span> <span class="main">(</span><span class="bound">aux'</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="bound">Y</span> <span class="main">=</span> mrtabulate <span class="free"><span class="bound"><span class="entity">mrs</span></span></span> <span class="main">(</span>lδ id <span class="bound">X</span> <span class="bound">rels'</span><span class="main">)</span>
     <span class="keyword1">in</span> <span class="main">(</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">rels'</span><span class="main">,</span> <span class="keyword1">if</span> mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="bound">rel</span> <span class="main">∪</span> lookup <span class="bound">Y</span> <span class="free"><span class="bound"><span class="entity">mr</span></span></span> <span class="keyword1">else</span> <span class="bound">rel</span><span class="main">)</span> <span class="main">#</span> <span class="bound">aux'</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">update_matchF</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> ℐ <span class="main">⇒</span> mregex <span class="main">⇒</span> mregex list <span class="main">⇒</span> event_data table list <span class="main">⇒</span> ts <span class="main">⇒</span> event_data mlδaux <span class="main">⇒</span> event_data mlδaux"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_matchF</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">mr</span></span></span> <span class="free"><span class="bound"><span class="entity">mrs</span></span></span> <span class="free"><span class="bound"><span class="entity">rels</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">=</span>
     fst <span class="main">(</span>foldr <span class="main">(</span>update_matchF_step <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">mr</span></span></span> <span class="free"><span class="bound"><span class="entity">mrs</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">(</span>update_matchF_base <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">mr</span></span></span> <span class="free"><span class="bound"><span class="entity">mrs</span></span></span> <span class="free"><span class="bound"><span class="entity">rels</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_matchF</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> mregex <span class="main">⇒</span> ts <span class="main">⇒</span> event_data mlδaux <span class="main">⇒</span> event_data table list <span class="main">×</span> event_data mlδaux"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_matchF</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">mr</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_matchF</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">mr</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rels</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">¬</span> memR <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="keyword1">then</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span> <span class="main">=</span> <span class="free">eval_matchF</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">mr</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rel</span></span></span> <span class="main">#</span> <span class="bound">xs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rels</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">map_split</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_split</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">map_split</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">=</span> <span class="free">map_split</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">,</span> <span class="bound">z</span> <span class="main">#</span> <span class="bound">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_assignment</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> Formula.trm <span class="main">⇒</span> event_data tuple <span class="main">⇒</span> event_data tuple"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_assignment</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">:=</span>Some <span class="main">(</span>meval_trm <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_constraint0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"mconstraint <span class="main">⇒</span> event_data <span class="main">⇒</span> event_data <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_constraint0</span> MEq <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_constraint0</span> MLess <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_constraint0</span> MLessEq <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_constraint</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Formula.trm <span class="main">×</span> bool <span class="main">×</span> mconstraint <span class="main">×</span> Formula.trm <span class="main">⇒</span> event_data tuple <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_constraint</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span>eval_constraint0 <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>meval_trm <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>meval_trm <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lookahead_ts</span> <span class="free"><span class="bound"><span class="entity">nts'</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> hd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nts'</span></span></span> <span class="main">@</span> rev <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lookahead_ts_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lookahead_ts <span class="free">nts'</span> <span class="free">nts</span> <span class="free">ts</span> <span class="free">t</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">case</span> <span class="free">nts'</span> <span class="keyword1">of</span> <span class="bound">t</span> <span class="main">#</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">t</span>
   <span class="main">|</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">ts</span> <span class="keyword1">of</span> <span class="main"><span class="bound">_</span></span> <span class="main">#</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> last <span class="free">ts</span>
           <span class="main">|</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">nts</span> <span class="keyword1">of</span> <span class="main"><span class="bound">_</span></span> <span class="main">#</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> last <span class="free">nts</span>
                   <span class="main">|</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lookahead_ts_def hd_append hd_rev <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> maux<span class="main">)</span> <span class="entity">meval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> ts list <span class="main">⇒</span> Formula.database <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula <span class="main">⇒</span>
    event_data table list <span class="main">×</span> <span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MRel <span class="free"><span class="bound"><span class="entity">rel</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rel</span></span></span><span class="main">)</span><span class="main">,</span> MRel <span class="free"><span class="bound"><span class="entity">rel</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MPred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">tms</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> Table.tabulate <span class="bound">f</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">`</span> Option.these
    <span class="main">(</span>match <span class="free"><span class="bound"><span class="entity">tms</span></span></span> <span class="main">`</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> replicate <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> empty_table <span class="main">|</span> Some <span class="bound">xs</span> <span class="main">⇒</span> <span class="bound">xs</span><span class="main">)</span><span class="main">,</span> MPred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">tms</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MLet <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">;</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">(</span>Mapping.update <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>map <span class="main">(</span>image <span class="main">(</span>map the<span class="main">)</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">db</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> MLet <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">φ</span> <span class="bound">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MAnd <span class="free"><span class="bound"><span class="entity">V1</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">V2</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span>   <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">;</span>
         <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">ψ</span><span class="main">)</span>   <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">;</span>
         <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">buf</span><span class="main">)</span> <span class="main">=</span> mbuf2_take <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r1</span><span class="main">)</span> <span class="main">(</span><span class="bound">r2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>bin_join <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">V1</span></span></span> <span class="bound">r1</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">V2</span></span></span> <span class="bound">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mbuf2_add <span class="bound">xs</span> <span class="bound">ys</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> MAnd <span class="free"><span class="bound"><span class="entity">V1</span></span></span> <span class="bound">φ</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">V2</span></span></span> <span class="bound">ψ</span> <span class="bound">buf</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MAndAssign <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">in</span>
    <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>eval_assignment <span class="free"><span class="bound"><span class="entity">conf</span></span></span> <span class="main">`</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">xs</span><span class="main">,</span> MAndAssign <span class="bound">φ</span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MAndRel <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">in</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>Set.filter <span class="main">(</span>eval_constraint <span class="free"><span class="bound"><span class="entity">conf</span></span></span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">xs</span><span class="main">,</span> MAndRel <span class="bound">φ</span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MAndTrigger <span class="free"><span class="bound"><span class="entity">V_φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf1</span></span></span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">buf2</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span>
    <span class="main">(</span><span class="bound">as</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">;</span>
    <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ'</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span><span class="main">;</span>
    <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">ψ'</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">;</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">zs_trigger</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">,</span> <span class="bound">buf2</span><span class="main">,</span> <span class="bound">nts</span><span class="main">)</span> <span class="main">=</span> mbuf2t_take <span class="main">(</span><span class="main">λ</span><span class="bound">r1</span> <span class="bound">r2</span> <span class="bound">t</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">.</span>
        <span class="keyword1">let</span> <span class="bound">aux</span>       <span class="main">=</span> <span class="free">update_mtaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="bound">t</span> <span class="bound">r1</span> <span class="bound">r2</span> <span class="bound">aux</span><span class="main">;</span>
            <span class="main">(</span><span class="bound">fv_z</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">result_mtaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="bound">aux</span>
        <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="bound">fv_z</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">(</span>mbuf2_add <span class="bound">xs</span> <span class="bound">ys</span> <span class="free"><span class="bound"><span class="entity">buf2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">;</span>
     <span class="comment1">― ‹analogous to MAnd›</span>
    <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">buf1</span><span class="main">)</span> <span class="main">=</span> mbuf2_take <span class="main">(</span><span class="main">λ</span><span class="bound">r1</span> <span class="main">(</span><span class="bound">V_trigger</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span><span class="main">.</span>
        bin_join <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">V_φ</span></span></span> <span class="bound">r1</span> True <span class="bound">V_trigger</span> <span class="bound">r2</span> <span class="comment1">― ‹fix pos=True for the and join›</span>
    <span class="main">)</span> <span class="main">(</span>mbuf2_add <span class="bound">as</span> <span class="bound">zs_trigger</span> <span class="free"><span class="bound"><span class="entity">buf1</span></span></span><span class="main">)</span>
    <span class="keyword1">in</span>
    <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> MAndTrigger <span class="free"><span class="bound"><span class="entity">V_φ</span></span></span> <span class="bound">φ</span> <span class="bound">buf1</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="bound">φ'</span> <span class="bound">ψ'</span> <span class="bound">buf2</span> <span class="bound">nts</span> <span class="bound">aux</span><span class="main">)</span>
<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MAnds <span class="free"><span class="bound"><span class="entity">A_pos</span></span></span> <span class="free"><span class="bound"><span class="entity">A_neg</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">R</span> <span class="main">=</span> map <span class="main">(</span><span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">buf</span> <span class="main">=</span> mbufn_add <span class="main">(</span>map fst <span class="bound">R</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">buf</span><span class="main">)</span> <span class="main">=</span> mbufn_take <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span> <span class="bound">zs</span><span class="main">.</span> <span class="bound">zs</span> <span class="main">@</span> <span class="main">[</span>mmulti_join <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">A_pos</span></span></span> <span class="free"><span class="bound"><span class="entity">A_neg</span></span></span> <span class="bound">xs</span><span class="main">]</span><span class="main">)</span> <span class="main">[]</span> <span class="bound">buf</span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> MAnds <span class="free"><span class="bound"><span class="entity">A_pos</span></span></span> <span class="free"><span class="bound"><span class="entity">A_neg</span></span></span> <span class="main">(</span>map snd <span class="bound">R</span><span class="main">)</span> <span class="bound">buf</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">;</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">buf</span><span class="main">)</span> <span class="main">=</span> mbuf2_take <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r1</span><span class="main">)</span> <span class="main">(</span><span class="bound">r2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">r1</span> <span class="main">∪</span> <span class="bound">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mbuf2_add <span class="bound">xs</span> <span class="bound">ys</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> MOr <span class="bound">φ</span> <span class="bound">ψ</span> <span class="bound">buf</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MNeg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">in</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">r</span> <span class="main">=</span> empty_table <span class="keyword1">then</span> <span class="main">(</span>unit_table <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>empty_table<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">xs</span><span class="main">,</span> MNeg <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MExists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">in</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>tl <span class="main">`</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">xs</span><span class="main">,</span> MExists <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MAgg <span class="free"><span class="bound"><span class="entity">g0</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">in</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>eval_agg <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">g0</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="bound">xs</span><span class="main">,</span> MAgg <span class="free"><span class="bound"><span class="entity">g0</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MPrev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">first</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>
    <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">first</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> MPrev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">φ</span> True <span class="main">(</span><span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">@</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">buf</span><span class="main">,</span> <span class="bound">nts</span><span class="main">)</span> <span class="main">=</span> mprev_next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">@</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>
      <span class="keyword1">in</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">first</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>empty_table<span class="main">)</span> <span class="main">#</span> <span class="bound">zs</span> <span class="keyword1">else</span> <span class="bound">zs</span><span class="main">,</span> MPrev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">φ</span> False <span class="bound">buf</span> <span class="bound">nts</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MNext <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">first</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">first</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">first</span></span></span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span> <span class="main">#</span> <span class="bound">xs</span><span class="main">,</span> True<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> False<span class="main">)</span> <span class="main">|</span> <span class="bound">a</span> <span class="main">⇒</span> <span class="bound">a</span><span class="main">)</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">nts</span><span class="main">)</span> <span class="main">=</span> mprev_next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">xs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> MNext <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">φ</span> <span class="bound">first</span> <span class="bound">nts</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MSince <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">;</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">,</span> <span class="bound">buf</span><span class="main">,</span> <span class="bound">nts</span><span class="main">)</span> <span class="main">=</span> mbuf2t_take <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r1</span><span class="main">)</span> <span class="main">(</span><span class="bound">r2</span><span class="main">)</span> <span class="bound">t</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">.</span>
        <span class="keyword1">let</span> <span class="main">(</span><span class="bound">z</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span> <span class="main">=</span> update_since <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="bound">r1</span> <span class="bound">r2</span> <span class="bound">t</span> <span class="bound">aux</span>
        <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="bound">z</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">(</span>mbuf2_add <span class="bound">xs</span> <span class="bound">ys</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> MSince <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="bound">φ</span> <span class="bound">ψ</span> <span class="bound">buf</span> <span class="bound">nts</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MUntil <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span>
      <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">aux</span><span class="main">,</span> <span class="bound">buf</span><span class="main">,</span> <span class="bound">nts'</span><span class="main">)</span> <span class="main">=</span> mbuf2t_take <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r1</span><span class="main">)</span> <span class="main">(</span><span class="bound">r2</span><span class="main">)</span> <span class="bound">t</span> <span class="bound">aux</span><span class="main">.</span>
        <span class="free">add_new_muaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="bound">r1</span> <span class="bound">r2</span> <span class="bound">t</span> <span class="bound">aux</span>
       <span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">(</span>mbuf2_add <span class="bound">xs</span> <span class="bound">ys</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="bound">nt</span> <span class="main">=</span> lookahead_ts <span class="bound">nts'</span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span> <span class="main">=</span> <span class="free">eval_muaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="bound">nt</span> <span class="bound">aux</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> MUntil <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="bound">φ</span> <span class="bound">ψ</span> <span class="bound">buf</span> <span class="bound">nts'</span> <span class="bound">nt</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MTrigger <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">;</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">,</span> <span class="bound">buf</span><span class="main">,</span> <span class="bound">nts</span><span class="main">)</span> <span class="main">=</span> mbuf2t_take <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r1</span><span class="main">)</span> <span class="main">(</span><span class="bound">r2</span><span class="main">)</span> <span class="bound">t</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">.</span>
        <span class="keyword1">let</span> <span class="bound">aux</span>       <span class="main">=</span> <span class="free">update_mtaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="bound">t</span> <span class="bound">r1</span> <span class="bound">r2</span> <span class="bound">aux</span><span class="main">;</span>
            <span class="main">(</span><span class="bound">fv_z</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">result_mtaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="bound">aux</span>
        <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="bound">z</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">(</span>mbuf2_add <span class="bound">xs</span> <span class="bound">ys</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> MTrigger <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="bound">φ</span> <span class="bound">ψ</span> <span class="bound">buf</span> <span class="bound">nts</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MMatchP <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">mr</span></span></span> <span class="free"><span class="bound"><span class="entity">mrs</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xss</span><span class="main">,</span> <span class="bound">φs</span><span class="main">)</span> <span class="main">=</span> map_split id <span class="main">(</span>map <span class="main">(</span><span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="main">(</span><span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">,</span> <span class="bound">buf</span><span class="main">,</span> <span class="bound">nts</span><span class="main">)</span> <span class="main">=</span> mbufnt_take <span class="main">(</span><span class="main">λ</span><span class="bound">rels</span> <span class="bound">t</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">.</span>
        <span class="keyword1">let</span> <span class="main">(</span><span class="bound">z</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span> <span class="main">=</span> update_matchP <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">mr</span></span></span> <span class="free"><span class="bound"><span class="entity">mrs</span></span></span> <span class="bound">rels</span> <span class="bound">t</span> <span class="bound">aux</span>
        <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">z</span><span class="main">]</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">(</span>mbufn_add <span class="bound">xss</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> MMatchP <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">mr</span></span></span> <span class="free"><span class="bound"><span class="entity">mrs</span></span></span> <span class="bound">φs</span> <span class="bound">buf</span> <span class="bound">nts</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MMatchF <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">mr</span></span></span> <span class="free"><span class="bound"><span class="entity">mrs</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xss</span><span class="main">,</span> <span class="bound">φs</span><span class="main">)</span> <span class="main">=</span> map_split id <span class="main">(</span>map <span class="main">(</span><span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">aux</span><span class="main">,</span> <span class="bound">buf</span><span class="main">,</span> <span class="bound">nts'</span><span class="main">)</span> <span class="main">=</span> mbufnt_take <span class="main">(</span><span class="main">λ</span><span class="bound">rels</span> <span class="bound">t</span> <span class="bound">aux</span><span class="main">.</span> update_matchF <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">mr</span></span></span> <span class="free"><span class="bound"><span class="entity">mrs</span></span></span> <span class="bound">rels</span> <span class="bound">t</span> <span class="bound">aux</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">(</span>mbufn_add <span class="bound">xss</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="bound">nt</span> <span class="main">=</span> lookahead_ts <span class="bound">nts'</span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span> <span class="main">=</span> eval_matchF <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">mr</span></span></span> <span class="bound">nt</span> <span class="bound">aux</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> MMatchF <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">mr</span></span></span> <span class="free"><span class="bound"><span class="entity">mrs</span></span></span> <span class="bound">φs</span> <span class="bound">buf</span> <span class="bound">nts'</span> <span class="bound">nt</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> maux<span class="main">)</span> <span class="entity">mstep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Formula.database <span class="main">×</span> ts <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mstate <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> event_data table<span class="main">)</span> list <span class="main">×</span> <span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mstate"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mstep</span> <span class="free"><span class="bound"><span class="entity">tdb</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> meval <span class="main">(</span>mstate_n <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main">[</span>snd <span class="free"><span class="bound"><span class="entity">tdb</span></span></span><span class="main">]</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">tdb</span></span></span><span class="main">)</span> <span class="main">(</span>mstate_m <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>
     <span class="keyword1">in</span> <span class="main">(</span>List.enumerate <span class="main">(</span>mstate_i <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="bound">xs</span><span class="main">,</span>
      <span class="main">⦇</span>mstate_i <span class="main">=</span> mstate_i <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">+</span> length <span class="bound">xs</span><span class="main">,</span> mstate_m <span class="main">=</span> <span class="bound">m</span><span class="main">,</span> mstate_n <span class="main">=</span> mstate_n <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">⦈</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Verdict delay›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">σ</span> <span class="main">::</span> <span class="quoted">Formula.trace</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">)</span> <span class="entity">progress</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Formula.name <span class="main">⇀</span> nat<span class="main">)</span> <span class="main">⇒</span> Formula.formula <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.Pred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">|</span> Some <span class="bound">k</span> <span class="main">⇒</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.Let <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="free">progress</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">↦</span> <span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.Less <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.LessEq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.Or <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> min <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> min <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.Ands <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="keyword1">else</span> Min <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">φ</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.Exists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.Agg <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> min <span class="main">(</span>Suc <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.Since <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> min <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span>
    Inf <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> min <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">⟶</span> memR <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.Trigger <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> min <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.Release <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="comment1">― ‹for an actual implementation use Inf {i. ∀k. k &lt; j ∧ k ≤ min (progress P φ j) (progress P ψ j) ⟶ memR I (τ σ k - τ σ i)},
    for the rewrite rules the following is necessary as the rewrite rule of always leads to a
    funny term›</span>
    <span class="comment1">― ‹the not bounded condition here just allows the rewrite formula to be applied in the else case›</span>
    <span class="keyword1">if</span> mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">0</span> <span class="main">∨</span> <span class="main">¬</span>bounded <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="keyword1">then</span>
      Inf <span class="main">(</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> min <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">⟶</span> memR <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span>
          <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">⟶</span> memR <span class="main">(</span>flip_int_double_upper <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>release_safe_bounded <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>
    <span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.MatchP <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> min_regex_default <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.MatchF <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span>
    Inf <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> min_regex_default <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">⟶</span> memR <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command">using</span></span> size'_and_release size'_Release size'_Or size'_release_aux
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">φ</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> size' <span class="bound">φ</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Nat.less_Suc_eq_le eventually_def Formula.TT_def Formula.FF_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_list_mem_leq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">size'</span><span class="main"><span class="main">]</span></span> regex_atms_size'<span class="main">)</span>

<span class="comment1">(* sanity check for trigger progress *)</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_FF <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> Formula.FF <span class="free">j</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Formula.FF_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_TT <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> Formula.TT <span class="free">j</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Formula.TT_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_first <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> Formula.first <span class="free">j</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Formula.first_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_once <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="main">(</span>once <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> min <span class="free">j</span> <span class="main">(</span>progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> once_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_eventually<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="main">(</span>eventually <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> Inf <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">⟶</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> eventually_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">Inf</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_eventually_once<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="main">(</span>eventually <span class="free">I</span> <span class="main">(</span>once <span class="free">J</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> progress <span class="free">P</span> <span class="main">(</span>eventually <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">Inf</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_historically_safe_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="main">(</span>historically_safe_0 <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> min <span class="free">j</span> <span class="main">(</span>
  <span class="keyword1">if</span> bounded <span class="free">I</span> <span class="keyword1">then</span>
    <span class="main">(</span>progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="comment1">― ‹? in in the past.›</span>
  <span class="keyword1">else</span>
    progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> historically_safe_0_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_historically_safe_bounded <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="main">(</span>historically_safe_bounded <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> min <span class="free">j</span> <span class="main">(</span>Inf <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">⟶</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span>  <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">⟶</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> A_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨅</span> <span class="skolem">A</span> <span class="main">≤</span> progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cInf_lower<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span>  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" min <span class="main">(</span>min <span class="free">j</span> <span class="main">(</span>local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">⨅</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span>
    min <span class="free">j</span> <span class="main">(</span><span class="main">⨅</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="main">(</span>int_remove_lower_bound <span class="free">I</span><span class="main">)</span> <span class="main">=</span> memR <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> historically_safe_bounded_def A_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> progress_historically_safe_unbounded <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="main">(</span>historically_safe_unbounded <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> min <span class="free">j</span> <span class="main">(</span>progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> historically_safe_unbounded_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> memR_flip_int_double_upper<span class="main">:</span> <span class="quoted"><span class="quoted">"memR <span class="free">I</span> <span class="free">t</span> <span class="main">⟹</span> memR <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Inf_leq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat set"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span> <span class="main">⟹</span> Inf <span class="free">Y</span> <span class="main">≤</span> Inf <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cInf_superset_mono<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> progress_always_safe_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="main">(</span>always_safe_0 <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span>
  Inf <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">⟶</span> memR <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> set_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> Suc <span class="main">(</span>local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟶</span> memR <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
        <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">⟶</span> memR <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">⟶</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span>
  <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">⟶</span> memR <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> memR_flip_int_double_upper
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">⟶</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">⟶</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">⟶</span> memR <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
     <span class="main">(</span><span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">⟶</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">⟶</span> memR <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Inf_leq<span class="main">[</span><span class="operator">OF</span> non_empty subset<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> set_eq
    <span class="keyword1"><span class="command">unfolding</span></span> always_safe_0_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> progress_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟶</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> min_Inf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>Inf <span class="free">X</span><span class="main">)</span> <span class="main">(</span>Inf <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> Inf <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Inf <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="bound">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> cInf_lower
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inf_nat_def1<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> Inf <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="bound">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> cInf_lower
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inf_nat_def1<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span> <span class="main">⟹</span> min <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="bound">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> x_def<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> y_def<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inf <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> min <span class="skolem">x</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Inf_nat_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Least_equality<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> x_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> y_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> progress_eventually_or<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="main">(</span>eventually <span class="free">I</span> <span class="main">(</span>Formula.Or <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span>
  min <span class="main">(</span>progress <span class="free">P</span> <span class="main">(</span>eventually <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">P</span> <span class="main">(</span>eventually <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> progress_eventually min_Inf<span class="main">[</span><span class="operator">OF</span> progress_nonempty progress_nonempty<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">≤</span> progress <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?f</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">Inf</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_le_mono_cross<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">≤</span> <span class="free">l'</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">-</span> <span class="free">l'</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">-</span> <span class="free">l</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">m</span> <span class="free">n</span> <span class="free">l</span> <span class="free">l'</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subset_contrI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">B</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Inf_memR_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟶</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">j</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Suc <span class="bound">x</span> <span class="main">⇒</span> Inf <span class="main">{</span><span class="bound">i</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span>min <span class="bound">x</span> <span class="free">n</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> memR_antimono<span class="main">[</span><span class="operator">OF</span> _ diff_le_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> τ_mono<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cInf_eq_minimum less_Suc_eq_le <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?f</span><span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">Inf</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> min_x_Inf<span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="free">x</span> <span class="main">(</span><span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span>min <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span>min <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span>min <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span>min <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span>min <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cInf_lower<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> assm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> min.absorb2 not_le_imp_less<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> progress_eventually_double_upper<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>progress <span class="free">P</span> <span class="main">(</span>eventually <span class="free">I</span> <span class="main">(</span>eventually <span class="main">(</span>int_remove_lower_bound <span class="free">I</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">j</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="main">0</span>
   <span class="main">|</span> Suc <span class="bound">x</span> <span class="main">⇒</span> <span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span>min <span class="bound">x</span> <span class="main">(</span>progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>progress <span class="free">P</span> <span class="main">(</span>eventually <span class="free">I</span> <span class="main">(</span>eventually <span class="main">(</span>int_remove_lower_bound <span class="free">I</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free">j</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="main">0</span>
     <span class="main">|</span> Suc <span class="bound">x</span> <span class="main">⇒</span> <span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span>min <span class="bound">x</span> <span class="main">(</span><span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span>min <span class="bound">x</span> <span class="main">(</span>progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> progress_eventually Inf_memR_conv
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">j</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="main">0</span>
     <span class="main">|</span> Suc <span class="bound">x</span> <span class="main">⇒</span> <span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span>min <span class="bound">x</span> <span class="main">(</span>progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min_x_Inf <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> progress_always_safe_bounded <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="main">(</span>always_safe_bounded <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">j</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="main">0</span>
  <span class="main">|</span> Suc <span class="bound">x</span> <span class="main">⇒</span> <span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span>min <span class="bound">x</span> <span class="main">(</span>progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">⟶</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">⟶</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">⟶</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> <span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">⟶</span> memR <span class="main">(</span>int_remove_lower_bound <span class="free">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span> <span class="main">⟶</span>
                 memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> min_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">⟶</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
     <span class="main">(</span><span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> <span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">⟶</span> memR <span class="main">(</span>int_remove_lower_bound <span class="free">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span> <span class="main">⟶</span>
                 memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> <span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">⟶</span> memR <span class="main">(</span>int_remove_lower_bound <span class="free">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span> <span class="main">⟶</span>
                 memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>
  "</span></span>
    <span class="keyword1"><span class="command">using</span></span> Inf_leq<span class="main">[</span><span class="operator">OF</span> non_empty subset<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">⟶</span> memR <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span> <span class="main">≤</span>
    <span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">⟶</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> memR_flip_int_double_upper
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Inf_leq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> progress_nonempty<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="main">(</span>always_safe_bounded <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> progress <span class="free">P</span> <span class="main">(</span>eventually <span class="free">I</span> <span class="main">(</span>formula.Or <span class="main">(</span>once <span class="main">(</span>int_remove_lower_bound <span class="free">I</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>eventually <span class="main">(</span>int_remove_lower_bound <span class="free">I</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> always_safe_bounded_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> min <span class="main">(</span>local.progress <span class="free">P</span> <span class="main">(</span>Formula.eventually <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">j</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="main">0</span>
   <span class="main">|</span> Suc <span class="bound">x</span> <span class="main">⇒</span> <span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span>min <span class="bound">x</span> <span class="main">(</span>progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> progress_eventually_or progress_eventually_once progress_eventually_double_upper
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">j</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="main">0</span>
   <span class="main">|</span> Suc <span class="bound">x</span> <span class="main">⇒</span> <span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="main">⨅</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span>min <span class="bound">x</span> <span class="main">(</span>progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> progress_eventually Inf_memR_conv
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> min_x_Inf min.idem<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> progress_eventually
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> progress_release_rewrite_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="main">(</span>release_safe_0 <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> progress <span class="free">P</span> <span class="main">(</span>formula.Release <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> min <span class="main">(</span>progress <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟶</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> progress <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span> <span class="main">⟶</span> memR <span class="main">(</span>flip_int_double_upper <span class="free">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="main">(</span>release_safe_0 <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> min <span class="main">(</span>progress <span class="free">P</span> <span class="main">(</span>formula.Until <span class="free">ψ</span> <span class="free">I</span> <span class="main">(</span>formula.And <span class="free">ψ</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">P</span> <span class="main">(</span>always_safe_0 <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> release_safe_0_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="main">(</span>formula.Until <span class="free">ψ</span> <span class="free">I</span> <span class="main">(</span>formula.And <span class="free">ψ</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> Inf <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> A_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="main">(</span>always_safe_0 <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> Inf <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> B_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> progress_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="main">(</span>release_safe_0 <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> min <span class="main">(</span>Inf <span class="skolem">A</span><span class="main">)</span> <span class="main">(</span>Inf <span class="skolem">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>min <span class="main">(</span>local.progress <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
    <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> A_def B_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> non_empty<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> progress_eq min_Inf<span class="main">[</span><span class="operator">OF</span> non_empty<span class="main">]</span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> A_def B_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> progress_release_safe_bounded_evtl<span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>progress <span class="free">P</span> <span class="main">(</span>Formula.eventually <span class="free">I</span> Formula.TT<span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">P</span> <span class="main">(</span>release_safe_bounded <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> progress <span class="free">P</span> <span class="main">(</span>release_safe_bounded <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> release_safe_bounded_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_eventually_subformulas<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">≤</span> progress <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>progress <span class="free">P</span> <span class="main">(</span>Formula.eventually <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>progress <span class="free">P</span> <span class="main">(</span>Formula.eventually <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">⟶</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> progress <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span> <span class="main">⟶</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> B_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> B_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> progress <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span> <span class="main">⟶</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> B_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">⟶</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> A_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">⊆</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨅</span> <span class="skolem">A</span> <span class="main">≤</span> <span class="main">⨅</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Inf_leq<span class="main">[</span><span class="operator">OF</span> B_props<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="main">(</span>Formula.eventually <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> <span class="main">⨅</span> <span class="skolem">A</span>"</span></span>
    <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="main">(</span>Formula.eventually <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> <span class="main">⨅</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> A_def B_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> progress_trigger_0_lower_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="main">(</span>trigger_safe_0 <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span> <span class="main">≤</span> progress <span class="free">P</span> <span class="main">(</span>formula.Trigger <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trigger_safe_0_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_trigger_unbounded_lower_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="main">(</span>trigger_safe_unbounded <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span> <span class="main">≤</span> progress <span class="free">P</span> <span class="main">(</span>formula.Trigger <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trigger_safe_unbounded_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_and_trigger_unbounded_lower_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="main">(</span>and_trigger_safe_unbounded <span class="free">α</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span> <span class="main">≤</span> progress <span class="free">P</span> <span class="main">(</span>formula.And <span class="free">α</span> <span class="main">(</span>formula.Trigger <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="main">(</span>trigger_safe_unbounded <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span> <span class="main">≤</span> progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span>"</span></span>
    <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="main">(</span>trigger_safe_unbounded <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span> <span class="main">≤</span> progress <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> progress_trigger_unbounded_lower_bound
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> and_trigger_safe_unbounded_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> progress_trigger_bounded_lower_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="main">(</span>trigger_safe_bounded <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span> <span class="main">≤</span> progress <span class="free">P</span> <span class="main">(</span>formula.Trigger <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> progress <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span> <span class="main">⟶</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> leq_φ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> min <span class="main">(</span>min <span class="main">(</span>min <span class="free">j</span> <span class="main">(</span><span class="main">⨅</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>min <span class="free">j</span> <span class="main">(</span>local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="main">(</span>min <span class="main">(</span>Suc <span class="main">(</span>min <span class="main">(</span>local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>local.progress <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span>
      <span class="main">≤</span> local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> leq_ψ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> min <span class="main">(</span>min <span class="main">(</span>min <span class="free">j</span> <span class="main">(</span><span class="main">⨅</span> <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>min <span class="free">j</span> <span class="main">(</span>local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="main">(</span>min <span class="main">(</span>Suc <span class="main">(</span>min <span class="main">(</span>local.progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>local.progress <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span>
      <span class="main">≤</span> local.progress <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> A_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inf <span class="skolem">A</span> <span class="main">≤</span> progress <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cInf_lower<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trigger_safe_bounded_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> leq_φ leq_ψ
    <span class="keyword1"><span class="command">unfolding</span></span> A_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> progress_and_trigger_bounded_lower_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="main">(</span>and_trigger_safe_bounded <span class="free">α</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span> <span class="main">≤</span> progress <span class="free">P</span> <span class="main">(</span>formula.And <span class="free">α</span> <span class="main">(</span>formula.Trigger <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="main">(</span>trigger_safe_bounded <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span> <span class="main">≤</span> progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span>"</span></span>
    <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="main">(</span>trigger_safe_bounded <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span> <span class="main">≤</span> progress <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> progress_trigger_bounded_lower_bound
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> and_trigger_safe_bounded_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> progress_and_release_rewrite_bounded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> mem <span class="free">I</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"bounded <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Monitor.progress <span class="free">σ</span> <span class="free">P</span> <span class="main">(</span>and_release_safe_bounded <span class="free">φ</span> <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> progress <span class="free">P</span> <span class="main">(</span>formula.And <span class="free">φ</span> <span class="main">(</span>formula.Release <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">P</span> <span class="main">(</span>formula.And <span class="free">φ</span> <span class="main">(</span>formula.Release <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> min <span class="main">(</span>progress <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>min <span class="main">(</span>progress <span class="free">P</span> <span class="main">(</span>Formula.eventually <span class="free">I</span> Formula.TT<span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">P</span> <span class="main">(</span>release_safe_bounded <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> progress_release_safe_bounded_evtl<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">φ'</span></span> <span class="quoted"><span class="free">ψ'</span></span><span class="main"><span class="main">]</span></span> progress.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> and_release_safe_bounded_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*lemma progress_historically_safe_bounded [simp]: "progress P (historically_safe_bounded I φ) j = j"
  unfolding historically_safe_bounded_def
  by auto*)</span>

<span class="comment1">(*lemma "progress P (Formula.Trigger φ I ψ) j = progress P (trigger_safe_0 φ I ψ) j"
  unfolding trigger_safe_0_def
  by (auto split: if_splits)*)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">progress_regex</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> min_regex_default <span class="main">(</span>progress <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> progress.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> progress_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> progress.simps<span class="main">[</span><span class="operator">folded</span> progress_regex_def<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator">THEN</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> fun_cong<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> <span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator"><span class="operator">THEN</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> fun_cong<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pred_mapping</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">=</span> pred_fun <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span>pred_option <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">rel_mapping</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">=</span> rel_fun <span class="main">(=)</span> <span class="main">(</span>rel_option <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pred_mapping_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"pred_mapping <span class="free">Q</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> dom <span class="free">P</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span>the <span class="main">(</span><span class="free">P</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pred_mapping_def pred_fun_def option.pred_set dom_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_mapping_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_mapping <span class="free">Q</span> <span class="free">P</span> <span class="free">P'</span> <span class="main">=</span> <span class="main">(</span>dom <span class="free">P</span> <span class="main">=</span> dom <span class="free">P'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> dom <span class="free">P</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span>the <span class="main">(</span><span class="free">P</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="free">P'</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_mapping_def rel_fun_def rel_option_iff dom_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_mapping_map_upd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> rel_mapping <span class="free">Q</span> <span class="free">P</span> <span class="free">P'</span> <span class="main">⟹</span> rel_mapping <span class="free">Q</span> <span class="main">(</span><span class="free">P</span><span class="main">(</span><span class="free">p</span> <span class="main">↦</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">P'</span><span class="main">(</span><span class="free">p</span> <span class="main">↦</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_mapping_alt<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pred_mapping_map_upd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">x</span> <span class="main">⟹</span> pred_mapping <span class="free">Q</span> <span class="free">P</span> <span class="main">⟹</span> pred_mapping <span class="free">Q</span> <span class="main">(</span><span class="free">P</span><span class="main">(</span><span class="free">p</span> <span class="main">↦</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_mapping_alt<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pred_mapping_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pred_mapping <span class="free">Q</span> Map.empty"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_mapping_alt<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pred_mapping_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"pred_mapping <span class="free">Q</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">≤</span> <span class="free">R</span> <span class="main">⟹</span> pred_mapping <span class="free">R</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_mapping_alt<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pred_mapping_mono_strong<span class="main">:</span> <span class="quoted"><span class="quoted">"pred_mapping <span class="free">Q</span> <span class="free">P</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> dom <span class="free">P</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">(</span>the <span class="main">(</span><span class="free">P</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">R</span> <span class="main">(</span>the <span class="main">(</span><span class="free">P</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> pred_mapping <span class="free">R</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_mapping_alt<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_mono_gen<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span> <span class="main">⟹</span> rel_mapping <span class="main">(≤)</span> <span class="free">P</span> <span class="free">P'</span> <span class="main">⟹</span> progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="free">P'</span> <span class="free">φ</span> <span class="free">j'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">P'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> progress.induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">P</span> <span class="skolem">e</span> <span class="skolem">ts</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_mapping_alt dom_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>15 <span class="skolem">P</span> <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span> <span class="skolem">j</span><span class="main">)</span>
   <span class="keyword1"><span class="command">from</span></span> 15<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">P</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">P'</span></span></span></span><span class="main">]</span> 15<span class="main">(</span>3-<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> memR_nonzeroD less_τD spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">j'</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cInf_superset_mono<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>17 <span class="skolem">P</span> <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">¬</span> bounded <span class="skolem">I</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
     <span class="keyword1"><span class="command">from</span></span> 17<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">P</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">P'</span></span></span></span><span class="main">]</span> 17<span class="main">(</span>4-<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> memR_nonzeroD less_τD spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">j'</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cInf_superset_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 17 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>19 <span class="skolem">P</span> <span class="skolem">I</span> <span class="skolem">r</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 19<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">P</span></span> <span class="quoted"><span class="skolem">P'</span></span><span class="main">]</span> 19<span class="main">(</span>2-<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Min_le_iff progress_regex_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> memR_nonzeroD less_τD spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">j'</span></span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order_trans less_le_trans <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cInf_superset_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ex_in_conv le_trans less_le_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Min_le_iff progress_regex_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rel_mapping_reflp<span class="main">:</span> <span class="quoted"><span class="quoted">"reflp <span class="free">Q</span> <span class="main">⟹</span> rel_mapping <span class="free">Q</span> <span class="free">P</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_mapping_alt reflp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> progress_mono <span class="main">=</span> progress_mono_gen<span class="main">[</span><span class="operator">OF</span> _ rel_mapping_reflp<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> reflp_def<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_le_gen<span class="main">:</span> <span class="quoted"><span class="quoted">"pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">j</span><span class="main">)</span> <span class="free">P</span> <span class="main">⟹</span> progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> progress.induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">P</span> <span class="skolem">e</span> <span class="skolem">ts</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_mapping_alt dom_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>9 <span class="skolem">P</span> <span class="skolem">l</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Min.coboundedI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>hd <span class="skolem">l</span><span class="main">)</span> <span class="skolem">j</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> order_trans<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>15 <span class="skolem">P</span> <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cInf_lower<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>17 <span class="skolem">P</span> <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">¬</span> bounded <span class="skolem">I</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 17 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cInf_lower<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 17 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>19 <span class="skolem">P</span> <span class="skolem">I</span> <span class="skolem">r</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cInf_lower<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Min_le_iff progress_regex_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> progress_le<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> Map.empty <span class="free">φ</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> progress_le_gen<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted">Map.empty</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_0_gen<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="free">P</span> <span class="main">⟹</span> progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> progress_le_gen<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> Map.empty <span class="free">φ</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_mapping_alt<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_mapping</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_mapping</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
    <span class="main">(</span>None<span class="main">,</span> None<span class="main">)</span> <span class="main">⇒</span> None
  <span class="main">|</span> <span class="main">(</span>Some <span class="bound">x</span><span class="main">,</span> None<span class="main">)</span> <span class="main">⇒</span> None
  <span class="main">|</span> <span class="main">(</span>None<span class="main">,</span> Some <span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> None
  <span class="main">|</span> <span class="main">(</span>Some <span class="bound">x</span><span class="main">,</span> Some <span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> Some <span class="main">(</span>max <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Max_mapping</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> option<span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> linorder<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Max_mapping</span> <span class="free"><span class="bound"><span class="entity">Ps</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∀</span><span class="bound">P</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Ps</span></span></span><span class="main">.</span> <span class="bound">P</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> None<span class="main">)</span> <span class="keyword1">then</span> Some <span class="main">(</span>Max <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">P</span><span class="main">.</span> the <span class="main">(</span><span class="bound">P</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">Ps</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dom_max_mapping<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>max_mapping <span class="free">P1</span> <span class="free">P2</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">P1</span> <span class="main">∩</span> dom <span class="free">P2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> max_mapping_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dom_Max_mapping<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>Max_mapping <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋂</span><span class="bound">P</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> dom <span class="bound">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Max_mapping_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Max_mapping_coboundedI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Q</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> dom <span class="bound">Q</span> <span class="main">=</span> dom <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rel_mapping <span class="main">(≤)</span> <span class="free">P</span> <span class="main">(</span>Max_mapping <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rel_mapping_alt
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI ballI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">P</span> <span class="main">=</span> dom <span class="main">(</span>Max_mapping <span class="free">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> dom <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="free">P</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≤</span> the <span class="main">(</span>Max_mapping <span class="free">X</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Max_mapping_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Max.coboundedI imageI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rel_mapping_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="keyword1">OO</span> <span class="free">Q</span> <span class="main">≤</span> <span class="free">R</span> <span class="main">⟹</span>
  rel_mapping <span class="free">P</span> <span class="free">P1</span> <span class="free">P2</span> <span class="main">⟹</span> rel_mapping <span class="free">Q</span> <span class="free">P2</span> <span class="free">P3</span> <span class="main">⟹</span> rel_mapping <span class="free">R</span> <span class="free">P1</span> <span class="free">P3</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_mapping_alt dom_def set_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">range_mapping</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> nat option<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">range_mapping</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> range_mapping_relax<span class="main">:</span>
  <span class="quoted"><span class="quoted">"range_mapping <span class="free">i</span> <span class="free">j</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">i'</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">j'</span> <span class="main">≥</span> <span class="free">j</span> <span class="main">⟹</span> range_mapping <span class="free">i'</span> <span class="free">j'</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_mapping_alt dom_def set_eq_iff max_mapping_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> range_mapping_max_mapping<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"range_mapping <span class="free">i</span> <span class="free">j1</span> <span class="free">P1</span> <span class="main">⟹</span> range_mapping <span class="free">i</span> <span class="free">j2</span> <span class="free">P2</span> <span class="main">⟹</span> range_mapping <span class="free">i</span> <span class="main">(</span>max <span class="free">j1</span> <span class="free">j2</span><span class="main">)</span> <span class="main">(</span>max_mapping <span class="free">P1</span> <span class="free">P2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_mapping_alt dom_def set_eq_iff max_mapping_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> range_mapping_Max_mapping<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">X</span> <span class="main">⟹</span> <span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> range_mapping <span class="free">i</span> <span class="main">(</span><span class="free">j</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> range_mapping <span class="free">i</span> <span class="main">(</span>Max <span class="main">(</span><span class="free">j</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Max_mapping <span class="main">(</span><span class="free">P</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_mapping_alt Max_mapping_def dom_def image_iff
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Max_ge_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pred_mapping_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pred_mapping <span class="main">(</span><span class="main">(≤)</span> <span class="free">i</span><span class="main">)</span> <span class="free">P1</span> <span class="main">⟹</span> rel_mapping <span class="main">(≤)</span> <span class="free">P1</span> <span class="free">P2</span> <span class="main">⟹</span> pred_mapping <span class="main">(</span><span class="main">(≤)</span> <span class="main">(</span><span class="free">i</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="free">P2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_mapping_alt pred_mapping_alt dom_def set_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pred_mapping_le'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pred_mapping <span class="main">(</span><span class="main">(≤)</span> <span class="free">j</span><span class="main">)</span> <span class="free">P1</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> rel_mapping <span class="main">(≤)</span> <span class="free">P1</span> <span class="free">P2</span> <span class="main">⟹</span> pred_mapping <span class="main">(</span><span class="main">(≤)</span> <span class="main">(</span><span class="free">i</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">)</span> <span class="free">P2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_mapping_alt pred_mapping_alt dom_def set_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> max_mapping_cobounded1<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">P1</span> <span class="main">⊆</span> dom <span class="free">P2</span> <span class="main">⟹</span> rel_mapping <span class="main">(≤)</span> <span class="free">P1</span> <span class="main">(</span>max_mapping <span class="free">P1</span> <span class="free">P2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> max_mapping_def rel_mapping_alt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dom_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> max_mapping_cobounded2<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">P2</span> <span class="main">⊆</span> dom <span class="free">P1</span> <span class="main">⟹</span> rel_mapping <span class="main">(≤)</span> <span class="free">P2</span> <span class="main">(</span>max_mapping <span class="free">P1</span> <span class="free">P2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> max_mapping_def rel_mapping_alt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dom_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> max_mapping_fun_upd2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"max_mapping <span class="free">P1</span> <span class="main">(</span><span class="free">P2</span><span class="main">(</span><span class="free">p</span> <span class="main">:=</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">(</span><span class="free">p</span> <span class="main">↦</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>max_mapping <span class="free">P1</span> <span class="free">P2</span><span class="main">)</span><span class="main">(</span><span class="free">p</span> <span class="main">↦</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_mapping_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_mapping_max_mapping_fun_upd<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">P2</span> <span class="main">⊆</span> dom <span class="free">P1</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">∈</span> dom <span class="free">P2</span> <span class="main">⟹</span> the <span class="main">(</span><span class="free">P2</span> <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span>
  rel_mapping <span class="main">(≤)</span> <span class="free">P2</span> <span class="main">(</span>max_mapping <span class="free">P1</span> <span class="free">P2</span><span class="main">(</span><span class="free">p</span> <span class="main">↦</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_mapping_alt max_mapping_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="comment1">(* as soon as release is implemented natively, this function can be removed.
   it is only used for it's induction rule
*)</span>

<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">)</span> <span class="entity">dummy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Formula.formula <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dummy</span> <span class="main">(</span>Formula.Pred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dummy</span> <span class="main">(</span>Formula.Let <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">dummy</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">dummy</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dummy</span> <span class="main">(</span>Formula.Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dummy</span> <span class="main">(</span>Formula.Less <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dummy</span> <span class="main">(</span>Formula.LessEq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dummy</span> <span class="main">(</span>Formula.Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">dummy</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dummy</span> <span class="main">(</span>Formula.Or <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">dummy</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">dummy</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dummy</span> <span class="main">(</span>Formula.And <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">dummy</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">dummy</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dummy</span> <span class="main">(</span>Formula.Ands <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> fold <span class="main">(∧)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="free">dummy</span> <span class="bound">φ</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dummy</span> <span class="main">(</span>Formula.Exists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">dummy</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dummy</span> <span class="main">(</span>Formula.Agg <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">dummy</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dummy</span> <span class="main">(</span>Formula.Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">dummy</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dummy</span> <span class="main">(</span>Formula.Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">dummy</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dummy</span> <span class="main">(</span>Formula.Since <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">dummy</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">dummy</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dummy</span> <span class="main">(</span>Formula.Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">dummy</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">dummy</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dummy</span> <span class="main">(</span>Formula.Trigger <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">dummy</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">dummy</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dummy</span> <span class="main">(</span>Formula.Release <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">0</span> <span class="main">∨</span> <span class="main">¬</span>bounded <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="keyword1">then</span>
      <span class="main">(</span><span class="free">dummy</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">dummy</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="main">(</span><span class="free">dummy</span> <span class="main">(</span>release_safe_bounded <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dummy</span> <span class="main">(</span>Formula.MatchP <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Regex.pred_regex <span class="free">dummy</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">dummy</span> <span class="main">(</span>Formula.MatchF <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>Regex.pred_regex <span class="free">dummy</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command">using</span></span> size'_and_release size'_Release size'_Or size'_release_aux
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure size'"</span></span><span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Nat.less_Suc_eq_le eventually_def Formula.TT_def Formula.FF_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_list_mem_leq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">size'</span><span class="main"><span class="main">]</span></span> regex_atms_size'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_ge_gen<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.future_bounded <span class="free">φ</span> <span class="main">⟹</span>
   <span class="main">∃</span><span class="bound">P</span> <span class="bound">j</span><span class="main">.</span> dom <span class="bound">P</span> <span class="main">=</span> <span class="free">S</span> <span class="main">∧</span> range_mapping <span class="free">i</span> <span class="bound">j</span> <span class="bound">P</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="bound">P</span> <span class="free">φ</span> <span class="bound">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> dummy.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">e</span> <span class="skolem">ts</span><span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">e</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="keyword1">then</span> Some <span class="skolem">i</span> <span class="keyword1">else</span> None"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_mapping_alt pred_mapping_alt dom_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">p</span> <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P2</span></span> <span class="skolem"><span class="skolem">j2</span></span> <span class="keyword2"><span class="keyword">where</span></span> P2<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">P2</span> <span class="main">=</span> insert <span class="skolem">p</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"range_mapping <span class="skolem">i</span> <span class="skolem">j2</span> <span class="skolem">P2</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P2</span> <span class="skolem">ψ</span> <span class="skolem">j2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> 2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_mapping_alt rel_mapping_alt dom_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P1</span></span> <span class="skolem"><span class="skolem">j1</span></span> <span class="keyword2"><span class="keyword">where</span></span> P1<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">P1</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"range_mapping <span class="main">(</span>the <span class="main">(</span><span class="skolem">P2</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="skolem">j1</span> <span class="skolem">P1</span>"</span></span>
    <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="skolem">P2</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P1</span> <span class="skolem">φ</span> <span class="skolem">j1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> 2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P12</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"max_mapping <span class="skolem">P1</span> <span class="skolem">P2</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> P1 P2 <span class="keyword1"><span class="command">have</span></span> le1<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P1</span> <span class="skolem">φ</span> <span class="skolem">j1</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="main">(</span><span class="var">?P12</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> <span class="skolem">P1</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="skolem">φ</span> <span class="main">(</span>max <span class="skolem">j1</span> <span class="skolem">j2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> progress_mono_gen<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_mapping_alt max_mapping_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> P1 P2 <span class="keyword1"><span class="command">have</span></span> le2<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P2</span> <span class="skolem">ψ</span> <span class="skolem">j2</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="main">(</span><span class="var">?P12</span><span class="main">(</span><span class="skolem">p</span> <span class="main">↦</span> progress <span class="free">σ</span> <span class="skolem">P1</span> <span class="skolem">φ</span> <span class="skolem">j1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ψ</span> <span class="main">(</span>max <span class="skolem">j1</span> <span class="skolem">j2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> progress_mono_gen<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_mapping_alt max_mapping_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> progress.simps
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P12</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> <span class="skolem">P1</span> <span class="skolem">p</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"max <span class="skolem">j1</span> <span class="skolem">j2</span>"</span></span><span class="main"><span class="main">]</span></span> conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="var">?P12</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> <span class="skolem">P1</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> P1 P2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dom_def max_mapping_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"range_mapping <span class="skolem">i</span> <span class="main">(</span>max <span class="skolem">j1</span> <span class="skolem">j2</span><span class="main">)</span> <span class="main">(</span><span class="var">?P12</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> <span class="skolem">P1</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> P1 P2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pred_mapping_alt dom_def max_mapping_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P2</span> <span class="skolem">ψ</span> <span class="skolem">j2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="main">(</span><span class="var">?P12</span><span class="main">(</span><span class="skolem">p</span> <span class="main">↦</span> progress <span class="free">σ</span> <span class="skolem">P1</span> <span class="skolem">φ</span> <span class="skolem">j1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ψ</span> <span class="main">(</span>max <span class="skolem">j1</span> <span class="skolem">j2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> le2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="main">(</span><span class="var">?P12</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> <span class="skolem">P1</span> <span class="skolem">p</span><span class="main">)</span><span class="main">(</span><span class="skolem">p</span><span class="main">↦</span>progress <span class="free">σ</span> <span class="main">(</span><span class="var">?P12</span><span class="main">(</span><span class="skolem">p</span> <span class="main">:=</span> <span class="skolem">P1</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="skolem">φ</span> <span class="main">(</span>max <span class="skolem">j1</span> <span class="skolem">j2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ψ</span> <span class="main">(</span>max <span class="skolem">j1</span> <span class="skolem">j2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> progress_mono_gen <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le1 rel_mapping_alt<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="main">...</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">e</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="keyword1">then</span> Some <span class="skolem">i</span> <span class="keyword1">else</span> None"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_mapping_alt<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">e</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="keyword1">then</span> Some <span class="skolem">i</span> <span class="keyword1">else</span> None"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_mapping_alt<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">e</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="keyword1">then</span> Some <span class="skolem">i</span> <span class="keyword1">else</span> None"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_mapping_alt<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 7<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P1</span></span> <span class="skolem"><span class="skolem">j1</span></span> <span class="keyword2"><span class="keyword">where</span></span> P1<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">P1</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"range_mapping <span class="skolem">i</span> <span class="skolem">j1</span> <span class="skolem">P1</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P1</span> <span class="skolem">φ1</span> <span class="skolem">j1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 7<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">S</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> 7<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P2</span></span> <span class="skolem"><span class="skolem">j2</span></span> <span class="keyword2"><span class="keyword">where</span></span> P2<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">P2</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"range_mapping <span class="skolem">i</span> <span class="skolem">j2</span> <span class="skolem">P2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P2</span> <span class="skolem">φ2</span> <span class="skolem">j2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 7<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">S</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="main">(</span>max_mapping <span class="skolem">P1</span> <span class="skolem">P2</span><span class="main">)</span> <span class="main">(</span>Formula.Or <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span> <span class="main">(</span>max <span class="skolem">j1</span> <span class="skolem">j2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_mono_gen<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> max_mapping_cobounded1 max_mapping_cobounded2<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> P1 P2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"max_mapping <span class="skolem">P1</span> <span class="skolem">P2</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"max <span class="skolem">j1</span> <span class="skolem">j2</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>8 <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 8<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P1</span></span> <span class="skolem"><span class="skolem">j1</span></span> <span class="keyword2"><span class="keyword">where</span></span> P1<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">P1</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"range_mapping <span class="skolem">i</span> <span class="skolem">j1</span> <span class="skolem">P1</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P1</span> <span class="skolem">φ1</span> <span class="skolem">j1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 8<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">S</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> 8<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P2</span></span> <span class="skolem"><span class="skolem">j2</span></span> <span class="keyword2"><span class="keyword">where</span></span> P2<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">P2</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"range_mapping <span class="skolem">i</span> <span class="skolem">j2</span> <span class="skolem">P2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P2</span> <span class="skolem">φ2</span> <span class="skolem">j2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 8<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">S</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="main">(</span>max_mapping <span class="skolem">P1</span> <span class="skolem">P2</span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span> <span class="main">(</span>max <span class="skolem">j1</span> <span class="skolem">j2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_mono_gen<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> max_mapping_cobounded1 max_mapping_cobounded2<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> P1 P2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"max_mapping <span class="skolem">P1</span> <span class="skolem">P2</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"max <span class="skolem">j1</span> <span class="skolem">j2</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>9 <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">e</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="keyword1">then</span> Some <span class="skolem">i</span> <span class="keyword1">else</span> None"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_mapping_alt<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">l</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> 9<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">φ</span><span class="main">∈</span>set <span class="skolem">l</span><span class="main">.</span> Formula.future_bounded <span class="bound">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.pred_set<span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> 9<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">P</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"range_mapping <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> 9<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">φ</span></span> <span class="quoted"><span class="skolem">S</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list.pred_set<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Pj</span><span class="main">.</span> dom <span class="main">(</span>fst <span class="bound">Pj</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">S</span> <span class="main">∧</span> range_mapping <span class="skolem">i</span> <span class="main">(</span>snd <span class="bound">Pj</span><span class="main">)</span> <span class="main">(</span>fst <span class="bound">Pj</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="main">(</span>fst <span class="bound">Pj</span><span class="main">)</span> <span class="skolem">φ</span> <span class="main">(</span>snd <span class="bound">Pj</span><span class="main">)</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Pj</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">Pj</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">P</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">φ</span><span class="main">∈</span>set <span class="skolem">l</span><span class="main">.</span> <span class="main">∃</span><span class="bound">Pj</span><span class="main">.</span> dom <span class="main">(</span>fst <span class="bound">Pj</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">S</span> <span class="main">∧</span> range_mapping <span class="skolem">i</span> <span class="main">(</span>snd <span class="bound">Pj</span><span class="main">)</span> <span class="main">(</span>fst <span class="bound">Pj</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="main">(</span>fst <span class="bound">Pj</span><span class="main">)</span> <span class="bound">φ</span> <span class="main">(</span>snd <span class="bound">Pj</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">φ</span><span class="main">∈</span>set <span class="skolem">l</span><span class="main">.</span> <span class="main">∃</span><span class="bound">Pj</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">Pj</span> <span class="bound">φ</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> 9<span class="main">(</span>1<span class="main">)</span> 9<span class="main">(</span>2<span class="main">)</span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Pjf</span><span class="main">.</span> <span class="main">∀</span><span class="bound">φ</span><span class="main">∈</span>set <span class="skolem">l</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span><span class="bound">Pjf</span> <span class="bound">φ</span><span class="main">)</span> <span class="bound">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Ball_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> choice<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Pjf</span></span> <span class="keyword2"><span class="keyword">where</span></span> Pjf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">φ</span><span class="main">∈</span>set <span class="skolem">l</span><span class="main">.</span> <span class="var">?P</span> <span class="main">(</span><span class="skolem">Pjf</span> <span class="bound">φ</span><span class="main">)</span> <span class="bound">φ</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Pf</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Pf</span> <span class="main">=</span> fst <span class="keyword1">o</span> <span class="skolem">Pjf</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">jf</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">jf</span> <span class="main">=</span> snd <span class="keyword1">o</span> <span class="skolem">Pjf</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="skolem">Pf</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"range_mapping <span class="skolem">i</span> <span class="main">(</span><span class="skolem">jf</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Pf</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="main">(</span><span class="skolem">Pf</span> <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">φ</span> <span class="main">(</span><span class="skolem">jf</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">φ</span>
      <span class="keyword1"><span class="command">using</span></span> Pjf<span class="main">[</span><span class="operator">THEN</span> bspec<span class="main">,</span> <span class="operator">OF</span> that<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> Pf_def jf_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> progress.simps eq_False<span class="main">[</span><span class="operator">THEN</span> iffD2<span class="main">,</span> <span class="operator">OF</span> False<span class="main">]</span> if_False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">subst</span> Min_ge_iff<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> False<span class="main">)</span><span class="main"><span class="keyword3">,</span></span>
          <span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="keyword1">MAX</span> <span class="bound">φ</span><span class="main">∈</span>set <span class="skolem">l</span><span class="main">.</span> <span class="skolem">jf</span> <span class="bound">φ</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"Max_mapping <span class="main">(</span><span class="skolem">Pf</span> <span class="main">`</span> set <span class="skolem">l</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span>
          conjI ballI order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> progress_mono_gen<span class="main"><span class="main">]</span></span> Max_mapping_coboundedI<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> False *<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‹<span class="skolem"><span class="skolem"><span class="skolem">φ</span></span></span> <span class="main"><span class="main"><span class="main">∈</span></span></span> set <span class="skolem"><span class="skolem"><span class="skolem">l</span></span></span>›</span></span></span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">l</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>12 <span class="skolem">I</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">P</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"range_mapping <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> 12<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_mapping_alt dom_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 12<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"dom <span class="skolem">P</span> <span class="main">=</span> <span class="skolem">S</span> <span class="main">∧</span> range_mapping <span class="skolem">i</span> <span class="main">(</span>max <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Prev <span class="skolem">I</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>max <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_Suc_eq max_def pred_mapping_alt <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_mono<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>13 <span class="skolem">I</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">P</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"range_mapping <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">j</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> 13<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_mapping_alt dom_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">P</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_mapping_alt dom_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>14 <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 14<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P1</span></span> <span class="skolem"><span class="skolem">j1</span></span> <span class="keyword2"><span class="keyword">where</span></span> P1<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">P1</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"range_mapping <span class="skolem">i</span> <span class="skolem">j1</span> <span class="skolem">P1</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P1</span> <span class="skolem">φ1</span> <span class="skolem">j1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 14<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">S</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> 14<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P2</span></span> <span class="skolem"><span class="skolem">j2</span></span> <span class="keyword2"><span class="keyword">where</span></span> P2<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">P2</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"range_mapping <span class="skolem">i</span> <span class="skolem">j2</span> <span class="skolem">P2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P2</span> <span class="skolem">φ2</span> <span class="skolem">j2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 14<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">S</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="main">(</span>max_mapping <span class="skolem">P1</span> <span class="skolem">P2</span><span class="main">)</span> <span class="main">(</span>Formula.Since <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span> <span class="main">(</span>max <span class="skolem">j1</span> <span class="skolem">j2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_mono_gen<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_mapping_cobounded1 max_mapping_cobounded2<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> P1 P2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"max_mapping <span class="skolem">P1</span> <span class="skolem">P2</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"max <span class="skolem">j1</span> <span class="skolem">j2</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> pred_mapping_le <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> max_mapping_cobounded1<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>15 <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 15<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="skolem">I</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bounded_memR<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">i'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">i'</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_le_τ<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">i</span> <span class="main">+</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">σ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le memR_antimono<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 15<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P1</span></span> <span class="skolem"><span class="skolem">j1</span></span> <span class="keyword2"><span class="keyword">where</span></span> P1<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">P1</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"range_mapping <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span> <span class="skolem">j1</span> <span class="skolem">P1</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i'</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P1</span> <span class="skolem">φ1</span> <span class="skolem">j1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> 15<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_mapping_alt dom_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 15<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P2</span></span> <span class="skolem"><span class="skolem">j2</span></span> <span class="keyword2"><span class="keyword">where</span></span> P2<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">P2</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"range_mapping <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span> <span class="skolem">j2</span> <span class="skolem">P2</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i'</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P2</span> <span class="skolem">φ2</span> <span class="skolem">j2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> 15<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_mapping_alt dom_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P12</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"max_mapping <span class="skolem">P1</span> <span class="skolem">P2</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="var">?P12</span> <span class="main">(</span>Formula.Until <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span> <span class="main">(</span>max <span class="skolem">j1</span> <span class="skolem">j2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> progress.simps
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> cInf_greatest<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> nonempty greatest<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> nonempty
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> trans_le_add1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> τ_mono<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"max <span class="skolem">j1</span> <span class="skolem">j2</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>greatest <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> P1<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">j1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> progress_le_gen <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.trans pred_mapping_mono_strong<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> max <span class="skolem">j1</span> <span class="skolem">j2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P1</span> <span class="skolem">φ1</span> <span class="skolem">j1</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="var">?P12</span> <span class="skolem">φ1</span> <span class="main">(</span>max <span class="skolem">j1</span> <span class="skolem">j2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> P1<span class="main">(</span>1<span class="main">)</span> P2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> progress_mono_gen max_mapping_cobounded1<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P2</span> <span class="skolem">φ2</span> <span class="skolem">j2</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="var">?P12</span> <span class="skolem">φ2</span> <span class="main">(</span>max <span class="skolem">j1</span> <span class="skolem">j2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> P1<span class="main">(</span>1<span class="main">)</span> P2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> progress_mono_gen max_mapping_cobounded2<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≤</span> min <span class="main">(</span>progress <span class="free">σ</span> <span class="var">?P12</span> <span class="skolem">φ1</span> <span class="main">(</span>max <span class="skolem">j1</span> <span class="skolem">j2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="var">?P12</span> <span class="skolem">φ2</span> <span class="main">(</span>max <span class="skolem">j1</span> <span class="skolem">j2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> P1<span class="main">(</span>3<span class="main">)</span> P2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> greatest <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> max <span class="skolem">j1</span> <span class="skolem">j2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">i'</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">i</span> <span class="main">&lt;</span> τ <span class="free">σ</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> contrapos_np<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less_τD<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> P1 P2 <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">i'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"max_mapping <span class="skolem">P1</span> <span class="skolem">P2</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"max <span class="skolem">j1</span> <span class="skolem">j2</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> range_mapping_relax<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>16 <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> size'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"size' <span class="skolem">φ1</span> <span class="main">≤</span> size' <span class="skolem">φ1</span> <span class="main">+</span> size' <span class="skolem">φ2</span>"</span></span>
    <span class="quoted"><span class="quoted">"size' <span class="skolem">φ2</span> <span class="main">≤</span> size' <span class="skolem">φ1</span> <span class="main">+</span> size' <span class="skolem">φ2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> 16<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P1</span></span> <span class="skolem"><span class="skolem">j1</span></span> <span class="keyword2"><span class="keyword">where</span></span> P1<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">P1</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"range_mapping <span class="skolem">i</span> <span class="skolem">j1</span> <span class="skolem">P1</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P1</span> <span class="skolem">φ1</span> <span class="skolem">j1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 16<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">S</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> 16<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P2</span></span> <span class="skolem"><span class="skolem">j2</span></span> <span class="keyword2"><span class="keyword">where</span></span> P2<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">P2</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"range_mapping <span class="skolem">i</span> <span class="skolem">j2</span> <span class="skolem">P2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P2</span> <span class="skolem">φ2</span> <span class="skolem">j2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 16<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">S</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="main">(</span>max_mapping <span class="skolem">P1</span> <span class="skolem">P2</span><span class="main">)</span> <span class="main">(</span>Formula.Since <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span> <span class="main">(</span>max <span class="skolem">j1</span> <span class="skolem">j2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_mono_gen<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_mapping_cobounded1 max_mapping_cobounded2<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> P1 P2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"max_mapping <span class="skolem">P1</span> <span class="skolem">P2</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"max <span class="skolem">j1</span> <span class="skolem">j2</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> pred_mapping_le <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> max_mapping_cobounded1<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>17 <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 17<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded <span class="main">(</span>flip_int_double_upper <span class="skolem">I</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer'</span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="main">(</span>flip_int_double_upper <span class="skolem">I</span><span class="main">)</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bounded_memR<span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">i'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="main">(</span>flip_int_double_upper <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">i'</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_le_τ<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">i</span> <span class="main">+</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">σ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le memR_antimono<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> not_mem_I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">i'</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> memR_flip_int_double_upper
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">¬</span> bounded <span class="skolem">I</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> 17<span class="main">(</span>4<span class="main">)</span> True <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P1</span></span> <span class="skolem"><span class="skolem">j1</span></span> <span class="keyword2"><span class="keyword">where</span></span> P1<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">P1</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"range_mapping <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span> <span class="skolem">j1</span> <span class="skolem">P1</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i'</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P1</span> <span class="skolem">φ1</span> <span class="skolem">j1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> 17<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_mapping_alt dom_def<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> 17<span class="main">(</span>4<span class="main">)</span> True <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P2</span></span> <span class="skolem"><span class="skolem">j2</span></span> <span class="keyword2"><span class="keyword">where</span></span> P2<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">P2</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"range_mapping <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span> <span class="skolem">j2</span> <span class="skolem">P2</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i'</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P2</span> <span class="skolem">φ2</span> <span class="skolem">j2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> 17<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_mapping_alt dom_def<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P12</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"max_mapping <span class="skolem">P1</span> <span class="skolem">P2</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="var">?P12</span> <span class="main">(</span>Formula.Release <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span> <span class="main">(</span>max <span class="skolem">j1</span> <span class="skolem">j2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> progress.simps if_P<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> cInf_greatest<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> nonempty greatest<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> nonempty
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> trans_le_add1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> τ_mono<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"max <span class="skolem">j1</span> <span class="skolem">j2</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>greatest <span class="skolem">x</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> P1<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">j1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> progress_le_gen <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.trans pred_mapping_mono_strong<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> max <span class="skolem">j1</span> <span class="skolem">j2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P1</span> <span class="skolem">φ1</span> <span class="skolem">j1</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="var">?P12</span> <span class="skolem">φ1</span> <span class="main">(</span>max <span class="skolem">j1</span> <span class="skolem">j2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> P1<span class="main">(</span>1<span class="main">)</span> P2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> progress_mono_gen max_mapping_cobounded1<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P2</span> <span class="skolem">φ2</span> <span class="skolem">j2</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="var">?P12</span> <span class="skolem">φ2</span> <span class="main">(</span>max <span class="skolem">j1</span> <span class="skolem">j2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> P1<span class="main">(</span>1<span class="main">)</span> P2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> progress_mono_gen max_mapping_cobounded2<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≤</span> min <span class="main">(</span>progress <span class="free">σ</span> <span class="var">?P12</span> <span class="skolem">φ1</span> <span class="main">(</span>max <span class="skolem">j1</span> <span class="skolem">j2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="var">?P12</span> <span class="skolem">φ2</span> <span class="main">(</span>max <span class="skolem">j1</span> <span class="skolem">j2</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> P1<span class="main">(</span>3<span class="main">)</span> P2<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> greatest <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> max <span class="skolem">j1</span> <span class="skolem">j2</span>›</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"memR <span class="main">(</span>flip_int_double_upper <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">i'</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∨</span> memR <span class="main">(</span><span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">i'</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> 1 not_mem_I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">i</span> <span class="main">&lt;</span> τ <span class="free">σ</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> contrapos_np<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less_τD<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> P1 P2 <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">i'</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"max_mapping <span class="skolem">P1</span> <span class="skolem">P2</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"max <span class="skolem">j1</span> <span class="skolem">j2</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> range_mapping_relax<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
   
    <span class="keyword1"><span class="command">have</span></span> future_bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.future_bounded <span class="main">(</span>release_safe_bounded <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 17<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> release_safe_bounded_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> False flip_int_less_lower_props memR_zero
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 17<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> False future_bounded<span class="main">]</span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>18 <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"regex.atms <span class="skolem">r</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> 18<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> progress.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">e</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="keyword1">then</span> Some <span class="skolem">i</span> <span class="keyword1">else</span> None"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_mapping_alt regex.pred_set<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pick</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pick</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="keyword1">SOME</span> <span class="bound">Pj</span><span class="main">.</span> dom <span class="main">(</span>fst <span class="bound">Pj</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">S</span> <span class="main">∧</span> range_mapping <span class="skolem">i</span> <span class="main">(</span>snd <span class="bound">Pj</span><span class="main">)</span> <span class="main">(</span>fst <span class="bound">Pj</span><span class="main">)</span> <span class="main">∧</span>
       <span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="main">(</span>fst <span class="bound">Pj</span><span class="main">)</span> <span class="bound">φ</span> <span class="main">(</span>snd <span class="bound">Pj</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pickP</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="keyword1">o</span> <span class="skolem">pick</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pickj</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="keyword1">o</span> <span class="skolem">pick</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 18 <span class="keyword1"><span class="command">have</span></span> pick<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> regex.atms <span class="skolem">r</span> <span class="main">⟹</span> dom <span class="main">(</span><span class="var">?pickP</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">S</span> <span class="main">∧</span>
      range_mapping <span class="skolem">i</span> <span class="main">(</span><span class="var">?pickj</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span><span class="var">?pickP</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="main">(</span><span class="var">?pickP</span> <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">φ</span> <span class="main">(</span><span class="var">?pickj</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">φ</span>
      <span class="keyword1"><span class="command">unfolding</span></span> pick_def o_def future_bounded.simps regex.pred_set
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> someI_ex<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">Pj</span><span class="main">.</span> dom <span class="main">(</span>fst <span class="bound">Pj</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">S</span> <span class="main">∧</span> range_mapping <span class="skolem">i</span> <span class="main">(</span>snd <span class="bound">Pj</span><span class="main">)</span> <span class="main">(</span>fst <span class="bound">Pj</span><span class="main">)</span> <span class="main">∧</span>
         <span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="main">(</span>fst <span class="bound">Pj</span><span class="main">)</span> <span class="skolem">φ</span> <span class="main">(</span>snd <span class="bound">Pj</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> progress.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Max_mapping <span class="main">(</span><span class="var">?pickP</span> <span class="main">`</span> regex.atms <span class="skolem">r</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="var">?pickj</span> <span class="main">`</span> regex.atms <span class="skolem">r</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Max_mapping_coboundedI
          order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pick<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">THEN</span> conjunct2<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">THEN</span> conjunct2<span class="main"><span class="main"><span class="main">]</span></span></span> progress_mono_gen<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>19 <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 19<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="skolem">I</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bounded_memR<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">i'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">i'</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_le_τ<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">i</span> <span class="main">+</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">σ</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le memR_antimono<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">i'</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> i' less_τD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_le_mono2 <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> contrapos_np<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"regex.atms <span class="skolem">r</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> 19<span class="main">(</span>2<span class="main">)</span> ix <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> progress.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">e</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="keyword1">then</span> Some <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span> <span class="keyword1">else</span> None"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i'</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_mapping_alt regex.pred_set add.commute less_Suc_eq
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cInf_greatest <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">i'</span></span><span class="main"><span class="main">]</span></span> less_imp_le<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> τ_mono<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">i'</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ</span></span> <span class="keyword2"><span class="keyword">where</span></span> φ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> regex.atms <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pick</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pick</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="keyword1">SOME</span> <span class="bound">Pj</span><span class="main">.</span> dom <span class="main">(</span>fst <span class="bound">Pj</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">S</span> <span class="main">∧</span> range_mapping <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">Pj</span><span class="main">)</span> <span class="main">(</span>fst <span class="bound">Pj</span><span class="main">)</span> <span class="main">∧</span>
      Suc <span class="skolem">i'</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="main">(</span>fst <span class="bound">Pj</span><span class="main">)</span> <span class="bound">φ</span> <span class="main">(</span>snd <span class="bound">Pj</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pickP</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pickP</span> <span class="main">=</span> fst <span class="keyword1">o</span> <span class="skolem">pick</span>"</span></span> <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pickj</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pickj</span> <span class="main">=</span> snd <span class="keyword1">o</span> <span class="skolem">pick</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> 19 <span class="keyword1"><span class="command">have</span></span> pick<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> regex.atms <span class="skolem">r</span> <span class="main">⟹</span> dom <span class="main">(</span><span class="skolem">pickP</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">S</span> <span class="main">∧</span>
    range_mapping <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">pickj</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">pickP</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">∧</span> Suc <span class="skolem">i'</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="main">(</span><span class="skolem">pickP</span> <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">φ</span> <span class="main">(</span><span class="skolem">pickj</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">φ</span>
      <span class="keyword1"><span class="command">unfolding</span></span> pick_def o_def future_bounded.simps regex.pred_set pickj_def pickP_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> someI_ex<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">Pj</span><span class="main">.</span> dom <span class="main">(</span>fst <span class="bound">Pj</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">S</span> <span class="main">∧</span> range_mapping <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">Pj</span><span class="main">)</span> <span class="main">(</span>fst <span class="bound">Pj</span><span class="main">)</span> <span class="main">∧</span>
       Suc <span class="skolem">i'</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="main">(</span>fst <span class="bound">Pj</span><span class="main">)</span> <span class="skolem">φ</span> <span class="main">(</span>snd <span class="bound">Pj</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Max_mapping <span class="main">(</span><span class="skolem">pickP</span> <span class="main">`</span> regex.atms <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?j</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="skolem">pickj</span> <span class="main">`</span> regex.atms <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> pick<span class="main">[</span><span class="operator">OF</span> φ<span class="main">]</span> False φ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i'</span> <span class="main">≤</span> <span class="var">?j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pick<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">THEN</span> conjunct2<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">THEN</span> conjunct2<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> φ<span class="main"><span class="main">]</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> progress_le_gen<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Max_ge_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> range_mapping_relax<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _ order_refl<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">note</span></span> i' ix
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> 19<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Regex.pred_regex Formula.future_bounded <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> τ_mono<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="var"><span class="quoted"><span class="var">?j</span></span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">]</span> less_τD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> pick False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="var">?j</span>"</span></span><span class="main"><span class="main">]</span></span>  exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cInf_greatest
          order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_SucI<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> order_refl<span class="main"><span class="main"><span class="main">]</span></span></span> order_trans<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> pick<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator">THEN</span> conjunct2<span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span> <span class="operator">THEN</span> conjunct2<span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span> progress_mono_gen<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
          range_mapping_Max_mapping<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ ballI<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> range_mapping_relax<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i'</span>"</span></span> <span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span> <span class="main"><span class="main"><span class="main"><span class="main">_</span></span></span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span> <span class="operator">OF</span> _ _ order_refl<span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> Suc_le_eq trans_le_add2 Max_mapping_coboundedI progress_regex_def
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span>"</span></span><span class="main"><span class="main">]</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var">?j</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> progress_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.future_bounded <span class="free">φ</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> progress <span class="free">σ</span> Map.empty <span class="free">φ</span> <span class="bound">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> progress_ge_gen<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> cInf_restrict_nat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inf <span class="free">A</span> <span class="main">=</span> Inf <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> antisym <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cInf_greatest cInf_lower Inf_nat_def1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_time_conv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free">j</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> τ <span class="free">σ'</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">=</span> progress <span class="free">σ'</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> progress.induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>15 <span class="skolem">P</span> <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">⟷</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> 15 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"bounded <span class="skolem">I</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> * 15 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> τ_mono<span class="main">[</span><span class="operator">THEN</span> trans_le_add1<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 6 0
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> arg_cong<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted">Inf</span><span class="main"><span class="main"><span class="main">]</span></span></span>
              cInf_restrict_nat<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main"><span class="main">]</span></span></span> cInf_restrict_nat<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bounded_memR<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>17 <span class="skolem">P</span> <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">⟷</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> 17 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">¬</span> bounded <span class="skolem">I</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> mem<span class="main">:</span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> mem 17
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"bounded <span class="skolem">I</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> mem
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> * 17 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> τ_mono<span class="main">[</span><span class="operator">THEN</span> trans_le_add1<span class="main">]</span> mem
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 6 0
              <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> arg_cong<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted">Inf</span><span class="main"><span class="main"><span class="main">]</span></span></span>
                cInf_restrict_nat<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main"><span class="main">]</span></span></span> cInf_restrict_nat<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bounded_memR<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 17 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>19 <span class="skolem">P</span> <span class="skolem">I</span> <span class="skolem">r</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">⟷</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> 19 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> τ_mono<span class="main">[</span><span class="operator">THEN</span> trans_le_add1<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"bounded <span class="skolem">I</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span>
      <span class="main">(</span><span class="main">(</span><span class="operator">auto</span> 6 0 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> progress_le_gen progress_regex_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> arg_cong<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted">Inf</span><span class="main"><span class="main"><span class="main">]</span></span></span>
            cInf_restrict_nat<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">-</span><span class="main">1</span>"</span></span><span class="main"><span class="main"><span class="main">]</span></span></span> cInf_restrict_nat<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">-</span><span class="main">1</span>"</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> progress_regex_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Inf_UNIV_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Inf UNIV <span class="main">::</span> nat<span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cInf_eq_minimum<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_prefix_conv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">=</span> progress <span class="free">σ'</span> <span class="free">P</span> <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> progress_time_conv τ_prefix_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bounded_rtranclp_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> <span class="main">::</span> linorder"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="free">R</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">S</span> <span class="bound">i</span> <span class="bound">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="free">R</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rtranclp <span class="free">R</span> <span class="free">i</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> rtranclp <span class="free">S</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">z</span></span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rtrancl_into_rtrancl<span class="main"><span class="main">[</span></span><span class="operator">to_pred</span><span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>



<span class="keyword1"><span class="command">lemma</span></span> sat_prefix_conv_gen<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">⟹</span> dom <span class="free">V</span> <span class="main">=</span> dom <span class="free">V'</span> <span class="main">⟹</span> dom <span class="free">P</span> <span class="main">=</span> dom <span class="free">V</span> <span class="main">⟹</span>
    pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> plen <span class="free">π</span><span class="main">)</span> <span class="free">P</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">⋀</span><span class="bound">p</span> <span class="bound">i</span> <span class="bound">φ</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> dom <span class="free">V</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> the <span class="main">(</span><span class="free">P</span> <span class="bound">p</span><span class="main">)</span> <span class="main">⟹</span> the <span class="main">(</span><span class="free">V</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">i</span> <span class="main">=</span> the <span class="main">(</span><span class="free">V'</span> <span class="bound">p</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span>
    Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">⟷</span> Formula.sat <span class="free">σ'</span> <span class="free">V'</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">V'</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> progress.induct<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">P</span> <span class="skolem">e</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.strict_trans2 progress_le_gen<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="skolem">e</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V'</span> <span class="skolem">e</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">V</span> <span class="main">=</span> dom <span class="skolem">V'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> None Γ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> plen <span class="free">π</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V'</span> <span class="skolem">e</span> <span class="main">=</span> Some <span class="skolem">a'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Some <span class="quoted"><span class="quoted">‹dom <span class="skolem">V</span> <span class="main">=</span> dom <span class="skolem">V'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> the <span class="main">(</span><span class="skolem">P</span> <span class="skolem">e</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1-3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="skolem">V</span> <span class="skolem">e</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> the <span class="main">(</span><span class="skolem">V'</span> <span class="skolem">e</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Some <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> 1<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domI<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Some <span class="quoted"><span class="quoted">‹<span class="skolem">V'</span> <span class="skolem">e</span> <span class="main">=</span> Some <span class="skolem">a'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">P</span> <span class="skolem">p</span> <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?V</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">V</span> <span class="bound">σ</span><span class="main">.</span> <span class="main">(</span><span class="bound">V</span><span class="main">(</span><span class="skolem">p</span> <span class="main">↦</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> length <span class="bound">v</span> <span class="main">=</span> Formula.nfv <span class="skolem">φ</span> <span class="main">∧</span> Formula.sat <span class="bound">σ</span> <span class="bound">V</span> <span class="bound">v</span> <span class="bound">i</span> <span class="skolem">φ</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sat.simps <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> 2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="main">(</span><span class="skolem">P</span><span class="main">(</span><span class="skolem">p</span> <span class="main">↦</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="var">?V</span> <span class="skolem">V</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> dom <span class="main">(</span><span class="var">?V</span> <span class="skolem">V'</span> <span class="free">σ'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="skolem">P</span><span class="main">(</span><span class="skolem">p</span> <span class="main">↦</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="main">(</span><span class="var">?V</span> <span class="skolem">V</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> plen <span class="free">π</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span><span class="main">(</span><span class="skolem">p</span> <span class="main">↦</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> pred_mapping_map_upd <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> progress_le_gen<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p'</span> <span class="skolem">i</span> <span class="skolem">φ'</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> dom <span class="main">(</span><span class="var">?V</span> <span class="skolem">V</span> <span class="free">σ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 21<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> the <span class="main">(</span><span class="main">(</span><span class="skolem">P</span><span class="main">(</span><span class="skolem">p</span> <span class="main">↦</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p'</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="var">?V</span> <span class="skolem">V</span> <span class="free">σ</span> <span class="skolem">p'</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> the <span class="main">(</span><span class="var">?V</span> <span class="skolem">V'</span> <span class="free">σ'</span> <span class="skolem">p'</span><span class="main">)</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> 2 21 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> 1 21 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> 2<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>9 <span class="skolem">P</span> <span class="skolem">l</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 9<span class="main">(</span>2-<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">φ</span><span class="main">∈</span>set <span class="skolem">l</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="bound">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">with</span></span> 9 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sat_Ands
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>12 <span class="skolem">P</span> <span class="skolem">I</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> τ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>13 <span class="skolem">P</span> <span class="skolem">I</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_le_gen<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">φ</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 13 τ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sat.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> conj_cong 13<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>14 <span class="skolem">P</span> <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_le_gen<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 14 τ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sat.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> conj_cong ex_cong ball_cong 14<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>15 <span class="skolem">P</span> <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 15 <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bounded <span class="skolem">I</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"bounded <span class="skolem">I</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bounded_memR Inf_UNIV_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 15 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ1</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ2</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le not_le <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Suc_leI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span>"</span></span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_cInf_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ1</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ2</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> contrapos_np <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less_τD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">using</span></span> 1<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span> 15<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_le_gen<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> 15 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="main">(</span>Formula.Until <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> progress_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">φ1</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">φ2</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le not_le <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Suc_leI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span>"</span></span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_cInf_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ1</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 21<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ2</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">unfolding</span></span> progress_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> contrapos_np <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less_τD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">σ'</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 31<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">using</span></span> 11<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span> 15<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_le_gen<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">thm</span></span> order.trans<span class="main">[</span><span class="operator">OF</span> _ progress_le_gen<span class="main">]</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sat.simps
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">intro</span> ex_cong iffI<span class="main"><span class="keyword3">;</span></span> <span class="operator">elim</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> LR RL<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LR <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> 15<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> 15<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 2<span class="main">]</span> τ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> 3<span class="main">]</span> 15<span class="main">(</span>3-<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_diff_conv add.commute memR_antimono <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> less_imp_le order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> τ_mono<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RL <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> 15<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 11<span class="main">]</span> 15<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 21<span class="main">]</span> τ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> 31<span class="main">]</span> 15<span class="main">(</span>3-<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_diff_conv add.commute memR_antimono <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> less_imp_le order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> τ_mono<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>16 <span class="skolem">P</span> <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_le_gen<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="skolem">i</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="skolem">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">=</span> τ <span class="free">σ'</span> <span class="bound">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> τ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> sat_subformulas<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="skolem">i</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="bound">j</span> <span class="skolem">φ</span> <span class="main">=</span> Formula.sat <span class="free">σ'</span> <span class="skolem">V'</span> <span class="skolem">v</span> <span class="bound">j</span> <span class="skolem">φ</span>"</span></span>    
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="skolem">i</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="bound">j</span> <span class="skolem">ψ</span> <span class="main">=</span> Formula.sat <span class="free">σ'</span> <span class="skolem">V'</span> <span class="skolem">v</span> <span class="bound">j</span> <span class="skolem">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 16<span class="main">(</span>1-2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ 16<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">,</span></span></span>5<span class="main"><span class="main"><span class="main">,</span></span></span>6<span class="main"><span class="main"><span class="main">,</span></span></span>7<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> 16<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> sat_subformulas t_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>17 <span class="skolem">P</span> <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>

 <span class="keyword1"><span class="command">have</span></span> τ_prefix_diff_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> plen <span class="free">π</span> <span class="main">⟹</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assm τ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="quoted"><span class="quoted">"τ <span class="free">σ'</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_le_imp_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">0</span> <span class="main">∨</span> <span class="main">¬</span> bounded <span class="skolem">I</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bounded <span class="main">(</span>flip_int_double_upper <span class="skolem">I</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True 17
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"bounded <span class="main">(</span>flip_int_double_upper <span class="skolem">I</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bounded_memR Inf_UNIV_nat<span class="main">)</span>
  
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">⟶</span> memR <span class="main">(</span>flip_int_double_upper <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
  
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A'</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> min <span class="main">(</span>progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B'</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">⟶</span> memR <span class="main">(</span>flip_int_double_upper <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
  
    <span class="keyword1"><span class="command">have</span></span> AA'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="skolem">A'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> τ_prefix_diff_conv
      <span class="keyword1"><span class="command">unfolding</span></span> A_def A'_def progress_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> BB'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="skolem">B'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> τ_prefix_diff_conv
      <span class="keyword1"><span class="command">unfolding</span></span> B_def B'_def progress_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
      <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> A_def B_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> non_empty<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    <span class="keyword1"><span class="command">have</span></span> progress_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Release <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">=</span> min <span class="main">(</span>Inf <span class="skolem">A</span><span class="main">)</span> <span class="main">(</span>Inf <span class="skolem">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> min_Inf<span class="main">[</span><span class="operator">OF</span> non_empty<span class="main">]</span> True
      <span class="keyword1"><span class="command">unfolding</span></span> A_def B_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> memR<span class="main">:</span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> assm<span class="main">:</span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Inf <span class="skolem">A</span> <span class="main">≤</span> Inf <span class="skolem">B</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> release_progress_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Release <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">=</span> Inf <span class="skolem">A</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> progress_eq
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 17
          <span class="keyword1"><span class="command">unfolding</span></span> A_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le not_le <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Suc_leI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span>"</span></span><span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_cInf_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> that
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> contrapos_np <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less_τD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">=</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Min <span class="skolem">J</span>"</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> release_progress_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Release <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">=</span> Inf <span class="skolem">B</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> progress_eq
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="main">(</span>flip_int_double_upper <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j'</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 17<span class="main">(</span>5<span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> B_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le not_le <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Suc_leI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span>"</span></span><span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_cInf_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="main">(</span><span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j'</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> memR_flip_int_double_upper
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">∈</span> <span class="skolem">J</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> J_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> J_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">J</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> J_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">J</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> j_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> J_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> less_j_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span><span class="main">&lt;</span><span class="skolem">j</span> <span class="main">⟹</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">l</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
          <span class="keyword3"><span class="command">assume</span></span> l_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">l</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="skolem">J</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> l_j j_props<span class="main">(</span>2<span class="main">)</span>
              <span class="keyword1"><span class="command">unfolding</span></span> J_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
              <span class="keyword1"><span class="command">using</span></span> l_j J_props
              <span class="keyword1"><span class="command">unfolding</span></span> j_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">l</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> j_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> j_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&gt;</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> plen <span class="free">π</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">≤</span> min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_g
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> less_j_mem
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> A_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> Inf <span class="skolem">A</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cInf_lower<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Inf <span class="skolem">A</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> 17<span class="main">(</span>5<span class="main">)</span> release_progress_eq False
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> not_le_imp_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> that j_props
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> contrapos_np <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less_τD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> assm<span class="main">:</span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> A_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> A_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">⟶</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> A_eq
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">⟶</span> memR <span class="main">(</span>flip_int_double_upper <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> memR_flip_int_double_upper not_le_imp_less
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> B_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inf <span class="skolem">B</span> <span class="main">≤</span> Inf <span class="skolem">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Inf_leq<span class="main">[</span><span class="operator">OF</span> non_empty<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> release_progress_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Release <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">=</span> Inf <span class="skolem">B</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> progress_eq
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>flip_int_double_upper <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 17
        <span class="keyword1"><span class="command">unfolding</span></span> B_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le not_le <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Suc_leI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span>"</span></span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_cInf_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="main">(</span>flip_int_double_upper <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assm
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"memR <span class="main">(</span>flip_int_double_upper <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
        <span class="keyword1"><span class="command">using</span></span> that
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> contrapos_np <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less_τD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> memR_flip_int_double_upper memR
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> memR<span class="main">:</span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> assm<span class="main">:</span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Inf <span class="skolem">A</span> <span class="main">≤</span> Inf <span class="skolem">B</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> release_progress_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="main">(</span>formula.Release <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">=</span> Inf <span class="skolem">A'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> progress_eq AA'_eq
          <span class="keyword1"><span class="command">unfolding</span></span> progress_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 17<span class="main">(</span>5<span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> A'_def progress_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le not_le <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Suc_leI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span>"</span></span><span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_cInf_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> that
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> contrapos_np <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less_τD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">σ'</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">=</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">≤</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Min <span class="skolem">J</span>"</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> release_progress_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="main">(</span>formula.Release <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">=</span> Inf <span class="skolem">B'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> progress_eq BB'_eq
          <span class="keyword1"><span class="command">unfolding</span></span> progress_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="main">(</span>flip_int_double_upper <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">j'</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">≤</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 17<span class="main">(</span>5<span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> B'_def progress_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le not_le <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Suc_leI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span>"</span></span><span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_cInf_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="main">(</span><span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">j'</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">≤</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> memR_flip_int_double_upper
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">∈</span> <span class="skolem">J</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> J_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> J_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">J</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> J_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="skolem">J</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> j_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> J_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> less_j_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span><span class="main">&lt;</span><span class="skolem">j</span> <span class="main">⟹</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="bound">l</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l</span>
          <span class="keyword3"><span class="command">assume</span></span> l_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">l</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="skolem">J</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> l_j j_props<span class="main">(</span>2<span class="main">)</span>
              <span class="keyword1"><span class="command">unfolding</span></span> J_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
              <span class="keyword1"><span class="command">using</span></span> l_j J_props
              <span class="keyword1"><span class="command">unfolding</span></span> j_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">l</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> j_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> j_g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&gt;</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> plen <span class="free">π</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">≤</span> min <span class="main">(</span>Monitor.progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> min <span class="main">(</span>Monitor.progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> j_g
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> less_j_mem
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">qed</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">A'</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> A'_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> Inf <span class="skolem">A'</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cInf_lower<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Inf <span class="skolem">A'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> 17<span class="main">(</span>5<span class="main">)</span> release_progress_eq False
              <span class="keyword1"><span class="command">unfolding</span></span> AA'_eq BB'_eq progress_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> not_le_imp_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> that j_props
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> contrapos_np <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less_τD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">σ'</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> assm<span class="main">:</span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> A'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A'</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> <span class="main">(</span>Monitor.progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> A'_def progress_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A'</span> <span class="main">⊆</span> <span class="skolem">B'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">A'</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> Monitor.progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">⟶</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> A'_eq
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> Monitor.progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">⟶</span> memR <span class="main">(</span>flip_int_double_upper <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> memR_flip_int_double_upper not_le_imp_less
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">B'</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> B'_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inf <span class="skolem">B'</span> <span class="main">≤</span> Inf <span class="skolem">A'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Inf_leq<span class="main">[</span><span class="operator">OF</span> non_empty<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">B'</span></span><span class="main">]</span> BB'_eq AA'_eq
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> release_progress_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="main">(</span>formula.Release <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">=</span> Inf <span class="skolem">B'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> progress_eq BB'_eq AA'_eq
        <span class="keyword1"><span class="command">unfolding</span></span> progress_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>flip_int_double_upper <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">≤</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 17<span class="main">(</span>5<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> B'_def progress_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le not_le <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Suc_leI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span>"</span></span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_cInf_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="main">(</span>flip_int_double_upper <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assm
        <span class="keyword1"><span class="command">unfolding</span></span> progress_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"memR <span class="main">(</span>flip_int_double_upper <span class="skolem">I</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
        <span class="keyword1"><span class="command">using</span></span> that
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> contrapos_np <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less_τD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">σ'</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> memR_flip_int_double_upper memR
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 21<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span> 17<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_le_gen<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 31<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">using</span></span> 11<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span> 17<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_le_gen<span class="main"><span class="main">]</span></span><span class="main">)</span>
  
    <span class="keyword1"><span class="command">have</span></span> t_eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⟹</span> τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">=</span> τ <span class="free">σ'</span> <span class="bound">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> τ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> 3<span class="main">]</span> memR_flip_int_double_upper
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    <span class="keyword1"><span class="command">have</span></span> t_eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⟹</span> τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">=</span> τ <span class="free">σ'</span> <span class="bound">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> τ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> 31<span class="main">]</span> memR_flip_int_double_upper
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword1"><span class="command">have</span></span> sat_subformulas<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span> <span class="bound">v</span><span class="main">.</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⟹</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="bound">v</span> <span class="bound">j</span> <span class="skolem">φ</span> <span class="main">=</span> Formula.sat <span class="free">σ'</span> <span class="skolem">V'</span> <span class="bound">v</span> <span class="bound">j</span> <span class="skolem">φ</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span> <span class="bound">v</span><span class="main">.</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⟹</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="bound">v</span> <span class="bound">j</span> <span class="skolem">ψ</span> <span class="main">=</span> Formula.sat <span class="free">σ'</span> <span class="skolem">V'</span> <span class="bound">v</span> <span class="bound">j</span> <span class="skolem">ψ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 17<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> True 1 17<span class="main"><span class="main">(</span></span>6-9<span class="main"><span class="main">)</span></span><span class="main">]</span> 17<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> True 2 17<span class="main"><span class="main">(</span></span>6-9<span class="main"><span class="main">)</span></span><span class="main">]</span> 17<span class="main">(</span>5<span class="main">)</span> memR_flip_int_double_upper
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span> <span class="bound">k</span><span class="main">.</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟹</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> memR_antimono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">I</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> τ_mono diff_le_mono
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span> <span class="bound">k</span><span class="main">.</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟹</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="bound">k</span> <span class="skolem">φ</span> <span class="main">=</span> Formula.sat <span class="free">σ'</span> <span class="skolem">V'</span> <span class="skolem">v</span> <span class="bound">k</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sat_subformulas<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> release_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span>mem <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>
        <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="bound">j</span> <span class="skolem">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span> <span class="main">..&lt;</span> <span class="bound">j</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="bound">k</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span>Formula.sat <span class="free">σ'</span> <span class="skolem">V'</span> <span class="skolem">v</span> <span class="bound">j</span> <span class="skolem">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span> <span class="main">..&lt;</span> <span class="bound">j</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ'</span> <span class="skolem">V'</span> <span class="skolem">v</span> <span class="bound">k</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span>
    <span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sat_subformulas<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="main">(</span>formula.Release <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
        <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> memR<span class="main">:</span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> memRi<span class="main">:</span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">i</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> t_eq2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> memR<span class="main"><span class="main">,</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> t_eq2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> memRi<span class="main"><span class="main">,</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> sat<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">j</span> <span class="skolem">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span> <span class="main">..&lt;</span> <span class="skolem">j</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="bound">k</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assm assms<span class="main">(</span>1<span class="main">)</span> mem
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ'</span> <span class="skolem">V'</span> <span class="skolem">v</span> <span class="skolem">j</span> <span class="skolem">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span> <span class="main">..&lt;</span> <span class="skolem">j</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ'</span> <span class="skolem">V'</span> <span class="skolem">v</span> <span class="bound">k</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> mem release_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ'</span> <span class="skolem">V'</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="main">(</span>formula.Release <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ'</span> <span class="skolem">V'</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="main">(</span>formula.Release <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
        <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> memR<span class="main">:</span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> memRi<span class="main">:</span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> t_eq1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> memR<span class="main"><span class="main">]</span></span> t_eq1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> memRi<span class="main"><span class="main">]</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> sat<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ'</span> <span class="skolem">V'</span> <span class="skolem">v</span> <span class="skolem">j</span> <span class="skolem">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span> <span class="main">..&lt;</span> <span class="skolem">j</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ'</span> <span class="skolem">V'</span> <span class="skolem">v</span> <span class="bound">k</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assm assms<span class="main">(</span>1<span class="main">)</span> mem
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">j</span> <span class="skolem">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span> <span class="main">..&lt;</span> <span class="skolem">j</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="bound">k</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> release_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="main">(</span>formula.Release <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>release_safe_bounded <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 17<span class="main">(</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> rewrite_conds<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded <span class="skolem">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> mem <span class="skolem">I</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword1"><span class="command">have</span></span> sat_safe_bounded_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span>
        Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="bound">v</span> <span class="skolem">i</span> <span class="main">(</span>release_safe_bounded <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">=</span> Formula.sat <span class="free">σ'</span> <span class="skolem">V'</span> <span class="bound">v</span> <span class="skolem">i</span> <span class="main">(</span>release_safe_bounded <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 17<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> False i_le 17<span class="main"><span class="main">(</span></span>6-9<span class="main"><span class="main">)</span></span><span class="main">]</span> 17<span class="main">(</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="skolem">i</span><span class="main">..&lt;</span>plen <span class="free">π</span><span class="main">}</span><span class="main">.</span> mem <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="skolem">i</span><span class="main">..&lt;</span>plen <span class="free">π</span><span class="main">}</span><span class="main">.</span> mem <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> τ_prefix_diff_conv
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="main">(</span>Formula.eventually <span class="skolem">I</span> Formula.TT<span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ'</span> <span class="skolem">V'</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="main">(</span>Formula.eventually <span class="skolem">I</span> Formula.TT<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> True
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span>
        <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="main">(</span>formula.Release <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">=</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="main">(</span>release_safe_bounded <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ'</span> <span class="skolem">V'</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="main">(</span>formula.Release <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">=</span> Formula.sat <span class="free">σ'</span> <span class="skolem">V'</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="main">(</span>release_safe_bounded <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sat_release_rewrite<span class="main">[</span><span class="operator">OF</span> rewrite_conds<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">φ</span></span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> sat_safe_bounded_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> r
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> int_props<span class="main">:</span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> int_props<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="skolem">i</span><span class="main">..&lt;</span>plen <span class="free">π</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span>mem <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="skolem">i</span><span class="main">..&lt;</span>plen <span class="free">π</span><span class="main">}</span><span class="main">.</span> <span class="main">¬</span>mem <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> τ_prefix_diff_conv
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>release_safe_bounded <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> False 17<span class="main">(</span>5<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>Formula.eventually <span class="skolem">I</span> Formula.TT<span class="main">)</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> release_safe_bounded_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>Formula.eventually <span class="skolem">I</span> Formula.TT<span class="main">)</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">=</span>
        progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="main">(</span>Formula.eventually <span class="skolem">I</span> Formula.TT<span class="main">)</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> progress_prefix_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> i_le'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="main">(</span>Formula.eventually <span class="skolem">I</span> Formula.TT<span class="main">)</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> mem <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
        <span class="keyword3"><span class="command">assume</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> plen <span class="free">π</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> plen <span class="free">π</span> <span class="main">⟶</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> plen <span class="free">π</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> plen <span class="free">π</span> <span class="main">⟶</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> plen <span class="free">π</span> <span class="main">⟹</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> assm
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="skolem">j</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> mem
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> plen <span class="free">π</span> <span class="main">⟶</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>Formula.eventually <span class="skolem">I</span> Formula.TT<span class="main">)</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> progress_eventually progress_TT
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cInf_lower<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
            <span class="keyword1"><span class="command">using</span></span> i_le
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> not_le
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span>plen <span class="free">π</span><span class="main">.</span> <span class="main">¬</span>mem <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> leD
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> not_mem_σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="skolem">i</span><span class="main">.</span> <span class="main">¬</span> mem <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> int_props
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> mem <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
        <span class="keyword3"><span class="command">assume</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> plen <span class="free">π</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> plen <span class="free">π</span> <span class="main">⟶</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> plen <span class="free">π</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> plen <span class="free">π</span> <span class="main">⟶</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> plen <span class="free">π</span> <span class="main">⟹</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> assm
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ'</span> <span class="skolem">k</span> <span class="main">≤</span> τ <span class="free">σ'</span> <span class="skolem">j</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> mem
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> plen <span class="free">π</span> <span class="main">⟶</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="main">(</span>Formula.eventually <span class="skolem">I</span> Formula.TT<span class="main">)</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> progress_eventually progress_TT
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cInf_lower<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
            <span class="keyword1"><span class="command">using</span></span> i_le'
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> not_le
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span>plen <span class="free">π</span><span class="main">.</span> <span class="main">¬</span>mem <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> leD
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> not_mem_σ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="skolem">i</span><span class="main">.</span> <span class="main">¬</span> mem <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> int_props
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> not_mem_σ not_mem_σ'
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>18 <span class="skolem">P</span> <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_mapping_alt <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_le_gen<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 18 τ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sat.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> ex_cong conj_cong match_cong_strong 18<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> progress_regex_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>19 <span class="skolem">P</span> <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 19 <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bounded <span class="skolem">I</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"bounded <span class="skolem">I</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bounded_memR Inf_UNIV_nat<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"regex.atms <span class="skolem">r</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> 19 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> plen <span class="free">π</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le not_le <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_cInf_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> τ_mono diff_le_mono memR_antimono not_le_imp_less that<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> 19 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="main">(</span>Formula.MatchF <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> progress_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> plen <span class="free">π</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le not_le <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_cInf_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> τ_mono diff_le_mono memR_antimono not_le_imp_less that<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> 19 True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sat.simps conj_commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"memL <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ex_cong conj_cong match_cong_strong<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> memL memR sat<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>memL <span class="skolem">j</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iffI<span class="main">)</span>
          <span class="main">(</span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> τ_prefix_conv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> 1<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> τ_mono<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span>
            <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> τ_prefix_conv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> 2<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> τ_mono<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>memR <span class="skolem">j</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iffI<span class="main">)</span>
          <span class="main">(</span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> τ_prefix_conv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> 2<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> τ_mono<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span>
            <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> τ_prefix_conv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> 2<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> τ_mono<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> 19 False <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>regex.atms <span class="skolem">r</span><span class="main">.</span> <span class="skolem">j</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="bound">x</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> 0 6 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le not_le progress_regex_def
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_cInf_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> regex.atms <span class="skolem">r</span> <span class="main">⟹</span> <span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="skolem">φ</span>
      <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> contrapos_np<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">&lt;</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_le_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"regex.atms <span class="skolem">r</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">using</span></span> that
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_le_gen<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> 19<span class="main"><span class="main"><span class="main">(</span></span></span>5<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> 19 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="main">(</span>Formula.MatchF <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> progress_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>regex.atms <span class="skolem">r</span><span class="main">.</span> <span class="skolem">j</span> <span class="main">≤</span> progress <span class="free">σ'</span> <span class="skolem">P</span> <span class="bound">x</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> 0 6 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le not_le progress_regex_def
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_cInf_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> regex.atms <span class="skolem">r</span> <span class="main">⟹</span> <span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="skolem">φ</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">using</span></span> progress_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> contrapos_np<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">&lt;</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_le_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 21<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ'</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ'</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">using</span></span> 11<span class="main">[</span><span class="operator">OF</span> that<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_le_gen<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> 19<span class="main"><span class="main"><span class="main">(</span></span></span>5<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
 
    
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sat.simps conj_commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"memL <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">intro</span> ex_cong conj_cong match_cong_strong 19<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> False _ _ 19<span class="main"><span class="main">(</span></span>3-6<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> memR memL progress<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>memR <span class="skolem">j</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iffI<span class="main">)</span>
          <span class="main">(</span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> τ_prefix_conv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> 2<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> τ_mono<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span>
            <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> τ_prefix_conv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> 21<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> τ_mono<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>memL <span class="skolem">j</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iffI<span class="main">)</span>
          <span class="main">(</span><span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> τ_prefix_conv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> 21<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> τ_mono<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span>
            <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> τ_prefix_conv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> 21<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> τ_mono<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>progress <span class="skolem">j</span> <span class="skolem">k</span> <span class="skolem">z</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> 1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> τ_prefix_conv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> 21<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_le_mono memR_antimono <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> contrapos_np<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted">False</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_prefix_conv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> progress <span class="free">σ</span> Map.empty <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">⟹</span>
    Formula.sat <span class="free">σ</span> Map.empty <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">⟷</span> Formula.sat <span class="free">σ'</span> Map.empty <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> sat_prefix_conv_gen<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_remove_neg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="free">P</span> <span class="main">(</span>remove_neg <span class="free">φ</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> safe_progress_get_and<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span> <span class="main">⟹</span>
  Min <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> progress <span class="free">σ</span> <span class="free">P</span> <span class="bound">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">`</span> set <span class="main">(</span>get_and_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> get_and_list.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_convert_multiway<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span> <span class="main">⟹</span> progress <span class="free">σ</span> <span class="free">P</span> <span class="main">(</span>convert_multiway <span class="free">φ</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> safe_formula_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_safe <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="main">(</span>Formula.And <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cφ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="skolem">φ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cψ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="skolem">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> c_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">=</span> Formula.Ands <span class="main">(</span>get_and_list <span class="var">?cφ</span> <span class="main">@</span> get_and_list <span class="var">?cψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_safe <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹safe_formula <span class="skolem">φ</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="var">?cφ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> safe_convert_multiway<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹safe_formula <span class="skolem">ψ</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="var">?cψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> safe_convert_multiway<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> c_eq
    <span class="keyword1"><span class="command">using</span></span> And_safe.IH
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> get_and_nonempty Min.union safe_progress_get_and<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_Not <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="main">(</span>Formula.And <span class="skolem">φ</span> <span class="main">(</span>Formula.Neg <span class="skolem">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cφ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="skolem">φ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cψ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="skolem">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> c_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">=</span> Formula.Ands <span class="main">(</span>Formula.Neg <span class="var">?cψ</span> <span class="main">#</span> get_and_list <span class="var">?cφ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_Not <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹safe_formula <span class="skolem">φ</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="var">?cφ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> safe_convert_multiway<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹safe_formula <span class="skolem">ψ</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="var">?cψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> safe_convert_multiway<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> c_eq
    <span class="keyword1"><span class="command">using</span></span> And_Not.IH
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> get_and_nonempty Min.union safe_progress_get_and<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_Trigger <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Formula.Trigger <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> Formula.And <span class="skolem">φ</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> t_not_safe_assign<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>safe_assignment <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> safe_assignment_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> t_not_constraint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_constraint <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> t_prog<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>convert_multiway <span class="skolem">t</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">t</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_Trigger<span class="main">(</span>6-7<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">P</span></span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> t_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">t</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l_props<span class="main">:</span>
      <span class="quoted"><span class="quoted">"convert_multiway <span class="skolem">f</span> <span class="main">=</span> Formula.Ands <span class="skolem">l</span>"</span></span>
      <span class="quoted"><span class="quoted">"set <span class="skolem">l</span> <span class="main">=</span> set <span class="main">(</span>get_and_list <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>convert_multiway <span class="skolem">t</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t_not_safe_assign t_not_constraint And_Trigger<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> f_def t_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_formula_dual_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">f</span> <span class="free">j</span> <span class="main">=</span> Min <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="bound">φ</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">l</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l_props<span class="main">(</span>2<span class="main">)</span> And_Trigger<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">P</span></span><span class="main">]</span> t_prog safe_convert_multiway<span class="main">[</span><span class="operator">OF</span> And_Trigger<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> f_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="skolem">φ</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> f_def t_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> convert_f<span class="main">:</span> <span class="quoted"><span class="quoted">"convert_multiway <span class="skolem">f</span> <span class="main">=</span> Formula.And <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>Formula.Trigger <span class="main">(</span>convert_multiway <span class="skolem">φ'</span><span class="main">)</span> <span class="skolem">I</span> <span class="main">(</span>convert_multiway <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t_not_safe_assign t_not_constraint
      <span class="keyword1"><span class="command">unfolding</span></span> f_def t_def convert_multiway.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> And_Trigger
      <span class="keyword1"><span class="command">unfolding</span></span> f_def t_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_convert_multiway safe_formula_dual_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_Release <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> progress_and_release_rewrite_bounded <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ands <span class="skolem">l</span> <span class="skolem">pos</span> <span class="skolem">neg</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l_future_bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>convert_multiway <span class="bound">a</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="bound">a</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">l</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span>
      <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">∈</span> set <span class="skolem">pos</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Ands<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> φ'_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">φ</span> <span class="keyword1">of</span> Formula.Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="main">∀</span><span class="bound">P</span><span class="main">.</span> progress <span class="free">σ</span> <span class="bound">P</span> <span class="main">(</span>convert_multiway <span class="bound">φ'</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="bound">P</span> <span class="bound">φ'</span> <span class="free">j</span>
           <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">(</span><span class="main">∀</span><span class="bound">P</span><span class="main">.</span> progress <span class="free">σ</span> <span class="bound">P</span> <span class="main">(</span>convert_multiway <span class="skolem">φ</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="bound">P</span> <span class="skolem">φ</span> <span class="free">j</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Ands<span class="main">(</span>1<span class="main">,</span>7<span class="main">)</span> assm
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits formula.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trigger_0 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"safe_assignment <span class="main">(</span>fv <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">φ</span> <span class="main">∨</span> is_constraint <span class="skolem">φ</span> <span class="main">∨</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">φ</span> <span class="keyword1">of</span> formula.Neg <span class="bound">φ'</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> Monitor.progress <span class="free">σ</span> <span class="bound">x</span> <span class="main">(</span>convert_multiway <span class="bound">φ'</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> Monitor.progress <span class="free">σ</span> <span class="bound">x</span> <span class="bound">φ'</span> <span class="free">j</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"safe_assignment <span class="main">(</span>fv <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> safe_assignment_def
        <span class="keyword1"><span class="command">using</span></span> Trigger_0
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"is_constraint <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Trigger_0
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">φ'</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Trigger_0 assm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="skolem">φ</span> <span class="keyword1">of</span> formula.Neg <span class="bound">φ'</span> <span class="main">⇒</span> safe_formula <span class="bound">φ'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> Monitor.progress <span class="free">σ</span> <span class="bound">x</span> <span class="main">(</span>convert_multiway <span class="bound">φ'</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> Monitor.progress <span class="free">σ</span> <span class="bound">x</span> <span class="bound">φ'</span> <span class="free">j</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> φ'_props<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">=</span> formula.Neg <span class="skolem">φ'</span>"</span></span>
        <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">φ'</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> Monitor.progress <span class="free">σ</span> <span class="bound">x</span> <span class="main">(</span>convert_multiway <span class="skolem">φ'</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> Monitor.progress <span class="free">σ</span> <span class="bound">x</span> <span class="skolem">φ'</span> <span class="free">j</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Trigger_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Trigger_0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Release_0 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> progress_release_rewrite_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MatchP <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MatchP <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> progress.simps regex.map convert_multiway.simps regex.set_map image_image
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> if_cong arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">Min</span><span class="main"><span class="main">]</span></span> image_cong<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atms_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> disjE_Not2 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> safe_regex_safe_formula<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MatchF <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MatchF <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> progress.simps regex.map convert_multiway.simps regex.set_map image_image
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> if_cong arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">Min</span><span class="main"><span class="main">]</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">Inf</span><span class="main"><span class="main">]</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">(≤)</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span>
      image_cong Collect_cong all_cong1 imp_cong conj_cong image_cong<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atms_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> disjE_Not2 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> safe_regex_safe_formula<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Specification›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pprogress</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Formula.formula <span class="main">⇒</span> Formula.prefix <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pprogress</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> prefix_of <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="bound">σ</span> <span class="main">⟶</span> progress <span class="bound">σ</span> Map.empty <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>plen <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="bound">n</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pprogress_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ</span> <span class="main">⟹</span> pprogress <span class="free">φ</span> <span class="free">π</span> <span class="main">=</span> progress <span class="free">σ</span> Map.empty <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pprogress_def <span class="keyword1"><span class="command">using</span></span> progress_prefix_conv
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">locale</span></span> future_bounded_mfodl <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted">Formula.formula</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> future_bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.future_bounded <span class="free">φ</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> future_bounded_mfodl <span class="main">⊆</span> sliceable_timed_progress <span class="quoted"><span class="quoted">"Formula.nfv <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.fv <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"relevant_events <span class="free">φ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">σ</span> <span class="bound">v</span> <span class="bound">i</span><span class="main">.</span> Formula.sat <span class="bound">σ</span> Map.empty <span class="bound">v</span> <span class="bound">i</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"pprogress <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fvi_less_nfv<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">v</span> <span class="skolem">v'</span> <span class="skolem">σ</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> sat_fv_cong<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">v</span> <span class="skolem">S</span> <span class="skolem">σ</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> sat_slice_iff<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">π</span> <span class="skolem">π'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="skolem">π'</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_prefix_of <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="skolem">π</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefix_of_antimono<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">≤</span> <span class="skolem">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹prefix_of <span class="skolem">π'</span> <span class="skolem">σ</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pprogress_eq plen_mono progress_mono<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">σ</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> progress <span class="skolem">σ</span> Map.empty <span class="free">φ</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> future_bounded progress_ge <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> pprogress <span class="free">φ</span> <span class="main">(</span>take_prefix <span class="skolem">j</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pprogress_eq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">σ</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">π</span> <span class="skolem">σ</span> <span class="skolem">σ'</span> <span class="skolem">i</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> progress <span class="skolem">σ</span> Map.empty <span class="free">φ</span> <span class="main">(</span>plen <span class="skolem">π</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pprogress_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 6 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> sat_prefix_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">π</span> <span class="skolem">π'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"plen <span class="skolem">π</span> <span class="main">=</span> plen <span class="skolem">π'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="skolem">π</span> <span class="skolem">σ</span>"</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="skolem">π'</span> <span class="skolem">σ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_prefix_of <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> plen <span class="skolem">π</span><span class="main">.</span> τ <span class="skolem">σ</span> <span class="bound">i</span> <span class="main">=</span> τ <span class="skolem">σ'</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 7 calculation
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pprogress_eq progress_time_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">locale</span></span> verimon_spec <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted">Formula.formula</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> monitorable<span class="main">:</span> <span class="quoted"><span class="quoted">"mmonitorable <span class="free">φ</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> verimon_spec <span class="main">⊆</span> future_bounded_mfodl
  <span class="keyword1"><span class="command">using</span></span> monitorable <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mmonitorable_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_mbuf2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_mbuf2</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">ja</span></span></span> <span class="free"><span class="bound"><span class="entity">jb</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">ja</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">jb</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">⇒</span>
    list_all2 <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">ja</span></span></span><span class="main">]</span> <span class="bound">xs</span> <span class="main">∧</span> list_all2 <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">jb</span></span></span><span class="main">]</span> <span class="bound">ys</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">list_all3</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'c</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> bool<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_all3</span> <span class="free">P</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">a3</span></span></span> <span class="main">⟹</span> <span class="free">list_all3</span> <span class="free">P</span> <span class="free"><span class="bound"><span class="entity">q1</span></span></span> <span class="free"><span class="bound"><span class="entity">q2</span></span></span> <span class="free"><span class="bound"><span class="entity">q3</span></span></span> <span class="main">⟹</span> <span class="free">list_all3</span> <span class="free">P</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">q1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">q2</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a3</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">q3</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_all3_list_all2D<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all3 <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span> <span class="main">⟹</span>
  <span class="main">(</span>length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">∧</span> list_all2 <span class="main">(</span>case_prod <span class="free">P</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_all3.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all2_list_all3I<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">⟹</span> list_all2 <span class="main">(</span>case_prod <span class="free">P</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="free">zs</span> <span class="main">⟹</span>
  list_all3 <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_Cons1 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> list_all3.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all3_list_all2_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all3 <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span> <span class="main">⟷</span>
  <span class="main">(</span>length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">∧</span> list_all2 <span class="main">(</span>case_prod <span class="free">P</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> list_all2_list_all3I list_all3_list_all2D <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all3_mapD<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all3 <span class="free">P</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>map <span class="free">g</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span>map <span class="free">h</span> <span class="free">zs</span><span class="main">)</span> <span class="main">⟹</span>
  list_all3 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"map <span class="free">g</span> <span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"map <span class="free">h</span> <span class="free">zs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_all3.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> list_all3.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all3_mapI<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all3 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span> <span class="main">⟹</span>
  list_all3 <span class="free">P</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>map <span class="free">g</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span>map <span class="free">h</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_all3.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> list_all3.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all3_map_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all3 <span class="free">P</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>map <span class="free">g</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span>map <span class="free">h</span> <span class="free">zs</span><span class="main">)</span> <span class="main">⟷</span>
  list_all3 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span><span class="free">h</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> list_all3_mapD list_all3_mapI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemmas</span></span> list_all3_map <span class="main">=</span>
  list_all3_map_iff<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g<span class="main"><span class="main">=</span></span><span class="quoted">id</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> h<span class="main"><span class="main">=</span></span><span class="quoted">id</span><span class="main">,</span> <span class="operator">unfolded</span> list.map_id id_apply<span class="main">]</span>
  list_all3_map_iff<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted">id</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> h<span class="main"><span class="main">=</span></span><span class="quoted">id</span><span class="main">,</span> <span class="operator">unfolded</span> list.map_id id_apply<span class="main">]</span>
  list_all3_map_iff<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span><span class="quoted">id</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> g<span class="main"><span class="main">=</span></span><span class="quoted">id</span><span class="main">,</span> <span class="operator">unfolded</span> list.map_id id_apply<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all3_conv_all_nth<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all3 <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span> <span class="main">=</span>
  <span class="main">(</span>length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span> <span class="main">∧</span> length <span class="free">ys</span> <span class="main">=</span> length <span class="free">zs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">zs</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all3_list_all2_eq list_all2_conv_all_nth<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all3_refl <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">x</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> list_all3 <span class="free">P</span> <span class="free">xs</span> <span class="free">xs</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all3_conv_all_nth<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_mbufn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat list <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> event_data table <span class="main">⇒</span> bool<span class="main">)</span> list <span class="main">⇒</span> event_data mbufn <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_mbufn</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">js</span></span></span> <span class="free"><span class="bound"><span class="entity">Ps</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟷</span> list_all3 <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">j</span> <span class="bound">xs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> list_all2 <span class="bound">P</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">..&lt;</span><span class="bound">j</span><span class="main">]</span> <span class="bound">xs</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Ps</span></span></span> <span class="free"><span class="bound"><span class="entity">js</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_mbuf2'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Formula.trace <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> event_data list set <span class="main">⇒</span>
  Formula.formula <span class="main">⇒</span> Formula.formula <span class="main">⇒</span> event_data mbuf2 <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_mbuf2'</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟷</span> wf_mbuf2 <span class="main">(</span>min <span class="main">(</span>progress <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span>progress <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>progress <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span>progress <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="main">(</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span> qtable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="main">(</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span> qtable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_dfvs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"
  <span class="free">wf_dfvs</span> <span class="free"><span class="bound"><span class="entity">dfvs</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">.</span> <span class="main">¬</span> mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
    <span class="free"><span class="bound"><span class="entity">dfvs</span></span></span> <span class="main">=</span> <span class="main">{}</span>
  <span class="keyword1">else</span>
    <span class="free"><span class="bound"><span class="entity">dfvs</span></span></span> <span class="main">=</span> fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_mbuft2'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Formula.trace <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> event_data list set <span class="main">⇒</span>
  Formula.formula <span class="main">⇒</span> Formula.formula <span class="main">⇒</span> ℐ <span class="main">⇒</span> Formula.formula <span class="main">⇒</span> event_data mbuft2 <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_mbuft2'</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟷</span> wf_mbuf2 <span class="main">(</span>min <span class="main">(</span>progress <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span>progress <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>formula.Trigger <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>progress <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span>progress <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>formula.Trigger <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="main">(</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span> qtable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="main">(</span><span class="bound">dfvs</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> wf_dfvs <span class="bound">dfvs</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span> <span class="main">∧</span> qtable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">dfvs</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span>"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_mbufn'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Formula.trace <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> event_data list set <span class="main">⇒</span>
  Formula.formula Regex.regex <span class="main">⇒</span> event_data mbufn <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_mbufn'</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span>  <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> to_mregex <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">mr</span><span class="main">,</span> <span class="bound">φs</span><span class="main">)</span> <span class="main">⇒</span>
    wf_mbufn <span class="main">(</span>progress_regex <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> progress <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">φ</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="bound">φs</span><span class="main">)</span>
    <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span> qtable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>fv <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">φ</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">φs</span><span class="main">)</span>
    <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_mbuf2'_UNIV_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="free">P</span> <span class="free">V</span> <span class="free">j</span> <span class="free">n</span> UNIV <span class="free">φ</span> <span class="free">ψ</span> <span class="free">buf</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">buf</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">⇒</span>
  list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="main">(</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span> wf_table <span class="free">n</span> <span class="main">(</span>fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">φ</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>
    <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span> <span class="main">..&lt;</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span><span class="main">]</span> <span class="bound">xs</span> <span class="main">∧</span>
  list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="main">(</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span> wf_table <span class="free">n</span> <span class="main">(</span>fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">ψ</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>
    <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span> <span class="main">..&lt;</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span><span class="main">]</span> <span class="bound">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2'_def wf_mbuf2_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mem_restr_UNIV<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> eqTrueI<span class="main"><span class="main">,</span></span> <span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_ts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Formula.trace <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> nat <span class="main">⇒</span> Formula.formula <span class="main">⇒</span> Formula.formula <span class="main">⇒</span> ts list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_ts</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">⟷</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>min <span class="main">(</span>progress <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span>progress <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_ts_regex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Formula.trace <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> nat <span class="main">⇒</span> Formula.formula Regex.regex <span class="main">⇒</span> ts list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_ts_regex</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">⟷</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>progress_regex <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Sincep</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> Formula.Since <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">else</span> Formula.Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> msaux<span class="main">)</span> <span class="entity">wf_since_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Formula.trace <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> event_data list set <span class="main">⇒</span> args <span class="main">⇒</span>
  Formula.formula <span class="main">⇒</span> Formula.formula <span class="main">⇒</span> <span class="tfree">'msaux</span> <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_since_aux</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">⟷</span> Formula.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⊆</span> Formula.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">cur</span> <span class="bound">auxlist</span><span class="main">.</span> <span class="free">valid_msaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="bound">cur</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="bound">auxlist</span> <span class="main">∧</span>
    <span class="bound">cur</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">&gt;</span> fst <span class="bound">y</span><span class="main">)</span> <span class="bound">auxlist</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">auxlist</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">≤</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span>
      qtable <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>Sincep <span class="main">(</span>args_pos <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>point <span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">≤</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">auxlist</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_matchP_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Formula.trace <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> nat <span class="main">⇒</span> event_data list set <span class="main">⇒</span>
    ℐ <span class="main">⇒</span> Formula.formula Regex.regex <span class="main">⇒</span> event_data mrδaux <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_matchP_aux</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">⟷</span> sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">&gt;</span> fst <span class="bound">y</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">≤</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">∧</span> memR <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="keyword1">case</span> to_mregex <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">mr</span><span class="main">,</span> <span class="bound">φs</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">ms</span> <span class="main">∈</span> RPDs <span class="bound">mr</span><span class="main">.</span> qtable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.fv_regex <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span>
         <span class="main">(</span>Formula.MatchP <span class="main">(</span>point <span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>from_mregex <span class="bound">ms</span> <span class="bound">φs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
         <span class="main">(</span>lookup <span class="bound">X</span> <span class="bound">ms</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">≤</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">∧</span> memR <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> qtable_mem_restr_UNIV<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span><span class="main">(</span>mem_restr UNIV<span class="main">)</span> <span class="free">Q</span> <span class="free">X</span> <span class="main">=</span> wf_table <span class="free">n</span> <span class="free">A</span> <span class="free">Q</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> qtable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> msaux<span class="main">)</span> wf_since_aux_UNIV_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_since_aux <span class="free">σ</span> <span class="free">V</span> UNIV <span class="free">args</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="free">aux</span> <span class="free">ne</span> <span class="main">⟷</span> Formula.fv <span class="free">φ</span> <span class="main">⊆</span> Formula.fv <span class="free">ψ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">cur</span> <span class="bound">auxlist</span><span class="main">.</span> <span class="free">valid_msaux</span> <span class="free">args</span> <span class="bound">cur</span> <span class="free">aux</span> <span class="bound">auxlist</span> <span class="main">∧</span>
    <span class="bound">cur</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">ne</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">&gt;</span> fst <span class="bound">y</span><span class="main">)</span> <span class="bound">auxlist</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">auxlist</span> <span class="main">⟶</span> <span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span>
      wf_table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free">ψ</span><span class="main">)</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Sincep <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="free">φ</span> <span class="main">(</span>point <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">auxlist</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_since_aux_def qtable_mem_restr_UNIV <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_until_auxlist</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Formula.trace <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> nat <span class="main">⇒</span> event_data list set <span class="main">⇒</span> bool <span class="main">⇒</span>
    Formula.formula <span class="main">⇒</span> ℐ <span class="main">⇒</span> Formula.formula <span class="main">⇒</span> event_data muaux <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_until_auxlist</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">⟷</span>
    list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r1</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">i</span> <span class="main">∧</span>
      qtable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">+</span>length <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>
          <span class="keyword1">else</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">+</span>length <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">r1</span> <span class="main">∧</span>
      qtable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">+</span> length <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span> <span class="main">∧</span> mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
          Formula.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">j</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span>
          <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span><span class="main">..&lt;</span><span class="bound">j</span><span class="main">}</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="keyword1">then</span> Formula.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">else</span> <span class="main">¬</span> Formula.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">r2</span><span class="main">)</span>
      <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">+</span>length <span class="free"><span class="bound"><span class="entity">auxlist</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> muaux<span class="main">)</span> <span class="entity">wf_until_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Formula.trace <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> event_data list set <span class="main">⇒</span> args <span class="main">⇒</span>
  Formula.formula <span class="main">⇒</span> Formula.formula <span class="main">⇒</span> <span class="tfree">'muaux</span> <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_until_aux</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">⟷</span> Formula.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⊆</span> Formula.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">cur</span> <span class="bound">auxlist</span><span class="main">.</span> <span class="free">valid_muaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="bound">cur</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="bound">auxlist</span> <span class="main">∧</span>
      <span class="bound">cur</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">+</span> length <span class="bound">auxlist</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">+</span> length <span class="bound">auxlist</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      wf_until_auxlist <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>args_pos <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="bound">auxlist</span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> muaux<span class="main">)</span> wf_until_aux_UNIV_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_until_aux <span class="free">σ</span> <span class="free">V</span> UNIV <span class="free">args</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="free">aux</span> <span class="free">ne</span> <span class="main">⟷</span> Formula.fv <span class="free">φ</span> <span class="main">⊆</span> Formula.fv <span class="free">ψ</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">cur</span> <span class="bound">auxlist</span><span class="main">.</span> <span class="free">valid_muaux</span> <span class="free">args</span> <span class="bound">cur</span> <span class="free">aux</span> <span class="bound">auxlist</span> <span class="main">∧</span>
      <span class="bound">cur</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">ne</span> <span class="main">+</span> length <span class="bound">auxlist</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">+</span> length <span class="bound">auxlist</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r1</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">∧</span>
      wf_table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span>
          <span class="keyword1">then</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span><span class="main">..&lt;</span><span class="free">ne</span><span class="main">+</span>length <span class="bound">auxlist</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>
          <span class="keyword1">else</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span><span class="main">..&lt;</span><span class="free">ne</span><span class="main">+</span>length <span class="bound">auxlist</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="bound">r1</span> <span class="main">∧</span>
      wf_table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">ne</span> <span class="main">+</span> length <span class="bound">auxlist</span> <span class="main">∧</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span>
          Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">j</span> <span class="free">ψ</span> <span class="main">∧</span>
          <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span><span class="main">..&lt;</span><span class="bound">j</span><span class="main">}</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="keyword1">then</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free">φ</span> <span class="keyword1">else</span> <span class="main">¬</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="bound">r2</span><span class="main">)</span>
      <span class="bound">auxlist</span> <span class="main">[</span><span class="free">ne</span><span class="main">..&lt;</span><span class="free">ne</span><span class="main">+</span>length <span class="bound">auxlist</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_until_aux_def wf_until_auxlist_def qtable_mem_restr_UNIV <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> mtaux<span class="main">)</span> <span class="entity">wf_trigger_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Formula.trace <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> event_data list set <span class="main">⇒</span> args <span class="main">⇒</span>
  Formula.formula <span class="main">⇒</span> Formula.formula <span class="main">⇒</span> <span class="tfree">'mtaux</span> <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_trigger_aux</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">⟷</span> Formula.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⊆</span> Formula.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">cur</span> <span class="bound">auxlist</span><span class="main">.</span> <span class="free">valid_mtaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="bound">cur</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span><span class="bound">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">auxlist</span><span class="main">)</span> <span class="main">∧</span>
    <span class="bound">cur</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">≤</span> fst <span class="bound">y</span><span class="main">)</span> <span class="bound">auxlist</span> <span class="main">∧</span>
    length <span class="bound">auxlist</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="bound">auxlist</span><span class="main">]</span> <span class="bound">auxlist</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">≤</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span>
      qtable <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="bound">l</span>  <span class="main">∧</span>
      qtable <span class="main">(</span>args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≤</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">i</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">=</span> <span class="bound">auxlist</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_matchF_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Formula.trace <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> nat <span class="main">⇒</span> event_data list set <span class="main">⇒</span>
    ℐ <span class="main">⇒</span> Formula.formula Regex.regex <span class="main">⇒</span> event_data mlδaux <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_matchF_aux</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> to_mregex <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">mr</span><span class="main">,</span> <span class="bound">φs</span><span class="main">)</span> <span class="main">⇒</span>
      list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">rels</span><span class="main">,</span> <span class="bound">rel</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">i</span> <span class="main">∧</span>
        list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> qtable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.fv <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span>
          Formula.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span> <span class="bound">φs</span> <span class="bound">rels</span> <span class="main">∧</span>
        qtable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.fv_regex <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">+</span> length <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∧</span> mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
          Regex.match <span class="main">(</span>Formula.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="bound">rel</span><span class="main">)</span>
    <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">+</span>length <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_matchF_invar</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_matchF_invar</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">aux</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">aux</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> wf_matchF_aux <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">aux</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">0</span> <span class="main">∧</span>
     <span class="main">(</span><span class="keyword1">case</span> to_mregex <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">mr</span><span class="main">,</span> <span class="bound">φs</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">∀</span><span class="bound">ms</span> <span class="main">∈</span> LPDs <span class="bound">mr</span><span class="main">.</span>
       qtable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.fv_regex <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span>
         Regex.match <span class="main">(</span>Formula.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>from_mregex <span class="bound">ms</span> <span class="bound">φs</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> length <span class="bound">aux</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lookup <span class="bound">Y</span> <span class="bound">ms</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lift_envs'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> event_data list set <span class="main">⇒</span> event_data list set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lift_envs'</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span><span class="bound">ys</span><span class="main">)</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">@</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">{</span><span class="bound">xs</span><span class="main">.</span> length <span class="bound">xs</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">}</span> <span class="main">×</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">formula_of_constraint</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Formula.trm <span class="main">×</span> bool <span class="main">×</span> mconstraint <span class="main">×</span> Formula.trm <span class="main">⇒</span> Formula.formula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">formula_of_constraint</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> True<span class="main">,</span> MEq<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> Formula.Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">formula_of_constraint</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> True<span class="main">,</span> MLess<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> Formula.Less <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">formula_of_constraint</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> True<span class="main">,</span> MLessEq<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> Formula.LessEq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">formula_of_constraint</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> False<span class="main">,</span> MEq<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> Formula.Neg <span class="main">(</span>Formula.Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">formula_of_constraint</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> False<span class="main">,</span> MLess<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> Formula.Neg <span class="main">(</span>Formula.Less <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">formula_of_constraint</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> False<span class="main">,</span> MLessEq<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> Formula.Neg <span class="main">(</span>Formula.LessEq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> maux<span class="main">)</span> <span class="entity">wf_mformula</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Formula.trace <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span>
  nat <span class="main">⇒</span> event_data list set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mformula <span class="main">⇒</span> Formula.formula <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">σ</span> <span class="entity">j</span> <span class="keyword2"><span class="keyword">where</span></span>
    Eq<span class="main">:</span> <span class="quoted"><span class="quoted">"is_simple_eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">⟹</span>
    <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>Formula.fv_trm <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>Formula.fv_trm <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MRel <span class="main">(</span>eq_rel <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Formula.Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> neq_Var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MRel empty_table<span class="main">)</span> <span class="main">(</span>Formula.Neg <span class="main">(</span>Formula.Eq <span class="main">(</span>Formula.Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> Pred<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>Formula.fv <span class="main">(</span>Formula.Pred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
    <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">.</span> Formula.is_Var <span class="bound">t</span> <span class="main">∨</span> Formula.is_Const <span class="bound">t</span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MPred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.Pred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> Let<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> UNIV <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">↦</span> progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">↦</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> length <span class="bound">v</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="bound">v</span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">}</span> <span class="main">⊆</span> Formula.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> Formula.nfv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MLet <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.Let <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> And<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span> <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">χ</span></span></span> <span class="main">=</span> Formula.And <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span>
      <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">χ</span></span></span> <span class="main">=</span> Formula.And <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">(</span>Formula.Neg <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span> <span class="main">∧</span> Formula.fv <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⊆</span> Formula.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    wf_mbuf2' <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MAnd <span class="main">(</span>fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="main">(</span>fv <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">χ</span></span></span>"</span></span>
  <span class="main">|</span> AndAssign<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∉</span> Formula.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span> Formula.fv_trm <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⊆</span> Formula.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">=</span> Formula.Eq <span class="main">(</span>Formula.Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">=</span> Formula.Eq <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span>Formula.Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MAndAssign <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> AndRel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">=</span> formula_of_constraint <span class="free"><span class="bound"><span class="entity">conf</span></span></span> <span class="main">⟹</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span> <span class="keyword1">in</span> Formula.fv_trm <span class="bound">t1</span> <span class="main">∪</span> Formula.fv_trm <span class="bound">t2</span> <span class="main">⊆</span> Formula.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MAndRel <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">conf</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> And_Trigger<span class="main">:</span> <span class="quoted"><span class="quoted">"
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">α'</span></span></span> <span class="main">⟹</span>
    wf_mbuft2' <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">α'</span></span></span> <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">buf1</span></span></span> <span class="main">⟹</span>
    fv <span class="main">(</span>Formula.Trigger <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span> <span class="main">⊆</span> fv <span class="free"><span class="bound"><span class="entity">α'</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    <span class="keyword1">if</span> args_pos <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="main">=</span> Formula.Neg <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    safe_formula <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="main">=</span> args_pos <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">⟹</span>
    args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">⟹</span>
    args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
    args_L <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">=</span> Formula.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    args_R <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">=</span> Formula.fv <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>Formula.fv <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
    <span class="keyword1">if</span> mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">0</span> <span class="keyword1">then</span>
      Formula.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⊆</span> Formula.fv <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span>
    <span class="keyword1">else</span>
      Formula.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">=</span> Formula.fv <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span>
    <span class="main">⟹</span>
    wf_mbuf2' <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">buf2</span></span></span> <span class="main">⟹</span>
    wf_ts <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">⟹</span>
    wf_trigger_aux <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.Trigger <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MAndTrigger <span class="main">(</span>fv <span class="free"><span class="bound"><span class="entity">α'</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">buf1</span></span></span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf2</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.And <span class="free"><span class="bound"><span class="entity">α'</span></span></span> <span class="main">(</span>Formula.Trigger <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> And_Release<span class="main">:</span> <span class="quoted"><span class="quoted">"
    <span class="main">¬</span>mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">0</span> <span class="main">⟹</span>
    bounded <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">⟹</span>
    Formula.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">=</span> Formula.fv <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">(</span>and_release_safe_bounded <span class="free"><span class="bound"><span class="entity">α'</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">(</span>Formula.And <span class="free"><span class="bound"><span class="entity">α'</span></span></span> <span class="main">(</span>Formula.Release <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">|</span> Ands<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="bound">φ'</span><span class="main">.</span> <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">φ</span> <span class="bound">φ'</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l_pos</span></span></span> <span class="main">@</span> map remove_neg <span class="free"><span class="bound"><span class="entity">l_neg</span></span></span><span class="main">)</span> <span class="main">⟹</span>
    wf_mbufn <span class="main">(</span>progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.Ands <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ψ</span><span class="main">.</span> progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">ψ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l_pos</span></span></span> <span class="main">@</span> map remove_neg <span class="free"><span class="bound"><span class="entity">l_neg</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ψ</span> <span class="bound">i</span><span class="main">.</span>
      qtable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>Formula.fv <span class="bound">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l_pos</span></span></span> <span class="main">@</span> map remove_neg <span class="free"><span class="bound"><span class="entity">l_neg</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l_pos</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">l_neg</span></span></span><span class="main">)</span> <span class="main">=</span> partition safe_formula <span class="free"><span class="bound"><span class="entity">l'</span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">l_pos</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span>
    list_all safe_formula <span class="main">(</span>map remove_neg <span class="free"><span class="bound"><span class="entity">l_neg</span></span></span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">A_pos</span></span></span> <span class="main">=</span> map fv <span class="free"><span class="bound"><span class="entity">l_pos</span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">A_neg</span></span></span> <span class="main">=</span> map fv <span class="free"><span class="bound"><span class="entity">l_neg</span></span></span> <span class="main">⟹</span>
    <span class="main">⋃</span><span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">A_neg</span></span></span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">A_pos</span></span></span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MAnds <span class="free"><span class="bound"><span class="entity">A_pos</span></span></span> <span class="free"><span class="bound"><span class="entity">A_neg</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.Ands <span class="free"><span class="bound"><span class="entity">l'</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> Or<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span> <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    Formula.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">=</span> Formula.fv <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    wf_mbuf2' <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.Or <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> Neg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span> Formula.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MNeg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.Neg <span class="free"><span class="bound"><span class="entity">φ'</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> Exists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>lift_envs <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MExists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.Exists <span class="free"><span class="bound"><span class="entity">φ'</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> Agg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>lift_envs' <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∉</span> Formula.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">}</span> <span class="main">⊆</span> Formula.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    Formula.fv_trm <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⊆</span> Formula.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">g0</span></span></span> <span class="main">=</span> <span class="main">(</span>Formula.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MAgg <span class="free"><span class="bound"><span class="entity">g0</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.Agg <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> Prev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">first</span></span></span> <span class="main">⟷</span> <span class="free">j</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span>
    list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="main">(</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span> qtable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>
      <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free">j</span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟹</span>
    list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MPrev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">first</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> Next<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">first</span></span></span> <span class="main">⟷</span> progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free">j</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span>
    list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MNext <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">first</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> Since<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span> <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    <span class="keyword1">if</span> args_pos <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="main">=</span> Formula.Neg <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    safe_formula <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="main">=</span> args_pos <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">⟹</span>
    args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">⟹</span>
    args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
    args_L <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">=</span> Formula.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    args_R <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">=</span> Formula.fv <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    Formula.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⊆</span> Formula.fv <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    wf_mbuf2' <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟹</span>
    wf_ts <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">⟹</span>
    wf_since_aux <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.Since <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MSince <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.Since <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> Until<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span> <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    <span class="keyword1">if</span> args_pos <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="main">=</span> Formula.Neg <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    safe_formula <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="main">=</span> args_pos <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">⟹</span>
    args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">⟹</span>
    args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
    args_L <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">=</span> Formula.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    args_R <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">=</span> Formula.fv <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    Formula.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⊆</span> Formula.fv <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    wf_mbuf2' <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟹</span>
    wf_ts <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">j</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> τ <span class="free">σ</span> <span class="main">(</span>min <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
    wf_until_aux <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.Until <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟹</span>
    progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.Until <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span> <span class="free">j</span> <span class="main">+</span> <span class="free">length_muaux</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">=</span> min <span class="main">(</span>progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free">j</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MUntil <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.Until <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> Trigger_0<span class="main">:</span> <span class="quoted"><span class="quoted">"
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    <span class="keyword1">if</span> args_pos <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="main">=</span> Formula.Neg <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    safe_formula <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="main">=</span> args_pos <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">⟹</span>
    args_ivl <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">⟹</span>
    args_n <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
    args_L <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">=</span> Formula.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    args_R <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="main">=</span> Formula.fv <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>Formula.fv <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
    <span class="keyword1">if</span> mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span>Formula.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⊆</span> Formula.fv <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span> <span class="keyword1">else</span> Formula.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">=</span> Formula.fv <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    wf_mbuf2' <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟹</span>
    wf_ts <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">⟹</span>
    wf_trigger_aux <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.Trigger <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟹</span>
    mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">0</span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MTrigger <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.Trigger <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> Release_0<span class="main">:</span> <span class="quoted"><span class="quoted">"
    mem <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">0</span> <span class="main">⟹</span>
    bounded <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">⟹</span>
    Formula.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⊆</span> Formula.fv <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">(</span>release_safe_0 <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">(</span>Formula.Release <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> MatchP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> to_mregex <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">mr'</span><span class="main">,</span> <span class="bound">φs'</span><span class="main">)</span> <span class="main">⇒</span>
      list_all2 <span class="main">(</span><span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="bound">φs'</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">mr</span></span></span> <span class="main">=</span> <span class="bound">mr'</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">mrs</span></span></span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span>RPDs <span class="free"><span class="bound"><span class="entity">mr</span></span></span><span class="main">)</span> <span class="main">⟹</span>
    safe_regex Past Strict <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟹</span>
    wf_mbufn' <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟹</span>
    wf_ts_regex <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">⟹</span>
    wf_matchP_aux <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.MatchP <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MMatchP <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">mr</span></span></span> <span class="free"><span class="bound"><span class="entity">mrs</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.MatchP <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>
  <span class="main">|</span> MatchF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> to_mregex <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">mr'</span><span class="main">,</span> <span class="bound">φs'</span><span class="main">)</span> <span class="main">⇒</span>
      list_all2 <span class="main">(</span><span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="bound">φs'</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">mr</span></span></span> <span class="main">=</span> <span class="bound">mr'</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">mrs</span></span></span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span>LPDs <span class="free"><span class="bound"><span class="entity">mr</span></span></span><span class="main">)</span> <span class="main">⟹</span>
    safe_regex Futu Strict <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟹</span>
    wf_mbufn' <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟹</span>
    wf_ts_regex <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">j</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> τ <span class="free">σ</span> <span class="main">(</span>min <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>progress_regex <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
    wf_matchF_aux <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.MatchF <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">0</span> <span class="main">⟹</span>
    progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span>Formula.MatchF <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free">j</span> <span class="main">+</span> length <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">=</span> progress_regex <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free">j</span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MMatchF <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">mr</span></span></span> <span class="free"><span class="bound"><span class="entity">mrs</span></span></span> <span class="free"><span class="bound"><span class="entity">φs</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">(</span>Formula.MatchF <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> maux<span class="main">)</span> <span class="entity">wf_mstate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"Formula.formula <span class="main">⇒</span> Formula.prefix <span class="main">⇒</span> event_data list set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mstate <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_mstate</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">⟷</span> mstate_n <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> Formula.nfv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> prefix_of <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="bound">σ</span> <span class="main">⟶</span>
    mstate_i <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> progress <span class="bound">σ</span> Map.empty <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>plen <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">)</span> <span class="main">∧</span>
    wf_mformula <span class="bound">σ</span> <span class="main">(</span>plen <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">)</span> Map.empty Map.empty <span class="main">(</span>mstate_n <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>mstate_m <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Initialisation›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_mbuf2'_0<span class="main">:</span> <span class="quoted"><span class="quoted">"pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="free">P</span> <span class="main">⟹</span> wf_mbuf2' <span class="free">σ</span> <span class="free">P</span> <span class="free">V</span> <span class="main">0</span> <span class="free">n</span> <span class="free">R</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2'_def wf_mbuf2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_mbufn'_0<span class="main">:</span> <span class="quoted"><span class="quoted">"to_mregex <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">mr</span><span class="main">,</span> <span class="free">φs</span><span class="main">)</span> <span class="main">⟹</span> pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="free">P</span> <span class="main">⟹</span> wf_mbufn' <span class="free">σ</span> <span class="free">P</span> <span class="free">V</span> <span class="main">0</span> <span class="free">n</span> <span class="free">R</span> <span class="free">r</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="free">φs</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_mbufn'_def wf_mbufn_def map_replicate_const<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all3_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> list_all3_refl <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Min_eq_iff progress_regex_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_ts_0<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_ts <span class="free">σ</span> <span class="free">P</span> <span class="main">0</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_ts_regex_0<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_ts_regex <span class="free">σ</span> <span class="free">P</span> <span class="main">0</span> <span class="free">r</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_regex_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> msaux<span class="main">)</span> wf_since_aux_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.fv <span class="free">φ'</span> <span class="main">⊆</span> Formula.fv <span class="free">ψ'</span> <span class="main">⟹</span>
  wf_since_aux <span class="free">σ</span> <span class="free">V</span> <span class="free">R</span> <span class="main">(</span>init_args <span class="free">I</span> <span class="free">n</span> <span class="main">(</span>Formula.fv <span class="free">φ'</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free">ψ'</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span> <span class="free">φ'</span> <span class="free">ψ'</span> <span class="main">(</span><span class="free">init_msaux</span> <span class="main">(</span>init_args <span class="free">I</span> <span class="free">n</span> <span class="main">(</span>Formula.fv <span class="free">φ'</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free">ψ'</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_since_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> valid_init_msaux<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> muaux<span class="main">)</span> wf_until_aux_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.fv <span class="free">φ'</span> <span class="main">⊆</span> Formula.fv <span class="free">ψ'</span> <span class="main">⟹</span>
  wf_until_aux <span class="free">σ</span> <span class="free">V</span> <span class="free">R</span> <span class="main">(</span>init_args <span class="free">I</span> <span class="free">n</span> <span class="main">(</span>Formula.fv <span class="free">φ'</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free">ψ'</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span> <span class="free">φ'</span> <span class="free">ψ'</span> <span class="main">(</span><span class="free">init_muaux</span> <span class="main">(</span>init_args <span class="free">I</span> <span class="free">n</span> <span class="main">(</span>Formula.fv <span class="free">φ'</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free">ψ'</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_until_aux_def wf_until_auxlist_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> valid_init_muaux<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_matchP_aux_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_matchP_aux <span class="free">σ</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">I</span> <span class="free">r</span> <span class="main">[]</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_matchP_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_matchF_aux_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_matchF_aux <span class="free">σ</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">I</span> <span class="free">r</span> <span class="main">[]</span> <span class="main">0</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_matchF_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> fv_regex_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex <span class="free">m</span> <span class="free">g</span> <span class="free">r</span> <span class="main">⟹</span> Formula.fv_regex <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> atms <span class="free">r</span><span class="main">.</span> Formula.fv <span class="bound">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fv_regex_alt atms_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> safe_regex_safe_formula<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> to_mregex_atms <span class="main">=</span>
  to_mregex_ok<span class="main">[</span><span class="operator">THEN</span> conjunct1<span class="main">,</span> <span class="operator">THEN</span> equalityD1<span class="main">,</span> <span class="operator">THEN</span> set_mp<span class="main">,</span> <span class="operator">rotated</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> maux<span class="main">)</span> wf_minit0<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>Formula.fv <span class="free">φ</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span>
  pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="free">P</span> <span class="main">⟹</span>
  wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="free">P</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="main">(</span>minit0 <span class="free">n</span> <span class="free">φ</span><span class="main">)</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> safe_formula_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eq_Const <span class="skolem">c</span> <span class="skolem">d</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> wf_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"is_simple_eq <span class="main">(</span>trm.Const <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span>trm.Const <span class="skolem">d</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv_trm <span class="main">(</span>trm.Const <span class="skolem">c</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv_trm <span class="main">(</span>trm.Const <span class="skolem">d</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_simple_eq_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> eq_rel.simps<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_mformula.Eq<span class="main">[</span><span class="operator">OF</span> wf_props<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eq_Var1 <span class="skolem">c</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> wf_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"is_simple_eq <span class="main">(</span>trm.Const <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span>trm.Var <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv_trm <span class="main">(</span>trm.Const <span class="skolem">c</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv_trm <span class="main">(</span>trm.Var <span class="skolem">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_simple_eq_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> eq_rel.simps<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_mformula.Eq<span class="main">[</span><span class="operator">OF</span> wf_props<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eq_Var2 <span class="skolem">c</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> wf_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"is_simple_eq <span class="main">(</span>trm.Var <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>trm.Const <span class="skolem">c</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv_trm <span class="main">(</span>trm.Var <span class="skolem">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv_trm <span class="main">(</span>trm.Const <span class="skolem">c</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_simple_eq_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> eq_rel.simps<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_mformula.Eq<span class="main">[</span><span class="operator">OF</span> wf_props<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>neq_Var <span class="skolem">x</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.neq_Var<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pred <span class="skolem">e</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Pred<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let <span class="skolem">p</span> <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> fvi_less_nfv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pred_mapping_alt dom_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Let Let<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_assign <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="skolem">ψ</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> 1 <span class="quoted"><span class="quoted">‹safe_assignment <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">ψ</span>›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> fv <span class="skolem">φ</span>"</span></span> <span class="quoted"><span class="quoted">"fv_trm <span class="skolem">t</span> <span class="main">⊆</span> fv <span class="skolem">φ</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">=</span> Formula.Eq <span class="main">(</span>Formula.Var <span class="skolem">x</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> Formula.Eq <span class="skolem">t</span> <span class="main">(</span>Formula.Var <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> safe_assignment_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits trm.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> And_assign <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.AndAssign <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> trm.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_safe <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.And wf_mbuf2'_0<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_constraint <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹fv <span class="skolem">ψ</span> <span class="main">⊆</span> fv <span class="skolem">φ</span>›</span></span> <span class="quoted"><span class="quoted">‹is_constraint <span class="skolem">ψ</span>›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t1</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="skolem"><span class="skolem">t2</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t1</span><span class="main">,</span> <span class="skolem">p</span><span class="main">,</span> <span class="skolem">c</span><span class="main">,</span> <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> split_constraint <span class="skolem">ψ</span>"</span></span>
    <span class="quoted"><span class="quoted">"formula_of_constraint <span class="main">(</span>split_constraint <span class="skolem">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ψ</span>"</span></span>
    <span class="quoted"><span class="quoted">"fv_trm <span class="skolem">t1</span> <span class="main">∪</span> fv_trm <span class="skolem">t2</span> <span class="main">⊆</span> fv <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> is_constraint.induct<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> And_constraint <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.AndRel<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_Not <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.And wf_mbuf2'_0<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_Trigger <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> wf_φ<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>minit0 <span class="skolem">n</span> <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_Trigger<span class="main">(</span>5<span class="main">,</span>8<span class="main">,</span>9<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> formula.Trigger <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> formula.And <span class="skolem">φ</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">args</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">args</span> <span class="main">=</span> <span class="main">(</span>init_args <span class="skolem">I</span> <span class="skolem">n</span> <span class="main">(</span>Formula.fv <span class="skolem">φ'</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="skolem">ψ'</span><span class="main">)</span> True<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">aux</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aux</span> <span class="main">=</span> <span class="main">(</span><span class="free">init_mtaux</span> <span class="skolem">args</span><span class="main">)</span>"</span></span>

 <span class="keyword1"><span class="command">have</span></span> t_not_safe_assign<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>safe_assignment <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> safe_assignment_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> t_not_constraint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_constraint <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> wf_φ'<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>minit0 <span class="skolem">n</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="skolem">φ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_Trigger<span class="main">(</span>6<span class="main">,</span>8<span class="main">,</span>9<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> wf_ψ'<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>minit0 <span class="skolem">n</span> <span class="skolem">ψ'</span><span class="main">)</span> <span class="skolem">ψ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_Trigger<span class="main">(</span>7<span class="main">,</span>8<span class="main">,</span>9<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> if_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> args_pos <span class="skolem">args</span> <span class="keyword1">then</span> <span class="skolem">φ'</span> <span class="main">=</span> <span class="skolem">φ'</span> <span class="keyword1">else</span> <span class="skolem">φ'</span> <span class="main">=</span> formula.Neg <span class="skolem">φ'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> args_def init_args_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> args<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">φ'</span> <span class="main">=</span> args_pos <span class="skolem">args</span>"</span></span>
    <span class="quoted"><span class="quoted">"args_ivl <span class="skolem">args</span> <span class="main">=</span> <span class="skolem">I</span>"</span></span>
    <span class="quoted"><span class="quoted">"args_n <span class="skolem">args</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"args_L <span class="skolem">args</span> <span class="main">=</span> fv <span class="skolem">φ'</span>"</span></span>
    <span class="quoted"><span class="quoted">"args_R <span class="skolem">args</span> <span class="main">=</span> fv <span class="skolem">ψ'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="skolem">ψ'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> mem <span class="skolem">I</span> <span class="main">0</span> <span class="keyword1">then</span> fv <span class="skolem">φ'</span> <span class="main">⊆</span> fv <span class="skolem">ψ'</span> <span class="keyword1">else</span> fv <span class="skolem">φ'</span> <span class="main">=</span> fv <span class="skolem">ψ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_Trigger<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>8<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> args_def init_args_def safe_formula_dual_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> buf_ts<span class="main">:</span>
    <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="main">0</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ'</span> <span class="skolem">ψ'</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"wf_ts <span class="free">σ</span> <span class="skolem">P</span> <span class="main">0</span> <span class="skolem">φ'</span> <span class="skolem">ψ'</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2'_def wf_mbuf2_def wf_ts_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> And_Trigger<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_trigger_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">R</span> <span class="skolem">args</span> <span class="skolem">φ'</span> <span class="skolem">ψ'</span> <span class="skolem">aux</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Trigger <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_Trigger<span class="main">(</span>3<span class="main">)</span> valid_init_mtaux<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="quoted">"fv <span class="skolem">φ'</span>"</span></span> <span class="quoted"><span class="quoted">"fv <span class="skolem">ψ'</span>"</span></span> <span class="quoted">True</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> safe_formula_dual_def wf_trigger_aux_def aux_def args_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def And_Trigger<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> if_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> args_pos <span class="skolem">args</span> <span class="keyword1">then</span> <span class="skolem">φ'</span> <span class="main">=</span> <span class="skolem">φ'</span> <span class="keyword1">else</span> <span class="skolem">φ'</span> <span class="main">=</span> formula.Neg <span class="skolem">φ'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> args_def init_args_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> wf_buf<span class="main">:</span>
    <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="main">0</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">t</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"wf_mbuft2' <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="main">0</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="main">0</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ'</span> <span class="skolem">ψ'</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"wf_ts <span class="free">σ</span> <span class="skolem">P</span> <span class="main">0</span>  <span class="skolem">φ'</span> <span class="skolem">ψ'</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2'_def wf_mbuft2'_def wf_mbuf2_def wf_mbuf2_def wf_ts_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> And_Trigger<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">t</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> t_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> safe_formula_dual_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> wf_t<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>minit0 <span class="skolem">n</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> And_Trigger<span class="main">(</span>2<span class="main">)</span> wf_mformula.Trigger_0<span class="main">[</span><span class="operator">OF</span> wf_ψ' if_pos wf_φ' args buf_ts aux mem<span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> t_def aux_def args_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> wf_mformula.And<span class="main">[</span><span class="operator">OF</span> wf_φ wf_t _ wf_buf<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> True And_Trigger<span class="main">(</span>2<span class="main">)</span> t_not_safe_assign t_not_constraint
      <span class="keyword1"><span class="command">unfolding</span></span> f_def t_def args_def aux_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> wf_mformula.And_Trigger<span class="main">[</span><span class="operator">OF</span> wf_φ wf_buf<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> t_def<span class="main"><span class="main">]</span></span> And_Trigger<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> wf_ψ' if_pos wf_φ' args wf_buf<span class="main"><span class="main">(</span></span>3-4<span class="main"><span class="main">)</span></span> aux<span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> And_Trigger<span class="main">(</span>2<span class="main">)</span> t_not_safe_assign t_not_constraint
      <span class="keyword1"><span class="command">unfolding</span></span> f_def t_def args_def aux_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_Release <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> fvs <span class="main">=</span> release_fvi<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="skolem">φ</span></span> <span class="quoted"><span class="skolem">φ'</span></span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="skolem">ψ'</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> fv_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="main">(</span>formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fv <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_Release<span class="main">(</span>7<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> release_subformulas<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="skolem">φ'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="skolem">ψ'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_Release<span class="main">(</span>7<span class="main">)</span> And_Release.prems<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> fvi.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> wf_formula<span class="main">:</span>
    <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>minit0 <span class="skolem">n</span> <span class="main">(</span>and_release_safe_bounded <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>and_release_safe_bounded <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>minit0 <span class="skolem">n</span> <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
    <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>minit0 <span class="skolem">n</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="skolem">φ'</span>"</span></span>
    <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>minit0 <span class="skolem">n</span> <span class="skolem">ψ'</span><span class="main">)</span> <span class="skolem">ψ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_Release.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> And_Release.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> fvs<span class="main"><span class="main">]</span></span><span class="main">]</span>
          And_Release.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> And_Release.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> fv_eq<span class="main"><span class="main">]</span></span><span class="main">]</span>
          And_Release.IH<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> release_subformulas<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
          And_Release.IH<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> release_subformulas<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      And_Release.prems<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> safe_assignment <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> safe_assignment_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> safe_formula <span class="main">(</span>formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_Release<span class="main">(</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_constraint <span class="main">(</span>formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"minit0 <span class="skolem">n</span> <span class="main">(</span>and_release_safe_bounded <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span> <span class="main">=</span> minit0 <span class="skolem">n</span> <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="main">(</span>formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> wf_mformula.And_Release<span class="main">[</span><span class="operator">OF</span> And_Release<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> wf_formula<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ands <span class="skolem">l</span> <span class="skolem">pos</span> <span class="skolem">neg</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">mpos</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mpos</span> <span class="main">=</span> map <span class="main">(</span>minit0 <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="skolem">pos</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">mneg</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mneg</span> <span class="main">=</span> map <span class="main">(</span>minit0 <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>map remove_neg <span class="skolem">neg</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> fvs_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">φ</span> <span class="main">∈</span> <span class="main">(</span>set <span class="skolem">pos</span> <span class="main">∪</span> set <span class="skolem">neg</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="bound">φ</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Ands<span class="main">(</span>1<span class="main">,</span>8<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="bound">φ</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">⟶</span> pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">⟶</span> wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>minit0 <span class="skolem">n</span> <span class="bound">φ</span><span class="main">)</span> <span class="bound">φ</span><span class="main">)</span> <span class="skolem">pos</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Ands<span class="main">(</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_all_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>minit0 <span class="skolem">n</span> <span class="bound">φ</span><span class="main">)</span> <span class="bound">φ</span><span class="main">)</span> <span class="skolem">pos</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Ands<span class="main">(</span>9<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_all_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>minit0 <span class="skolem">n</span><span class="main">)</span> <span class="skolem">pos</span><span class="main">)</span> <span class="skolem">pos</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">pos</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">mpos</span> <span class="skolem">pos</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mpos_def list_all2_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span><span class="main">∈</span>set <span class="main">(</span>map remove_neg <span class="skolem">neg</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> φ'_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">=</span> remove_neg <span class="skolem">φ'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ'</span> <span class="main">∈</span> set <span class="skolem">neg</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> safe_formula <span class="skolem">φ'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Ands<span class="main">(</span>1<span class="main">)</span> φ'_props<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> φ'_eq<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">φ'</span> <span class="main">=</span> Formula.Neg <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ballE<span class="main">[</span><span class="operator">OF</span> Ands<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> list_all_iff<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">φ'</span></span> <span class="quoted">False</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="skolem">φ</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">⟶</span> pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">⟶</span> wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>minit0 <span class="skolem">n</span> <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Ands<span class="main">(</span>7<span class="main">)</span> φ'_props<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> list_all_iff
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="skolem">φ</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fvs_l φ'_props fv_remove_neg
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ballE<span class="main">[</span><span class="operator">OF</span> Ands<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> list_all_iff<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">φ'</span></span> <span class="quoted">False</span><span class="main">]</span> φ'_props
      <span class="keyword1"><span class="command">unfolding</span></span> list_all_iff
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>minit0 <span class="skolem">n</span> <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
      <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Ands<span class="main">(</span>1<span class="main">,</span>9<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> list_all_remove_neg<span class="main">:</span>
    <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>minit0 <span class="skolem">n</span> <span class="bound">φ</span><span class="main">)</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span>map remove_neg <span class="skolem">neg</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> safe_formula <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span>map remove_neg <span class="skolem">neg</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_all_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> neg<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">mneg</span> <span class="main">(</span>map remove_neg <span class="skolem">neg</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mneg_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">neg</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> wf_l<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="skolem">mpos</span> <span class="main">@</span> <span class="skolem">mneg</span><span class="main">)</span> <span class="main">(</span><span class="skolem">pos</span> <span class="main">@</span> map remove_neg <span class="skolem">neg</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pos
    <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">pos</span> <span class="main">+</span> length <span class="skolem">neg</span> <span class="main">=</span> length <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Ands<span class="main">(</span>1<span class="main">)</span> sum_length_filter_compl
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> qtable<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbufn <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Ands <span class="skolem">l</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ψ</span><span class="main">.</span> Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="bound">ψ</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="skolem">pos</span> <span class="main">@</span> map remove_neg <span class="skolem">neg</span><span class="main">)</span><span class="main">)</span>
   <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ψ</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="bound">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">ψ</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">pos</span> <span class="main">@</span> map remove_neg <span class="skolem">neg</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="skolem">l</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> len Ands<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> Ands.prems<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span>
        <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_mbufn_def list_all3_map list.rel_map map_replicate_const<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_append
    <span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all3_list_all2_eq list_all2_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> f_arg_min_list_f<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A_pos</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A_pos</span> <span class="main">=</span> map fv <span class="skolem">pos</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A_neg</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A_neg</span> <span class="main">=</span> map fv <span class="skolem">neg</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> fvs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>set <span class="skolem">A_neg</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span> <span class="main">(</span>set <span class="skolem">A_pos</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Ands<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> A_pos_def A_neg_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>MAnds <span class="skolem">A_pos</span> <span class="skolem">A_neg</span> <span class="main">(</span><span class="skolem">mpos</span> <span class="main">@</span> <span class="skolem">mneg</span><span class="main">)</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="skolem">l</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>formula.Ands <span class="skolem">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_mformula.Ands<span class="main">[</span><span class="operator">OF</span> wf_l qtable Ands<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> list_all_remove_neg<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> A_pos_def A_neg_def fvs<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Ands<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> mpos_def mneg_def A_pos_def A_neg_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Neg<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Or <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Or wf_mbuf2'_0<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Exists <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fvi_Suc_bound <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Exists<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> fvi.simps<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="skolem">φ</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">b</span> <span class="main">+</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Agg
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fvi_plus_bound<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>lift_envs' <span class="skolem">b</span> <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span>minit0 <span class="main">(</span><span class="skolem">b</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Agg<span class="main">(</span>7<span class="main">)</span> Agg.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">+</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lift_envs' <span class="skolem">b</span> <span class="skolem">R</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Agg wf_mformula.Agg<span class="main">[</span><span class="operator">unfolded</span> fvi.simps<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">R</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>minit0 <span class="main">(</span><span class="skolem">b</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">φ</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fv <span class="skolem">φ</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">b</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">ω</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prev <span class="skolem">I</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">thm</span></span> wf_mformula.Prev<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">P</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Prev<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Next <span class="skolem">I</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Next<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Since <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_since_aux_Nil
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_args_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Since wf_mbuf2'_0 wf_ts_0<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Not_Since <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_since_aux_Nil
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_args_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Since wf_mbuf2'_0 wf_ts_0<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Until <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_length_muaux<span class="main">[</span><span class="operator">OF</span> valid_init_muaux<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Until<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> wf_until_aux_Nil
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_args_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> progress_simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Until<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> fvi.simps<span class="main"><span class="main">]</span></span> wf_mbuf2'_0 wf_ts_0<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Not_Until <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">args</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">args</span> <span class="main">=</span> init_args <span class="skolem">I</span> <span class="skolem">n</span> <span class="main">(</span>Formula.fv <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="skolem">ψ</span><span class="main">)</span> False"</span></span>

  <span class="keyword1"><span class="command">have</span></span> wf_φ<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>minit0 <span class="skolem">n</span> <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Not_Until<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">R</span></span><span class="main">]</span> Not_Until<span class="main">(</span>7<span class="main">,</span>8<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> wf_ψ<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>minit0 <span class="skolem">n</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Not_Until<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">R</span></span><span class="main">]</span> Not_Until<span class="main">(</span>7<span class="main">,</span>8<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> args<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> args_pos <span class="skolem">args</span> <span class="keyword1">then</span> formula.Neg <span class="skolem">φ</span> <span class="main">=</span> <span class="skolem">φ</span> <span class="keyword1">else</span> formula.Neg <span class="skolem">φ</span> <span class="main">=</span> formula.Neg <span class="skolem">φ</span>"</span></span>
    <span class="quoted"><span class="quoted">"safe_formula <span class="main">(</span>formula.Neg <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> args_pos <span class="skolem">args</span>"</span></span>
    <span class="quoted"><span class="quoted">"args_ivl <span class="skolem">args</span> <span class="main">=</span> <span class="skolem">I</span>"</span></span>
    <span class="quoted"><span class="quoted">"args_n <span class="skolem">args</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"args_L <span class="skolem">args</span> <span class="main">=</span> fv <span class="skolem">φ</span>"</span></span>
    <span class="quoted"><span class="quoted">"args_R <span class="skolem">args</span> <span class="main">=</span> fv <span class="skolem">ψ</span>"</span></span>
    <span class="quoted"><span class="quoted">"fv <span class="skolem">φ</span> <span class="main">⊆</span> fv <span class="skolem">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Not_Until<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> args_def init_args_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> wf_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_until_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">R</span> <span class="skolem">args</span> <span class="skolem">φ</span> <span class="skolem">ψ</span> <span class="main">(</span><span class="free">init_muaux</span> <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Until <span class="main">(</span>formula.Neg <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_until_aux_Nil<span class="main">[</span><span class="operator">OF</span> args<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">]</span> Not_Until<span class="main">(</span>8<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> args_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> progress_simps<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> muax_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">length_muaux</span> <span class="skolem">args</span> <span class="main">(</span><span class="free">init_muaux</span> <span class="skolem">args</span><span class="main">)</span> <span class="main">=</span> length <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_length_muaux<span class="main">[</span><span class="operator">OF</span> valid_init_muaux<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Not_Until<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted">False</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> args_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> prog<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> τ <span class="free">σ</span> <span class="main">(</span>min <span class="main">(</span><span class="main">0</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Until <span class="main">(</span>formula.Neg <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">0</span> <span class="main">+</span> <span class="free">length_muaux</span> <span class="skolem">args</span> <span class="main">(</span><span class="free">init_muaux</span> <span class="skolem">args</span><span class="main">)</span> <span class="main">=</span> min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Inf_UNIV_nat Not_Until<span class="main">(</span>8<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_mformula.Until<span class="main">[</span><span class="operator">unfolded</span> fvi.simps<span class="main">,</span> <span class="operator">OF</span> wf_φ wf_ψ args wf_mbuf2'_0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Not_Until<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> wf_ts_0 prog<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> wf_aux prog<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> Not_Until<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> args_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trigger_0 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> wf_ψ<span class="main">:</span>
    <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>minit0 <span class="skolem">n</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Trigger_0
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">φ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">xa</span><span class="main">∈</span>fv <span class="skolem">φ</span><span class="main">.</span> <span class="bound">xa</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">xa</span> <span class="bound">xaa</span><span class="main">.</span> pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="bound">xaa</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">xaaa</span><span class="main">.</span> wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="bound">xaa</span> <span class="bound">xaaa</span> <span class="bound">x</span> <span class="bound">xa</span> <span class="main">(</span>minit0 <span class="bound">x</span> <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">args</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">args</span> <span class="main">=</span> init_args <span class="skolem">I</span> <span class="skolem">n</span> <span class="main">(</span>Formula.fv <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="skolem">ψ</span><span class="main">)</span> True"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">aux</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aux</span> <span class="main">=</span> <span class="free">init_mtaux</span> <span class="skolem">args</span>"</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> wf_φ<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>minit0 <span class="skolem">n</span> <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Trigger_0
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> if_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> args_pos <span class="skolem">args</span> <span class="keyword1">then</span> <span class="skolem">φ</span> <span class="main">=</span> <span class="skolem">φ</span> <span class="keyword1">else</span> <span class="skolem">φ</span> <span class="main">=</span> formula.Neg <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> args_def init_args_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> args<span class="main">:</span>
      <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">φ</span> <span class="main">=</span> args_pos <span class="skolem">args</span>"</span></span>
      <span class="quoted"><span class="quoted">"args_ivl <span class="skolem">args</span> <span class="main">=</span> <span class="skolem">I</span>"</span></span>
      <span class="quoted"><span class="quoted">"args_n <span class="skolem">args</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
      <span class="quoted"><span class="quoted">"args_L <span class="skolem">args</span> <span class="main">=</span> fv <span class="skolem">φ</span>"</span></span>
      <span class="quoted"><span class="quoted">"args_R <span class="skolem">args</span> <span class="main">=</span> fv <span class="skolem">ψ</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="skolem">ψ</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> mem <span class="skolem">I</span> <span class="main">0</span> <span class="keyword1">then</span> fv <span class="skolem">φ</span> <span class="main">⊆</span> fv <span class="skolem">ψ</span> <span class="keyword1">else</span> fv <span class="skolem">φ</span> <span class="main">=</span> fv <span class="skolem">ψ</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Trigger_0<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>6<span class="main">)</span> True
      <span class="keyword1"><span class="command">unfolding</span></span> args_def init_args_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_trigger_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">R</span> <span class="skolem">args</span> <span class="skolem">φ</span> <span class="skolem">ψ</span> <span class="skolem">aux</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Trigger <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Trigger_0<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> valid_init_mtaux<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="quoted">"fv <span class="skolem">φ</span>"</span></span> <span class="quoted"><span class="quoted">"fv <span class="skolem">ψ</span>"</span></span> <span class="quoted">True</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> safe_formula_dual_def wf_trigger_aux_def aux_def args_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def Trigger_0<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> True wf_mformula.Trigger_0<span class="main">[</span><span class="operator">OF</span> wf_ψ if_pos wf_φ args wf_mbuf2'_0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Trigger_0<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> wf_ts_0 aux mem<span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> aux_def args_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">args</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">args</span> <span class="main">=</span> init_args <span class="skolem">I</span> <span class="skolem">n</span> <span class="main">(</span>Formula.fv <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="skolem">ψ</span><span class="main">)</span> True"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">aux</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aux</span> <span class="main">=</span> <span class="free">init_mtaux</span> <span class="skolem">args</span>"</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> φ'_props<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">=</span> Formula.Neg <span class="skolem">φ'</span>"</span></span>
      <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">φ'</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">xa</span><span class="main">∈</span>fv <span class="skolem">φ'</span><span class="main">.</span> <span class="bound">xa</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">xa</span> <span class="bound">xaa</span><span class="main">.</span> pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="bound">xaa</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">xaaa</span><span class="main">.</span> wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="bound">xaa</span> <span class="bound">xaaa</span> <span class="bound">x</span> <span class="bound">xa</span> <span class="main">(</span>minit0 <span class="bound">x</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Trigger_0<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">φ</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv <span class="skolem">φ'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> φ'_props<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> safe_formula_Neg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">φ'</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>minit0 <span class="skolem">n</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="skolem">φ'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Trigger_0<span class="main">(</span>6<span class="main">,</span>7<span class="main">)</span> φ'_props<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> wf_φ<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>minit0 <span class="skolem">n</span> <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> φ'_props<span class="main">(</span>1<span class="main">)</span> wf_mformula.Neg
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> if_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> args_pos <span class="skolem">args</span> <span class="keyword1">then</span> <span class="skolem">φ</span> <span class="main">=</span> <span class="skolem">φ</span> <span class="keyword1">else</span> <span class="skolem">φ</span> <span class="main">=</span> formula.Neg <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> args_def init_args_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> args<span class="main">:</span>
        <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">φ</span> <span class="main">=</span> args_pos <span class="skolem">args</span>"</span></span>
        <span class="quoted"><span class="quoted">"args_ivl <span class="skolem">args</span> <span class="main">=</span> <span class="skolem">I</span>"</span></span>
        <span class="quoted"><span class="quoted">"args_n <span class="skolem">args</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
        <span class="quoted"><span class="quoted">"args_L <span class="skolem">args</span> <span class="main">=</span> fv <span class="skolem">φ</span>"</span></span>
        <span class="quoted"><span class="quoted">"args_R <span class="skolem">args</span> <span class="main">=</span> fv <span class="skolem">ψ</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="skolem">ψ</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> mem <span class="skolem">I</span> <span class="main">0</span> <span class="keyword1">then</span> fv <span class="skolem">φ</span> <span class="main">⊆</span> fv <span class="skolem">ψ</span> <span class="keyword1">else</span> fv <span class="skolem">φ</span> <span class="main">=</span> fv <span class="skolem">ψ</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Trigger_0<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>6<span class="main">)</span> True
        <span class="keyword1"><span class="command">unfolding</span></span> args_def init_args_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_trigger_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">R</span> <span class="skolem">args</span> <span class="skolem">φ</span> <span class="skolem">ψ</span> <span class="skolem">aux</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Trigger <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Trigger_0<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> valid_init_mtaux<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="quoted">"fv <span class="skolem">φ</span>"</span></span> <span class="quoted"><span class="quoted">"fv <span class="skolem">ψ</span>"</span></span> <span class="quoted">True</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> safe_formula_dual_def wf_trigger_aux_def aux_def args_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def Trigger_0<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> True wf_mformula.Trigger_0<span class="main">[</span><span class="operator">OF</span> wf_ψ if_pos wf_φ args wf_mbuf2'_0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Trigger_0<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> wf_ts_0 aux mem<span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> aux_def args_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">args</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">args</span> <span class="main">=</span> init_args <span class="skolem">I</span> <span class="skolem">n</span> <span class="main">(</span>Formula.fv <span class="skolem">φ'</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="skolem">ψ</span><span class="main">)</span> False"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">aux</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aux</span> <span class="main">=</span> <span class="free">init_mtaux</span> <span class="skolem">args</span>"</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> wf_φ'<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>minit0 <span class="skolem">n</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="skolem">φ'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> φ'_props Trigger_0
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> if_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> args_pos <span class="skolem">args</span> <span class="keyword1">then</span> <span class="skolem">φ</span> <span class="main">=</span> <span class="skolem">φ'</span> <span class="keyword1">else</span> <span class="skolem">φ</span> <span class="main">=</span> formula.Neg <span class="skolem">φ'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> φ'_props<span class="main">(</span>1<span class="main">)</span> args_def init_args_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> args<span class="main">:</span>
        <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">φ</span> <span class="main">=</span> args_pos <span class="skolem">args</span>"</span></span>
        <span class="quoted"><span class="quoted">"args_ivl <span class="skolem">args</span> <span class="main">=</span> <span class="skolem">I</span>"</span></span>
        <span class="quoted"><span class="quoted">"args_n <span class="skolem">args</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
        <span class="quoted"><span class="quoted">"args_L <span class="skolem">args</span> <span class="main">=</span> fv <span class="skolem">φ'</span>"</span></span>
        <span class="quoted"><span class="quoted">"args_R <span class="skolem">args</span> <span class="main">=</span> fv <span class="skolem">ψ</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="skolem">ψ</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> mem <span class="skolem">I</span> <span class="main">0</span> <span class="keyword1">then</span> fv <span class="skolem">φ'</span> <span class="main">⊆</span> fv <span class="skolem">ψ</span> <span class="keyword1">else</span> fv <span class="skolem">φ'</span> <span class="main">=</span> fv <span class="skolem">ψ</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> φ'_props<span class="main">(</span>1<span class="main">)</span> Trigger_0<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>6<span class="main">)</span> False
        <span class="keyword1"><span class="command">unfolding</span></span> args_def init_args_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_trigger_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">R</span> <span class="skolem">args</span> <span class="skolem">φ'</span> <span class="skolem">ψ</span> <span class="skolem">aux</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Trigger <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Trigger_0<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> valid_init_mtaux<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="quoted">"fv <span class="skolem">φ'</span>"</span></span> <span class="quoted"><span class="quoted">"fv <span class="skolem">ψ</span>"</span></span> <span class="quoted">False</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> φ'_props<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> safe_formula_dual_def wf_trigger_aux_def aux_def args_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def Trigger_0<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> False φ'_props<span class="main">(</span>1<span class="main">)</span> wf_mformula.Trigger_0<span class="main">[</span><span class="operator">OF</span> wf_ψ if_pos wf_φ' args wf_mbuf2'_0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Trigger_0<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> wf_ts_0 aux mem<span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> aux_def args_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trigger <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Release_0 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>minit0 <span class="skolem">n</span> <span class="main">(</span>release_safe_0 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>release_safe_0 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Release_0.IH<span class="main">[</span><span class="operator">OF</span> Release_0.prems<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> release_fvi<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> minit0_release_0<span class="main">[</span><span class="operator">OF</span> Release_0<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> wf_mformula.Release_0<span class="main">[</span><span class="operator">OF</span> Release_0<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Release <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MatchP <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mr</span></span> <span class="skolem"><span class="skolem">φs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> r_props<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">mr</span><span class="main">,</span> <span class="skolem">φs'</span><span class="main">)</span> <span class="main">=</span> to_mregex <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">φs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φs</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span>minit0 <span class="skolem">n</span><span class="main">)</span> <span class="skolem">φs'</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> wf_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> to_mregex <span class="skolem">r</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">mr'</span><span class="main">,</span> <span class="bound">φs'</span><span class="main">)</span> <span class="main">⇒</span> list_all2 <span class="main">(</span>wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">φs</span> <span class="bound">φs'</span> <span class="main">∧</span> <span class="skolem">mr</span> <span class="main">=</span> <span class="bound">mr'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>sorted_list_of_set <span class="main">(</span>RPDs <span class="skolem">mr</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span>RPDs <span class="skolem">mr</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"safe_regex Past Strict <span class="skolem">r</span>"</span></span>
    <span class="quoted"><span class="quoted">"wf_mbufn' <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="main">0</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">r</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="skolem">φs'</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"wf_ts_regex <span class="free">σ</span> <span class="skolem">P</span> <span class="main">0</span> <span class="skolem">r</span> <span class="main">[]</span>"</span></span>
    <span class="quoted"><span class="quoted">"wf_matchP_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">I</span> <span class="skolem">r</span> <span class="main">[]</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.MatchP <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> MatchP r_props
    <span class="keyword1"><span class="command">unfolding</span></span> φs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list.rel_map fv_regex_alt <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> progress_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.rel_refl_strong wf_mbufn'_0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> r_props<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> wf_ts_regex_0 wf_matchP_aux_Nil
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> to_mregex_atms<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_mformula.MatchP<span class="main">[</span><span class="operator">OF</span> wf_props<span class="main">]</span> r_props
    <span class="keyword1"><span class="command">unfolding</span></span> φs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"to_mregex <span class="skolem">r</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MatchF <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mr</span></span> <span class="skolem"><span class="skolem">φs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> r_props<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">mr</span><span class="main">,</span> <span class="skolem">φs'</span><span class="main">)</span> <span class="main">=</span> to_mregex <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">φs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φs</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span>minit0 <span class="skolem">n</span><span class="main">)</span> <span class="skolem">φs'</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> wf_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> to_mregex <span class="skolem">r</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">mr'</span><span class="main">,</span> <span class="bound">φs'</span><span class="main">)</span> <span class="main">⇒</span> list_all2 <span class="main">(</span>wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">φs</span> <span class="bound">φs'</span> <span class="main">∧</span> <span class="skolem">mr</span> <span class="main">=</span> <span class="bound">mr'</span>"</span></span>
    <span class="quoted"><span class="quoted">"sorted_list_of_set <span class="main">(</span>LPDs <span class="skolem">mr</span><span class="main">)</span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span>LPDs <span class="skolem">mr</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"safe_regex Futu Strict <span class="skolem">r</span>"</span></span>
    <span class="quoted"><span class="quoted">"wf_mbufn' <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="main">0</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">r</span> <span class="main">(</span>replicate <span class="main">(</span>length <span class="skolem">φs'</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"wf_ts_regex <span class="free">σ</span> <span class="skolem">P</span> <span class="main">0</span> <span class="skolem">r</span> <span class="main">[]</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> τ <span class="free">σ</span> <span class="main">(</span>min <span class="main">(</span><span class="main">0</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>progress_regex <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">r</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"wf_matchF_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">I</span> <span class="skolem">r</span> <span class="main">[]</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.MatchF <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.MatchF <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">0</span> <span class="main">+</span> length <span class="main">[]</span> <span class="main">=</span> progress_regex <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">r</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> MatchF r_props
    <span class="keyword1"><span class="command">unfolding</span></span> φs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list.rel_map fv_regex_alt progress_le Min_eq_iff progress_regex_def
        <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> progress_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.rel_refl_strong wf_mbufn'_0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> r_props<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> wf_ts_regex_0 wf_matchF_aux_Nil
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> to_mregex_atms<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_mformula.MatchF<span class="main">[</span><span class="operator">OF</span> wf_props<span class="main">]</span> r_props
    <span class="keyword1"><span class="command">unfolding</span></span> φs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"to_mregex <span class="skolem">r</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> maux<span class="main">)</span> wf_mstate_minit<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span> <span class="main">⟹</span> wf_mstate <span class="free">φ</span> pnil <span class="free">R</span> <span class="main">(</span>minit <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_mstate_def minit_def Let_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_minit0 fvi_less_nfv<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Evaluation›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> match_wf_tuple<span class="main">:</span> <span class="quoted"><span class="quoted">"Some <span class="free">f</span> <span class="main">=</span> match <span class="free">ts</span> <span class="free">xs</span> <span class="main">⟹</span>
  wf_tuple <span class="free">n</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span><span class="main">∈</span>set <span class="free">ts</span><span class="main">.</span> Formula.fv_trm <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>Table.tabulate <span class="free">f</span> <span class="main">0</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> match_fvi_trm_None<span class="main">:</span> <span class="quoted"><span class="quoted">"Some <span class="free">f</span> <span class="main">=</span> match <span class="free">ts</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set <span class="free">ts</span><span class="main">.</span> <span class="free">x</span> <span class="main">∉</span> Formula.fv_trm <span class="bound">t</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> match_fvi_trm_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"Some <span class="free">f</span> <span class="main">=</span> match <span class="free">ts</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">∈</span> set <span class="free">ts</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> Formula.fv_trm <span class="free">t</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> match_eval_trm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set <span class="free">ts</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>Formula.fv_trm <span class="bound">t</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> Some <span class="free">f</span> <span class="main">=</span> match <span class="free">ts</span> <span class="free">xs</span> <span class="main">⟹</span>
    map <span class="main">(</span>Formula.eval_trm <span class="main">(</span>Table.tabulate <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> the <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="free">ts</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">ts</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 3<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> match_fvi_trm_Some sym <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eval_trm_fv_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_tuple_tabulate_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="main">(</span>Table.tabulate <span class="free">f</span> <span class="main">0</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> Some <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ex_match<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span><span class="main">∈</span>set <span class="free">ts</span><span class="main">.</span> Formula.fv_trm <span class="bound">t</span><span class="main">)</span> <span class="free">v</span> <span class="main">⟹</span>
  <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set <span class="free">ts</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>Formula.fv_trm <span class="bound">t</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>Formula.is_Var <span class="bound">t</span> <span class="main">∨</span> Formula.is_Const <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">f</span><span class="main">.</span> match <span class="free">ts</span> <span class="main">(</span>map <span class="main">(</span>Formula.eval_trm <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">f</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">=</span> Table.tabulate <span class="bound">f</span> <span class="main">0</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>Formula.eval_trm <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">ts</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">ts</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span><span class="main">∈</span>set <span class="skolem">ts</span><span class="main">.</span> Formula.fv_trm <span class="bound">t</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insert_absorb <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_tuple_tabulate_Some meta_spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> 3<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
      *<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>Formula.eval_trm <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ts</span> <span class="main">=</span> map <span class="main">(</span>Formula.eval_trm <span class="main">(</span>map the <span class="main">(</span><span class="skolem">v</span><span class="main">[</span><span class="skolem">x</span> <span class="main">:=</span> None<span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ts</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_def nth_list_update <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eval_trm_fv_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> False 3<span class="main">(</span>2-4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"match <span class="skolem">ts</span> <span class="main">(</span>map <span class="main">(</span>Formula.eval_trm <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">[</span><span class="skolem">x</span> <span class="main">:=</span> None<span class="main">]</span> <span class="main">=</span> Table.tabulate <span class="skolem">f</span> <span class="main">0</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> *
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> 3<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">[</span><span class="skolem">x</span> <span class="main">:=</span> None<span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_def nth_list_update <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eval_trm_fv_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> False this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> None"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">v</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> match_fvi_trm_None<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sym<span class="main"><span class="main">]</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">length</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq wf_tuple_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_rel_eval_trm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> eq_rel <span class="free">n</span> <span class="free">t1</span> <span class="free">t2</span> <span class="main">⟹</span> is_simple_eq <span class="free">t1</span> <span class="free">t2</span> <span class="main">⟹</span>
  <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>Formula.fv_trm <span class="free">t1</span> <span class="main">∪</span> Formula.fv_trm <span class="free">t2</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span>
  Formula.eval_trm <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span> <span class="free">t1</span> <span class="main">=</span> Formula.eval_trm <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">t2</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_simple_eq_def singleton_table_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_eq_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="main">(</span>Formula.fv_trm <span class="free">t1</span> <span class="main">∪</span> Formula.fv_trm <span class="free">t2</span><span class="main">)</span> <span class="free">v</span> <span class="main">⟹</span>
  is_simple_eq <span class="free">t1</span> <span class="free">t2</span> <span class="main">⟹</span>
  Formula.eval_trm <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span> <span class="free">t1</span> <span class="main">=</span> Formula.eval_trm <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span> <span class="free">t2</span> <span class="main">⟹</span>
  <span class="free">v</span> <span class="main">∈</span> eq_rel <span class="free">n</span> <span class="free">t1</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">t2</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_simple_eq_def singleton_table_def wf_tuple_def unit_table_def
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nth_equalityI <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> table_eq_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"is_simple_eq <span class="free">t1</span> <span class="free">t2</span> <span class="main">⟹</span>
  table <span class="free">n</span> <span class="main">(</span>Formula.fv_trm <span class="free">t1</span> <span class="main">∪</span> Formula.fv_trm <span class="free">t2</span><span class="main">)</span> <span class="main">(</span>eq_rel <span class="free">n</span> <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">t2</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_simple_eq_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_tuple_Suc_fviD<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>Formula.fvi <span class="free">b</span> <span class="free">φ</span><span class="main">)</span> <span class="free">v</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="main">(</span>Formula.fvi <span class="main">(</span>Suc <span class="free">b</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>tl <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fvi_Suc nth_tl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> table_fvi_tl<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>Formula.fvi <span class="free">b</span> <span class="free">φ</span><span class="main">)</span> <span class="free">X</span> <span class="main">⟹</span> table <span class="free">n</span> <span class="main">(</span>Formula.fvi <span class="main">(</span>Suc <span class="free">b</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">`</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> table_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_tuple_Suc_fviD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_tuple_Suc_fvi_SomeI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> Formula.fvi <span class="free">b</span> <span class="free">φ</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="main">(</span>Formula.fvi <span class="main">(</span>Suc <span class="free">b</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span> <span class="free">v</span> <span class="main">⟹</span>
  wf_tuple <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>Formula.fvi <span class="free">b</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">x</span> <span class="main">#</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fvi_Suc less_Suc_eq_0_disj<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_tuple_Suc_fvi_NoneI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> Formula.fvi <span class="free">b</span> <span class="free">φ</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="main">(</span>Formula.fvi <span class="main">(</span>Suc <span class="free">b</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span> <span class="free">v</span> <span class="main">⟹</span>
  wf_tuple <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>Formula.fvi <span class="free">b</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>None <span class="main">#</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fvi_Suc less_Suc_eq_0_disj<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> qtable_project_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="main">(</span>lift_envs <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="free">X</span> <span class="main">⟹</span>
    qtable <span class="free">n</span> <span class="main">(</span>Formula.fvi <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">∈</span> fv <span class="free">φ</span> <span class="keyword1">then</span> Some <span class="bound">x</span> <span class="keyword1">else</span> None<span class="main">)</span> <span class="main">#</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">`</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> neq0_conv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff Bex_def fvi_Suc <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_cong <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_project<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mem_restr_lift_envs'_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="free">b</span> <span class="main">⟹</span> mem_restr <span class="main">(</span>lift_envs' <span class="free">b</span> <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> mem_restr <span class="free">R</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mem_restr_def lift_envs'_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_append list.rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"map the <span class="free">xs</span>"</span></span><span class="main"><span class="main">]</span></span> list.rel_refl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_list_update_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> <span class="free">x</span><span class="main">]</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="keyword1">else</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_tuple_upd_None<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">=</span> <span class="free">B</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">B</span> <span class="main">(</span><span class="free">xs</span><span class="main">[</span><span class="free">i</span><span class="main">:=</span>None<span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_list_update_alt<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mem_restr_upd_None<span class="main">:</span> <span class="quoted"><span class="quoted">"mem_restr <span class="free">R</span> <span class="free">xs</span> <span class="main">⟹</span> mem_restr <span class="free">R</span> <span class="main">(</span><span class="free">xs</span><span class="main">[</span><span class="free">i</span><span class="main">:=</span>None<span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mem_restr_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_conv_all_nth nth_list_update_alt<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mem_restr_dropI<span class="main">:</span> <span class="quoted"><span class="quoted">"mem_restr <span class="main">(</span>lift_envs' <span class="free">b</span> <span class="free">R</span><span class="main">)</span> <span class="free">xs</span> <span class="main">⟹</span> mem_restr <span class="free">R</span> <span class="main">(</span>drop <span class="free">b</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mem_restr_def lift_envs'_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> append_eq_conv_conj list_all2_append2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mem_restr_dropD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mem_restr <span class="free">R</span> <span class="main">(</span>drop <span class="free">b</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mem_restr <span class="main">(</span>lift_envs' <span class="free">b</span> <span class="free">R</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">≠</span> None <span class="main">⟶</span> <span class="bound">a</span> <span class="main">=</span> Some <span class="bound">b</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="var">?R</span> <span class="main">(</span>drop <span class="free">b</span> <span class="free">xs</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mem_restr_def <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mem_restr_def <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="var">?R</span> <span class="main">(</span>take <span class="free">b</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>map the <span class="main">(</span>take <span class="free">b</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list.rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.rel_refl<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹list_all2 <span class="var">?R</span> <span class="main">(</span>drop <span class="free">b</span> <span class="free">xs</span><span class="main">)</span> <span class="skolem">v</span>›</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="var">?R</span> <span class="main">(</span>take <span class="free">b</span> <span class="free">xs</span> <span class="main">@</span> drop <span class="free">b</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>map the <span class="main">(</span>take <span class="free">b</span> <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> list_all2_appendI<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="var">?R</span> <span class="free">xs</span> <span class="main">(</span>map the <span class="main">(</span>take <span class="free">b</span> <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"map the <span class="main">(</span>take <span class="free">b</span> <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">v</span> <span class="main">∈</span> lift_envs' <span class="free">b</span> <span class="free">R</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lift_envs'_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">∈</span> <span class="free">R</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_tuple_append<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">a</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">a</span><span class="main">}</span> <span class="free">xs</span> <span class="main">⟹</span>
  wf_tuple <span class="free">b</span> <span class="main">{</span><span class="bound">x</span> <span class="main">-</span> <span class="free">a</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">a</span><span class="main">}</span> <span class="free">ys</span> <span class="main">⟹</span>
  wf_tuple <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="free">A</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append eq_diff_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_tuple_map_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="main">(</span>map Some <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_tuple_drop<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="free">A</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="main">{</span><span class="bound">x</span> <span class="main">-</span> <span class="free">b</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≥</span> <span class="free">b</span><span class="main">}</span> <span class="main">=</span> <span class="free">B</span> <span class="main">⟹</span>
  wf_tuple <span class="free">n</span> <span class="free">B</span> <span class="main">(</span>drop <span class="free">b</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> ecard_image<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span> <span class="main">⟹</span> ecard <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> ecard <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ecard_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> card_image <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> finite_imageD<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> meval_trm_eval_trm<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="free">x</span> <span class="main">⟹</span> fv_trm <span class="free">t</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span>
    meval_trm <span class="free">t</span> <span class="free">x</span> <span class="main">=</span> Formula.eval_trm <span class="main">(</span>map the <span class="free">x</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> list_update_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">xs</span><span class="main">[</span><span class="free">i</span><span class="main">:=</span><span class="free">z</span><span class="main">]</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> qtable_wf_tupleD<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">X</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> qtable_def table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> qtable_eval_agg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inner<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="main">(</span>lift_envs' <span class="free">b</span> <span class="free">R</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="free">rel</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>Formula.fv <span class="main">(</span>Formula.Agg <span class="free">y</span> <span class="free">ω</span> <span class="free">b</span> <span class="free">f</span> <span class="free">φ</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fresh<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">+</span> <span class="free">b</span> <span class="main">∉</span> Formula.fv <span class="free">φ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> b_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> Formula.fv <span class="free">φ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> f_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.fv_trm <span class="free">f</span> <span class="main">⊆</span> Formula.fv <span class="free">φ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> g0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g0</span> <span class="main">=</span> <span class="main">(</span>Formula.fv <span class="free">φ</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>Formula.fv <span class="main">(</span>Formula.Agg <span class="free">y</span> <span class="free">ω</span> <span class="free">b</span> <span class="free">f</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">i</span> <span class="main">(</span>Formula.Agg <span class="free">y</span> <span class="free">ω</span> <span class="free">b</span> <span class="free">f</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>eval_agg <span class="free">n</span> <span class="free">g0</span> <span class="free">y</span> <span class="free">ω</span> <span class="free">b</span> <span class="free">f</span> <span class="free">rel</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"qtable <span class="main">_</span> <span class="var">?fv</span> <span class="main">_</span> <span class="var">?Q</span> <span class="var">?rel'</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> ecard <span class="bound">Zs</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">Zs</span><span class="main">.</span>
      <span class="bound">Zs</span> <span class="main">=</span> <span class="main">{</span><span class="bound">zs</span><span class="main">.</span> length <span class="bound">zs</span> <span class="main">=</span> <span class="free">b</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span><span class="bound">zs</span> <span class="main">@</span> <span class="bound">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">∧</span> Formula.eval_trm <span class="main">(</span><span class="bound">zs</span> <span class="main">@</span> <span class="bound">v</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="bound">x</span><span class="main">}</span> <span class="main">∧</span>
      <span class="bound">Zs</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> f_fvi<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.fvi_trm <span class="free">b</span> <span class="free">f</span> <span class="main">⊆</span> Formula.fvi <span class="free">b</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f_fv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fvi_trm_iff_fv_trm<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">b</span></span><span class="main"><span class="main">]</span></span> fvi_iff_fv<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">b</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">g0</span> <span class="main">∧</span> <span class="free">rel</span> <span class="main">=</span> empty_table"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.fvi <span class="free">b</span> <span class="free">φ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g0 fvi_iff_fv<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">b</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.fvi_trm <span class="free">b</span> <span class="free">f</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f_fvi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> qtableI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="var">?fv</span> <span class="var">?rel'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_agg_def True<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="var">?fv</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"mem_restr <span class="free">R</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> map the <span class="skolem">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">zs</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">zs</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?zs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map2 <span class="main">(</span><span class="main">λ</span><span class="bound">z</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">∈</span> Formula.fv <span class="free">φ</span> <span class="keyword1">then</span> Some <span class="bound">z</span> <span class="keyword1">else</span> None<span class="main">)</span> <span class="skolem">zs</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">b</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> fv <span class="free">φ</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">b</span><span class="main">}</span> <span class="var">?zs</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_tuple_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="var">?zs</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>None<span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="var">?fv</span> <span class="skolem">v</span>›</span></span> True
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g0 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_tuple_append wf_tuple_upd_None<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="main">(</span><span class="var">?zs</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>None<span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True <span class="quoted"><span class="quoted">‹mem_restr <span class="free">R</span> <span class="skolem">v</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_append <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_qtableI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inner<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span>
              <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mem_restr_upd_None<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="main">(</span><span class="var">?zs</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>None<span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">⟷</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> map the <span class="skolem">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> g0 nth_append <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sat_fv_cong<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> M_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> M_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="free">i</span> <span class="main">(</span>Formula.Agg <span class="free">y</span> <span class="free">ω</span> <span class="free">b</span> <span class="free">f</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> eval_agg <span class="free">n</span> <span class="free">g0</span> <span class="free">y</span> <span class="free">ω</span> <span class="free">b</span> <span class="free">f</span> <span class="free">rel</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> M_empty True that n
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def eval_agg_def g0 singleton_table_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> singleton_table <span class="free">n</span> <span class="free">y</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">v</span> <span class="main">!</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">v</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="var">?fv</span> <span class="skolem">v</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def singleton_table_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tabulate_alt map_nth
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> map_cong<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="quoted">"<span class="main">(!)</span> <span class="skolem">v</span>"</span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">simplified</span> nth_map<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> refl<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> eval_agg <span class="free">n</span> <span class="free">g0</span> <span class="free">y</span> <span class="free">ω</span> <span class="free">b</span> <span class="free">f</span> <span class="free">rel</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="free">i</span> <span class="main">(</span>Formula.Agg <span class="free">y</span> <span class="free">ω</span> <span class="free">b</span> <span class="free">f</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> M_empty True that n
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def eval_agg_def g0<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> non_default_case<span class="main">:</span> False
    <span class="keyword1"><span class="command">have</span></span> union_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="main">`</span> Formula.fvi <span class="free">b</span> <span class="free">φ</span> <span class="main">=</span> fv <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> b_fv
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fvi_iff_fv<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">b</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">-</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">x</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> b_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="free">φ</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">+</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> fv <span class="free">φ</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">+</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="free">b</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> fv <span class="free">φ</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">-</span> <span class="free">b</span> <span class="main">∈</span> <span class="var">?fv</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fvi_iff_fv<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">b</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> n f_fvi <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Un_absorb2<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">M'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">group</span> <span class="main">=</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> drop <span class="free">b</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">k</span><span class="main">)</span> <span class="free">rel</span><span class="main">;</span>
        <span class="bound">images</span> <span class="main">=</span> meval_trm <span class="free">f</span> <span class="main">`</span> <span class="bound">group</span>
      <span class="keyword1">in</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> ecard <span class="main">(</span>Set.filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> meval_trm <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">group</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="bound">images</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> M'_M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">(</span>drop <span class="free">b</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">M</span> <span class="main">(</span>map the <span class="main">(</span>drop <span class="free">b</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">rel</span>"</span></span> <span class="quoted"><span class="quoted">"mem_restr <span class="main">(</span>lift_envs' <span class="free">b</span> <span class="free">R</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> wf_x<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>fv <span class="free">φ</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_qtableE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inner<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> wf_zs_x<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>map Some <span class="skolem">zs</span> <span class="main">@</span> drop <span class="free">b</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">zs</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">zs</span>
        <span class="keyword1"><span class="command">using</span></span> that b_fv
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_tuple_append wf_tuple_map_Some wf_tuple_drop<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="skolem">zs</span> <span class="main">=</span> <span class="free">b</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> map the <span class="main">(</span>drop <span class="free">b</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">∧</span>
          Formula.eval_trm <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> map the <span class="main">(</span>drop <span class="free">b</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">⟷</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">rel</span> <span class="main">∧</span> take <span class="free">b</span> <span class="bound">a</span> <span class="main">=</span> map Some <span class="skolem">zs</span> <span class="main">∧</span> drop <span class="free">b</span> <span class="bound">a</span> <span class="main">=</span> drop <span class="free">b</span> <span class="skolem">x</span> <span class="main">∧</span> meval_trm <span class="free">f</span> <span class="bound">a</span> <span class="main">=</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="var">?B</span> <span class="bound">a</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span> <span class="skolem">zs</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> iffI conjI<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">(</span>map Some <span class="skolem">zs</span> <span class="main">@</span> drop <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> in_qtableI<span class="main">[</span><span class="operator">OF</span> inner wf_zs_x<span class="main">]</span> <span class="quoted"><span class="quoted">‹mem_restr <span class="main">(</span>lift_envs' <span class="free">b</span> <span class="free">R</span><span class="main">)</span> <span class="skolem">x</span>›</span></span>
            meval_trm_eval_trm<span class="main">[</span><span class="operator">OF</span> wf_zs_x f_fv b_n<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mem_restr_dropI<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="var">?B</span> <span class="bound">a</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="var">?B</span> <span class="bound">a</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">rel</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> map Some <span class="skolem">zs</span> <span class="main">@</span> drop <span class="free">b</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> append_take_drop_id<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">a</span> <span class="main">=</span> <span class="free">b</span> <span class="main">+</span> <span class="free">n</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> inner <span class="keyword1"><span class="command">unfolding</span></span> qtable_def table_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_tuple_length<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">zs</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> wf_tuple_length<span class="main">[</span><span class="operator">OF</span> wf_x<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> a_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem_restr <span class="main">(</span>lift_envs' <span class="free">b</span> <span class="free">R</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹mem_restr <span class="main">_</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> a_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mem_restr_dropI<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> map the <span class="main">(</span>drop <span class="free">b</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> in_qtableE<span class="main">[</span><span class="operator">OF</span> inner <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="free">rel</span>›</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> a_eq sat_fv_cong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?B</span> <span class="skolem">a</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.eval_trm <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> map the <span class="main">(</span>drop <span class="free">b</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> meval_trm_eval_trm<span class="main">[</span><span class="operator">OF</span> wf_zs_x f_fv b_n<span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹length <span class="skolem">zs</span> <span class="main">=</span> <span class="free">b</span>›</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">unfolding</span></span> a_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"map Some <span class="main">(</span>map the <span class="main">(</span>take <span class="free">b</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> take <span class="free">b</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">rel</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">a</span>
        <span class="keyword1"><span class="command">using</span></span> that b_fv inner<span class="main">[</span><span class="operator">THEN</span> qtable_wf_tupleD<span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> table_def wf_tuple_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"ecard <span class="main">{</span><span class="bound">zs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">rel</span> <span class="main">∧</span> take <span class="free">b</span> <span class="bound">a</span> <span class="main">=</span> map Some <span class="bound">zs</span> <span class="main">∧</span> drop <span class="free">b</span> <span class="bound">a</span> <span class="main">=</span> drop <span class="free">b</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="skolem">P</span> <span class="bound">a</span><span class="main">}</span> <span class="main">=</span>
        ecard <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">rel</span> <span class="main">∧</span> drop <span class="free">b</span> <span class="bound">a</span> <span class="main">=</span> drop <span class="free">b</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="skolem">P</span> <span class="bound">a</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"ecard <span class="var">?A</span> <span class="main">=</span> ecard <span class="var">?B</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">P</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ecard <span class="var">?A</span> <span class="main">=</span> ecard <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">zs</span><span class="main">.</span> map Some <span class="bound">zs</span> <span class="main">@</span> drop <span class="free">b</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">`</span> <span class="var">?A</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ecard_image<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> inj_onI<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">zs</span><span class="main">.</span> map Some <span class="bound">zs</span> <span class="main">@</span> drop <span class="free">b</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">`</span> <span class="var">?A</span> <span class="main">=</span> <span class="var">?B</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> eq_commute<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="quoted">"2"</span> append_take_drop_id<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> M_def M'_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> non_default_case Let_def image_def Set.filter_def 1 3<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="quoted">"2"</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> drop_lift<span class="main">:</span> <span class="quoted"><span class="quoted">"mem_restr <span class="main">(</span>lift_envs' <span class="free">b</span> <span class="free">R</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">rel</span>"</span></span> <span class="quoted"><span class="quoted">"mem_restr <span class="free">R</span> <span class="main">(</span><span class="main">(</span>drop <span class="free">b</span> <span class="skolem">x</span><span class="main">)</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">z</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>drop <span class="free">b</span> <span class="skolem">x</span><span class="main">)</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>None<span class="main">]</span> <span class="main">=</span> <span class="main">(</span>drop <span class="free">b</span> <span class="skolem">x</span><span class="main">)</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>drop <span class="free">b</span> <span class="skolem">x</span> <span class="main">!</span> <span class="free">y</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">rel</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="free">b</span> <span class="skolem">x</span> <span class="main">!</span> <span class="free">y</span> <span class="main">=</span> None"</span></span>
          <span class="keyword1"><span class="command">using</span></span> fresh n inner<span class="main">[</span><span class="operator">THEN</span> qtable_wf_tupleD<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute wf_tuple_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>drop <span class="free">b</span> <span class="skolem">x</span><span class="main">)</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>None<span class="main">]</span> <span class="main">=</span> drop <span class="free">b</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">rel</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">x</span> <span class="main">=</span> <span class="free">b</span> <span class="main">+</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> inner<span class="main">[</span><span class="operator">THEN</span> qtable_wf_tupleD<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_tuple_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> that<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem_restr <span class="free">R</span> <span class="main">(</span><span class="main">(</span>drop <span class="free">b</span> <span class="skolem">x</span><span class="main">)</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span><span class="skolem">z</span><span class="main">,</span> <span class="free">y</span><span class="main">:=</span>None<span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mem_restr_upd_None<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mem_restr_dropD<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"mem_restr <span class="free">R</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>Some <span class="main">(</span>eval_agg_op <span class="free">ω</span> <span class="main">(</span><span class="skolem">M'</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">`</span> drop <span class="free">b</span> <span class="main">`</span> <span class="free">rel</span> <span class="main">⟷</span>
          <span class="skolem">v</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>Some <span class="main">(</span>eval_agg_op <span class="free">ω</span> <span class="main">(</span><span class="skolem">M</span> <span class="main">(</span>map the <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">`</span> drop <span class="free">b</span> <span class="main">`</span> <span class="free">rel</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="var">?A</span> <span class="main">⟷</span> <span class="skolem">v</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> <span class="free">rel</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span>drop <span class="free">b</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>Some <span class="main">(</span>eval_agg_op <span class="free">ω</span> <span class="main">(</span><span class="skolem">M'</span> <span class="main">(</span>drop <span class="free">b</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M'</span> <span class="main">(</span>drop <span class="free">b</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">M</span> <span class="main">(</span>map the <span class="main">(</span>drop <span class="free">b</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹mem_restr <span class="free">R</span> <span class="skolem">v</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> M'_M drop_lift<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> <span class="free">rel</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span>drop <span class="free">b</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>Some <span class="main">(</span>eval_agg_op <span class="free">ω</span> <span class="main">(</span><span class="skolem">M</span> <span class="main">(</span>map the <span class="main">(</span>drop <span class="free">b</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">(</span>map the <span class="main">(</span>drop <span class="free">b</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">M'</span> <span class="main">(</span>drop <span class="free">b</span> <span class="skolem">v'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹mem_restr <span class="free">R</span> <span class="skolem">v</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> M'_M<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> drop_lift<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> eval_agg <span class="free">n</span> <span class="free">g0</span> <span class="free">y</span> <span class="free">ω</span> <span class="free">b</span> <span class="free">f</span> <span class="free">rel</span> <span class="main">⟷</span> <span class="skolem">v</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>Some <span class="main">(</span>eval_agg_op <span class="free">ω</span> <span class="main">(</span><span class="skolem">M</span> <span class="main">(</span>map the <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">`</span> drop <span class="free">b</span> <span class="main">`</span> <span class="free">rel</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> non_default_case eval_agg_def M'_def Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> alt <span class="main">=</span> this

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> qtableI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="var">?fv</span> <span class="var">?rel'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> inner<span class="main">[</span><span class="operator">THEN</span> qtable_wf_tupleD<span class="main">]</span> n f_fvi
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eval_agg_def non_default_case table_def wf_tuple_def Let_def nth_list_update
            fvi_iff_fv<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">b</span></span><span class="main"><span class="main">]</span></span> add.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="var">?fv</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"mem_restr <span class="free">R</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> length_v<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">v</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_tuple_def<span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="free">i</span> <span class="main">(</span>Formula.Agg <span class="free">y</span> <span class="free">ω</span> <span class="free">b</span> <span class="free">f</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> eval_agg <span class="free">n</span> <span class="free">g0</span> <span class="free">y</span> <span class="free">ω</span> <span class="free">b</span> <span class="free">f</span> <span class="free">rel</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> that <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> <span class="free">rel</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span>drop <span class="free">b</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>Some <span class="main">(</span>eval_agg_op <span class="free">ω</span> <span class="main">(</span><span class="skolem">M</span> <span class="main">(</span>map the <span class="main">(</span>drop <span class="free">b</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> alt<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹mem_restr <span class="free">R</span> <span class="skolem">v</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> length_v'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">v'</span> <span class="main">=</span> <span class="free">b</span> <span class="main">+</span> <span class="free">n</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> inner<span class="main">[</span><span class="operator">THEN</span> qtable_wf_tupleD<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_tuple_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="skolem">v'</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="main">∈</span> <span class="free">rel</span>›</span></span> <span class="quoted"><span class="quoted">‹mem_restr <span class="free">R</span> <span class="skolem">v</span>›</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_qtableE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inner<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> drop_lift <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="main">∈</span> <span class="free">rel</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="main">(</span>take <span class="free">b</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">@</span> map the <span class="skolem">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sat_fv_cong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> ballI<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> fv <span class="free">φ</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">+</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> length <span class="skolem">v'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> fv <span class="free">φ</span>›</span></span> b_n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_v'<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"map the <span class="skolem">v'</span> <span class="main">!</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span>map the <span class="main">(</span>take <span class="free">b</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">@</span> map the <span class="skolem">v</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">=</span> <span class="main">_</span>›</span></span> nth_append<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M_def length_v'<span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> length <span class="main">(</span>drop <span class="free">b</span> <span class="skolem">v'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_v'<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> map the <span class="skolem">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">⟷</span>
          Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> map the <span class="main">(</span>drop <span class="free">b</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">zs</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">zs</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sat_fv_cong ballI<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> fv <span class="free">φ</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">+</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> length <span class="skolem">v'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> fv <span class="free">φ</span>›</span></span> b_n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_v'<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> map the <span class="skolem">v</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> map the <span class="main">(</span>drop <span class="free">b</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">=</span> <span class="main">_</span>›</span></span> that nth_append<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.eval_trm <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> map the <span class="skolem">v</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span>
          Formula.eval_trm <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> map the <span class="main">(</span>drop <span class="free">b</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">zs</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">zs</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> eval_trm_fv_cong ballI<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> fv_trm <span class="free">f</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">+</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_fv fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> length <span class="skolem">v'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> fv_trm <span class="free">f</span>›</span></span> f_fv b_n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_v'<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> map the <span class="skolem">v</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> map the <span class="main">(</span>drop <span class="free">b</span> <span class="skolem">v'</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">=</span> <span class="main">_</span>›</span></span> that nth_append<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map the <span class="skolem">v</span> <span class="main">!</span> <span class="free">y</span> <span class="main">=</span> eval_agg_op <span class="free">ω</span> <span class="main">(</span><span class="skolem">M</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def <span class="quoted"><span class="quoted">‹<span class="skolem">v</span> <span class="main">=</span> <span class="main">_</span>›</span></span> conj_commute <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> conj_cong<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> eval_agg <span class="free">n</span> <span class="free">g0</span> <span class="free">y</span> <span class="free">ω</span> <span class="free">b</span> <span class="free">f</span> <span class="free">rel</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> sat_Agg<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="free">i</span> <span class="main">(</span>Formula.Agg <span class="free">y</span> <span class="free">ω</span> <span class="free">b</span> <span class="free">f</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">zs</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"map Some <span class="skolem">zs</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>None<span class="main">]</span> <span class="main">∈</span> <span class="free">rel</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fv <span class="free">φ</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">}</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">with</span></span> non_default_case <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">rel</span> <span class="main">≠</span> empty_table"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g0<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">rel</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">v</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>None<span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> True <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="var">?fv</span> <span class="skolem">v</span>›</span></span> f_fv
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_def fvi_iff_fv<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">b</span></span><span class="main"><span class="main">]</span></span> fvi_trm_iff_fv_trm<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">b</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> drop <span class="free">b</span> <span class="skolem">x</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">∧</span> length <span class="skolem">x</span> <span class="main">=</span> <span class="free">b</span> <span class="main">+</span> <span class="free">n</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> True <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">rel</span>›</span></span> inner<span class="main">[</span><span class="operator">THEN</span> qtable_wf_tupleD<span class="main">]</span> f_fv
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_def<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>None<span class="main">]</span> <span class="main">=</span> drop <span class="free">b</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> list_eq_iff_nth_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_v<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">rel</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="free">b</span> <span class="skolem">x</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>None<span class="main">]</span> <span class="main">∈</span> <span class="free">rel</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>Some <span class="main">∘</span> the<span class="main">)</span> <span class="main">(</span>take <span class="free">b</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> take <span class="free">b</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> True <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">rel</span>›</span></span> inner<span class="main">[</span><span class="operator">THEN</span> qtable_wf_tupleD<span class="main">]</span> b_fv
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> map_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> g<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">id</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_def in_set_conv_nth<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map Some <span class="main">(</span>map the <span class="main">(</span>take <span class="free">b</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>None<span class="main">]</span> <span class="main">∈</span> <span class="free">rel</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="skolem">thesis</span></span> <span class="keyword1"><span class="command">using</span></span> x<span class="main">[</span><span class="operator">THEN</span> conjunct2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> that<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">with</span></span> sat_Agg <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">zs</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> map the <span class="skolem">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> map the <span class="main">(</span><span class="skolem">v</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>None<span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> fresh
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_update not_less nth_append <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sat_fv_cong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span>
                <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nth_list_update_neq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map Some <span class="skolem">zs</span> <span class="main">@</span> <span class="skolem">v</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>None<span class="main">]</span> <span class="main">∈</span> <span class="free">rel</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> b_fv f_fv fresh
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_qtableI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inner<span class="main"><span class="main">]</span></span> wf_tuple_append wf_tuple_map_Some
                wf_tuple_upd_None <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="var">?fv</span> <span class="skolem">v</span>›</span></span> mem_restr_upd_None <span class="quoted"><span class="quoted">‹mem_restr <span class="free">R</span> <span class="skolem">v</span>›</span></span>
                <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">zs</span> <span class="main">=</span> <span class="free">b</span>›</span></span> set_eq_iff fvi_iff_fv<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">b</span></span><span class="main"><span class="main">]</span></span> fvi_trm_iff_fv_trm<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">b</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
              <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command">with</span></span> that <span class="quoted"><span class="quoted">‹length <span class="skolem">zs</span> <span class="main">=</span> <span class="free">b</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="skolem">thesis</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>None<span class="main">]</span> <span class="main">∈</span> drop <span class="free">b</span> <span class="main">`</span> <span class="free">rel</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> image_eqI<span class="main">)</span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">have</span></span> y_length<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> length <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_v<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> map the <span class="main">(</span><span class="skolem">v</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>None<span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">⟷</span>
          Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> map the <span class="skolem">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">zs</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">zs</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> sat_fv_cong ballI<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> fv <span class="free">φ</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">+</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">+</span> length <span class="skolem">v</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> fv <span class="free">φ</span>›</span></span> b_n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_v<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> map the <span class="main">(</span><span class="skolem">v</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>None<span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> map the <span class="skolem">v</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> that nth_append<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.eval_trm <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> map the <span class="main">(</span><span class="skolem">v</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>None<span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span>
          Formula.eval_trm <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> map the <span class="skolem">v</span><span class="main">)</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">zs</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">zs</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> eval_trm_fv_cong ballI<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> fv_trm <span class="free">f</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">+</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_fv fresh <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">+</span> length <span class="skolem">v</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> fv_trm <span class="free">f</span>›</span></span> f_fv b_n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_v<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> map the <span class="main">(</span><span class="skolem">v</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>None<span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> map the <span class="skolem">v</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> that nth_append<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map the <span class="skolem">v</span> <span class="main">!</span> <span class="free">y</span> <span class="main">=</span> eval_agg_op <span class="free">ω</span> <span class="main">(</span><span class="skolem">M</span> <span class="main">(</span>map the <span class="main">(</span><span class="skolem">v</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>None<span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> sat_Agg <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> conj_cong<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> rev_conj_cong<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">!</span> <span class="free">y</span> <span class="main">=</span> Some <span class="main">(</span>eval_agg_op <span class="free">ω</span> <span class="main">(</span><span class="skolem">M</span> <span class="main">(</span>map the <span class="main">(</span><span class="skolem">v</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>None<span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="var">?fv</span> <span class="skolem">v</span>›</span></span> y_length <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_tuple_def<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> alt<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹mem_restr <span class="free">R</span> <span class="skolem">v</span>›</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>None<span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">use</span> 1 2 <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> y_length list_update_id›</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mprev_next_NilE<span class="main">[</span><span class="operator">elim</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mprev_next <span class="free">I</span> <span class="free">xs</span> <span class="free">ts</span> <span class="main">=</span> <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">ts</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">R</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mprev_next.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mprev<span class="main">:</span> <span class="quoted"><span class="quoted">"mprev_next <span class="free">I</span> <span class="free">xs</span> <span class="free">ts</span> <span class="main">=</span> <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">xs'</span><span class="main">,</span> <span class="free">ts'</span><span class="main">)</span> <span class="main">⟹</span>
  list_all2 <span class="free">P</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j'</span><span class="main">]</span> <span class="free">xs</span> <span class="main">⟹</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free">ts</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j'</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span>
  list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">X</span><span class="main">.</span> <span class="keyword1">if</span> mem <span class="free">I</span> <span class="main">(</span><span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free">P</span> <span class="bound">i</span> <span class="bound">X</span> <span class="keyword1">else</span> <span class="bound">X</span> <span class="main">=</span> empty_table<span class="main">)</span>
    <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span>min <span class="free">j'</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span> <span class="keyword1">then</span> <span class="free">j</span> <span class="keyword1">else</span> <span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="free">ys</span> <span class="main">∧</span>
  list_all2 <span class="free">P</span> <span class="main">[</span>min <span class="free">j'</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span> <span class="keyword1">then</span> <span class="free">j</span> <span class="keyword1">else</span> <span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">..&lt;</span><span class="free">j'</span><span class="main">]</span> <span class="free">xs'</span> <span class="main">∧</span>
  list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>min <span class="free">j'</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span> <span class="keyword1">then</span> <span class="free">j</span> <span class="keyword1">else</span> <span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free">ts'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">xs'</span></span> <span class="quoted"><span class="free">ts'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mprev_next.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">I</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="free">j'</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">j</span> <span class="keyword1">then</span> <span class="free">j</span> <span class="keyword1">else</span> <span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">I</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="free">j'</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">I</span> <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 4<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"tl <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="skolem">xs'</span></span> <span class="quoted"><span class="skolem">ts'</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span> 4<span class="main">(</span>2-6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv Suc_less_eq2
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.rel_mono_strong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gr0_conv_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mnext<span class="main">:</span> <span class="quoted"><span class="quoted">"mprev_next <span class="free">I</span> <span class="free">xs</span> <span class="free">ts</span> <span class="main">=</span> <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">xs'</span><span class="main">,</span> <span class="free">ts'</span><span class="main">)</span> <span class="main">⟹</span>
  list_all2 <span class="free">P</span> <span class="main">[</span>Suc <span class="free">i</span><span class="main">..&lt;</span><span class="free">j'</span><span class="main">]</span> <span class="free">xs</span> <span class="main">⟹</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free">ts</span> <span class="main">⟹</span> Suc <span class="free">i</span> <span class="main">≤</span> <span class="free">j'</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span>
  list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">X</span><span class="main">.</span> <span class="keyword1">if</span> mem <span class="free">I</span> <span class="main">(</span><span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="bound">X</span> <span class="keyword1">else</span> <span class="bound">X</span> <span class="main">=</span> empty_table<span class="main">)</span>
    <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span>min <span class="main">(</span><span class="free">j'</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span> <span class="keyword1">then</span> <span class="free">j</span> <span class="keyword1">else</span> <span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="free">ys</span> <span class="main">∧</span>
  list_all2 <span class="free">P</span> <span class="main">[</span>Suc <span class="main">(</span>min <span class="main">(</span><span class="free">j'</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span> <span class="keyword1">then</span> <span class="free">j</span> <span class="keyword1">else</span> <span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">..&lt;</span><span class="free">j'</span><span class="main">]</span> <span class="free">xs'</span> <span class="main">∧</span>
  list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>min <span class="main">(</span><span class="free">j'</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span> <span class="keyword1">then</span> <span class="free">j</span> <span class="keyword1">else</span> <span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free">ts'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">xs'</span></span> <span class="quoted"><span class="free">ts'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mprev_next.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">I</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="free">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">j</span> <span class="keyword1">then</span> <span class="free">j</span> <span class="keyword1">else</span> <span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">I</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="free">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">j</span> <span class="keyword1">then</span> <span class="free">j</span> <span class="keyword1">else</span> <span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">I</span> <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 4<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"tl <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="skolem">xs'</span></span> <span class="quoted"><span class="skolem">ts'</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span> 4<span class="main">(</span>2-6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv Suc_less_eq2
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.rel_mono_strong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits if_splits<span class="main">)</span> <span class="comment1">(* slow 10 sec *)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> in_foldr_UnI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> foldr <span class="main">(∪)</span> <span class="free">xs</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> in_foldr_UnE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> foldr <span class="main">(∪)</span> <span class="free">xs</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">A</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sat_the_restrict<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="free">φ</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="main">(</span>restrict <span class="free">A</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">=</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sat_fv_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_the_restrict<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eps_the_restrict<span class="main">:</span> <span class="quoted"><span class="quoted">"fv_regex <span class="free">r</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> Regex.eps <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="main">(</span>restrict <span class="free">A</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span> <span class="main">=</span> Regex.eps <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eps_fv_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_the_restrict<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_wrt_filter<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">R</span> <span class="free">xs</span> <span class="main">⟹</span> sorted_wrt <span class="free">R</span> <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> concat_map_filter<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"concat <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">P</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_filter_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">P</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="main">[</span><span class="free">f</span> <span class="bound">x</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> maux<span class="main">)</span> update_since<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_since_aux <span class="free">σ</span> <span class="free">V</span> <span class="free">R</span> <span class="free">args</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="free">aux</span> <span class="free">ne</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> qtable1<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>Formula.fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="free">φ</span><span class="main">)</span> <span class="free">rel1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> qtable2<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>Formula.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">rel2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> result_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">rel</span><span class="main">,</span> <span class="free">aux'</span><span class="main">)</span> <span class="main">=</span> update_since <span class="free">args</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span><span class="main">)</span> <span class="free">aux</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fvi_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.fv <span class="free">φ</span> <span class="main">⊆</span> Formula.fv <span class="free">ψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_ivl<span class="main">:</span> <span class="quoted"><span class="quoted">"args_ivl <span class="free">args</span> <span class="main">=</span> <span class="free">I</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_n<span class="main">:</span> <span class="quoted"><span class="quoted">"args_n <span class="free">args</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_L<span class="main">:</span> <span class="quoted"><span class="quoted">"args_L <span class="free">args</span> <span class="main">=</span> Formula.fv <span class="free">φ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_R<span class="main">:</span> <span class="quoted"><span class="quoted">"args_R <span class="free">args</span> <span class="main">=</span> Formula.fv <span class="free">ψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"args_pos <span class="free">args</span> <span class="main">=</span> <span class="free">pos</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_since_aux <span class="free">σ</span> <span class="free">V</span> <span class="free">R</span> <span class="free">args</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="free">aux'</span> <span class="main">(</span>Suc <span class="free">ne</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>Formula.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="main">(</span>Sincep <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="free">rel</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?wf_tuple</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">v</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="main">(</span>Formula.fv <span class="free">ψ</span><span class="main">)</span> <span class="bound">v</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> sat.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> pre<span class="main">[</span><span class="operator">unfolded</span> wf_since_aux_def<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cur</span></span> <span class="skolem"><span class="skolem">auxlist</span></span> <span class="keyword2"><span class="keyword">where</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">valid_msaux</span> <span class="free">args</span> <span class="skolem">cur</span> <span class="free">aux</span> <span class="skolem">auxlist</span>"</span></span>
    <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> fst <span class="bound">y</span> <span class="main">&lt;</span> fst <span class="bound">x</span><span class="main">)</span> <span class="skolem">auxlist</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">auxlist</span> <span class="main">⟹</span> <span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span>
      qtable <span class="free">n</span> <span class="main">(</span>fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span>
        <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Sincep <span class="free">pos</span> <span class="free">φ</span> <span class="main">(</span>point <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="bound">X</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟹</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟹</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> cur_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">cur</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">ne</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> args_ivl args_n args_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> pre<span class="main">[</span><span class="operator">unfolded</span> wf_since_aux_def<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> fv_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.fv <span class="free">φ</span> <span class="main">⊆</span> Formula.fv <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">aux0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aux0</span> <span class="main">=</span> <span class="free">join_msaux</span> <span class="free">args</span> <span class="free">rel1</span> <span class="main">(</span><span class="free">add_new_ts_msaux</span> <span class="free">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span><span class="main">)</span> <span class="free">aux</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">auxlist0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">auxlist0</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> join <span class="bound">rel</span> <span class="free">pos</span> <span class="free">rel1</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>t<span class="main">,</span> rel<span class="main">)</span> <span class="main">←</span> <span class="skolem">auxlist</span><span class="main">,</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> tabL<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="free">rel1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> qtable1<span class="main">[</span><span class="operator">unfolded</span> qtable_def<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> args_n<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> args_L<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> cur_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cur</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cur_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> valid0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">valid_msaux</span> <span class="free">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span><span class="main">)</span> <span class="skolem">aux0</span> <span class="skolem">auxlist0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> aux0_def auxlist0_def
    <span class="keyword1"><span class="command">using</span></span> valid_join_msaux<span class="main">[</span><span class="operator">OF</span> valid_add_new_ts_msaux<span class="main"><span class="main">[</span></span><span class="operator">OF</span> aux<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">OF</span> cur_le tabL<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> args_ivl args_pos cur_def map_filter_alt split_beta <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> map_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> aux<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> sorted_auxlist0<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">&gt;</span> fst <span class="bound">y</span><span class="main">)</span> <span class="skolem">auxlist0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist0_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">auxlist</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_wrt_append<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> in_auxlist0_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">auxlist0</span> <span class="main">⟹</span> <span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">∧</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∧</span>
      qtable <span class="free">n</span> <span class="main">(</span>Formula.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>Sincep <span class="free">pos</span> <span class="free">φ</span> <span class="main">(</span>point <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">∧</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="free">pos</span> <span class="keyword1">then</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="free">φ</span> <span class="keyword1">else</span> <span class="main">¬</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="skolem">X</span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist0_def <span class="keyword1"><span class="command">using</span></span> fvi_subset
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 1 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_join<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ qtable1<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sat_the_restrict <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> aux<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> in_auxlist0_le_τ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">auxlist0</span> <span class="main">⟹</span> <span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="skolem">X</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> τ_mono diff_le_self le_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> in_auxlist0_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">⟹</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">auxlist0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">auxlist</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> aux<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gr0_conv_Suc <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> diff_le_mono τ_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> join <span class="skolem">X</span> <span class="free">pos</span> <span class="free">rel1</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">auxlist0</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> auxlist0_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">X</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">auxlist0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> auxlist0_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">auxlist0</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">ne</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">∧</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∄</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> in_auxlist0_2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> aux'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">aux'</span> <span class="main">=</span> <span class="free">add_new_table_msaux</span> <span class="free">args</span> <span class="free">rel2</span> <span class="skolem">aux0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> result_eq <span class="keyword1"><span class="command">unfolding</span></span> aux0_def update_since_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">auxlist'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    auxlist'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">auxlist'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">auxlist0</span> <span class="keyword1">of</span>
      <span class="main">[]</span> <span class="main">⇒</span> <span class="main">[</span><span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span><span class="main">,</span> <span class="free">rel2</span><span class="main">)</span><span class="main">]</span>
    <span class="main">|</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">auxlist'</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> fst <span class="bound">x</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">ne</span> <span class="keyword1">then</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">,</span> snd <span class="bound">x</span> <span class="main">∪</span> <span class="free">rel2</span><span class="main">)</span> <span class="main">#</span> <span class="bound">auxlist'</span> <span class="keyword1">else</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span><span class="main">,</span> <span class="free">rel2</span><span class="main">)</span> <span class="main">#</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">auxlist'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> tabR<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="free">rel2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> qtable2<span class="main">[</span><span class="operator">unfolded</span> qtable_def<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> args_n<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> args_R<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> valid'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">valid_msaux</span> <span class="free">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span><span class="main">)</span> <span class="free">aux'</span> <span class="skolem">auxlist'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq auxlist'_eq <span class="keyword1"><span class="command">using</span></span> valid_add_new_table_msaux<span class="main">[</span><span class="operator">OF</span> valid0 tabR<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_le <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits option.splits if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> sorted_auxlist'<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">&gt;</span> fst <span class="bound">y</span><span class="main">)</span> <span class="skolem">auxlist'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_eq
    <span class="keyword1"><span class="command">using</span></span> sorted_auxlist0 in_auxlist0_le_τ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">auxlist0</span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> in_auxlist'_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">∧</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∧</span>
      qtable <span class="free">n</span> <span class="main">(</span>Formula.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="main">(</span>Sincep <span class="free">pos</span> <span class="free">φ</span> <span class="main">(</span>point <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> auxlist'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">auxlist'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="skolem">X</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">auxlist0</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">with</span></span> auxlist' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_eq <span class="keyword1"><span class="command">using</span></span> qtable2 auxlist0_Nil
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_enat_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> sat_Since_rec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">ne</span></span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> t<span class="main">:</span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> auxlist' Cons t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> snd <span class="skolem">a</span> <span class="main">∪</span> <span class="free">rel2</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_eq <span class="keyword1"><span class="command">using</span></span> sorted_auxlist0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> in_auxlist0_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">a</span>"</span></span><span class="main">]</span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
          <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> fst <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> fst <span class="skolem">a</span>"</span></span>
          <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>
            <span class="main">(</span>Sincep <span class="free">pos</span> <span class="free">φ</span> <span class="main">(</span>point <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> fst <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">pos</span> <span class="keyword1">then</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="free">φ</span>
              <span class="keyword1">else</span> <span class="main">¬</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">a</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> True<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> zero_enat_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> qtable2 t True
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sat_Since_rec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">ne</span></span><span class="main"><span class="main">]</span></span> sat.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_union<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> auxlist' Cons t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="free">rel2</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_eq <span class="keyword1"><span class="command">using</span></span> sorted_auxlist0 in_auxlist0_le_τ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">a</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> auxlist' Cons t False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_eq <span class="keyword1"><span class="command">using</span></span> qtable2 in_auxlist0_2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span><span class="main">]</span> in_auxlist0_le_τ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">a</span>"</span></span><span class="main">]</span> sorted_auxlist0
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sat_Since_rec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">ne</span></span><span class="main"><span class="main">]</span></span> sat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> zero_enat_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> enat_0_iff not_le
              <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ refl<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_τ_less meta_mp<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> auxlist' Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">auxlist0</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
        <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Sincep <span class="free">pos</span> <span class="free">φ</span> <span class="main">(</span>point <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">∧</span>
           <span class="main">(</span><span class="keyword1">if</span> <span class="free">pos</span> <span class="keyword1">then</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="free">φ</span> <span class="keyword1">else</span> <span class="main">¬</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> in_auxlist0_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">with</span></span> False auxlist' Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_eq <span class="keyword1"><span class="command">using</span></span> qtable2
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sat_Since_rec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">ne</span></span><span class="main"><span class="main">]</span></span> sat.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span>
            diff_diff_right<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">ne</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> j<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">_</span> <span class="main">+</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> k<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span>
              <span class="operator">OF</span> trans_le_add2<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ refl<span class="main"><span class="main">]</span></span> order_trans <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> le_τ_less<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> in_auxlist'_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">auxlist'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">auxlist0</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_enat_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_eq
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_enat_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> le_τ_less neq0_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> False that <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_leI Suc_pred τ_mono diff_is_0_eq' order.antisym neq0_conv not_le<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">auxlist0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> τ_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ne</span>"</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_auxlist0_2 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> τ_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_eq <span class="keyword1"><span class="command">using</span></span> False <span class="quoted"><span class="quoted">‹memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">X</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.split<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_since_aux <span class="free">σ</span> <span class="free">V</span> <span class="free">R</span> <span class="free">args</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="free">aux'</span> <span class="main">(</span>Suc <span class="free">ne</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wf_since_aux_def args_ivl args_n args_pos
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_sub <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_auxlist'_1 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sorted_auxlist' in_auxlist'_2
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">auxlist'</span></span><span class="main"><span class="main">]</span></span> valid'<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">rel</span> <span class="main">=</span> <span class="free">result_msaux</span> <span class="free">args</span> <span class="free">aux'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> result_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> update_since_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> valid' <span class="keyword1"><span class="command">have</span></span> rel_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rel</span> <span class="main">=</span> foldr <span class="main">(∪)</span> <span class="main">[</span><span class="bound">rel</span><span class="main">.</span> <span class="main">(</span>t<span class="main">,</span> rel<span class="main">)</span> <span class="main">←</span> <span class="skolem">auxlist'</span><span class="main">,</span> memL <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">]</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> args_ivl valid_result_msaux
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> foldr <span class="main">(∪)</span> <span class="main">(</span>concat <span class="bound">x</span><span class="main">)</span> <span class="main">{}</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> rel_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rel</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">rel</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">auxlist'</span><span class="main">.</span> <span class="keyword1">if</span> memL <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">then</span> <span class="bound">rel</span> <span class="keyword1">else</span> empty_table<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rel_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_foldr_UnE bexI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_foldr_UnI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="main">(</span>Sincep <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="free">rel</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rel_alt
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> qtable_Union<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Qi<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">v</span><span class="main">.</span>
    memL <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="main">(</span>Sincep <span class="free">pos</span> <span class="free">φ</span> <span class="main">(</span>point <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">goal_cases</span> finite qtable equiv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>equiv <span class="skolem">v</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> sat_Since_point<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> left right<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>left <span class="skolem">j</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> in_auxlist'_2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">j</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> _ _ exI<span class="main">,</span> <span class="operator">OF</span> _ _ refl<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> right
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sat_Since_pointD <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_auxlist'_1<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_auxlist'_1 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_empty<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fv_regex_from_mregex<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ok <span class="main">(</span>length <span class="free">φs</span><span class="main">)</span> <span class="free">mr</span> <span class="main">⟹</span> fv_regex <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">φ</span> <span class="main">∈</span> set <span class="free">φs</span><span class="main">.</span> fv <span class="bound">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">mr</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Bex_def in_set_conv_nth<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> qtable_ε_lax<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span>length <span class="free">φs</span><span class="main">)</span> <span class="free">mr</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="bound">rel</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>Formula.fv <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">i</span> <span class="bound">φ</span><span class="main">)</span> <span class="bound">rel</span><span class="main">)</span> <span class="free">φs</span> <span class="free">rels</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fv_regex <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="free">Q</span> <span class="free">guard</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span>
   <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Regex.eps <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">v</span><span class="main">)</span> <span class="main">(</span>ε_lax <span class="free">guard</span> <span class="free">rels</span> <span class="free">mr</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">mr</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MPlus <span class="skolem">mr1</span> <span class="skolem">mr2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MPlus<span class="main">(</span>3-6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_union<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MPlus<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MTimes <span class="skolem">mr1</span> <span class="skolem">mr2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv_regex <span class="main">(</span>from_mregex <span class="skolem">mr1</span> <span class="free">φs</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"fv_regex <span class="main">(</span>from_mregex <span class="skolem">mr2</span> <span class="free">φs</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fv_regex_from_mregex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">φs</span></span> <span class="quoted"><span class="skolem">mr1</span></span><span class="main">]</span> fv_regex_from_mregex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">φs</span></span> <span class="quoted"><span class="skolem">mr2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subset_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> MTimes<span class="main">(</span>3-6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eps_the_restrict restrict_idle <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_join<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MTimes<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qtable_empty_iff list_all2_conv_all_nth
    in_set_conv_nth restrict_idle sat_the_restrict
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> in_qtableI qtableI <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_join<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">A</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> C<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">A</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nullary_qtable_cases<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">{}</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">X</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">X</span> <span class="main">=</span> empty_table <span class="main">∨</span> <span class="free">X</span> <span class="main">=</span> unit_table <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qtable_def table_empty<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_tuple_unit_table<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="main">{}</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> replicate <span class="free">n</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_iff length_replicate nth_equalityI nth_replicate<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> qtable_empty_unit_table<span class="main">:</span>
  <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">{}</span> <span class="free">R</span> <span class="free">P</span> empty_table <span class="main">⟹</span> qtable <span class="free">n</span> <span class="main">{}</span> <span class="free">R</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">v</span><span class="main">)</span> <span class="main">(</span>unit_table <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> qtable_unit_table <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qtable_empty_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> qtable_unit_empty_table<span class="main">:</span>
  <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">{}</span> <span class="free">R</span> <span class="free">P</span> <span class="main">(</span>unit_table <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> qtable <span class="free">n</span> <span class="main">{}</span> <span class="free">R</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">v</span><span class="main">)</span> empty_table"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_empty <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> in_qtableE <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_tuple_empty unit_table_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> qtable_nonempty_empty_table<span class="main">:</span>
  <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">{}</span> <span class="free">R</span> <span class="free">P</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> qtable <span class="free">n</span> <span class="main">{}</span> <span class="free">R</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">v</span><span class="main">)</span> empty_table"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">frule</span> nullary_qtable_cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> qtable_unit_empty_table<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> qtable_rε_strict<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"safe_regex Past Strict <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span>length <span class="free">φs</span><span class="main">)</span> <span class="free">mr</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> fv_regex <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="bound">rel</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>Formula.fv <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">i</span> <span class="bound">φ</span><span class="main">)</span> <span class="bound">rel</span><span class="main">)</span> <span class="free">φs</span> <span class="free">rels</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Regex.eps <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rε_strict <span class="free">n</span> <span class="free">rels</span> <span class="free">mr</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">hypsubst</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted">Past</span> <span class="quoted">Strict</span> <span class="quoted"><span class="quoted">"from_mregex <span class="free">mr</span> <span class="free">φs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mr</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> safe_regex_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Skip <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mr</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qtable_empty_iff qtable_unit_table <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Test <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mr</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_conv_all_nth qtable_empty_unit_table
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_nonempty_empty_table <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mr</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> qtable_union <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>TimesP <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mr</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> qtable_ε_lax<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mr</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qtable_unit_table <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> qtable_lε_strict<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"safe_regex Futu Strict <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span>length <span class="free">φs</span><span class="main">)</span> <span class="free">mr</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> fv_regex <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="bound">rel</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>Formula.fv <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">i</span> <span class="bound">φ</span><span class="main">)</span> <span class="bound">rel</span><span class="main">)</span> <span class="free">φs</span> <span class="free">rels</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Regex.eps <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lε_strict <span class="free">n</span> <span class="free">rels</span> <span class="free">mr</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">hypsubst</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">induct</span> <span class="quoted">Futu</span> <span class="quoted">Strict</span> <span class="quoted"><span class="quoted">"from_mregex <span class="free">mr</span> <span class="free">φs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mr</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> safe_regex_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Skip <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mr</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qtable_empty_iff qtable_unit_table <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Test <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mr</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_conv_all_nth qtable_empty_unit_table
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_nonempty_empty_table <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mr</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> qtable_union <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>TimesF <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mr</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> qtable_ε_lax<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mr</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qtable_unit_table <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rtranclp_False<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> False<span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">=</span> <span class="main">(=)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> False<span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup><span class="hidden">⇧</span><sup>*</sup></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">⟹</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtranclp.induct<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">ok_rctxt</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">φs</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ok_rctxt</span> <span class="free">φs</span> id id"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ok_rctxt</span> <span class="free">φs</span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="free"><span class="bound"><span class="entity">κ'</span></span></span> <span class="main">⟹</span> <span class="free">ok_rctxt</span> <span class="free">φs</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="main">(</span>MTimes <span class="free"><span class="bound"><span class="entity">mr</span></span></span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">κ'</span></span></span> <span class="main">(</span>Regex.Times <span class="main">(</span>from_mregex <span class="free"><span class="bound"><span class="entity">mr</span></span></span> <span class="free">φs</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ok_rctxt_swap<span class="main">:</span> <span class="quoted"><span class="quoted">"ok_rctxt <span class="free">φs</span> <span class="free">κ</span> <span class="free">κ'</span> <span class="main">⟹</span> from_mregex <span class="main">(</span><span class="free">κ</span> <span class="free">mr</span><span class="main">)</span> <span class="free">φs</span> <span class="main">=</span> <span class="free">κ'</span> <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">κ</span></span> <span class="quoted"><span class="free">κ'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mr</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ok_rctxt.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ok_rctxt_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"ok_rctxt <span class="free">φs</span> <span class="free">κ</span> <span class="free">κ'</span> <span class="main">⟹</span> Regex.match <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> Regex.match <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span>
  Regex.match <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">κ'</span> <span class="free">r</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> Regex.match <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">κ'</span> <span class="free">s</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">κ</span></span> <span class="quoted"><span class="free">κ'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ok_rctxt.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> qtable_rδκ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span>length <span class="free">φs</span><span class="main">)</span> <span class="free">mr</span>"</span></span> <span class="quoted"><span class="quoted">"fv_regex <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="bound">rel</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>Formula.fv <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">j</span> <span class="bound">φ</span><span class="main">)</span> <span class="bound">rel</span><span class="main">)</span> <span class="free">φs</span> <span class="free">rels</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ok_rctxt <span class="free">φs</span> <span class="free">κ</span> <span class="free">κ'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ms</span> <span class="main">∈</span> <span class="free">κ</span> <span class="main">`</span> RPD <span class="free">mr</span><span class="main">.</span> qtable <span class="free">n</span> <span class="free">A</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span>from_mregex <span class="bound">ms</span> <span class="free">φs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lookup <span class="free">rel</span> <span class="bound">ms</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s</span> <span class="main">∈</span> Regex.rpdκ <span class="free">κ'</span> <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span> <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>
  <span class="main">(</span>rδ <span class="free">κ</span> <span class="free">rel</span> <span class="free">rels</span> <span class="free">mr</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">mr</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">κ</span></span> <span class="quoted"><span class="free">κ'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> MSkip
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rtranclp_False ok_rctxt_swap qtable_empty_iff
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ ok_rctxt_cong<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="skolem">κ</span></span> <span class="quoted"><span class="skolem">κ'</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MPlus <span class="skolem">mr1</span> <span class="skolem">mr2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MPlus<span class="main">(</span>3-7<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_union<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MPlus<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MTimes <span class="skolem">mr1</span> <span class="skolem">mr2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MTimes<span class="main">(</span>3-7<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_union<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MTimes<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> qtable_ε_lax<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> _ _ _ MTimes<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ok_rctxt.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MTimesL_def Ball_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MStar <span class="skolem">mr</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MStar<span class="main">(</span>2-6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MStar<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ok_rctxt.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MTimesL_def Ball_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qtable_empty_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> qtable_rδ <span class="main">=</span> qtable_rδκ<span class="main">[</span><span class="operator">OF</span> _ _ _ ok_rctxt.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">unfolded</span> rpdκ_rpd image_id id_apply<span class="main">]</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">ok_lctxt</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">φs</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ok_lctxt</span> <span class="free">φs</span> id id"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ok_lctxt</span> <span class="free">φs</span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="free"><span class="bound"><span class="entity">κ'</span></span></span> <span class="main">⟹</span> <span class="free">ok_lctxt</span> <span class="free">φs</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">κ</span></span></span> <span class="main">(</span>MTimes <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">mr</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">κ'</span></span></span> <span class="main">(</span>Regex.Times <span class="bound">t</span> <span class="main">(</span>from_mregex <span class="free"><span class="bound"><span class="entity">mr</span></span></span> <span class="free">φs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ok_lctxt_swap<span class="main">:</span> <span class="quoted"><span class="quoted">"ok_lctxt <span class="free">φs</span> <span class="free">κ</span> <span class="free">κ'</span> <span class="main">⟹</span> from_mregex <span class="main">(</span><span class="free">κ</span> <span class="free">mr</span><span class="main">)</span> <span class="free">φs</span> <span class="main">=</span> <span class="free">κ'</span> <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">κ</span></span> <span class="quoted"><span class="free">κ'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mr</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ok_lctxt.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ok_lctxt_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"ok_lctxt <span class="free">φs</span> <span class="free">κ</span> <span class="free">κ'</span> <span class="main">⟹</span> Regex.match <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> Regex.match <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span>
  Regex.match <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">κ'</span> <span class="free">r</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> Regex.match <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">κ'</span> <span class="free">s</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">κ</span></span> <span class="quoted"><span class="free">κ'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ok_lctxt.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> qtable_lδκ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span>length <span class="free">φs</span><span class="main">)</span> <span class="free">mr</span>"</span></span> <span class="quoted"><span class="quoted">"fv_regex <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="bound">rel</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>Formula.fv <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">j</span> <span class="bound">φ</span><span class="main">)</span> <span class="bound">rel</span><span class="main">)</span> <span class="free">φs</span> <span class="free">rels</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ok_lctxt <span class="free">φs</span> <span class="free">κ</span> <span class="free">κ'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ms</span> <span class="main">∈</span> <span class="free">κ</span> <span class="main">`</span> LPD <span class="free">mr</span><span class="main">.</span> qtable <span class="free">n</span> <span class="free">A</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span>from_mregex <span class="bound">ms</span> <span class="free">φs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lookup <span class="free">rel</span> <span class="bound">ms</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s</span> <span class="main">∈</span> Regex.lpdκ <span class="free">κ'</span> <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span> <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>
  <span class="main">(</span>lδ <span class="free">κ</span> <span class="free">rel</span> <span class="free">rels</span> <span class="free">mr</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">mr</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">κ</span></span> <span class="quoted"><span class="free">κ'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> MSkip
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rtranclp_False ok_lctxt_swap qtable_empty_iff
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ ok_rctxt_cong<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="skolem">κ</span></span> <span class="quoted"><span class="skolem">κ'</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MPlus <span class="skolem">mr1</span> <span class="skolem">mr2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MPlus<span class="main">(</span>3-7<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_union<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MPlus<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MTimes <span class="skolem">mr1</span> <span class="skolem">mr2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MTimes<span class="main">(</span>3-7<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_union<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MTimes<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> qtable_ε_lax<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> _ _ _ MTimes<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ok_lctxt.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MTimesR_def Ball_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MStar <span class="skolem">mr</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MStar<span class="main">(</span>2-6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MStar<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ok_lctxt.intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MTimesR_def Ball_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qtable_empty_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> qtable_lδ <span class="main">=</span> qtable_lδκ<span class="main">[</span><span class="operator">OF</span> _ _ _ ok_lctxt.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">unfolded</span> lpdκ_lpd image_id id_apply<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> RPD_fv_regex_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ms</span> <span class="main">∈</span> RPD <span class="free">mr</span> <span class="main">⟹</span> fv_regex <span class="main">(</span>from_mregex <span class="free">ms</span> <span class="free">φs</span><span class="main">)</span> <span class="main">⊆</span> fv_regex <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">mr</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ms</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MTimesL_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> RPD_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex Past <span class="free">g</span> <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">ms</span> <span class="main">∈</span> RPD <span class="free">mr</span> <span class="main">⟹</span> safe_regex Past <span class="free">g</span> <span class="main">(</span>from_mregex <span class="free">ms</span> <span class="free">φs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted">Past</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="quoted">"from_mregex <span class="free">mr</span> <span class="free">φs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mr</span></span> <span class="quoted"><span class="free">ms</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> safe_regex_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Skip
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mr</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Test <span class="skolem">g</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mr</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">g</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">mrs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mrs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MPlus <span class="skolem">mr</span> <span class="skolem">ms</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Plus<span class="main">(</span>3-5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Plus<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>TimesP <span class="skolem">g</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">mrs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mrs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MTimes <span class="skolem">mr</span> <span class="skolem">ms</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> TimesP<span class="main">(</span>3-5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">g</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MTimesL_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> RPD_fv_regex_le TimesP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Star <span class="skolem">g</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mr</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MStar <span class="skolem">x6</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Star<span class="main">(</span>2-4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">g</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MTimesL_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> RPD_fv_regex_le
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> safe_cosafe<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Star<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> RPDi_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex Past <span class="free">g</span> <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">ms</span> <span class="main">∈</span> RPDi <span class="free">n</span> <span class="free">mr</span> <span class="main">==&gt;</span> safe_regex Past <span class="free">g</span> <span class="main">(</span>from_mregex <span class="free">ms</span> <span class="free">φs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ms</span></span> <span class="quoted"><span class="free">mr</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> RPD_safe<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> RPDs_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex Past <span class="free">g</span> <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">ms</span> <span class="main">∈</span> RPDs <span class="free">mr</span> <span class="main">==&gt;</span> safe_regex Past <span class="free">g</span> <span class="main">(</span>from_mregex <span class="free">ms</span> <span class="free">φs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RPDs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> RPDi_safe<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> RPD_safe_fv_regex<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex Past Strict <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">ms</span> <span class="main">∈</span> RPD <span class="free">mr</span> <span class="main">⟹</span> fv_regex <span class="main">(</span>from_mregex <span class="free">ms</span> <span class="free">φs</span><span class="main">)</span> <span class="main">=</span> fv_regex <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted">Past</span> <span class="quoted">Strict</span> <span class="quoted"><span class="quoted">"from_mregex <span class="free">mr</span> <span class="free">φs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mr</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> safe_regex_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Skip <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mr</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Test <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mr</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mr</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>TimesP <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mr</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MTimesL_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> RPD_fv_regex_le <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> modality.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mr</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MTimesL_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> RPD_fv_regex_le<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> RPDi_safe_fv_regex<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex Past Strict <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">ms</span> <span class="main">∈</span> RPDi <span class="free">n</span> <span class="free">mr</span> <span class="main">==&gt;</span> fv_regex <span class="main">(</span>from_mregex <span class="free">ms</span> <span class="free">φs</span><span class="main">)</span> <span class="main">=</span> fv_regex <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ms</span></span> <span class="quoted"><span class="free">mr</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 5 0 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> RPD_safe_fv_regex RPD_safe<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> RPDs_safe_fv_regex<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex Past Strict <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">ms</span> <span class="main">∈</span> RPDs <span class="free">mr</span> <span class="main">==&gt;</span> fv_regex <span class="main">(</span>from_mregex <span class="free">ms</span> <span class="free">φs</span><span class="main">)</span> <span class="main">=</span> fv_regex <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RPDs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> RPDi_safe_fv_regex<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> RPD_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"ok <span class="free">m</span> <span class="free">mr</span> <span class="main">⟹</span> <span class="free">ms</span> <span class="main">∈</span> RPD <span class="free">mr</span> <span class="main">⟹</span> ok <span class="free">m</span> <span class="free">ms</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">mr</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ms</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MPlus <span class="skolem">mr1</span> <span class="skolem">mr2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MPlus<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> MPlus<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MTimes <span class="skolem">mr1</span> <span class="skolem">mr2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MTimes<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> MTimes<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MTimesL_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MStar <span class="skolem">mr</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MStar<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> MStar<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MTimesL_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> RPDi_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"ok <span class="free">m</span> <span class="free">mr</span> <span class="main">⟹</span> <span class="free">ms</span> <span class="main">∈</span> RPDi <span class="free">n</span> <span class="free">mr</span> <span class="main">⟹</span> ok <span class="free">m</span> <span class="free">ms</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ms</span></span> <span class="quoted"><span class="free">mr</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> RPD_ok<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> RPDs_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"ok <span class="free">m</span> <span class="free">mr</span> <span class="main">⟹</span> <span class="free">ms</span> <span class="main">∈</span> RPDs <span class="free">mr</span> <span class="main">⟹</span> ok <span class="free">m</span> <span class="free">ms</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RPDs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> RPDi_ok<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LPD_fv_regex_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ms</span> <span class="main">∈</span> LPD <span class="free">mr</span> <span class="main">⟹</span> fv_regex <span class="main">(</span>from_mregex <span class="free">ms</span> <span class="free">φs</span><span class="main">)</span> <span class="main">⊆</span> fv_regex <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">mr</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ms</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MTimesR_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LPD_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex Futu <span class="free">g</span> <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">ms</span> <span class="main">∈</span> LPD <span class="free">mr</span> <span class="main">==&gt;</span> safe_regex Futu <span class="free">g</span> <span class="main">(</span>from_mregex <span class="free">ms</span> <span class="free">φs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted">Futu</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="quoted">"from_mregex <span class="free">mr</span> <span class="free">φs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mr</span></span> <span class="quoted"><span class="free">ms</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> safe_regex_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Skip
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mr</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Test <span class="skolem">g</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mr</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">g</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">mrs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mrs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MPlus <span class="skolem">mr</span> <span class="skolem">ms</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Plus<span class="main">(</span>3-5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Plus<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>TimesF <span class="skolem">g</span> <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">mrs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mrs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MTimes <span class="skolem">mr</span> <span class="skolem">ms</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> TimesF<span class="main">(</span>3-5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">g</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MTimesR_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> LPD_fv_regex_le <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> modality.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> TimesF<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Star <span class="skolem">g</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mr</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MStar <span class="skolem">x6</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Star<span class="main">(</span>2-4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">g</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MTimesR_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> LPD_fv_regex_le
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> safe_cosafe<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Star<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LPDi_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex Futu <span class="free">g</span> <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">ms</span> <span class="main">∈</span> LPDi <span class="free">n</span> <span class="free">mr</span> <span class="main">==&gt;</span> safe_regex Futu <span class="free">g</span> <span class="main">(</span>from_mregex <span class="free">ms</span> <span class="free">φs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ms</span></span> <span class="quoted"><span class="free">mr</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> LPD_safe<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LPDs_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex Futu <span class="free">g</span> <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">ms</span> <span class="main">∈</span> LPDs <span class="free">mr</span> <span class="main">==&gt;</span> safe_regex Futu <span class="free">g</span> <span class="main">(</span>from_mregex <span class="free">ms</span> <span class="free">φs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> LPDs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> LPDi_safe<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LPD_safe_fv_regex<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex Futu Strict <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">ms</span> <span class="main">∈</span> LPD <span class="free">mr</span> <span class="main">==&gt;</span> fv_regex <span class="main">(</span>from_mregex <span class="free">ms</span> <span class="free">φs</span><span class="main">)</span> <span class="main">=</span> fv_regex <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted">Futu</span> <span class="quoted">Strict</span> <span class="quoted"><span class="quoted">"from_mregex <span class="free">mr</span> <span class="free">φs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">mr</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> safe_regex_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Skip
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mr</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Test <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mr</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mr</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>TimesF <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mr</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MTimesR_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> LPD_fv_regex_le <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> modality.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">mr</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MTimesR_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> LPD_fv_regex_le<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LPDi_safe_fv_regex<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex Futu Strict <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">ms</span> <span class="main">∈</span> LPDi <span class="free">n</span> <span class="free">mr</span> <span class="main">==&gt;</span> fv_regex <span class="main">(</span>from_mregex <span class="free">ms</span> <span class="free">φs</span><span class="main">)</span> <span class="main">=</span> fv_regex <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ms</span></span> <span class="quoted"><span class="free">mr</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 5 0 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> LPD_safe_fv_regex LPD_safe<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LPDs_safe_fv_regex<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex Futu Strict <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">ms</span> <span class="main">∈</span> LPDs <span class="free">mr</span> <span class="main">==&gt;</span> fv_regex <span class="main">(</span>from_mregex <span class="free">ms</span> <span class="free">φs</span><span class="main">)</span> <span class="main">=</span> fv_regex <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="free">φs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> LPDs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> LPDi_safe_fv_regex<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LPD_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"ok <span class="free">m</span> <span class="free">mr</span> <span class="main">⟹</span> <span class="free">ms</span> <span class="main">∈</span> LPD <span class="free">mr</span> <span class="main">⟹</span> ok <span class="free">m</span> <span class="free">ms</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">mr</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ms</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MPlus <span class="skolem">mr1</span> <span class="skolem">mr2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MPlus<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> MPlus<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MTimes <span class="skolem">mr1</span> <span class="skolem">mr2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MTimes<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> MTimes<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MTimesR_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MStar <span class="skolem">mr</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MStar<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> MStar<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MTimesR_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LPDi_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"ok <span class="free">m</span> <span class="free">mr</span> <span class="main">⟹</span> <span class="free">ms</span> <span class="main">∈</span> LPDi <span class="free">n</span> <span class="free">mr</span> <span class="main">⟹</span> ok <span class="free">m</span> <span class="free">ms</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ms</span></span> <span class="quoted"><span class="free">mr</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> LPD_ok<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> LPDs_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"ok <span class="free">m</span> <span class="free">mr</span> <span class="main">⟹</span> <span class="free">ms</span> <span class="main">∈</span> LPDs <span class="free">mr</span> <span class="main">⟹</span> ok <span class="free">m</span> <span class="free">ms</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> LPDs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> LPDi_ok<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> update_matchP<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_matchP_aux <span class="free">σ</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">I</span> <span class="free">r</span> <span class="free">aux</span> <span class="free">ne</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> safe<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex Past Strict <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mr<span class="main">:</span> <span class="quoted"><span class="quoted">"to_mregex <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">mr</span><span class="main">,</span> <span class="free">φs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mrs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mrs</span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span>RPDs <span class="free">mr</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> qtables<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="bound">rel</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>Formula.fv <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="bound">φ</span><span class="main">)</span> <span class="bound">rel</span><span class="main">)</span> <span class="free">φs</span> <span class="free">rels</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> result_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">rel</span><span class="main">,</span> <span class="free">aux'</span><span class="main">)</span> <span class="main">=</span> update_matchP <span class="free">n</span> <span class="free">I</span> <span class="free">mr</span> <span class="free">mrs</span> <span class="free">rels</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span><span class="main">)</span> <span class="free">aux</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_matchP_aux <span class="free">σ</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">I</span> <span class="free">r</span> <span class="free">aux'</span> <span class="main">(</span>Suc <span class="free">ne</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>Formula.fv_regex <span class="free">r</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="main">(</span>Formula.MatchP <span class="free">I</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">rel</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?wf_tuple</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">v</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="main">(</span>Formula.fv_regex <span class="free">r</span><span class="main">)</span> <span class="bound">v</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?update</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">rel</span> <span class="bound">t</span><span class="main">.</span> mrtabulate <span class="free">mrs</span> <span class="main">(</span><span class="main">λ</span><span class="bound">mr</span><span class="main">.</span>
    rδ id <span class="bound">rel</span> <span class="free">rels</span> <span class="bound">mr</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">ne</span> <span class="keyword1">then</span> rε_strict <span class="free">n</span> <span class="free">rels</span> <span class="bound">mr</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> sat.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">aux0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aux0</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="var">?update</span> <span class="bound">rel</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>t<span class="main">,</span> rel<span class="main">)</span> <span class="main">←</span> <span class="free">aux</span><span class="main">,</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> sorted_aux0<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">&gt;</span> fst <span class="bound">y</span><span class="main">)</span> <span class="skolem">aux0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pre<span class="main">[</span><span class="operator">unfolded</span> wf_matchP_aux_def<span class="main">,</span> <span class="operator">THEN</span> conjunct1<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> aux0_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">aux</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_wrt_append<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ms</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ms</span> <span class="main">∈</span> RPDs <span class="free">mr</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv_regex <span class="main">(</span>from_mregex <span class="skolem">ms</span> <span class="free">φs</span><span class="main">)</span> <span class="main">=</span> fv_regex <span class="free">r</span>"</span></span>
      <span class="quoted"><span class="quoted">"safe_regex Past Strict <span class="main">(</span>from_mregex <span class="skolem">ms</span> <span class="free">φs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span>length <span class="free">φs</span><span class="main">)</span> <span class="skolem">ms</span>"</span></span> <span class="quoted"><span class="quoted">"RPD <span class="skolem">ms</span> <span class="main">⊆</span> RPDs <span class="free">mr</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> safe RPDs_safe RPDs_safe_fv_regex mr from_mregex_to_mregex RPDs_ok to_mregex_ok RPDs_trans
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">i</span> <span class="main">+</span> τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Nat.diff_diff_right τ_mono add.commute add_diff_cancel_left diff_le_self le_add2 order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ***<span class="main">:</span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">i</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span>  <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">i</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Suc_pred τ_mono diff_le_self le_τ_less le_antisym not_less_eq that<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> in_aux0_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">aux0</span> <span class="main">⟹</span> <span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">∧</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">ms</span><span class="main">∈</span>RPDs <span class="free">mr</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>fv_regex <span class="free">r</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span>
         <span class="main">(</span>Formula.MatchP <span class="main">(</span>point <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>from_mregex <span class="bound">ms</span> <span class="free">φs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lookup <span class="skolem">X</span> <span class="bound">ms</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="skolem">X</span>
    <span class="keyword1"><span class="command">unfolding</span></span> aux0_def <span class="keyword1"><span class="command">using</span></span> safe mr mrs
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lookup_tabulate map_of_map_restrict restrict_map_def finite_RPDs * ** RPDs_trans diff_le_mono2
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sat_MatchP_rec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">ne</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span>
        qtable_union<span class="main"><span class="main">[</span></span><span class="operator">OF</span> qtable_rδ<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> _ _ qtables<span class="main"><span class="main"><span class="main">]</span></span></span> qtable_rε_strict<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> _ _ _ qtables<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span>
          <span class="operator">of</span> <span class="quoted"><span class="skolem">ms</span></span> <span class="quoted"><span class="quoted">"fv_regex <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">v</span> <span class="bound">r</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="bound">v</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Formula.MatchP <span class="main">(</span>point <span class="main">0</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>"</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">ms</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">ms</span><span class="main"><span class="main">]</span></span>
        qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> qtable_rδ<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> _ _ qtables<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span>
          <span class="operator">of</span> <span class="quoted"><span class="skolem">ms</span></span> <span class="quoted"><span class="quoted">"fv_regex <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">v</span> <span class="bound">r</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="bound">v</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Formula.MatchP <span class="main">(</span>point <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
          <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="main">(</span>Formula.MatchP <span class="main">(</span>point <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>  <span class="main">(</span>from_mregex <span class="skolem">ms</span> <span class="free">φs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">ms</span> <span class="skolem">i</span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> wf_matchP_aux_def<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct2<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct1<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span>
        sat_MatchP_rec<span class="main"><span class="main">[</span></span><span class="quoted"><span class="operator">"of"</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">ne</span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bspec order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ τ_mono<span class="main"><span class="main">]</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span> <span class="comment1">(* slow 7 sec *)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> in_aux0_le_τ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">aux0</span> <span class="main">⟹</span> <span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="skolem">X</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> τ_mono diff_le_self le_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> in_aux0_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">⟹</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">aux0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">aux</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> wf_matchP_aux_def<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct2<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct2<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gr0_conv_Suc <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> diff_le_mono τ_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="var">?update</span> <span class="skolem">X</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">aux0</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> aux0_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> id_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">X</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">aux0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> aux0_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">aux0</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">ne</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">∧</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∄</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> in_aux0_2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> aux'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">aux'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">aux0</span> <span class="keyword1">of</span>
      <span class="main">[]</span> <span class="main">⇒</span> <span class="main">[</span><span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span><span class="main">,</span> mrtabulate <span class="free">mrs</span> <span class="main">(</span>rε_strict <span class="free">n</span> <span class="free">rels</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>
    <span class="main">|</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">aux'</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> fst <span class="bound">x</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">ne</span> <span class="keyword1">then</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">aux'</span>
       <span class="keyword1">else</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span><span class="main">,</span> mrtabulate <span class="free">mrs</span> <span class="main">(</span>rε_strict <span class="free">n</span> <span class="free">rels</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">aux'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> result_eq <span class="keyword1"><span class="command">unfolding</span></span> aux0_def update_matchP_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> sorted_aux'<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">&gt;</span> fst <span class="bound">y</span><span class="main">)</span> <span class="free">aux'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq
    <span class="keyword1"><span class="command">using</span></span> sorted_aux0 in_aux0_le_τ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">aux0</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> in_aux'_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">∧</span> memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">ms</span><span class="main">∈</span>RPDs <span class="free">mr</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>Formula.fv_regex <span class="free">r</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span>
        Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="main">(</span>Formula.MatchP <span class="main">(</span>point <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>from_mregex <span class="bound">ms</span> <span class="free">φs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lookup <span class="skolem">X</span> <span class="bound">ms</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> aux'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">aux'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="skolem">X</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">aux0</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">with</span></span> aux' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq <span class="keyword1"><span class="command">using</span></span> safe mrs qtables aux0_Nil *
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_enat_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> sat_MatchP_rec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">ne</span></span><span class="main"><span class="main">]</span></span>
          lookup_tabulate finite_RPDs <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> qtable_rε_strict<span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> t<span class="main">:</span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> aux' Cons t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> snd <span class="skolem">a</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq <span class="keyword1"><span class="command">using</span></span> sorted_aux0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> in_aux0_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">a</span>"</span></span><span class="main">]</span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
          <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> fst <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> fst <span class="skolem">a</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ms</span> <span class="main">∈</span> RPDs <span class="free">mr</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>fv_regex <span class="free">r</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span>
            <span class="main">(</span>Formula.MatchP <span class="main">(</span>point <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> fst <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>from_mregex <span class="bound">ms</span> <span class="free">φs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lookup <span class="main">(</span>snd <span class="skolem">a</span><span class="main">)</span> <span class="bound">ms</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> t True
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> aux' Cons t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> mrtabulate <span class="free">mrs</span> <span class="main">(</span>rε_strict <span class="free">n</span> <span class="free">rels</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq <span class="keyword1"><span class="command">using</span></span> sorted_aux0 in_aux0_le_τ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">a</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> aux' Cons t False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq <span class="keyword1"><span class="command">using</span></span> safe mrs qtables * in_aux0_2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span><span class="main">]</span> in_aux0_le_τ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">a</span>"</span></span><span class="main">]</span> sorted_aux0
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sat_MatchP_rec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">ne</span></span><span class="main"><span class="main">]</span></span> zero_enat_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> enat_0_iff not_le
              lookup_tabulate finite_RPDs <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits
              <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> qtable_rε_strict<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_τ_less meta_mp<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> aux' Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">aux0</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ms</span> <span class="main">∈</span> RPDs <span class="free">mr</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>fv_regex <span class="free">r</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span>
          <span class="main">(</span>Formula.MatchP <span class="main">(</span>point <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>from_mregex <span class="bound">ms</span> <span class="free">φs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lookup <span class="skolem">X</span> <span class="bound">ms</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> in_aux0_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">with</span></span> False aux' Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> in_aux'_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">aux'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span> <span class="quoted"><span class="quoted">"memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">aux0</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq <span class="keyword1"><span class="command">using</span></span> eq_fst_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> le_τ_less neq0_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> False that <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_leI Suc_pred τ_mono diff_is_0_eq' order.antisym neq0_conv not_le<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">aux0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹memR <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_aux0_2<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq <span class="keyword1"><span class="command">using</span></span> False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">X</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.split<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_matchP_aux <span class="free">σ</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">I</span> <span class="free">r</span> <span class="free">aux'</span> <span class="main">(</span>Suc <span class="free">ne</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wf_matchP_aux_def <span class="keyword1"><span class="command">using</span></span> mr
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_aux'_1 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sorted_aux' in_aux'_2<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> rel_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rel</span> <span class="main">=</span> foldr <span class="main">(∪)</span> <span class="main">[</span>lookup <span class="bound">rel</span> <span class="free">mr</span><span class="main">.</span> <span class="main">(</span>t<span class="main">,</span> rel<span class="main">)</span> <span class="main">←</span> <span class="free">aux'</span><span class="main">,</span> memL <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">]</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq aux0_def
    <span class="keyword1"><span class="command">using</span></span> result_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> update_matchP_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> rel_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rel</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">rel</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">aux'</span><span class="main">.</span> <span class="keyword1">if</span> memL <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="keyword1">then</span> lookup <span class="bound">rel</span> <span class="free">mr</span> <span class="keyword1">else</span> empty_table<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rel_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_foldr_UnE bexI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_foldr_UnI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>fv_regex <span class="free">r</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="main">(</span>Formula.MatchP <span class="free">I</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="free">rel</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rel_alt
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> qtable_Union<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Qi<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="bound">v</span><span class="main">.</span>
    memL <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="main">(</span>Formula.MatchP <span class="main">(</span>point <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">goal_cases</span> finite qtable equiv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>equiv <span class="skolem">v</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> sat_MatchP_point<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> left right<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>left <span class="skolem">j</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> in_aux'_2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">j</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> _ _ exI<span class="main">,</span> <span class="operator">OF</span> _ _ refl<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> right
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sat_MatchP_pointD <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_aux'_1<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_aux'_1 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_empty <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bspec<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ RPDs_refl<span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> from_mregex_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> safe mr<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> length_update_until<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>update_until <span class="free">args</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="free">nt</span> <span class="free">aux</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="free">aux</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> update_until_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_update_until_auxlist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_until_auxlist <span class="free">σ</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="free">auxlist</span> <span class="free">ne</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> qtable1<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>Formula.fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free">ne</span> <span class="main">+</span> length <span class="free">auxlist</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span> <span class="free">rel1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> qtable2<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>Formula.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free">ne</span> <span class="main">+</span> length <span class="free">auxlist</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">rel2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fvi_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.fv <span class="free">φ</span> <span class="main">⊆</span> Formula.fv <span class="free">ψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_ivl<span class="main">:</span> <span class="quoted"><span class="quoted">"args_ivl <span class="free">args</span> <span class="main">=</span> <span class="free">I</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_n<span class="main">:</span> <span class="quoted"><span class="quoted">"args_n <span class="free">args</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"args_pos <span class="free">args</span> <span class="main">=</span> <span class="free">pos</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_until_auxlist <span class="free">σ</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="main">(</span>update_until <span class="free">args</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">+</span> length <span class="free">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist</span><span class="main">)</span> <span class="free">ne</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_until_auxlist_def length_update_until
  <span class="keyword1"><span class="command">unfolding</span></span> update_until_def list.rel_map add_Suc_right upt.simps eqTrueI<span class="main">[</span><span class="operator">OF</span> le_add1<span class="main">]</span> if_True
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> list_all2_appendI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> list.rel_map<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> old new<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> old
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> list.rel_mono_strong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> wf_until_auxlist_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> mono1 mono2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mono1 <span class="skolem">i</span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">v</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> args_ivl args_n args_pos sat_the_restrict less_Suc_eq
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_join<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ qtable1<span class="main"><span class="main">]</span></span> qtable_union<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ qtable1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mono2 <span class="skolem">i</span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">v</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvi_subset
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> args_ivl args_n args_pos sat_the_restrict less_Suc_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_union<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ qtable_join_fixed<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> qtable2<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ refl<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">+</span> length <span class="free">auxlist</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="comment1">(* slow 8 sec*)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> new
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_empty qtable1 qtable2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> qtable_cong<span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">+</span> length <span class="free">auxlist</span>"</span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> args_ivl args_n args_pos less_Suc_eq zero_enat_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> muaux<span class="main">)</span> wf_update_until<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_until_aux <span class="free">σ</span> <span class="free">V</span> <span class="free">R</span> <span class="free">args</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="free">aux</span> <span class="free">ne</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> qtable1<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>Formula.fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free">ne</span> <span class="main">+</span> <span class="free">length_muaux</span> <span class="free">args</span> <span class="free">aux</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span> <span class="free">rel1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> qtable2<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>Formula.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free">ne</span> <span class="main">+</span> <span class="free">length_muaux</span> <span class="free">args</span> <span class="free">aux</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">rel2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fvi_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.fv <span class="free">φ</span> <span class="main">⊆</span> Formula.fv <span class="free">ψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_ivl<span class="main">:</span> <span class="quoted"><span class="quoted">"args_ivl <span class="free">args</span> <span class="main">=</span> <span class="free">I</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_n<span class="main">:</span> <span class="quoted"><span class="quoted">"args_n <span class="free">args</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_L<span class="main">:</span> <span class="quoted"><span class="quoted">"args_L <span class="free">args</span> <span class="main">=</span> Formula.fv <span class="free">φ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_R<span class="main">:</span> <span class="quoted"><span class="quoted">"args_R <span class="free">args</span> <span class="main">=</span> Formula.fv <span class="free">ψ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"args_pos <span class="free">args</span> <span class="main">=</span> <span class="free">pos</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_until_aux <span class="free">σ</span> <span class="free">V</span> <span class="free">R</span> <span class="free">args</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="main">(</span><span class="free">add_new_muaux</span> <span class="free">args</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">+</span> <span class="free">length_muaux</span> <span class="free">args</span> <span class="free">aux</span><span class="main">)</span><span class="main">)</span> <span class="free">aux</span><span class="main">)</span> <span class="free">ne</span> <span class="main">∧</span>
      <span class="free">length_muaux</span> <span class="free">args</span> <span class="main">(</span><span class="free">add_new_muaux</span> <span class="free">args</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">+</span> <span class="free">length_muaux</span> <span class="free">args</span> <span class="free">aux</span><span class="main">)</span><span class="main">)</span> <span class="free">aux</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">length_muaux</span> <span class="free">args</span> <span class="free">aux</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> pre <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cur</span></span> <span class="skolem"><span class="skolem">auxlist</span></span> <span class="keyword2"><span class="keyword">where</span></span> valid_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">valid_muaux</span> <span class="free">args</span> <span class="skolem">cur</span> <span class="free">aux</span> <span class="skolem">auxlist</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    cur<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cur</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">ne</span> <span class="main">+</span> length <span class="skolem">auxlist</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">+</span> length <span class="skolem">auxlist</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    pre_list<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_until_auxlist <span class="free">σ</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="skolem">auxlist</span> <span class="free">ne</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wf_until_aux_def args_ivl args_n args_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> length_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">length_muaux</span> <span class="free">args</span> <span class="free">aux</span> <span class="main">=</span> length <span class="skolem">auxlist</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_length_muaux<span class="main">[</span><span class="operator">OF</span> valid_aux<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">nt</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nt</span> <span class="main">≡</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">+</span> <span class="free">length_muaux</span> <span class="free">args</span> <span class="free">aux</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> nt_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cur</span> <span class="main">≤</span> <span class="skolem">nt</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cur nt_def length_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">auxlist'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">auxlist'</span> <span class="main">≡</span> update_until <span class="free">args</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">+</span> length <span class="skolem">auxlist</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> length_auxlist'<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">auxlist'</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="skolem">auxlist</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_update_until<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> tab1<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="free">rel1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> qtable1 <span class="keyword1"><span class="command">unfolding</span></span> args_n<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> args_L<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qtable_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> tab2<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="free">rel2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> qtable2 <span class="keyword1"><span class="command">unfolding</span></span> args_n<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> args_R<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qtable_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fv_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="free">φ</span> <span class="main">⊆</span> fv <span class="free">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pre <span class="keyword1"><span class="command">unfolding</span></span> wf_until_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> valid_add_new_auxlist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">valid_muaux</span> <span class="free">args</span> <span class="skolem">nt</span> <span class="main">(</span><span class="free">add_new_muaux</span> <span class="free">args</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="skolem">nt</span> <span class="free">aux</span><span class="main">)</span> <span class="skolem">auxlist'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_add_new_muaux<span class="main">[</span><span class="operator">OF</span> valid_aux tab1 tab2 nt_mono<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def nt_def length_aux <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">length_muaux</span> <span class="free">args</span> <span class="main">(</span><span class="free">add_new_muaux</span> <span class="free">args</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="skolem">nt</span> <span class="free">aux</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">length_muaux</span> <span class="free">args</span> <span class="free">aux</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_length_muaux<span class="main">[</span><span class="operator">OF</span> valid_add_new_auxlist<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> length_auxlist' length_aux<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_until_auxlist <span class="free">σ</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="skolem">auxlist'</span> <span class="free">ne</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_update_until_auxlist<span class="main">[</span><span class="operator">OF</span> pre_list qtable1<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> length_aux<span class="main"><span class="main">]</span></span> qtable2<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> length_aux<span class="main"><span class="main">]</span></span> fv_sub args_ivl args_n args_pos<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">+</span> length <span class="skolem">auxlist</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">ne</span> <span class="main">+</span> length <span class="skolem">auxlist'</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">+</span> length <span class="skolem">auxlist'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> cur length_auxlist' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wf_until_aux_def nt_def length_aux args_ivl args_n args_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> length_update_matchF_base<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="main">(</span>update_matchF_base <span class="free">I</span> <span class="free">mr</span> <span class="free">mrs</span> <span class="free">nt</span> <span class="free">entry</span> <span class="free">st</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def update_matchF_base_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> length_update_matchF_step<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="main">(</span>update_matchF_step <span class="free">I</span> <span class="free">mr</span> <span class="free">mrs</span> <span class="free">nt</span> <span class="free">entry</span> <span class="free">st</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="main">(</span>fst <span class="free">st</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def update_matchF_step_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> length_foldr_update_matchF_step<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="main">(</span>foldr <span class="main">(</span>update_matchF_step <span class="free">I</span> <span class="free">mr</span> <span class="free">mrs</span> <span class="free">nt</span><span class="main">)</span> <span class="free">aux</span> <span class="free">base</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="free">aux</span> <span class="main">+</span> length <span class="main">(</span>fst <span class="free">base</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">aux</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">base</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def length_update_matchF_step<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> length_update_matchF<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>update_matchF <span class="free">n</span> <span class="free">I</span> <span class="free">mr</span> <span class="free">mrs</span> <span class="free">rels</span> <span class="free">nt</span> <span class="free">aux</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="free">aux</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> update_matchF_def update_matchF_base_def length_foldr_update_matchF_step
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_update_matchF_base_invar<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> safe<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex Futu Strict <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mr<span class="main">:</span> <span class="quoted"><span class="quoted">"to_mregex <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">mr</span><span class="main">,</span> <span class="free">φs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mrs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mrs</span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span>LPDs <span class="free">mr</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> qtables<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="bound">rel</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>Formula.fv <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">j</span> <span class="bound">φ</span><span class="main">)</span> <span class="bound">rel</span><span class="main">)</span> <span class="free">φs</span> <span class="free">rels</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_matchF_invar <span class="free">σ</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">I</span> <span class="free">r</span> <span class="main">(</span>update_matchF_base <span class="free">n</span> <span class="free">I</span> <span class="free">mr</span> <span class="free">mrs</span> <span class="free">rels</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> from_mregex<span class="main">:</span> <span class="quoted"><span class="quoted">"from_mregex <span class="free">mr</span> <span class="free">φs</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> safe mr <span class="keyword1"><span class="command">using</span></span> from_mregex_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ms</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ms</span> <span class="main">∈</span> LPDs <span class="free">mr</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv_regex <span class="main">(</span>from_mregex <span class="skolem">ms</span> <span class="free">φs</span><span class="main">)</span> <span class="main">=</span> fv_regex <span class="free">r</span>"</span></span>
      <span class="quoted"><span class="quoted">"safe_regex Futu Strict <span class="main">(</span>from_mregex <span class="skolem">ms</span> <span class="free">φs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span>length <span class="free">φs</span><span class="main">)</span> <span class="skolem">ms</span>"</span></span> <span class="quoted"><span class="quoted">"LPD <span class="skolem">ms</span> <span class="main">⊆</span> LPDs <span class="free">mr</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> safe LPDs_safe LPDs_safe_fv_regex mr from_mregex_to_mregex LPDs_ok to_mregex_ok LPDs_trans
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wf_matchF_invar_def wf_matchF_aux_def update_matchF_base_def mr prod.case Let_def mrs
    <span class="keyword1"><span class="command">using</span></span> safe
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> * from_mregex qtables qtable_empty_iff zero_enat_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
        lookup_tabulate finite_LPDs eps_match less_Suc_eq LPDs_refl
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> qtable_lε_strict<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> φs<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="free">φs</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> qtables exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">j</span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Un_empty_table<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rel</span> <span class="main">∪</span> empty_table <span class="main">=</span> <span class="free">rel</span>"</span></span> <span class="quoted"><span class="quoted">"empty_table <span class="main">∪</span> <span class="free">rel</span> <span class="main">=</span> <span class="free">rel</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> empty_table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_matchF_invar_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_matchF_invar <span class="free">σ</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">I</span> <span class="free">r</span> <span class="free">st</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> safe<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex Futu Strict <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mr<span class="main">:</span> <span class="quoted"><span class="quoted">"to_mregex <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">mr</span><span class="main">,</span> <span class="free">φs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mrs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mrs</span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span>LPDs <span class="free">mr</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> qtables<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="bound">rel</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>Formula.fv <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">i</span> <span class="bound">φ</span><span class="main">)</span> <span class="bound">rel</span><span class="main">)</span> <span class="free">φs</span> <span class="free">rels</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> rel<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>Formula.fv_regex <span class="free">r</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>fst <span class="free">st</span><span class="main">)</span> <span class="main">∧</span> mem <span class="free">I</span> <span class="main">(</span><span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
          Regex.match <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span> <span class="free">i</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="free">rel</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> entry<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">entry</span> <span class="main">=</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span><span class="main">,</span> <span class="free">rels</span><span class="main">,</span> <span class="free">rel</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nt</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>fst <span class="free">st</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_matchF_invar <span class="free">σ</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">I</span> <span class="free">r</span> <span class="main">(</span>update_matchF_step <span class="free">I</span> <span class="free">mr</span> <span class="free">mrs</span> <span class="free">nt</span> <span class="free">entry</span> <span class="free">st</span><span class="main">)</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> from_mregex<span class="main">:</span> <span class="quoted"><span class="quoted">"from_mregex <span class="free">mr</span> <span class="free">φs</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> safe mr <span class="keyword1"><span class="command">using</span></span> from_mregex_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ms</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ms</span> <span class="main">∈</span> LPDs <span class="free">mr</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv_regex <span class="main">(</span>from_mregex <span class="skolem">ms</span> <span class="free">φs</span><span class="main">)</span> <span class="main">=</span> fv_regex <span class="free">r</span>"</span></span>
      <span class="quoted"><span class="quoted">"safe_regex Futu Strict <span class="main">(</span>from_mregex <span class="skolem">ms</span> <span class="free">φs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"ok <span class="main">(</span>length <span class="free">φs</span><span class="main">)</span> <span class="skolem">ms</span>"</span></span> <span class="quoted"><span class="quoted">"LPD <span class="skolem">ms</span> <span class="main">⊆</span> LPDs <span class="free">mr</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> safe LPDs_safe LPDs_safe_fv_regex mr from_mregex_to_mregex LPDs_ok to_mregex_ok LPDs_trans
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> * <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">aux</span> <span class="skolem">X</span> <span class="skolem">ms</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">st</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">aux</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ms</span> <span class="main">∈</span> LPDs <span class="free">mr</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> wf mr <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>fv_regex <span class="free">r</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Regex.match <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>from_mregex <span class="skolem">ms</span> <span class="free">φs</span><span class="main">)</span> <span class="free">i</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="skolem">aux</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>lδ <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">X</span> <span class="free">rels</span> <span class="skolem">ms</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> qtable_lδ<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> φs<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="free">φs</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span> A<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="quoted">"fv_regex <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span>
              Q<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">v</span> <span class="bound">r</span><span class="main">.</span> Regex.match <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="bound">v</span><span class="main">)</span> <span class="bound">r</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="skolem">aux</span><span class="main">)</span>"</span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> _ _ qtables<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_matchF_invar_def * LPDs_trans lpd_match<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bspec<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> lδ <span class="main">=</span> this
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span>mrtabulate <span class="free">mrs</span> <span class="skolem">f</span><span class="main">)</span> <span class="skolem">ms</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">ms</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ms</span> <span class="main">∈</span> LPDs <span class="free">mr</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ms</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"mregex <span class="main">⇒</span> <span class="tfree">'a</span> table"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that mrs  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lookup_tabulate finite_LPDs <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> wf mr mrs entry nt LPDs_trans
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def wf_matchF_invar_def update_matchF_step_def wf_matchF_aux_def mr * LPDs_refl
        list_all2_Cons1 append_eq_Cons_conv upt_eq_Cons_conv Suc_le_eq qtables
        lookup_tabulate finite_LPDs id_def lδ from_mregex less_Suc_eq
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_union<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rel lδ<span class="main"><span class="main">]</span></span> qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rel<span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> length <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_update_matchF_invar<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_matchF_aux <span class="free">σ</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">I</span> <span class="free">r</span> <span class="free">aux</span> <span class="free">ne</span> <span class="main">(</span>length <span class="main">(</span>fst <span class="free">st</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_matchF_invar <span class="free">σ</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">I</span> <span class="free">r</span> <span class="free">st</span> <span class="main">(</span><span class="free">ne</span> <span class="main">+</span> length <span class="free">aux</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> safe<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex Futu Strict <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mr<span class="main">:</span> <span class="quoted"><span class="quoted">"to_mregex <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">mr</span><span class="main">,</span> <span class="free">φs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mrs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mrs</span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span>LPDs <span class="free">mr</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> <span class="free">ne</span> <span class="main">+</span> length <span class="free">aux</span> <span class="main">+</span> length <span class="main">(</span>fst <span class="free">st</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_matchF_invar <span class="free">σ</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">I</span> <span class="free">r</span> <span class="main">(</span>foldr <span class="main">(</span>update_matchF_step <span class="free">I</span> <span class="free">mr</span> <span class="free">mrs</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="free">aux</span> <span class="free">st</span><span class="main">)</span> <span class="free">ne</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pre wf <span class="keyword1"><span class="command">unfolding</span></span> j
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">aux</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ne</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">entry</span> <span class="skolem">aux</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">ne</span>"</span></span><span class="main">]</span> Cons<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> foldr.simps o_apply
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> wf_matchF_invar_step<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> rels <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>snd <span class="skolem">entry</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> rel <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>snd <span class="skolem">entry</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> safe mr mrs wf_matchF_aux_def wf_matchF_invar_def list_all2_Cons1 append_eq_Cons_conv
        Suc_le_eq upt_eq_Cons_conv length_foldr_update_matchF_step add.assoc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">lemma</span></span> wf_update_matchF<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_matchF_aux <span class="free">σ</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">I</span> <span class="free">r</span> <span class="free">aux</span> <span class="free">ne</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> safe<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex Futu Strict <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mr<span class="main">:</span> <span class="quoted"><span class="quoted">"to_mregex <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">mr</span><span class="main">,</span> <span class="free">φs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mrs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mrs</span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span>LPDs <span class="free">mr</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">nt</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">+</span> length <span class="free">aux</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> qtables<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="bound">rel</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>Formula.fv <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free">ne</span> <span class="main">+</span> length <span class="free">aux</span><span class="main">)</span> <span class="bound">φ</span><span class="main">)</span> <span class="bound">rel</span><span class="main">)</span> <span class="free">φs</span> <span class="free">rels</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_matchF_aux <span class="free">σ</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">I</span> <span class="free">r</span> <span class="main">(</span>update_matchF <span class="free">n</span> <span class="free">I</span> <span class="free">mr</span> <span class="free">mrs</span> <span class="free">rels</span> <span class="free">nt</span> <span class="free">aux</span><span class="main">)</span> <span class="free">ne</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> update_matchF_def <span class="keyword1"><span class="command">using</span></span> wf_update_matchF_base_invar<span class="main">[</span><span class="operator">OF</span> safe mr mrs qtables<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">I</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> nt
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> wf_update_matchF_invar<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ safe mr mrs<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> wf_matchF_invar_def split_beta<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct2<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct1<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_update_matchF_base wf_matchF_invar_def update_matchF_base_def Let_def pre<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_until_aux_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_until_auxlist <span class="free">σ</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">aux</span><span class="main">)</span> <span class="free">ne</span> <span class="main">⟹</span>
  wf_until_auxlist <span class="free">σ</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="free">aux</span> <span class="main">(</span>Suc <span class="free">ne</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_until_auxlist_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upt_conv_Cons <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_matchF_aux_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_matchF_aux <span class="free">σ</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">I</span> <span class="free">r</span> <span class="main">(</span><span class="free">entry</span> <span class="main">#</span> <span class="free">aux</span><span class="main">)</span> <span class="free">ne</span> <span class="free">i</span> <span class="main">⟹</span>
  wf_matchF_aux <span class="free">σ</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">I</span> <span class="free">r</span> <span class="free">aux</span> <span class="main">(</span>Suc <span class="free">ne</span><span class="main">)</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_matchF_aux_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upt_conv_Cons <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_until_aux_Cons1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_until_auxlist <span class="free">σ</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="main">(</span><span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">a1</span><span class="main">,</span> <span class="free">a2</span><span class="main">)</span> <span class="main">#</span> <span class="free">aux</span><span class="main">)</span> <span class="free">ne</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_until_auxlist_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upt_conv_Cons <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_matchF_aux_Cons1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_matchF_aux <span class="free">σ</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">I</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">rels</span><span class="main">,</span> <span class="free">rel</span><span class="main">)</span> <span class="main">#</span> <span class="free">aux</span><span class="main">)</span> <span class="free">ne</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_matchF_aux_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upt_conv_Cons <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_until_aux_Cons3<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_until_auxlist <span class="free">σ</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="main">(</span><span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">a1</span><span class="main">,</span> <span class="free">a2</span><span class="main">)</span> <span class="main">#</span> <span class="free">aux</span><span class="main">)</span> <span class="free">ne</span> <span class="main">⟹</span>
  qtable <span class="free">n</span> <span class="main">(</span>Formula.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="free">ne</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> Suc <span class="main">(</span><span class="free">ne</span> <span class="main">+</span> length <span class="free">aux</span><span class="main">)</span> <span class="main">∧</span> mem <span class="free">I</span> <span class="main">(</span><span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">ne</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">j</span> <span class="free">ψ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="free">ne</span><span class="main">..&lt;</span><span class="bound">j</span><span class="main">}</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">pos</span> <span class="keyword1">then</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free">φ</span> <span class="keyword1">else</span> <span class="main">¬</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">a2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_until_auxlist_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upt_conv_Cons <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_matchF_aux_Cons3<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_matchF_aux <span class="free">σ</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">I</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">rels</span><span class="main">,</span> <span class="free">rel</span><span class="main">)</span> <span class="main">#</span> <span class="free">aux</span><span class="main">)</span> <span class="free">ne</span> <span class="free">i</span> <span class="main">⟹</span>
  qtable <span class="free">n</span> <span class="main">(</span>Formula.fv_regex <span class="free">r</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="free">ne</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> Suc <span class="main">(</span><span class="free">ne</span> <span class="main">+</span> length <span class="free">aux</span> <span class="main">+</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> mem <span class="free">I</span> <span class="main">(</span><span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">ne</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    Regex.match <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span> <span class="free">ne</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="free">rel</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_matchF_aux_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upt_conv_Cons <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> upt_append<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">..&lt;</span><span class="free">c</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">c</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_Suc_ex upt_add_eq_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_mbuf2_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_mbuf2 <span class="free">i</span> <span class="free">ja</span> <span class="free">jb</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="main">[</span><span class="free">ja</span><span class="main">..&lt;</span><span class="free">ja'</span><span class="main">]</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">Q</span> <span class="main">[</span><span class="free">jb</span><span class="main">..&lt;</span><span class="free">jb'</span><span class="main">]</span> <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ja</span> <span class="main">≤</span> <span class="free">ja'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">jb</span> <span class="main">≤</span> <span class="free">jb'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_mbuf2 <span class="free">i</span> <span class="free">ja'</span> <span class="free">jb'</span> <span class="free">P</span> <span class="free">Q</span> <span class="main">(</span>mbuf2_add <span class="free">xs</span> <span class="free">ys</span> <span class="free">buf</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_append2 upt_append <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">ja</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">ja</span><span class="main">..&lt;</span><span class="free">ja'</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span>
      exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">jb</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">jb</span><span class="main">..&lt;</span><span class="free">jb'</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_mbufn_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_mbufn <span class="free">i</span> <span class="free">js</span> <span class="free">Ps</span> <span class="free">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all3 list_all2 <span class="free">Ps</span> <span class="main">(</span>List.map2 <span class="main">(</span><span class="main">λ</span><span class="bound">j</span> <span class="bound">j'</span><span class="main">.</span> <span class="main">[</span><span class="bound">j</span><span class="main">..&lt;</span><span class="bound">j'</span><span class="main">]</span><span class="main">)</span> <span class="free">js</span> <span class="free">js'</span><span class="main">)</span> <span class="free">xss</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(≤)</span> <span class="free">js</span> <span class="free">js'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_mbufn <span class="free">i</span> <span class="free">js'</span> <span class="free">Ps</span> <span class="main">(</span>mbufn_add <span class="free">xss</span> <span class="free">buf</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_mbufn_def list_all3_conv_all_nth
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="free">Ps</span> <span class="main">=</span> length <span class="free">js'</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">js'</span> <span class="main">=</span> length <span class="main">(</span>mbufn_add <span class="free">xss</span> <span class="free">buf</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wf_mbufn_def list_all3_conv_all_nth list_all2_conv_all_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">Ps</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">js'</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wf_mbufn_def list_all3_conv_all_nth list_all2_conv_all_nth
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> k <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">js'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">=</span>  <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">js</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">js</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">..&lt;</span><span class="free">js'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"length <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">js</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">=</span> length <span class="main">(</span><span class="free">buf</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> wf_mbufn_def list_all3_conv_all_nth list_all2_conv_all_nth
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upt_append<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> k <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="free">Ps</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">js'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">(</span>mbufn_add <span class="free">xss</span> <span class="free">buf</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> wf_mbufn_def list_all3_conv_all_nth<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mbuf2_take_eqD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mbuf2_take <span class="free">f</span> <span class="free">buf</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">buf'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_mbuf2 <span class="free">i</span> <span class="free">ja</span> <span class="free">jb</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">buf</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_mbuf2 <span class="main">(</span>min <span class="free">ja</span> <span class="free">jb</span><span class="main">)</span> <span class="free">ja</span> <span class="free">jb</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">buf'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">z</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">i</span> <span class="bound">y</span> <span class="main">∧</span> <span class="bound">z</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span>min <span class="free">ja</span> <span class="free">jb</span><span class="main">]</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">buf</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">buf'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mbuf2_take.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv min_absorb1 min_absorb2 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_all3_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all3 <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="quoted"><span class="quoted">"list_all3 <span class="free">P</span> <span class="free">xs</span> <span class="main">[]</span> <span class="free">zs</span> <span class="main">⟷</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">zs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="quoted"><span class="quoted">"list_all3 <span class="free">P</span> <span class="main">[]</span> <span class="free">ys</span> <span class="free">zs</span> <span class="main">⟷</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free">zs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> list_all3_conv_all_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all3_Cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"list_all3 <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">(</span><span class="free">z</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="bound">xs'</span> <span class="bound">y</span> <span class="bound">ys'</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs'</span> <span class="main">∧</span> <span class="free">ys</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">ys'</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="free">z</span> <span class="main">∧</span> list_all3 <span class="free">P</span> <span class="bound">xs'</span> <span class="bound">ys'</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"list_all3 <span class="free">P</span> <span class="free">xs</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span> <span class="free">zs</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="bound">xs'</span> <span class="bound">z</span> <span class="bound">zs'</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs'</span> <span class="main">∧</span> <span class="free">zs</span> <span class="main">=</span> <span class="bound">z</span> <span class="main">#</span> <span class="bound">zs'</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">x</span> <span class="free">y</span> <span class="bound">z</span> <span class="main">∧</span> list_all3 <span class="free">P</span> <span class="bound">xs'</span> <span class="free">ys</span> <span class="bound">zs'</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"list_all3 <span class="free">P</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span> <span class="free">zs</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span> <span class="bound">ys'</span> <span class="bound">z</span> <span class="bound">zs'</span><span class="main">.</span> <span class="free">ys</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">ys'</span> <span class="main">∧</span> <span class="free">zs</span> <span class="main">=</span> <span class="bound">z</span> <span class="main">#</span> <span class="bound">zs'</span> <span class="main">∧</span> <span class="free">P</span> <span class="free">x</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">∧</span> list_all3 <span class="free">P</span> <span class="free">xs</span> <span class="bound">ys'</span> <span class="bound">zs'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> list_all3_conv_all_nth
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_Suc_conv Suc_length_conv nth_Cons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all3_mono_strong<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all3 <span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free">ys</span> <span class="main">⟹</span> <span class="bound">z</span> <span class="main">∈</span> set <span class="free">zs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">)</span> <span class="main">⟹</span>
  list_all3 <span class="free">Q</span> <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_all3.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> list_all3.intros<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Mini</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Mini</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">js</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">js</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">else</span> Min <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">js</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_mbufn_in_set_Mini<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_mbufn <span class="free">i</span> <span class="free">js</span> <span class="free">Ps</span> <span class="free">buf</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> set <span class="free">buf</span> <span class="main">⟹</span> Mini <span class="free">i</span> <span class="free">js</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> in_set_conv_nth
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> exE conjE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> set <span class="free">js</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">using</span></span> that assms <span class="keyword1"><span class="command">unfolding</span></span> wf_mbufn_def list_all3_conv_all_nth in_set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">buf</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">buf</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> Mini_def wf_mbufn_def list_all3_conv_all_nth
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Min_eqI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_mbufn_notin_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_mbufn <span class="free">i</span> <span class="free">js</span> <span class="free">Ps</span> <span class="free">buf</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∉</span> set <span class="free">buf</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">∈</span> set <span class="free">js</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wf_mbufn_def list_all3_conv_all_nth
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> set <span class="free">js</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_neq_implies_less <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_mbufn_map_tl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_mbufn <span class="free">i</span> <span class="free">js</span> <span class="free">Ps</span> <span class="free">buf</span> <span class="main">⟹</span> <span class="main">[]</span> <span class="main">∉</span> set <span class="free">buf</span> <span class="main">⟹</span> wf_mbufn <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">js</span> <span class="free">Ps</span> <span class="main">(</span>map tl <span class="free">buf</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_mbufn_def list_all3_map Suc_le_eq
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rel_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tl_transfer<span class="main"><span class="main">]</span></span>  <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all3_mono_strong le_neq_implies_less<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all3_list_all2I<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all3 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span> <span class="main">⟹</span> list_all2 <span class="free">Q</span> <span class="free">xs</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_all3.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mbuf2t_take_eqD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mbuf2t_take <span class="free">f</span> <span class="free">z</span> <span class="free">buf</span> <span class="free">nts</span> <span class="main">=</span> <span class="main">(</span><span class="free">z'</span><span class="main">,</span> <span class="free">buf'</span><span class="main">,</span> <span class="free">nts'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_mbuf2 <span class="free">i</span> <span class="free">ja</span> <span class="free">jb</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free">nts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ja</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">jb</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_mbuf2 <span class="main">(</span>min <span class="free">ja</span> <span class="free">jb</span><span class="main">)</span> <span class="free">ja</span> <span class="free">jb</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">buf'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span> <span class="main">[</span>min <span class="free">ja</span> <span class="free">jb</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free">nts'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">buf</span></span> <span class="quoted"><span class="free">nts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">z'</span></span> <span class="quoted"><span class="free">buf'</span></span> <span class="quoted"><span class="free">nts'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mbuf2t_take.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv less_eq_Suc_le min_absorb1 min_absorb2
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_mbufn_take<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mbufn_take <span class="free">f</span> <span class="free">z</span> <span class="free">buf</span> <span class="main">=</span> <span class="main">(</span><span class="free">z'</span><span class="main">,</span> <span class="free">buf'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_mbufn <span class="free">i</span> <span class="free">js</span> <span class="free">Ps</span> <span class="free">buf</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_mbufn <span class="main">(</span>Mini <span class="free">i</span> <span class="free">js</span><span class="main">)</span> <span class="free">js</span> <span class="free">Ps</span> <span class="free">buf'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wf_mbufn_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">buf</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">z'</span></span> <span class="quoted"><span class="free">buf'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mbufn_take.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> rec<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">f</span> <span class="skolem">z</span> <span class="skolem">buf</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">buf</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> rec.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> nonempty<span class="main">:</span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> set <span class="skolem">buf</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> rec.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">∈</span>set <span class="free">js</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="bound">j</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth list_all3_conv_all_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> True rec.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> set <span class="free">js</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth list_all3_conv_all_nth list_all2_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mini <span class="skolem">i</span> <span class="free">js</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Mini_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> antisym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Min.coboundedI Min.boundedI<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> rec.prems nonempty True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> nonempty rec.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mini <span class="skolem">i</span> <span class="free">js</span> <span class="main">=</span> Mini <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">js</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Mini_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹Mini <span class="skolem">i</span> <span class="free">js</span> <span class="main">=</span> Mini <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">js</span>›</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> rec.IH<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">buf</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="main">[]</span> <span class="main">∈</span> set <span class="skolem">buf</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nonempty False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all3 <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">j</span> <span class="bound">xs</span><span class="main">.</span> Suc <span class="skolem">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> list_all2 <span class="bound">P</span> <span class="main">[</span>Suc <span class="skolem">i</span><span class="main">..&lt;</span><span class="bound">j</span><span class="main">]</span> <span class="bound">xs</span><span class="main">)</span> <span class="free">Ps</span> <span class="free">js</span> <span class="main">(</span>map tl <span class="skolem">buf</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False rec.prems<span class="main">(</span>2<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all3_map <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all3_mono_strong <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list.rel_sel<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mbufn_take <span class="skolem">f</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>map hd <span class="skolem">buf</span><span class="main">)</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">(</span>map tl <span class="skolem">buf</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">z'</span><span class="main">,</span> <span class="skolem">buf'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> nonempty False rec.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mbufnt_take_eqD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mbufnt_take <span class="free">f</span> <span class="free">z</span> <span class="free">buf</span> <span class="free">nts</span> <span class="main">=</span> <span class="main">(</span><span class="free">z'</span><span class="main">,</span> <span class="free">buf'</span><span class="main">,</span> <span class="free">nts'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_mbufn <span class="free">i</span> <span class="free">js</span> <span class="free">Ps</span> <span class="free">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free">nts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> set <span class="free">js</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> Mini <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="free">nts</span><span class="main">)</span> <span class="free">js</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_mbufn <span class="free">k</span> <span class="free">js</span> <span class="free">Ps</span> <span class="free">buf'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span> <span class="main">[</span><span class="free">k</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free">nts'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>5<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">buf</span></span> <span class="quoted"><span class="free">nts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">z'</span></span> <span class="quoted"><span class="free">buf'</span></span> <span class="quoted"><span class="free">nts'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mbufnt_take.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> IH<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">f</span> <span class="skolem">z</span> <span class="skolem">buf</span> <span class="skolem">nts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> mbufnt_take.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword3"><span class="command">case</span></span> 1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span> <span class="main">[</span>Suc <span class="skolem">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="main">(</span>tl <span class="skolem">nts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list.rel_sel<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="skolem">nts</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_mbufn_in_set_Mini<span class="main">[</span><span class="operator">OF</span> 1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> mbufnt_take.simps<span class="main">)</span>
      <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Mini_def wf_mbufn_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all3_mono_strong
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ wf_mbufn_map_tl<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> 1<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> *<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 2
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span> <span class="main">[</span>Suc <span class="skolem">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="main">(</span>tl <span class="skolem">nts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list.rel_sel<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="skolem">nts</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">(</span>length <span class="skolem">nts</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">nts</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nts</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> length_greater_0_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_mbufn_in_set_Mini<span class="main">[</span><span class="operator">OF</span> 2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> wf_mbufn_notin_set<span class="main">[</span><span class="operator">OF</span> 2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> mbufnt_take.simps<span class="main">)</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Mini_def wf_mbufn_def
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ wf_mbufn_map_tl<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> 2<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> *<span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mbuf2t_take_induct<span class="main">[</span><span class="operator">consumes</span> 5<span class="main">,</span> <span class="operator">case_names</span> base step<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mbuf2t_take <span class="free">f</span> <span class="free">z</span> <span class="free">buf</span> <span class="free">nts</span> <span class="main">=</span> <span class="main">(</span><span class="free">z'</span><span class="main">,</span> <span class="free">buf'</span><span class="main">,</span> <span class="free">nts'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_mbuf2 <span class="free">i</span> <span class="free">ja</span> <span class="free">jb</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free">nts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ja</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">jb</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="free">i</span> <span class="free">z</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">t</span> <span class="bound">z</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">⟹</span> Suc <span class="bound">k</span> <span class="main">≤</span> <span class="free">ja</span> <span class="main">⟹</span> Suc <span class="bound">k</span> <span class="main">≤</span> <span class="free">jb</span> <span class="main">⟹</span>
      <span class="free">P</span> <span class="bound">k</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">k</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">k</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="free">U</span> <span class="bound">k</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="free">U</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">t</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">(</span>min <span class="free">ja</span> <span class="free">jb</span><span class="main">)</span> <span class="free">z'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">buf</span></span> <span class="quoted"><span class="free">nts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">z'</span></span> <span class="quoted"><span class="free">buf'</span></span> <span class="quoted"><span class="free">nts'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mbuf2t_take.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv less_eq_Suc_le min_absorb1 min_absorb2
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">U</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ refl<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all2_hdD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">i</span> <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> list_all2_conv_all_nth
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hd_conv_nth <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> zero_less_diff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all2_lastD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>last <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms list_all2_hdD<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">THEN</span> less_imp_add_positive<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> list_all2_conv_all_nth
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> last_conv_nth Suc_le_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mbufn_take_induct<span class="main">[</span><span class="operator">consumes</span> 3<span class="main">,</span> <span class="operator">case_names</span> base step<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mbufn_take <span class="free">f</span> <span class="free">z</span> <span class="free">buf</span> <span class="main">=</span> <span class="main">(</span><span class="free">z'</span><span class="main">,</span> <span class="free">buf'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_mbufn <span class="free">i</span> <span class="free">js</span> <span class="free">Ps</span> <span class="free">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="free">i</span> <span class="free">z</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span> <span class="bound">xs</span> <span class="bound">z</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">⟹</span> Suc <span class="bound">k</span> <span class="main">≤</span> Mini <span class="free">i</span> <span class="free">js</span> <span class="main">⟹</span>
      list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">k</span> <span class="bound">x</span><span class="main">)</span> <span class="free">Ps</span> <span class="bound">xs</span> <span class="main">⟹</span> <span class="free">U</span> <span class="bound">k</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="free">U</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">xs</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">(</span>Mini <span class="free">i</span> <span class="free">js</span><span class="main">)</span> <span class="free">z'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wf_mbufn_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">buf</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">z'</span></span> <span class="quoted"><span class="free">buf'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mbufn_take.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> rec<span class="main">:</span> <span class="main">(</span>1 <span class="skolem">f</span> <span class="skolem">z</span> <span class="skolem">buf</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">buf</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> rec.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Mini_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> nonempty<span class="main">:</span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> set <span class="skolem">buf</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> rec.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">∈</span>set <span class="free">js</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="bound">j</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth list_all3_conv_all_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> True rec.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> set <span class="free">js</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth list_all3_conv_all_nth list_all2_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mini <span class="skolem">i</span> <span class="free">js</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Mini_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> antisym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Min.coboundedI Min.boundedI<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> rec.prems nonempty True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> nonempty rec.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> more<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">≤</span> Mini <span class="skolem">i</span> <span class="free">js</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> diff_is_0_eq not_le <span class="keyword1"><span class="command">unfolding</span></span> Mini_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth list_all3_conv_all_nth list_all2_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Mini <span class="skolem">i</span> <span class="free">js</span> <span class="main">=</span> Mini <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">js</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Mini_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹Mini <span class="skolem">i</span> <span class="free">js</span> <span class="main">=</span> Mini <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">js</span>›</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> rec.IH<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">buf</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="main">[]</span> <span class="main">∈</span> set <span class="skolem">buf</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nonempty False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mbufn_take <span class="skolem">f</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>map hd <span class="skolem">buf</span><span class="main">)</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">(</span>map tl <span class="skolem">buf</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">z'</span><span class="main">,</span> <span class="skolem">buf'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> nonempty False rec.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all3 <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">j</span> <span class="bound">xs</span><span class="main">.</span> Suc <span class="skolem">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> list_all2 <span class="bound">P</span> <span class="main">[</span>Suc <span class="skolem">i</span><span class="main">..&lt;</span><span class="bound">j</span><span class="main">]</span> <span class="bound">xs</span><span class="main">)</span> <span class="free">Ps</span> <span class="free">js</span> <span class="main">(</span>map tl <span class="skolem">buf</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False rec.prems
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all3_map <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all3_mono_strong <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list.rel_sel<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>map hd <span class="skolem">buf</span><span class="main">)</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> more False rec.prems
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all3_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rec.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> list_all3_list_all2I
              <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all3_mono_strong <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list.rel_sel<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span> <span class="bound">xs</span> <span class="bound">z</span><span class="main">.</span> Suc <span class="skolem">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">⟹</span> Suc <span class="bound">k</span> <span class="main">≤</span> Mini <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">js</span> <span class="main">⟹</span>
          list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">k</span><span class="main">)</span> <span class="free">Ps</span> <span class="bound">xs</span> <span class="main">⟹</span> <span class="free">U</span> <span class="bound">k</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="free">U</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="bound">xs</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rec.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Mini_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mbufnt_take_induct<span class="main">[</span><span class="operator">consumes</span> 5<span class="main">,</span> <span class="operator">case_names</span> base step<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mbufnt_take <span class="free">f</span> <span class="free">z</span> <span class="free">buf</span> <span class="free">nts</span> <span class="main">=</span> <span class="main">(</span><span class="free">z'</span><span class="main">,</span> <span class="free">buf'</span><span class="main">,</span> <span class="free">nts'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_mbufn <span class="free">i</span> <span class="free">js</span> <span class="free">Ps</span> <span class="free">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free">nts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> set <span class="free">js</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="free">i</span> <span class="free">z</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span> <span class="bound">xs</span> <span class="bound">t</span> <span class="bound">z</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">⟹</span> Suc <span class="bound">k</span> <span class="main">≤</span> Mini <span class="free">j</span> <span class="free">js</span> <span class="main">⟹</span>
      list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">k</span> <span class="bound">x</span><span class="main">)</span> <span class="free">Ps</span> <span class="bound">xs</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">k</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="free">U</span> <span class="bound">k</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="free">U</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">xs</span> <span class="bound">t</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">(</span>Mini <span class="main">(</span><span class="free">i</span> <span class="main">+</span> length <span class="free">nts</span><span class="main">)</span> <span class="free">js</span><span class="main">)</span> <span class="free">z'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">buf</span></span> <span class="quoted"><span class="free">nts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">z'</span></span> <span class="quoted"><span class="free">buf'</span></span> <span class="quoted"><span class="free">nts'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mbufnt_take.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">f</span> <span class="skolem">z</span> <span class="skolem">buf</span> <span class="skolem">nts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span> <span class="main">[</span>Suc <span class="skolem">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="main">(</span>tl <span class="skolem">nts</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list.rel_sel<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="skolem">nts</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> mbufnt_take.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>2-6<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> Min <span class="main">(</span>set <span class="free">js</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">js</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nts</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">unfolding</span></span> wf_mbufn_def <span class="keyword1"><span class="command">using</span></span> wf_mbufn_in_set_Mini<span class="main">[</span><span class="operator">OF</span> 1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Mini_def list_all3_Cons neq_Nil_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 1<span class="main">(</span>2-7<span class="main">)</span> list_all2_hdD<span class="main">[</span><span class="operator">OF</span> 1<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wf_mbufn_def <span class="keyword1"><span class="command">using</span></span> wf_mbufn_in_set_Mini<span class="main">[</span><span class="operator">OF</span> 1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> wf_mbufn_notin_set<span class="main">[</span><span class="operator">OF</span> 1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> mbufnt_take.simps<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mini_def list.rel_map Suc_le_eq
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">U</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ refl<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span>
        list_all3_mono_strong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> list_all3_list_all2I<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="free">js</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> list_all2_hdD
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> 1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ wf_mbufn_map_tl<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> 1<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> * _ 1<span class="main"><span class="main"><span class="main">(</span></span></span>7<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mbuf2_take_add'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mbuf2_take <span class="free">f</span> <span class="main">(</span>mbuf2_add <span class="free">xs</span> <span class="free">ys</span> <span class="free">buf</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">zs</span><span class="main">,</span> <span class="free">buf'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="free">P</span> <span class="free">V</span> <span class="free">j</span> <span class="free">n</span> <span class="free">R</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="free">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> rm<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_mapping <span class="main">(≤)</span> <span class="free">P</span> <span class="free">P'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">r</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">φ</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free">P'</span> <span class="free">φ</span> <span class="free">j'</span><span class="main">]</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">r</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">ψ</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free">P'</span> <span class="free">ψ</span> <span class="free">j'</span><span class="main">]</span> <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="free">P'</span> <span class="free">V</span> <span class="free">j'</span> <span class="free">n</span> <span class="free">R</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="free">buf'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">Z</span><span class="main">.</span> <span class="main">∃</span><span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span>
      qtable <span class="free">n</span> <span class="main">(</span>fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">φ</span><span class="main">)</span> <span class="bound">X</span> <span class="main">∧</span>
      qtable <span class="free">n</span> <span class="main">(</span>fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">ψ</span><span class="main">)</span> <span class="bound">Y</span> <span class="main">∧</span>
      <span class="bound">Z</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">X</span> <span class="bound">Y</span><span class="main">)</span>
      <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P'</span> <span class="free">φ</span> <span class="free">j'</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P'</span> <span class="free">ψ</span> <span class="free">j'</span><span class="main">)</span><span class="main">]</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pre rm <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2'_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mbuf2_take_eqD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq<span class="main"><span class="main">]</span></span> wf_mbuf2_add<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ xs ys<span class="main"><span class="main">]</span></span> progress_mono_gen<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>›</span></span> rm<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>


<span class="keyword1"><span class="command">lemma</span></span> mbuft2_take_add'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mbuf2_take <span class="free">f</span> <span class="main">(</span>mbuf2_add <span class="free">xs</span> <span class="free">ys</span> <span class="free">buf</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">zs</span><span class="main">,</span> <span class="free">buf'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbuft2' <span class="free">σ</span> <span class="free">P</span> <span class="free">V</span> <span class="free">j</span> <span class="free">n</span> <span class="free">R</span> <span class="free">φ</span> <span class="free">α</span> <span class="free">I</span> <span class="free">β</span> <span class="free">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> rm<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_mapping <span class="main">(≤)</span> <span class="free">P</span> <span class="free">P'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">r</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">φ</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free">P'</span> <span class="free">φ</span> <span class="free">j'</span><span class="main">]</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="main">(</span><span class="bound">dfvs</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> wf_dfvs <span class="bound">dfvs</span> <span class="free">σ</span> <span class="free">I</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="free">α</span> <span class="free">I</span> <span class="free">β</span><span class="main">)</span> <span class="main">∧</span> qtable <span class="free">n</span> <span class="bound">dfvs</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="free">α</span> <span class="free">I</span> <span class="free">β</span><span class="main">)</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="main">(</span>formula.Trigger <span class="free">α</span> <span class="free">I</span> <span class="free">β</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free">P'</span> <span class="main">(</span>formula.Trigger <span class="free">α</span> <span class="free">I</span> <span class="free">β</span><span class="main">)</span> <span class="free">j'</span><span class="main">]</span> <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_mbuft2' <span class="free">σ</span> <span class="free">P'</span> <span class="free">V</span> <span class="free">j'</span> <span class="free">n</span> <span class="free">R</span> <span class="free">φ</span> <span class="free">α</span> <span class="free">I</span> <span class="free">β</span> <span class="free">buf'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">Z</span><span class="main">.</span> <span class="main">∃</span><span class="bound">X</span> <span class="bound">V_Y</span> <span class="bound">Y</span><span class="main">.</span>
      qtable <span class="free">n</span> <span class="main">(</span>fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">φ</span><span class="main">)</span> <span class="bound">X</span> <span class="main">∧</span>
      wf_dfvs <span class="bound">V_Y</span> <span class="free">σ</span> <span class="free">I</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="free">α</span> <span class="free">I</span> <span class="free">β</span><span class="main">)</span> <span class="main">∧</span> qtable <span class="free">n</span> <span class="bound">V_Y</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="free">α</span> <span class="free">I</span> <span class="free">β</span><span class="main">)</span><span class="main">)</span> <span class="bound">Y</span> <span class="main">∧</span>
      <span class="bound">Z</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">X</span> <span class="main">(</span><span class="bound">V_Y</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="main">(</span>formula.Trigger <span class="free">α</span> <span class="free">I</span> <span class="free">β</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P'</span> <span class="free">φ</span> <span class="free">j'</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P'</span> <span class="main">(</span>formula.Trigger <span class="free">α</span> <span class="free">I</span> <span class="free">β</span><span class="main">)</span> <span class="free">j'</span><span class="main">)</span><span class="main">]</span> <span class="free">zs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> progress<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Monitor.progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">≤</span> Monitor.progress <span class="free">σ</span> <span class="free">P'</span> <span class="free">φ</span> <span class="free">j'</span>"</span></span>
    <span class="quoted"><span class="quoted">"Monitor.progress <span class="free">σ</span> <span class="free">P</span> <span class="main">(</span>formula.Trigger <span class="free">α</span> <span class="free">I</span> <span class="free">β</span><span class="main">)</span> <span class="free">j</span> <span class="main">≤</span> Monitor.progress <span class="free">σ</span> <span class="free">P'</span> <span class="main">(</span>formula.Trigger <span class="free">α</span> <span class="free">I</span> <span class="free">β</span><span class="main">)</span> <span class="free">j'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> progress_mono_gen<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>›</span></span> rm<span class="main">]</span> progress_mono_gen<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>›</span></span> rm<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>formula.Trigger <span class="free">α</span> <span class="free">I</span> <span class="free">β</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> wf_add<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbuf2 <span class="main">(</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="free">P</span> <span class="main">(</span>formula.Trigger <span class="free">α</span> <span class="free">I</span> <span class="free">β</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="free">P'</span> <span class="free">φ</span> <span class="free">j'</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="free">P'</span> <span class="main">(</span>formula.Trigger <span class="free">α</span> <span class="free">I</span> <span class="free">β</span><span class="main">)</span> <span class="free">j'</span><span class="main">)</span>
   <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>
   <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="main">(</span><span class="bound">dfvs</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> wf_dfvs <span class="bound">dfvs</span> <span class="free">σ</span> <span class="free">I</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="free">α</span> <span class="free">I</span> <span class="free">β</span><span class="main">)</span> <span class="main">∧</span> qtable <span class="free">n</span> <span class="bound">dfvs</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="free">α</span> <span class="free">I</span> <span class="free">β</span><span class="main">)</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span> <span class="main">(</span>mbuf2_add <span class="free">xs</span> <span class="free">ys</span> <span class="free">buf</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_mbuf2_add<span class="main">[</span><span class="operator">OF</span> pre<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> wf_mbuft2'_def<span class="main"><span class="main">]</span></span> xs ys progress<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"wf_mbuft2' <span class="free">σ</span> <span class="free">P'</span> <span class="free">V</span> <span class="free">j'</span> <span class="free">n</span> <span class="free">R</span> <span class="free">φ</span> <span class="free">α</span> <span class="free">I</span> <span class="free">β</span> <span class="free">buf'</span>"</span></span>
    <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">Z</span><span class="main">.</span> <span class="main">∃</span><span class="bound">X</span> <span class="bound">V_Y</span> <span class="bound">Y</span><span class="main">.</span>
      qtable <span class="free">n</span> <span class="main">(</span>fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">φ</span><span class="main">)</span> <span class="bound">X</span> <span class="main">∧</span>
      wf_dfvs <span class="bound">V_Y</span> <span class="free">σ</span> <span class="free">I</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="free">α</span> <span class="free">I</span> <span class="free">β</span><span class="main">)</span> <span class="main">∧</span> qtable <span class="free">n</span> <span class="bound">V_Y</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="free">α</span> <span class="free">I</span> <span class="free">β</span><span class="main">)</span><span class="main">)</span> <span class="bound">Y</span> <span class="main">∧</span>
      <span class="bound">Z</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">X</span> <span class="main">(</span><span class="bound">V_Y</span><span class="main">,</span> <span class="bound">Y</span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="main">(</span>formula.Trigger <span class="free">α</span> <span class="free">I</span> <span class="free">β</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P'</span> <span class="free">φ</span> <span class="free">j'</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P'</span> <span class="main">(</span>formula.Trigger <span class="free">α</span> <span class="free">I</span> <span class="free">β</span><span class="main">)</span> <span class="free">j'</span><span class="main">)</span><span class="main">]</span> <span class="free">zs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuft2'_def
    <span class="keyword1"><span class="command">using</span></span> mbuf2_take_eqD<span class="main">[</span><span class="operator">OF</span> eq wf_add<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mbuf2t_take_add'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mbuf2t_take <span class="free">f</span> <span class="free">z</span> <span class="main">(</span>mbuf2_add <span class="free">xs</span> <span class="free">ys</span> <span class="free">buf</span><span class="main">)</span> <span class="free">nts</span> <span class="main">=</span> <span class="main">(</span><span class="free">z'</span><span class="main">,</span> <span class="free">buf'</span><span class="main">,</span> <span class="free">nts'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">j</span><span class="main">)</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">j'</span><span class="main">)</span> <span class="free">P'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> rm<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_mapping <span class="main">(≤)</span> <span class="free">P</span> <span class="free">P'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pre_buf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="free">P</span> <span class="free">V</span> <span class="free">j</span> <span class="free">n</span> <span class="free">R</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="free">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pre_nts<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="free">j'</span><span class="main">]</span> <span class="free">nts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="main">(</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">φ</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free">P'</span> <span class="free">φ</span> <span class="free">j'</span><span class="main">]</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="main">(</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">ψ</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free">P'</span> <span class="free">ψ</span> <span class="free">j'</span><span class="main">]</span> <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="free">P'</span> <span class="free">V</span> <span class="free">j'</span> <span class="free">n</span> <span class="free">R</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="free">buf'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_ts <span class="free">σ</span> <span class="free">P'</span> <span class="free">j'</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="free">nts'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pre_buf pre_nts bounded rm <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2'_def wf_ts_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mbuf2t_take_eqD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq<span class="main"><span class="main">]</span></span> wf_mbuf2_add<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ xs ys<span class="main"><span class="main">]</span></span> progress_mono_gen<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>›</span></span> rm<span class="main"><span class="main">]</span></span>
      progress_le_gen<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> ok_0_atms<span class="main">:</span> <span class="quoted"><span class="quoted">"ok <span class="main">0</span> <span class="free">mr</span> <span class="main">⟹</span> regex.atms <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">mr</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> ok_0_progress<span class="main">:</span> <span class="quoted"><span class="quoted">"ok <span class="main">0</span> <span class="free">mr</span> <span class="main">⟹</span> progress_regex <span class="free">σ</span> <span class="free">P</span> <span class="main">(</span>from_mregex <span class="free">mr</span> <span class="main">[]</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> ok_0_atms<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> progress_regex_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> atms_empty_atms<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex <span class="free">m</span> <span class="free">g</span> <span class="free">r</span> <span class="main">⟹</span> atms <span class="free">r</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> regex.atms <span class="free">r</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> safe_regex_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cases_Neg_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> atms_empty_progress<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex <span class="free">m</span> <span class="free">g</span> <span class="free">r</span> <span class="main">⟹</span> atms <span class="free">r</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> progress_regex <span class="free">σ</span> <span class="free">P</span> <span class="free">r</span> <span class="free">j</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> atms_empty_atms<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> progress_regex_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> to_mregex_empty_progress<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex <span class="free">m</span> <span class="free">g</span> <span class="free">r</span> <span class="main">⟹</span> to_mregex <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">mr</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟹</span>
  progress_regex <span class="free">σ</span> <span class="free">P</span> <span class="free">r</span> <span class="free">j</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> from_mregex_eq ok_0_progress to_mregex_ok atms_empty_atms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_regex_le<span class="main">:</span> <span class="quoted"><span class="quoted">"pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">j</span><span class="main">)</span> <span class="free">P</span> <span class="main">⟹</span> progress_regex <span class="free">σ</span> <span class="free">P</span> <span class="free">r</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> progress_le_gen <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Min_le_iff progress_regex_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Neg_acyclic<span class="main">:</span> <span class="quoted"><span class="quoted">"formula.Neg <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> case_Neg_in_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">y</span> <span class="keyword1">of</span> formula.Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="main">{</span><span class="bound">φ'</span><span class="main">}</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">{}</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">y</span> <span class="main">=</span> formula.Neg <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> atms_nonempty_progress<span class="main">:</span>
  <span class="quoted"><span class="quoted">"safe_regex <span class="free">m</span> <span class="free">g</span> <span class="free">r</span> <span class="main">⟹</span> atms <span class="free">r</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> progress <span class="free">σ</span> <span class="free">P</span> <span class="bound">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">`</span> atms <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> progress <span class="free">σ</span> <span class="free">P</span> <span class="bound">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">`</span> regex.atms <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">frule</span> atms_empty_atms<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> atms_def image_iff case_Neg_in_iff <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> disjE_Not2 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> safe_regex_safe_formula<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> to_mregex_nonempty_progress<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex <span class="free">m</span> <span class="free">g</span> <span class="free">r</span> <span class="main">⟹</span> to_mregex <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">mr</span><span class="main">,</span> <span class="free">φs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">φs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span>
  progress_regex <span class="free">σ</span> <span class="free">P</span> <span class="free">r</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">MIN</span> <span class="bound">φ</span><span class="main">∈</span>set <span class="free">φs</span><span class="main">.</span> progress <span class="free">σ</span> <span class="free">P</span> <span class="bound">φ</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> atms_nonempty_progress to_mregex_ok <span class="keyword1"><span class="command">unfolding</span></span> progress_regex_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> to_mregex_progress<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex <span class="free">m</span> <span class="free">g</span> <span class="free">r</span> <span class="main">⟹</span> to_mregex <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">mr</span><span class="main">,</span> <span class="free">φs</span><span class="main">)</span> <span class="main">⟹</span>
  progress_regex <span class="free">σ</span> <span class="free">P</span> <span class="free">r</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">φs</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="free">j</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">MIN</span> <span class="bound">φ</span><span class="main">∈</span>set <span class="free">φs</span><span class="main">.</span> progress <span class="free">σ</span> <span class="free">P</span> <span class="bound">φ</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> to_mregex_nonempty_progress to_mregex_empty_progress <span class="keyword1"><span class="command">unfolding</span></span> progress_regex_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mbufnt_take_add'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mbufnt_take <span class="free">f</span> <span class="free">z</span> <span class="main">(</span>mbufn_add <span class="free">xss</span> <span class="free">buf</span><span class="main">)</span> <span class="free">nts</span> <span class="main">=</span> <span class="main">(</span><span class="free">z'</span><span class="main">,</span> <span class="free">buf'</span><span class="main">,</span> <span class="free">nts'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">j</span><span class="main">)</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">j'</span><span class="main">)</span> <span class="free">P'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> rm<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_mapping <span class="main">(≤)</span> <span class="free">P</span> <span class="free">P'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> safe<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex <span class="free">m</span> <span class="free">g</span> <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mr<span class="main">:</span> <span class="quoted"><span class="quoted">"to_mregex <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">mr</span><span class="main">,</span> <span class="free">φs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pre_buf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbufn' <span class="free">σ</span> <span class="free">P</span> <span class="free">V</span> <span class="free">j</span> <span class="free">n</span> <span class="free">R</span> <span class="free">r</span> <span class="free">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pre_nts<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>progress_regex <span class="free">σ</span> <span class="free">P</span> <span class="free">r</span> <span class="free">j</span><span class="main">..&lt;</span><span class="free">j'</span><span class="main">]</span> <span class="free">nts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> xss<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all3 list_all2
     <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>fv <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">φ</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span> <span class="free">φs</span><span class="main">)</span>
     <span class="main">(</span>map2 upt <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> progress <span class="free">σ</span> <span class="free">P</span> <span class="bound">φ</span> <span class="free">j</span><span class="main">)</span> <span class="free">φs</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> progress <span class="free">σ</span> <span class="free">P'</span> <span class="bound">φ</span> <span class="free">j'</span><span class="main">)</span> <span class="free">φs</span><span class="main">)</span><span class="main">)</span> <span class="free">xss</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_mbufn' <span class="free">σ</span> <span class="free">P'</span> <span class="free">V</span> <span class="free">j'</span> <span class="free">n</span> <span class="free">R</span> <span class="free">r</span> <span class="free">buf'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_ts_regex <span class="free">σ</span> <span class="free">P'</span> <span class="free">j'</span> <span class="free">r</span> <span class="free">nts'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pre_buf pre_nts bounded rm mr safe xss <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>›</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> wf_mbufn'_def wf_ts_regex_def
  <span class="keyword1"><span class="command">using</span></span> atms_empty_progress<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> to_mregex_ok<span class="main">[</span><span class="operator">OF</span> mr<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list.rel_map to_mregex_empty_progress to_mregex_nonempty_progress Mini_def
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> progress_mono_gen<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>›</span></span> rm<span class="main"><span class="main">]</span></span> list.rel_refl_strong progress_le_gen
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mbufnt_take_eqD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq wf_mbufn_add<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mbuf2t_take_add_induct'<span class="main">[</span><span class="operator">consumes</span> 6<span class="main">,</span> <span class="operator">case_names</span> base step<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mbuf2t_take <span class="free">f</span> <span class="free">z</span> <span class="main">(</span>mbuf2_add <span class="free">xs</span> <span class="free">ys</span> <span class="free">buf</span><span class="main">)</span> <span class="free">nts</span> <span class="main">=</span> <span class="main">(</span><span class="free">z'</span><span class="main">,</span> <span class="free">buf'</span><span class="main">,</span> <span class="free">nts'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">j</span><span class="main">)</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">j'</span><span class="main">)</span> <span class="free">P'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> rm<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_mapping <span class="main">(≤)</span> <span class="free">P</span> <span class="free">P'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pre_buf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="free">P</span> <span class="free">V</span> <span class="free">j</span> <span class="free">n</span> <span class="free">R</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="free">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pre_nts<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="free">j'</span><span class="main">]</span> <span class="free">nts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="main">(</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">φ</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free">P'</span> <span class="free">φ</span> <span class="free">j'</span><span class="main">]</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="main">(</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">ψ</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free">P'</span> <span class="free">ψ</span> <span class="free">j'</span><span class="main">]</span> <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">(</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="free">z</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span> <span class="bound">X</span> <span class="bound">Y</span> <span class="bound">z</span><span class="main">.</span> min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">⟹</span>
      Suc <span class="bound">k</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="free">P'</span> <span class="free">φ</span> <span class="free">j'</span> <span class="main">⟹</span> Suc <span class="bound">k</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="free">P'</span> <span class="free">ψ</span> <span class="free">j'</span> <span class="main">⟹</span>
      qtable <span class="free">n</span> <span class="main">(</span>fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span> <span class="bound">X</span> <span class="main">⟹</span>
      qtable <span class="free">n</span> <span class="main">(</span>fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free">ψ</span><span class="main">)</span> <span class="bound">Y</span> <span class="main">⟹</span>
      <span class="free">U</span> <span class="bound">k</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="free">U</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">X</span> <span class="bound">Y</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span><span class="main">)</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">(</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P'</span> <span class="free">φ</span> <span class="free">j'</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P'</span> <span class="free">ψ</span> <span class="free">j'</span><span class="main">)</span><span class="main">)</span> <span class="free">z'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pre_buf pre_nts bounded rm <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2'_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mbuf2t_take_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq<span class="main"><span class="main">]</span></span> wf_mbuf2_add<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ xs ys<span class="main"><span class="main">]</span></span> progress_mono_gen<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>›</span></span> rm<span class="main"><span class="main">]</span></span>
      progress_le_gen base step<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mbufnt_take_add_induct'<span class="main">[</span><span class="operator">consumes</span> 6<span class="main">,</span> <span class="operator">case_names</span> base step<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mbufnt_take <span class="free">f</span> <span class="free">z</span> <span class="main">(</span>mbufn_add <span class="free">xss</span> <span class="free">buf</span><span class="main">)</span> <span class="free">nts</span> <span class="main">=</span> <span class="main">(</span><span class="free">z'</span><span class="main">,</span> <span class="free">buf'</span><span class="main">,</span> <span class="free">nts'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">j</span><span class="main">)</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">j'</span><span class="main">)</span> <span class="free">P'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> rm<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_mapping <span class="main">(≤)</span> <span class="free">P</span> <span class="free">P'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> safe<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex <span class="free">m</span> <span class="free">g</span> <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mr<span class="main">:</span> <span class="quoted"><span class="quoted">"to_mregex <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">mr</span><span class="main">,</span> <span class="free">φs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pre_buf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbufn' <span class="free">σ</span> <span class="free">P</span> <span class="free">V</span> <span class="free">j</span> <span class="free">n</span> <span class="free">R</span> <span class="free">r</span> <span class="free">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pre_nts<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>progress_regex <span class="free">σ</span> <span class="free">P</span> <span class="free">r</span> <span class="free">j</span><span class="main">..&lt;</span><span class="free">j'</span><span class="main">]</span> <span class="free">nts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> xss<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all3 list_all2
     <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>fv <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">φ</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span> <span class="free">φs</span><span class="main">)</span>
     <span class="main">(</span>map2 upt <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> progress <span class="free">σ</span> <span class="free">P</span> <span class="bound">φ</span> <span class="free">j</span><span class="main">)</span> <span class="free">φs</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> progress <span class="free">σ</span> <span class="free">P'</span> <span class="bound">φ</span> <span class="free">j'</span><span class="main">)</span> <span class="free">φs</span><span class="main">)</span><span class="main">)</span> <span class="free">xss</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">(</span>progress_regex <span class="free">σ</span> <span class="free">P</span> <span class="free">r</span> <span class="free">j</span><span class="main">)</span> <span class="free">z</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span> <span class="bound">Xs</span> <span class="bound">z</span><span class="main">.</span> progress_regex <span class="free">σ</span> <span class="free">P</span> <span class="free">r</span> <span class="free">j</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">⟹</span> Suc <span class="bound">k</span> <span class="main">≤</span> progress_regex <span class="free">σ</span> <span class="free">P'</span> <span class="free">r</span> <span class="free">j'</span> <span class="main">⟹</span>
      list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="main">(</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>fv <span class="bound">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="bound">φ</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span> <span class="free">φs</span> <span class="bound">Xs</span> <span class="main">⟹</span>
      <span class="free">U</span> <span class="bound">k</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="free">U</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">Xs</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span><span class="main">)</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">(</span>progress_regex <span class="free">σ</span> <span class="free">P'</span> <span class="free">r</span> <span class="free">j'</span><span class="main">)</span> <span class="free">z'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pre_buf pre_nts bounded rm <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>›</span></span> to_mregex_progress<span class="main">[</span><span class="operator">OF</span> safe mr<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">P'</span></span> <span class="quoted"><span class="free">j'</span></span><span class="main">]</span> to_mregex_empty_progress<span class="main">[</span><span class="operator">OF</span> safe<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">mr</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span> base
  <span class="keyword1"><span class="command">unfolding</span></span> wf_mbufn'_def mr prod.case
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mbufnt_take_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq wf_mbufn_add<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> _ xss<span class="main"><span class="main"><span class="main">]</span></span></span> pre_nts<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">U</span></span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list.rel_map le_imp_diff_is_add <span class="dynamic"><span class="dynamic">ac_simps</span></span> Mini_def
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> progress_mono_gen<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>›</span></span> rm<span class="main"><span class="main">]</span></span> list.rel_refl_strong progress_le_gen
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> base step  <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_Until_le<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="free">P</span> <span class="main">(</span>Formula.Until <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span> <span class="main">≤</span> min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> trans_le_add1 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cInf_lower<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_MatchF_le<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="free">P</span> <span class="main">(</span>Formula.MatchF <span class="free">I</span> <span class="free">r</span><span class="main">)</span> <span class="free">j</span> <span class="main">≤</span> progress_regex <span class="free">σ</span> <span class="free">P</span> <span class="free">r</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> trans_le_add1 progress_regex_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cInf_lower<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all2_upt_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">a</span> <span class="free">x</span> <span class="main">⟹</span> list_all2 <span class="free">P</span> <span class="main">[</span>Suc <span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">]</span> <span class="free">xs</span> <span class="main">⟹</span> Suc <span class="free">a</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span>
  list_all2 <span class="free">P</span> <span class="main">[</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all2_upt_append<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="main">[</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">]</span> <span class="free">xs</span> <span class="main">⟹</span> list_all2 <span class="free">P</span> <span class="main">[</span><span class="free">b</span><span class="main">..&lt;</span><span class="free">c</span><span class="main">]</span> <span class="free">ys</span> <span class="main">⟹</span>
  <span class="free">a</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">⟹</span> list_all2 <span class="free">P</span> <span class="main">[</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">c</span><span class="main">]</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all3_list_all2_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all3 <span class="free">R</span> <span class="free">xs</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">x</span><span class="main">)</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all3_conv_all_nth list_all2_conv_all_nth<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> map_split_map<span class="main">:</span> <span class="quoted"><span class="quoted">"map_split <span class="free">f</span> <span class="main">(</span>map <span class="free">g</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> map_split <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">g</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_split_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"map_split <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span>fst <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span><span class="main">,</span> map <span class="main">(</span>snd <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fv_formula_of_constraint<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="main">(</span>formula_of_constraint <span class="main">(</span><span class="free">t1</span><span class="main">,</span> <span class="free">p</span><span class="main">,</span> <span class="free">c</span><span class="main">,</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fv_trm <span class="free">t1</span> <span class="main">∪</span> fv_trm <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t1</span><span class="main">,</span> <span class="free">p</span><span class="main">,</span> <span class="free">c</span><span class="main">,</span> <span class="free">t2</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> formula_of_constraint.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> maux<span class="main">)</span> wf_mformula_wf_set<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="free">P</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">φ</span> <span class="free">φ'</span> <span class="main">⟹</span> wf_set <span class="free">n</span> <span class="main">(</span>Formula.fv <span class="free">φ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_set_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_mformula.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>AndRel <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">ψ'</span> <span class="skolem">conf</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_formula_of_constraint <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> subsetD<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_Release <span class="skolem">I</span> <span class="skolem">φ'</span> <span class="skolem">ψ'</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">aux</span> <span class="skolem">α'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> release_fvi<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ands <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">l</span> <span class="skolem">l_pos</span> <span class="skolem">l_neg</span> <span class="skolem">l'</span> <span class="skolem">buf</span> <span class="skolem">A_pos</span> <span class="skolem">A_neg</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Ands.IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">φ'</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">l_pos</span> <span class="main">@</span> map remove_neg <span class="skolem">l_neg</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="bound">φ'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prodD in_set_impl_in_set_zip2<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">φ'</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">l_pos</span> <span class="main">@</span> <span class="skolem">l_neg</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="bound">φ'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fv_remove_neg
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Ands <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Agg <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">b</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">y</span> <span class="skolem">f</span> <span class="skolem">g0</span> <span class="skolem">ω</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.fvi_trm <span class="skolem">b</span> <span class="skolem">f</span> <span class="main">⊆</span> Formula.fvi <span class="skolem">b</span> <span class="skolem">φ'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fvi_trm_iff_fv_trm<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="main">]</span></span> fvi_iff_fv<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Agg <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Un_absorb2 fvi_iff_fv<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Release_0<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> release_fvi<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MatchP <span class="skolem">r</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φs</span> <span class="skolem">mr</span> <span class="skolem">mrs</span> <span class="skolem">buf</span> <span class="skolem">nts</span> <span class="skolem">I</span> <span class="skolem">aux</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> conv<span class="main">:</span> <span class="quoted"><span class="quoted">"to_mregex <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">mr</span><span class="main">,</span> <span class="skolem">φs'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> MatchP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">φ'</span><span class="main">∈</span>set <span class="skolem">φs'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="bound">φ'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_conv_all_nth all_set_conv_all_nth<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">φs'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> conv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_mregex_ok<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> conjunct1<span class="main"><span class="main">]</span></span> fv_regex_alt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹safe_regex <span class="main">_</span> <span class="main">_</span> <span class="skolem">r</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MatchF <span class="skolem">r</span>  <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φs</span> <span class="skolem">mr</span> <span class="skolem">mrs</span> <span class="skolem">buf</span> <span class="skolem">nts</span> <span class="skolem">I</span> <span class="skolem">aux</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> conv<span class="main">:</span> <span class="quoted"><span class="quoted">"to_mregex <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">mr</span><span class="main">,</span> <span class="skolem">φs'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> MatchF <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">φ'</span><span class="main">∈</span>set <span class="skolem">φs'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="bound">φ'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_conv_all_nth all_set_conv_all_nth<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">φs'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> conv <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_mregex_ok<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> conjunct1<span class="main"><span class="main">]</span></span> fv_regex_alt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹safe_regex <span class="main">_</span> <span class="main">_</span> <span class="skolem">r</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fvi_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> qtable_mmulti_join<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all3 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">Qi</span> <span class="bound">X</span><span class="main">.</span> qtable <span class="free">n</span> <span class="bound">A</span> <span class="free">P</span> <span class="bound">Qi</span> <span class="bound">X</span> <span class="main">∧</span> wf_set <span class="free">n</span> <span class="bound">A</span><span class="main">)</span> <span class="free">A_pos</span> <span class="free">Q_pos</span> <span class="free">L_pos</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> neg<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all3 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">Qi</span> <span class="bound">X</span><span class="main">.</span> qtable <span class="free">n</span> <span class="bound">A</span> <span class="free">P</span> <span class="bound">Qi</span> <span class="bound">X</span> <span class="main">∧</span> wf_set <span class="free">n</span> <span class="bound">A</span><span class="main">)</span> <span class="free">A_neg</span> <span class="free">Q_neg</span> <span class="free">L_neg</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> C_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">A_pos</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> L_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">=</span> <span class="free">L_pos</span> <span class="main">@</span> <span class="free">L_neg</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A_pos</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fv_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>set <span class="free">A_neg</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span>set <span class="free">A_pos</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> restrict_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">C</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> list_all <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">A_pos</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> restrict_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">C</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> list_all <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">A_neg</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Qs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">C</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">⟷</span>
      list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">Qi</span><span class="main">.</span> <span class="bound">Qi</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">A_pos</span> <span class="free">Q_pos</span> <span class="main">∧</span>
      list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">Qi</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">Qi</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">A_neg</span> <span class="free">Q_neg</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">C</span> <span class="free">P</span> <span class="free">Q</span> <span class="main">(</span>mmulti_join <span class="free">n</span> <span class="free">A_pos</span> <span class="free">A_neg</span> <span class="free">L</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> qtableI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> pos <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> table <span class="free">n</span> <span class="bound">A</span> <span class="bound">X</span> <span class="main">∧</span> wf_set <span class="free">n</span> <span class="bound">A</span><span class="main">)</span> <span class="free">A_pos</span> <span class="free">L_pos</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all3_conv_all_nth list_all2_conv_all_nth qtable_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> neg <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> table <span class="free">n</span> <span class="bound">A</span> <span class="bound">X</span> <span class="main">∧</span> wf_set <span class="free">n</span> <span class="bound">A</span><span class="main">)</span> <span class="free">A_neg</span> <span class="free">L_neg</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all3_conv_all_nth list_all2_conv_all_nth qtable_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> table <span class="free">n</span> <span class="bound">A</span> <span class="bound">X</span> <span class="main">∧</span> wf_set <span class="free">n</span> <span class="bound">A</span><span class="main">)</span> <span class="main">(</span><span class="free">A_pos</span> <span class="main">@</span> <span class="free">A_neg</span><span class="main">)</span> <span class="main">(</span><span class="free">L_pos</span> <span class="main">@</span> <span class="free">L_neg</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> list_all2_appendI<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> in_join_iff <span class="main">=</span> mmulti_join_correct<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">A_pos</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> L<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> take_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="free">A_pos</span><span class="main">)</span> <span class="main">(</span><span class="free">L_pos</span> <span class="main">@</span> <span class="free">L_neg</span><span class="main">)</span> <span class="main">=</span> <span class="free">L_pos</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> drop_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>length <span class="free">A_pos</span><span class="main">)</span> <span class="main">(</span><span class="free">L_pos</span> <span class="main">@</span> <span class="free">L_neg</span><span class="main">)</span> <span class="main">=</span> <span class="free">L_neg</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> mmulti_join.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">C</span> <span class="main">(</span>mmulti_join <span class="free">n</span> <span class="free">A_pos</span> <span class="free">A_neg</span> <span class="free">L</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> C_eq L_eq table_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_join_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> mmulti_join <span class="free">n</span> <span class="free">A_pos</span> <span class="free">A_neg</span> <span class="free">L</span>"</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">C</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Qs<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _ conjI<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> pos'<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="main">(∈)</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="free">A_pos</span> <span class="free">L_pos</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> neg'<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="main">(∉)</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="free">A_neg</span> <span class="free">L_neg</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> L_eq in_join_iff take_eq drop_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">Qi</span><span class="main">.</span> <span class="bound">Qi</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="free">A_pos</span> <span class="free">Q_pos</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pos pos' restrict_pos that<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all3_conv_all_nth list_all2_conv_all_nth list_all_length qtable_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> fv_subset'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">A_neg</span> <span class="main">⟹</span> <span class="free">A_neg</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">⊆</span> <span class="free">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fv_subset <span class="keyword1"><span class="command">unfolding</span></span> C_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sup_le_iff<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">Qi</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">Qi</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="free">A_neg</span> <span class="free">Q_neg</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> neg neg' restrict_neg that<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all3_conv_all_nth list_all2_conv_all_nth list_all_length qtable_def
          wf_tuple_restrict_simple<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ fv_subset'<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> mmulti_join <span class="free">n</span> <span class="free">A_pos</span> <span class="free">A_neg</span> <span class="free">L</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">C</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">unfolding</span></span> L_eq in_join_iff take_eq drop_eq
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> pos'<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">Qi</span><span class="main">.</span> <span class="bound">Qi</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="free">A_pos</span> <span class="free">Q_pos</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> neg'<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">Qi</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">Qi</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="free">A_neg</span> <span class="free">Q_neg</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Qs<span class="main">[</span><span class="operator">THEN</span> iffD1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">A</span><span class="main">∈</span>set <span class="free">A_pos</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">C</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> C_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="main">(∈)</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="free">A_pos</span> <span class="free">L_pos</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pos pos' restrict_pos that<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all3_conv_all_nth list_all2_conv_all_nth list_all_length qtable_def
          C_eq wf_tuple_restrict_simple<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ Sup_upper<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="main">(∉)</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="free">A_neg</span> <span class="free">L_neg</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> neg neg' restrict_neg that<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all3_conv_all_nth list_all2_conv_all_nth list_all_length qtable_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nth_filter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">i'</span><span class="main">.</span> <span class="bound">i'</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> in_set_conv_nth set_filter mem_Collect_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_partition<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">i'</span><span class="main">.</span> <span class="bound">i'</span> <span class="main">&lt;</span> length <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">i'</span><span class="main">.</span> <span class="bound">i'</span> <span class="main">&lt;</span> length <span class="main">(</span>filter <span class="main">(</span>Not <span class="main">∘</span> <span class="free">P</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">(</span>filter <span class="main">(</span>Not <span class="main">∘</span> <span class="free">P</span><span class="main">)</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> in_set_conv_nth set_filter mem_Collect_eq comp_apply<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> qtable_bin_join<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q1</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">B</span> <span class="free">P</span> <span class="free">Q2</span> <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="free">A</span> <span class="main">∪</span> <span class="free">B</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">C</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span>restrict <span class="free">B</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">b</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">C</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">⟷</span> <span class="free">Q1</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="free">Q2</span> <span class="main">(</span>restrict <span class="free">B</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="free">b</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">C</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">⟷</span> <span class="free">Q1</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">Q2</span> <span class="main">(</span>restrict <span class="free">B</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">C</span> <span class="free">P</span> <span class="free">Q</span> <span class="main">(</span>bin_join <span class="free">n</span> <span class="free">A</span> <span class="free">X</span> <span class="free">b</span> <span class="free">B</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> qtable_join<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> bin_join_table<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> qtable_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> restrict_update<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">&lt;</span> length <span class="free">x</span> <span class="main">⟹</span> restrict <span class="free">A</span> <span class="main">(</span><span class="free">x</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span><span class="free">z</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> restrict <span class="free">A</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_list_update<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> qtable_assign<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">X</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">y</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> <span class="free">A</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x'</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">A'</span> <span class="bound">x'</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x'</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="bound">x'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q'</span> <span class="main">(</span><span class="bound">x</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>Some <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x'</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">A'</span> <span class="bound">x'</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x'</span> <span class="main">⟹</span> <span class="free">Q'</span> <span class="bound">x'</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">x'</span> <span class="main">!</span> <span class="free">y</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">f</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A'</span> <span class="free">P</span> <span class="free">Q'</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>Some <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"qtable <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="var">?Y</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> qtableI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> qtable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A'</span> <span class="var">?Y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> table_def wf_tuple_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_list_update<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="var">?Y</span>"</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A'</span> <span class="skolem">x'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x'</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>Some <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> qtable_def table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> length <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_tuple_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">A</span> <span class="skolem">x'</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> x'_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_update<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> restrict_idle<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">A'</span> <span class="skolem">x'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">x'</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> in_qtableE<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">x</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q'</span> <span class="skolem">x'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> x'_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A'</span> <span class="skolem">x'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q'</span> <span class="skolem">x'</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="skolem">x'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_tuple_restrict_simple<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="skolem">x'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">A'</span> <span class="skolem">x'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">x'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="skolem">x'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">!</span> <span class="free">y</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">f</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">A'</span> <span class="skolem">x'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">P</span> <span class="skolem">x'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Q'</span> <span class="skolem">x'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">A</span> <span class="skolem">x'</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> in_qtableI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">=</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span>Some <span class="main">(</span><span class="free">f</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="skolem">x'</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> y assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="skolem">x'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">A'</span> <span class="skolem">x'</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq wf_tuple_def nth_list_update nth_restrict<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">∈</span> <span class="var">?Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sat_the_update<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> fv <span class="free">φ</span> <span class="main">⟹</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="main">(</span><span class="free">x</span><span class="main">[</span><span class="free">y</span><span class="main">:=</span><span class="free">z</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">=</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="free">x</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sat_fv_cong<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> map_update nth_list_update_neq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> progress_constraint<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="free">P</span> <span class="main">(</span>formula_of_constraint <span class="free">c</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> formula_of_constraint.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> qtable_filter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">X</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">x</span> <span class="main">⟷</span> <span class="free">Q'</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q'</span> <span class="main">(</span>Set.filter <span class="free">R</span> <span class="free">X</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"qtable <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="var">?Y</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> qtableI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> qtable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A</span> <span class="var">?Y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> table_def wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?Y</span>"</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q'</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_qtableE<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q'</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> Set.filter <span class="free">R</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_qtableI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_constraint_sat_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="free">x</span> <span class="main">⟹</span> fv_trm <span class="free">t1</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> fv_trm <span class="free">t2</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span>
  <span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> eval_constraint <span class="main">(</span><span class="free">t1</span><span class="main">,</span> <span class="free">p</span><span class="main">,</span> <span class="free">c</span><span class="main">,</span> <span class="free">t2</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span>
    Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="free">x</span><span class="main">)</span> <span class="free">i</span> <span class="main">(</span>formula_of_constraint <span class="main">(</span><span class="free">t1</span><span class="main">,</span> <span class="free">p</span><span class="main">,</span> <span class="free">c</span><span class="main">,</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t1</span><span class="main">,</span> <span class="free">p</span><span class="main">,</span> <span class="free">c</span><span class="main">,</span> <span class="free">t2</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> formula_of_constraint.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> meval_trm_eval_trm<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> progress_le_gen<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_envs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"
  <span class="comment1">― ‹σ : trace›</span>
  Formula.trace <span class="main">⇒</span>
  <span class="comment1">― ‹j : current ts›</span>
  nat <span class="main">⇒</span>
  <span class="comment1">― ‹δ : number of new ts that are read in one step›</span>
  nat <span class="main">⇒</span>
  <span class="comment1">― ‹P : number of tables outputted for φ (p/let) after reading in  j      timestamps (progress)›</span>
  <span class="main">(</span>Formula.name <span class="main">⇀</span> nat<span class="main">)</span> <span class="main">⇒</span>
  <span class="comment1">― ‹P': number of tables outputted for φ (p/let) after reading in (j + δ) timestamps (progress)›</span>
  <span class="main">(</span>Formula.name <span class="main">⇀</span> nat<span class="main">)</span> <span class="main">⇒</span>
  <span class="comment1">― ‹V: tables of φ›</span>
  <span class="main">(</span>Formula.name <span class="main">⇀</span> <span class="main">(</span>nat <span class="main">⇒</span> event_data list set<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span>
  <span class="comment1">― ‹db: tables of σ and for predicates p (let overrides predicates in trace)›</span>
  Formula.database <span class="main">⇒</span>
  bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">wf_envs</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">=</span>
  <span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">=</span> dom <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span>
  <span class="comment1">― ‹db should contain all of P (until j) and the ones in between j and j + δ =&gt; until j + δ›</span>
   Mapping.keys <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">=</span> dom <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">..&lt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">}</span><span class="main">.</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> fst <span class="main">`</span> Γ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">k</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span>
  <span class="comment1">― ‹the number of tables outputted after j+δ has to be greater or equal to the number of tables outputted after j›</span>
   rel_mapping <span class="main">(≤)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main">∧</span>
  <span class="comment1">― ‹at j no more than j tables could have been outputted›</span>
   pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span>
  <span class="comment1">― ‹at j+δ no more than j+δ tables could have been outputted›</span>
   pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="main">∧</span>
  <span class="comment1">― ‹the keys of db without the ones until j equals the databases in between j and j + δ›</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> Mapping.keys <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">-</span> dom <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> the <span class="main">(</span>Mapping.lookup <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">{</span><span class="bound">ts</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">∈</span> Γ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">k</span><span class="main">}</span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">..&lt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">=</span> the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="bound">p</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">..&lt;</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P'</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>the <span class="main">(</span>Mapping.lookup <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">lift_definition</span></span> mk_db <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Formula.name <span class="main">×</span> event_data list<span class="main">)</span> set <span class="main">⇒</span> Formula.database"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">X</span> <span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">p</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="bound">X</span> <span class="keyword1">then</span> Some <span class="main">[</span><span class="main">{</span><span class="bound">ts</span><span class="main">.</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">}</span><span class="main">]</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf_envs_mk_db<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_envs <span class="free">σ</span> <span class="free">j</span> <span class="main">1</span> Map.empty Map.empty Map.empty <span class="main">(</span>mk_db <span class="main">(</span>Γ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_envs_def mk_db_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff rel_mapping_alt<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_envs_update<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf_envs<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_envs <span class="free">σ</span> <span class="free">j</span> <span class="free">δ</span> <span class="free">P</span> <span class="free">P'</span> <span class="free">V</span> <span class="free">db</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> m_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> Formula.nfv <span class="free">φ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> in_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="free">m</span><span class="main">}</span> <span class="main">⊆</span> fv <span class="free">φ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="free">m</span> <span class="main">(</span>Formula.fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr UNIV<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free">P'</span> <span class="free">φ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_envs <span class="free">σ</span> <span class="free">j</span> <span class="free">δ</span> <span class="main">(</span><span class="free">P</span><span class="main">(</span><span class="free">p</span> <span class="main">↦</span> progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">P'</span><span class="main">(</span><span class="free">p</span> <span class="main">↦</span> progress <span class="free">σ</span> <span class="free">P'</span> <span class="free">φ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="free">V</span><span class="main">(</span><span class="free">p</span> <span class="main">↦</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> length <span class="bound">v</span> <span class="main">=</span> <span class="free">m</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="bound">v</span> <span class="bound">i</span> <span class="free">φ</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>Mapping.update <span class="free">p</span> <span class="main">(</span>map <span class="main">(</span>image <span class="main">(</span>map the<span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="free">db</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_envs_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> conjI ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 3
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_envs_def pred_mapping_alt progress_le progress_mono_gen
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_mapping_map_upd<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">p'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> dom <span class="free">P</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_envs_def lookup_update'<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">p'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> xs in_fv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> map the <span class="main">`</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> length <span class="bound">v</span> <span class="main">=</span> <span class="free">m</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="bound">v</span> <span class="bound">x</span> <span class="free">φ</span><span class="main">}</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free">P'</span> <span class="free">φ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> list.rel_mono_strong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_def nth_append
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_qtableE in_qtableI <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_eqI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"map Some <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">=</span> the <span class="main">(</span><span class="free">V</span> <span class="skolem">p'</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>the <span class="main">(</span><span class="free">P</span> <span class="skolem">p'</span><span class="main">)</span><span class="main">..&lt;</span>the <span class="main">(</span><span class="free">P'</span> <span class="skolem">p'</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>the <span class="main">(</span>Mapping.lookup <span class="free">db</span> <span class="skolem">p'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="skolem">p'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> that 7 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> dom <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> wf_envs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_envs_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.rel_map image_iff lookup_update'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main">:</span> wf_envs_def subset_iff›</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_envs_P_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
   <span class="quoted"><span class="quoted">"wf_envs <span class="free">σ</span> <span class="free">j</span> <span class="free">δ</span> <span class="free">P</span> <span class="free">P'</span> <span class="free">V</span> <span class="free">db</span> <span class="main">⟹</span> pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">j</span><span class="main">)</span> <span class="free">P</span>"</span></span>
   <span class="quoted"><span class="quoted">"wf_envs <span class="free">σ</span> <span class="free">j</span> <span class="free">δ</span> <span class="free">P</span> <span class="free">P'</span> <span class="free">V</span> <span class="free">db</span> <span class="main">⟹</span> pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="free">P'</span>"</span></span>
   <span class="quoted"><span class="quoted">"wf_envs <span class="free">σ</span> <span class="free">j</span> <span class="free">δ</span> <span class="free">P</span> <span class="free">P'</span> <span class="free">V</span> <span class="free">db</span> <span class="main">⟹</span> rel_mapping <span class="main">(≤)</span> <span class="free">P</span> <span class="free">P'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_envs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_envs_progress_le<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
   <span class="quoted"><span class="quoted">"wf_envs <span class="free">σ</span> <span class="free">j</span> <span class="free">δ</span> <span class="free">P</span> <span class="free">P'</span> <span class="free">V</span> <span class="free">db</span> <span class="main">⟹</span> progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
   <span class="quoted"><span class="quoted">"wf_envs <span class="free">σ</span> <span class="free">j</span> <span class="free">δ</span> <span class="free">P</span> <span class="free">P'</span> <span class="free">V</span> <span class="free">db</span> <span class="main">⟹</span> progress <span class="free">σ</span> <span class="free">P'</span> <span class="free">φ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_envs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_envs_progress_regex_le<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
   <span class="quoted"><span class="quoted">"wf_envs <span class="free">σ</span> <span class="free">j</span> <span class="free">δ</span> <span class="free">P</span> <span class="free">P'</span> <span class="free">V</span> <span class="free">db</span> <span class="main">⟹</span> progress_regex <span class="free">σ</span> <span class="free">P</span> <span class="free">r</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
   <span class="quoted"><span class="quoted">"wf_envs <span class="free">σ</span> <span class="free">j</span> <span class="free">δ</span> <span class="free">P</span> <span class="free">P'</span> <span class="free">V</span> <span class="free">db</span> <span class="main">⟹</span> progress_regex <span class="free">σ</span> <span class="free">P'</span> <span class="free">r</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_envs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> progress_regex_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_envs_progress_mono<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
   <span class="quoted"><span class="quoted">"wf_envs <span class="free">σ</span> <span class="free">j</span> <span class="free">δ</span> <span class="free">P</span> <span class="free">P'</span> <span class="free">V</span> <span class="free">db</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span> progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ</span> <span class="free">a</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="free">P'</span> <span class="free">φ</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_envs_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> progress_mono_gen<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> qtable_wf_tuple_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="bound">v</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">v</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">Q'</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟹</span> qtable <span class="free">n</span> <span class="free">B</span> <span class="free">P</span> <span class="free">Q'</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> qtable_def table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all2_replicate<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span> <span class="main">(</span>replicate <span class="free">m</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span> <span class="main">⟷</span> length <span class="free">xs</span> <span class="main">=</span> <span class="free">m</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">.</span> <span class="free">R</span> <span class="free">x</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_conv_all_nth<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_all2_replicate2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span> <span class="free">xs</span> <span class="main">(</span>replicate <span class="free">m</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> length <span class="free">xs</span> <span class="main">=</span> <span class="free">m</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">.</span> <span class="free">R</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_conv_all_nth<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> maux<span class="main">)</span> wf_mformula_release<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="free">P</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">φ</span> <span class="main">(</span>release_safe_0 <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">φ</span> <span class="keyword1">of</span> <span class="main">(</span>MOr <span class="bound">α</span> <span class="bound">β</span> <span class="bound">buf</span><span class="main">)</span> <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_mformula.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> release_safe_0_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zip_map_el<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free">xs</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv in_set_zip nth_map snd_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> drop_filter_memR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> mem<span class="main">:</span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> filter_IH<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">#</span><span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">nat</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> drop_IH<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> drop <span class="skolem">nat</span> <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> filter_IH
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">db</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True mem
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.case_eq_if<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> mem
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True mem
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">!</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">xs</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> atLeastLessThan_iff case_prod_beta' in_set_conv_nth leI not_less_zero<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">!</span><span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">!</span><span class="main">0</span><span class="main">)</span> <span class="main">≤</span> fst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">!</span><span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> j_props
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> memR_antimono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> take_filter_not_memR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> take <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">=</span> take <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">#</span><span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">#</span><span class="main">(</span>take <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> not_mem<span class="main">:</span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> filter_IH<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> takeWhile_IH<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> take <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">nat</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> takeWhile_IH<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="main">(</span>take <span class="skolem">nat</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> takeWhile_IH
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">db</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">db</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> filter_IH
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> takeWhile_IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">!</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">xs</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> atLeastLessThan_iff case_prod_beta' in_set_conv_nth leI not_less_zero<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">!</span><span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">!</span><span class="main">0</span><span class="main">)</span> <span class="main">≤</span> fst <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">!</span><span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> j_props
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span>memR <span class="free">I</span> <span class="main">(</span><span class="free">mt</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> memR_antimono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> not_mem <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zip_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">P</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="bound">xs</span><span class="main">]</span> <span class="bound">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="bound">xs</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> case_prodD case_prodI2 diff_zero in_set_impl_in_set_zip2 length_upt set_zip_rightD<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> zip_idx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">P</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="bound">xs</span><span class="main">]</span> <span class="bound">xs</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">xs</span><span class="main">!</span><span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prodI2 map_nth zip_map_el<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> memR_impl_pred<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟹</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="free">j</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> memR_impl<span class="main">:</span> <span class="quoted"><span class="quoted">"memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟹</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> memR_antimono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"args_ivl <span class="free">args</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> max_memR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span><span class="main">≤</span><span class="free">k</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> Max <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> A_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k'</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">k'</span> <span class="main">&gt;</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> k'_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">&gt;</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> A_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> k_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> Max <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> A_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Max_eqI finite_nat_set_iff_bounded_le le_less_linear<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">lemma</span></span> eq_memR<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span><span class="main">&lt;</span><span class="free">k</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">{</span>Min <span class="free">A</span><span class="main">..</span>Max <span class="free">A</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> A_props<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> non_empty
    <span class="keyword1"><span class="command">unfolding</span></span> A_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Min <span class="free">A</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A_props
    <span class="keyword1"><span class="command">unfolding</span></span> j_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> A_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span>Min <span class="free">A</span><span class="main">..</span>Max <span class="free">A</span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>Min <span class="free">A</span><span class="main">..</span>Max <span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> Max <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="free">A</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> A_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> j_def assm
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">≥</span> τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> j_props memR_antimono
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> A_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> Min <span class="free">A</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A_props
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&gt;</span> Max <span class="free">A</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A_props
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> A_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span>Min <span class="free">A</span><span class="main">..</span>Max <span class="free">A</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> A_props Min_eq_iff atLeastAtMost_iff eq_Max_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">{</span>Min <span class="free">A</span><span class="main">..</span>Max <span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> proj_tuple_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">bs</span><span class="main">!</span><span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">bs</span> <span class="main">=</span> length <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>proj_tuple <span class="free">bs</span> <span class="free">t</span><span class="main">)</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> <span class="free">t</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> proj_tuple.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">bs</span> <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">bs</span> <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_mono_zip<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> before<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P1</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> impl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P1</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">P2</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P2</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> eq_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">x</span> <span class="main">=</span> length <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> before
    <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P2</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="free">x</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P2</span> <span class="skolem">a</span> <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> before impl
      <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> maux<span class="main">)</span> update_trigger<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf_trigger<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_trigger_aux <span class="free">σ</span> <span class="free">V</span> <span class="free">R</span> <span class="free">args</span> <span class="free">γ</span> <span class="free">β</span> <span class="free">aux</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> qtable_X<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>fv <span class="free">γ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">k</span> <span class="free">γ</span><span class="main">)</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> qtable_Y<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>fv <span class="free">β</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">k</span> <span class="free">β</span><span class="main">)</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> args_n<span class="main">:</span> <span class="quoted"><span class="quoted">"args_n <span class="free">args</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> args_L<span class="main">:</span> <span class="quoted"><span class="quoted">"args_L <span class="free">args</span> <span class="main">=</span> fv <span class="free">γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> args_R<span class="main">:</span> <span class="quoted"><span class="quoted">"args_R <span class="free">args</span> <span class="main">=</span> fv <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_trigger_aux <span class="free">σ</span> <span class="free">V</span> <span class="free">R</span> <span class="free">args</span> <span class="free">γ</span> <span class="free">β</span> <span class="main">(</span><span class="free">update_mtaux</span> <span class="free">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span><span class="main">)</span> <span class="free">X</span> <span class="free">Y</span> <span class="free">aux</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> table<span class="main">:</span>
    <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span> <span class="free">X</span>"</span></span>
    <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="free">Y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> qtable_X qtable_Y args_n args_L args_R
    <span class="keyword1"><span class="command">unfolding</span></span> qtable_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cur</span></span> <span class="skolem"><span class="skolem">auxlist</span></span> <span class="keyword2"><span class="keyword">where</span></span> wf_trigger_before<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Formula.fv <span class="free">γ</span> <span class="main">⊆</span> Formula.fv <span class="free">β</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">valid_mtaux</span> <span class="free">args</span> <span class="skolem">cur</span> <span class="free">aux</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">cur</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">k</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">≤</span> fst <span class="bound">y</span><span class="main">)</span> <span class="skolem">auxlist</span>"</span></span>
    <span class="quoted"><span class="quoted">"length <span class="skolem">auxlist</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">auxlist</span><span class="main">]</span> <span class="skolem">auxlist</span><span class="main">)</span><span class="main">.</span>
      <span class="free">k</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span>
      <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">∧</span>
      <span class="bound">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span>
      qtable <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free">γ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">γ</span><span class="main">)</span> <span class="bound">l</span>  <span class="main">∧</span>
      qtable <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free">β</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">β</span><span class="main">)</span> <span class="bound">r</span>
     "</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span>
        <span class="free">k</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span>
        <span class="bound">i</span> <span class="main">≤</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>
        <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">auxlist</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span>
    "</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_trigger
    <span class="keyword1"><span class="command">unfolding</span></span> wf_trigger_aux_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cur'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cur'</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">k</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">auxlist'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">auxlist'</span> <span class="main">=</span> <span class="skolem">auxlist</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">cur'</span><span class="main">,</span> <span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span><span class="main">]</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">auxlist</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_trigger_before<span class="main">(</span>6<span class="main">)</span> zip_P<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">auxlist</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">k</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> auxlist_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">auxlist</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> le_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sorted_auxlist'<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">≤</span> fst <span class="bound">y</span><span class="main">)</span> <span class="skolem">auxlist'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_trigger_before<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def cur'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_wrt_append<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sorted<span class="main">:</span>
    <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="skolem">auxlist</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_trigger_before<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_map<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> auxlist_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">auxlist'</span> <span class="main">=</span> Suc <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_trigger_before<span class="main">(</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> auxlist_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">auxlist'</span><span class="main">]</span> <span class="skolem">auxlist'</span><span class="main">)</span><span class="main">.</span>
      Suc <span class="free">k</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span>
      <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">∧</span>
      <span class="bound">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">k</span> <span class="main">∧</span>
      qtable <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free">γ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">γ</span><span class="main">)</span> <span class="bound">l</span>  <span class="main">∧</span>
      qtable <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free">β</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">β</span><span class="main">)</span> <span class="bound">r</span>
     "</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">t</span> <span class="skolem">l</span> <span class="skolem">r</span>
      <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">auxlist'</span><span class="main">]</span> <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">auxlist'</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> set_zip_leftD
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"Suc <span class="free">k</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span>
        <span class="skolem">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="skolem">i</span> <span class="main">∧</span>
        <span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">k</span> <span class="main">∧</span>
        qtable <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free">γ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="free">γ</span><span class="main">)</span> <span class="skolem">l</span>  <span class="main">∧</span>
        qtable <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free">β</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="free">β</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">auxlist</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">auxlist</span><span class="main">]</span> <span class="skolem">auxlist</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assm zip_idx<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">auxlist'</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="skolem">i</span> <span class="main">∧</span>
           <span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span>
           qtable <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>fv <span class="free">γ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="free">γ</span><span class="main">)</span> <span class="skolem">l</span> <span class="main">∧</span>
           qtable <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>fv <span class="free">β</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="free">β</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> wf_trigger_before<span class="main">(</span>6<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> True wf_trigger_before<span class="main">(</span>5<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> length <span class="skolem">auxlist</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> i_mem
          <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">cur'</span><span class="main">,</span> <span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assm zip_idx<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">auxlist'</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> qtable_X qtable_Y args_n wf_trigger_before<span class="main">(</span>5<span class="main">)</span> i_eq
          <span class="keyword1"><span class="command">unfolding</span></span> cur'_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> auxlist_mem<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span>
        Suc <span class="free">k</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span>
        <span class="bound">i</span> <span class="main">≤</span> <span class="free">k</span>
        <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">auxlist'</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span>
    "</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">auxlist'</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">auxlist</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> wf_trigger_before<span class="main">(</span>7<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">X'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">auxlist</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">X'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">auxlist'</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> nth_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">auxlist</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="skolem">cur'</span><span class="main">,</span> <span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> wf_trigger_before<span class="main">(</span>5<span class="main">)</span> True
          <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> exI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">X'</span><span class="main">.</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">,</span> <span class="bound">X'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">auxlist'</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> length <span class="skolem">auxlist'</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms wf_trigger_before<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">cur'</span><span class="main">,</span> <span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">auxlist'</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> cur'_def
          <span class="keyword1"><span class="command">using</span></span> exI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">X'</span><span class="main">.</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">,</span> <span class="bound">X'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">auxlist'</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span>"</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> False
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cur'</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cur'</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cur'</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cur'</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_trigger_before<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> cur'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> memR_impl_pred memR_zero zero_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> filter_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cur'</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cur'</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">have</span></span> filter_simp<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cur'</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">cur'</span><span class="main">,</span> <span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cur'</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">auxlist</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">cur'</span><span class="main">,</span> <span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> filter_filter
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_simp<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">valid_mtaux</span> <span class="free">args</span> <span class="skolem">cur'</span> <span class="main">(</span><span class="free">update_mtaux</span> <span class="free">args</span> <span class="skolem">cur'</span> <span class="free">X</span> <span class="free">Y</span> <span class="free">aux</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cur'</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">cur'</span><span class="main">,</span> <span class="free">X</span><span class="main">,</span> <span class="free">Y</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_trigger_before<span class="main">(</span>3<span class="main">)</span> valid_update_mtaux<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">cur</span></span> <span class="quoted"><span class="skolem">cur'</span></span> <span class="quoted"><span class="free">args</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quoted"><span class="free">aux</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cur</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> _ table wf_trigger_before<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> cur'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">valid_mtaux</span> <span class="free">args</span> <span class="skolem">cur'</span> <span class="main">(</span><span class="free">update_mtaux</span> <span class="free">args</span> <span class="skolem">cur'</span> <span class="free">X</span> <span class="free">Y</span> <span class="free">aux</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cur'</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">auxlist'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def
    <span class="keyword1"><span class="command">using</span></span> filter_simp
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> valid_mtaux<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Formula.fv <span class="free">γ</span> <span class="main">⊆</span> Formula.fv <span class="free">β</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">valid_mtaux</span> <span class="free">args</span> <span class="skolem">cur'</span> <span class="main">(</span><span class="free">update_mtaux</span> <span class="free">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span><span class="main">)</span> <span class="free">X</span> <span class="free">Y</span> <span class="free">aux</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cur'</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">cur'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> τ <span class="free">σ</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_trigger_before<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist'_def cur'_def Let_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_simp <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_trigger_aux <span class="free">σ</span> <span class="free">V</span> <span class="free">R</span> <span class="free">args</span> <span class="free">γ</span> <span class="free">β</span> <span class="main">(</span><span class="free">update_mtaux</span> <span class="free">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span><span class="main">)</span> <span class="free">X</span> <span class="free">Y</span> <span class="free">aux</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sorted_auxlist' auxlist_props auxlist_mem auxlist_len
    <span class="keyword1"><span class="command">unfolding</span></span> wf_trigger_aux_def diff_Suc_1
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> maux<span class="main">)</span> trigger_sat_equiv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> restr<span class="main">:</span> <span class="quoted"><span class="quoted">"mem_restr <span class="free">R</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf_x<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> args_pos <span class="free">args</span> <span class="keyword1">then</span> <span class="free">α</span> <span class="main">=</span> <span class="free">γ</span> <span class="keyword1">else</span> <span class="free">α</span> <span class="main">=</span> formula.Neg <span class="free">γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> args_n<span class="main">:</span> <span class="quoted"><span class="quoted">"args_n <span class="free">args</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> args_ivl<span class="main">:</span> <span class="quoted"><span class="quoted">"args_ivl <span class="free">args</span> <span class="main">=</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> args_L<span class="main">:</span> <span class="quoted"><span class="quoted">"args_L <span class="free">args</span> <span class="main">=</span> fv <span class="free">γ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> args_R<span class="main">:</span> <span class="quoted"><span class="quoted">"args_R <span class="free">args</span> <span class="main">=</span> fv <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fvi_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> mem <span class="free">I</span> <span class="main">0</span> <span class="keyword1">then</span> fv <span class="free">γ</span> <span class="main">⊆</span> fv <span class="free">β</span> <span class="keyword1">else</span> fv <span class="free">γ</span> <span class="main">=</span> fv <span class="free">β</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fv_l_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="free">β</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_mtaux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">valid_mtaux</span> <span class="free">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">update_mtaux</span> <span class="free">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span><span class="main">)</span> <span class="free">X</span> <span class="free">Y</span> <span class="free">aux</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sorted<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">≤</span> fst <span class="bound">y</span><span class="main">)</span> <span class="free">auxlist'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> auxlist_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">auxlist'</span> <span class="main">=</span> Suc <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> auxlist_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">auxlist'</span><span class="main">]</span> <span class="free">auxlist'</span><span class="main">)</span><span class="main">.</span>
       Suc <span class="free">k</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span>
       <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">∧</span>
       <span class="bound">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">k</span> <span class="main">∧</span>
       qtable <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>fv <span class="free">γ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">γ</span><span class="main">)</span> <span class="bound">l</span> <span class="main">∧</span>
       qtable <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>fv <span class="free">β</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">β</span><span class="main">)</span> <span class="bound">r</span>
    <span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">assumes</span></span> auxlist_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span>
        Suc <span class="free">k</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span>
        <span class="bound">i</span> <span class="main">≤</span> <span class="free">k</span>
        <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">=</span> <span class="free">auxlist'</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span>
    <span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">assumes</span></span> non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist'</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
   <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> snd <span class="main">(</span>trigger_results <span class="free">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="free">x</span><span class="main">)</span> <span class="free">k</span> <span class="main">(</span>formula.Trigger <span class="free">α</span> <span class="free">I</span> <span class="free">β</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> sorted<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="free">auxlist'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sorted sorted_map
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">offset</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">offset</span> <span class="main">=</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> offset_leq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">offset</span> <span class="main">≤</span> length <span class="free">auxlist'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">auxlist''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">auxlist''</span> <span class="main">=</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> auxlist''_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">auxlist''</span> <span class="main">=</span> drop <span class="skolem">offset</span> <span class="free">auxlist'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> drop_filter_memR<span class="main">[</span><span class="operator">OF</span> sorted<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"args_ivl <span class="free">args</span>"</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">k</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> offset_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> auxlist'_filter_sum<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist'</span><span class="main">)</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist'</span><span class="main">)</span> <span class="main">=</span> length <span class="free">auxlist'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_length_filter_compl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">auxlist'</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> idx_shift<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">auxlist''</span> <span class="main">⟹</span> <span class="skolem">auxlist''</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="free">auxlist'</span><span class="main">!</span><span class="main">(</span><span class="skolem">offset</span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">offset</span> <span class="main">+</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">auxlist'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist''_eq
    <span class="keyword1"><span class="command">using</span></span> nth_drop<span class="main">[</span><span class="operator">OF</span> offset_leq<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> idx_shift_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span>length <span class="free">auxlist'</span> <span class="main">⟹</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">auxlist'</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">auxlist'</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="skolem">auxlist''</span><span class="main">!</span><span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="skolem">offset</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="skolem">offset</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">auxlist''</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span>length <span class="free">auxlist'</span>"</span></span> <span class="quoted"><span class="quoted">"memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">auxlist'</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> i_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">auxlist'</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">auxlist''</span> <span class="main">+</span> <span class="skolem">offset</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms auxlist'_filter_sum
      <span class="keyword1"><span class="command">unfolding</span></span> auxlist''_def offset_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> <span class="skolem">offset</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">offset</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">auxlist'</span><span class="main">!</span><span class="skolem">i</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="skolem">offset</span> <span class="free">auxlist'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> i_mem
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeastLessThan_iff image_eqI nth_image offset_leq<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">offset</span> <span class="free">auxlist'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> take_filter_not_memR<span class="main">[</span><span class="operator">OF</span> sorted<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"args_ivl <span class="free">args</span>"</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">k</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">unfolding</span></span> offset_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">auxlist'</span><span class="main">!</span><span class="skolem">i</span> <span class="main">∈</span> set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">auxlist'</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> not_le_imp_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">offset</span><span class="main">..&lt;</span>length <span class="skolem">auxlist''</span> <span class="main">+</span> <span class="skolem">offset</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="skolem">offset</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">auxlist''</span><span class="main">}</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">auxlist''</span><span class="main">!</span><span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="skolem">offset</span><span class="main">)</span> <span class="main">=</span> <span class="free">auxlist'</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> idx_shift
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">auxlist'</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="skolem">auxlist''</span><span class="main">!</span><span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="skolem">offset</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="skolem">offset</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">auxlist''</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> filter_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist''</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist''_def filter_filter
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prod_beta'<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> snd <span class="main">(</span>trigger_results <span class="free">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span><span class="main">)</span> <span class="skolem">auxlist''</span><span class="main">)</span>"</span></span>



  <span class="keyword1"><span class="command">have</span></span> z_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="main">{</span>
    <span class="bound">tuple</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="bound">tuple</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="skolem">auxlist''</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
        <span class="keyword1">let</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">auxlist''</span><span class="main">!</span><span class="bound">i</span> <span class="keyword1">in</span>
        mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span> 
        <span class="main">(</span>
          <span class="bound">tuple</span> <span class="main">∈</span> <span class="bound">r</span> <span class="main">∨</span>
          <span class="main">(</span><span class="main">∃</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">&lt;..&lt;</span><span class="main">(</span>length <span class="skolem">auxlist''</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
            join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>fst <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">(</span><span class="skolem">auxlist''</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="main">(</span>join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span><span class="main">)</span> <span class="bound">tuple</span><span class="main">)</span>
          <span class="main">)</span>
        <span class="main">)</span>
      <span class="main">)</span>
    <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> non_empty filter_inv
    <span class="keyword1"><span class="command">unfolding</span></span> z_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> fv_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="free">γ</span> <span class="main">⊆</span> fv <span class="free">β</span> "</span></span> <span class="keyword1"><span class="command">using</span></span> fvi_subset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">proj_x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">proj_x</span> <span class="main">=</span> proj_tuple <span class="main">(</span>join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> len_x<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">x</span> <span class="main">=</span> args_n <span class="free">args</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_x
    <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">have</span></span> restr_proj_x<span class="main">:</span> <span class="quoted"><span class="quoted">"mem_restr <span class="free">R</span> <span class="skolem">proj_x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> restr
    <span class="keyword1"><span class="command">unfolding</span></span> proj_x_def proj_tuple_join_mask_restrict<span class="main">[</span><span class="operator">OF</span> len_x<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> len_x_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_x
    <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def join_mask_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> join_mask_fv_γ<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>proj_tuple <span class="main">(</span>join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>fv <span class="free">γ</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">x</span> <span class="main">∧</span> join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>fv <span class="free">γ</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> fv <span class="free">γ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> wf_x args_n args_R args_L fvi_subset fv_l_n mem
    <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def join_mask_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> proj_tuple_alt <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> wf_proj_x<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>fv <span class="free">γ</span><span class="main">)</span> <span class="skolem">proj_x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_x
    <span class="keyword1"><span class="command">unfolding</span></span> proj_x_def proj_tuple_join_mask_restrict<span class="main">[</span><span class="operator">OF</span> len_x<span class="main">]</span> args_R args_L
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fv_subset wf_tuple_restrict_simple<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> proj_sat_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j''</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="free">x</span><span class="main">)</span> <span class="bound">j''</span> <span class="free">γ</span> <span class="main">=</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="skolem">proj_x</span><span class="main">)</span> <span class="bound">j''</span> <span class="free">γ</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sat_fv_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> nth_map wf_x args_L args_R fv_l_n fvi_subset proj_tuple_nth<span class="main">[</span><span class="operator">OF</span> _ _ len_x_eq<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> proj_x_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_tuple_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> join_mask_fv_γ<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">z</span> <span class="main">=</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="free">x</span><span class="main">)</span> <span class="free">k</span> <span class="main">(</span>formula.Trigger <span class="free">α</span> <span class="free">I</span> <span class="free">β</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> auxlist_trigger<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="skolem">auxlist''</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
        <span class="keyword1">let</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">auxlist''</span><span class="main">!</span><span class="bound">i</span> <span class="keyword1">in</span>
        mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span> 
        <span class="main">(</span>
          <span class="free">x</span> <span class="main">∈</span> <span class="bound">r</span> <span class="main">∨</span>
          <span class="main">(</span><span class="main">∃</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">&lt;..&lt;</span><span class="main">(</span>length <span class="skolem">auxlist''</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
            join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>fst <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">(</span><span class="skolem">auxlist''</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="main">(</span>join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>
          <span class="main">)</span>
        <span class="main">)</span>
      <span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> z_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> i_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">=</span> <span class="free">auxlist'</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> allE<span class="main">[</span><span class="operator">OF</span> auxlist_mem<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> lr_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">auxlist'</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> memR<span class="main">:</span> <span class="quoted"><span class="quoted">"memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> <span class="main">(</span>fst <span class="main">(</span><span class="free">auxlist'</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> i_props<span class="main">[</span><span class="operator">folded</span> args_ivl<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fstI<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> i_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">auxlist'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> i_props<span class="main">(</span>1<span class="main">)</span> auxlist_len
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">-</span> <span class="skolem">offset</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> j_props<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="free">auxlist'</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">auxlist''</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">auxlist''</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> idx_shift_rev<span class="main">[</span><span class="operator">OF</span> i_mem memR<span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> j_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lr_j_props<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="skolem">auxlist''</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> i_props<span class="main">(</span>2<span class="main">)</span> lr_props args_ivl
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">auxlist''</span> <span class="main">!</span> <span class="skolem">j</span>
            <span class="keyword1">in</span> mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span>
            <span class="free">x</span> <span class="main">∈</span> <span class="bound">r</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="skolem">j</span><span class="main">&lt;..&lt;</span>length <span class="skolem">auxlist''</span><span class="main">}</span><span class="main">.</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span><span class="skolem">auxlist''</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="main">(</span>join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>
        <span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ballE<span class="main">[</span><span class="operator">OF</span> auxlist_trigger<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> j_props<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">r</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="skolem">j</span><span class="main">&lt;..&lt;</span>length <span class="skolem">auxlist''</span><span class="main">}</span><span class="main">.</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span><span class="skolem">auxlist''</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="main">(</span>join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> lr_j_props
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> x_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">auxlist'</span><span class="main">]</span> <span class="free">auxlist'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> lr_props i_mem in_set_conv_nth
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"qtable <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>fv <span class="free">β</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="free">β</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> auxlist_props
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="free">x</span><span class="main">)</span> <span class="skolem">i</span> <span class="free">β</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> x_mem restr 
          <span class="keyword1"><span class="command">unfolding</span></span> qtable_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="skolem">j</span><span class="main">&lt;..&lt;</span>length <span class="skolem">auxlist''</span><span class="main">}</span><span class="main">.</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span><span class="skolem">auxlist''</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="main">(</span>join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> j'_props<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="skolem">j'</span><span class="main">∈</span><span class="main">{</span><span class="skolem">j</span><span class="main">&lt;..&lt;</span>length <span class="skolem">auxlist''</span><span class="main">}</span>"</span></span>
          <span class="quoted"><span class="quoted">"join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span><span class="skolem">auxlist''</span> <span class="main">!</span> <span class="skolem">j'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="main">(</span>join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j''</span> <span class="main">=</span> <span class="skolem">offset</span> <span class="main">+</span> <span class="skolem">j'</span>"</span></span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">auxlist''</span> <span class="main">=</span> length <span class="free">auxlist'</span> <span class="main">-</span> <span class="skolem">offset</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> auxlist'_filter_sum
          <span class="keyword1"><span class="command">unfolding</span></span> offset_def auxlist''_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span><span class="main">∈</span><span class="main">{</span><span class="skolem">i</span> <span class="main">-</span> <span class="skolem">offset</span><span class="main">&lt;..&lt;</span>length <span class="free">auxlist'</span> <span class="main">-</span> <span class="skolem">offset</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> j'_props<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> j_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j''_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j''</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span><span class="main">&lt;..&lt;</span>length <span class="free">auxlist'</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> j''_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> tlr_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">auxlist''</span> <span class="main">!</span> <span class="skolem">j'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span><span class="skolem">auxlist''</span> <span class="main">!</span> <span class="skolem">j'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_def fst_conv snd_conv tlr_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> join_cond<span class="main">:</span> <span class="quoted"><span class="quoted">"join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="skolem">l</span> <span class="main">(</span>proj_tuple <span class="main">(</span>join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> j'_props<span class="main">(</span>2<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        
        <span class="keyword1"><span class="command">have</span></span> j'_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span><span class="main">&lt;</span>length <span class="skolem">auxlist''</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> j'_props
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> k_shift<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">auxlist''</span> <span class="main">!</span> <span class="skolem">j'</span> <span class="main">=</span> <span class="free">auxlist'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j''</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> idx_shift<span class="main">[</span><span class="operator">OF</span> j'_l<span class="main">]</span>
          <span class="keyword1"><span class="command">unfolding</span></span> j''_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tlr_eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">auxlist'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j''</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> tlr_eq
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">j''</span><span class="main">,</span> <span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">auxlist'</span><span class="main">]</span> <span class="free">auxlist'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> j'_l j''_mem
          <span class="keyword1"><span class="command">using</span></span> in_set_zip
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> qtable<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>fv <span class="free">γ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">j''</span> <span class="free">γ</span><span class="main">)</span> <span class="skolem">l</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> auxlist_props
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="free">x</span><span class="main">)</span> <span class="skolem">j''</span> <span class="free">α</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"args_pos <span class="free">args</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">proj_x</span> <span class="main">∈</span> <span class="skolem">l</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> True join_cond
            <span class="keyword1"><span class="command">unfolding</span></span> proj_x_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="skolem">proj_x</span><span class="main">)</span> <span class="skolem">j''</span> <span class="free">γ</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> qtable restr_proj_x
            <span class="keyword1"><span class="command">unfolding</span></span> qtable_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> proj_sat_equiv True pos
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> not_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">proj_x</span> <span class="main">∉</span> <span class="skolem">l</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> join_cond
            <span class="keyword1"><span class="command">unfolding</span></span> proj_x_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="free">x</span><span class="main">)</span> <span class="skolem">j''</span> <span class="free">γ</span> "</span></span>
            <span class="keyword1"><span class="command">using</span></span> not_mem qtable restr_proj_x proj_sat_equiv wf_proj_x
            <span class="keyword1"><span class="command">unfolding</span></span> qtable_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> False pos
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j''</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span> <span class="main">&lt;..</span> <span class="free">k</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> j''_mem auxlist_len
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span> <span class="main">&lt;..</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="free">x</span><span class="main">)</span> <span class="bound">k</span> <span class="free">α</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="free">x</span><span class="main">)</span> <span class="skolem">i</span> <span class="free">β</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span> <span class="main">&lt;..</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="free">x</span><span class="main">)</span> <span class="bound">k</span> <span class="free">α</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="free">x</span><span class="main">)</span> <span class="free">k</span> <span class="main">(</span>formula.Trigger <span class="free">α</span> <span class="free">I</span> <span class="free">β</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="free">x</span><span class="main">)</span> <span class="free">k</span> <span class="main">(</span>formula.Trigger <span class="free">α</span> <span class="free">I</span> <span class="free">β</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="free">k</span><span class="main">.</span> <span class="main">(</span>mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="free">x</span><span class="main">)</span> <span class="bound">j</span> <span class="free">β</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">j</span> <span class="main">&lt;..</span> <span class="free">k</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="free">x</span><span class="main">)</span> <span class="bound">k</span> <span class="free">α</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="free">args</span><span class="main">)</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf_x
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">auxlist''</span><span class="main">}</span><span class="main">.</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">auxlist''</span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">in</span>
        mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="free">x</span> <span class="main">∈</span> <span class="bound">r</span> <span class="main">∨</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span><span class="main">&lt;..&lt;</span>length <span class="skolem">auxlist''</span><span class="main">}</span><span class="main">.</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span><span class="skolem">auxlist''</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="main">(</span>join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> fst <span class="main">(</span><span class="skolem">auxlist''</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="main">(</span>fst <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">(</span><span class="skolem">auxlist''</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span>snd <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">(</span><span class="skolem">auxlist''</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">offset</span> <span class="main">+</span> <span class="skolem">i</span>"</span></span>

        <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">auxlist''</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        
        <span class="keyword1"><span class="command">have</span></span> i'_props<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="skolem">auxlist''</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">auxlist'</span> <span class="main">!</span> <span class="skolem">i'</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="free">auxlist'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> idx_shift<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> assm<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> i'_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">l</span><span class="main">,</span><span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">auxlist''</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> t_def l_def r_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X'</span></span> <span class="keyword2"><span class="keyword">where</span></span> X'_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">i'</span><span class="main">,</span> <span class="skolem">X'</span><span class="main">)</span> <span class="main">=</span> <span class="free">auxlist'</span> <span class="main">!</span> <span class="skolem">i'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> allE<span class="main">[</span><span class="operator">OF</span> auxlist_mem<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i'</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">i'</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">=</span> <span class="free">auxlist'</span> <span class="main">!</span> <span class="skolem">i'</span>"</span></span><span class="main">]</span> auxlist_len i'_props<span class="main">(</span>2<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> tlr_props<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="skolem">i'</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">auxlist'</span> <span class="main">!</span> <span class="skolem">i'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assm<span class="main">(</span>2<span class="main">)</span> args_ivl
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="free">x</span><span class="main">)</span> <span class="skolem">i'</span> <span class="free">β</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="skolem">i'</span><span class="main">&lt;..</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="free">x</span><span class="main">)</span> <span class="bound">k</span> <span class="free">α</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> sat i'_props<span class="main">(</span>2<span class="main">)</span> auxlist_len
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="free">x</span><span class="main">)</span> <span class="skolem">i'</span> <span class="free">β</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i'</span><span class="main">,</span> <span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">auxlist'</span><span class="main">]</span> <span class="free">auxlist'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> i'_props tlr_props<span class="main">(</span>2<span class="main">)</span> in_set_zip
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"qtable <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>fv <span class="free">β</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i'</span> <span class="free">β</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> auxlist_props
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">r</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> wf_x<span class="main">[</span><span class="operator">unfolded</span> args_R<span class="main">]</span> restr assm
            <span class="keyword1"><span class="command">unfolding</span></span> qtable_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="skolem">i'</span><span class="main">&lt;..</span><span class="free">k</span><span class="main">}</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="free">x</span><span class="main">)</span> <span class="bound">k</span> <span class="free">α</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">∈</span><span class="main">{</span><span class="skolem">i'</span><span class="main">&lt;..</span><span class="free">k</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="free">x</span><span class="main">)</span> <span class="skolem">j</span> <span class="free">α</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> tlr_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">auxlist'</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_cases3<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> j_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">auxlist'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> j_props<span class="main">(</span>1<span class="main">)</span> auxlist_len
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="free">auxlist'</span><span class="main">]</span> <span class="free">auxlist'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> in_set_zip <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> qtable<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>fv <span class="free">γ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">j</span> <span class="free">γ</span><span class="main">)</span> <span class="skolem">l</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> auxlist_props
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">-</span> <span class="skolem">offset</span>"</span></span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">auxlist''</span> <span class="main">+</span> <span class="skolem">offset</span> <span class="main">=</span> Suc <span class="free">k</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> auxlist'_filter_sum auxlist_len
            <span class="keyword1"><span class="command">unfolding</span></span> offset_def auxlist''_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">∈</span><span class="main">{</span><span class="skolem">offset</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">&lt;..&lt;</span>length <span class="skolem">auxlist''</span> <span class="main">+</span> <span class="skolem">offset</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> j_props<span class="main">(</span>1<span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span> i'_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j'_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span><span class="main">&lt;..&lt;</span>length <span class="skolem">auxlist''</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> j'_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">auxlist''</span> <span class="main">!</span> <span class="skolem">j'</span> <span class="main">=</span> <span class="free">auxlist'</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> idx_shift
            <span class="keyword1"><span class="command">unfolding</span></span> j'_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tlr_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">auxlist''</span> <span class="main">!</span> <span class="skolem">j'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> tlr_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="skolem">i</span><span class="main">&lt;..&lt;</span>length <span class="skolem">auxlist''</span><span class="main">}</span><span class="main">.</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span><span class="skolem">auxlist''</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="main">(</span>join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"args_pos <span class="free">args</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sat<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="skolem">proj_x</span><span class="main">)</span> <span class="skolem">j</span> <span class="free">γ</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> j_props pos proj_sat_equiv
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">proj_x</span> <span class="main">∈</span> <span class="skolem">l</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> qtable restr_proj_x wf_proj_x
              <span class="keyword1"><span class="command">unfolding</span></span> qtable_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">proj_x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span><span class="skolem">auxlist''</span> <span class="main">!</span> <span class="skolem">j'</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> tlr_eq
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_def fst_conv snd_conv<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="skolem">i</span><span class="main">&lt;..&lt;</span>length <span class="skolem">auxlist''</span><span class="main">}</span><span class="main">.</span> <span class="skolem">proj_x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span><span class="skolem">auxlist''</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> j'_mem
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> True
              <span class="keyword1"><span class="command">unfolding</span></span> proj_x_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sat<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="skolem">proj_x</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">(</span>Formula.Neg <span class="free">γ</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> j_props pos proj_sat_equiv
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">proj_x</span> <span class="main">∉</span> <span class="skolem">l</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> qtable restr_proj_x wf_proj_x
              <span class="keyword1"><span class="command">unfolding</span></span> qtable_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">proj_x</span> <span class="main">∉</span> <span class="main">(</span><span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span><span class="skolem">auxlist''</span> <span class="main">!</span> <span class="skolem">j'</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> tlr_eq
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> comp_def fst_conv snd_conv<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="skolem">i</span><span class="main">&lt;..&lt;</span>length <span class="skolem">auxlist''</span><span class="main">}</span><span class="main">.</span> <span class="skolem">proj_x</span> <span class="main">∉</span> <span class="main">(</span><span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span><span class="skolem">auxlist''</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> j'_mem
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">using</span></span> False
              <span class="keyword1"><span class="command">unfolding</span></span> proj_x_def
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">r</span> <span class="main">∨</span>
         <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="skolem">i</span><span class="main">&lt;..&lt;</span>length <span class="skolem">auxlist''</span><span class="main">}</span><span class="main">.</span> join_cond <span class="main">(</span>args_pos <span class="free">args</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>fst <span class="main">∘</span> snd<span class="main">)</span> <span class="main">(</span><span class="skolem">auxlist''</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="main">(</span>join_mask <span class="main">(</span>args_n <span class="free">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="free">args</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Let_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf
      <span class="keyword1"><span class="command">unfolding</span></span> z_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fv <span class="free">β</span> <span class="main">=</span> fst <span class="main">(</span>trigger_results <span class="free">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="free">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">k</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">auxlist'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> non_empty args_R filter_inv
    <span class="keyword1"><span class="command">unfolding</span></span> auxlist''_def trigger_results.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> non_empty
    <span class="keyword1"><span class="command">unfolding</span></span> z_def auxlist''_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> maux<span class="main">)</span> meval<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="free">P</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="free">φ</span> <span class="free">φ'</span>"</span></span> <span class="quoted"><span class="quoted">"wf_envs <span class="free">σ</span> <span class="free">j</span> <span class="free">δ</span> <span class="free">P</span> <span class="free">P'</span> <span class="free">V</span> <span class="free">db</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> meval <span class="free">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="free">db</span> <span class="free">φ</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">⇒</span> wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="free">P'</span> <span class="free">V</span> <span class="free">n</span> <span class="free">R</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ'</span> <span class="main">∧</span>
    list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="main">(</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>Formula.fv <span class="free">φ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="free">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">φ'</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>
    <span class="main">[</span>progress <span class="free">σ</span> <span class="free">P</span> <span class="free">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free">P'</span> <span class="free">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="bound">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">φ'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">db</span></span> <span class="quoted"><span class="free">P'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> wf_mformula.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eq <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="skolem">n</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">R</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ball_Un <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_mformula.intros<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> fvi.simps<span class="main"><span class="main">]</span></span> table_eq_rel eq_rel_eval_trm
        in_eq_rel qtable_empty qtable_unit_table <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtableI<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>neq_Var <span class="skolem">x</span> <span class="skolem">n</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">R</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ball_Un <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_mformula.intros<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> fvi.simps<span class="main"><span class="main">]</span></span> table_eq_rel eq_rel_eval_trm
        in_eq_rel qtable_empty qtable_unit_table <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtableI<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pred <span class="skolem">e</span> <span class="skolem">tms</span> <span class="skolem">n</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">R</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> dom <span class="skolem">P</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> Pred<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> e_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> Mapping.keys <span class="skolem">db</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> dom <span class="skolem">P'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> dom <span class="skolem">V</span>"</span></span>
      <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">=</span> the <span class="main">(</span><span class="skolem">V</span> <span class="skolem">e</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>the <span class="main">(</span><span class="skolem">P</span> <span class="skolem">e</span><span class="main">)</span><span class="main">..&lt;</span>the <span class="main">(</span><span class="skolem">P'</span> <span class="skolem">e</span><span class="main">)</span><span class="main">]</span>
         <span class="main">(</span>the <span class="main">(</span>Mapping.lookup <span class="skolem">db</span> <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wf_envs_def rel_mapping_alt <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> True e_props Pred<span class="main">(</span>1-2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Pred qtableI bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">_</span> <span class="main">=</span> tabulate <span class="bound">x</span> <span class="main">0</span> <span class="skolem">n</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> refl<span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.rel_mono_strong bexI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ex_match
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list.rel_map table_def match_wf_tuple in_these_eq match_eval_trm image_iff
        list.map_comp keys_dom_lookup<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">note</span></span> Pred<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> False Pred<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> e_not_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∉</span> dom <span class="skolem">P'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∉</span> dom <span class="skolem">V</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> wf_envs_def rel_mapping_alt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> False Pred<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">}</span><span class="main">.</span> fst <span class="main">`</span> Γ <span class="free">σ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">⟷</span> <span class="skolem">e</span> <span class="main">∈</span> Mapping.keys <span class="skolem">db</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> wf_envs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> False Pred<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> Mapping.keys <span class="skolem">db</span> <span class="main">⟹</span> Mapping.lookup <span class="skolem">db</span> <span class="skolem">e</span> <span class="main">=</span> Some <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">{</span><span class="bound">ts</span><span class="main">.</span> <span class="main">(</span><span class="skolem">e</span><span class="main">,</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">∈</span> Γ <span class="free">σ</span> <span class="bound">k</span><span class="main">}</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> wf_envs_def keys_dom_lookup <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_iff domD option.sel<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> db_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="skolem">db</span> <span class="skolem">e</span> <span class="keyword1">of</span> None <span class="main">⇒</span> replicate <span class="free">δ</span> <span class="main">{}</span> <span class="main">|</span> Some <span class="bound">xs</span> <span class="main">⇒</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">=</span>
      map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">{</span><span class="bound">ts</span><span class="main">.</span> <span class="main">(</span><span class="skolem">e</span><span class="main">,</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">∈</span> Γ <span class="free">σ</span> <span class="bound">k</span><span class="main">}</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">}</span><span class="main">.</span> fst <span class="main">`</span> Γ <span class="free">σ</span> <span class="bound">k</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff keys_dom_lookup list.rel_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> list.rel_map
         <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> list.rel_refl <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="main">(</span>MPred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">α</span> <span class="main">=</span> snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="main">(</span>MPred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> pair_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="main">(</span>MPred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">α</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> xs_def α_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> α_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">α</span> <span class="main">=</span> <span class="main">(</span>MPred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Pred<span class="main">(</span>1<span class="main">)</span> α_def meval.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">α</span> <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf_mformula.Pred<span class="main">[</span><span class="operator">OF</span> Pred<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> α_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> xs_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> Table.tabulate <span class="bound">f</span> <span class="main">0</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">`</span> Option.these
        <span class="main">(</span>match <span class="skolem">tms</span> <span class="main">`</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="skolem">db</span> <span class="skolem">e</span> <span class="keyword1">of</span> None <span class="main">⇒</span> replicate <span class="main">(</span>length <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> empty_table <span class="main">|</span> Some <span class="bound">xs</span> <span class="main">⇒</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> xs_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> <span class="free">δ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> db_props
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span>
               length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False e_not_mem
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">.</span>
      qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span><span class="main">)</span> <span class="bound">r</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">r</span>
        <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mems<span class="main">:</span>
          <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> set <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> set_zip_leftD set_zip_rightD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

        <span class="keyword1"><span class="command">have</span></span> i_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> set <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False e_not_mem mems<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> Pred<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> assm'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> assm False e_not_mem mems<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> Pred<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">db</span> <span class="skolem">e</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> None
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> replicate <span class="main">(</span>length <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> Table.tabulate <span class="bound">f</span> <span class="main">0</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">`</span> Option.these <span class="main">(</span>match <span class="skolem">tms</span> <span class="main">`</span> empty_table<span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> xs_eq
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> r_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> mems<span class="main">(</span>2<span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span> empty_table_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> qtable1<span class="main">:</span>
            <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">r</span> <span class="main">⟹</span> wf_tuple <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟹</span> mem_restr <span class="skolem">R</span> <span class="bound">x</span> <span class="main">⟹</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">x</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list.rel_map table_def match_wf_tuple in_these_eq match_eval_trm image_iff<span class="main">)</span>
          
          <span class="keyword1"><span class="command">have</span></span> Γ_props<span class="main">:</span> <span class="quoted"><span class="quoted">"replicate <span class="free">δ</span> <span class="main">{}</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">{</span><span class="bound">ts</span><span class="main">.</span> <span class="main">(</span><span class="skolem">e</span><span class="main">,</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">∈</span> Γ <span class="free">σ</span> <span class="bound">k</span><span class="main">}</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> None db_props
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> qtable2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> wf_tuple <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟹</span> mem_restr <span class="skolem">R</span> <span class="bound">x</span> <span class="main">⟹</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">x</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
            <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"mem_restr <span class="skolem">R</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="skolem">x</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="skolem">V</span> <span class="skolem">e</span> <span class="keyword1">of</span>
               None <span class="main">⇒</span> <span class="main">(</span><span class="skolem">e</span><span class="main">,</span> map <span class="main">(</span>Formula.eval_trm <span class="main">(</span>map the <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tms</span><span class="main">)</span> <span class="main">∈</span> Γ <span class="free">σ</span> <span class="skolem">i</span>
             <span class="main">|</span> Some <span class="bound">X</span> <span class="main">⇒</span> map <span class="main">(</span>Formula.eval_trm <span class="main">(</span>map the <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tms</span> <span class="main">∈</span> <span class="bound">X</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> Pred<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">e</span><span class="main">,</span> map <span class="main">(</span>Formula.eval_trm <span class="main">(</span>map the <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tms</span><span class="main">)</span> <span class="main">∈</span> Γ <span class="free">σ</span> <span class="skolem">i</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> e_not_mem
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">ts</span><span class="main">.</span> <span class="main">(</span><span class="skolem">e</span><span class="main">,</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">∈</span> Γ <span class="free">σ</span> <span class="skolem">i</span><span class="main">}</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">{</span><span class="bound">ts</span><span class="main">.</span> <span class="main">(</span><span class="skolem">e</span><span class="main">,</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">∈</span> Γ <span class="free">σ</span> <span class="bound">k</span><span class="main">}</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> i_mem
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">{</span><span class="bound">ts</span><span class="main">.</span> <span class="main">(</span><span class="skolem">e</span><span class="main">,</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">∈</span> Γ <span class="free">σ</span> <span class="bound">k</span><span class="main">}</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> Γ_props
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_replicate<span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">ts</span><span class="main">.</span> <span class="main">(</span><span class="skolem">e</span><span class="main">,</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">∈</span> Γ <span class="free">σ</span> <span class="skolem">i</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> Γ_props
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">r</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> non_empty
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>

          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> qtableI<span class="main">[</span><span class="operator">OF</span> qtable1 qtable2<span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">ys</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> xs_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> tabulate <span class="bound">f</span> <span class="main">0</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">`</span> Option.these <span class="main">(</span>match <span class="skolem">tms</span> <span class="main">`</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ys</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> xs_eq
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> ys_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">{</span><span class="bound">ts</span><span class="main">.</span> <span class="main">(</span><span class="skolem">e</span><span class="main">,</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">∈</span> Γ <span class="free">σ</span> <span class="bound">k</span><span class="main">}</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Some db_props
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> qtable1<span class="main">:</span>
            <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Pred<span class="main">(</span>1<span class="main">)</span> mems<span class="main">(</span>2<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> table_def match_wf_tuple in_these_eq<span class="main">)</span>

          <span class="keyword1"><span class="command">have</span></span> r_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> tabulate <span class="bound">x</span> <span class="main">0</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">`</span> Option.these <span class="main">(</span>match <span class="skolem">tms</span> <span class="main">`</span> <span class="main">{</span><span class="bound">ts</span><span class="main">.</span> <span class="main">(</span><span class="skolem">e</span><span class="main">,</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">∈</span> Γ <span class="free">σ</span> <span class="skolem">i</span><span class="main">}</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> zip_map_el<span class="main">[</span><span class="operator">OF</span> assm'<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> xs_eq ys_eq map_map<span class="main"><span class="main">]</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
           
          <span class="keyword1"><span class="command">have</span></span> qtable2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">r</span> <span class="main">⟹</span> wf_tuple <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟹</span> mem_restr <span class="skolem">R</span> <span class="bound">x</span> <span class="main">⟹</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">x</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">r</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">e</span><span class="main">,</span> map <span class="main">(</span>Formula.eval_trm <span class="main">(</span>map the <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tms</span><span class="main">)</span> <span class="main">∈</span> Γ <span class="free">σ</span> <span class="skolem">i</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> mems<span class="main">(</span>2<span class="main">)</span> i_mem Pred<span class="main">(</span>1<span class="main">)</span> r_eq
              <span class="keyword1"><span class="command">unfolding</span></span> xs_eq ys_eq
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ex_match <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list.rel_map in_these_eq match_eval_trm image_iff<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="skolem">x</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> e_not_mem
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>

          <span class="keyword1"><span class="command">have</span></span> qtable3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> wf_tuple <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟹</span> mem_restr <span class="skolem">R</span> <span class="bound">x</span> <span class="main">⟹</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">x</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
            <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"mem_restr <span class="skolem">R</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="skolem">x</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> Γ_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">e</span><span class="main">,</span> map <span class="main">(</span>Formula.eval_trm <span class="main">(</span>map the <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tms</span><span class="main">)</span> <span class="main">∈</span> Γ <span class="free">σ</span> <span class="skolem">i</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> e_not_mem
              <span class="keyword1"><span class="command">unfolding</span></span> Pred<span class="main">(</span>1<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="skolem">n</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>fv_trm <span class="main">`</span> set <span class="skolem">tms</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
              <span class="keyword1"><span class="command">unfolding</span></span> Pred<span class="main">(</span>1<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> fvs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set <span class="skolem">tms</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>fv_trm <span class="bound">t</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>trm.is_Var <span class="bound">t</span> <span class="main">∨</span> trm.is_Const <span class="bound">t</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> Pred<span class="main">(</span>1-2<span class="main">)</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f_props<span class="main">:</span>
              <span class="quoted"><span class="quoted">"match <span class="skolem">tms</span> <span class="main">(</span>map <span class="main">(</span>Formula.eval_trm <span class="main">(</span>map the <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tms</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">f</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> tabulate <span class="skolem">f</span> <span class="main">0</span> <span class="skolem">n</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> Γ_mem ex_match<span class="main">[</span><span class="operator">OF</span> wf fvs<span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"match <span class="skolem">tms</span> <span class="main">(</span>map <span class="main">(</span>Formula.eval_trm <span class="main">(</span>map the <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tms</span><span class="main">)</span> <span class="main">∈</span> match <span class="skolem">tms</span> <span class="main">`</span> <span class="main">{</span><span class="bound">ts</span><span class="main">.</span> <span class="main">(</span><span class="skolem">e</span><span class="main">,</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">∈</span> Γ <span class="free">σ</span> <span class="skolem">i</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> Γ_mem
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> Option.these <span class="main">(</span>match <span class="skolem">tms</span> <span class="main">`</span> <span class="main">{</span><span class="bound">ts</span><span class="main">.</span> <span class="main">(</span><span class="skolem">e</span><span class="main">,</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">∈</span> Γ <span class="free">σ</span> <span class="skolem">i</span><span class="main">}</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> in_these_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span>Option.these <span class="main">(</span>match <span class="skolem">tms</span> <span class="main">`</span> <span class="main">{</span><span class="bound">ts</span><span class="main">.</span> <span class="main">(</span><span class="skolem">e</span><span class="main">,</span> <span class="bound">ts</span><span class="main">)</span> <span class="main">∈</span> Γ <span class="free">σ</span> <span class="skolem">i</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> tabulate <span class="skolem">f</span> <span class="main">0</span> <span class="skolem">n</span> <span class="main">=</span> tabulate <span class="bound">x</span> <span class="main">0</span> <span class="skolem">n</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> f_props
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">r</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> f_props<span class="main">(</span>2<span class="main">)</span>
              <span class="keyword1"><span class="command">unfolding</span></span> xs_eq ys_eq Pred<span class="main">(</span>1<span class="main">)</span> r_eq
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>

          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> qtableI<span class="main">[</span><span class="operator">OF</span> qtable1 qtable2 qtable3<span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> qtableI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fv <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.Pred <span class="skolem">e</span> <span class="skolem">tms</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> wf pair_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Let <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">m</span> <span class="skolem">φ1</span> <span class="skolem">φ1'</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ2</span> <span class="skolem">φ2'</span> <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Let<span class="main">(</span>1-3<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
    1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">m</span> UNIV <span class="skolem">φ1</span> <span class="skolem">φ1'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    fv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> Formula.nfv <span class="skolem">φ1'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">m</span><span class="main">}</span> <span class="main">⊆</span> fv <span class="skolem">φ1'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    2<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="main">(</span><span class="skolem">P</span><span class="main">(</span><span class="skolem">p</span> <span class="main">↦</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ1'</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="skolem">V</span><span class="main">(</span><span class="skolem">p</span> <span class="main">↦</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> length <span class="bound">v</span> <span class="main">=</span> <span class="skolem">m</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="bound">v</span> <span class="bound">i</span> <span class="skolem">φ1'</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>
      <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ2</span> <span class="skolem">φ2'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">φ1_new</span></span> <span class="keyword2"><span class="keyword">where</span></span> e1<span class="main">:</span> <span class="quoted"><span class="quoted">"meval <span class="skolem">m</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">φ1_new</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      wf1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">m</span> UNIV <span class="skolem">φ1_new</span> <span class="skolem">φ1'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      res1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="main">(</span><span class="bound">r</span><span class="main">)</span><span class="main">.</span> qtable <span class="skolem">m</span> <span class="main">(</span>fv <span class="skolem">φ1'</span><span class="main">)</span> <span class="main">(</span>mem_restr UNIV<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">φ1'</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>
       <span class="main">[</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ1'</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ1'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Let.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Let.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> eqTrueI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mem_restr_UNIV<span class="main"><span class="main">,</span></span> <span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Let.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> wf_envs_update<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Let.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> fv res1<span class="main"><span class="main">]</span></span><span class="main">]</span> wf1 e1 fv
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Let <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_upd_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Let<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">ψ</span> <span class="skolem">ψ'</span> <span class="skolem">pos</span> <span class="skolem">χ</span> <span class="skolem">buf</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">⇒</span>
      wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ'</span> <span class="main">∧</span>
      list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="bound">xs</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">ψ</span> <span class="keyword1">of</span>
    <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">⇒</span>
      wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">ψ'</span> <span class="main">∧</span>
      list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">ψ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">ψ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="bound">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And.IH<span class="main">[</span><span class="operator">OF</span> And.prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> env<span class="main">:</span>
    <span class="quoted"><span class="quoted">"rel_mapping <span class="main">(≤)</span> <span class="skolem">P</span> <span class="skolem">P'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And.prems
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">φ''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ''</span> <span class="main">=</span> snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> xtuple_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">φ''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> xs_def φ''_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> φ_IH<span class="main">:</span>
    <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ''</span> <span class="skolem">φ'</span>"</span></span>
    <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xtuple_eq<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ψ''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ''</span> <span class="main">=</span> snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> ytuple_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ys</span><span class="main">,</span> <span class="skolem">ψ''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ys_def ψ''_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> ψ_IH<span class="main">:</span>
    <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">ψ''</span> <span class="skolem">ψ'</span>"</span></span>
    <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">ψ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">ψ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ytuple_eq<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="main">(</span>MAnd <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="skolem">φ</span> <span class="skolem">pos</span> <span class="main">(</span>fv <span class="skolem">ψ'</span><span class="main">)</span> <span class="skolem">ψ</span> <span class="skolem">buf</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">χ''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">χ''</span> <span class="main">=</span> snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="main">(</span>MAnd <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="skolem">φ</span> <span class="skolem">pos</span> <span class="main">(</span>fv <span class="skolem">ψ'</span><span class="main">)</span> <span class="skolem">ψ</span> <span class="skolem">buf</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> ztuple_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">χ''</span><span class="main">)</span> <span class="main">=</span> meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="main">(</span>MAnd <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="skolem">φ</span> <span class="skolem">pos</span> <span class="main">(</span>fv <span class="skolem">ψ'</span><span class="main">)</span> <span class="skolem">ψ</span> <span class="skolem">buf</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> zs_def χ''_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> zs_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> fst <span class="main">(</span>mbuf2_take <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r1</span><span class="main">)</span> <span class="main">(</span><span class="bound">r2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>bin_join <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="bound">r1</span> <span class="skolem">pos</span> <span class="main">(</span>fv <span class="skolem">ψ'</span><span class="main">)</span> <span class="bound">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mbuf2_add <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">buf</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xs_def ys_def
    <span class="keyword1"><span class="command">unfolding</span></span> zs_def meval.simps Let_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> xtuple_eq ytuple_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits if_splits<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">buf'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">buf'</span> <span class="main">=</span> snd <span class="main">(</span>mbuf2_take <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r1</span><span class="main">)</span> <span class="main">(</span><span class="bound">r2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>bin_join <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="bound">r1</span> <span class="skolem">pos</span> <span class="main">(</span>fv <span class="skolem">ψ'</span><span class="main">)</span> <span class="bound">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mbuf2_add <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">buf</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> mbuf2_take_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mbuf2_take <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r1</span><span class="main">)</span> <span class="main">(</span><span class="bound">r2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>bin_join <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="bound">r1</span> <span class="skolem">pos</span> <span class="main">(</span>fv <span class="skolem">ψ'</span><span class="main">)</span> <span class="bound">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mbuf2_add <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">buf</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">buf'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> zs_eq buf'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> χ''_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">χ''</span> <span class="main">=</span> <span class="main">(</span>MAnd <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="skolem">φ''</span> <span class="skolem">pos</span> <span class="main">(</span>fv <span class="skolem">ψ'</span><span class="main">)</span> <span class="skolem">ψ''</span> <span class="skolem">buf'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> χ''_def meval.simps Let_def buf'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> xtuple_eq ytuple_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits if_splits<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> buf_take_add_IH<span class="main">:</span>
    <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ'</span> <span class="skolem">ψ'</span> <span class="skolem">buf'</span>"</span></span>
    <span class="quoted"><span class="quoted">"list_all2
     <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">Z</span><span class="main">.</span> <span class="main">∃</span><span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="bound">X</span> <span class="main">∧</span>
                   qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">ψ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">ψ'</span><span class="main">)</span> <span class="bound">Y</span> <span class="main">∧</span> <span class="bound">Z</span> <span class="main">=</span> bin_join <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="bound">X</span> <span class="skolem">pos</span> <span class="main">(</span>fv <span class="skolem">ψ'</span><span class="main">)</span> <span class="bound">Y</span><span class="main">)</span>
     <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ'</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ'</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">ψ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="skolem">zs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mbuf2_take_add'<span class="main">[</span><span class="operator">OF</span> mbuf2_take_eq And<span class="main"><span class="main"><span class="main">(</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span> env<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> φ_IH<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> ψ_IH<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> env<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">χ''</span> <span class="skolem">χ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> χ''_eq
    <span class="keyword1"><span class="command">using</span></span> wf_mformula.And<span class="main">[</span><span class="operator">OF</span> φ_IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ψ_IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> And<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> buf_take_add_IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">χ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">χ</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">χ</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">χ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">zs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> progress_eq<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ'</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ'</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">ψ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span>
       <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">χ</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">χ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> And<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">χ</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">χ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> length <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> buf_take_add_IH<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">χ</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">χ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">⟹</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">χ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">χ</span><span class="main">)</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">Z</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">Z</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">χ</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">χ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">Z</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ'</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ'</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">ψ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> progress_eq
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="bound">X</span> <span class="main">∧</span>
                   qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">ψ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">ψ'</span><span class="main">)</span> <span class="bound">Y</span> <span class="main">∧</span> <span class="skolem">Z</span> <span class="main">=</span> bin_join <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="bound">X</span> <span class="skolem">pos</span> <span class="main">(</span>fv <span class="skolem">ψ'</span><span class="main">)</span> <span class="bound">Y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> buf_take_add_IH<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="keyword2"><span class="keyword">where</span></span> qtables<span class="main">:</span>
        <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="skolem">X</span>"</span></span>
        <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">ψ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">ψ'</span><span class="main">)</span> <span class="skolem">Y</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">=</span> bin_join <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="skolem">X</span> <span class="skolem">pos</span> <span class="main">(</span>fv <span class="skolem">ψ'</span><span class="main">)</span> <span class="skolem">Y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> fvs<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> <span class="skolem">pos</span> <span class="main">⟹</span> fv <span class="skolem">ψ'</span> <span class="main">⊆</span> fv <span class="skolem">φ'</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"fv <span class="skolem">χ</span> <span class="main">=</span> fv <span class="skolem">φ'</span> <span class="main">∪</span> fv <span class="skolem">ψ'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> And<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> qtable_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">pos</span> <span class="main">⟹</span>
        wf_tuple <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">χ</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟹</span>
        mem_restr <span class="skolem">R</span> <span class="bound">x</span> <span class="main">⟹</span>
        Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">x</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">χ</span> <span class="main">=</span> <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="main">(</span>restrict <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">φ'</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="main">(</span>restrict <span class="main">(</span>fv <span class="skolem">ψ'</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> And<span class="main">(</span>3<span class="main">)</span> sat_the_restrict
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> qtable_neg_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="skolem">pos</span> <span class="main">⟹</span>
        wf_tuple <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">χ</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟹</span>
        mem_restr <span class="skolem">R</span> <span class="bound">x</span> <span class="main">⟹</span>
        Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">x</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">χ</span> <span class="main">=</span> <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="main">(</span>restrict <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">φ'</span> <span class="main">∧</span> <span class="main">¬</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="main">(</span>restrict <span class="main">(</span>fv <span class="skolem">ψ'</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> And<span class="main">(</span>3<span class="main">)</span> sat_the_restrict
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">χ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">χ</span><span class="main">)</span> <span class="skolem">Z</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> qtables<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> qtable_bin_join<span class="main">[</span><span class="operator">OF</span> qtables<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> fvs _ qtable_pos qtable_neg_pos<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ztuple_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>AndAssign <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ''</span> <span class="skolem">x</span> <span class="skolem">t</span> <span class="skolem">conf</span> <span class="skolem">ψ''</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> AndAssign <span class="keyword1"><span class="command">have</span></span>
    wf_envs<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_envs <span class="free">σ</span> <span class="free">j</span> <span class="free">δ</span> <span class="skolem">P</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">db</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    wf_φ<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> fv <span class="skolem">φ''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    fv_t_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"fv_trm <span class="skolem">t</span> <span class="main">⊆</span> fv <span class="skolem">φ''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    conf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">conf</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ψ''_eqs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ''</span> <span class="main">=</span> formula.Eq <span class="main">(</span>trm.Var <span class="skolem">x</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">∨</span> <span class="skolem">ψ''</span> <span class="main">=</span> formula.Eq <span class="skolem">t</span> <span class="main">(</span>trm.Var <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> wf_φ wf_envs <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">φ<span class="hidden">⇩</span><sub>n</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span>
    meval_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    wf_φ<span class="hidden">⇩</span><sub>n</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    xs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ''</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">φ''</span><span class="main">)</span><span class="main">)</span>
        <span class="main">[</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ''</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> AndAssign.IH<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> progress_eqs<span class="main">:</span>
      <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.And <span class="skolem">φ''</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ''</span> <span class="free">j</span>"</span></span>
      <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.And <span class="skolem">φ''</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ψ''_eqs wf_envs_progress_le<span class="main">[</span><span class="operator">OF</span> wf_envs<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> meval_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>MAndAssign <span class="skolem">φ<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">conf</span><span class="main">)</span> <span class="main">(</span>formula.And <span class="skolem">φ''</span> <span class="skolem">ψ''</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_mformula.AndAssign<span class="main">)</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>formula.And <span class="skolem">φ''</span> <span class="skolem">ψ''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.And <span class="skolem">φ''</span> <span class="skolem">ψ''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">[</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.And <span class="skolem">φ''</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.And <span class="skolem">φ''</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(`)</span> <span class="main">(</span>eval_assignment <span class="skolem">conf</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> list.rel_map progress_eqs conf<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> eval_assignment.simps
      <span class="keyword1"><span class="command">using</span></span> xs
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> list.rel_mono_strong<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">X</span>
      <span class="keyword3"><span class="command">assume</span></span> qtable<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ''</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">φ''</span><span class="main">)</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>formula.And <span class="skolem">φ''</span> <span class="skolem">ψ''</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.And <span class="skolem">φ''</span> <span class="skolem">ψ''</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span><span class="main">[</span><span class="skolem">x</span> <span class="main">:=</span> Some <span class="main">(</span>meval_trm <span class="skolem">t</span> <span class="bound">y</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> qtable_assign<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">x</span> <span class="main">(</span>fv <span class="skolem">φ''</span><span class="main">)</span> <span class="main">=</span> fv <span class="main">(</span>formula.And <span class="skolem">φ''</span> <span class="skolem">ψ''</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ψ''_eqs fv_t_subset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> fv <span class="skolem">φ''</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
        <span class="keyword3"><span class="command">assume</span></span> wf_v<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>formula.And <span class="skolem">φ''</span> <span class="skolem">ψ''</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mem_restr <span class="skolem">R</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mem_restr <span class="skolem">R</span> <span class="main">(</span>restrict <span class="main">(</span>fv <span class="skolem">φ''</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

        <span class="keyword3"><span class="command">assume</span></span> sat<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.And <span class="skolem">φ''</span> <span class="skolem">ψ''</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="main">(</span>restrict <span class="main">(</span>fv <span class="skolem">φ''</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">φ''</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sat_the_restrict<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map the <span class="skolem">v</span> <span class="main">!</span> <span class="skolem">x</span> <span class="main">=</span> Formula.eval_trm <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> sat ψ''_eqs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Formula.eval_trm <span class="main">(</span>map the <span class="main">(</span>restrict <span class="main">(</span>fv <span class="skolem">φ''</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> fv_t_subset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_the_restrict <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eval_trm_fv_cong<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map the <span class="skolem">v</span> <span class="main">!</span> <span class="skolem">x</span> <span class="main">=</span> meval_trm <span class="skolem">t</span> <span class="main">(</span>restrict <span class="main">(</span>fv <span class="skolem">φ''</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> meval_trm_eval_trm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="quoted">"fv <span class="skolem">φ''</span>"</span></span> <span class="quoted"><span class="quoted">"restrict <span class="main">(</span>fv <span class="skolem">φ''</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
            fv_t_subset wf_v wf_mformula_wf_set<span class="main">[</span><span class="operator">unfolded</span> wf_set_def<span class="main">,</span> <span class="operator">OF</span> wf_φ<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_tuple_restrict<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">!</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span>meval_trm <span class="skolem">t</span> <span class="main">(</span>restrict <span class="main">(</span>fv <span class="skolem">φ''</span><span class="main">)</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> ψ''_eqs wf_v <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_def<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> A B <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">∧</span> <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
        <span class="keyword3"><span class="command">assume</span></span> wf_v<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ''</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mem_restr <span class="skolem">R</span> <span class="skolem">v</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> sat<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">φ''</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">[</span><span class="skolem">x</span> <span class="main">:=</span> Some <span class="main">(</span>meval_trm <span class="skolem">t</span> <span class="skolem">v</span><span class="main">)</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> sat <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="var">?v</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">φ''</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> fv <span class="skolem">φ''</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sat_the_update<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> fv_trm <span class="skolem">t</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
          <span class="keyword1"><span class="command">using</span></span> fv_t_subset <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∉</span> fv <span class="skolem">φ''</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="var">?v</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">ψ''</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ψ''_eqs meval_trm_eval_trm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="quoted">"fv <span class="skolem">φ''</span>"</span></span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>›</span></span>
            fv_t_subset wf_v wf_mformula_wf_set<span class="main">[</span><span class="operator">unfolded</span> wf_set_def<span class="main">,</span> <span class="operator">OF</span> wf_φ<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_def map_update <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eval_trm_fv_cong<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> A B <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="var">?v</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.And <span class="skolem">φ''</span> <span class="skolem">ψ''</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ''</span> <span class="main">∪</span> fv <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">φ''</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">ψ''</span><span class="main">)</span><span class="main">)</span>
     <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ''</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ''</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">ψ''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>
     <span class="main">(</span>map <span class="main">(</span><span class="main">(`)</span> <span class="main">(</span>eval_assignment <span class="skolem">conf</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>AndRel <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">ψ'</span> <span class="skolem">conf</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> progress_constraint progress_le list.rel_map fv_formula_of_constraint
      Un_absorb2 wf_mformula_wf_set<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> wf_set_def<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> AndRel.IH<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">P'</span></span> <span class="quoted"><span class="skolem">db</span></span><span class="main"><span class="main">]</span></span> eval_constraint_sat_eq<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.AndRel
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.rel_mono_strong qtable_filter eval_constraint_sat_eq<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_Trigger <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ'</span> <span class="skolem">φ</span> <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span> <span class="skolem">buf1</span> <span class="skolem">β'</span> <span class="skolem">args</span> <span class="skolem">γ</span> <span class="skolem">γ'</span> <span class="skolem">buf2</span> <span class="skolem">nts</span> <span class="skolem">aux</span><span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ'</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">φ''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ''</span> <span class="main">=</span> snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> xtuple_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">φ''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xs_def φ''_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> IH_φ<span class="main">:</span>
    <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ''</span> <span class="skolem">φ</span>"</span></span>
    <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_Trigger.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> And_Trigger.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> xtuple_eq<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">γ'</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">γ''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">γ''</span> <span class="main">=</span> snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">γ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> atuple_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">γ'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">as</span><span class="main">,</span> <span class="skolem">γ''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> as_def γ''_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> IH_γ<span class="main">:</span>
    <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">γ''</span> <span class="skolem">γ</span>"</span></span>
    <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">γ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">γ</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">γ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">as</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_Trigger.IH<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> And_Trigger.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> atuple_eq<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">=</span> fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">β'</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">β''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">β''</span> <span class="main">=</span> snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">β'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> btuple_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">β'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">bs</span><span class="main">,</span> <span class="skolem">β''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bs_def β''_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> IH_β<span class="main">:</span>
    <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">β''</span> <span class="skolem">β</span>"</span></span>
    <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">β</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">β</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">bs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_Trigger.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> And_Trigger.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> btuple_eq<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="main">(</span>MAndTrigger <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">φ'</span> <span class="skolem">buf1</span> <span class="skolem">args</span> <span class="skolem">γ'</span> <span class="skolem">β'</span> <span class="skolem">buf2</span> <span class="skolem">nts</span> <span class="skolem">aux</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">χ''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">χ''</span> <span class="main">=</span> snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="main">(</span>MAndTrigger <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">φ'</span> <span class="skolem">buf1</span> <span class="skolem">args</span> <span class="skolem">γ'</span> <span class="skolem">β'</span> <span class="skolem">buf2</span> <span class="skolem">nts</span> <span class="skolem">aux</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> ztuple_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="main">(</span>MAndTrigger <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">φ'</span> <span class="skolem">buf1</span> <span class="skolem">args</span> <span class="skolem">γ'</span> <span class="skolem">β'</span> <span class="skolem">buf2</span> <span class="skolem">nts</span> <span class="skolem">aux</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">χ''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> zs_def χ''_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> And_Trigger <span class="keyword1"><span class="command">have</span></span>
        pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> args_pos <span class="skolem">args</span> <span class="keyword1">then</span> <span class="skolem">α</span> <span class="main">=</span> <span class="skolem">γ</span> <span class="keyword1">else</span> <span class="skolem">α</span> <span class="main">=</span> formula.Neg <span class="skolem">γ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pos_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">α</span> <span class="main">=</span> args_pos <span class="skolem">args</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> γ<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">γ'</span> <span class="skolem">γ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> β<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">β'</span> <span class="skolem">β</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fvi_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> mem <span class="skolem">I</span> <span class="main">0</span> <span class="keyword1">then</span> fv <span class="skolem">γ</span> <span class="main">⊆</span> fv <span class="skolem">β</span> <span class="keyword1">else</span> fv <span class="skolem">γ</span> <span class="main">=</span> fv <span class="skolem">β</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> buf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="free">j</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">γ</span> <span class="skolem">β</span> <span class="skolem">buf2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nts<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_ts <span class="free">σ</span> <span class="skolem">P</span> <span class="free">j</span> <span class="skolem">γ</span> <span class="skolem">β</span> <span class="skolem">nts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_trigger_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">R</span> <span class="skolem">args</span> <span class="skolem">γ</span> <span class="skolem">β</span> <span class="skolem">aux</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_ivl<span class="main">:</span> <span class="quoted"><span class="quoted">"args_ivl <span class="skolem">args</span> <span class="main">=</span> <span class="skolem">I</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_n<span class="main">:</span> <span class="quoted"><span class="quoted">"args_n <span class="skolem">args</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_L<span class="main">:</span> <span class="quoted"><span class="quoted">"args_L <span class="skolem">args</span> <span class="main">=</span> fv <span class="skolem">γ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_R<span class="main">:</span> <span class="quoted"><span class="quoted">"args_R <span class="skolem">args</span> <span class="main">=</span> fv <span class="skolem">β</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fv_l_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="skolem">β</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fvs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> mem <span class="skolem">I</span> <span class="main">0</span> <span class="keyword1">then</span> fv <span class="skolem">γ</span> <span class="main">⊆</span> fv <span class="skolem">β</span> <span class="keyword1">else</span> fv <span class="skolem">γ</span> <span class="main">=</span> fv <span class="skolem">β</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> args_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"args_n <span class="skolem">args</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"args_R <span class="skolem">args</span> <span class="main">=</span> fv <span class="skolem">α</span> <span class="main">∪</span> fv <span class="skolem">β</span>"</span></span>
    <span class="quoted"><span class="quoted">"fv <span class="skolem">γ</span> <span class="main">=</span> fv <span class="skolem">α</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pos args_n args_L args_R fvi_subset
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tuple</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">=</span> mbuf2t_take <span class="main">(</span><span class="main">λ</span><span class="bound">r1</span> <span class="bound">r2</span> <span class="bound">t</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">let</span>
    <span class="bound">aux</span> <span class="main">=</span> <span class="free">update_mtaux</span> <span class="skolem">args</span> <span class="bound">t</span> <span class="bound">r1</span> <span class="bound">r2</span> <span class="bound">aux</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">fv_z</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">result_mtaux</span> <span class="skolem">args</span> <span class="bound">aux</span>
    <span class="keyword1">in</span>
      <span class="main">(</span><span class="bound">zs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="bound">fv_z</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span>
  <span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">aux</span><span class="main">)</span> <span class="main">(</span>mbuf2_add <span class="skolem">as</span> <span class="skolem">bs</span> <span class="skolem">buf2</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span>"</span></span>

  <span class="comment1">(*have zs_eq: "zs = fst (fst tuple)"
    unfolding tuple_def zs_def meval. simps Let_def xs_def ys_def
    by (auto split: prod.splits)*)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs'</span> <span class="main">=</span> fst <span class="main">(</span>fst <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">aux'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aux'</span> <span class="main">=</span> snd <span class="main">(</span>fst <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">buf2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">buf2'</span> <span class="main">=</span> fst <span class="main">(</span>snd <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">nts'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nts'</span> <span class="main">=</span> snd <span class="main">(</span>snd <span class="skolem">tuple</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> tuple_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">zs'</span><span class="main">,</span> <span class="skolem">aux'</span><span class="main">)</span><span class="main">,</span> <span class="skolem">buf2'</span><span class="main">,</span> <span class="skolem">nts'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> zs'_def aux'_def buf2'_def nts'_def Let_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="comment1">(*have η_eq: "η = MTrigger args γ' β' buf' nts' aux'"
    unfolding η_def meval.simps γ'_def β'_def aux'_def buf'_def nts'_def tuple_def xs_def ys_def Let_def
    by (auto split: prod.splits)*)</span>

  <span class="keyword1"><span class="command">have</span></span> pred_mapping<span class="main">:</span>
    <span class="quoted"><span class="quoted">"pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">P</span>"</span></span>
    <span class="quoted"><span class="quoted">"pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span>"</span></span>
    <span class="quoted"><span class="quoted">"rel_mapping <span class="main">(≤)</span> <span class="skolem">P</span> <span class="skolem">P'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_Trigger.prems<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> And_Trigger.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> nts_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span>
    <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nts
    <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> upt_add_eq_append<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_envs_progress_le<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> min.coboundedI1<span class="main"><span class="main">]</span></span> list.rel_map
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all2_appendI list.rel_refl<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> wf_buf_ts_trigger<span class="main">:</span>
    <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">γ</span> <span class="skolem">β</span> <span class="skolem">buf2'</span>"</span></span>
    <span class="quoted"><span class="quoted">"wf_ts <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">γ</span> <span class="skolem">β</span> <span class="skolem">nts'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mbuf2t_take_add'<span class="main">[</span><span class="operator">OF</span> tuple_eq<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">unfolded</span></span> tuple_def<span class="main"><span class="main"><span class="main">]</span></span></span> pred_mapping buf nts_snoc IH_γ<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> IH_β<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> α_γ_props<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.fv <span class="skolem">α</span> <span class="main">=</span> Formula.fv <span class="skolem">γ</span>"</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">α</span> <span class="skolem">j</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="skolem">j</span>"</span></span>
  <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">α</span> <span class="skolem">j</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">γ</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">using</span></span> pos
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> update_trigger<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_trigger_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">R</span> <span class="skolem">args</span> <span class="skolem">γ</span> <span class="skolem">β</span> <span class="main">(</span>snd <span class="main">(</span><span class="skolem">zs'</span><span class="main">,</span> <span class="skolem">aux'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="main">(</span><span class="bound">dfvs</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> wf_dfvs <span class="bound">dfvs</span> <span class="free">σ</span> <span class="skolem">I</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">∧</span> qtable <span class="skolem">n</span> <span class="bound">dfvs</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>
    <span class="main">[</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">zs'</span><span class="main">,</span> <span class="skolem">aux'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> progress_simps α_γ_props
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mbuf2t_take_add_induct'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> j'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">+</span> <span class="free">δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> z'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">zs'</span><span class="main">,</span> <span class="skolem">aux'</span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span>
      <span class="operator">OF</span> tuple_eq<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> tuple_def<span class="main"><span class="main">]</span></span> wf_envs_P_simps<span class="main"><span class="main">[</span></span><span class="operator">OF</span> And_Trigger.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> buf nts_snoc<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">goal_cases</span> xs ys _ base step<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> xs
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> IH_γ<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> ys
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> IH_β<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> base
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> aux α_γ_props
      <span class="keyword1"><span class="command">unfolding</span></span> progress_simps 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">k</span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">acc</span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> fst <span class="skolem">acc</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">aux</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aux</span> <span class="main">=</span> snd <span class="skolem">acc</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> z_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">acc</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">aux</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> zs_def aux_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> table<span class="main">:</span>
      <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="skolem">args</span><span class="main">)</span> <span class="skolem">X</span>"</span></span>
      <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="skolem">args</span><span class="main">)</span> <span class="skolem">Y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>4-5<span class="main">)</span> args_n args_L args_R
      <span class="keyword1"><span class="command">unfolding</span></span> qtable_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> wf_trigger<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_trigger_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">R</span> <span class="skolem">args</span> <span class="skolem">γ</span> <span class="skolem">β</span> <span class="skolem">aux</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>6<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> aux_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fv_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="skolem">γ</span> <span class="main">⊆</span> fv <span class="skolem">β</span> "</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> wf_trigger_aux_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> wf_trigger_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_trigger_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">R</span> <span class="skolem">args</span> <span class="skolem">γ</span> <span class="skolem">β</span> <span class="main">(</span><span class="free">update_mtaux</span> <span class="skolem">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">aux</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> update_trigger<span class="main">[</span><span class="operator">OF</span> wf_trigger step<span class="main"><span class="main">(</span></span>4-5<span class="main"><span class="main">)</span></span> args_n args_L args_R<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">auxlist'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      valid_mtaux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">valid_mtaux</span> <span class="skolem">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span><span class="free">update_mtaux</span> <span class="skolem">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">aux</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      sorted_wrt<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">≤</span> fst <span class="bound">y</span><span class="main">)</span> <span class="skolem">auxlist'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      auxlist_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">auxlist'</span> <span class="main">=</span> Suc <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      auxlist_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">auxlist'</span><span class="main">]</span> <span class="skolem">auxlist'</span><span class="main">)</span><span class="main">.</span>
         Suc <span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span>
         <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">∧</span>
         <span class="bound">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">∧</span>
         qtable <span class="main">(</span>args_n <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span>fv <span class="skolem">γ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">γ</span><span class="main">)</span> <span class="bound">l</span> <span class="main">∧</span>
         qtable <span class="main">(</span>args_n <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span>fv <span class="skolem">β</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">β</span><span class="main">)</span> <span class="bound">r</span>
      <span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      auxlist_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span>
          Suc <span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span>
          <span class="bound">i</span> <span class="main">≤</span> <span class="skolem">k</span>
          <span class="main">⟶</span>
          <span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">auxlist'</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span>
      <span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> wf_trigger_aux_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs'</span> <span class="main">=</span> fst <span class="main">(</span><span class="keyword1">let</span> <span class="bound">aux</span> <span class="main">=</span> <span class="free">update_mtaux</span> <span class="skolem">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">aux</span><span class="main">;</span> <span class="main">(</span><span class="bound">fv_z</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">result_mtaux</span> <span class="skolem">args</span> <span class="bound">aux</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="bound">fv_z</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">aux'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aux'</span> <span class="main">=</span> snd <span class="main">(</span><span class="keyword1">let</span> <span class="bound">aux</span> <span class="main">=</span> <span class="free">update_mtaux</span> <span class="skolem">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">aux</span><span class="main">;</span> <span class="main">(</span><span class="bound">fv_z</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">result_mtaux</span> <span class="skolem">args</span> <span class="bound">aux</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="bound">fv_z</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_trigger_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">R</span> <span class="skolem">args</span> <span class="skolem">γ</span> <span class="skolem">β</span> <span class="main">(</span>snd <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">acc</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">let</span> <span class="bound">aux</span> <span class="main">=</span> <span class="free">update_mtaux</span> <span class="skolem">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="bound">aux</span><span class="main">;</span> <span class="main">(</span><span class="bound">fv_z</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">result_mtaux</span> <span class="skolem">args</span> <span class="bound">aux</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="bound">fv_z</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf_trigger_aux
      <span class="keyword1"><span class="command">unfolding</span></span> z_eq Let_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">a</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">dfvs</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">⇒</span> wf_dfvs <span class="bound">dfvs</span> <span class="free">σ</span> <span class="skolem">I</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">∧</span> qtable <span class="skolem">n</span> <span class="bound">dfvs</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>
     <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>Suc <span class="skolem">k</span><span class="main">]</span>
     <span class="main">(</span>fst <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">acc</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">let</span> <span class="bound">aux</span> <span class="main">=</span> <span class="free">update_mtaux</span> <span class="skolem">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="bound">aux</span><span class="main">;</span> <span class="main">(</span><span class="bound">fv_z</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">result_mtaux</span> <span class="skolem">args</span> <span class="bound">aux</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="bound">fv_z</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> aux'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">aux'</span> <span class="main">=</span> <span class="free">update_mtaux</span> <span class="skolem">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">aux</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> aux'_def Let_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">fv_z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fv_z</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">result_mtaux</span> <span class="skolem">args</span> <span class="skolem">aux'</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">result_mtaux</span> <span class="skolem">args</span> <span class="skolem">aux'</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">auxlist''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">auxlist''</span> <span class="main">=</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> valid_mtaux'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">valid_mtaux</span> <span class="skolem">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">aux'</span> <span class="skolem">auxlist''</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq auxlist''_def
        <span class="keyword1"><span class="command">using</span></span> valid_mtaux
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> z_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> snd <span class="main">(</span>trigger_results <span class="skolem">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">auxlist''</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> z_def
        <span class="keyword1"><span class="command">using</span></span> valid_result_mtaux<span class="main">[</span><span class="operator">OF</span> valid_mtaux'<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> fv_z_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fv_z</span> <span class="main">=</span> fst <span class="main">(</span>trigger_results <span class="skolem">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">auxlist''</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> fv_z_def
        <span class="keyword1"><span class="command">using</span></span> valid_result_mtaux<span class="main">[</span><span class="operator">OF</span> valid_mtaux'<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> filter_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist''</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> auxlist''_def filter_filter
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prod_beta'<span class="main">)</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> non_empty<span class="main">:</span> True
        <span class="keyword1"><span class="command">have</span></span> equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="skolem">x</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
          restr<span class="main">:</span> <span class="quoted"><span class="quoted">"mem_restr <span class="skolem">R</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          wf_x<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="main">(</span>args_n <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="skolem">args</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
          <span class="keyword1"><span class="command">unfolding</span></span> z_eq auxlist''_def
          <span class="keyword1"><span class="command">using</span></span> trigger_sat_equiv<span class="main">[</span><span class="operator">OF</span> restr wf_x pos args_n args_ivl args_L args_R fvi_subset fv_l_n valid_mtaux sorted_wrt auxlist_len auxlist_props auxlist_mem non_empty<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">have</span></span> int_non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="skolem">k</span><span class="main">.</span> <span class="main">¬</span> mem <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">auxlist'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">auxlist'''</span> <span class="main">=</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">auxlist'''</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> auxlist'''_def
            <span class="keyword1"><span class="command">using</span></span> non_empty
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">auxlist'''</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> filter_True filter_empty_conv prod.exhaust<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span>
            <span class="quoted"><span class="quoted">"mem <span class="main">(</span>args_ivl <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">auxlist'</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> auxlist'''_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_props<span class="main">:</span>
            <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">auxlist'</span><span class="main">}</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">auxlist'</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeastLessThan_iff in_set_conv_nth zero_le<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">auxlist'</span><span class="main">]</span> <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> mem
            <span class="keyword1"><span class="command">using</span></span> in_set_zip <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> auxlist_len auxlist_props
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> mem<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> t_eq<span class="main">]</span> i_props<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> auxlist_len<span class="main">]</span> not_le_imp_less
            <span class="keyword1"><span class="command">unfolding</span></span> args_ivl
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fv_z</span> <span class="main">=</span> args_R <span class="skolem">args</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> non_empty filter_inv
          <span class="keyword1"><span class="command">unfolding</span></span> fv_z_eq auxlist''_def trigger_results.simps
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fv_z_eq''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fv_z</span> <span class="main">=</span> fv <span class="skolem">α</span> <span class="main">∪</span> fv <span class="skolem">β</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> args_props
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">result_mtaux</span> <span class="skolem">args</span> <span class="skolem">aux'</span> <span class="main">=</span> trigger_results <span class="skolem">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">auxlist''</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> valid_result_mtaux<span class="main">[</span><span class="operator">OF</span> valid_mtaux<span class="main">]</span>
          <span class="keyword1"><span class="command">unfolding</span></span> aux'_def auxlist''_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist''</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> filter_inv non_empty
          <span class="keyword1"><span class="command">unfolding</span></span> auxlist''_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> z_eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="main">{</span>
          <span class="bound">tuple</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="skolem">args</span><span class="main">)</span> <span class="bound">tuple</span> <span class="main">∧</span>
            <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="skolem">auxlist''</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
              <span class="keyword1">let</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">auxlist''</span><span class="main">!</span><span class="bound">i</span> <span class="keyword1">in</span>
              mem <span class="main">(</span>args_ivl <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span> 
              <span class="main">(</span>
                <span class="bound">tuple</span> <span class="main">∈</span> <span class="bound">r</span> <span class="main">∨</span>
                <span class="main">(</span><span class="main">∃</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">&lt;..&lt;</span><span class="main">(</span>length <span class="skolem">auxlist''</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
                  join_cond <span class="main">(</span>args_pos <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>fst <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">(</span><span class="skolem">auxlist''</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="main">(</span>join_mask <span class="main">(</span>args_n <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="skolem">args</span><span class="main">)</span><span class="main">)</span> <span class="bound">tuple</span><span class="main">)</span>
                <span class="main">)</span>
              <span class="main">)</span>
            <span class="main">)</span>
          <span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> z_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
        <span class="keyword1"><span class="command">have</span></span> args_R_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"args_R <span class="skolem">args</span> <span class="main">=</span> fv <span class="skolem">α</span> <span class="main">∪</span> fv <span class="skolem">β</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> args_L args_R pos fvi_subset
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> table<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">α</span> <span class="main">∪</span> fv <span class="skolem">β</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> z_eq'
          <span class="keyword1"><span class="command">unfolding</span></span> table_def args_R_simp args_n
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
        <span class="keyword1"><span class="command">have</span></span> correctness<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">z</span> <span class="main">⟹</span> wf_tuple <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">α</span> <span class="main">∪</span> fv <span class="skolem">β</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟹</span> mem_restr <span class="skolem">R</span> <span class="bound">x</span> <span class="main">⟹</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">x</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> equiv args_props
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
        <span class="keyword1"><span class="command">have</span></span> completeness<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> wf_tuple <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">α</span> <span class="main">∪</span> fv <span class="skolem">β</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟹</span> mem_restr <span class="skolem">R</span> <span class="bound">x</span> <span class="main">⟹</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">x</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">z</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> equiv args_props
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
        <span class="keyword1"><span class="command">have</span></span> qtable_k<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">α</span> <span class="main">∪</span> fv <span class="skolem">β</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> qtableI<span class="main">[</span><span class="operator">OF</span> table correctness completeness<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
        <span class="keyword1"><span class="command">have</span></span> zs'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs'</span> <span class="main">=</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">fv_z</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> zs'_def fv_z_def z_def aux'_eq  Let_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  
        <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2
          <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="main">(</span><span class="bound">dfvs</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> wf_dfvs <span class="bound">dfvs</span> <span class="free">σ</span> <span class="skolem">I</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">∧</span> qtable <span class="skolem">n</span> <span class="bound">dfvs</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>
          <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span> <span class="skolem">zs</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>6<span class="main">)</span> zs_def args_props<span class="main">(</span>3<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span> <span class="main">=</span> length <span class="skolem">zs</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>Suc <span class="skolem">k</span><span class="main">]</span> <span class="main">=</span> length <span class="skolem">zs'</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> zs'_eq length_append
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="main">(</span><span class="bound">dfvs</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>Suc <span class="skolem">k</span><span class="main">]</span> <span class="skolem">zs'</span><span class="main">)</span><span class="main">.</span>
        wf_dfvs <span class="bound">dfvs</span> <span class="free">σ</span> <span class="skolem">I</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">∧</span>
        qtable <span class="skolem">n</span> <span class="bound">dfvs</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">dfvs</span> <span class="skolem">r</span>
            <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="main">(</span><span class="skolem">dfvs</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>Suc <span class="skolem">k</span><span class="main">]</span> <span class="skolem">zs'</span><span class="main">)</span>"</span></span>
            
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span> <span class="main">=</span> length <span class="skolem">zs</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>6<span class="main">)</span> zs_def
              <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">k</span><span class="main">]</span> <span class="main">=</span>
                           <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>Suc <span class="skolem">k</span><span class="main">]</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> zip_eq<span class="main">:</span>
              <span class="quoted"><span class="quoted">"zip <span class="main">(</span><span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>Suc <span class="skolem">k</span><span class="main">]</span><span class="main">)</span> <span class="skolem">zs'</span> <span class="main">=</span>
               zip <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span> <span class="skolem">zs</span> <span class="main">@</span> zip <span class="main">[</span><span class="skolem">k</span><span class="main">]</span> <span class="main">[</span><span class="main">(</span><span class="skolem">fv_z</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span><span class="main">]</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> zs'_eq
              <span class="keyword1"><span class="command">using</span></span> zip_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">k</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="skolem">fv_z</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="main">(</span><span class="skolem">dfvs</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
                <span class="quoted"><span class="quoted">"wf_dfvs <span class="skolem">dfvs</span> <span class="free">σ</span> <span class="skolem">I</span> <span class="skolem">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span>"</span></span>
                <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="skolem">dfvs</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>6<span class="main">)</span> args_props<span class="main">(</span>3<span class="main">)</span> zs_def
                <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="main">(</span><span class="skolem">dfvs</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>zip <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eqs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">dfvs</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">fv_z</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> assm zip_eq
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_dfvs <span class="skolem">dfvs</span> <span class="free">σ</span> <span class="skolem">I</span> <span class="skolem">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> eqs int_non_empty
                <span class="keyword1"><span class="command">unfolding</span></span> fv_z_eq'' wf_dfvs_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
                <span class="quoted"><span class="quoted">"wf_dfvs <span class="skolem">dfvs</span> <span class="free">σ</span> <span class="skolem">I</span> <span class="skolem">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span>"</span></span>
                <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="skolem">dfvs</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> qtable_k fv_z_eq''
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
              <span class="quoted"><span class="quoted">"wf_dfvs <span class="skolem">dfvs</span> <span class="free">σ</span> <span class="skolem">I</span> <span class="skolem">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="skolem">dfvs</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
  
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff zs'_def zs_def aux_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
        
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist'</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">have</span></span> int_empty<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="skolem">k</span><span class="main">.</span> <span class="main">¬</span> mem <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="skolem">k</span><span class="main">.</span> mem <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">auxlist'</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> auxlist_mem
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> auxlist_len j_props args_ivl
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
              <span class="keyword1"><span class="command">using</span></span> empty length_pos_if_in_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span>"</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>

        <span class="keyword1"><span class="command">have</span></span> sat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="bound">v</span> <span class="skolem">k</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> int_empty
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">have</span></span> z_eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="main">{</span>replicate <span class="main">(</span>args_n <span class="skolem">args</span><span class="main">)</span> None<span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> empty filter_inv
          <span class="keyword1"><span class="command">unfolding</span></span> z_eq auxlist''_def trigger_results.simps
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">have</span></span> fv_z_eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fv_z</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> empty filter_inv
          <span class="keyword1"><span class="command">unfolding</span></span> fv_z_eq auxlist''_def trigger_results.simps
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">have</span></span> table<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="main">{}</span> <span class="skolem">z</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> fv_z_eq' z_eq'
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> args_n table_def wf_tuple_unit_table<span class="main">)</span>

        <span class="keyword1"><span class="command">have</span></span> correctness<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">z</span> <span class="main">⟹</span> wf_tuple <span class="skolem">n</span> <span class="main">{}</span> <span class="bound">x</span> <span class="main">⟹</span> mem_restr <span class="skolem">R</span> <span class="bound">x</span> <span class="main">⟹</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">x</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> sat
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
        <span class="keyword1"><span class="command">have</span></span> completeness<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> wf_tuple <span class="skolem">n</span> <span class="main">{}</span> <span class="bound">x</span> <span class="main">⟹</span> mem_restr <span class="skolem">R</span> <span class="bound">x</span> <span class="main">⟹</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">x</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">z</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> sat
          <span class="keyword1"><span class="command">unfolding</span></span> z_eq'
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> args_n wf_tuple_unit_table<span class="main">)</span>
  
        <span class="keyword1"><span class="command">have</span></span> qtable_k<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="main">{}</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> qtableI<span class="main">[</span><span class="operator">OF</span> table correctness completeness<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
        <span class="keyword1"><span class="command">have</span></span> zs'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs'</span> <span class="main">=</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">fv_z</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> zs'_def fv_z_def z_def aux'_eq  Let_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  
        <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2
          <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="main">(</span><span class="bound">dfvs</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> wf_dfvs <span class="bound">dfvs</span> <span class="free">σ</span> <span class="skolem">I</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">∧</span> qtable <span class="skolem">n</span> <span class="bound">dfvs</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>
          <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span> <span class="skolem">zs</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>6<span class="main">)</span> zs_def args_props<span class="main">(</span>3<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span> <span class="main">=</span> length <span class="skolem">zs</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>Suc <span class="skolem">k</span><span class="main">]</span> <span class="main">=</span> length <span class="skolem">zs'</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> zs'_eq length_append
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="main">(</span><span class="bound">dfvs</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>Suc <span class="skolem">k</span><span class="main">]</span> <span class="skolem">zs'</span><span class="main">)</span><span class="main">.</span>
        wf_dfvs <span class="bound">dfvs</span> <span class="free">σ</span> <span class="skolem">I</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">∧</span>
        qtable <span class="skolem">n</span> <span class="bound">dfvs</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">dfvs</span> <span class="skolem">r</span>
            <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="main">(</span><span class="skolem">dfvs</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>Suc <span class="skolem">k</span><span class="main">]</span> <span class="skolem">zs'</span><span class="main">)</span>"</span></span>
            
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span> <span class="main">=</span> length <span class="skolem">zs</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>6<span class="main">)</span> zs_def
              <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">k</span><span class="main">]</span> <span class="main">=</span>
                           <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>Suc <span class="skolem">k</span><span class="main">]</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> zip_eq<span class="main">:</span>
              <span class="quoted"><span class="quoted">"zip <span class="main">(</span><span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>Suc <span class="skolem">k</span><span class="main">]</span><span class="main">)</span> <span class="skolem">zs'</span> <span class="main">=</span>
               zip <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span> <span class="skolem">zs</span> <span class="main">@</span> zip <span class="main">[</span><span class="skolem">k</span><span class="main">]</span> <span class="main">[</span><span class="main">(</span><span class="skolem">fv_z</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span><span class="main">]</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> zs'_eq
              <span class="keyword1"><span class="command">using</span></span> zip_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">k</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="skolem">fv_z</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="main">(</span><span class="skolem">dfvs</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
                <span class="quoted"><span class="quoted">"wf_dfvs <span class="skolem">dfvs</span> <span class="free">σ</span> <span class="skolem">I</span> <span class="skolem">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span>"</span></span>
                <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="skolem">dfvs</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>6<span class="main">)</span> args_props<span class="main">(</span>3<span class="main">)</span> zs_def
                <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="main">(</span><span class="skolem">dfvs</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>zip <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">dfvs</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">fv_z</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> assm zip_eq
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_dfvs <span class="skolem">dfvs</span> <span class="free">σ</span> <span class="skolem">I</span> <span class="skolem">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> sat eq fv_z_eq' int_empty
                <span class="keyword1"><span class="command">unfolding</span></span> wf_dfvs_def
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
                <span class="quoted"><span class="quoted">"wf_dfvs <span class="skolem">dfvs</span> <span class="free">σ</span> <span class="skolem">I</span> <span class="skolem">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span>"</span></span>
                <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="skolem">dfvs</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> qtable_k fv_z_eq'
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
              <span class="quoted"><span class="quoted">"wf_dfvs <span class="skolem">dfvs</span> <span class="free">σ</span> <span class="skolem">I</span> <span class="skolem">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="skolem">dfvs</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
  
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff zs'_def zs_def aux_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> args_props<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="comment1">(* same but this time without the conjunction *)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> update_trigger<span class="main">:</span>
    <span class="quoted"><span class="quoted">"wf_trigger_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">R</span> <span class="skolem">args</span> <span class="skolem">γ</span> <span class="skolem">β</span> <span class="skolem">aux'</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="main">(</span><span class="bound">dfvs</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">.</span> wf_dfvs <span class="bound">dfvs</span> <span class="free">σ</span> <span class="skolem">I</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">∧</span> qtable <span class="skolem">n</span> <span class="bound">dfvs</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>
     <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">zs'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tuple'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple'</span> <span class="main">=</span> mbuf2_take <span class="main">(</span><span class="main">λ</span><span class="bound">r1</span> <span class="main">(</span><span class="bound">V_trigger</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span><span class="main">.</span>
      bin_join <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="bound">r1</span> True <span class="bound">V_trigger</span> <span class="bound">r2</span>
  <span class="main">)</span> <span class="main">(</span>mbuf2_add <span class="skolem">xs</span> <span class="skolem">zs'</span> <span class="skolem">buf1</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> zs_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> fst <span class="skolem">tuple'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> zs_def meval.simps tuple'_def Let_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> xtuple_eq atuple_eq btuple_eq tuple_def<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> Let_def<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> tuple_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
    
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">buf1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">buf1'</span> <span class="main">=</span> snd <span class="skolem">tuple'</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> tuple'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">buf1'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> zs_eq buf1'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> χ''_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">χ''</span> <span class="main">=</span> MAndTrigger <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">φ''</span> <span class="skolem">buf1'</span> <span class="skolem">args</span> <span class="skolem">γ''</span> <span class="skolem">β''</span> <span class="skolem">buf2'</span> <span class="skolem">nts'</span> <span class="skolem">aux'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> χ''_def meval.simps Let_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> xtuple_eq atuple_eq btuple_eq tuple_def<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> Let_def<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
        tuple_eq tuple'_def<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> Let_def<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> tuple'_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> buf_and<span class="main">:</span>
    <span class="quoted"><span class="quoted">"wf_mbuft2' <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span> <span class="skolem">buf1'</span>"</span></span>
    <span class="quoted"><span class="quoted">"list_all2
     <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">Z</span><span class="main">.</span> <span class="main">∃</span><span class="bound">X</span> <span class="bound">V_Y</span> <span class="bound">Y</span><span class="main">.</span>
                qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">φ</span><span class="main">)</span> <span class="bound">X</span> <span class="main">∧</span>
                wf_dfvs <span class="bound">V_Y</span> <span class="free">σ</span> <span class="skolem">I</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">∧</span>
                qtable <span class="skolem">n</span> <span class="bound">V_Y</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="bound">Y</span> <span class="main">∧</span>
                <span class="bound">Z</span> <span class="main">=</span> bin_join <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="bound">X</span> True <span class="bound">V_Y</span> <span class="bound">Y</span><span class="main">)</span>
     <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>
      min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>
     <span class="skolem">zs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mbuft2_take_add'<span class="main">[</span><span class="operator">OF</span> tuple'_eq<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">unfolded</span></span> tuple'_def<span class="main"><span class="main"><span class="main">]</span></span></span> And_Trigger<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> pred_mapping<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span> IH_φ<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> update_trigger<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">χ''</span> <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> χ''_eq
    <span class="keyword1"><span class="command">using</span></span> wf_mformula.And_Trigger<span class="main">[</span><span class="operator">OF</span> IH_φ<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> buf_and<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> And_Trigger<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> IH_β<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pos IH_γ<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pos_eq args_ivl args_n args_L args_R fv_l_n fvs wf_buf_ts_trigger update_trigger<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2
       <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">zs</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> length <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> buf_and<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">⟹</span>
        qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">r</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">r</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span> min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span> <span class="bound">V_Y</span> <span class="bound">Y</span><span class="main">.</span>
           qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">φ</span><span class="main">)</span> <span class="bound">X</span> <span class="main">∧</span>
           wf_dfvs <span class="bound">V_Y</span> <span class="free">σ</span> <span class="skolem">I</span> <span class="skolem">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">∧</span>
           qtable <span class="skolem">n</span> <span class="bound">V_Y</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="bound">Y</span> <span class="main">∧</span> <span class="skolem">r</span> <span class="main">=</span> bin_join <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="bound">X</span> True <span class="bound">V_Y</span> <span class="bound">Y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> buf_and<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="skolem"><span class="skolem">V_Y</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="keyword2"><span class="keyword">where</span></span> qtables<span class="main">:</span>
        <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">X</span>"</span></span>
        <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="skolem">V_Y</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Y</span>"</span></span>
        <span class="quoted"><span class="quoted">"wf_dfvs <span class="skolem">V_Y</span> <span class="free">σ</span> <span class="skolem">I</span> <span class="skolem">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> bin_join <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">X</span> True <span class="skolem">V_Y</span> <span class="skolem">Y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V_Y</span> <span class="main">⊆</span> fv <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> qtables<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> wf_dfvs_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fvs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fv <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fv <span class="skolem">φ</span> <span class="main">∪</span> <span class="skolem">V_Y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> And_Trigger<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="main">(</span>restrict <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">φ</span> <span class="main">=</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">x</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sat_the_restrict
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> qtable_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span>
          wf_tuple <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟹</span>
          mem_restr <span class="skolem">R</span> <span class="bound">x</span> <span class="main">⟹</span>
          Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">x</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="main">(</span>restrict <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">φ</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="main">(</span>restrict <span class="skolem">V_Y</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="skolem">i</span><span class="main">.</span> <span class="main">¬</span> mem <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="skolem">x</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="main">(</span>restrict <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">φ</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="main">(</span>restrict <span class="skolem">V_Y</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> sat_the_restrict True
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> V_Y_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">V_Y</span> <span class="main">=</span> fv <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> qtables<span class="main">(</span>3<span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> wf_dfvs_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="skolem">x</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="main">(</span>restrict <span class="main">(</span>fv <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">φ</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="main">(</span>restrict <span class="skolem">V_Y</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> V_Y_eq
          <span class="keyword1"><span class="command">using</span></span> sat_the_restrict
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.And <span class="skolem">φ</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> qtables<span class="main">(</span>4<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> qtable_bin_join<span class="main">[</span><span class="operator">OF</span> qtables<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span> _ fvs _ qtable_pos<span class="main">,</span> <span class="operator">of</span> <span class="quoted">True</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ztuple_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>And_Release <span class="skolem">I</span> <span class="skolem">φ'</span> <span class="skolem">ψ'</span> <span class="skolem">P</span> <span class="skolem">v</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">aux</span> <span class="skolem">α'</span><span class="main">)</span>
  
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">aux</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">χ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">χ</span> <span class="main">=</span> snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">aux</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> ztuple_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">aux</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">χ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> zs_def χ_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span>
    <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">v</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">χ</span> <span class="main">(</span>and_release_safe_bounded <span class="skolem">α'</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>and_release_safe_bounded <span class="skolem">α'</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">va</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">v</span> <span class="main">(</span>map the <span class="bound">va</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>and_release_safe_bounded <span class="skolem">α'</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>and_release_safe_bounded <span class="skolem">α'</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>and_release_safe_bounded <span class="skolem">α'</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">zs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_Release.IH<span class="main">[</span><span class="operator">OF</span> And_Release.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> ztuple_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">v</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">χ</span> <span class="main">(</span>formula.And <span class="skolem">α'</span> <span class="main">(</span>formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_mformula.And_Release<span class="main">[</span><span class="operator">OF</span> And_Release<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span> IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2
       <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>formula.And <span class="skolem">α'</span> <span class="main">(</span>formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">va</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">v</span> <span class="main">(</span>map the <span class="bound">va</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.And <span class="skolem">α'</span> <span class="main">(</span>formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.And <span class="skolem">α'</span> <span class="main">(</span>formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.And <span class="skolem">α'</span> <span class="main">(</span>formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">zs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>and_release_safe_bounded <span class="skolem">α'</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>and_release_safe_bounded <span class="skolem">α'</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> length <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.And <span class="skolem">α'</span> <span class="main">(</span>formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.And <span class="skolem">α'</span> <span class="main">(</span>formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span>
    length <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> progress_and_release_rewrite_bounded<span class="main"><span class="main">[</span></span><span class="operator">OF</span> And_Release<span class="main"><span class="main"><span class="main">(</span></span></span>1-2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span>set <span class="main">(</span>zip <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.And <span class="skolem">α'</span> <span class="main">(</span>formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.And <span class="skolem">α'</span> <span class="main">(</span>formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">⟹</span>
        qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>formula.And <span class="skolem">α'</span> <span class="main">(</span>formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">va</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">v</span> <span class="main">(</span>map the <span class="bound">va</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.And <span class="skolem">α'</span> <span class="main">(</span>formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">r</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">r</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span>set <span class="main">(</span>zip <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.And <span class="skolem">α'</span> <span class="main">(</span>formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.And <span class="skolem">α'</span> <span class="main">(</span>formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span>set <span class="main">(</span>zip <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>and_release_safe_bounded <span class="skolem">α'</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>and_release_safe_bounded <span class="skolem">α'</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> progress_and_release_rewrite_bounded<span class="main"><span class="main">[</span></span><span class="operator">OF</span> And_Release<span class="main"><span class="main"><span class="main">(</span></span></span>1-2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> qtable<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>and_release_safe_bounded <span class="skolem">α'</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">va</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">v</span> <span class="main">(</span>map the <span class="bound">va</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>and_release_safe_bounded <span class="skolem">α'</span> <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>formula.And <span class="skolem">α'</span> <span class="main">(</span>formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">va</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">v</span> <span class="main">(</span>map the <span class="bound">va</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.And <span class="skolem">α'</span> <span class="main">(</span>formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> qtable release_fvi<span class="main">(</span>3<span class="main">)</span> sat_and_release_rewrite<span class="main">[</span><span class="operator">OF</span> And_Release<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> qtable_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtableI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fv <span class="main">(</span>formula.And <span class="skolem">α'</span> <span class="main">(</span>formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">va</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">v</span> <span class="main">(</span>map the <span class="bound">va</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.And <span class="skolem">α'</span> <span class="main">(</span>formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ztuple_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Ands <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">l</span> <span class="skolem">pos</span> <span class="skolem">neg</span> <span class="skolem">l'</span> <span class="skolem">buf</span> <span class="skolem">A_pos</span> <span class="skolem">A_neg</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> mbufn_take.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span> mbufn_add.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span> mmulti_join.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

  <span class="keyword1"><span class="command">from</span></span> Ands<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> wf_l<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">l</span> <span class="main">(</span><span class="skolem">pos</span> <span class="main">@</span> map remove_neg <span class="skolem">neg</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> Ands <span class="keyword1"><span class="command">have</span></span>
    wf_buf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbufn <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Ands <span class="skolem">l'</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ψ</span><span class="main">.</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="bound">ψ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">pos</span> <span class="main">@</span> map remove_neg <span class="skolem">neg</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ψ</span> <span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="bound">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">pos</span> <span class="main">@</span> map remove_neg <span class="skolem">neg</span><span class="main">)</span><span class="main">)</span> <span class="skolem">buf</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    posneg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pos</span><span class="main">,</span> <span class="skolem">neg</span><span class="main">)</span> <span class="main">=</span> partition safe_formula <span class="skolem">l'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    pos_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pos</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    safe_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all safe_formula <span class="main">(</span>map remove_neg <span class="skolem">neg</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    A_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A_pos</span> <span class="main">=</span> map fv <span class="skolem">pos</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A_neg</span> <span class="main">=</span> map fv <span class="skolem">neg</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    fv_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span> <span class="main">(</span>set <span class="skolem">A_neg</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span> <span class="main">(</span>set <span class="skolem">A_pos</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> progress_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.Ands <span class="skolem">l'</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">=</span>
      Mini <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Ands <span class="skolem">l'</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ψ</span><span class="main">.</span> progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="bound">ψ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">pos</span> <span class="main">@</span> map remove_neg <span class="skolem">neg</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pos</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> posneg
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Mini_def image_Un<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Collect_disj_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">Min</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> join_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>fv <span class="main">`</span> set <span class="skolem">l'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span>
        <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> list_all <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">l'</span><span class="main">)</span>
        <span class="main">(</span>mmulti_join <span class="skolem">n</span> <span class="skolem">A_pos</span> <span class="skolem">A_neg</span> <span class="skolem">L</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> args_ok<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">k</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="skolem">pos</span> <span class="main">@</span> map remove_neg <span class="skolem">neg</span><span class="main">)</span> <span class="skolem">L</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="skolem">L</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> qtable_mmulti_join<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ok</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">A</span> <span class="bound">Qi</span> <span class="bound">X</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="bound">A</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="bound">Qi</span> <span class="bound">X</span> <span class="main">∧</span> wf_set <span class="skolem">n</span> <span class="bound">A</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L_pos</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">A_pos</span><span class="main">)</span> <span class="skolem">L</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L_neg</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>length <span class="skolem">A_pos</span><span class="main">)</span> <span class="skolem">L</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">pos</span> <span class="main">≤</span> length <span class="skolem">L</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> args_ok <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all2_lengthD<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all3 <span class="var">?ok</span> <span class="skolem">A_pos</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ψ</span> <span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">k</span> <span class="bound">ψ</span><span class="main">)</span> <span class="skolem">pos</span><span class="main">)</span> <span class="var">?L_pos</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> args_ok wf_l <span class="keyword1"><span class="command">unfolding</span></span> A_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all3_conv_all_nth list_all2_conv_all_nth nth_append
          <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula_wf_set<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">R</span></span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> args_ok <span class="keyword1"><span class="command">have</span></span> prems_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">ψ</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="bound">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">(</span>remove_neg <span class="bound">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">neg</span> <span class="var">?L_neg</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> A_eq list_all2_append1 list.rel_map<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all3 <span class="var">?ok</span> <span class="skolem">A_neg</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ψ</span> <span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">(</span>remove_neg <span class="bound">ψ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">neg</span><span class="main">)</span> <span class="var">?L_neg</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prems_neg wf_l <span class="keyword1"><span class="command">unfolding</span></span> A_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all3_conv_all_nth list_all2_conv_all_nth list_all_length nth_append less_diff_conv
          <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula_wf_set<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="skolem">P</span></span> <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">R</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"remove_neg <span class="main">_</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>fv <span class="main">`</span> set <span class="skolem">l'</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>set <span class="skolem">A_pos</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fv_subset posneg <span class="keyword1"><span class="command">unfolding</span></span> A_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> take <span class="main">(</span>length <span class="skolem">A_pos</span><span class="main">)</span> <span class="skolem">L</span> <span class="main">@</span> drop <span class="main">(</span>length <span class="skolem">A_pos</span><span class="main">)</span> <span class="skolem">L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A_pos</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pos</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> A_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"event_data tuple"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="skolem">n</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>fv <span class="main">`</span> set <span class="skolem">l'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"mem_restr <span class="skolem">R</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> mem_restr <span class="skolem">R</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A_pos</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> mem_restr <span class="skolem">R</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A_neg</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.pred_set<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all Formula.is_Neg <span class="skolem">neg</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> posneg safe_neg
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.pred_map <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.pred_mono_strong
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> formula.exhaust<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">ψ</span></span> <span class="quoted"><span class="quoted">"Formula.is_Neg <span class="skolem">ψ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span> <span class="skolem">ψ</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">ψ</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>remove_neg <span class="bound">ψ</span><span class="main">)</span> <span class="main">⟷</span>
      <span class="main">¬</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="bound">ψ</span><span class="main">)</span> <span class="skolem">neg</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Formula.is_Neg_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.pred_mono_strong<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="skolem">x</span><span class="main">)</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">l'</span> <span class="main">=</span>
       <span class="main">(</span>list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">Qi</span><span class="main">.</span> <span class="bound">Qi</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A_pos</span>
         <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ψ</span> <span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">k</span> <span class="bound">ψ</span><span class="main">)</span> <span class="skolem">pos</span><span class="main">)</span> <span class="main">∧</span>
        list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="bound">Qi</span><span class="main">.</span> <span class="main">¬</span> <span class="bound">Qi</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A_neg</span>
         <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ψ</span> <span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">k</span>
                       <span class="main">(</span>remove_neg <span class="bound">ψ</span><span class="main">)</span><span class="main">)</span>
           <span class="skolem">neg</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> posneg
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_eq list_all2_conv_all_nth list_all_length sat_the_restrict
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> nth_filter nth_partition<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted">safe_formula</span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> Q<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"Formula.sat <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fact</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">φ'</span><span class="main">.</span> <span class="main">(</span><span class="bound">φ</span><span class="main">,</span> <span class="bound">φ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">l</span> <span class="main">(</span><span class="skolem">pos</span> <span class="main">@</span> map remove_neg <span class="skolem">neg</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
    wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">φ</span> <span class="bound">φ'</span> <span class="main">∧</span>
    wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span> <span class="bound">φ'</span> <span class="main">∧</span>
    list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="bound">φ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">φ'</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="bound">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="bound">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span> <span class="skolem">φ'</span>
    
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">φ</span><span class="main">,</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">l</span> <span class="main">(</span><span class="skolem">pos</span> <span class="main">@</span> map remove_neg <span class="skolem">neg</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="main">∧</span>
            <span class="main">(</span><span class="keyword1">case</span> meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span> <span class="keyword1">of</span>
             <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">⇒</span>
               wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ'</span> <span class="main">∧</span>
               list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Ands.IH Ands.prems<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="bound">φ'</span><span class="main">.</span>
         wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">φ</span> <span class="bound">φ'</span> <span class="main">∧</span>
         <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">xa</span><span class="main">.</span>
             wf_envs <span class="free">σ</span> <span class="free">j</span> <span class="free">δ</span> <span class="skolem">P</span> <span class="bound">xa</span> <span class="skolem">V</span> <span class="bound">x</span> <span class="main">⟶</span>
             <span class="main">(</span><span class="keyword1">case</span> meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span> <span class="bound">φ</span> <span class="keyword1">of</span>
              <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">⇒</span>
                wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="bound">xa</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">φ'</span> <span class="main">∧</span>
                list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="bound">φ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">φ'</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="bound">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="bound">xa</span> <span class="bound">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span>
                 <span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">pos</span> <span class="main">@</span> map remove_neg <span class="skolem">neg</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ'</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span> <span class="keyword1">of</span>
         <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">⇒</span>
           wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ'</span> <span class="main">∧</span>
           list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="bound">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span>
      <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="main">∧</span>
      wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">φ'</span> <span class="main">∧</span>
      list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">φ'</span><span class="main">.</span> <span class="main">(</span><span class="bound">φ</span><span class="main">,</span> <span class="bound">φ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">l</span> <span class="main">(</span><span class="skolem">pos</span> <span class="main">@</span> map remove_neg <span class="skolem">neg</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">φ</span> <span class="bound">φ'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">φ'</span><span class="main">.</span> <span class="main">(</span><span class="bound">φ</span><span class="main">,</span> <span class="bound">φ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">l</span> <span class="main">(</span><span class="skolem">pos</span> <span class="main">@</span> map remove_neg <span class="skolem">neg</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span> <span class="bound">φ'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">φ'</span><span class="main">.</span> <span class="main">(</span><span class="bound">φ</span><span class="main">,</span> <span class="bound">φ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">l</span> <span class="main">(</span><span class="skolem">pos</span> <span class="main">@</span> map remove_neg <span class="skolem">neg</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="bound">φ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">φ'</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="bound">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="bound">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> Ands.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.rel_map progress_eq map2_map_map list_all3_map
        list_all3_list_all2_conv list.pred_map
        <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> set_append map_append progress_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Ands<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ posneg <span class="quoted"><span class="quoted">‹<span class="skolem">pos</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> safe_neg A_eq fv_subset<span class="main"><span class="main">]</span></span>
        rel_mono_zip<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_l<span class="main"><span class="main">]</span></span> wf_mbufn_add<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_buf<span class="main"><span class="main">]</span></span>
        list.rel_flip<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> rel_mono_zip<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> wf_l<span class="main"><span class="main">]</span></span>
        list.rel_refl join_ok<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> list.pred_set<span class="main"><span class="main">]</span></span>
        IH
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mbufn_take list_all2_appendI
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mbufn_take_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ wf_mbufn_add<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> wf_buf<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Or <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">ψ</span> <span class="skolem">ψ'</span> <span class="skolem">buf</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Or<span class="main">(</span>1-4<span class="main">)</span> Or.prems Or.IH<span class="main">[</span><span class="operator">OF</span> Or.prems<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span>  <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Or qtable_union
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mbuf2_take_add'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.rel_mono_strong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mbuf2_take_add'<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="main">{}</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">v</span><span class="main">)</span> <span class="skolem">X</span> <span class="main">⟹</span>
    <span class="main">¬</span> qtable <span class="skolem">n</span> <span class="main">{}</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">¬</span> <span class="skolem">P</span> <span class="bound">v</span><span class="main">)</span> empty_table <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">⟹</span> False"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">P</span> <span class="skolem">x</span> <span class="skolem">X</span>
    <span class="keyword1"><span class="command">using</span></span> nullary_qtable_cases qtable_unit_empty_table <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> Neg <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Neg <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Neg.IH
        <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.rel_map
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> nullary_qtable_cases qtable_unit_empty_table <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_empty_unit_table
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.rel_mono_strong <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Exists <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list.rel_map fvi_Suc sat_fv_cong nth_Cons'
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Exists <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Exists.IH qtable_project_fv
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.rel_mono_strong table_fvi_tl qtable_cong sat_fv_cong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Agg <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">b</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="skolem">y</span> <span class="skolem">f</span> <span class="skolem">g0</span> <span class="skolem">ω</span><span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> fst <span class="main">(</span>meval <span class="main">(</span><span class="skolem">b</span><span class="main">+</span><span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">φ''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ''</span> <span class="main">=</span> snd <span class="main">(</span>meval <span class="main">(</span><span class="skolem">b</span><span class="main">+</span><span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> xtuple_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"meval <span class="main">(</span><span class="skolem">b</span><span class="main">+</span><span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">φ''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xs_def φ''_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="main">(</span>MAgg <span class="skolem">g0</span> <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ψ''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ''</span> <span class="main">=</span> snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="main">(</span>MAgg <span class="skolem">g0</span> <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> ztuple_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="main">(</span>MAgg <span class="skolem">g0</span> <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">ψ''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> zs_def ψ''_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

  <span class="keyword1"><span class="command">have</span></span> zs_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> map <span class="main">(</span>eval_agg <span class="skolem">n</span> <span class="skolem">g0</span> <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> zs_def meval.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xtuple_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> ψ''_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ''</span> <span class="main">=</span> MAgg <span class="skolem">g0</span> <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">φ''</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ψ''_def meval.simps Let_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xtuple_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span>
    <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>lift_envs' <span class="skolem">b</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">φ''</span> <span class="skolem">φ'</span>"</span></span>
    <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="main">(</span><span class="skolem">b</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="main">(</span>lift_envs' <span class="skolem">b</span> <span class="skolem">R</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">)</span>
     <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Agg.IH<span class="main">[</span><span class="operator">OF</span> Agg.prems<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> xtuple_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">ψ''</span> <span class="main">(</span>formula.Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">φ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ψ''_eq
    <span class="keyword1"><span class="command">using</span></span> wf_mformula.Agg<span class="main">[</span><span class="operator">OF</span> IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Agg<span class="main"><span class="main">(</span></span>2-6<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>formula.Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">zs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> zs_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> progress_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> len_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> length <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">r</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">zs</span><span class="main">)</span> <span class="main">⟹</span>
        qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>formula.Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">)</span> <span class="bound">r</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zipped</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zipped</span> <span class="main">=</span> zip <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>map <span class="main">(</span>eval_agg <span class="skolem">n</span> <span class="skolem">g0</span> <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">r</span>
      <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">zipped</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> zs_eq zipped_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> progress_eq<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">zs</span> <span class="main">=</span> length <span class="main">(</span>zip <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> progress_eq len_eq
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">idx</span></span> <span class="keyword2"><span class="keyword">where</span></span> idx_props<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">zipped</span><span class="main">}</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">zipped</span><span class="main">!</span><span class="skolem">idx</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> mem
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeastLessThan_iff in_set_conv_nth zero_le<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> idx_l<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&lt;</span> length <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> "</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">idx</span> <span class="main">&lt;</span> length <span class="main">(</span>map <span class="main">(</span>eval_agg <span class="skolem">n</span> <span class="skolem">g0</span> <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> idx_props<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> zipped_def length_zip
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">idx</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> nth<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span><span class="main">!</span><span class="skolem">idx</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span>eval_agg <span class="skolem">n</span> <span class="skolem">g0</span> <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">!</span><span class="skolem">idx</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nth_zip<span class="main">[</span><span class="operator">OF</span> idx_l<span class="main">]</span> idx_props<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> zipped_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> r_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> eval_agg <span class="skolem">n</span> <span class="skolem">g0</span> <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">r'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> r'_def
        <span class="keyword1"><span class="command">using</span></span> nth_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">idx</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>eval_agg <span class="skolem">n</span> <span class="skolem">g0</span> <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span><span class="main">)</span>"</span></span><span class="main">]</span> idx_l<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>zip <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">idx</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> r'_def nth<span class="main">(</span>1<span class="main">)</span> idx_l
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> idx_l in_set_conv_nth
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> qtable<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="main">(</span><span class="skolem">b</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="main">(</span>lift_envs' <span class="skolem">b</span> <span class="skolem">R</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="skolem">r'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> fvs_l_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="main">(</span>formula.Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> wf_mformula_wf_set<span class="main">[</span><span class="operator">OF</span> wf<span class="main">,</span> <span class="operator">unfolded</span> wf_set_def<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>formula.Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.Agg <span class="skolem">y</span> <span class="skolem">ω</span> <span class="skolem">b</span> <span class="skolem">f</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> qtable_eval_agg<span class="main">[</span><span class="operator">OF</span> qtable fvs_l_n Agg<span class="main"><span class="main">(</span></span>3-6<span class="main"><span class="main">)</span></span><span class="main">]</span> r_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ztuple_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prev <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">ψ</span> <span class="skolem">first</span> <span class="skolem">buf</span> <span class="skolem">nts</span> <span class="skolem">I</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?φ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ls</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>mprev_next <span class="skolem">I</span> <span class="main">(</span><span class="skolem">buf</span> <span class="main">@</span> <span class="var">?xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>snd <span class="main">(</span>mprev_next <span class="skolem">I</span> <span class="main">(</span><span class="skolem">buf</span> <span class="main">@</span> <span class="var">?xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>snd <span class="main">(</span>mprev_next <span class="skolem">I</span> <span class="main">(</span><span class="skolem">buf</span> <span class="main">@</span> <span class="var">?xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span> <span class="bound">X</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="bound">X</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?j</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">+</span> <span class="free">δ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?j'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">ψ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">mini</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mini</span> <span class="main">=</span> min <span class="var">?j'</span> <span class="main">(</span><span class="keyword1">if</span> <span class="var">?i</span> <span class="main">=</span> <span class="var">?j</span> <span class="keyword1">then</span> <span class="var">?j</span> <span class="keyword1">else</span> <span class="var">?j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  
  <span class="keyword1"><span class="command">from</span></span> Prev.IH<span class="main">[</span><span class="operator">OF</span> Prev.prems<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="var">?φ</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"list_all2 <span class="var">?P</span> <span class="main">[</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">ψ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="var">?xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> Prev<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> Prev.prems <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">X</span><span class="main">.</span> <span class="keyword1">if</span> mem <span class="skolem">I</span> <span class="main">(</span><span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="var">?P</span> <span class="bound">i</span> <span class="bound">X</span> <span class="keyword1">else</span> <span class="bound">X</span> <span class="main">=</span> empty_table<span class="main">)</span> <span class="main">[</span><span class="var">?i</span><span class="main">..&lt;</span><span class="skolem">mini</span><span class="main">]</span> <span class="var">?ls</span> <span class="main">∧</span>
     list_all2 <span class="var">?P</span> <span class="main">[</span><span class="skolem">mini</span><span class="main">..&lt;</span><span class="var">?j'</span><span class="main">]</span> <span class="var">?rs</span> <span class="main">∧</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="skolem">mini</span><span class="main">..&lt;</span> <span class="var">?j</span><span class="main">]</span> <span class="var">?ts</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mini_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mprev<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all2_upt_append list_all2_appendI order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> min.cobounded1<span class="main"><span class="main">]</span></span>
      list.rel_refl <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list.rel_map<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>Suc <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">=</span> Suc <span class="main">(</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">P</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Prev<span class="main">(</span>2<span class="main">)</span> Prev.prems IH
    upt_conv_Cons<span class="main">[</span><span class="operator">OF</span> zero_less_Suc<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">ψ</span> <span class="free">δ</span><span class="main">)</span> <span class="main">(</span><span class="free">δ</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_Suc_upt<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> list.rel_map qtable_empty_iff mini_def
        <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Prev list.rel_mono_strong <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wf_envs_progress_le
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split if_split_asm<span class="main">)</span> <span class="comment1">(* slow 25 sec*)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Next <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">ψ</span> <span class="skolem">first</span> <span class="skolem">nts</span> <span class="skolem">I</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> min<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="free">j</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="free">j</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">ψ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">ψ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_envs_progress_le<span class="main">[</span><span class="operator">OF</span> Next.prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ψ</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ys</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="main">(</span><span class="var">?xs</span><span class="main">,</span> <span class="skolem">first</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span> <span class="main">#</span> <span class="bound">xs</span><span class="main">,</span> True<span class="main">)</span> <span class="main">⇒</span> <span class="bound">xs</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="var">?xs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?φ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ls</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>mprev_next <span class="skolem">I</span> <span class="var">?ys</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>snd <span class="main">(</span>mprev_next <span class="skolem">I</span> <span class="var">?ys</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>snd <span class="main">(</span>mprev_next <span class="skolem">I</span> <span class="var">?ys</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span> <span class="bound">X</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="bound">X</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="free">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?j</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">+</span> <span class="free">δ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?j'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">ψ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">mini</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">mini</span> <span class="main">=</span> min <span class="main">(</span><span class="var">?j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">if</span> <span class="var">?i</span> <span class="main">=</span> <span class="var">?j</span> <span class="keyword1">then</span> <span class="var">?j</span> <span class="keyword1">else</span> <span class="var">?j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  
  <span class="keyword1"><span class="command">from</span></span> Next.IH<span class="main">[</span><span class="operator">OF</span> Next.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span>  <span class="skolem">n</span> <span class="skolem">R</span> <span class="var">?φ</span> <span class="skolem">ψ</span>"</span></span>
    <span class="quoted"><span class="quoted">"list_all2 <span class="var">?P</span> <span class="main">[</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">ψ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="var">?xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">X</span><span class="main">.</span> <span class="keyword1">if</span> mem <span class="skolem">I</span> <span class="main">(</span><span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="var">?P</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="bound">X</span> <span class="keyword1">else</span> <span class="bound">X</span> <span class="main">=</span> empty_table<span class="main">)</span>
       <span class="main">[</span><span class="var">?i</span><span class="main">..&lt;</span><span class="skolem">mini</span><span class="main">]</span> <span class="var">?ls</span> <span class="main">∧</span>
     list_all2 <span class="var">?P</span> <span class="main">[</span>Suc <span class="skolem">mini</span><span class="main">..&lt;</span><span class="var">?j'</span><span class="main">]</span> <span class="var">?rs</span> <span class="main">∧</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="skolem">mini</span><span class="main">..&lt;</span><span class="var">?j</span><span class="main">]</span> <span class="var">?ts</span>"</span></span>
     <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="free">j</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">ψ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Next<span class="main">(</span>1-3<span class="main">)</span> IH that wf_envs_progress_le<span class="main">[</span><span class="operator">OF</span> Next.prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ψ</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> mini_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mnext<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv list.rel_map
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all2_upt_append list_all2_appendI list.rel_refl <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> wf_envs_progress_le<span class="main">[</span><span class="operator">OF</span> Next.prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ψ</span></span></span></span><span class="main">]</span>
    upt_add_eq_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">δ</span></span><span class="main">]</span> upt_add_eq_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?j'</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">δ</span></span><span class="main">]</span>
    wf_envs_progress_mono<span class="main">[</span><span class="operator">OF</span> Next.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">+</span> <span class="free">δ</span>"</span></span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> Next<span class="main">(</span>1-3<span class="main">)</span> IH
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">ψ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">&gt;</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ</span> <span class="free">j</span>"</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qtable_empty_iff le_Suc_eq le_diff_conv mini_def list.rel_map
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Next list.rel_mono_strong list_all2_appendI <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.rel_refl
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split list.splits if_split_asm<span class="main">)</span> <span class="comment1">(* slow 15 sec*)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Since <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ''</span> <span class="skolem">ψ</span> <span class="skolem">ψ''</span> <span class="skolem">args</span> <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">buf</span> <span class="skolem">nts</span> <span class="skolem">aux</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> sat.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> Since <span class="keyword1"><span class="command">have</span></span>
       pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> args_pos <span class="skolem">args</span> <span class="keyword1">then</span> <span class="skolem">φ'''</span> <span class="main">=</span> <span class="skolem">φ''</span> <span class="keyword1">else</span> <span class="skolem">φ'''</span> <span class="main">=</span> Formula.Neg <span class="skolem">φ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pos_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">φ'''</span> <span class="main">=</span> args_pos <span class="skolem">args</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> φ<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ψ<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">ψ</span> <span class="skolem">ψ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fvi_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.fv <span class="skolem">φ''</span> <span class="main">⊆</span> Formula.fv <span class="skolem">ψ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> buf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="free">j</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ''</span> <span class="skolem">ψ''</span> <span class="skolem">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nts<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_ts <span class="free">σ</span> <span class="skolem">P</span> <span class="free">j</span> <span class="skolem">φ''</span> <span class="skolem">ψ''</span> <span class="skolem">nts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_since_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">R</span> <span class="skolem">args</span> <span class="skolem">φ''</span> <span class="skolem">ψ''</span> <span class="skolem">aux</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>Formula.Since <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_ivl<span class="main">:</span> <span class="quoted"><span class="quoted">"args_ivl <span class="skolem">args</span> <span class="main">=</span> <span class="skolem">I</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_n<span class="main">:</span> <span class="quoted"><span class="quoted">"args_n <span class="skolem">args</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_L<span class="main">:</span> <span class="quoted"><span class="quoted">"args_L <span class="skolem">args</span> <span class="main">=</span> Formula.fv <span class="skolem">φ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_R<span class="main">:</span> <span class="quoted"><span class="quoted">"args_R <span class="skolem">args</span> <span class="main">=</span> Formula.fv <span class="skolem">ψ''</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> φ'''<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.fv <span class="skolem">φ'''</span> <span class="main">=</span> Formula.fv <span class="skolem">φ''</span>"</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ'''</span> <span class="skolem">j</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ''</span> <span class="skolem">j</span>"</span></span>
    <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'''</span> <span class="skolem">j</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ''</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">using</span></span> pos <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Since.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> nts_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span>
    <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ''</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ''</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nts <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> upt_add_eq_append<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_envs_progress_le<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> min.coboundedI1<span class="main"><span class="main">]</span></span> list.rel_map
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all2_appendI list.rel_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> update<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_since_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">R</span> <span class="skolem">args</span> <span class="skolem">φ''</span> <span class="skolem">ψ''</span> <span class="main">(</span>snd <span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">aux'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>Formula.Since <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>Formula.fv <span class="skolem">φ'''</span> <span class="main">∪</span> Formula.fv <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>Formula.Since <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>Formula.Since <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>Formula.Since <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">aux'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> eval_φ<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eval_ψ<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ys</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mbuf2t_take <span class="main">(</span><span class="main">λ</span><span class="bound">r1</span> <span class="bound">r2</span> <span class="bound">t</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">.</span>
        <span class="keyword1">case</span> update_since <span class="skolem">args</span> <span class="bound">r1</span> <span class="bound">r2</span> <span class="bound">t</span> <span class="bound">aux</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">z</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">zs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">z</span><span class="main">]</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">aux</span><span class="main">)</span> <span class="main">(</span>mbuf2_add <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">buf</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">aux'</span><span class="main">)</span><span class="main">,</span> <span class="skolem">buf'</span><span class="main">,</span> <span class="skolem">nts'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">zs</span> <span class="skolem">aux'</span> <span class="skolem">buf'</span> <span class="skolem">nts'</span>
    <span class="keyword1"><span class="command">unfolding</span></span> progress_simps φ'''
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mbuf2t_take_add_induct'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> j'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">+</span> <span class="free">δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> z'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">aux'</span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span>
      <span class="operator">OF</span> eq wf_envs_P_simps<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Since.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> buf nts_snoc<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">goal_cases</span> xs ys _ base step<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> xs
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Since.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Since.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> eval_φ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> ys
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Since.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Since.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> eval_ψ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> base
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> aux <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> φ'''<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">k</span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">z</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> fvi_subset pos
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> args_ivl args_n args_L args_R Un_absorb1
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> update_since<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list_all2_appendI <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> update_since<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
          <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> Since.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Since.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> Since.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Since.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_mformula.Since<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ pos pos_eq args_ivl args_n args_L args_R fvi_subset<span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mbuf2t_take_add'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ wf_envs_P_simps<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> Since.prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> buf nts_snoc<span class="main"><span class="main">]</span></span>
              mbuf2t_take_add'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ wf_envs_P_simps<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> Since.prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> buf nts_snoc<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Until <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ''</span> <span class="skolem">ψ</span> <span class="skolem">ψ''</span> <span class="skolem">args</span> <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">buf</span> <span class="skolem">nts</span> <span class="skolem">t</span> <span class="skolem">aux</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> sat.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span> progress_simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> Until <span class="keyword1"><span class="command">have</span></span>
        pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> args_pos <span class="skolem">args</span> <span class="keyword1">then</span> <span class="skolem">φ'''</span> <span class="main">=</span> <span class="skolem">φ''</span> <span class="keyword1">else</span> <span class="skolem">φ'''</span> <span class="main">=</span> Formula.Neg <span class="skolem">φ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pos_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">φ'''</span> <span class="main">=</span> args_pos <span class="skolem">args</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> φ<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ψ<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">ψ</span> <span class="skolem">ψ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fvi_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.fv <span class="skolem">φ''</span> <span class="main">⊆</span> Formula.fv <span class="skolem">ψ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> buf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="free">j</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ''</span> <span class="skolem">ψ''</span> <span class="skolem">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nts<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_ts <span class="free">σ</span> <span class="skolem">P</span> <span class="free">j</span> <span class="skolem">φ''</span> <span class="skolem">ψ''</span> <span class="skolem">nts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_until_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">R</span> <span class="skolem">args</span> <span class="skolem">φ''</span> <span class="skolem">ψ''</span> <span class="skolem">aux</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>Formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_ivl<span class="main">:</span> <span class="quoted"><span class="quoted">"args_ivl <span class="skolem">args</span> <span class="main">=</span> <span class="skolem">I</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_n<span class="main">:</span> <span class="quoted"><span class="quoted">"args_n <span class="skolem">args</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_L<span class="main">:</span> <span class="quoted"><span class="quoted">"args_L <span class="skolem">args</span> <span class="main">=</span> Formula.fv <span class="skolem">φ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_R<span class="main">:</span> <span class="quoted"><span class="quoted">"args_R <span class="skolem">args</span> <span class="main">=</span> Formula.fv <span class="skolem">ψ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">j</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> τ <span class="free">σ</span> <span class="main">(</span>min <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ''</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ''</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> length_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>Formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="free">j</span> <span class="main">+</span> <span class="free">length_muaux</span> <span class="skolem">args</span> <span class="skolem">aux</span> <span class="main">=</span>
      min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ''</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ''</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pos</span></span> <span class="keyword2"><span class="keyword">where</span></span> args_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pos</span> <span class="main">=</span> args_pos <span class="skolem">args</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> φ'''<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ'''</span> <span class="skolem">j</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ''</span> <span class="skolem">j</span>"</span></span>  <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'''</span> <span class="skolem">j</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ''</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">using</span></span> pos <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> progress.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Until.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> nts_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span>
    <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ''</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">ψ''</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nts <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> upt_add_eq_append<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_envs_progress_le<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> min.coboundedI1<span class="main"><span class="main">]</span></span> list.rel_map
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all2_appendI list.rel_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">zs</span> <span class="skolem">aux'</span> <span class="skolem">aux''</span> <span class="skolem">buf'</span> <span class="skolem">nts'</span> <span class="skolem">nt</span>
    <span class="keyword3"><span class="command">assume</span></span> eval_φ<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eval_ψ<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ys</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> nt0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nt</span> <span class="main">=</span> lookahead_ts <span class="skolem">nts'</span> <span class="skolem">nts</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"mbuf2t_take <span class="main">(</span><span class="free">add_new_muaux</span> <span class="skolem">args</span><span class="main">)</span> <span class="skolem">aux</span> <span class="main">(</span>mbuf2_add <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">buf</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="skolem">aux'</span><span class="main">,</span> <span class="skolem">buf'</span><span class="main">,</span> <span class="skolem">nts'</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">eval_muaux</span> <span class="skolem">args</span> <span class="skolem">nt</span> <span class="skolem">aux'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">aux''</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ne</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ne</span> <span class="main">≡</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>Formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> update1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_until_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">R</span> <span class="skolem">args</span> <span class="skolem">φ''</span> <span class="skolem">ψ''</span> <span class="skolem">aux'</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>Formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">∧</span>
      <span class="skolem">ne</span> <span class="main">+</span> <span class="free">length_muaux</span> <span class="skolem">args</span> <span class="skolem">aux'</span> <span class="main">=</span> min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">ψ''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Until.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Until.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> eval_φ Until.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Until.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        eval_ψ nts_snoc nts_snoc length_aux aux fvi_subset
      <span class="keyword1"><span class="command">unfolding</span></span> φ'''
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> mbuf2t_take_add_induct'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">+</span> <span class="free">δ</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> eq1 wf_envs_P_simps<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Until.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> buf<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> args_n args_L args_R ne_def wf_update_until<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cur</span></span> <span class="skolem"><span class="skolem">auxlist'</span></span> <span class="keyword2"><span class="keyword">where</span></span> valid_aux'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">valid_muaux</span> <span class="skolem">args</span> <span class="skolem">cur</span> <span class="skolem">aux'</span> <span class="skolem">auxlist'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      cur<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cur</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">ne</span> <span class="main">+</span> length <span class="skolem">auxlist'</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> τ <span class="free">σ</span> <span class="main">(</span><span class="skolem">ne</span> <span class="main">+</span> length <span class="skolem">auxlist'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      wf_auxlist'<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_until_auxlist <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">pos</span> <span class="skolem">φ''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span> <span class="skolem">auxlist'</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>Formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> wf_until_aux_def ne_def args_ivl args_n args_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> length_aux'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">length_muaux</span> <span class="skolem">args</span> <span class="skolem">aux'</span> <span class="main">=</span> length <span class="skolem">auxlist'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_length_muaux<span class="main">[</span><span class="operator">OF</span> valid_aux'<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> nts'<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_ts <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">φ''</span> <span class="skolem">ψ''</span> <span class="skolem">nts'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Until.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Until.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> eval_φ Until.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Until.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        Until.prems<span class="main">(</span>1<span class="main">)</span> eval_ψ nts_snoc
      <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mbuf2t_take_eqD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq1<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_mbuf2_add buf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> wf_mbuf2'_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nt</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> τ <span class="free">σ</span> <span class="main">(</span>min <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">ψ''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nts nts' <span class="keyword1"><span class="command">unfolding</span></span> nt0 t
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hd_append hd_rev last_map wf_ts_def lookahead_ts_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> list_all2_hdD<span class="main">(</span>1<span class="main">)</span> list_all2_hdD<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">using</span></span> list_all2_lastD  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> list_all2_hdD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list_all2_hdD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> min.absorb2 Suc_diff_Suc diff_zero less_Suc_eq_le<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> add_gr_0 list_all2_hdD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list_all2_hdD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> min.absorb2 Suc_diff_Suc diff_zero less_Suc_eq_le<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> add_gr_0 list_all2_hdD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list_all2_hdD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> min.absorb2 Suc_diff_Suc diff_zero less_Suc_eq_le<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs''</span> <span class="main">=</span> fst <span class="main">(</span>eval_until <span class="skolem">I</span> <span class="skolem">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">auxlist''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">auxlist''</span> <span class="main">=</span> snd <span class="main">(</span>eval_until <span class="skolem">I</span> <span class="skolem">nt</span> <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> current_w_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cur</span> <span class="main">≤</span> <span class="skolem">nt</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">nts'</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">have</span></span> p_le<span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">ψ''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> wf_envs_progress_le<span class="main">[</span><span class="operator">OF</span> Until.prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min_def le_diff_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> cur conjunct2<span class="main">[</span><span class="operator">OF</span> update1<span class="main">,</span> <span class="operator">unfolded</span> length_aux'<span class="main">]</span> nt
        <span class="keyword1"><span class="command">using</span></span> Nil <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ''' <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> τ_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">nt</span> <span class="skolem">x</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> progress_φ'''<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> pos <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> progress.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> p_le<span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">ψ''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> wf_envs_progress_le<span class="main">[</span><span class="operator">OF</span> Until.prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min_def le_diff_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> cur conjunct2<span class="main">[</span><span class="operator">OF</span> update1<span class="main">,</span> <span class="operator">unfolded</span> length_aux'<span class="main">]</span> Cons progress_φ''' nt
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits list.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> τ_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> valid_aux''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">valid_muaux</span> <span class="skolem">args</span> <span class="skolem">cur</span> <span class="skolem">aux''</span> <span class="skolem">auxlist''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_eval_muaux<span class="main">[</span><span class="operator">OF</span> valid_aux' current_w_le eq2<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">zs''</span></span> <span class="quoted"><span class="skolem">auxlist''</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> args_ivl zs''_def auxlist''_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> length_aux''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">length_muaux</span> <span class="skolem">args</span> <span class="skolem">aux''</span> <span class="main">=</span> length <span class="skolem">auxlist''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_length_muaux<span class="main">[</span><span class="operator">OF</span> valid_aux''<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> eq2'<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_until <span class="skolem">I</span> <span class="skolem">nt</span> <span class="skolem">auxlist'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">auxlist''</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_eval_muaux<span class="main">[</span><span class="operator">OF</span> valid_aux' current_w_le eq2<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">zs''</span></span> <span class="quoted"><span class="skolem">auxlist''</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> args_ivl zs''_def auxlist''_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> length_aux'_aux''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">length_muaux</span> <span class="skolem">args</span> <span class="skolem">aux'</span> <span class="main">=</span> length <span class="skolem">zs</span> <span class="main">+</span> <span class="free">length_muaux</span> <span class="skolem">args</span> <span class="skolem">aux''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eval_until_length<span class="main">[</span><span class="operator">OF</span> eq2'<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> length_aux' length_aux'' <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>Formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">⟹</span>
      wf_until_auxlist <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">pos</span> <span class="skolem">φ''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span> <span class="skolem">auxlist'</span> <span class="skolem">i</span> <span class="main">⟹</span>
      <span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">auxlist'</span> <span class="main">=</span> min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">ψ''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
      wf_until_auxlist <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">pos</span> <span class="skolem">φ''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span> <span class="skolem">auxlist''</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>Formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
        <span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">zs</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>Formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">∧</span>
        <span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">zs</span> <span class="main">+</span> length <span class="skolem">auxlist''</span> <span class="main">=</span> min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">ψ''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
        list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>Formula.fv <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>Formula.Until <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">pos</span> <span class="keyword1">then</span> <span class="skolem">φ''</span> <span class="keyword1">else</span> Formula.Neg <span class="skolem">φ''</span><span class="main">)</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">[</span><span class="skolem">i</span><span class="main">..&lt;</span><span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">zs</span><span class="main">]</span> <span class="skolem">zs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">using</span></span> eq2'
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">auxlist'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">zs</span></span> <span class="quoted"><span class="skolem">auxlist''</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> antisym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> progress_Until_le<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">aux'</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">a1</span></span> <span class="skolem"><span class="skolem">a2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">a1</span><span class="main">,</span> <span class="skolem">a2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> aux'<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_until_auxlist <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">pos</span> <span class="skolem">φ''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span> <span class="skolem">aux'</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_until_aux_Cons<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">a1</span><span class="main">,</span> <span class="skolem">a2</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_until_aux_Cons1<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="main">(</span>Formula.fv <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="skolem">i</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> Suc <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">aux'</span><span class="main">)</span> <span class="main">∧</span> mem <span class="skolem">I</span> <span class="main">(</span><span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">j</span> <span class="skolem">ψ''</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="skolem">i</span><span class="main">..&lt;</span><span class="bound">j</span><span class="main">}</span><span class="main">.</span> <span class="keyword1">if</span> <span class="skolem">pos</span> <span class="keyword1">then</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="skolem">φ''</span> <span class="keyword1">else</span> <span class="main">¬</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="skolem">φ''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a2</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">a1</span><span class="main">,</span> <span class="skolem">a2</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_until_aux_Cons3<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> Suc_i_aux'<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">aux'</span> <span class="main">=</span>
          min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">ψ''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>Formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span><span class="skolem">nt</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that nts' <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_def progress.simps nt
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1 list_all2_Cons2 upt_eq_Cons_conv φ'''
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cInf_lower τ_mono diff_le_mono <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits list.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>Formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span><span class="skolem">nt</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> τ_min<span class="main">:</span>  <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">(</span>min <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> min <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_of_mono monoI<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> le_progress_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">+</span> <span class="free">δ</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">⟷</span> progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">φ</span>
          <span class="keyword1"><span class="command">using</span></span> wf_envs_progress_le<span class="main">[</span><span class="operator">OF</span> Until.prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">φ</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">ψ''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?min</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">ψ''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="var">?min</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> τ_mono<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ''' <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> that nts' Suc_i_aux' <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_def progress.simps nt
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cInf_greatest<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="var">?X</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 1 φ''' list_all2_Cons2 upt_eq_Cons_conv
              <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits if_splits
              <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="var">?min</span>"</span></span><span class="main"><span class="main">]</span></span>
              <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> diff_le_mono diff_le_mono2 order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> diff_le_mono diff_le_mono2<span class="main"><span class="main">]</span></span> τ_mono
              <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> contrapos_np<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">≤</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">ψ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span><span class="skolem">nt</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">=</span> <span class="skolem">ψ''</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="skolem">φ''</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="skolem">ψ</span>
        <span class="keyword1"><span class="command">using</span></span> that nts' <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_def nt
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv
          <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits if_splits
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> contrapos_np<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> diff_le_mono diff_le_mono2<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems Suc_i_aux'<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">a1</span><span class="main">,</span> <span class="skolem">a2</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ''' 1 sat.simps upt_conv_Cons <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Cons.IH<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ aux' Suc_i_aux'<span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> iff_exI qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 3 refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">note</span></span> wf_aux'' <span class="main">=</span> this<span class="main">[</span><span class="operator">OF</span> wf_envs_progress_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Until.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> le_add1<span class="main"><span class="main">]</span></span>
      wf_auxlist' conjunct2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> update1<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> ne_def length_aux'<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="free">j</span> <span class="main">+</span> length <span class="skolem">auxlist'</span> <span class="main">=</span>
      progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">+</span> length <span class="skolem">auxlist''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf_aux'' valid_aux'' length_aux'_aux''
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ne_def length_aux' length_aux''<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cur</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">if</span> progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">+</span> length <span class="skolem">auxlist''</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span>
      <span class="keyword1">else</span> τ <span class="free">σ</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">+</span> length <span class="skolem">auxlist''</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> cur ne_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_until_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">R</span> <span class="skolem">args</span> <span class="skolem">φ''</span> <span class="skolem">ψ''</span> <span class="skolem">aux''</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="free">j</span> <span class="main">+</span> length <span class="skolem">zs</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">∧</span>
      progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="free">j</span> <span class="main">+</span> length <span class="skolem">zs</span> <span class="main">+</span> <span class="free">length_muaux</span> <span class="skolem">args</span> <span class="skolem">aux''</span> <span class="main">=</span> min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">ψ''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Until <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">pos</span> <span class="keyword1">then</span> <span class="skolem">φ''</span> <span class="keyword1">else</span> formula.Neg <span class="skolem">φ''</span><span class="main">)</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="free">j</span> <span class="main">+</span> length <span class="skolem">zs</span><span class="main">]</span> <span class="skolem">zs</span> <span class="main">∧</span>
      <span class="skolem">nt</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> τ <span class="free">σ</span> <span class="main">(</span>min <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">ψ''</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf_aux'' valid_aux'' fvi_subset
      <span class="keyword1"><span class="command">unfolding</span></span> wf_until_aux_def length_aux'' args_ivl args_n args_pos nt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> length_aux''<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> update <span class="main">=</span> this<span class="main">[</span><span class="operator">OF</span> refl refl refl<span class="main">,</span> <span class="operator">rotated</span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> Until.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Until.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> Until.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Until.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> pos pos_eq fvi_subset <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> meval.simps Let_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> args_ivl args_n args_pos φ''' progress.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> Let_def
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split if_splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> update
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Until<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ _ _ args_ivl args_n args_L args_R fvi_subset<span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.rel_mono_strong qtable_cong
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mbuf2t_take_add'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ wf_envs_P_simps<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> Until.prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> buf nts_snoc<span class="main"><span class="main">]</span></span>
        mbuf2t_take_add'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ wf_envs_P_simps<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> Until.prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> buf nts_snoc<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Trigger_0 <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">ψ</span> <span class="skolem">β</span> <span class="skolem">args</span> <span class="skolem">α</span> <span class="skolem">γ</span> <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">buf</span> <span class="skolem">nts</span> <span class="skolem">aux</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> Trigger_0 <span class="keyword1"><span class="command">have</span></span>
        pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> args_pos <span class="skolem">args</span> <span class="keyword1">then</span> <span class="skolem">α</span> <span class="main">=</span> <span class="skolem">γ</span> <span class="keyword1">else</span> <span class="skolem">α</span> <span class="main">=</span> formula.Neg <span class="skolem">γ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pos_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">α</span> <span class="main">=</span> args_pos <span class="skolem">args</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> φ<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">γ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ψ<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">ψ</span> <span class="skolem">β</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fvi_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> mem <span class="skolem">I</span> <span class="main">0</span> <span class="keyword1">then</span> fv <span class="skolem">γ</span> <span class="main">⊆</span> fv <span class="skolem">β</span> <span class="keyword1">else</span> fv <span class="skolem">γ</span> <span class="main">=</span> fv <span class="skolem">β</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> buf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="free">j</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">γ</span> <span class="skolem">β</span> <span class="skolem">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nts<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_ts <span class="free">σ</span> <span class="skolem">P</span> <span class="free">j</span> <span class="skolem">γ</span> <span class="skolem">β</span> <span class="skolem">nts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_trigger_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">R</span> <span class="skolem">args</span> <span class="skolem">γ</span> <span class="skolem">β</span> <span class="skolem">aux</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_ivl<span class="main">:</span> <span class="quoted"><span class="quoted">"args_ivl <span class="skolem">args</span> <span class="main">=</span> <span class="skolem">I</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_n<span class="main">:</span> <span class="quoted"><span class="quoted">"args_n <span class="skolem">args</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_L<span class="main">:</span> <span class="quoted"><span class="quoted">"args_L <span class="skolem">args</span> <span class="main">=</span> fv <span class="skolem">γ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> args_R<span class="main">:</span> <span class="quoted"><span class="quoted">"args_R <span class="skolem">args</span> <span class="main">=</span> fv <span class="skolem">β</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fv_l_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="skolem">β</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mem0<span class="main">:</span> <span class="quoted"><span class="quoted">"mem <span class="skolem">I</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> args_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"args_n <span class="skolem">args</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"args_R <span class="skolem">args</span> <span class="main">=</span> fv <span class="skolem">α</span> <span class="main">∪</span> fv <span class="skolem">β</span>"</span></span>
    <span class="quoted"><span class="quoted">"fv <span class="skolem">γ</span> <span class="main">=</span> fv <span class="skolem">α</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pos args_n args_L args_R fvi_subset
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> IH_φ <span class="main">=</span> Trigger_0.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Trigger_0.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> IH_ψ <span class="main">=</span> Trigger_0.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Trigger_0.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="main">(</span>MTrigger <span class="skolem">args</span> <span class="skolem">φ</span> <span class="skolem">ψ</span> <span class="skolem">buf</span> <span class="skolem">nts</span> <span class="skolem">aux</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">η</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">η</span> <span class="main">=</span> snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="main">(</span>MTrigger <span class="skolem">args</span> <span class="skolem">φ</span> <span class="skolem">ψ</span> <span class="skolem">buf</span> <span class="skolem">nts</span> <span class="skolem">aux</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">γ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">γ'</span> <span class="main">=</span> snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> φ_pair_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">γ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> xs_def γ'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> γ_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">γ'</span> <span class="skolem">γ</span>"</span></span>
    <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">γ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">γ</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">γ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> IH_φ
    <span class="keyword1"><span class="command">unfolding</span></span> φ_pair_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">β'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">β'</span> <span class="main">=</span> snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">ψ</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> ψ_pair_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ys</span><span class="main">,</span> <span class="skolem">β'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ys_def β'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> β_props<span class="main">:</span>
    <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">β'</span> <span class="skolem">β</span>"</span></span>
    <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">β</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">β</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> IH_ψ
    <span class="keyword1"><span class="command">unfolding</span></span> ψ_pair_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tuple</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">=</span> mbuf2t_take <span class="main">(</span><span class="main">λ</span><span class="bound">r1</span> <span class="bound">r2</span> <span class="bound">t</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">let</span>
    <span class="bound">aux</span> <span class="main">=</span> <span class="free">update_mtaux</span> <span class="skolem">args</span> <span class="bound">t</span> <span class="bound">r1</span> <span class="bound">r2</span> <span class="bound">aux</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">fv_z</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">result_mtaux</span> <span class="skolem">args</span> <span class="bound">aux</span>
    <span class="keyword1">in</span>
      <span class="main">(</span><span class="bound">zs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">z</span><span class="main">]</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span>
  <span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">aux</span><span class="main">)</span> <span class="main">(</span>mbuf2_add <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">buf</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> zs_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> fst <span class="main">(</span>fst <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tuple_def zs_def meval.simps Let_def xs_def ys_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">aux'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aux'</span> <span class="main">=</span> snd <span class="main">(</span>fst <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">buf'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">buf'</span> <span class="main">=</span> fst <span class="main">(</span>snd <span class="skolem">tuple</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">nts'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nts'</span> <span class="main">=</span> snd <span class="main">(</span>snd <span class="skolem">tuple</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> tuple_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tuple</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">aux'</span><span class="main">)</span><span class="main">,</span> <span class="skolem">buf'</span><span class="main">,</span> <span class="skolem">nts'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> zs_eq aux'_def buf'_def nts'_def Let_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> η_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">η</span> <span class="main">=</span> MTrigger <span class="skolem">args</span> <span class="skolem">γ'</span> <span class="skolem">β'</span> <span class="skolem">buf'</span> <span class="skolem">nts'</span> <span class="skolem">aux'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> η_def meval.simps γ'_def β'_def aux'_def buf'_def nts'_def tuple_def xs_def ys_def Let_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> pred_mapping<span class="main">:</span>
    <span class="quoted"><span class="quoted">"pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">P</span>"</span></span>
    <span class="quoted"><span class="quoted">"pred_mapping <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span>"</span></span>
    <span class="quoted"><span class="quoted">"rel_mapping <span class="main">(≤)</span> <span class="skolem">P</span> <span class="skolem">P'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Trigger_0.prems<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> Trigger_0.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> nts_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span>
    <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nts
    <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> upt_add_eq_append<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_envs_progress_le<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> min.coboundedI1<span class="main"><span class="main">]</span></span> list.rel_map
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all2_appendI list.rel_refl<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> wf_buf_ts<span class="main">:</span>
    <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">γ</span> <span class="skolem">β</span> <span class="skolem">buf'</span>"</span></span>
    <span class="quoted"><span class="quoted">"wf_ts <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">γ</span> <span class="skolem">β</span> <span class="skolem">nts'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mbuf2t_take_add'<span class="main">[</span><span class="operator">OF</span> tuple_eq<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">unfolded</span></span> tuple_def<span class="main"><span class="main"><span class="main">]</span></span></span> pred_mapping buf nts_snoc γ_props<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> β_props<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> α_γ_props<span class="main">:</span> <span class="quoted"><span class="quoted">"Formula.fv <span class="skolem">α</span> <span class="main">=</span> Formula.fv <span class="skolem">γ</span>"</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">α</span> <span class="skolem">j</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="skolem">j</span>"</span></span>
  <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">α</span> <span class="skolem">j</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">γ</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">using</span></span> pos
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> update<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_trigger_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">R</span> <span class="skolem">args</span> <span class="skolem">γ</span> <span class="skolem">β</span> <span class="main">(</span>snd <span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">aux'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>Formula.fv <span class="skolem">α</span> <span class="main">∪</span> Formula.fv <span class="skolem">β</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">[</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">aux'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> progress_simps α_γ_props
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mbuf2t_take_add_induct'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">j</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> j'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">+</span> <span class="free">δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> z'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">aux'</span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span>
      <span class="operator">OF</span> tuple_eq<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> tuple_def<span class="main"><span class="main">]</span></span> wf_envs_P_simps<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Trigger_0.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> buf nts_snoc<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">goal_cases</span> xs ys _ base step<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> xs
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> γ_props<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> ys
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> β_props<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> base
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> aux α_γ_props
      <span class="keyword1"><span class="command">unfolding</span></span> progress_simps 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">k</span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">acc</span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> fst <span class="skolem">acc</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">aux</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aux</span> <span class="main">=</span> snd <span class="skolem">acc</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> z_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">acc</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">aux</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> zs_def aux_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> table<span class="main">:</span>
      <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="skolem">args</span><span class="main">)</span> <span class="skolem">X</span>"</span></span>
      <span class="quoted"><span class="quoted">"table <span class="main">(</span>args_n <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="skolem">args</span><span class="main">)</span> <span class="skolem">Y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>4-5<span class="main">)</span> args_n args_L args_R
      <span class="keyword1"><span class="command">unfolding</span></span> qtable_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs'</span> <span class="main">=</span> fst <span class="main">(</span><span class="keyword1">let</span> <span class="bound">aux</span> <span class="main">=</span> <span class="free">update_mtaux</span> <span class="skolem">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">aux</span><span class="main">;</span> <span class="main">(</span><span class="bound">fv_z</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">result_mtaux</span> <span class="skolem">args</span> <span class="bound">aux</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">z</span><span class="main">]</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">aux'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aux'</span> <span class="main">=</span> snd <span class="main">(</span><span class="keyword1">let</span> <span class="bound">aux</span> <span class="main">=</span> <span class="free">update_mtaux</span> <span class="skolem">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">aux</span><span class="main">;</span> <span class="main">(</span><span class="bound">fv_z</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">result_mtaux</span> <span class="skolem">args</span> <span class="bound">aux</span> <span class="keyword1">in</span> <span class="main">(</span><span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">z</span><span class="main">]</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cur'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cur'</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="skolem">k</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> wf_trigger<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_trigger_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">R</span> <span class="skolem">args</span> <span class="skolem">γ</span> <span class="skolem">β</span> <span class="skolem">aux</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>6<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> aux_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> fv_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="skolem">γ</span> <span class="main">⊆</span> fv <span class="skolem">β</span> "</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> wf_trigger_aux_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> wf_trigger_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_trigger_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">R</span> <span class="skolem">args</span> <span class="skolem">γ</span> <span class="skolem">β</span> <span class="main">(</span><span class="free">update_mtaux</span> <span class="skolem">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">aux</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> update_trigger<span class="main">[</span><span class="operator">OF</span> wf_trigger step<span class="main"><span class="main">(</span></span>4-5<span class="main"><span class="main">)</span></span> args_n args_L args_R<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">auxlist'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      valid_mtaux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">valid_mtaux</span> <span class="skolem">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span><span class="free">update_mtaux</span> <span class="skolem">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">aux</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      sorted_wrt<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">≤</span> fst <span class="bound">y</span><span class="main">)</span> <span class="skolem">auxlist'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      auxlist_len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">auxlist'</span> <span class="main">=</span> Suc <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      auxlist_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">auxlist'</span><span class="main">]</span> <span class="skolem">auxlist'</span><span class="main">)</span><span class="main">.</span>
         Suc <span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span>
         <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">∧</span>
         <span class="bound">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">∧</span>
         qtable <span class="main">(</span>args_n <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span>fv <span class="skolem">γ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">γ</span><span class="main">)</span> <span class="bound">l</span> <span class="main">∧</span>
         qtable <span class="main">(</span>args_n <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span>fv <span class="skolem">β</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">β</span><span class="main">)</span> <span class="bound">r</span>
      <span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      auxlist_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span>
          Suc <span class="skolem">k</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span>
          <span class="bound">i</span> <span class="main">≤</span> <span class="skolem">k</span>
          <span class="main">⟶</span>
          <span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">auxlist'</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span>
      <span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> wf_trigger_aux_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sorted<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map fst <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sorted_wrt
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_map<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">auxlist'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> auxlist_mem auxlist_len
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Zero_not_Suc less_Suc_eq_le nth_mem order_refl<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X_tmp</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">,</span> <span class="skolem">X_tmp</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> args_ivl mem0
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> non_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist'</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> length_pos_if_in_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">,</span> <span class="skolem">X_tmp</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_trigger_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">R</span> <span class="skolem">args</span> <span class="skolem">γ</span> <span class="skolem">β</span> <span class="main">(</span>snd <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">acc</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">let</span> <span class="bound">aux</span> <span class="main">=</span> <span class="free">update_mtaux</span> <span class="skolem">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="bound">aux</span><span class="main">;</span> <span class="main">(</span><span class="bound">fv_z</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">result_mtaux</span> <span class="skolem">args</span> <span class="bound">aux</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">z</span><span class="main">]</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
 <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf_trigger_aux
      <span class="keyword1"><span class="command">unfolding</span></span> z_eq Let_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2
    <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">α</span> <span class="main">∪</span> fv <span class="skolem">β</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>Suc <span class="skolem">k</span><span class="main">]</span>
    <span class="main">(</span>fst <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">acc</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">let</span> <span class="bound">aux</span> <span class="main">=</span> <span class="free">update_mtaux</span> <span class="skolem">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="bound">aux</span><span class="main">;</span> <span class="main">(</span><span class="bound">fv_z</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">result_mtaux</span> <span class="skolem">args</span> <span class="bound">aux</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">z</span><span class="main">]</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> aux'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">aux'</span> <span class="main">=</span> <span class="free">update_mtaux</span> <span class="skolem">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">aux</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> aux'_def Let_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">fv_z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fv_z</span> <span class="main">=</span> fst <span class="main">(</span><span class="free">result_mtaux</span> <span class="skolem">args</span> <span class="skolem">aux'</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> snd <span class="main">(</span><span class="free">result_mtaux</span> <span class="skolem">args</span> <span class="skolem">aux'</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">auxlist''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">auxlist''</span> <span class="main">=</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> memR <span class="main">(</span>args_ivl <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> valid_mtaux'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">valid_mtaux</span> <span class="skolem">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">aux'</span> <span class="skolem">auxlist''</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq auxlist''_def
        <span class="keyword1"><span class="command">using</span></span> valid_mtaux
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> z_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> snd <span class="main">(</span>trigger_results <span class="skolem">args</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">auxlist''</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> z_def
        <span class="keyword1"><span class="command">using</span></span> valid_result_mtaux<span class="main">[</span><span class="operator">OF</span> valid_mtaux'<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span>
         Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="skolem">x</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
          restr<span class="main">:</span> <span class="quoted"><span class="quoted">"mem_restr <span class="skolem">R</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
          wf_x<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="main">(</span>args_n <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="skolem">args</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
        <span class="keyword1"><span class="command">unfolding</span></span> z_eq auxlist''_def
        <span class="keyword1"><span class="command">using</span></span> trigger_sat_equiv<span class="main">[</span><span class="operator">OF</span> restr wf_x pos args_n args_ivl args_L args_R fvi_subset fv_l_n valid_mtaux sorted_wrt auxlist_len auxlist_props auxlist_mem non_empty<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> filter_inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist''</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> auxlist''_def filter_filter
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prod_beta'<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">result_mtaux</span> <span class="skolem">args</span> <span class="skolem">aux'</span> <span class="main">=</span> trigger_results <span class="skolem">args</span> <span class="skolem">cur'</span> <span class="skolem">auxlist''</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid_result_mtaux<span class="main">[</span><span class="operator">OF</span> valid_mtaux<span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> aux'_def cur'_def auxlist''_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> mem <span class="main">(</span>args_ivl <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cur'</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">auxlist''</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> filter_inv non_empty
        <span class="keyword1"><span class="command">unfolding</span></span> cur'_def auxlist''_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> z_eq'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="main">{</span>
        <span class="bound">tuple</span><span class="main">.</span> wf_tuple <span class="main">(</span>args_n <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span>args_R <span class="skolem">args</span><span class="main">)</span> <span class="bound">tuple</span> <span class="main">∧</span>
          <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>length <span class="skolem">auxlist''</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
            <span class="keyword1">let</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">auxlist''</span><span class="main">!</span><span class="bound">i</span> <span class="keyword1">in</span>
            mem <span class="main">(</span>args_ivl <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span><span class="skolem">cur'</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span> 
            <span class="main">(</span>
              <span class="bound">tuple</span> <span class="main">∈</span> <span class="bound">r</span> <span class="main">∨</span>
              <span class="main">(</span><span class="main">∃</span><span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">&lt;..&lt;</span><span class="main">(</span>length <span class="skolem">auxlist''</span><span class="main">)</span><span class="main">}</span><span class="main">.</span>
                join_cond <span class="main">(</span>args_pos <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>fst <span class="keyword1">o</span> snd<span class="main">)</span> <span class="main">(</span><span class="skolem">auxlist''</span><span class="main">!</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>proj_tuple <span class="main">(</span>join_mask <span class="main">(</span>args_n <span class="skolem">args</span><span class="main">)</span> <span class="main">(</span>args_L <span class="skolem">args</span><span class="main">)</span><span class="main">)</span> <span class="bound">tuple</span><span class="main">)</span>
              <span class="main">)</span>
            <span class="main">)</span>
          <span class="main">)</span>
        <span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> z_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> args_R_simp<span class="main">:</span> <span class="quoted"><span class="quoted">"args_R <span class="skolem">args</span> <span class="main">=</span> fv <span class="skolem">α</span> <span class="main">∪</span> fv <span class="skolem">β</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> args_L args_R pos fvi_subset
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> table<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">α</span> <span class="main">∪</span> fv <span class="skolem">β</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> z_eq'
        <span class="keyword1"><span class="command">unfolding</span></span> table_def args_R_simp args_n
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> correctness<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">z</span> <span class="main">⟹</span> wf_tuple <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">α</span> <span class="main">∪</span> fv <span class="skolem">β</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟹</span> mem_restr <span class="skolem">R</span> <span class="bound">x</span> <span class="main">⟹</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">x</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> equiv args_props
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> completeness<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> wf_tuple <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">α</span> <span class="main">∪</span> fv <span class="skolem">β</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟹</span> mem_restr <span class="skolem">R</span> <span class="bound">x</span> <span class="main">⟹</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">x</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">z</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> equiv args_props
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> qtable_k<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">α</span> <span class="main">∪</span> fv <span class="skolem">β</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">k</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> qtableI<span class="main">[</span><span class="operator">OF</span> table correctness completeness<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">have</span></span> zs'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs'</span> <span class="main">=</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> zs'_def z_def aux'_eq  Let_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2
        <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">α</span> <span class="main">∪</span> fv <span class="skolem">β</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span> <span class="skolem">zs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>6<span class="main">)</span> zs_def args_props<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span> <span class="main">=</span> length <span class="skolem">zs</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>Suc <span class="skolem">k</span><span class="main">]</span> <span class="main">=</span> length <span class="skolem">zs'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> zs'_eq length_append
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>Suc <span class="skolem">k</span><span class="main">]</span> <span class="skolem">zs'</span><span class="main">)</span><span class="main">.</span>
      qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">α</span> <span class="main">∪</span> fv <span class="skolem">β</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">r</span>
          <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>Suc <span class="skolem">k</span><span class="main">]</span> <span class="skolem">zs'</span><span class="main">)</span>"</span></span>
          
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span> <span class="main">=</span> length <span class="skolem">zs</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>6<span class="main">)</span> zs_def
            <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">k</span><span class="main">]</span> <span class="main">=</span>
                         <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>Suc <span class="skolem">k</span><span class="main">]</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> zip_eq<span class="main">:</span>
            <span class="quoted"><span class="quoted">"zip <span class="main">(</span><span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>Suc <span class="skolem">k</span><span class="main">]</span><span class="main">)</span> <span class="skolem">zs'</span> <span class="main">=</span>
             zip <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span> <span class="skolem">zs</span> <span class="main">@</span> zip <span class="main">[</span><span class="skolem">k</span><span class="main">]</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> zs'_eq
            <span class="keyword1"><span class="command">using</span></span> zip_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">k</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">z</span><span class="main">]</span>"</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">α</span> <span class="main">∪</span> fv <span class="skolem">β</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> step<span class="main">(</span>6<span class="main">)</span> args_props<span class="main">(</span>3<span class="main">)</span> zs_def
              <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>zip <span class="main">[</span>min <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">γ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">β</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">k</span><span class="main">]</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> assm zip_eq
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">α</span> <span class="main">∪</span> fv <span class="skolem">β</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> qtable_k
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">α</span> <span class="main">∪</span> fv <span class="skolem">β</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff zs'_def zs_def aux_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> args_props<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_trigger_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">R</span> <span class="skolem">args</span> <span class="skolem">γ</span> <span class="skolem">β</span> <span class="skolem">aux'</span> <span class="main">(</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> update
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">η</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> η_eq
    <span class="keyword1"><span class="command">using</span></span> wf_mformula.Trigger_0<span class="main">[</span><span class="operator">OF</span> β_props<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pos γ_props<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pos_eq args_ivl args_n args_L args_R fv_l_n fvi_subset wf_buf_ts aux mem0<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.Trigger <span class="skolem">α</span> <span class="skolem">I</span> <span class="skolem">β</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">zs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> update
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> zs_def η_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Release_0 <span class="skolem">I</span> <span class="skolem">φ'</span> <span class="skolem">ψ'</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">aux</span><span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">aux</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">φ''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ''</span> <span class="main">=</span> snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">aux</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> tuple_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">aux</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">,</span> <span class="skolem">φ''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xs_def φ''_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span>
    <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ''</span> <span class="main">(</span>release_safe_0 <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>release_safe_0 <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>release_safe_0 <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>release_safe_0 <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>release_safe_0 <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Release_0.IH<span class="main">[</span><span class="operator">OF</span> Release_0.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tuple_eq<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="main">(</span>release_safe_0 <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> sat_release_rewrite_0<span class="main">[</span><span class="operator">OF</span> Release_0<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> progress_release_rewrite_0<span class="main">[</span><span class="operator">OF</span> Release_0<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ''</span> <span class="main">(</span>formula.Release <span class="skolem">φ'</span> <span class="skolem">I</span> <span class="skolem">ψ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_mformula.Release_0<span class="main">[</span><span class="operator">OF</span> Release_0<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span> IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> tuple_eq release_fvi<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MatchP <span class="skolem">r</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φs</span> <span class="skolem">mr</span> <span class="skolem">mrs</span> <span class="skolem">buf</span> <span class="skolem">nts</span> <span class="skolem">I</span> <span class="skolem">aux</span><span class="main">)</span> <span class="comment1">(* (Formula.MatchP I r) *)</span>
  <span class="keyword1"><span class="command">note</span></span> sat.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span> mbufnt_take.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span> mbufn_add.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> MatchP <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ψs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        safe<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex Past Strict <span class="skolem">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mr<span class="main">:</span> <span class="quoted"><span class="quoted">"to_mregex <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">mr</span><span class="main">,</span> <span class="skolem">ψs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mrs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mrs</span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span>RPDs <span class="skolem">mr</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ψs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">φs</span> <span class="skolem">ψs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> buf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbufn' <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="free">j</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">r</span> <span class="skolem">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nts<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_ts_regex <span class="free">σ</span> <span class="skolem">P</span> <span class="free">j</span> <span class="skolem">r</span> <span class="skolem">nts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_matchP_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">I</span> <span class="skolem">r</span> <span class="skolem">aux</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>Formula.MatchP <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> list_all2_mono
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">have</span></span> IH_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2
     <span class="main">(</span><span class="main">λ</span><span class="bound">x1</span> <span class="bound">x2</span><span class="main">.</span>
         wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="main">∧</span>
         <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">xa</span><span class="main">.</span>
             wf_envs <span class="free">σ</span> <span class="free">j</span> <span class="free">δ</span> <span class="skolem">P</span> <span class="bound">xa</span> <span class="skolem">V</span> <span class="bound">x</span> <span class="main">⟶</span>
             <span class="main">(</span><span class="keyword1">case</span> meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span> <span class="bound">x1</span> <span class="keyword1">of</span>
              <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">⇒</span>
                wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="bound">xa</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">x2</span> <span class="main">∧</span>
                list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="bound">x2</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">x2</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="bound">x2</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="bound">xa</span> <span class="bound">x2</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span>
                 <span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="skolem">φs</span> <span class="skolem">ψs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> MatchP.IH mr
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">φ'</span><span class="main">.</span> <span class="main">(</span><span class="bound">φ</span><span class="main">,</span> <span class="bound">φ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">φs</span> <span class="skolem">ψs</span><span class="main">)</span> <span class="main">⟹</span>
    wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">φ</span> <span class="bound">φ'</span> <span class="main">∧</span>
    wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span> <span class="bound">φ'</span> <span class="main">∧</span>
    list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="bound">φ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">φ'</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="bound">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="bound">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span> <span class="skolem">φ'</span>
    
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">φ</span><span class="main">,</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">φs</span> <span class="skolem">ψs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="main">∧</span>
            <span class="main">(</span><span class="keyword1">case</span> meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span> <span class="keyword1">of</span>
             <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">⇒</span>
               wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ'</span> <span class="main">∧</span>
               list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH_alt MatchP.prems<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x1</span> <span class="bound">x2</span><span class="main">.</span>
           wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="main">∧</span>
           <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">xa</span><span class="main">.</span>
               wf_envs <span class="free">σ</span> <span class="free">j</span> <span class="free">δ</span> <span class="skolem">P</span> <span class="bound">xa</span> <span class="skolem">V</span> <span class="bound">x</span> <span class="main">⟶</span>
               <span class="main">(</span><span class="keyword1">case</span> meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span> <span class="bound">x1</span> <span class="keyword1">of</span>
                <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">⇒</span>
                  wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="bound">xa</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">x2</span> <span class="main">∧</span>
                  list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="bound">x2</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">x2</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="bound">x2</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="bound">xa</span> <span class="bound">x2</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span>
                   <span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">φs</span></span> <span class="quoted"><span class="skolem">ψs</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ'</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span> <span class="keyword1">of</span>
         <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">⇒</span>
           wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ'</span> <span class="main">∧</span>
           list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="bound">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span>
      <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="main">∧</span>
      wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">φ'</span> <span class="main">∧</span>
      list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">φ'</span><span class="main">.</span> <span class="main">(</span><span class="bound">φ</span><span class="main">,</span> <span class="bound">φ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">φs</span> <span class="skolem">ψs</span><span class="main">)</span> <span class="main">⟹</span> wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">φ</span> <span class="bound">φ'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">φ'</span><span class="main">.</span> <span class="main">(</span><span class="bound">φ</span><span class="main">,</span> <span class="bound">φ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">φs</span> <span class="skolem">ψs</span><span class="main">)</span> <span class="main">⟹</span> wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span> <span class="bound">φ'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">φ'</span><span class="main">.</span> <span class="main">(</span><span class="bound">φ</span><span class="main">,</span> <span class="bound">φ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">φs</span> <span class="skolem">ψs</span><span class="main">)</span> <span class="main">⟹</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="bound">φ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">φ'</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="bound">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="bound">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> wf_mformula_map<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>snd <span class="main">∘</span> meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span><span class="main">)</span> <span class="skolem">φs</span><span class="main">)</span> <span class="skolem">ψs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> len_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">φs</span> <span class="main">=</span> length <span class="skolem">ψs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH_alt
      <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>map <span class="main">(</span>snd <span class="main">∘</span> meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span><span class="main">)</span> <span class="skolem">φs</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">ψs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">φ'</span><span class="main">.</span> <span class="main">(</span><span class="bound">φ</span><span class="main">,</span> <span class="bound">φ'</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="main">(</span>map <span class="main">(</span>snd <span class="main">∘</span> meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span><span class="main">)</span> <span class="skolem">φs</span><span class="main">)</span> <span class="skolem">ψs</span><span class="main">)</span> <span class="main">⟹</span> wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">φ</span> <span class="bound">φ'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> snd <span class="main">∘</span> meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span>"</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span> <span class="skolem">φ'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">φ</span><span class="main">,</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="main">(</span>map <span class="main">(</span>snd <span class="main">∘</span> meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span><span class="main">)</span> <span class="skolem">φs</span><span class="main">)</span> <span class="skolem">ψs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">φ</span><span class="main">,</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="main">(</span>map <span class="skolem">f</span> <span class="skolem">φs</span><span class="main">)</span> <span class="skolem">ψs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> f_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ''</span></span> <span class="keyword2"><span class="keyword">where</span></span> φ''_props<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">φ''</span><span class="main">,</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="skolem">φs</span> <span class="skolem">ψs</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">φ''</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> len_eq fst_conv in_set_zip nth_map snd_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ''</span><span class="main">)</span><span class="main">)</span> <span class="skolem">φ'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> φ''_props<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> f_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> nts_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>progress_regex <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">r</span> <span class="free">j</span><span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nts <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_regex_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> upt_add_eq_append<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_envs_progress_regex_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MatchP.prems<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main">]</span></span> list.rel_map
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all2_appendI list.rel_refl<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> update<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_matchP_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">I</span> <span class="skolem">r</span> <span class="main">(</span>snd <span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">aux'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>Formula.MatchP <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>Formula.fv_regex <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>Formula.MatchP <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>Formula.MatchP <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>Formula.MatchP <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">aux'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>fst <span class="keyword1">o</span> meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span><span class="main">)</span> <span class="skolem">φs</span> <span class="main">=</span> <span class="skolem">xss</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mbufnt_take <span class="main">(</span><span class="main">λ</span><span class="bound">rels</span> <span class="bound">t</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">.</span>
        <span class="keyword1">case</span> update_matchP <span class="skolem">n</span> <span class="skolem">I</span> <span class="skolem">mr</span> <span class="skolem">mrs</span> <span class="bound">rels</span> <span class="bound">t</span> <span class="bound">aux</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">z</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">zs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">z</span><span class="main">]</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">aux</span><span class="main">)</span> <span class="main">(</span>mbufn_add <span class="skolem">xss</span> <span class="skolem">buf</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">aux'</span><span class="main">)</span><span class="main">,</span> <span class="skolem">buf'</span><span class="main">,</span> <span class="skolem">nts'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">xss</span> <span class="skolem">zs</span> <span class="skolem">aux'</span> <span class="skolem">buf'</span> <span class="skolem">nts'</span>
    <span class="keyword1"><span class="command">unfolding</span></span> progress_simps
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mbufnt_take_add_induct'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">+</span> <span class="free">δ</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> z'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">aux'</span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> eq wf_envs_P_simps<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MatchP.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> safe mr buf nts_snoc<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">goal_cases</span> xss _ base step<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> xss
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> eval ψs
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all3_map map2_map_map list_all3_list_all2_conv list.rel_map
          list.rel_flip<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">ψs</span></span> <span class="quoted"><span class="skolem">φs</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> IH
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_mono_zip <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> base
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">k</span> <span class="skolem">Xs</span> <span class="skolem">z</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Un_absorb1 mrs safe mr <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> update_matchP<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list_all2_appendI
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> update_matchP<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ψs wf_mformula_map
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mr mrs safe map_split_alt list.rel_flip<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">ψs</span></span> <span class="quoted"><span class="skolem">φs</span></span><span class="main"><span class="main">]</span></span>
        list_all3_map map2_map_map list_all3_list_all2_conv  <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.intros
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_mono_zip mbufnt_take_add'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ wf_envs_P_simps<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> MatchP.prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> safe mr buf nts_snoc<span class="main"><span class="main">]</span></span>
        mbufnt_take_add'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ wf_envs_P_simps<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> MatchP.prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> safe mr buf nts_snoc<span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> IH <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MatchF <span class="skolem">r</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φs</span> <span class="skolem">mr</span> <span class="skolem">mrs</span> <span class="skolem">buf</span> <span class="skolem">nts</span> <span class="skolem">t</span> <span class="skolem">I</span> <span class="skolem">aux</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> sat.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span> mbufnt_take.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span> mbufn_add.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span> progress_simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> MatchF <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ψs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        safe<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_regex Futu Strict <span class="skolem">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mr<span class="main">:</span> <span class="quoted"><span class="quoted">"to_mregex <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">mr</span><span class="main">,</span> <span class="skolem">ψs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> mrs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">mrs</span> <span class="main">=</span> sorted_list_of_set <span class="main">(</span>LPDs <span class="skolem">mr</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ψs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">φs</span> <span class="skolem">ψs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> buf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbufn' <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="free">j</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">r</span> <span class="skolem">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nts<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_ts_regex <span class="free">σ</span> <span class="skolem">P</span> <span class="free">j</span> <span class="skolem">r</span> <span class="skolem">nts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_matchF_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">I</span> <span class="skolem">r</span> <span class="skolem">aux</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>Formula.MatchF <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">j</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> τ <span class="free">σ</span> <span class="main">(</span>min <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>progress_regex <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">r</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> length_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>Formula.MatchF <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span> <span class="free">j</span> <span class="main">+</span> length <span class="skolem">aux</span> <span class="main">=</span> progress_regex <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">r</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> list_all2_mono
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> nts_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span>
    <span class="main">[</span>progress_regex <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">r</span> <span class="free">j</span><span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nts <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_regex_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> upt_add_eq_append<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_envs_progress_regex_le<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MatchF.prems<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main">]</span></span> list.rel_map
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all2_appendI list.rel_refl<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> IH_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2
     <span class="main">(</span><span class="main">λ</span><span class="bound">x1</span> <span class="bound">x2</span><span class="main">.</span>
         wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="main">∧</span>
         <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">xa</span><span class="main">.</span>
             wf_envs <span class="free">σ</span> <span class="free">j</span> <span class="free">δ</span> <span class="skolem">P</span> <span class="bound">xa</span> <span class="skolem">V</span> <span class="bound">x</span> <span class="main">⟶</span>
             <span class="main">(</span><span class="keyword1">case</span> meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span> <span class="bound">x1</span> <span class="keyword1">of</span>
              <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">⇒</span>
                wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="bound">xa</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">x2</span> <span class="main">∧</span>
                list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="bound">x2</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">x2</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="bound">x2</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="bound">xa</span> <span class="bound">x2</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span>
                 <span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="skolem">φs</span> <span class="skolem">ψs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> MatchF.IH mr
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">φ'</span><span class="main">.</span> <span class="main">(</span><span class="bound">φ</span><span class="main">,</span> <span class="bound">φ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">φs</span> <span class="skolem">ψs</span><span class="main">)</span> <span class="main">⟹</span>
    wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">φ</span> <span class="bound">φ'</span> <span class="main">∧</span>
    wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span> <span class="bound">φ'</span> <span class="main">∧</span>
    list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="bound">φ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">φ'</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="bound">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="bound">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span> <span class="skolem">φ'</span>
    
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">φ</span><span class="main">,</span> <span class="skolem">φ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">φs</span> <span class="skolem">ψs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="main">∧</span>
            <span class="main">(</span><span class="keyword1">case</span> meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span> <span class="keyword1">of</span>
             <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">⇒</span>
               wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ'</span> <span class="main">∧</span>
               list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH_alt MatchF.prems<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x1</span> <span class="bound">x2</span><span class="main">.</span>
           wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">x1</span> <span class="bound">x2</span> <span class="main">∧</span>
           <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">xa</span><span class="main">.</span>
               wf_envs <span class="free">σ</span> <span class="free">j</span> <span class="free">δ</span> <span class="skolem">P</span> <span class="bound">xa</span> <span class="skolem">V</span> <span class="bound">x</span> <span class="main">⟶</span>
               <span class="main">(</span><span class="keyword1">case</span> meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="bound">x</span> <span class="bound">x1</span> <span class="keyword1">of</span>
                <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">⇒</span>
                  wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="bound">xa</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span> <span class="bound">x2</span> <span class="main">∧</span>
                  list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="bound">x2</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">x2</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="bound">x2</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="bound">xa</span> <span class="bound">x2</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span>
                   <span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">φs</span></span> <span class="quoted"><span class="skolem">ψs</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ'</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span> <span class="keyword1">of</span>
         <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">⇒</span>
           wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">φ'</span> <span class="main">∧</span>
           list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="bound">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span>
      <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ'</span> <span class="main">∧</span>
      wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">φ'</span> <span class="main">∧</span>
      list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">φ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="skolem">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">φ'</span><span class="main">.</span> <span class="main">(</span><span class="bound">φ</span><span class="main">,</span> <span class="bound">φ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">φs</span> <span class="skolem">ψs</span><span class="main">)</span> <span class="main">⟹</span> wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">P</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">φ</span> <span class="bound">φ'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">φ'</span><span class="main">.</span> <span class="main">(</span><span class="bound">φ</span><span class="main">,</span> <span class="bound">φ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">φs</span> <span class="skolem">ψs</span><span class="main">)</span> <span class="main">⟹</span> wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span> <span class="bound">φ'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">φ'</span><span class="main">.</span> <span class="main">(</span><span class="bound">φ</span><span class="main">,</span> <span class="bound">φ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>zip <span class="skolem">φs</span> <span class="skolem">ψs</span><span class="main">)</span> <span class="main">⟹</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="bound">φ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">φ'</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P</span> <span class="bound">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>Monitor.progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="bound">φ'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> wf_mformula_map<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span>wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>snd <span class="main">∘</span> meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span><span class="main">)</span> <span class="skolem">φs</span><span class="main">)</span> <span class="skolem">ψs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> len_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">φs</span> <span class="main">=</span> length <span class="skolem">ψs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH_alt
      <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>map <span class="main">(</span>snd <span class="main">∘</span> meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span><span class="main">)</span> <span class="skolem">φs</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">ψs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">φ'</span><span class="main">.</span> <span class="main">(</span><span class="bound">φ</span><span class="main">,</span> <span class="bound">φ'</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="main">(</span>map <span class="main">(</span>snd <span class="main">∘</span> meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span><span class="main">)</span> <span class="skolem">φs</span><span class="main">)</span> <span class="skolem">ψs</span><span class="main">)</span> <span class="main">⟹</span> wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="bound">φ</span> <span class="bound">φ'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> snd <span class="main">∘</span> meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span>"</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span> <span class="skolem">φ'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">φ</span><span class="main">,</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="main">(</span>map <span class="main">(</span>snd <span class="main">∘</span> meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span><span class="main">)</span> <span class="skolem">φs</span><span class="main">)</span> <span class="skolem">ψs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">φ</span><span class="main">,</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="main">(</span>map <span class="skolem">f</span> <span class="skolem">φs</span><span class="main">)</span> <span class="skolem">ψs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> f_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ''</span></span> <span class="keyword2"><span class="keyword">where</span></span> φ''_props<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">φ''</span><span class="main">,</span> <span class="skolem">φ'</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>zip <span class="skolem">φs</span> <span class="skolem">ψs</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">φ''</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> len_eq fst_conv in_set_zip nth_map snd_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="main">(</span>snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span> <span class="skolem">φ''</span><span class="main">)</span><span class="main">)</span> <span class="skolem">φ'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">P'</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> φ''_props<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> f_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> list_all2_iff
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xss</span> <span class="skolem">zs</span> <span class="skolem">aux'</span> <span class="skolem">aux''</span> <span class="skolem">buf'</span> <span class="skolem">nts'</span> <span class="skolem">nt</span>
    <span class="keyword3"><span class="command">assume</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>fst <span class="keyword1">o</span> meval <span class="skolem">n</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">db</span><span class="main">)</span> <span class="skolem">φs</span> <span class="main">=</span> <span class="skolem">xss</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> nt0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nt</span> <span class="main">=</span> lookahead_ts <span class="skolem">nts'</span> <span class="skolem">nts</span> <span class="main">(</span>map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"mbufnt_take <span class="main">(</span>update_matchF <span class="skolem">n</span> <span class="skolem">I</span> <span class="skolem">mr</span> <span class="skolem">mrs</span><span class="main">)</span> <span class="skolem">aux</span> <span class="main">(</span>mbufn_add <span class="skolem">xss</span> <span class="skolem">buf</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> map <span class="main">(</span>τ <span class="free">σ</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span> <span class="main">..&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="skolem">aux'</span><span class="main">,</span> <span class="skolem">buf'</span><span class="main">,</span> <span class="skolem">nts'</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_matchF <span class="skolem">I</span> <span class="skolem">mr</span> <span class="skolem">nt</span> <span class="skolem">aux'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">aux''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> update1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_matchF_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">I</span> <span class="skolem">r</span> <span class="skolem">aux'</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>Formula.MatchF <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">0</span> <span class="main">∧</span>
      progress <span class="free">σ</span> <span class="skolem">P</span> <span class="main">(</span>Formula.MatchF <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span> <span class="free">j</span> <span class="main">+</span> length <span class="skolem">aux'</span> <span class="main">=</span> progress_regex <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">r</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eval nts_snoc nts_snoc length_aux aux ψs
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> mbufnt_take_add_induct'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">+</span> <span class="free">δ</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> eq1 wf_envs_P_simps<span class="main"><span class="main">[</span></span><span class="operator">OF</span> MatchF.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> safe mr buf<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_update_matchF
          list_all3_map map2_map_map list_all3_list_all2_conv list.rel_map list.rel_flip<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">ψs</span></span> <span class="quoted"><span class="skolem">φs</span></span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> IH
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> wf_update_matchF<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ safe mr mrs<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_mono_zip<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> MatchF.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> nts'<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_ts_regex <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="skolem">r</span> <span class="skolem">nts'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eval eval nts_snoc ψs
      <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_regex_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> mbufnt_take_eqD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq1 wf_mbufn_add<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> js'<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span><span class="main">.</span> progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="bound">φ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ψs</span>"</span></span><span class="main"><span class="main"><span class="main">,</span></span></span>
              <span class="operator">OF</span> buf<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">unfolded</span> wf_mbufn'_def mr prod.case<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_mregex_progress<span class="main"><span class="main">[</span></span><span class="operator">OF</span> safe mr<span class="main"><span class="main">]</span></span> Mini_def
          list_all3_map map2_map_map list_all3_list_all2_conv list.rel_map list.rel_flip<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">ψs</span></span> <span class="quoted"><span class="skolem">φs</span></span><span class="main"><span class="main">]</span></span>
          list_all2_Cons1 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_mono_zip <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.rel_refl_strong
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> IH<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_conv_all_nth<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">have</span></span> nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nt</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> τ <span class="free">σ</span> <span class="main">(</span>min <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>progress_regex <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">r</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nts nts' <span class="keyword1"><span class="command">unfolding</span></span> nt0 t
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> hd_append hd_rev last_map wf_ts_regex_def lookahead_ts_def<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> list_all2_hdD<span class="main">(</span>1<span class="main">)</span> list_all2_hdD<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">using</span></span> list_all2_lastD <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> list_all2_hdD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list_all2_hdD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> min.absorb2 Suc_diff_Suc diff_zero less_Suc_eq_le<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> add_gr_0 list_all2_hdD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list_all2_hdD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> min.absorb2 Suc_diff_Suc diff_zero less_Suc_eq_le<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> add_gr_0 list_all2_hdD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list_all2_hdD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> min.absorb2 Suc_diff_Suc diff_zero less_Suc_eq_le<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>Formula.MatchF <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">⟹</span>
      wf_matchF_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">I</span> <span class="skolem">r</span> <span class="skolem">aux'</span> <span class="skolem">i</span> <span class="main">0</span> <span class="main">⟹</span>
      <span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">aux'</span> <span class="main">=</span> progress_regex <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">r</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">⟹</span>
      wf_matchF_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">I</span> <span class="skolem">r</span> <span class="skolem">aux''</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>Formula.MatchF <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="main">∧</span>
        <span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">zs</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>Formula.MatchF <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">∧</span>
        <span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">zs</span> <span class="main">+</span> length <span class="skolem">aux''</span> <span class="main">=</span> progress_regex <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">r</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">∧</span>
        list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>Formula.fv_regex <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>Formula.MatchF <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">[</span><span class="skolem">i</span><span class="main">..&lt;</span><span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">zs</span><span class="main">]</span> <span class="skolem">zs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">using</span></span> eq2
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">aux'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">zs</span></span> <span class="quoted"><span class="skolem">aux''</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> antisym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> progress_MatchF_le<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">aux'</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">rels</span></span> <span class="skolem"><span class="skolem">rel</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">rels</span><span class="main">,</span> <span class="skolem">rel</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> aux'<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_matchF_aux <span class="free">σ</span> <span class="skolem">V</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">I</span> <span class="skolem">r</span> <span class="skolem">aux'</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_matchF_aux_Cons<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">rels</span><span class="main">,</span> <span class="skolem">rel</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_matchF_aux_Cons1<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="main">(</span>Formula.fv_regex <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="skolem">i</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> Suc <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">aux'</span><span class="main">)</span> <span class="main">∧</span> mem <span class="skolem">I</span> <span class="main">(</span><span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> Regex.match <span class="main">(</span>Formula.sat <span class="free">σ</span> <span class="skolem">V</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="skolem">r</span> <span class="skolem">i</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="skolem">rel</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">rels</span><span class="main">,</span> <span class="skolem">rel</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> wf_matchF_aux_Cons3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> Suc_i_aux'<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">aux'</span> <span class="main">=</span> progress_regex <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">r</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>Formula.MatchF <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span><span class="skolem">nt</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that nts' <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_regex_def progress_simps nt
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1 list_all2_Cons2 upt_eq_Cons_conv
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cInf_lower τ_mono diff_le_mono <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits list.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="main">(</span>Formula.MatchF <span class="skolem">I</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span><span class="skolem">nt</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> τ_min<span class="main">:</span>  <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">(</span>min <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> min <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_of_mono monoI<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> le_progress_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">+</span> <span class="free">δ</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">⟷</span> progress <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">φ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">φ</span>
          <span class="keyword1"><span class="command">using</span></span> wf_envs_progress_le<span class="main">[</span><span class="operator">OF</span> MatchF.prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">φ</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> min_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="free">j</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">=</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">+</span> <span class="free">δ</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> progress_regex <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">r</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">⟶</span> memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?min</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>progress_regex <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">r</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="var">?min</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> τ_mono<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"progress_regex <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">r</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> that nts' wf_envs_progress_regex_le<span class="main">[</span><span class="operator">OF</span> MatchF.prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">r</span></span></span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_regex_def progress_simps nt
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cInf_greatest<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="var">?X</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 1 list_all2_Cons2 upt_eq_Cons_conv
              <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits if_splits
              <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="var">?min</span>"</span></span><span class="main"><span class="main">]</span></span>
              <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> diff_le_mono diff_le_mono2 order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> diff_le_mono diff_le_mono2<span class="main"><span class="main">]</span></span> τ_mono
              <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> contrapos_np<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">≤</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress_regex <span class="free">σ</span> <span class="skolem">P'</span> <span class="skolem">r</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">¬</span> memR <span class="skolem">I</span> <span class="main">(</span><span class="skolem">nt</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"memR <span class="skolem">I</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
        <span class="keyword1"><span class="command">using</span></span> that nts' <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_regex_def nt
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv
          <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits if_splits
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> contrapos_np<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> diff_le_mono diff_le_mono2<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems Suc_i_aux'<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">rels</span><span class="main">,</span> <span class="skolem">rel</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 1 sat.simps upt_conv_Cons <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Cons.IH<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ aux' Suc_i_aux'<span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> iff_exI qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 3 refl<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">note</span></span> conjI<span class="main">[</span><span class="operator">OF</span> nt this<span class="main"><span class="main">[</span></span><span class="operator">OF</span> progress_mono_gen<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_add1<span class="main"><span class="main">]</span></span> conjunct1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> update1<span class="main"><span class="main">]</span></span> conjunct2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> update1<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> update <span class="main">=</span> this<span class="main">[</span><span class="operator">OF</span> refl refl<span class="main">,</span> <span class="operator">rotated</span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> MatchF.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ψs wf_mformula_map
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mr mrs safe map_split_alt list.rel_flip<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">ψs</span></span> <span class="quoted"><span class="skolem">φs</span></span><span class="main"><span class="main">]</span></span>
        list_all3_map map2_map_map list_all3_list_all2_conv Let_def
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.intros
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rel_mono_zip mbufnt_take_add'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ wf_envs_P_simps<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> MatchF.prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> safe mr buf nts_snoc<span class="main"><span class="main">]</span></span>
        mbufnt_take_add'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ wf_envs_P_simps<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> MatchF.prems<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> safe mr buf nts_snoc<span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> IH update <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Monitor step›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> maux<span class="main">)</span> wf_mstate_mstep<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mstate <span class="free">φ</span> <span class="free">π</span> <span class="free">R</span> <span class="free">st</span> <span class="main">⟹</span> last_ts <span class="free">π</span> <span class="main">≤</span> snd <span class="free">tdb</span> <span class="main">⟹</span>
  wf_mstate <span class="free">φ</span> <span class="main">(</span>psnoc <span class="free">π</span> <span class="free">tdb</span><span class="main">)</span> <span class="free">R</span> <span class="main">(</span>snd <span class="main">(</span>mstep <span class="main">(</span>map_prod mk_db id <span class="free">tdb</span><span class="main">)</span> <span class="free">st</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_mstate_def mstep_def Let_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> progress_mono le_imp_diff_is_add <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prefix_of_psnocE <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> meval<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ wf_envs_mk_db<span class="main"><span class="main">]</span></span> list_all2_lengthD<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">flatten_verdicts</span> <span class="free"><span class="bound"><span class="entity">Vs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="bound">X</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Vs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flatten_verdicts_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"flatten_verdicts <span class="main">(</span><span class="free">Vs</span> <span class="main">@</span> <span class="free">Us</span><span class="main">)</span> <span class="main">=</span> flatten_verdicts <span class="free">Vs</span> <span class="main">∪</span> flatten_verdicts <span class="free">Us</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Vs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> flatten_verdicts_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> maux<span class="main">)</span> mstep_output_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_mstate <span class="free">φ</span> <span class="free">π</span> <span class="free">R</span> <span class="free">st</span>"</span></span> <span class="quoted"><span class="quoted">"last_ts <span class="free">π</span> <span class="main">≤</span> snd <span class="free">tdb</span>"</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="main">(</span>psnoc <span class="free">π</span> <span class="free">tdb</span><span class="main">)</span> <span class="free">σ</span>"</span></span> <span class="quoted"><span class="quoted">"mem_restr <span class="free">R</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> flatten_verdicts <span class="main">(</span>fst <span class="main">(</span>mstep <span class="main">(</span>map_prod mk_db id <span class="free">tdb</span><span class="main">)</span> <span class="free">st</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
    progress <span class="free">σ</span> Map.empty <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">&lt;</span> progress <span class="free">σ</span> Map.empty <span class="free">φ</span> <span class="main">(</span>Suc <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    wf_tuple <span class="main">(</span>Formula.nfv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>Formula.fv <span class="free">φ</span><span class="main">)</span> <span class="free">v</span> <span class="main">∧</span> Formula.sat <span class="free">σ</span> Map.empty <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> prefix_of_psnocE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ</span>"</span></span>
    <span class="quoted"><span class="quoted">"Γ <span class="free">σ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">tdb</span>"</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">=</span> snd <span class="free">tdb</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹prefix_of <span class="free">π</span> <span class="free">σ</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mstate_n <span class="free">st</span> <span class="main">=</span> Formula.nfv <span class="free">φ</span>"</span></span>
    <span class="quoted"><span class="quoted">"mstate_i <span class="free">st</span> <span class="main">=</span> progress <span class="free">σ</span> Map.empty <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> Map.empty Map.empty <span class="main">(</span>mstate_n <span class="free">st</span><span class="main">)</span> <span class="free">R</span> <span class="main">(</span>mstate_m <span class="free">st</span><span class="main">)</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wf_mstate_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> meval<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹wf_mformula <span class="free">σ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> Map.empty Map.empty <span class="main">(</span>mstate_n <span class="free">st</span><span class="main">)</span> <span class="free">R</span> <span class="main">(</span>mstate_m <span class="free">st</span><span class="main">)</span> <span class="free">φ</span>›</span></span> wf_envs_mk_db<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Vs</span></span> <span class="skolem"><span class="skolem">st'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"meval <span class="main">(</span>mstate_n <span class="free">st</span><span class="main">)</span> <span class="main">[</span>τ <span class="free">σ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>mk_db <span class="main">(</span>Γ <span class="free">σ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mstate_m <span class="free">st</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Vs</span><span class="main">,</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span>Suc <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span> Map.empty Map.empty <span class="main">(</span>mstate_n <span class="free">st</span><span class="main">)</span> <span class="free">R</span> <span class="skolem">st'</span> <span class="free">φ</span>"</span></span>
    <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="main">(</span>mstate_n <span class="free">st</span><span class="main">)</span> <span class="main">(</span>fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> Map.empty <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> Map.empty <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">..&lt;</span>progress <span class="free">σ</span> Map.empty <span class="free">φ</span> <span class="main">(</span>Suc <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="skolem">Vs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"qtable <span class="main">(</span>mstate_n <span class="free">st</span><span class="main">)</span> <span class="main">(</span>fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Formula.sat <span class="free">σ</span> Map.empty <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Vs</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> progress <span class="free">σ</span> Map.empty <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> Map.empty <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> progress <span class="free">σ</span> Map.empty <span class="free">φ</span> <span class="main">(</span>Suc <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_conv_all_nth
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">-</span> progress <span class="free">σ</span> Map.empty <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> mstep_def Let_def flatten_verdicts_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_enumerate_eq list_all2_conv_all_nth progress_mono le_imp_diff_is_add
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_qtableE in_qtableI <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="skolem">Vs</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> progress <span class="free">σ</span> Map.empty <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Monitor function›</span></span>

<span class="keyword1"><span class="command">locale</span></span> verimon <span class="main">=</span> verimon_spec <span class="main">+</span> maux

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> verimon<span class="main">)</span> mstep_mverdicts<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mstate <span class="free">φ</span> <span class="free">π</span> <span class="free">R</span> <span class="free">st</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"last_ts <span class="free">π</span> <span class="main">≤</span> snd <span class="free">tdb</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> restrict<span class="main">:</span> <span class="quoted"><span class="quoted">"mem_restr <span class="free">R</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> flatten_verdicts <span class="main">(</span>fst <span class="main">(</span>mstep <span class="main">(</span>map_prod mk_db id <span class="free">tdb</span><span class="main">)</span> <span class="free">st</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
    <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> M <span class="main">(</span>psnoc <span class="free">π</span> <span class="free">tdb</span><span class="main">)</span> <span class="main">-</span> M <span class="free">π</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> p2<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="main">(</span>psnoc <span class="free">π</span> <span class="free">tdb</span><span class="main">)</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_prefix_of <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> le <span class="keyword1"><span class="command">have</span></span> p1<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prefix_of_psnocE<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> M_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p2 progress_prefix_conv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ p1<span class="main"><span class="main">]</span></span> sat_prefix_conv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ p1<span class="main"><span class="main">]</span></span> not_less
        pprogress_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p1<span class="main"><span class="main">]</span></span> pprogress_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p2<span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mstep_output_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf le p2 restrict<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">σ</span></span><span class="main"><span class="main">]</span></span>
        mstep_output_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf le _ restrict<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span> progress_sat_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p1<span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mstep_output_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf le p2 restrict<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span> p1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> maux
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">msteps0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">msteps0</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">msteps0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tdb</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">V'</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span> <span class="main">=</span> mstep <span class="main">(</span>map_prod mk_db id <span class="free"><span class="bound"><span class="entity">tdb</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">;</span> <span class="main">(</span><span class="bound">V''</span><span class="main">,</span> <span class="bound">st''</span><span class="main">)</span> <span class="main">=</span> <span class="free">msteps0</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="bound">st'</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">V'</span> <span class="main">@</span> <span class="bound">V''</span><span class="main">,</span> <span class="bound">st''</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">msteps0_stateless</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">msteps0_stateless</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">msteps0_stateless</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tdb</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">V'</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span> <span class="main">=</span> mstep <span class="main">(</span>map_prod mk_db id <span class="free"><span class="bound"><span class="entity">tdb</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="keyword1">in</span> <span class="bound">V'</span> <span class="main">@</span> <span class="free">msteps0_stateless</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="bound">st'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> msteps0_msteps0_stateless<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>msteps0 <span class="free">w</span> <span class="free">st</span><span class="main">)</span> <span class="main">=</span> msteps0_stateless <span class="free">w</span> <span class="free">st</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">st</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> msteps <span class="main">::</span> <span class="quoted"><span class="quoted">"Formula.prefix <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mstate <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> event_data table<span class="main">)</span> list <span class="main">×</span> <span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mstate"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">msteps0</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> msteps_stateless <span class="main">::</span> <span class="quoted"><span class="quoted">"Formula.prefix <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'msaux</span><span class="main">,</span> <span class="tfree">'muaux</span><span class="main">,</span> <span class="tfree">'mtaux</span><span class="main">)</span> mstate <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> event_data table<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">msteps0_stateless</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> msteps_msteps_stateless<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>msteps <span class="free">w</span> <span class="free">st</span><span class="main">)</span> <span class="main">=</span> msteps_stateless <span class="free">w</span> <span class="free">st</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> msteps0_msteps0_stateless<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> msteps0_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"msteps0 <span class="main">(</span><span class="free">π</span> <span class="main">@</span> <span class="main">[</span><span class="free">tdb</span><span class="main">]</span><span class="main">)</span> <span class="free">st</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">V'</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span> <span class="main">=</span> msteps0 <span class="free">π</span> <span class="free">st</span><span class="main">;</span> <span class="main">(</span><span class="bound">V''</span><span class="main">,</span> <span class="bound">st''</span><span class="main">)</span> <span class="main">=</span> mstep <span class="main">(</span>map_prod mk_db id <span class="free">tdb</span><span class="main">)</span> <span class="bound">st'</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">V'</span> <span class="main">@</span> <span class="bound">V''</span><span class="main">,</span> <span class="bound">st''</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">π</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">st</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> msteps_psnoc<span class="main">:</span> <span class="quoted"><span class="quoted">"last_ts <span class="free">π</span> <span class="main">≤</span> snd <span class="free">tdb</span> <span class="main">⟹</span> msteps <span class="main">(</span>psnoc <span class="free">π</span> <span class="free">tdb</span><span class="main">)</span> <span class="free">st</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">V'</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span> <span class="main">=</span> msteps <span class="free">π</span> <span class="free">st</span><span class="main">;</span> <span class="main">(</span><span class="bound">V''</span><span class="main">,</span> <span class="bound">st''</span><span class="main">)</span> <span class="main">=</span> mstep <span class="main">(</span>map_prod mk_db id <span class="free">tdb</span><span class="main">)</span> <span class="bound">st'</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">V'</span> <span class="main">@</span> <span class="bound">V''</span><span class="main">,</span> <span class="bound">st''</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer'</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> msteps0_snoc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits prod.splits if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">monitor</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">monitor</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">=</span> msteps_stateless <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span>minit_safe <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Suc_length_conv_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="free">n</span> <span class="main">=</span> length <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span> <span class="main">∧</span> length <span class="bound">ys</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> verimon<span class="main">)</span> wf_mstate_msteps<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mstate <span class="free">φ</span> <span class="free">π</span> <span class="free">R</span> <span class="free">st</span> <span class="main">⟹</span> mem_restr <span class="free">R</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">π</span> <span class="main">≤</span> <span class="free">π'</span> <span class="main">⟹</span>
  <span class="free">X</span> <span class="main">=</span> msteps <span class="main">(</span>pdrop <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="free">π'</span><span class="main">)</span> <span class="free">st</span> <span class="main">⟹</span> wf_mstate <span class="free">φ</span> <span class="free">π'</span> <span class="free">R</span> <span class="main">(</span>snd <span class="free">X</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> flatten_verdicts <span class="main">(</span>fst <span class="free">X</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> M <span class="free">π'</span> <span class="main">-</span> M <span class="free">π</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"plen <span class="free">π'</span> <span class="main">-</span> plen <span class="free">π</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">st</span></span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="free">π'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">from</span></span> 0<span class="main">(</span>1<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">=</span> <span class="skolem">π'</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">st</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> 0<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> flatten_verdicts_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>2<span class="main">,</span>5<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π''</span></span> <span class="skolem"><span class="skolem">tdb</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> plen <span class="skolem">π''</span> <span class="main">-</span> plen <span class="skolem">π</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">≤</span> <span class="skolem">π''</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">π'</span> <span class="main">=</span> psnoc <span class="skolem">π''</span> <span class="skolem">tdb</span>"</span></span> <span class="quoted"><span class="quoted">"pdrop <span class="main">(</span>plen <span class="skolem">π</span><span class="main">)</span> <span class="main">(</span>psnoc <span class="skolem">π''</span> <span class="skolem">tdb</span><span class="main">)</span> <span class="main">=</span> psnoc <span class="main">(</span>pdrop <span class="main">(</span>plen <span class="skolem">π</span><span class="main">)</span> <span class="skolem">π''</span><span class="main">)</span> <span class="skolem">tdb</span>"</span></span>
    <span class="quoted"><span class="quoted">"last_ts <span class="main">(</span>pdrop <span class="main">(</span>plen <span class="skolem">π</span><span class="main">)</span> <span class="skolem">π''</span><span class="main">)</span> <span class="main">≤</span> snd <span class="skolem">tdb</span>"</span></span> <span class="quoted"><span class="quoted">"last_ts <span class="skolem">π''</span> <span class="main">≤</span> snd <span class="skolem">tdb</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">π''</span> <span class="main">≤</span> psnoc <span class="skolem">π''</span> <span class="skolem">tdb</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> prefix<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>prefix _ _ <span class="skolem">π'</span> _ <span class="skolem">π_tdb</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">π_tdb</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">π</span> <span class="skolem">tdb</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> prefix <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π'</span> <span class="main">@</span> <span class="skolem">π</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">tdb</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_append append_eq_Cons_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits if_splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> refl<span class="main">]</span> Suc.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> msteps_msteps_stateless<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> msteps_psnoc split_beta mstep_mverdicts
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mono_monitor<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> set_mp<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mstate_mstep<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> verimon<span class="main">)</span> wf_mstate_msteps_stateless<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_mstate <span class="free">φ</span> <span class="free">π</span> <span class="free">R</span> <span class="free">st</span>"</span></span> <span class="quoted"><span class="quoted">"mem_restr <span class="free">R</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">≤</span> <span class="free">π'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> flatten_verdicts <span class="main">(</span>msteps_stateless <span class="main">(</span>pdrop <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="free">π'</span><span class="main">)</span> <span class="free">st</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> M <span class="free">π'</span> <span class="main">-</span> M <span class="free">π</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf_mstate_msteps<span class="main">[</span><span class="operator">OF</span> assms refl<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> msteps_msteps_stateless <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> verimon<span class="main">)</span> wf_mstate_msteps_stateless_UNIV<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mstate <span class="free">φ</span> <span class="free">π</span> UNIV <span class="free">st</span> <span class="main">⟹</span> <span class="free">π</span> <span class="main">≤</span> <span class="free">π'</span> <span class="main">⟹</span>
  flatten_verdicts <span class="main">(</span>msteps_stateless <span class="main">(</span>pdrop <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="free">π'</span><span class="main">)</span> <span class="free">st</span><span class="main">)</span> <span class="main">=</span> M <span class="free">π'</span> <span class="main">-</span> M <span class="free">π</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wf_mstate_msteps_stateless<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ mem_restr_UNIV<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> verimon<span class="main">)</span> mverdicts_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"M pnil <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def pprogress_eq<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> maux
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> minit_safe_minit<span class="main">:</span> <span class="quoted"><span class="quoted">"mmonitorable <span class="free">φ</span> <span class="main">⟹</span> minit_safe <span class="free">φ</span> <span class="main">=</span> minit <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> minit_safe_def monitorable_formula_code <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_mstate_minit_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"mmonitorable <span class="free">φ</span> <span class="main">⟹</span> wf_mstate <span class="free">φ</span> pnil <span class="free">R</span> <span class="main">(</span>minit_safe <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf_mstate_minit minit_safe_minit mmonitorable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> verimon<span class="main">)</span> monitor_mverdicts<span class="main">:</span> <span class="quoted"><span class="quoted">"flatten_verdicts <span class="main">(</span>monitor <span class="free">φ</span> <span class="free">π</span><span class="main">)</span> <span class="main">=</span> M <span class="free">π</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> monitor_def <span class="keyword1"><span class="command">using</span></span> monitorable
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> wf_mstate_msteps_stateless_UNIV<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_mstate_minit_safe<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmonitorable_def mverdicts_Nil<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Collected correctness results›</span></span>

<span class="keyword1"><span class="command">context</span></span> verimon
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We summarize the main results proved above.
\begin{enumerate}
\item The term <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">M</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> describes semantically the monitor's expected behaviour:
\begin{itemize}
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] mono_monitor<span class="antiquote"><span class="antiquote">}</span></span></span></span>: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> mono_monitor<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] sound_monitor<span class="antiquote"><span class="antiquote">}</span></span></span></span>: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> sound_monitor<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] complete_monitor<span class="antiquote"><span class="antiquote">}</span></span></span></span>: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> complete_monitor<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] sliceable_M<span class="antiquote"><span class="antiquote">}</span></span></span></span>: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> sliceable_M<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\end{itemize}
\item The executable monitor's online interface <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">minit_safe</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">mstep</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  preserves the invariant <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">wf_mstate</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and produces the the verdicts according
  to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">M</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:
\begin{itemize}
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] wf_mstate_minit_safe<span class="antiquote"><span class="antiquote">}</span></span></span></span>: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> wf_mstate_minit_safe<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] wf_mstate_mstep<span class="antiquote"><span class="antiquote">}</span></span></span></span>: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> wf_mstate_mstep<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] mstep_mverdicts<span class="antiquote"><span class="antiquote">}</span></span></span></span>: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> mstep_mverdicts<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\end{itemize}
\item The executable monitor's offline interface <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">monitor</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> implements <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">M</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:
\begin{itemize}
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] monitor_mverdicts<span class="antiquote"><span class="antiquote">}</span></span></span></span>: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> monitor_mverdicts<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\end{itemize}
\end{enumerate}
›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</body>

</html>