<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Code_Double</title>
</head>


<body>
<div class="head">
<h1>Theory Code_Double</h1>
</div>

<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Code_Double
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../IEEE_Floating_Point/IEEE_Properties.html">IEEE_Floating_Point.IEEE_Properties</a>
    <a href="../IEEE_Floating_Point/Conversion_IEEE_Float.html">IEEE_Floating_Point.Conversion_IEEE_Float</a>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Code_Target_Int.html">HOL-Library.Code_Target_Int</a>"</span>
    <a href="../Containers/Collection_Eq.html">Containers.Collection_Eq</a>
    <a href="../Containers/Collection_Order.html">Containers.Collection_Order</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Code adaptation for IEEE double-precision floats›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹copysign›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> copysign <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> <span class="keyword1">float</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> <span class="keyword1">float</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> <span class="keyword1">float</span>"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">e</span><span class="main">::</span><span class="tfree">'e</span> word<span class="main">,</span> <span class="bound">f</span><span class="main">::</span><span class="tfree">'f</span> word<span class="main">)</span> <span class="main">(</span><span class="bound">s</span><span class="main">::</span><span class="main">1</span> word<span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">e</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_nan_copysign<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_nan <span class="main">(</span>copysign <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">⟷</span> is_nan <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_nan_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Additional lemmas about generic floats›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_nan_some_nan<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_nan <span class="main">(</span>some_nan <span class="main">::</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> <span class="keyword1">float</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> some_nan_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> someI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"Abs_float <span class="main">(</span><span class="main">0</span><span class="main">,</span> max_word <span class="main">::</span> <span class="tfree">'e</span> word<span class="main">,</span> <span class="main">1</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_nan_def exponent_def fraction_def emax_def Abs_float_inverse<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_is_nan_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_nan <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_nan_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_is_nan_1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_nan <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_nan_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> is_nan_plus<span class="main">:</span> <span class="quoted"><span class="quoted">"is_nan <span class="free">x</span> <span class="main">∨</span> is_nan <span class="free">y</span> <span class="main">⟹</span> is_nan <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> plus_float_def fadd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_nan_minus<span class="main">:</span> <span class="quoted"><span class="quoted">"is_nan <span class="free">x</span> <span class="main">∨</span> is_nan <span class="free">y</span> <span class="main">⟹</span> is_nan <span class="main">(</span><span class="free">x</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> minus_float_def fsub_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_nan_times<span class="main">:</span> <span class="quoted"><span class="quoted">"is_nan <span class="free">x</span> <span class="main">∨</span> is_nan <span class="free">y</span> <span class="main">⟹</span> is_nan <span class="main">(</span><span class="free">x</span> <span class="main">*</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> times_float_def fmul_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_nan_divide<span class="main">:</span> <span class="quoted"><span class="quoted">"is_nan <span class="free">x</span> <span class="main">∨</span> is_nan <span class="free">y</span> <span class="main">⟹</span> is_nan <span class="main">(</span><span class="free">x</span> <span class="main">/</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> divide_float_def fdiv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_nan_float_sqrt<span class="main">:</span> <span class="quoted"><span class="quoted">"is_nan <span class="free">x</span> <span class="main">⟹</span> is_nan <span class="main">(</span>float_sqrt <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> float_sqrt_def fsqrt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> nan_fcompare<span class="main">:</span> <span class="quoted"><span class="quoted">"is_nan <span class="free">x</span> <span class="main">∨</span> is_nan <span class="free">y</span> <span class="main">⟹</span> fcompare <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> Und"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fcompare_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> nan_not_le<span class="main">:</span> <span class="quoted"><span class="quoted">"is_nan <span class="free">x</span> <span class="main">∨</span> is_nan <span class="free">y</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_eq_float_def fle_def fcompare_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> nan_not_less<span class="main">:</span> <span class="quoted"><span class="quoted">"is_nan <span class="free">x</span> <span class="main">∨</span> is_nan <span class="free">y</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> less_float_def flt_def fcompare_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> nan_not_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"is_nan <span class="free">x</span> <span class="main">⟹</span> <span class="main">¬</span> is_zero <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_nan_def is_zero_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> nan_not_infinity<span class="main">:</span> <span class="quoted"><span class="quoted">"is_nan <span class="free">x</span> <span class="main">⟹</span> <span class="main">¬</span> is_infinity <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_nan_def is_infinity_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> zero_not_infinity<span class="main">:</span> <span class="quoted"><span class="quoted">"is_zero <span class="free">x</span> <span class="main">⟹</span> <span class="main">¬</span> is_infinity <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_zero_def is_infinity_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> zero_not_nan<span class="main">:</span> <span class="quoted"><span class="quoted">"is_zero <span class="free">x</span> <span class="main">⟹</span> <span class="main">¬</span> is_nan <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_zero_def is_nan_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">lemma</span></span> minus_one_power_one_word<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="main">1</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">^</span> unat <span class="main">(</span><span class="free">x</span> <span class="main">::</span> <span class="main">1</span> word<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> unat <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unat <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> unat <span class="free">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> le_SucE<span class="main">[</span><span class="operator">OF</span> unat_one_word_le<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">valofn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> <span class="keyword1">float</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valofn</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span><span class="main">^</span>exponent <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span>bias <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> <span class="keyword1">float</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
      <span class="main">(</span><span class="main">1</span> <span class="main">+</span> real <span class="main">(</span>fraction <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'f</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">valofd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> <span class="keyword1">float</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valofd</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span>bias <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> <span class="keyword1">float</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>real <span class="main">(</span>fraction <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'f</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valof_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"valof <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> exponent <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span>
    <span class="keyword1">if</span> sign <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> valofd <span class="free">x</span> <span class="keyword1">else</span> <span class="main">-</span> valofd <span class="free">x</span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> sign <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> valofn <span class="free">x</span> <span class="keyword1">else</span> <span class="main">-</span> valofn <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> valofn_def valofd_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minus_one_power_one_word unat_eq_0 <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fraction_less_2p<span class="main">:</span> <span class="quoted"><span class="quoted">"fraction <span class="main">(</span><span class="free">x</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> <span class="keyword1">float</span><span class="main">)</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">^</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> valofn_ge_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> valofn <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> valofn_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> valofn_ge_2p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">^</span>exponent <span class="main">(</span><span class="free">x</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> <span class="keyword1">float</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span>bias <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> <span class="keyword1">float</span><span class="main">)</span> <span class="main">≤</span> valofn <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> valofn_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valofn_less_2p<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> <span class="keyword1">float</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exponent <span class="free">x</span> <span class="main">&lt;</span> <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valofn <span class="free">x</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">^</span><span class="free">e</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span>bias <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> <span class="keyword1">float</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> real <span class="main">(</span>fraction <span class="free">x</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'f</span><span class="main">)</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fraction_less_2p<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valofn <span class="free">x</span> <span class="main">&lt;</span> <span class="main">(</span><span class="numeral">2</span><span class="main">^</span>exponent <span class="free">x</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span>bias <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> <span class="keyword1">float</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> valofn_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="numeral">2</span><span class="main">^</span><span class="free">e</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span>bias <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> <span class="keyword1">float</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> exp_less<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valofd_ge_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> valofd <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> valofd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> valofd_less_2p<span class="main">:</span> <span class="quoted"><span class="quoted">"valofd <span class="main">(</span><span class="free">x</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> <span class="keyword1">float</span><span class="main">)</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span>bias <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> <span class="keyword1">float</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> valofd_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fraction_less_2p <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valofn_le_imp_exponent_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> <span class="keyword1">float</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valofn <span class="free">x</span> <span class="main">≤</span> valofn <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"exponent <span class="free">x</span> <span class="main">≤</span> exponent <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> exponent <span class="free">x</span> <span class="main">≤</span> exponent <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valofn <span class="free">y</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">^</span>exponent <span class="free">x</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span>bias <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> <span class="keyword1">float</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valofn_less_2p<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> valofn <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> valofn_ge_2p<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valofn_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> <span class="keyword1">float</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valofn <span class="free">x</span> <span class="main">=</span> valofn <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"exponent <span class="free">x</span> <span class="main">=</span> exponent <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"fraction <span class="free">x</span> <span class="main">=</span> fraction <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"exponent <span class="free">x</span> <span class="main">=</span> exponent <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> antisym valofn_le_imp_exponent_le<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fraction <span class="free">x</span> <span class="main">=</span> fraction <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> valofn_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valofd_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> <span class="keyword1">float</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valofd <span class="free">x</span> <span class="main">=</span> valofd <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fraction <span class="free">x</span> <span class="main">=</span> fraction <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> valofd_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_zero_valof_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_zero <span class="free">x</span> <span class="main">⟷</span> valof <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_zero_def valof_alt
  <span class="keyword1"><span class="command">using</span></span> valofn_ge_2p<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valofd_def <span class="dynamic"><span class="dynamic">field_simps</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> order.antisym<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valofd_neq_valofn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> <span class="keyword1">float</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"exponent <span class="free">y</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valofd <span class="free">x</span> <span class="main">≠</span> valofn <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"valofn <span class="free">y</span> <span class="main">≠</span> valofd <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valofd <span class="free">x</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">^</span>bias <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> <span class="keyword1">float</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> valofd_less_2p<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">^</span> IEEE.exponent <span class="free">y</span> <span class="main">/</span> <span class="numeral">2</span> <span class="main">^</span> bias <span class="keyword1">TYPE</span><span class="main">(</span><span class="main">(</span><span class="tfree">'e</span><span class="main">,</span> <span class="tfree">'f</span><span class="main">)</span> IEEE.float<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> self_le_power <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> valofn <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> valofn_ge_2p<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"valofd <span class="free">x</span> <span class="main">≠</span> valofn <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"valofn <span class="free">y</span> <span class="main">≠</span> valofd <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sign_gt_0_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> sign <span class="free">x</span> <span class="main">⟷</span> sign <span class="free">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sign_cases<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> valof_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_zero <span class="free">x</span> <span class="main">∨</span> <span class="main">¬</span> is_zero <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valof <span class="free">x</span> <span class="main">=</span> valof <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"valof <span class="free">x</span> <span class="main">=</span> valof <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valof <span class="free">y</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_zero_valof_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> valof_alt
    <span class="keyword1"><span class="command">using</span></span> valofd_ge_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> valofd_ge_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> valofn_ge_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> valofn_ge_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valofd_neq_valofn sign_gt_0_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> float_eqI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> valofn_eq valofd_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> zero_fcompare<span class="main">:</span> <span class="quoted"><span class="quoted">"is_zero <span class="free">x</span> <span class="main">⟹</span> is_zero <span class="free">y</span> <span class="main">⟹</span> fcompare <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> ccode.Eq"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fcompare_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_not_infinity zero_not_nan is_zero_valof_conv<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Doubles with a unified NaN value›</span></span>

<span class="keyword1"><span class="command">quotient_type</span></span> double <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="numeral">11</span><span class="main">,</span> <span class="numeral">52</span><span class="main">)</span> <span class="keyword1">float</span>"</span></span> <span class="main">/</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> is_nan <span class="bound">x</span> <span class="main">∧</span> is_nan <span class="bound">y</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> equivpI reflpI sympI transpI<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> double <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>zero<span class="main">,</span> one<span class="main">,</span> plus<span class="main">,</span> minus<span class="main">,</span> uminus<span class="main">,</span> times<span class="main">,</span> ord<span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">zero_double</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"double"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">one_double</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"double"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">plus_double</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"double <span class="main">⇒</span> double <span class="main">⇒</span> double"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">plus</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_nan_plus<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">minus_double</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"double <span class="main">⇒</span> double <span class="main">⇒</span> double"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">minus</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_nan_minus<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">uminus_double</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"double <span class="main">⇒</span> double"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">uminus</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">times_double</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"double <span class="main">⇒</span> double <span class="main">⇒</span> double"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">times</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_nan_times<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">less_eq_double</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"double <span class="main">⇒</span> double <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(≤)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nan_not_le<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">less_double</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"double <span class="main">⇒</span> double <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(&lt;)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nan_not_less<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> double <span class="main">::</span> <span class="quoted">inverse</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">divide_double</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"double <span class="main">⇒</span> double <span class="main">⇒</span> double"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">divide</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_nan_divide<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">inverse_double</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"double <span class="main">⇒</span> double"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inverse_double</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">div</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> sqrt_double <span class="main">::</span> <span class="quoted"><span class="quoted">"double <span class="main">⇒</span> double"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">float_sqrt</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_nan_float_sqrt<span class="main">)</span>

<span class="keyword1"><span class="command">no_notation</span></span> plus_infinity <span class="main">(</span><span class="quoted">"<span class="keyword1">∞</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> infinity <span class="main">::</span> <span class="quoted"><span class="quoted">"double"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">plus_infinity</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> nan <span class="main">::</span> <span class="quoted"><span class="quoted">"double"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">some_nan</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> is_zero <span class="main">::</span> <span class="quoted"><span class="quoted">"double <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">IEEE.is_zero</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nan_not_zero<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> is_infinite <span class="main">::</span> <span class="quoted"><span class="quoted">"double <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">IEEE.is_infinity</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nan_not_infinity<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> is_nan <span class="main">::</span> <span class="quoted"><span class="quoted">"double <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">IEEE.is_nan</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> is_nan_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"is_nan <span class="free">x</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> nan"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lift_definition</span></span> copysign_double <span class="main">::</span> <span class="quoted"><span class="quoted">"double <span class="main">⇒</span> double <span class="main">⇒</span> double"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> IEEE.is_nan <span class="bound">y</span> <span class="keyword1">then</span> some_nan <span class="keyword1">else</span> copysign <span class="bound">x</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> copysign_double<span class="antiquote"><span class="antiquote">}</span></span></span></span> deviates from the IEEE standard in cases where
  the second argument is a NaN.›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> fcompare_double <span class="main">::</span> <span class="quoted"><span class="quoted">"double <span class="main">⇒</span> double <span class="main">⇒</span> ccode"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">fcompare</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nan_fcompare<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nan_fcompare_double<span class="main">:</span> <span class="quoted"><span class="quoted">"is_nan <span class="free">x</span> <span class="main">∨</span> is_nan <span class="free">y</span> <span class="main">⟹</span> fcompare_double <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> Und"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> nan_fcompare<span class="main">)</span>

<span class="keyword1"><span class="command">consts</span></span> compare_double <span class="main">::</span> <span class="quoted"><span class="quoted">"double <span class="main">⇒</span> double <span class="main">⇒</span> integer"</span></span>

<span class="keyword1"><span class="command">specification</span></span> <span class="main">(</span><span class="quoted">compare_double</span><span class="main">)</span>
  compare_double_less<span class="main">:</span> <span class="quoted"><span class="quoted">"compare_double <span class="free">x</span> <span class="free">y</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">⟷</span> is_nan <span class="free">x</span> <span class="main">∧</span> <span class="main">¬</span> is_nan <span class="free">y</span> <span class="main">∨</span> fcompare_double <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> ccode.Lt"</span></span>
  compare_double_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"compare_double <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> is_nan <span class="free">x</span> <span class="main">∧</span> is_nan <span class="free">y</span> <span class="main">∨</span> fcompare_double <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> ccode.Eq"</span></span>
  compare_double_greater<span class="main">:</span> <span class="quoted"><span class="quoted">"compare_double <span class="free">x</span> <span class="free">y</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟷</span> <span class="main">¬</span> is_nan <span class="free">x</span> <span class="main">∧</span> is_nan <span class="free">y</span> <span class="main">∨</span> fcompare_double <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> ccode.Gt"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> is_nan <span class="bound">x</span> <span class="keyword1">then</span> <span class="keyword1">if</span> is_nan <span class="bound">y</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">-</span><span class="main">1</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> is_nan <span class="bound">y</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">case</span> fcompare_double <span class="bound">x</span> <span class="bound">y</span> <span class="keyword1">of</span> ccode.Eq <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> ccode.Lt <span class="main">⇒</span> <span class="main">-</span><span class="main">1</span> <span class="main">|</span> ccode.Gt <span class="main">⇒</span> <span class="main">1</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fcompare_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> compare_double_simps <span class="main">=</span> compare_double_less compare_double_eq compare_double_greater

<span class="keyword1"><span class="command">lemma</span></span> compare_double_le_0<span class="main">:</span> <span class="quoted"><span class="quoted">"compare_double <span class="free">x</span> <span class="free">y</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">⟷</span>
  is_nan <span class="free">x</span> <span class="main">∨</span> fcompare_double <span class="free">x</span> <span class="free">y</span> <span class="main">∈</span> <span class="main">{</span>ccode.Eq<span class="main">,</span> ccode.Lt<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> linorder_cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"compare_double <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> compare_double_simps nan_fcompare_double<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> double_of_integer <span class="main">::</span> <span class="quoted"><span class="quoted">"integer <span class="main">⇒</span> double"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> zerosign <span class="main">0</span> <span class="main">(</span>intround To_nearest <span class="main">(</span>int_of_integer <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">double_of_int</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">double_of_int</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> double_of_integer <span class="main">(</span>integer_of_int <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"double_of_int <span class="main">(</span>int_of_integer <span class="free">x</span><span class="main">)</span> <span class="main">=</span> double_of_integer <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> double_of_int_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lift_definition</span></span> integer_of_double <span class="main">::</span> <span class="quoted"><span class="quoted">"double <span class="main">⇒</span> integer"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> IEEE.is_nan <span class="bound">x</span> <span class="main">∨</span> IEEE.is_infinity <span class="bound">x</span> <span class="keyword1">then</span> undefined
     <span class="keyword1">else</span> integer_of_int <span class="main">⌊</span>valof <span class="main">(</span>intround float_To_zero <span class="main">(</span>valof <span class="bound">x</span><span class="main">)</span> <span class="main">::</span> <span class="main">(</span><span class="numeral">11</span><span class="main">,</span> <span class="numeral">52</span><span class="main">)</span> <span class="keyword1">float</span><span class="main">)</span><span class="main">⌋</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> int_of_double<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">int_of_double</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> int_of_integer <span class="main">(</span>integer_of_double <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Linear ordering›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lcompare_double</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"double <span class="main">⇒</span> double <span class="main">⇒</span> integer"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lcompare_double</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> is_zero <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> is_zero <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span>
      compare_double <span class="main">(</span>copysign_double <span class="main">1</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>copysign_double <span class="main">1</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> compare_double <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fcompare_double_swap<span class="main">:</span> <span class="quoted"><span class="quoted">"fcompare_double <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> ccode.Gt <span class="main">⟷</span> fcompare_double <span class="free">y</span> <span class="free">x</span> <span class="main">=</span> ccode.Lt"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fcompare_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fcompare_double_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_nan <span class="free">x</span> <span class="main">⟹</span> fcompare_double <span class="free">x</span> <span class="free">x</span> <span class="main">=</span> ccode.Eq"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fcompare_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fcompare_double_Eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"fcompare_double <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> ccode.Eq <span class="main">⟹</span> fcompare_double <span class="free">y</span> <span class="free">z</span> <span class="main">=</span> <span class="free">c</span> <span class="main">⟹</span> fcompare_double <span class="free">x</span> <span class="free">z</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fcompare_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fcompare_double_Eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"fcompare_double <span class="free">y</span> <span class="free">z</span> <span class="main">=</span> ccode.Eq <span class="main">⟹</span> fcompare_double <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="free">c</span> <span class="main">⟹</span> fcompare_double <span class="free">x</span> <span class="free">z</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fcompare_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fcompare_double_Lt_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"fcompare_double <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> ccode.Lt <span class="main">⟹</span> fcompare_double <span class="free">y</span> <span class="free">z</span> <span class="main">=</span> ccode.Lt <span class="main">⟹</span> fcompare_double <span class="free">x</span> <span class="free">z</span> <span class="main">=</span> ccode.Lt"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fcompare_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fcompare_double_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_zero <span class="free">x</span> <span class="main">∨</span> <span class="main">¬</span> is_zero <span class="free">y</span> <span class="main">⟹</span> fcompare_double <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> ccode.Eq <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fcompare_def valof_eq IEEE.is_infinity_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> float_eqI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fcompare_double_Lt_asym<span class="main">:</span> <span class="quoted"><span class="quoted">"fcompare_double <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> ccode.Lt <span class="main">⟹</span> fcompare_double <span class="free">y</span> <span class="free">x</span> <span class="main">=</span> ccode.Lt <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fcompare_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> compare_double_swap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> compare_double <span class="free">x</span> <span class="free">y</span> <span class="main">⟷</span> compare_double <span class="free">y</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> compare_double_simps fcompare_double_swap<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> compare_double_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"compare_double <span class="free">x</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> compare_double_eq <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fcompare_double_refl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> compare_double_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"compare_double <span class="free">x</span> <span class="free">y</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">⟹</span> compare_double <span class="free">y</span> <span class="free">z</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">⟹</span> compare_double <span class="free">x</span> <span class="free">z</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> compare_double_le_0 nan_fcompare_double
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fcompare_double_Eq1 fcompare_double_Eq2 fcompare_double_Lt_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> compare_double_antisym<span class="main">:</span> <span class="quoted"><span class="quoted">"compare_double <span class="free">x</span> <span class="free">y</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">⟹</span> compare_double <span class="free">y</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">⟹</span>
  <span class="main">¬</span> is_zero <span class="free">x</span> <span class="main">∨</span> <span class="main">¬</span> is_zero <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> compare_double_le_0
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nan_fcompare_double is_nan_conv
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fcompare_double_eq fcompare_double_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fcompare_double_Lt_asym<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zero_compare_double_copysign<span class="main">:</span> <span class="quoted"><span class="quoted">"compare_double <span class="main">(</span>copysign_double <span class="main">1</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>copysign_double <span class="main">1</span> <span class="free">y</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">⟹</span>
  is_zero <span class="free">x</span> <span class="main">⟹</span> is_zero <span class="free">y</span> <span class="main">⟹</span> compare_double <span class="free">x</span> <span class="free">y</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> compare_double_le_0
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nan_not_zero zero_fcompare <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_zero_double_cases<span class="main">:</span> <span class="quoted"><span class="quoted">"is_zero <span class="free">x</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="main">-</span><span class="main">0</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_zero_cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> copysign_1_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"copysign_double <span class="main">1</span> <span class="main">0</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"copysign_double <span class="main">1</span> <span class="main">(</span><span class="main">-</span><span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_zero_uminus_double<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_zero <span class="main">(</span><span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟷</span> is_zero <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> not_is_zero_one_double<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_zero <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> IEEE.is_zero_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> uminus_one_neq_one_double<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="main">1</span> <span class="main">≠</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> double<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lle_double</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"double <span class="main">⇒</span> double <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lle_double</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟷</span> lcompare_double <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≤</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lless_double</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"double <span class="main">⇒</span> double <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lless_double</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟷</span> lcompare_double <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lcompare_double_ge_0<span class="main">:</span> <span class="quoted"><span class="quoted">"lcompare_double <span class="free">x</span> <span class="free">y</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟷</span> lle_double <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lle_double_def lcompare_double_def
  <span class="keyword1"><span class="command">using</span></span> compare_double_swap not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lcompare_double_gt_0<span class="main">:</span> <span class="quoted"><span class="quoted">"lcompare_double <span class="free">x</span> <span class="free">y</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟷</span> lless_double <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lless_double_def lcompare_double_def
  <span class="keyword1"><span class="command">using</span></span> compare_double_swap <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lcompare_double_eq_0<span class="main">:</span> <span class="quoted"><span class="quoted">"lcompare_double <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"lcompare_double <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_zero <span class="free">x</span> <span class="main">∧</span> is_zero <span class="free">y</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lcompare_double_def compare_double_simps is_nan_conv
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> is_zero_double_cases <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> fcompare_double_eq<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lcompare_double_def linorder_not_less<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> compare_double_swap
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> compare_double_antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lcompare_double <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lcompare_double_def compare_double_refl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> lcompare_double_0_folds <span class="main">=</span> lle_double_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> lless_double_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
  lcompare_double_ge_0 lcompare_double_gt_0 lcompare_double_eq_0

<span class="keyword1"><span class="command">interpretation</span></span> double_linorder<span class="main">:</span> linorder <span class="quoted">lle_double</span> <span class="quoted">lless_double</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted">double</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lless_double <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">⟷</span> lle_double <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="main">¬</span> lle_double <span class="skolem">y</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lless_double_def lle_double_def lcompare_double_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> compare_double_swap not_le<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lle_double <span class="skolem">x</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lle_double_def lcompare_double_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> compare_double_refl<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lle_double <span class="skolem">x</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"lle_double <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lle_double <span class="skolem">y</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lle_double_def lcompare_double_def not_le compare_double_swap
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> compare_double_trans zero_compare_double_copysign
        zero_compare_double_copysign<span class="main"><span class="main">[</span></span><span class="operator">OF</span> less_imp_le<span class="main"><span class="main">]</span></span> compare_double_antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"lle_double <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lle_double <span class="skolem">y</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"is_zero <span class="skolem">x</span> <span class="main">∧</span> is_zero <span class="skolem">y</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lle_double_def lcompare_double_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> is_zero_double_cases
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> compare_double_antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lle_double_def lcompare_double_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> compare_double_antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lle_double <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">∨</span> lle_double <span class="skolem">y</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lle_double_def lcompare_double_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> compare_double_swap not_le<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> double <span class="main">::</span> <span class="quoted">equal</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">equal_double</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"double <span class="main">⇒</span> double <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">equal_double</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟷</span> lcompare_double <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">intro_classes</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> equal_double_def lcompare_double_eq_0<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">derive</span></span> <span class="main">(</span>eq<span class="main">)</span> ceq <span class="quoted">double</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">comparator_double</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"double comparator"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">comparator_double</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">c</span> <span class="main">=</span> lcompare_double <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">c</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> order.Eq <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">c</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> order.Lt <span class="keyword1">else</span> order.Gt<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> comparator_double<span class="main">:</span> <span class="quoted"><span class="quoted">"comparator comparator_double"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> comparator_double_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lcompare_double_0_folds <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> comparator.intro<span class="main">)</span>

<span class="keyword1"><span class="command">local_setup</span></span> <span class="quoted">‹
  <span class="entity">Comparator_Generator.register_foreign_comparator</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">double</span><span class="antiquote">}</span></span>
    <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">comparator_double</span><span class="antiquote">}</span></span>
    <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> comparator_double<span class="antiquote">}</span></span></span>
›</span>

<span class="keyword1"><span class="command">derive</span></span> ccompare <span class="quoted">double</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Code setup›</span></span>

<span class="keyword1"><span class="command">declare</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">drop</span><span class="main"><span class="main">:</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">::</span> double"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">::</span> double"</span></span>
      <span class="quoted"><span class="quoted">"plus <span class="main">::</span> double <span class="main">⇒</span> <span class="main">_</span>"</span></span>
      <span class="quoted"><span class="quoted">"minus <span class="main">::</span> double <span class="main">⇒</span> <span class="main">_</span>"</span></span>
      <span class="quoted"><span class="quoted">"uminus <span class="main">::</span> double <span class="main">⇒</span> <span class="main">_</span>"</span></span>
      <span class="quoted"><span class="quoted">"times <span class="main">::</span> double <span class="main">⇒</span> <span class="main">_</span>"</span></span>
      <span class="quoted"><span class="quoted">"less_eq <span class="main">::</span> double <span class="main">⇒</span> <span class="main">_</span>"</span></span>
      <span class="quoted"><span class="quoted">"less <span class="main">::</span> double <span class="main">⇒</span> <span class="main">_</span>"</span></span>
      <span class="quoted"><span class="quoted">"divide <span class="main">::</span> double <span class="main">⇒</span> <span class="main">_</span>"</span></span>
      <span class="quoted"><span class="quoted">"Code_Evaluation.term_of <span class="main">::</span> double <span class="main">⇒</span> <span class="main">_</span>"</span></span>
      <span class="quoted">sqrt_double</span> <span class="quoted">infinity</span> <span class="quoted">nan</span> <span class="quoted">is_zero</span> <span class="quoted">is_infinite</span> <span class="quoted">is_nan</span> <span class="quoted">copysign_double</span> <span class="quoted">fcompare_double</span>
      <span class="quoted">double_of_integer</span> <span class="quoted">integer_of_double</span>
      <span class="main">]</span><span class="main">]</span>

<span class="keyword1"><span class="command">code_printing</span></span>
  <span class="keyword2"><span class="keyword">code_module</span></span> FloatUtil <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span>
<span class="quoted">‹module FloatUtil : sig
  val iszero : float -&gt; bool
  val isinfinite : float -&gt; bool
  val isnan : float -&gt; bool
  val copysign : float -&gt; float -&gt; float
  val compare : float -&gt; float -&gt; Z.t
end = struct
  let iszero x = (Stdlib.classify_float x = Stdlib.FP_zero);;
  let isinfinite x = (Stdlib.classify_float x = Stdlib.FP_infinite);;
  let isnan x = (Stdlib.classify_float x = Stdlib.FP_nan);;
  let copysign x y = if isnan y then Stdlib.nan else Stdlib.copysign x y;;
  let compare x y = Z.of_int (Stdlib.compare x y);;
end;;›</span>

<span class="keyword1"><span class="command">code_reserved</span></span> OCaml Stdlib FloatUtil

<span class="keyword1"><span class="command">code_printing</span></span>
  <span class="keyword2"><span class="keyword">type_constructor</span></span> double <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"float"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"uminus <span class="main">::</span> double <span class="main">⇒</span> double"</span></span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"Stdlib.(~-.)"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"<span class="main">(+)</span> <span class="main">::</span> double <span class="main">⇒</span> double <span class="main">⇒</span> double"</span></span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"Stdlib.(+.)"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"<span class="main">(*)</span> <span class="main">::</span> double <span class="main">⇒</span> double <span class="main">⇒</span> double"</span></span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"Stdlib.( *. )"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"<span class="main">(/)</span> <span class="main">::</span> double <span class="main">⇒</span> double <span class="main">⇒</span> double"</span></span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"Stdlib.('/.)"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"<span class="main">(-)</span> <span class="main">::</span> double <span class="main">⇒</span> double <span class="main">⇒</span> double"</span></span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"Stdlib.(-.)"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">::</span> double"</span></span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"0.0"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">::</span> double"</span></span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"1.0"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"<span class="main">(≤)</span> <span class="main">::</span> double <span class="main">⇒</span> double <span class="main">⇒</span> bool"</span></span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"Stdlib.(&lt;=)"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"<span class="main">(&lt;)</span> <span class="main">::</span> double <span class="main">⇒</span> double <span class="main">⇒</span> bool"</span></span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"Stdlib.(&lt;)"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"sqrt_double <span class="main">::</span> double <span class="main">⇒</span> double"</span></span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"Stdlib.sqrt"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"infinity <span class="main">::</span> double"</span></span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"Stdlib.infinity"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"nan <span class="main">::</span> double"</span></span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"Stdlib.nan"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"is_zero <span class="main">::</span> double <span class="main">⇒</span> bool"</span></span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"FloatUtil.iszero"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"is_infinite <span class="main">::</span> double <span class="main">⇒</span> bool"</span></span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"FloatUtil.isinfinite"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"is_nan <span class="main">::</span> double <span class="main">⇒</span> bool"</span></span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"FloatUtil.isnan"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"copysign_double <span class="main">::</span> double <span class="main">⇒</span> double <span class="main">⇒</span> double"</span></span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"FloatUtil.copysign"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"compare_double <span class="main">::</span> double <span class="main">⇒</span> double <span class="main">⇒</span> integer"</span></span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"FloatUtil.compare"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"double_of_integer <span class="main">::</span> integer <span class="main">⇒</span> double"</span></span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"Z.to'_float"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"integer_of_double <span class="main">::</span> double <span class="main">⇒</span> integer"</span></span> <span class="main">⇀</span> <span class="main">(</span>OCaml<span class="main">)</span> <span class="quoted">"Z.of'_float"</span>

<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
<span class="keyword2"><span class="keyword">if</span></span> Real.precision &lt;&gt; <span class="inner_numeral">53</span> <span class="keyword2"><span class="keyword">then</span></span>
  error <span class="inner_quoted">"SML real type must be double precision for Eval code adaptation"</span>
<span class="keyword2"><span class="keyword">else</span></span> <span class="main">(</span><span class="main">)</span><span class="main">;</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">REALUTIL</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">sig</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> nan <span class="main">:</span> real
  <span class="keyword1"><span class="keyword">val</span></span> iszero <span class="main">:</span> real <span class="main">-&gt;</span> bool
  <span class="keyword1"><span class="keyword">val</span></span> isinfinite <span class="main">:</span> real <span class="main">-&gt;</span> bool
  <span class="keyword1"><span class="keyword">val</span></span> copysign <span class="main">:</span> real <span class="main">-&gt;</span> real <span class="main">-&gt;</span> real
  <span class="keyword1"><span class="keyword">val</span></span> compare <span class="main">:</span> real <span class="main">-&gt;</span> real <span class="main">-&gt;</span> int
  <span class="keyword1"><span class="keyword">val</span></span> toInt <span class="main">:</span> real <span class="main">-&gt;</span> int
  <span class="keyword1"><span class="keyword">val</span></span> toTerm <span class="main">:</span> real <span class="main">-&gt;</span> term
<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">RealUtil</span> <span class="main">:</span> <span class="entity">REALUTIL</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">struct</span></span>
  <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">nan</span> <span class="main">=</span> <span class="inner_numeral">1.0</span> / <span class="inner_numeral">0.0</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">iszero</span> <span class="entity">x</span> <span class="main">=</span> <span class="main">(</span>Real.class <span class="entity">x</span> <span class="main">=</span> IEEEReal.ZERO<span class="main">)</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">isinfinite</span> <span class="entity">x</span> <span class="main">=</span> <span class="main">(</span>Real.class <span class="entity">x</span> <span class="main">=</span> IEEEReal.INF<span class="main">)</span><span class="main">;</span>
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">copysign</span> <span class="entity">x</span> <span class="entity">y</span> <span class="main">=</span> <span class="keyword2"><span class="keyword">if</span></span> Real.isNan <span class="entity">y</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">nan</span> <span class="keyword2"><span class="keyword">else</span></span> Real.copySign <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">compare</span> <span class="entity">x</span> <span class="entity">y</span> <span class="main">=</span> <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> Real.compare <span class="main">(</span><span class="entity">x</span><span class="main">,</span> <span class="entity">y</span><span class="main">)</span> <span class="keyword2"><span class="keyword">of</span></span>
      LESS <span class="main">=&gt;</span> <span class="inner_numeral">~1</span>
    <span class="main">|</span> EQUAL <span class="main">=&gt;</span> <span class="inner_numeral">0</span>
    <span class="main">|</span> GREATER <span class="main">=&gt;</span> <span class="inner_numeral">1</span><span class="main">)</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">toInt</span> <span class="entity">x</span> <span class="main">=</span> Real.toInt IEEEReal.TO_ZERO <span class="entity">x</span><span class="main">;</span>

  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">toTerm</span> <span class="entity">x</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">case</span></span> Real.class <span class="entity">x</span> <span class="keyword2"><span class="keyword">of</span></span>
      IEEEReal.NAN <span class="main">=&gt;</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> nan<span class="antiquote">}</span></span>
    <span class="main">|</span> IEEEReal.INF <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">if</span></span> Real.signBit <span class="entity">x</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">-</span> infinity"</span><span class="antiquote">}</span></span> <span class="keyword2"><span class="keyword">else</span></span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"infinity"</span><span class="antiquote">}</span></span>
    <span class="main">|</span> IEEEReal.ZERO <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">if</span></span> Real.signBit <span class="entity">x</span> <span class="keyword2"><span class="keyword">then</span></span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">-</span><span class="main">0</span> <span class="main">::</span> double"</span><span class="antiquote">}</span></span> <span class="keyword2"><span class="keyword">else</span></span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">0</span> <span class="main">::</span> double"</span><span class="antiquote">}</span></span>
    <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="keyword2"><span class="keyword">case</span></span> Real.toManExp <span class="entity">x</span> <span class="keyword2"><span class="keyword">of</span></span> <span class="main">{</span>man <span class="main">=</span> <span class="entity">m</span><span class="main">,</span> exp <span class="main">=</span> <span class="entity">e</span><span class="main">}</span> <span class="main">=&gt;</span>
      <span class="keyword2"><span class="keyword">let</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">i</span> <span class="main">=</span> Real.floor <span class="main">(</span><span class="entity">m</span> * Math.pow <span class="main">(</span><span class="inner_numeral">2.0</span><span class="main">,</span> <span class="inner_numeral">53.0</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
        <span class="keyword1"><span class="keyword">val</span></span> <span class="entity">e</span> <span class="main">=</span> <span class="entity">e</span> - <span class="inner_numeral">53</span><span class="main">;</span>
      <span class="keyword2"><span class="keyword">in</span></span>
        <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">abs_double</span><span class="antiquote">}</span></span> $ <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"of_finite_Float <span class="main">::</span> Float.float <span class="main">⇒</span> <span class="main">(</span><span class="numeral">11</span><span class="main">,</span> <span class="numeral">52</span><span class="main">)</span> <span class="keyword1">float</span>"</span><span class="antiquote">}</span></span> $
          <span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">Float</span><span class="antiquote">}</span></span> $ <span class="entity">HOLogic.mk_number</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">int</span><span class="antiquote">}</span></span> <span class="entity">i</span> $ <span class="entity">HOLogic.mk_number</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">typ</span> <span class="quoted">int</span><span class="antiquote">}</span></span> <span class="entity">e</span><span class="main">)</span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">end</span></span><span class="main">)</span><span class="main">;</span>
<span class="keyword2"><span class="keyword">end</span></span>›</span>

<span class="keyword1"><span class="command">code_printing</span></span>
  <span class="keyword2"><span class="keyword">type_constructor</span></span> double <span class="main">⇀</span> <span class="main">(</span>Eval<span class="main">)</span> <span class="quoted">"real"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"uminus <span class="main">::</span> double <span class="main">⇒</span> double"</span></span> <span class="main">⇀</span> <span class="main">(</span>Eval<span class="main">)</span> <span class="quoted">"Real.~"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"<span class="main">(+)</span> <span class="main">::</span> double <span class="main">⇒</span> double <span class="main">⇒</span> double"</span></span> <span class="main">⇀</span> <span class="main">(</span>Eval<span class="main">)</span> <span class="quoted">"Real.+ ((_), (_))"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"<span class="main">(*)</span> <span class="main">::</span> double <span class="main">⇒</span> double <span class="main">⇒</span> double"</span></span> <span class="main">⇀</span> <span class="main">(</span>Eval<span class="main">)</span> <span class="quoted">"Real.* ((_), (_))"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"<span class="main">(/)</span> <span class="main">::</span> double <span class="main">⇒</span> double <span class="main">⇒</span> double"</span></span> <span class="main">⇀</span> <span class="main">(</span>Eval<span class="main">)</span> <span class="quoted">"Real.'/ ((_), (_))"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"<span class="main">(-)</span> <span class="main">::</span> double <span class="main">⇒</span> double <span class="main">⇒</span> double"</span></span> <span class="main">⇀</span> <span class="main">(</span>Eval<span class="main">)</span> <span class="quoted">"Real.- ((_), (_))"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">::</span> double"</span></span> <span class="main">⇀</span> <span class="main">(</span>Eval<span class="main">)</span> <span class="quoted">"0.0"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">::</span> double"</span></span> <span class="main">⇀</span> <span class="main">(</span>Eval<span class="main">)</span> <span class="quoted">"1.0"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"<span class="main">(≤)</span> <span class="main">::</span> double <span class="main">⇒</span> double <span class="main">⇒</span> bool"</span></span> <span class="main">⇀</span> <span class="main">(</span>Eval<span class="main">)</span> <span class="quoted">"Real.&lt;= ((_), (_))"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"<span class="main">(&lt;)</span> <span class="main">::</span> double <span class="main">⇒</span> double <span class="main">⇒</span> bool"</span></span> <span class="main">⇀</span> <span class="main">(</span>Eval<span class="main">)</span> <span class="quoted">"Real.&lt; ((_), (_))"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"sqrt_double <span class="main">::</span> double <span class="main">⇒</span> double"</span></span> <span class="main">⇀</span> <span class="main">(</span>Eval<span class="main">)</span> <span class="quoted">"Math.sqrt"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"infinity <span class="main">::</span> double"</span></span> <span class="main">⇀</span> <span class="main">(</span>Eval<span class="main">)</span> <span class="quoted">"Real.posInf"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"nan <span class="main">::</span> double"</span></span> <span class="main">⇀</span> <span class="main">(</span>Eval<span class="main">)</span> <span class="quoted">"RealUtil.nan"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"is_zero <span class="main">::</span> double <span class="main">⇒</span> bool"</span></span> <span class="main">⇀</span> <span class="main">(</span>Eval<span class="main">)</span> <span class="quoted">"RealUtil.iszero"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"is_infinite <span class="main">::</span> double <span class="main">⇒</span> bool"</span></span> <span class="main">⇀</span> <span class="main">(</span>Eval<span class="main">)</span> <span class="quoted">"RealUtil.isinfinite"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"is_nan <span class="main">::</span> double <span class="main">⇒</span> bool"</span></span> <span class="main">⇀</span> <span class="main">(</span>Eval<span class="main">)</span> <span class="quoted">"Real.isNan"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"copysign_double <span class="main">::</span> double <span class="main">⇒</span> double <span class="main">⇒</span> double"</span></span> <span class="main">⇀</span> <span class="main">(</span>Eval<span class="main">)</span> <span class="quoted">"RealUtil.copysign"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"compare_double <span class="main">::</span> double <span class="main">⇒</span> double <span class="main">⇒</span> integer"</span></span> <span class="main">⇀</span> <span class="main">(</span>Eval<span class="main">)</span> <span class="quoted">"RealUtil.compare"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"double_of_integer <span class="main">::</span> integer <span class="main">⇒</span> double"</span></span> <span class="main">⇀</span> <span class="main">(</span>Eval<span class="main">)</span> <span class="quoted">"Real.fromInt"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"integer_of_double <span class="main">::</span> double <span class="main">⇒</span> integer"</span></span> <span class="main">⇀</span> <span class="main">(</span>Eval<span class="main">)</span> <span class="quoted">"RealUtil.toInt"</span>
  <span class="main">|</span> <span class="keyword2"><span class="keyword">constant</span></span> <span class="quoted"><span class="quoted">"Code_Evaluation.term_of <span class="main">::</span> double <span class="main">⇒</span> term"</span></span> <span class="main">⇀</span> <span class="main">(</span>Eval<span class="main">)</span> <span class="quoted">"RealUtil.toTerm"</span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> fcompare_double

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>

</pre>
</body>

</html>